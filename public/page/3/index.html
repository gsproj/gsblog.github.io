<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"gsproj.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="GongSheng Blog">
<meta property="og:url" content="http://gsproj.github.io/page/3/index.html">
<meta property="og:site_name" content="GongSheng Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="GongSheng">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://gsproj.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>GongSheng Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">GongSheng Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">山川異域，風月同天</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/02_%E6%B5%8B%E8%AF%95/02_%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-%E5%AE%8C%E5%96%84%E4%B8%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/02_%E6%B5%8B%E8%AF%95/02_%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E-%E5%AE%8C%E5%96%84%E4%B8%AD/" class="post-title-link" itemprop="url">测试工具使用说明-完善中</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-07 10:30:03" itemprop="dateModified" datetime="2022-07-07T10:30:03+08:00">2022-07-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">测试</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%B5%8B%E8%AF%95/%E4%BF%A1%E5%88%9BPOC%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">信创POC测试</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="测试工具使用说明-汇总"><a href="#测试工具使用说明-汇总" class="headerlink" title="测试工具使用说明-汇总"></a>测试工具使用说明-汇总</h1><h1 id="一、SPEC-CPU-2017-测试"><a href="#一、SPEC-CPU-2017-测试" class="headerlink" title="一、SPEC CPU 2017 测试"></a>一、SPEC CPU 2017 测试</h1><h2 id="1-1-概述"><a href="#1-1-概述" class="headerlink" title="1.1 概述"></a>1.1 概述</h2><p>​	标准性能评测机构（SPEC）开发的用于评测CPU性能的基准程序测试组，是一套CPU子系统测试工具。处理器、内存和编译都会影响最终的测试结果，目前SPEC CPU是业界首选的CPU评测工具。 </p>
<h2 id="1-2-工具安装"><a href="#1-2-工具安装" class="headerlink" title="1.2 工具安装"></a>1.2 工具安装</h2><p>获取镜像包：</p>
<p>​	cpu2017-1_0_5.iso</p>
<p>挂载IOS</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mount -o loop -t iso9660 cpu2017-1_0_5.iso &#x2F;xxx&#x2F;cpu2017CD<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装工具</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cd &#x2F;xxx&#x2F;cpu2017CD
.&#x2F;install.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="1-3-测试步骤"><a href="#1-3-测试步骤" class="headerlink" title="1.3 测试步骤"></a>1.3 测试步骤</h2><p>spec2017主要分为四项测试：</p>
<ul>
<li>​	intrate</li>
<li>​	fprate</li>
<li>​	intspeed</li>
<li>​	fpspeed</li>
</ul>
<p>​	根据需要测试的cpu型号，可以到官网下载相应的cfg文件，修改icc、Jemalloc库、qkmalloc库的路径，放入config文件夹中。</p>
<p>测试命令如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">source shrc
ulimit -s unlimited
# speed 测试
runcpu --config&#x3D;icc-speed-official.cfg --threads&#x3D;48 --define cores&#x3D;48 -n 3 -i ref fpspeed intspeed

# rate 测试
runcpu --config&#x3D;icc-rate-official.cfg -copies&#x3D;48 -n 3 -i ref intrate fprate

-----------------------------------------------------------------------

# 仅编译不跑测试
--action&#x3D;build
# 重新编译
--rebuild
# 绑核跑
taskset -c <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-4-测试优化"><a href="#1-4-测试优化" class="headerlink" title="1.4 测试优化"></a>1.4 测试优化</h2><blockquote>
<p>Bios设置：</p>
<p>​	开启超线程</p>
<p>​	 尝试开启LLC-PREFETCH</p>
</blockquote>
<h2 id="1-5-其他事项："><a href="#1-5-其他事项：" class="headerlink" title="1.5 其他事项："></a>1.5 其他事项：</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cfg文件中的submit可以设置绑核选项<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="二、SPEC-CPU-2006-测试"><a href="#二、SPEC-CPU-2006-测试" class="headerlink" title="二、SPEC CPU 2006 测试"></a>二、SPEC CPU 2006 测试</h1><h2 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h2><p>​	作用同Spec CPU 2017, 近年来逐渐被淘汰</p>
<h2 id="2-2-测试步骤"><a href="#2-2-测试步骤" class="headerlink" title="2.2 测试步骤"></a>2.2 测试步骤</h2><p>1、spec2006.tgz 解压，使用install.sh安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">SPEC CPU2006 Installation
Top of the CPU2006 tree is &#39;&#x2F;vol8&#x2F;tarball&#x2F;cpu2006&#39;
These appear to be valid toolsets:
ft-spec2006-tool
aarch64-linux
Enter the architecture you are using:
&gt;&gt; aarch64-linux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">source shrc
# 单核测试
runspec -c linux64-arm64-gcc52.cfg -i ref -n 3 -I all 
# 多核测试（16）
runspec -c linux64-arm64-gcc52.cfg -r 16 -n 3 -i ref -I all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="三、-SPEC-OMP-2012-测试"><a href="#三、-SPEC-OMP-2012-测试" class="headerlink" title="三、 SPEC OMP 2012 测试"></a>三、 SPEC OMP 2012 测试</h1><h2 id="3-1-概述"><a href="#3-1-概述" class="headerlink" title="3.1 概述"></a>3.1 概述</h2><p>​	基于SPEC测试套件的OpenMP评测工具，其中包含15个基于OpenMP的并行程序。</p>
<h2 id="3-2-工具安装"><a href="#3-2-工具安装" class="headerlink" title="3.2 工具安装"></a>3.2 工具安装</h2><p>​	获取源包：</p>
<p>​		omp2012-1.1.zip</p>
<p>​	解压后使用install.sh安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 安装
.&#x2F;install.sh -d &#x2F;home&#x2F;xx
# 仅编译
runspec --action&#x3D;build --config&#x3D;gcc.cfg -i ref -I all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="3-3-测试步骤"><a href="#3-3-测试步骤" class="headerlink" title="3.3 测试步骤"></a>3.3 测试步骤</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">source shrc
ulimit -s unlimited
export OMP_NUM_THREADS&#x3D;48
runspec --config&#x3D;gcc.cfg --threads 48 -n 3 -i ref -I all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="四、NPB-测试"><a href="#四、NPB-测试" class="headerlink" title="四、NPB 测试"></a>四、NPB 测试</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><p>​	NAS并行基准测试程序（NPB），是由美国航空航天局开发的一套代表流体动力学计算的应用程序集，它已经成为公认的用于测评大规模并行机和超级计算机的标准测试程序。NPB可用于常用的编程模型，如MPI和OpenMP。</p>
<h2 id="4-2-工具安装"><a href="#4-2-工具安装" class="headerlink" title="4.2 工具安装"></a>4.2 工具安装</h2><p>源包获取：</p>
<p>​	NPB3.4.tar.gz         OpenMP || MPICH</p>
<p>​	NPB3.4-MZ.tar.gz  OpenMP &amp;&amp; MPICH</p>
<p>解压即可。</p>
<h2 id="4-3-测试步骤"><a href="#4-3-测试步骤" class="headerlink" title="4.3 测试步骤"></a>4.3 测试步骤</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">make suite
cd bin
mpirun -np 4 .&#x2F;xxx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h1 id="五、Stream-测试"><a href="#五、Stream-测试" class="headerlink" title="五、Stream 测试"></a>五、Stream 测试</h1><h2 id="5-1-概述"><a href="#5-1-概述" class="headerlink" title="5.1 概述"></a>5.1 概述</h2><p>​	STREAM是一套综合性能测试程序集，通过fortran和C两种高级且高效的语言编写完成，由于这两种语言在数学计算方面的高效率， 使得 STREAM 测试例程可以充分发挥出内存的能力。Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。</p>
<h2 id="5-2-工具安装"><a href="#5-2-工具安装" class="headerlink" title="5.2 工具安装"></a>5.2 工具安装</h2><p>源包获取：</p>
<p>​	stream.tgz  刘新娃修改过</p>
<p>​	<font color='red'>Intel平台请用ICC</font></p>
<p>解压后编译stream.c, 生成可执行文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">icc -O3 -fopenmp -DNTIMES&#x3D;10 -mcmodel&#x3D;large -o stream_c stream.c<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>没有修改过的怎么编译呢？</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">icc -mtune&#x3D;native -march&#x3D;native -O3 -mcmodel&#x3D;large -fopenmp -DSTREAM_ARRAY_SIZE&#x3D;100000000 -DNTIMES&#x3D;30 -DOFFSET&#x3D;512 stream.c -o stream-gs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="5-3-测试步骤"><a href="#5-3-测试步骤" class="headerlink" title="5.3 测试步骤"></a>5.3 测试步骤</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">export OMP_NUM_THREADS&#x3D;48&#x2F;32&#x2F;16&#x2F;8&#x2F;4  # 设置每个进程的线程数
.&#x2F;stream_c 200000 # 使用200G内存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="5-4-其他事项"><a href="#5-4-其他事项" class="headerlink" title="5.4 其他事项"></a>5.4 其他事项</h2><blockquote>
<p><code>STREAM_ARRAY_SIZE</code>即<code>N</code>指定计算中a[],b[],c[]三个数组的大小，且数组的值采用了双精度（8个字节）。数组的维数 N定义时需要注意以下几点：</p>
<p>一、要充分考虑内存容量的需求，粗略估计是 N× 8（双精度浮点类型） × 3 （三个数组）&lt;&#x3D; 0.6*M；M 是用户的可用内存。</p>
<p>二、要保证测试过程中，使用到的内存容量要大于处理器内的缓存，只有这样才会有内存的操作，而不仅仅是对处理器内缓存的操作。</p>
<p>三、为了保证测试可以持续一段时间，测试过程中内存带宽可以达到一定的最大值， 从而避免得不到实际最大峰值的情况，如果四项测试中有完成时间小于20微秒的情况，就需要适当的增大测试数组的维度 N。</p>
</blockquote>
<h1 id="六、Linpack-测试"><a href="#六、Linpack-测试" class="headerlink" title="六、Linpack 测试"></a>六、Linpack 测试</h1><h2 id="6-1-概述"><a href="#6-1-概述" class="headerlink" title="6.1 概述"></a>6.1 概述</h2><p>​	Linpack是国际上使用最广泛的测试高性能计算机系统浮点性能的基准测试。通过对高性能计算机采用高斯消元法求解一元 N次稠密线性代数方程组的测试，评价高性能计算机的浮点计算性能。Linpack的结果按每秒浮点运算次数（flops）表示。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">N ^ 2 * 8 &#x3D; 总内存<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="6-2-工具安装"><a href="#6-2-工具安装" class="headerlink" title="6.2 工具安装"></a>6.2 工具安装</h2><p>源包获取：</p>
<p>​	linpack.tgz</p>
<p>解压即可。</p>
<h2 id="6-3-测试步骤"><a href="#6-3-测试步骤" class="headerlink" title="6.3 测试步骤"></a>6.3 测试步骤</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 1进48线100G内存
.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 100000
# 1进48线200G内存
.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 200000
# 2进24线共100G内存
mpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 50000
# 2进24线共200G内存
mpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 100000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>用mpirun提交xhplrun.sh效果更好</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">PRO_SIZE&#x3D;$&#123;PMI_SIZE&#125;
threads&#x3D;&#96;echo $&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;
PMI_RANK_my&#x3D;$&#123;PMI_RANK&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="6-4-测试优化（重点）"><a href="#6-4-测试优化（重点）" class="headerlink" title="6.4 测试优化（重点）"></a>6.4 测试优化（重点）</h2><blockquote>
<p>一、计算理论内存总带宽</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;计算方法：
&gt;查看内存带宽：
&gt;dmidecode | grep -A 16 &quot;Memory Device&quot;
&gt;例如内存信息为：
&gt;三星 DDR4 
&gt;16G 每根
&gt;2666 MT&#x2F;s（Mhz）
&gt;查看cpu支持的通道数，例如intel 6252N支持6通道，两个CPU支持12通道
&gt;理论带宽计算DDR4：
&gt;单条内存带宽 &#x3D; 内存核心频率 x 内存总线位数 x 倍增系数
 &#x3D; 2666 * 64 &#x2F; 8 &#x3D; 21328 MB&#x2F;s &#x3D; 21.3G&#x2F;s
&gt;12通道总内存带宽 &#x3D; 21328 * 12 &#x3D; 255936 &#x3D; 250G&#x2F;s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>二、使用stream测试实际内存总带宽</p>
<p>​	如果可以达到90%或以上，说明内存带宽正常, 继续Linpack测试</p>
<p>三、计算CPU理论峰值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;计算方法：
Mhz * 每个时钟周期执行浮点运算的次数 * CPU数目
&gt;&#x3D;
2.3 x ( 8 x 2 x 2 ) x 48 &#x3D; 3532.8 Gflops
&gt;说明：
峰值计算分为单精度和双精度浮点运算
&gt;单精度：
32bit的指令长度的运算，对应32位操作系统
&gt;双精度：
64bit的指令长度的运算，对应64位操作系统
&gt;查找CPU可以处理什么样的指令集：
例如Intel官网查到Intel Xeon 6252N
支持AVX-512，
# of AVX-512 FMA Units &#x3D; 2
(Fused Multiply Add instructions) 融合了 乘法 和 加法
即可以单个周期同时执行2条512bit的加法和2条512bit的乘法
&gt;理解上述两个概念，可以开始计算（CPU单周期浮点计算能力）
&gt;Intel 6252N (支持avx512，有512位)
&gt;单精度：
2.3 x 512&#x2F;32 x 2 x 2 &#x3D; 147.2Gflops 
&gt;双精度
2.3 x 512&#x2F;64 x 2 x 2 &#x3D; 73.6Gflops
&gt;双精度共48核
74.6 x 48 &#x3D; 3580

&gt;FT2000+ 和 FT1500A (只有128位)，FT3000加入sve指令集(128-256位)
&gt;单精度： 
2.2 x 128&#x2F;32 * 2 &#x3D; 4.4
&gt;双精度:
2.2 x 128&#x2F;64 * 2 &#x3D; 8.8
&gt;双精度共64核
8.8 x 64 &#x3D; 563.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>四、使用Linapack测试CPU实际峰值</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;如果性能达到理论峰值的70%说明正常，如果未达到尝试以下优化<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;1、使用mpirun运行xhpl, 按&#96;lscpu&#96; 中的NUMA分组绑定,&#96;比如48核，分为两个Numa Node&#96;, 则用mpirun&#96;跑两个xhpl进程&#96;，每个进程使用 OMP_NUM_THREADS&#x3D;24, 跑24线程，这样可以将核用满。
&gt;在&#96;Intel&#96;平台，两个进程分别使用 HPL_HOST_CORE&#x3D;&#39;0-23&#39; 以及 HPL_HOST_CORE&#x3D;&#39;24-47&#39; 绑定核
&gt;在&#96;Arm64&#96;平台，则使用 GOMP_CPU_AFFINITY&#x3D;&#39;0-23&#39; 以及 GOMP_CPU_AFFINITY&#x3D;&#39;24-47&#39; 绑定
&gt;2、内存不用分配太大，根据stream测试结果分配，从小开始测
&gt;3、Intel平台编译器使用ICC，测试linpack使用icc自带的linpack，mpi使用icc自带的
&gt;4、Bios中关闭超线程，开启超频(turbo&#x2F;P-state)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><font color="blue">先测stream,判断带宽是否正常，再测linpack，然后再测Spec Cpu</font></strong></p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># Intel平台可以使用的控制频率的命令
cpupower -c all frequency-set -g performance
cpupower -c 0-95 frequency-set -g userspace
cpupower -c 0-95 frequency-set -f 2700000

# 查看当前频率控制是否为perfomance？
cat &#x2F;sys&#x2F;devices&#x2F;system&#x2F;cpu&#x2F;cpu0&#x2F;cpufreq&#x2F;scaling_governor

# 跑xhpl之前设置指令集，或许有用
export MKL_ENABLE_INSTRUCTIONS&#x3D;AVX512<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="G:\工作\2020年3月\CN9性能测试\测试组合.png" alt="image-20200415171716940"></p>
<h2 id="6-5-HPL-dat修改"><a href="#6-5-HPL-dat修改" class="headerlink" title="6.5 HPL.dat修改"></a>6.5 HPL.dat修改</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 第1-2行，注释说明行
HPLinpack benchmark input file   
Innovative Computing Laboratory, University of Tennessee  

# 第 3-4 行，输出结果文件的形式
HPL.out      output file name (if any)  
6            device out (6&#x3D;stdout,7&#x3D;stderr,file) 

# 5-6行，求解矩阵的大小
1            # of problems sizes (N)  
1000         Ns   

# 7-8行 求解矩阵分块的大小
1            # of NBs
192 256      NBs

# 9行 处理器阵列的排列方式，行还是列
0：适用于节点较少，单个节点CPU较多的胖系统
1：适用于节点较多，单个节点CPU较少的瘦系统（机群上远好于按行排列）
1            PMAP process mapping (0&#x3D;Row-,1&#x3D;Column-major) 

# 10-12行 定义二维处理网格P&#x2F;Q
# P X Q &#x3D; 进程数，P尽量小于Q
# P&#x3D;2^n,P最好选择2的幂
1            # of process grids (P x Q) 
1 2          Ps
1 2          Qs

# 13行 设置阀值，不用修改
16.0         threshold

# 14-21行 设置L的分解方式
1            # of panel fact
2 1 0        PFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大
1            # of recursive stopping criterium
4 8          NBMINs (&gt;&#x3D; 1)   # 4或8都不错
1            # of panels in recursion
2            NDIVs  # 选2比较理想
1            # of recursive panel fact.
1 0 2        RFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大

# 22-23行 设置L的横向广播方式
# 前四种，适用于快速网络，后两种适用于速度较慢的网络
# 小规模系统，选择0&#x2F;1，大规模系统选择3
1            # of broadcast
0            BCASTs (0&#x3D;1rg,1&#x3D;1rM,2&#x3D;2rg,3&#x3D;2rM,4&#x3D;Lng,5&#x3D;LnM)

# 24-25行 设置横向通信的通信深度
# 小规模系统选择1&#x2F;2，大规模系统2-5之间
1            # of lookahead depth
1            DEPTHs (&gt;&#x3D;0)

# 26-27 设置U的广播算法
# 小规模系统，使用缺省值即可
0            SWAP (0&#x3D;bin-exch,1&#x3D;long,2&#x3D;mix)
1            swapping threshold

# 28-29行 L和U的数据存放格式
0：按列存放
1：按行存放
0            L1 in (0&#x3D;transposed,1&#x3D;no-transposed) form
0            U  in (0&#x3D;transposed,1&#x3D;no-transposed) form

# 30-31 缺省值即可
0            Equilibration (0&#x3D;no,1&#x3D;yes)
8            memory alignment in double (&gt; 0)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-6-测试脚本编写"><a href="#6-6-测试脚本编写" class="headerlink" title="6.6 测试脚本编写"></a>6.6 测试脚本编写</h2><h3 id="6-6-1-本地mpirun测试脚本（Intel版本）"><a href="#6-6-1-本地mpirun测试脚本（Intel版本）" class="headerlink" title="6.6.1 本地mpirun测试脚本（Intel版本）"></a>6.6.1 本地mpirun测试脚本（Intel版本）</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 本地单节点测试，需要根据&#96;lscpu&#96;中numa分区情况(node)的使用mpirun测试xhpl
# eg:在未开超线程的情况下，分为两个node，每个node中有12个核，则最佳测试方法为mpirun -np 2 .&#x2F;myrun.sh
# 以下为myrun.sh的具体实现

#!&#x2F;bin&#x2F;bash
ulimit -s unlimited
Cores&#x3D;48
ThreadsNum&#x3D;&#96;echo &quot;$&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125;&quot; | bc&#96; # 计算每个进程跑的线程数
case $&#123;PMI_SIZE&#125; in
2)
        case $&#123;PMI_RANK&#125; in
        0)
        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;
        export HPL_HOST_CORE&#x3D;&#39;0-23&#39;
        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
        ;;
        1)
        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;
        export HPL_HOST_CORE&#x3D;&#39;24-47&#39;
        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
        ;;
        esac
;;
esac
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-6-2-Slurm-srun测试脚本-FT版本"><a href="#6-6-2-Slurm-srun测试脚本-FT版本" class="headerlink" title="6.6.2 Slurm srun测试脚本(FT版本)"></a>6.6.2 Slurm srun测试脚本(FT版本)</h2><p>xhplrun.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash
ulimit -s unlimited
Cores&#x3D;48


&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
PMI_SIZE&#x3D;$SLURM_NPROCS
PMI_RANK&#x3D;$SLURM_PROCID
MPI_NUM_NODE&#x3D;$SLURM_NNODES
MPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))
MPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))

PRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;
PMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;
&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;

echo $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;

export HPL_CMDLINE&#x3D;1
case $&#123;PRO_SIZE&#125; in
1)
#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
case $&#123;PMI_RANK_my&#125; in
0)
#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;
numactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;
numactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>yhrun 提交作业 runpro.sh</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#duqi

if [ $# -ne 5 ]
then
        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir
        exit 0
fi

export HPL_CMDLINE&#x3D;1

export LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH

nodes&#x3D;$&#123;1&#125;
nnodes&#x3D;$&#123;2&#125;
nprocs&#x3D;$&#123;3&#125;
nmem&#x3D;$&#123;4&#125;
logdir&#x3D;$&#123;5&#125;


mkdir -p $&#123;logdir&#125;

tnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))
P&#x3D;1
Q&#x3D;1
for i in &#96;seq 1 $&#123;tnprocs&#125;&#96;
do
        for j in &#96;seq 1 $&#123;tnprocs&#125;&#96;
        do
                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))
                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ] &amp;&amp; [ $&#123;i&#125; -le $&#123;j&#125; ]
                then
                        P&#x3D;$&#123;i&#125;
                        Q&#x3D;$&#123;j&#125;
                fi
        done
done

for i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;
do
        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;
done
wait
sleep 1

j&#x3D;0
runnodes&#x3D;&#39;&#39;

for i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;
do
        runnodes+&#x3D;$&#123;i&#125;,
        let j++
        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]
        then
                echo &quot;yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;
                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log
                yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;
                j&#x3D;0
                runnodes&#x3D;&#39;&#39;
        fi
done<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-7-Bios设置"><a href="#6-7-Bios设置" class="headerlink" title="6.7 Bios设置"></a>6.7 Bios设置</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">琦哥的：
    UPI Configuration
        Link Lop -&gt; disable
        Link L1  -&gt; disable 
        IO Directory Cache -&gt; enable
        Isoc Mode -&gt; enable

    Memory Configuration
        Eufsrce POR -&gt; enable
        PPR Type -&gt; Soft PPR
        Memory Frequency -&gt; 2666
        Data Scrambling for NVMDIMM -&gt; enable
        Data Scrambling for DDR4 -&gt; enable
        Enable AOR -&gt; enable
        Refresh Option -&gt; enable
        Memory RAS
            Memory Rank Sparing -&gt; enable

    IIO Configuration
        PCI-E Port Max Payload Size -&gt; 256B

    CPU P-State
        SpeedStep -&gt; disable&#x2F;enable?
        PBF 
        Hardware P-State -&gt; enable
        Package c state -&gt; No limit 
	
网上找的系统Bios设置优化
    关闭超线程
    打开EIST
    打开Turbo Mode
    Boot Performance mode设置为max performance
    Energy Performance BIAS设置为Performance
    打开Monitor&#x2F;Mwait
    Package C stat limit设置为C0&#x2F;C1 state
    关闭CPU C3 report
    关闭CPU C6 report
    关闭Enhanced Halt State
    关闭Intel VT for Directed I&#x2F;O
    Linux OS下CPU Power Management设置为max performance
    QPI及Memory Frequency保持为Max Frequency
    关闭NUMA功能 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-8-结果反馈"><a href="#6-8-结果反馈" class="headerlink" title="6.8 结果反馈"></a>6.8 <span id="jump">结果反馈</span></h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#linpack测试以我们为主导

1、grep FAILED 关键字,查看是否有节点计算错误
2、grep WR 查看节点性能是否正常
3、统计跑死的点

# 如何反馈？
一轮Linpack40分钟测试完成
	一、6个点本是drain*状态
	二、3个点跑死，cn[1,2,3]
	三、5个点Linpack计算FAILED
	四、其他点linpakc性能正常
可以考虑更换下一批<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="6-9-风冷系统linpack测试全过程记录"><a href="#6-9-风冷系统linpack测试全过程记录" class="headerlink" title="6.9 风冷系统linpack测试全过程记录"></a>6.9 风冷系统linpack测试全过程记录</h2><blockquote>
<h5 id="1、了解风冷系统的架构"><a href="#1、了解风冷系统的架构" class="headerlink" title="1、了解风冷系统的架构"></a>1、了解风冷系统的架构</h5><p>按批次测试，测完一批换下一批</p>
<p>一批为192个节点，每个框32个节点，共6个框</p>
<p>每个节点128G内存，芯片为FT2000+, 通过mhz获取频率为2000（降频），64物理核</p>
<p>系统版本： 4.19.46-cn+</p>
<h5 id="2、计算每个节点的理论峰值"><a href="#2、计算每个节点的理论峰值" class="headerlink" title="2、计算每个节点的理论峰值"></a>2、计算每个节点的理论峰值</h5><p>2000 * 128 &#x2F; 64 * 2 * 64&#x3D; 512000</p>
<h5 id="3、开始测试"><a href="#3、开始测试" class="headerlink" title="3、开始测试"></a>3、开始测试</h5><p>runpro.sh脚本参数说明:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;.&#x2F;runpro.sh NodeList NodeBind ProcessesPerNode MemSize
&gt;NodeList 节点列表,例如cn[0-8]
&gt;NodeBind 几个节点绑定运行，例如2，则计算效率时，需要将结果得到的效率&#x2F;2&#x2F;512
&gt;ProcessesPerNode 每给节点运行几个xhpl进程，根据numa node来，FT一般是8
&gt;MemSize 每个节点中，每个进程分配的内存，一般使用到约总内存的80%，例如单节点128G，填写12000（单位为Mb），则总使用96G内存<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>单节点测试：</p>
<p>​	不需要互联测试网络联通性，仅对单节点进行压力测试</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>多节点测试：</p>
<p>​	需要互联测试网络联通性， 2，4， 8， 16， 32， 64， 128，如果要求测多节点稳定性，测试的8点8进8线，结果按<a href="#jump">章节6.8</a>反馈</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>问题解决一：</p>
<p>​	测试到128节点，性能异常，效率仅有43%</p>
<p>互联那边回应：</p>
<p>​	节点数超过64，通信就跨框</p>
<p>琦哥建议的做法：</p>
<p>​	把128个节点分到4个框，测试一下，看是不是带宽的原因</p>
<p>最后的解决方法：</p>
<p>​	网络拓扑更换，矩阵值不能相等，使用原本32 x 32，改为16 x 64，但是换成160节点后还是有问题</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&gt;.&#x2F;runpro.sh cn[xx-xx] 128 8 12000 dir
&gt;其中执行的xhplrun.sh的参数为
&gt;xhplrun.sh 32 32 12000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


</blockquote>
<h1 id="七、Lmbench-测试"><a href="#七、Lmbench-测试" class="headerlink" title="七、Lmbench 测试"></a>七、Lmbench 测试</h1><h2 id="7-1-概述"><a href="#7-1-概述" class="headerlink" title="7.1 概述"></a>7.1 概述</h2><p>​	Lmbench是一套简易，可移植的，符合ANSI&#x2F;C标准为UNIX&#x2F;POSIX而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。LmBench旨在使系统开发者深入了解关键操作的基础成本。</p>
<h2 id="7-2-工具安装"><a href="#7-2-工具安装" class="headerlink" title="7.2 工具安装"></a>7.2 工具安装</h2><p>获取源包：</p>
<p>​	lmbench3.tar.gz</p>
<p>gcc编译安装</p>
<h2 id="7-3-测试步骤"><a href="#7-3-测试步骤" class="headerlink" title="7.3 测试步骤"></a>7.3 测试步骤</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cd src
make results
make see
内存10G。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">错误处理：
[root@cn9 lmbench3]# cd src&#x2F;
[root@cn9 src]# make results
gmake[1]: Entering directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;
gmake[1]: *** No rule to make target &#96;..&#x2F;SCCS&#x2F;s.ChangeSet&#39;, needed by &#96;bk.ver&#39;.  Stop.
gmake[1]: Leaving directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;
解决方法：
	vim Makefile
	231行修改：
	$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench bk.ver
	改为
	$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="八、IOR-测试（暂无）"><a href="#八、IOR-测试（暂无）" class="headerlink" title="八、IOR 测试（暂无）"></a>八、IOR 测试（暂无）</h1><h1 id="九、alltoall测试"><a href="#九、alltoall测试" class="headerlink" title="九、alltoall测试"></a>九、alltoall测试</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yhrun -n 128 -N 8 -w cn34,cn35,cn36,cn37,cn38,cn39,cn40,cn41, &#x2F;root&#x2F;xm_alltoall 102400 1000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="附录：常用工具链编译方法"><a href="#附录：常用工具链编译方法" class="headerlink" title="附录：常用工具链编译方法"></a>附录：常用工具链编译方法</h1><h2 id="一、GCC编译"><a href="#一、GCC编译" class="headerlink" title="一、GCC编译"></a>一、GCC编译</h2><p>需要依次编译依赖软件，然后在编译gcc中使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 设置isl的库路径
export LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH
# 编译GCC
..&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --enable-lto --disable-bootstrap --enable-languages&#x3D;c,c++,fortran --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpc&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-isl&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-1-依赖软件编译"><a href="#1-1-依赖软件编译" class="headerlink" title="1.1 依赖软件编译"></a>1.1 依赖软件编译</h3><h4 id="1-1-2-编译安装gmp"><a href="#1-1-2-编译安装gmp" class="headerlink" title="1.1.2 编译安装gmp"></a>1.1.2 编译安装gmp</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830
make 
make install

.&#x2F;configure --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83  --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-1-3-编译安装mpfr"><a href="#1-1-3-编译安装mpfr" class="headerlink" title="1.1.3 编译安装mpfr"></a>1.1.3 编译安装mpfr</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830
make 
make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="1-1-4-编译安装mpc"><a href="#1-1-4-编译安装mpc" class="headerlink" title="1.1.4 编译安装mpc"></a>1.1.4 编译安装mpc</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830
make
make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="1-1-5-编译安装isl"><a href="#1-1-5-编译安装isl" class="headerlink" title="1.1.5 编译安装isl"></a>1.1.5 编译安装isl</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp-prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"> yum install gcc-* gtk2 gtk3 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686
glibc.i686 glibc-devel.i686 libgcc* xulrunner.x86_64 xulrunner.i686 glibc-devel.x86_64 glibc.x86_64 autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!&#x2F;bin&#x2F;bash
mount -o loop -t iso9660 &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM


yum install gcc-* gtk2 gtk3 glibc-devel.i686 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686 glibc* libgcc* xulrunner* autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、MPICH3编译"><a href="#二、MPICH3编译" class="headerlink" title="二、MPICH3编译"></a>二、MPICH3编译</h2><p>设置gcc830的环境变量</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;bin:$PATH
export LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH
export LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$LD_INCLUDE_PATH
export CPATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$CPATH
export LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib64:$LD_LIBRARY_PATH
export LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;libexec:$LD_LIBRARY_PATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再编译</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830 --enable-fast --enable-shared&#x3D;yes --enable-threads&#x3D;runtime --with-ch3-rank-bits&#x3D;32 --enable-romio --with-file-system&#x3D;ufs+nfs --with-mpe
make 
make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>设置环境变量使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;bin:$PATH
export LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;lib:$LD_LIBRARY_PATH
export LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;include:$LD_INCLUDE_PATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>



<h3 id="三、Redhat设置本地镜像源"><a href="#三、Redhat设置本地镜像源" class="headerlink" title="三、Redhat设置本地镜像源"></a>三、Redhat设置本地镜像源</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mount -o loop -t iso9660 &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;mnt&#x2F;CDROM<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;redhat.repo

[rhel7.6]
name&#x3D;rhel7.6
baseurl&#x3D;file:&#x2F;&#x2F;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM
enabled&#x3D;1
gpgcheck&#x3D;0
priority&#x3D;1

yum clean
yum update
yum repolist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、找不到so库的解决方法"><a href="#四、找不到so库的解决方法" class="headerlink" title="四、找不到so库的解决方法"></a>四、找不到so库的解决方法</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 方法一：
	设置LD_LIBRARY_PATH
# 方法二：
 	vim &#x2F;etc&#x2F;ld.so.conf
 	----------------------------------------------------
 	include ld.so.conf.d&#x2F;*.conf
	&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries&#x2F;linux&#x2F;lib&#x2F;intel64
	ldconfig 更新<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、复制以及查看端口占用"><a href="#五、复制以及查看端口占用" class="headerlink" title="五、复制以及查看端口占用"></a>五、复制以及查看端口占用</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 查看端口占用
netstat -nultp | grep 8080
netstat -anp  | grep 80
netstat -ano | grep 18130
lsof -i:18130

# 复制
rsync -chavP &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;postgresql .
rsync -avzP 复制显示进度

# 查看Bios版本
dmidecode<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">
mpiicc -DAdd__ -DF77_INTEGER&#x3D;int -DStringSunStyle -DHPL_DETAILED_TIMING -DHPL_PROGRESS_REPORT -I&#x2F;root&#x2F;hpl&#x2F;include -I&#x2F;root&#x2F;hpl&#x2F;include&#x2F;Linux_Intel64 -I&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;include  -O3 -w -ansi-alias -i-static -z noexecstack -z relro -z now -nocompchk -Wall -qopenmp -mt_mpi -o &#x2F;root&#x2F;hpl&#x2F;bin&#x2F;Linux_Intel64&#x2F;xhpl HPL_pddriver.o         HPL_pdinfo.o           HPL_pdtest.o &#x2F;root&#x2F;hpl&#x2F;lib&#x2F;Linux_Intel64&#x2F;libhpl.a  -L&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;lib&#x2F;intel64 -Wl,--start-group &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_lp64.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_thread.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_core.a -Wl,--end-group -lpthread -ldl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="六、查看cpu主频率-和-内存信息"><a href="#六、查看cpu主频率-和-内存信息" class="headerlink" title="六、查看cpu主频率 和 内存信息"></a>六、查看cpu主频率 和 内存信息</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 查看CPU信息
lscpu 其中 sockets个数代表物理核个数
cat &#x2F;proc&#x2F;cpuinfo
lmbench的mhz
&#x2F;usr&#x2F;bin&#x2F;turbostat

# 查看内存信息
cat &#x2F;proc&#x2F;meminfo
dmidecode | grep -A 16 &quot;Memory Device&quot;、<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="七、GLSL-1-50-is-not-supported"><a href="#七、GLSL-1-50-is-not-supported" class="headerlink" title="七、GLSL 1.50 is not supported"></a>七、GLSL 1.50 is not supported</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 报错：
ERROR: In &#x2F;home&#x2F;gs&#x2F;src&#x2F;VTK8.2&#x2F;VTK-8.2.0&#x2F;Rendering&#x2F;OpenGL2&#x2F;vtkShaderProgram.cxx, line 447
vtkShaderProgram (0x2b87270): 0:1(10): error: GLSL 1.50 is not supported. Supported versions are: 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES

# 解决方法
export MESA_GL_VERSION_OVERRIDE&#x3D;3.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cn[16-19,24-27,144-147,152-155]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="八、附录"><a href="#八、附录" class="headerlink" title="八、附录"></a>八、附录</h2><h3 id="8-1-Linpack脚本"><a href="#8-1-Linpack脚本" class="headerlink" title="8.1 Linpack脚本"></a>8.1 Linpack脚本</h3><blockquote>
<p>runpro.sh</p>
<p>.&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir</p>
<p>node_list 节点列表</p>
<p>nodes_num 几个点连在一起跑，单点 双点 多点</p>
<p> proc_per_node 每个节点跑几个进程，看node分为几个，FT一般是8</p>
<p> mem 12000 每个进程分配的内存，*8 大概&#x3D; 总内存的80%</p>
<p> logdir 日志文件</p>
<p> 单点8进程，一轮≈35分钟</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#! &#x2F;bin&#x2F;bash

#duqi

if [ $# -ne 5 ]
then
        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir
        exit 0
fi

export HPL_CMDLINE&#x3D;1
export LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:LD_LIBRARY_PATH

nodes&#x3D;$&#123;1&#125;
nnodes&#x3D;$&#123;2&#125;
nprocs&#x3D;$&#123;3&#125;
nmem&#x3D;$&#123;4&#125;
logdir&#x3D;$&#123;5&#125;


mkdir -p $&#123;logdir&#125;

tnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))
P&#x3D;1
Q&#x3D;1


num_max&#x3D;1
for i in &#96;seq 1 $&#123;tnprocs&#125;&#96;
do
        j&#x3D;$(($&#123;i&#125;*$&#123;i&#125;))
        if [ $&#123;tnprocs&#125; -le $&#123;j&#125; ]; then
                num_max&#x3D;$&#123;i&#125;
                break
        fi
done
for i in &#96;seq 1 $&#123;num_max&#125;&#96;
do
        for j in &#96;seq $&#123;num_max&#125; $&#123;tnprocs&#125;&#96;
        do
                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))
                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ]
                then
                        P&#x3D;$&#123;i&#125;
                        Q&#x3D;$&#123;j&#125;
                fi
        done
done


for i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;
do
        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;
done
sleep 1

j&#x3D;0
runnodes&#x3D;&#39;&#39;

for i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;
do
        runnodes+&#x3D;$&#123;i&#125;,
        let j++
        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]
        then
                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;
                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;
                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125;&quot; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;list.log
                yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;
                j&#x3D;0
                runnodes&#x3D;&#39;&#39;
        fi
done
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>xhplrun.sh</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#! &#x2F;bin&#x2F;bash

#duqi

ulimit -s unlimited

Cores&#x3D;64
#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
PMI_SIZE&#x3D;$SLURM_NPROCS

PMI_RANK&#x3D;$SLURM_PROCID

MPI_NUM_NODES&#x3D;$SLURM_NNODES

MPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))

MPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))
#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;


threads&#x3D;&#96;echo $&#123;Cores&#125;*$&#123;SLURM_NNODES&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;

PRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;
PMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;

echo $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;

export HPL_CMDLINE&#x3D;1
case $&#123;PRO_SIZE&#125; in
1)
#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
case $&#123;PMI_RANK_my&#125; in
0)
#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;
numactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;
numactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
4)
case $&#123;PMI_RANK_my&#125; in
0)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-15&#39;
numactl -i 0-7 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 2-3 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;16-31&#39;
numactl -i 0-7 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 4-5 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-47&#39;
numactl -i 0-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 6-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
3)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;48-63&#39;
numactl -i 0-7 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0-1 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
;;
8)
case $&#123;PMI_RANK_my&#125; in
0)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-7&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 4 -N 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;8-15&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 2 -N 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;16-23&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 6 -N 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
3)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;24-31&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 1 -N 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
4)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-39&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 0 -N 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
5)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;40-47&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 7 -N 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
6)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;48-55&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 5 -N 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
7)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;56-63&#39;
numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#numactl -i 3 -N 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
;;
16)
case $&#123;PMI_RANK_my&#125; in
0)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-3&#39;
numactl -i 0-7 -C 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;4-7&#39;
numactl -i 0-7 -C 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;8-11&#39;
numactl -i 0-7 -C 8-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
3)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;12-15&#39;
numactl -i 0-7 -C 12-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
4)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;16-19&#39;
numactl -i 0-7 -C 16-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
5)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;20-23&#39;
numactl -i 0-7 -C 20-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
6)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;24-27&#39;
numactl -i 0-7 -C 24-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
7)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;28-31&#39;
numactl -i 0-7 -C 28-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
8)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-35&#39;
numactl -i 0-7 -C 32-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
9)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;36-39&#39;
numactl -i 0-7 -C 36-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
10)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;40-43&#39;
numactl -i 0-7 -C 40-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
11)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;44-47&#39;
numactl -i 0-7 -C 44-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
12)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;48-51&#39;
numactl -i 0-7 -C 48-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
13)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;52-55&#39;
numactl -i 0-7 -C 52-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
14)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;56-59&#39;
numactl -i 0-7 -C 56-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
15)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;60-63&#39;
numactl -i 0-7 -C 60-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
;;
32)
#export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#;;
case $&#123;PMI_RANK_my&#125; in
0)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0-1&#39;
numactl -i 0-7 -C 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;2-3&#39;
numactl -i 0-7 -C 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;4-5&#39;
numactl -i 0-7 -C 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
3)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;6-7&#39;
numactl -i 0-7 -C 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
4)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;8-9&#39;
numactl -i 0-7 -C 8-9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
5)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;10-11&#39;
numactl -i 0-7 -C 10-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
6)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;12-13&#39;
numactl -i 0-7 -C 12-13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
7)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;14-15&#39;
numactl -i 0-7 -C 14-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
8)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;16-17&#39;
numactl -i 0-7 -C 16-17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
9)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;18-19&#39;
numactl -i 0-7 -C 18-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
10)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;20-21&#39;
numactl -i 0-7 -C 20-21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
11)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;22-23&#39;
numactl -i 0-7 -C 22-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
12)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;24-25&#39;
numactl -i 0-7 -C 24-25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
13)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;26-27&#39;
numactl -i 0-7 -C 26-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
14)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;28-29&#39;
numactl -i 0-7 -C 28-29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
15)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;30-31&#39;
numactl -i 0-7 -C 30-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
16)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32-33&#39;
numactl -i 0-7 -C 32-33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
17)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;34-35&#39;
numactl -i 0-7 -C 34-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
18)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;36-37&#39;
numactl -i 0-7 -C 36-37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
19)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;38-39&#39;
numactl -i 0-7 -C 38-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
20)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;40-41&#39;
numactl -i 0-7 -C 40-41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
21)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;42-43&#39;
numactl -i 0-7 -C 42-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
22)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;44-45&#39;
numactl -i 0-7 -C 44-45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
23)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;46-47&#39;
numactl -i 0-7 -C 46-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
24)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;48-49&#39;
numactl -i 0-7 -C 48-49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
25)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;50-51&#39;
numactl -i 0-7 -C 50-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
26)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;52-53&#39;
numactl -i 0-7 -C 52-53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
27)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;54-55&#39;
numactl -i 0-7 -C 54-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
28)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;56-57&#39;
numactl -i 0-7 -C 56-57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
29)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;58-59&#39;
numactl -i 0-7 -C 58-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
30)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;60-61&#39;
numactl -i 0-7 -C 60-61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
31)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;62-63&#39;
numactl -i 0-7 -C 62-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
;;
64)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
#export GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;
#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
#;;
case $&#123;PMI_RANK_my&#125; in
0)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;0&#39;
numactl -i 0-7 -C 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
1)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;1&#39;
numactl -i 0-7 -C 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
2)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;2&#39;
numactl -i 0-7 -C 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
3)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;3&#39;
numactl -i 0-7 -C 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
4)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;4&#39;
numactl -i 0-7 -C 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
5)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;5&#39;
numactl -i 0-7 -C 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
6)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;6&#39;
numactl -i 0-7 -C 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
7)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;7&#39;
numactl -i 0-7 -C 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
8)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;8&#39;
numactl -i 0-7 -C 8 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
9)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;9&#39;
numactl -i 0-7 -C 9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
10)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;10&#39;
numactl -i 0-7 -C 10 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
11)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;11&#39;
numactl -i 0-7 -C 11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
12)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;12&#39;
numactl -i 0-7 -C 12 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
13)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;13&#39;
numactl -i 0-7 -C 13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
14)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;14&#39;
numactl -i 0-7 -C 14 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
15)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;15&#39;
numactl -i 0-7 -C 15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
16)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;16&#39;
numactl -i 0-7 -C 16 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
17)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;17&#39;
numactl -i 0-7 -C 17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
18)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;18&#39;
numactl -i 0-7 -C 18 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
19)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;19&#39;
numactl -i 0-7 -C 19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
20)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;20&#39;
numactl -i 0-7 -C 20 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
21)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;21&#39;
numactl -i 0-7 -C 21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
22)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;22&#39;
numactl -i 0-7 -C 22 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
23)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;23&#39;
numactl -i 0-7 -C 23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
24)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;24&#39;
numactl -i 0-7 -C 24 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
25)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;25&#39;
numactl -i 0-7 -C 25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
26)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;26&#39;
numactl -i 0-7 -C 26 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
27)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;27&#39;
numactl -i 0-7 -C 27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
28)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;28&#39;
numactl -i 0-7 -C 28 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
29)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;29&#39;
numactl -i 0-7 -C 29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
30)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;30&#39;
numactl -i 0-7 -C 30 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
31)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;31&#39;
numactl -i 0-7 -C 31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
32)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;32&#39;
numactl -i 0-7 -C 32 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
33)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;33&#39;
numactl -i 0-7 -C 33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
34)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;34&#39;
numactl -i 0-7 -C 34 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
35)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;35&#39;
numactl -i 0-7 -C 35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
36)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;36&#39;
numactl -i 0-7 -C 36 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
37)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;37&#39;
numactl -i 0-7 -C 37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
38)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;38&#39;
numactl -i 0-7 -C 38 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
39)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;39&#39;
numactl -i 0-7 -C 39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
40)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;40&#39;
numactl -i 0-7 -C 40 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
41)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;41&#39;
numactl -i 0-7 -C 41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
42)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;42&#39;
numactl -i 0-7 -C 42 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
43)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;43&#39;
numactl -i 0-7 -C 43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
44)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;44&#39;
numactl -i 0-7 -C 44 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
45)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;45&#39;
numactl -i 0-7 -C 45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
46)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;46&#39;
numactl -i 0-7 -C 46 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
47)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;47&#39;
numactl -i 0-7 -C 47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
48)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;48&#39;
numactl -i 0-7 -C 48 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
49)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;49&#39;
numactl -i 0-7 -C 49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
50)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;50&#39;
numactl -i 0-7 -C 50 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
51)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;51&#39;
numactl -i 0-7 -C 51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
52)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;52&#39;
numactl -i 0-7 -C 52 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
53)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;53&#39;
numactl -i 0-7 -C 53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
54)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;54&#39;
numactl -i 0-7 -C 54 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
55)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;55&#39;
numactl -i 0-7 -C 55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
56)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;56&#39;
numactl -i 0-7 -C 56 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
57)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;57&#39;
numactl -i 0-7 -C 57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
58)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;58&#39;
numactl -i 0-7 -C 58 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
59)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;59&#39;
numactl -i 0-7 -C 59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
60)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;60&#39;
numactl -i 0-7 -C 60 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
61)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;61&#39;
numactl -i 0-7 -C 61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
62)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;62&#39;
numactl -i 0-7 -C 62 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
63)
export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;
export GOMP_CPU_AFFINITY&#x3D;&#39;63&#39;
numactl -i 0-7 -C 63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;
;;
esac
;;
esac<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-2-编译问题"><a href="#8-2-编译问题" class="headerlink" title="8.2 编译问题"></a>8.2 编译问题</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-lc 
	解决找不到memcpy问题 
-lstdc++
	解决vtable for xxxx 问题
-lgcc_s
	undefined reference to &#96;_Unwind_Resume&#39;
	undefined reference to &#96;__popcountdi2&#39;
	
#include &lt;sys&#x2F;types.h&gt;
#include &lt;sys&#x2F;types.h&gt;
	 implicit declaration of function ‘fstat’

#include &lt;sys&#x2F;sysmacros.h&gt;
	implicit declaration of function ‘major’<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="十、Linux操作"><a href="#十、Linux操作" class="headerlink" title="十、Linux操作"></a>十、Linux操作</h1><h2 id="10-1-ncat端口转发"><a href="#10-1-ncat端口转发" class="headerlink" title="10.1 ncat端口转发"></a>10.1 ncat端口转发</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ncat --sh-exec &quot;ncat 25.8.27.6 15929&quot; -l 15929 --keep-open<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="十一、DDT安装"><a href="#十一、DDT安装" class="headerlink" title="十一、DDT安装"></a>十一、DDT安装</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># cp Licence &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;licences&#x2F;
# cp Licence.14713 &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;licences&#x2F;

export PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;bin:$PATH
export LD_LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;lib:$LD_LIBRARY_PATH
ifconfig eth3 hw ether 00:1b:21:14:15:60<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#glex高速网版本的MPI改为本地调试用
export MPICH_NO_LOCAL&#x3D;0 &#x2F;&#x2F;？不一定需要
export MPICH_NEMESIS_NETMOD&#x3D;tcp
export PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;bin:$PATH
export LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="十二、SPEC使用"><a href="#十二、SPEC使用" class="headerlink" title="十二、SPEC使用"></a>十二、SPEC使用</h1><h2 id="12-1-SPEC使用系统工具"><a href="#12-1-SPEC使用系统工具" class="headerlink" title="12.1 SPEC使用系统工具"></a>12.1 SPEC使用系统工具</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># SEPC设置使用系统的工具
vim &#x2F;home&#x2F;gs&#x2F;tools&#x2F;spack-v5&#x2F;etc&#x2F;spack&#x2F;defaults&#x2F;packages.yaml
# 参考：
..&#x2F;..&#x2F;..&#x2F;lib&#x2F;spack&#x2F;docs&#x2F;build_settings.rst<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="十三、mi协议"><a href="#十三、mi协议" class="headerlink" title="十三、mi协议"></a>十三、mi协议</h1><h2 id="13-1-使用mi启动调试"><a href="#13-1-使用mi启动调试" class="headerlink" title="13.1 使用mi启动调试"></a>13.1 使用mi启动调试</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gs@ft-svr:~&#x2F;matrix$ gdb --interpreter mi test
&#x3D;thread-group-added,id&#x3D;&quot;i1&quot;
~&quot;GNU gdb (Ubuntu 8.2.91.20190405-0ubuntu3) 8.2.91.20190405-git\n&quot;
~&quot;Copyright (C) 2019 Free Software Foundation, Inc.\n&quot;
~&quot;License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.&quot;
~&quot;\nType \&quot;show copying\&quot; and \&quot;show warranty\&quot; for details.\n&quot;
~&quot;This GDB was configured as \&quot;aarch64-linux-gnu\&quot;.\n&quot;
~&quot;Type \&quot;show configuration\&quot; for configuration details.\n&quot;
~&quot;For bug reporting instructions, please see:\n&quot;
~&quot;&lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;bugs&#x2F;&gt;.\n&quot;
~&quot;Find the GDB manual and other documentation resources online at:\n    &lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;documentation&#x2F;&gt;.&quot;
~&quot;\n\n&quot;
~&quot;For help, type \&quot;help\&quot;.\n&quot;
~&quot;Type \&quot;apropos word\&quot; to search for commands related to \&quot;word\&quot;...\n&quot;
~&quot;Reading symbols from test...\n&quot;
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-2-断点命令（BreakPoint）"><a href="#13-2-断点命令（BreakPoint）" class="headerlink" title="13.2 断点命令（BreakPoint）"></a>13.2 断点命令（BreakPoint）</h2><h3 id="13-2-1-break-after"><a href="#13-2-1-break-after" class="headerlink" title="13.2.1 -break-after"></a>13.2.1 -break-after</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-after number count
第number个断点在执行count次后有效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-2-break-condition"><a href="#13-2-2-break-condition" class="headerlink" title="13.2.2 -break-condition"></a>13.2.2 -break-condition</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-condition number expr
第number个断点在表达式expr为true时有效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-3-break-delete"><a href="#13-2-3-break-delete" class="headerlink" title="13.2.3 -break-delete"></a>13.2.3 -break-delete</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-delete(breakpoint number)+
删除指定number的多个断点<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-4-break-disable"><a href="#13-2-4-break-disable" class="headerlink" title="13.2.4 -break-disable"></a>13.2.4 -break-disable</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-disable(breakpoint number)+
使用指定Number的多个断点失效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-5-break-enable"><a href="#13-2-5-break-enable" class="headerlink" title="13.2.5 -break-enable"></a>13.2.5 -break-enable</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-enable(breakpoint number)+
使用指定Number的多个断点生效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-6-break-info"><a href="#13-2-6-break-info" class="headerlink" title="13.2.6 -break-info"></a>13.2.6 -break-info</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-info breakpoint
得到指定断点的信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-7-break-insert"><a href="#13-2-7-break-insert" class="headerlink" title="13.2.7 -break-insert"></a>13.2.7 -break-insert</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-insert
	-t				插入临时断点
	-h				插入硬件断点
	-r				插入正则断点，当函数名匹配正则表达式时生效
	-c condition    插入条件断点
	-i ignore-count 插入一个指定无效次数的断点
	-p thread  		
	line | addr(func) <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="13-2-8-break-list"><a href="#13-2-8-break-list" class="headerlink" title="13.2.8. -break-list"></a>13.2.8. -break-list</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-list
显示已插入的断点列表<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="13-2-9-break-watch"><a href="#13-2-9-break-watch" class="headerlink" title="13.2.9 -break-watch"></a>13.2.9 -break-watch</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-break-watch [-a|-r] variable
创建一个观察点，-a标识对variable读写时有效，-r标识只读时有效<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="13-3-程序环境命令-Program-Context"><a href="#13-3-程序环境命令-Program-Context" class="headerlink" title="13.3 程序环境命令(Program Context)"></a>13.3 程序环境命令(Program Context)</h2><h2 id="13-4-线程-thread"><a href="#13-4-线程-thread" class="headerlink" title="13.4 线程(thread)"></a>13.4 线程(thread)</h2><h2 id="13-5-程序执行-Program-Execution"><a href="#13-5-程序执行-Program-Execution" class="headerlink" title="13.5 程序执行(Program Execution)"></a>13.5 程序执行(Program Execution)</h2><h2 id="13-6-栈-Stack"><a href="#13-6-栈-Stack" class="headerlink" title="13.6 栈(Stack)"></a>13.6 栈(Stack)</h2><h2 id="13-7-变量-Variable"><a href="#13-7-变量-Variable" class="headerlink" title="13.7 变量(Variable)"></a>13.7 变量(Variable)</h2><h2 id="13-8-数据-Data"><a href="#13-8-数据-Data" class="headerlink" title="13.8 数据(Data)"></a>13.8 数据(Data)</h2><h2 id="13-9-跟踪点-TracePoint"><a href="#13-9-跟踪点-TracePoint" class="headerlink" title="13.9 跟踪点(TracePoint)"></a>13.9 跟踪点(TracePoint)</h2><h2 id="13-10-符号-Symbol"><a href="#13-10-符号-Symbol" class="headerlink" title="13.10 符号(Symbol)"></a>13.10 符号(Symbol)</h2><h2 id="13-11-文件-File"><a href="#13-11-文件-File" class="headerlink" title="13.11 文件(File)"></a>13.11 文件(File)</h2><h2 id="13-12-目标数据-Target-Manipulation"><a href="#13-12-目标数据-Target-Manipulation" class="headerlink" title="13.12 目标数据(Target Manipulation)"></a>13.12 目标数据(Target Manipulation)</h2><h2 id="13-13-其他"><a href="#13-13-其他" class="headerlink" title="13.13 其他"></a>13.13 其他</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">-enable-pretty-printing
-var-create - * map
-var-list-children --all-values var1 0 10

-data-evaluate-expression map
^done,value&#x3D;&quot;std::map with 140737353945088 elements&lt;error reading variable: Cannot access memory at address 0x1f0fc35f415e51&gt;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&#x2F;&#x2F;    &#x2F;&#x2F; 设置标记类型与颜色
&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 0);
&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#ee6666&quot;), 0);
&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 1);
&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#aaaaaa&quot;), 1);
&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::RightArrow, 2);
&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#eaf593&quot;), 2);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="十四、Git改密码"><a href="#十四、Git改密码" class="headerlink" title="十四、Git改密码"></a>十四、Git改密码</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">gitlab-rails console production

irb(main):002:0&gt; user&#x3D;User.where(email:&#39;cuiyingbomail@163.com&#39;).first
&#x3D;&gt; #&lt;User id:30 @cyb&gt;
irb(main):003:0&gt; user.password&#x3D;12345678
&#x3D;&gt; 12345678
irb(main):004:0&gt; user.password_confirmation&#x3D;12345678
&#x3D;&gt; 12345678
irb(main):005:0&gt; user.save!
Enqueued ActionMailer::DeliveryJob (Job ID: 540244db-c6ec-44f9-880e-72338b955aa5) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, #&lt;GlobalID:0x00007f57f5da3208 @uri&#x3D;#&lt;URI::GID gid:&#x2F;&#x2F;gitlab&#x2F;User&#x2F;30&gt;&gt;
&#x3D;&gt; true
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="十五、YHPDE（eclipse）FT部署"><a href="#十五、YHPDE（eclipse）FT部署" class="headerlink" title="十五、YHPDE（eclipse）FT部署"></a>十五、YHPDE（eclipse）FT部署</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1、安装eclipse:
	gitlab
2、插件安装，参考手册
2、新版SLURM需要
vim org.eclipse.ptp.rm.slurm.proxy_4.0.7.201104291906&#x2F;src&#x2F;ptp_slurm_proxy.c
1625行：slurm_allocation_lookup_lite -&gt; slurm_allocation_lookup
2942行: primary &#x3D; 1; -&gt;  primary &#x3D; 0;
2943行：secondary &#x3D; 2; -&gt; secondary &#x3D; 1;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/01-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%A7%84%E5%88%92/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/01-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E8%A7%84%E5%88%92/" class="post-title-link" itemprop="url">运维之综合架构--01-整体架构规划</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 13:42:39" itemprop="dateModified" datetime="2022-07-11T13:42:39+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一-、综合架构规划"><a href="#一-、综合架构规划" class="headerlink" title="一 、综合架构规划"></a>一 、综合架构规划</h2><blockquote>
<p>项目中涵盖了架构，架构中又涵盖了不同的角色（高可用、负载均衡、web集群）<br>五层架构模型–&gt; 负载均衡 web服务 存储服务 缓存服务 数据库服务（通过tcp连接）</p>
</blockquote>
<p><img src="/img/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="综合架构图"></p>
<h3 id="1-架构访问流程"><a href="#1-架构访问流程" class="headerlink" title="1 架构访问流程"></a>1 架构访问流程</h3><h4 id="1-1-用户视角"><a href="#1-1-用户视角" class="headerlink" title="1.1 用户视角"></a>1.1 用户视角</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.用户通过浏览器输入oldboyedu.com-&gt;回车
2.浏览器会发生一次跳转，分析URL-&gt;然后进行DNS解析-&gt;获取真实的公网IP地址
3.用户通过tcp的三次握手发起连接-&gt;真实的公网IP
4.连接会通过公网-&gt;路由器-&gt;交换机-&gt;抵达前端的硬件防火墙
5.防火墙根据自身访问规则，进行匹配-&gt;如果恶意的连接则拒绝-&gt;如果是正常的连接则放行
6.防火墙会将连接转发给负载均衡器-&gt;查看用户请求的内容-&gt;根据内容进行任务下发-&gt;下发给web服务器
7.web服务接收请求后会根据请求进行判断
如果是请求图片或者附件-&gt;查找存储服务器存储的静态资源
如果请求的网站上的内容-&gt;缓存服务器-&gt;如果缓存服务器没有-&gt;数据库
数据库查询完数据之后会返回数据给web服务器-&gt;同时也会返回一份给缓存服务器
8.数据库返回内容-&gt;web服务器-&gt;负载均衡-&gt;用户<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1-2-运维视角"><a href="#1-2-运维视角" class="headerlink" title="1.2 运维视角"></a>1.2 运维视角</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.用户通过公网连接（隧道）VPN服务器，这样方便管理内部主机，
2.自动化配置管理，节省人力成本，便于后期维护。统一环境，标准化
3.自动化监控服务，监控系统的运行状态，事前预警，事后追溯。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="2-架构环境规划"><a href="#2-架构环境规划" class="headerlink" title="2 架构环境规划"></a>2 架构环境规划</h3><h4 id="2-1-IP分配"><a href="#2-1-IP分配" class="headerlink" title="2.1 IP分配"></a>2.1 IP分配</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"> wanip         lanip       hostname
10.0.0.5     172.16.1.5     lb01
10.0.0.6     172.16.1.6     lb02
10.0.0.7     172.16.1.7     web01
10.0.0.8     172.16.1.8     web02
10.0.0.9     172.16.1.9     web03
10.0.0.31    172.16.1.31    nfs
10.0.0.41    172.16.1.41    backup
10.0.0.51    172.16.1.51    db01
10.0.0.61    172.16.1.61    m01
10.0.0.71    172.16.1.71    zabbix<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-2-基础环境准备"><a href="#2-2-基础环境准备" class="headerlink" title="2.2 基础环境准备"></a>2.2 基础环境准备</h4><h5 id="2-2-1-虚拟机系统和网卡准备"><a href="#2-2-1-虚拟机系统和网卡准备" class="headerlink" title="2.2.1 虚拟机系统和网卡准备"></a>2.2.1 虚拟机系统和网卡准备</h5><blockquote>
<p>安装全新Centos7系统，配置网卡为eth0及eth1命名模式<br>1.第一块网卡为NAT模式[公网环境]，配置的网段为10.0.0.0网段<br>2.第二块网卡为LAN模式[私网环境]，配置的网段为172.16.1.0网段<br>3.优化安装好的Centos7虚拟机，安装常用软件、关闭防火墙等等</p>
</blockquote>
<p>优化步骤</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 1.配置yum仓库
rm -f &#x2F;etc&#x2F;yum.repos.d&#x2F;*
curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo
curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo

# 2.安装基础软件包
yum install net-tools vim tree htop iftop \
iotop lrzsz sl wget unzip telnet nmap nc psmisc \
dos2unix bash-completion bash-completion-extra sysstat \
rsync nfs-utils httpd-tools -y

# 3.关闭防火墙firewalld
systemctl disable firewalld
systemctl stop firewalld

# 4.关闭selinux
sed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;disabled&#39; &#x2F;etc&#x2F;selinux&#x2F;config

# 5.调整单个进程最大能打开文件的数量
echo &#39;* - nofile 65535&#39; &gt;&gt; &#x2F;etc&#x2F;security&#x2F;limits.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>基于优化后的虚拟机进行克隆</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.连接克隆（需要依赖于母体）
2.完整克隆（完完全全的复制一份，占用磁盘空间）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>对新克隆的主机进行如下操作：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 1.修改主机名  
hostnamectl set-hostname backup

# 2.修改IP地址  
sed -i &#39;s#200#41#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth[01]

# 3.重启服务器<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/02-Rsync%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/02-Rsync%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">运维之综合架构--02--Rsync服务器搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:15:40" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="二、Rsync与数据备份"><a href="#二、Rsync与数据备份" class="headerlink" title="二、Rsync与数据备份"></a>二、Rsync与数据备份</h2><h3 id="2-1-备份概念"><a href="#2-1-备份概念" class="headerlink" title="2.1  备份概念"></a>2.1  备份概念</h3><p>为什么要做备份？</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">数据非常的重要
保证数据不丢失
便于快速的恢复<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>备份方式</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">完全备份，每次都进行全部备份 (效率低下, 占用空间)
增量备份，仅备份客户端与服务端差异的部分 (提高备份效率,节省空间, 适合异地备份 )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>用什么工具做备份？</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">scp  	网络之间的拷贝，全量拷贝的方式  （ssh协议）
rsync	远程同步（增量）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-2-rsync的基本概念"><a href="#2-2-rsync的基本概念" class="headerlink" title="2.2 rsync的基本概念"></a>2.2 rsync的基本概念</h3><blockquote>
<p>rsync是一款开源的备份工具，<br>可以在不同主机之间进行同步（windows和Linux之间   Mac和Linux   Linux和Linux）<br>可实现全量备份与增量备份<br>因此非常适合用于架构集中式备份或异地备份等应用</p>
</blockquote>
<p>rsync数据的同步模式</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">推送： 本地将数据上传至备份服务器上	 （上传）
拉取： 备份服务器获取本地服务器的数据  （下载）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>rsync的数据传输方式</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">本地传输（类似于使用cp命令）
远程传输（通过网络传输  a--&gt;b）
守护进程（运行一个服务一直在后台）<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>rsync选项详解</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync参数:
-a           #归档模式传输, 等于-tropgDl *
-v           #详细模式输出, 打印速率, 文件数量等 *
-z           #传输时进行压缩以提高效率 *
-r           #递归传输目录及子目录，即目录下得所有目录都同样传输。
-t           #保持文件时间信息
-o           #保持文件属主信息
-p           #保持文件权限
-g           #保持文件属组信息
-l           #保留软连接
-P           #显示同步的过程及传输时的进度等信息
-D           #保持设备文件信息
-L           #保留软连接指向的目标文件
-e           #使用的信道协议,指定替代rsh的shell程序  ssh
--exclude&#x3D;PATTERN   #指定排除不需要传输的文件模式
--exclude-from&#x3D;file #文件名所在的目录文件
--bwlimit&#x3D;100       #限速传输 *
--partial           #断点续传
--delete            #让目标目录和源目录数据保持一致 *<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-本地传输"><a href="#2-3-本地传输" class="headerlink" title="2.3 本地传输"></a>2.3 本地传输</h3><p>将&#x2F;boot文件夹拷贝到&#x2F;tmp中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync -avz &#x2F;boot &#x2F;tmp&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>将boot文件夹中的内容拷贝到&#x2F;tmp中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync -avz &#x2F;boot&#x2F; &#x2F;tmp&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-3-远程传输"><a href="#2-3-远程传输" class="headerlink" title="2.3 远程传输"></a>2.3 远程传输</h3><p>虚拟机准备</p>
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>nfs</td>
<td>172.16.1.31&#x2F;24 和 10.0.0.31&#x2F;24</td>
</tr>
<tr>
<td>backup</td>
<td>172.16.1.41&#x2F;24 和 10.0.0.41&#x2F;24</td>
</tr>
</tbody></table>
<p>backup从nfs拉取&#x2F;boo目录到本地&#x2F;tmp文件夹</p>
<pre class="line-numbers language-she" data-language="she"><code class="language-she">rsync -avz root@10.0.0.31:&#x2F;boot &#x2F;tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>backup上传&#x2F;root&#x2F;test.txt到nfs主机的&#x2F;tmp文件夹中</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync &#x2F;root&#x2F;test.txt root@10.0.0.31:&#x2F;tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="2-4-守护进程传输（服务搭建）"><a href="#2-4-守护进程传输（服务搭建）" class="headerlink" title="2.4 守护进程传输（服务搭建）"></a>2.4 守护进程传输（服务搭建）</h3><blockquote>
<p>为什么需要使用rsync守护进程传输？</p>
<p>Rsync借助SSH协议同步数据存在的缺陷（临时发送数据）<br>    1.使用系统用户（不安全）<br>    2.使用普通用户（会导致权限不足情况）</p>
</blockquote>
<p>backup充当rsync服务端，nfs充当客户端，配置步骤：</p>
<h4 id="2-4-1-服务端配置"><a href="#2-4-1-服务端配置" class="headerlink" title="2.4.1 服务端配置"></a>2.4.1 服务端配置</h4><p>获取配置文件路径</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# rpm -qc rsync
	&#x2F;etc&#x2F;rsyncd.conf			# 主配置文件
	&#x2F;etc&#x2F;sysconfig&#x2F;rsyncd		# 选项<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>编辑配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vim &#x2F;etc&#x2F;rsyncd.conf
---------------------
uid &#x3D; rsync
gid &#x3D; rsync
port &#x3D; 873
fake super &#x3D; yes
use chroot &#x3D; no
max connections &#x3D; 200
timeout &#x3D; 600
ignore errors
read only &#x3D; false
list &#x3D; false
auth users &#x3D; rsync_backup
secrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd
log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log
#####################################
[backup]
comment &#x3D; welcome to oldboyedu backup!
path &#x3D; &#x2F;backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置详细解析</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">uid &#x3D; rsync                      # 运行进程的用户
gid &#x3D; rsync                      # 运行进程的用户组
port &#x3D; 873                       # 监听端口
fake super &#x3D; yes                 # 无需让rsync以root身份运行，允许接收文件的完整属性
use chroot &#x3D; no                  # 禁锢推送的数据至某个目录, 不允许跳出该目录
max connections &#x3D; 200            # 最大连接数
timeout &#x3D; 600                    # 超时时间
ignore errors                    # 忽略错误信息
read only &#x3D; false                # 对备份数据可读写
list &#x3D; false                     # 不允许查看模块信息
auth users &#x3D; rsync_backup        # 定义虚拟用户，作为连接认证用户
secrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd # 定义rsync服务用户连接认证密码文件路径
log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log   # 日志文件
#####################################
[backup]                # 定义模块信息
comment &#x3D; commit        # 模块注释信息
path &#x3D; &#x2F;backup          # 定义接收备份数据目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建rsync进程启动时需要使用的用户</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# useradd rsync -M -s &#x2F;sbin&#x2F;nologin 
[root@backup ~]# id rsync
uid&#x3D;1000(rsync) gid&#x3D;1000(rsync) groups&#x3D;1000(rsync)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">&#x2F;etc&#x2F;rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码
[root@backup ~]# echo &quot;rsync_backup:123456&quot; &gt; &#x2F;etc&#x2F;rsync.passwd
[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>创建存储备份数据的目录，并进行授权</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# mkdir &#x2F;backup
[root@backup ~]# chown -R rsync.rsync &#x2F;backup&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>启动rsync服务并加入开机自启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# systemctl start rsyncd.service 
[root@backup ~]# systemctl enable rsyncd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>检查rsync的873端口是否存在</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# netstat -lntup
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name
tcp6       0      0 :::873                  :::*                    LISTEN      1269&#x2F;rsync<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-4-2-客户端测试"><a href="#2-4-2-客户端测试" class="headerlink" title="2.4.2 客户端测试"></a>2.4.2 客户端测试</h4><p>推送&#x2F;etc文件夹到服务端&#x2F;backup</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync -avz &#x2F;etc&#x2F; rsync_backup@172.16.1.41::backup
需要输入密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>从服务端&#x2F;backup拉取文件到&#x2F;tmp</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">rsync -avz rsync_backup@172.16.1.41::backup &#x2F;tmp
需要输入密码<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-5-rsync补充"><a href="#2-5-rsync补充" class="headerlink" title="2.5 rsync补充"></a>2.5 rsync补充</h3><h4 id="2-5-1-无差异同步-慎用"><a href="#2-5-1-无差异同步-慎用" class="headerlink" title="2.5.1 无差异同步(慎用)"></a>2.5.1 无差异同步(慎用)</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#推送方式实现无差异，以客户端为准，客户端有什么服务端就有什么
[root@nfs ~]# rsync -avz --delete &#x2F;root rsync_backup@172.16.1.41::backup		

#拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么
[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup &#x2F;opt&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-5-2-传输限速"><a href="#2-5-2-传输限速" class="headerlink" title="2.5.2 传输限速"></a>2.5.2 传输限速</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 生成大文件
[root@nfs ~]# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;size.disk bs&#x3D;1M count&#x3D;500  

# 限制传输的速率为1MB 
[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup
Password: 
sending incremental file list
size.disk
    118,358,016  22%    1.01MB&#x2F;s    0:06:33<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="2-5-3-取消每次传输需要输密码"><a href="#2-5-3-取消每次传输需要输密码" class="headerlink" title="2.5.3 取消每次传输需要输密码"></a>2.5.3 取消每次传输需要输密码</h4><p>在客户端配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">方式一：
[root@nfs ~]# echo &quot;123456&quot; &gt; &#x2F;etc&#x2F;rsync.pass
[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass #上该文件找123456
[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass

方式二：写Shell脚本
[root@nfs ~]# export RSYNC_PASSWORD&#x3D;123456
[root@nfs ~]# rsync -avzP .&#x2F;size.disk rsync_backup@172.16.1.41::backup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、Rsync备份案例"><a href="#三、Rsync备份案例" class="headerlink" title="三、Rsync备份案例"></a>三、Rsync备份案例</h2><blockquote>
<p>客户端需求<br>1.客户端提前准备存放的备份的目录，目录规则如下:&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端在本地打包备份(系统配置文件、应用配置等)拷贝至&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>3.客户端最后将备份的数据进行推送至备份服务器<br>4.客户端每天凌晨1点定时执行该脚本<br>5.客户端本地保留最近7天的数据, 避免浪费磁盘空间</p>
<p>服务端需求<br>1.服务端部署rsync，用于接收客户端推送过来的备份数据<br>2.服务端需要每天校验客户端推送过来的数据是否完整<br>3.服务端需要每天校验的结果通知给管理员<br>4.服务端仅保留6个月的备份数据,其余的全部删除</p>
<p>注意：所有服务器的备份目录必须都为&#x2F;backup</p>
<p>1.客户端将需要备份的文件放入指定的目录中   &#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端每天凌晨1点使用rsync命令推送一次nfs_172.16.1.31_2018-09-0<br>3.客户端保留最近7天的数据即可</p>
</blockquote>
<h3 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a>3.1 需求分析</h3><blockquote>
<p>1.我要备份什么？<br>&#x2F;etc&#x2F;fstab &#x2F;var&#x2F;spool&#x2F;cron&#x2F;USERNAME   &#x2F;server&#x2F;scripts</p>
<p>2.我要怎么备份？<br>&#x2F;backup&#x2F;主机名_ip地址_时间  命名的目录中</p>
<p>3.我要备份到哪？<br>rsync备份服务器   172.16.1.41</p>
</blockquote>
<h4 id="3-1-1-服务端配置"><a href="#3-1-1-服务端配置" class="headerlink" title="3.1.1 服务端配置"></a>3.1.1 服务端配置</h4><p>配置邮件服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# yum install mailx -y
[root@backup ~]# vim &#x2F;etc&#x2F;mail.rc
set from&#x3D;12345@qq.com
set smtp&#x3D;smtps:&#x2F;&#x2F;smtp.qq.com:465
set smtp-auth-user&#x3D;12345@qq.com
set smtp-auth-password&#x3D;xxxxxx # 授权码
set smtp-auth&#x3D;login
set ssl-verify&#x3D;ignore
set nss-config-dir&#x3D;&#x2F;etc&#x2F;pki&#x2F;nssdb&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>脚本编写</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# mkdir &#x2F;server&#x2F;scripts -p
[root@backup ~]# cat &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh
#!&#x2F;bin&#x2F;bash
#1.定义变量
PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin
SRC&#x3D;&#x2F;backup
DATE&#x3D;$(date +%F)

#1.使用md5进行校验，并保存校验的结果
md5sum -c $SRC&#x2F;*_$DATE&#x2F;flag_$DATE &gt; $SRC&#x2F;result_$DATE

#2.将保存的结果文件发送给管理员
mail -s &quot;Rsync Backup $DATE&quot; 572891887@qq.com &lt;$SRC&#x2F;result_$DATE

#3.保留最近180天的数据
find $SRC&#x2F; -type d -mtime +180|xargs rm -rf <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-1-2-客户端配置"><a href="#3-1-2-客户端配置" class="headerlink" title="3.1.2 客户端配置"></a>3.1.2 客户端配置</h4><p>创建目录</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir &#x2F;backup
mkdir -p &#x2F;server&#x2F;scripts&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>编写备份脚本</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# cat &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh
#!&#x2F;bin&#x2F;bash
#1.定义变量
PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin
SRC&#x3D;&#x2F;backup
HOST&#x3D;$(hostname)
ADDR&#x3D;$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2 &#123;print $2&#125;&#39;)
DATE&#x3D;$(date +%F)
DEST&#x3D;$&#123;HOST&#125;_$&#123;ADDR&#125;_$&#123;DATE&#125;

#2.创建目录
[ -d $SRC&#x2F;$DEST ] || mkdir -p $SRC&#x2F;$DEST

#3.备份文件
cd &#x2F; &amp;&amp; \
[ -f $SRC&#x2F;$DEST&#x2F;sys.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd &amp;&amp; \
[ -f $SRC&#x2F;$DEST&#x2F;other.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;other.tar.gz var&#x2F;spool&#x2F;cron&#x2F; server&#x2F;scripts &amp;&amp; \

#4.使用md5打标记
[ -f $SRC&#x2F;$DEST&#x2F;flag_$DATE ] || md5sum $SRC&#x2F;$DEST&#x2F;*.tar.gz  &gt; $SRC&#x2F;$DEST&#x2F;flag_$DATE 

#4.本地推送到备份服务器
export RSYNC_PASSWORD&#x3D;123456
rsync -avz $SRC&#x2F;$DEST rsync_backup@172.16.1.41::backup

#5.保留本地最近7天的数据
find $SRC&#x2F; -type d -mtime +7|xargs rm -rf <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="3-1-3-整体测试-设置定时任务"><a href="#3-1-3-整体测试-设置定时任务" class="headerlink" title="3.1.3 整体测试:设置定时任务"></a>3.1.3 整体测试:设置定时任务</h4><p>客户端每两分钟备份推送一次</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs backup]# crontab -e
*&#x2F;2 * * * * sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>服务端每3分钟校验一次，并发送确认邮件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup scripts]# crontab -e
*&#x2F;3 * * * * sh &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="3-1-5-增加客户端数量"><a href="#3-1-5-增加客户端数量" class="headerlink" title="3.1.5 增加客户端数量"></a>3.1.5 增加客户端数量</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">多创建几台客户端服务器，测试<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/03-NFS%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/03-NFS%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">运维之综合架构--03-NFS服务器搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:15:48" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>学习笔记</li>
</ul>
<hr>
<h2 id="一、NFS简介"><a href="#一、NFS简介" class="headerlink" title="一、NFS简介"></a>一、NFS简介</h2><blockquote>
<p>NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。<br>NFS系统和Windows网络共享、网络驱动器类似, 只不过windows用于局域网, NFS用于企业集群架构中<br>如果是大型网站, 会用到更复杂的分布式文件系统FastDFS（音频、小说、视频）,glusterfs（iso镜像）,HDFS<br>NFS（图片、）解决共享前端web共享</p>
</blockquote>
<h3 id="1-1-NFS有什么用？"><a href="#1-1-NFS有什么用？" class="headerlink" title="1.1 NFS有什么用？"></a>1.1 NFS有什么用？</h3><p>解决前端web静态资源的共享<br>解决前端web静态资源一致性<br>解决前端web磁盘空间的浪费</p>
<h3 id="1-2-NFS的文件操作方式"><a href="#1-2-NFS的文件操作方式" class="headerlink" title="1.2 NFS的文件操作方式"></a>1.2 NFS的文件操作方式</h3><p>1.当用户执行mkdir命令, 该命令会调用shell解释器翻译给内核。<br>2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。</p>
<h3 id="1-3-NFS的实现原理"><a href="#1-3-NFS的实现原理" class="headerlink" title="1.3 NFS的实现原理"></a>1.3 NFS的实现原理</h3><p>1.用户进程访问NFS客户端，使用不同的函数对数据进行处理<br>2.NFS客户端通过TCP&#x2F;IP的方式传递给NFS服务端。<br>3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。<br>4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。<br>5.Rpc.mount进程判断客户端是否有对应的权限进行验证。<br>6.idmap进程实现用户映射和压缩<br>7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。<br>注意: rpc是一个远程过程调用，那么使用nfs必须有rpc服务</p>
<h3 id="1-4-NFS的优缺点"><a href="#1-4-NFS的优缺点" class="headerlink" title="1.4 NFS的优缺点"></a>1.4 NFS的优缺点</h3><p>优点</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.NFS文件系统简单易用、方便部署、数据可靠、服务稳定、满足中小企业需求。
2.NFS文件系统内存放的数据都在文件系统之上，所有数据都是能看得见。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>缺点</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.存在单点故障, 如果构建高可用维护麻烦
web-&gt;nfs(sersync)-&gt;backup
2.NFS数据明文, 并不对数据做任何校验。
3.客户端挂载NFS服务没有密码验证, 安全性一般(内网使用)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>3.NFS应用建议<br>1.生产场景应将静态数据尽可能往前端推, 减少后端存储压力<br>2.必须将存储里的静态资源通过CDN缓存jpg\png\mp4\avi\css\js<br>3.如果没有缓存或架构本身历史遗留问题太大, 在多存储也无用</p>
</blockquote>
<h2 id="二、NFS部署"><a href="#二、NFS部署" class="headerlink" title="二、NFS部署"></a>二、NFS部署</h2><h3 id="2-1-服务端"><a href="#2-1-服务端" class="headerlink" title="2.1 服务端"></a>2.1 服务端</h3><p>安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# cat &#x2F;etc&#x2F;exports
&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>授权</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# mkdir &#x2F;data
[root@nfs ~]# chown -R nfsnobody.nfsnobody &#x2F;data&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>启动服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# systemctl start nfs-server
[root@nfs ~]# systemctl enable nfs-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>检查</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# cat &#x2F;var&#x2F;lib&#x2F;nfs&#x2F;etab 
&#x2F;data	172.16.1.0&#x2F;24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid&#x3D;65534,anongid&#x3D;65534,sec&#x3D;sys,rw,secure,root_squash,all_squash)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-2-客户端"><a href="#2-2-客户端" class="headerlink" title="2.2 客户端"></a>2.2 客户端</h3><p>安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>检查nfs是否有共享内容</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# showmount -e 172.16.1.31
Export list for 172.16.1.31:	
&#x2F;data 172.16.1.0&#x2F;24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>挂载nfs目录（临时）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;opt
[root@web01 ~]# df -h
Filesystem         Size  Used Avail Use% Mounted on
172.16.1.31:&#x2F;data   99G  1.8G   98G   2% &#x2F;opt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>挂载nfs目录（永久）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# vim &#x2F;etc&#x2F;fstab 
172.16.1.31:&#x2F;data  &#x2F;opt  nfs  defaults  0  0
[root@web01 ~]# mount -a   #验证fstab开机启动是否填写错误。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-NFS配置参数说明"><a href="#2-3-NFS配置参数说明" class="headerlink" title="2.3 NFS配置参数说明"></a>2.3 NFS配置参数说明</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ro				只读权限
root_squash		当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)
no_root_squash	当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)
no_all_squash	无论NFS客户端使用什么账户访问，都不进行压缩
async			优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据

rw*				读写权限
sync*			同时将数据写入到内存与硬盘中，保证不丢失数据
all_squash*		无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)
anonuid*		配置all_squash使用,指定NFS的用户UID,必须存在系统
anongid*		配置all_squash使用,指定NFS的用户UID,必须存在系统<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-4-验证ro权限"><a href="#2-4-验证ro权限" class="headerlink" title="2.4 验证ro权限"></a>2.4 验证ro权限</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# cat &#x2F;etc&#x2F;exports
&#x2F;data 172.16.1.0&#x2F;24(ro,sync,all_squash)
[root@nfs ~]# systemctl restart nfs-server

[root@web01 ~]# touch &#x2F;opt&#x2F;ttt
touch: cannot touch ‘&#x2F;opt&#x2F;ttt’: Read-only file system		#通常这样的错误都是设定的ro权限导致<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-5-验证all-squash、anonuid、anongid权限"><a href="#2-5-验证all-squash、anonuid、anongid权限" class="headerlink" title="2.5 验证all_squash、anonuid、anongid权限"></a>2.5 验证all_squash、anonuid、anongid权限</h3><p>服务端</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nfs ~]# cat &#x2F;etc&#x2F;exports
&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)
创建用户
[root@nfs ~]# groupadd -g 666 www
[root@nfs ~]# useradd -u666 -g666 www
[root@nfs ~]# id www
uid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)
授权
[root@nfs ~]# chown -R www.www &#x2F;data&#x2F;
重启
[root@nfs ~]# systemctl restart nfs-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>客户端重新挂载验证</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 opt]# touch file
[root@web01 opt]# touch test
[root@web01 opt]# ll
total 4
-rw-r--r-- 1 666 666 0 Jan  7 11:29 file
-rw-r--r-- 1 666 666 0 Jan  7 11:29 test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>PS:由于客户端没有创建id为666的www用户，因此看到的属组和属主都是666</p>
</blockquote>
<p>客户端如果觉得666不好看，建议在客户端上创建同名的用户以及uid</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# groupadd -g 666 www
[root@web01 ~]# useradd -u 666 -g 666 www
[root@web01 ~]# id www
uid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)
[root@web01 ~]# ll &#x2F;opt&#x2F;
total 4
-rw-r--r-- 1 www www 0 Jan  7 11:29 file
-rw-r--r-- 1 www www 0 Jan  7 11:29 test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/04-sersync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E5%A4%87%E4%BB%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/04-sersync%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E5%A4%87%E4%BB%BD/" class="post-title-link" itemprop="url">运维之综合架构--04--Sersync实时备份</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 13:52:13" itemprop="dateModified" datetime="2022-07-11T13:52:13+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、Sersync服务介绍"><a href="#一、Sersync服务介绍" class="headerlink" title="一、Sersync服务介绍"></a>一、Sersync服务介绍</h2><blockquote>
</blockquote>
<h3 id="1-为什么要用sersync"><a href="#1-为什么要用sersync" class="headerlink" title="1 为什么要用sersync"></a>1 为什么要用sersync</h3><ul>
<li>sersync是基于inotify开发的，类似于inotify-tools的工具</li>
<li>sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录</li>
<li>因为服务异常导致的同步失败有记录，便于恢复，确保高可用！</li>
</ul>
<h3 id="2-rsync-inotify-tools与rsync-sersync架构的区别？"><a href="#2-rsync-inotify-tools与rsync-sersync架构的区别？" class="headerlink" title="2 rsync+inotify-tools与rsync+sersync架构的区别？"></a>2 rsync+inotify-tools与rsync+sersync架构的区别？</h3><ul>
<li><p>rsync+inotify-tools</p>
<p>a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；</p>
<p>b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低</p>
</li>
<li><p>rsync+sersync</p>
<p>a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；</p>
<p>b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。</p>
</li>
</ul>
<h2 id="二、同步过程和原理"><a href="#二、同步过程和原理" class="headerlink" title="二、同步过程和原理"></a>二、同步过程和原理</h2><h3 id="1-同步过程"><a href="#1-同步过程" class="headerlink" title="1 同步过程"></a>1 同步过程</h3><ol>
<li>在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化</li>
<li>调用rsync命令把更新的文件同步到目标服务器；</li>
<li>需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务</li>
</ol>
<h3 id="2-同步原理"><a href="#2-同步原理" class="headerlink" title="2 同步原理"></a>2 同步原理</h3><ol>
<li>用户实时的往sersync服务器上写入更新文件数据；</li>
<li>此时需要在同步主服务器上配置sersync服务；</li>
<li>在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；</li>
</ol>
<blockquote>
<p>通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，再调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器。</p>
</blockquote>
<h2 id="三、案例"><a href="#三、案例" class="headerlink" title="三、案例"></a>三、案例</h2><blockquote>
<p>案例: 实现web上传视频文件，实则是写入NFS至存储，当NFS存在新的数据则会实时的复制到备份服务器</p>
</blockquote>
<table>
<thead>
<tr>
<th>角色</th>
<th>内网IP(LAN)</th>
<th>外网IP(NAT)</th>
<th>安装工具</th>
</tr>
</thead>
<tbody><tr>
<td>web01</td>
<td>eth1:172.16.1.7</td>
<td>eth0:10.0.0.7</td>
<td>httpd php</td>
</tr>
<tr>
<td>nfs-server</td>
<td>eth1:172.16.1.31</td>
<td>eth0:10.0.0.31</td>
<td>nfsServer、rsync+inotify+sersync</td>
</tr>
<tr>
<td>backup</td>
<td>eth1:172.16.1.41</td>
<td>eth0:10.0.0.41</td>
<td>rsync-server</td>
</tr>
</tbody></table>
<p><img src="/img/sersync%E6%B5%81%E7%A8%8B-1628145534424.png" alt="sersync流程"></p>
<h3 id="1-web上传视频至nfs存储"><a href="#1-web上传视频至nfs存储" class="headerlink" title="1 web上传视频至nfs存储"></a>1 web上传视频至nfs存储</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nfs存储服务  172.16.1.31
	1.安装
		[root@nfs ~]# yum install nfs-utils -y
	2.配置
		[root@nfs ~]# cat &#x2F;etc&#x2F;exports
		&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)
		
		[root@nfs ~]# groupadd -g666 www
		[root@nfs ~]# useradd -u666 -g666 www
		
		[root@nfs ~]# mkdir &#x2F;data
		[root@nfs ~]# chown -R www.www &#x2F;data
		
	3.启动
		[root@nfs ~]# systemctl restart nfs-server
		[root@nfs ~]# sysytemctl enable nfs-server
		
web服务器操作：172.16.1.7
	1.安装
		[root@web01 ~]# yum install httpd php -y
	2.配置
		进程运行的身份（最好是和nfs的匿名用户保持一致）
			# sed c 匹配到User开头的字段，替换为User www
			[root@web01 html]# sed -i &#39;&#x2F;^User&#x2F;c User www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf 	
			[root@web01 html]# sed -i &#39;&#x2F;^Group&#x2F;c Group www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf
		挂载
			[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;var&#x2F;www&#x2F;html		#核心
		上传代码
			[root@web01 ~]# cd &#x2F;var&#x2F;www&#x2F;html&#x2F;
			[root@web01 html]# rz kaoshi.zip
			[root@web01 html]# unzip kaoshi.zip
	3.启动
		[root@web01 ~]# systemctl start httpd

	4.修改上传大小
		[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini中设置：
		upload_max_filesize &#x3D; 200M;
		post_max_size &#x3D; 200M;
	
	5.注意: 修改完配置记得重启服务
	[root@web01 ~]#  systemctl restart httpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-web和nfs的数据都备份在备份服务器的-x2F-backup"><a href="#2-web和nfs的数据都备份在备份服务器的-x2F-backup" class="headerlink" title="2 web和nfs的数据都备份在备份服务器的&#x2F;backup"></a>2 web和nfs的数据都备份在备份服务器的&#x2F;backup</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">备份服务器操作如下：172.16.1.41
	1.安装
		[root@backup ~]# yum install rsync -y
	2.配置
		[root@backup ~]# cat &#x2F;etc&#x2F;rsyncd.conf
		uid &#x3D; www
		gid &#x3D; www
		port &#x3D; 873
		fake super &#x3D; yes
		use chroot &#x3D; no
		max connections &#x3D; 200
		timeout &#x3D; 600
		ignore errors
		read only &#x3D; false
		list &#x3D; true
		auth users &#x3D; rsync_backup
		secrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd
		log file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log
		#####################################
		[backup]
		path &#x3D; &#x2F;backup
		
		[data]
		path &#x3D; &#x2F;data
		
		创建用户
			[root@backup ~]# groupadd -g666 www
			[root@backup ~]# useradd -u666 -g666 www
		
		准备虚拟连接用户账号和密码
		[root@backup ~]# cat &#x2F;etc&#x2F;rsync.passwd 
		rsync_backup:123456
		[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd
		
		创建数据存放的目录
		[root@backup ~]# mkdir -p &#x2F;data &#x2F;backup
		[root@backup ~]# chown -R www.www &#x2F;data&#x2F; &#x2F;backup&#x2F;

	3.启动
		[root@backup ~]# systemctl restart rsyncd

	4.客户端执行脚本。测试rsync的备份是否ok   （客户端的数据都写入到&#x2F;backup目录中） 172.16.1.7 172.16.1.31
	[root@web01 ~]# sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh 
	sending incremental file list
	web01_172.16.1.7_2019-01-08&#x2F;
	web01_172.16.1.7_2019-01-08&#x2F;flag_2019-01-08
	web01_172.16.1.7_2019-01-08&#x2F;other.tar.gz
	web01_172.16.1.7_2019-01-08&#x2F;sys.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录"><a href="#3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录" class="headerlink" title="3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录"></a>3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">监控nfs服务器上面的&#x2F;data目录，如果发生变化则触发动作，动作可以是执行一次同步。
1.安装
	[root@nfs ~]# yum install inotify-tools		监控工具
	
	[root@nfs ~]# rz -E sersync2.5.4_64bit_binary_stable_final.tar.gz	
	[root@nfs ~]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz
	[root@nfs ~]# mv GNU-Linux-x86&#x2F; &#x2F;usr&#x2F;local&#x2F;sersync
2.配置
	[root@nfs sersync]# diff confxml.xml confxml.xml.bak
       5c5
       &lt;     &lt;fileSystem xfs&#x3D;&quot;true&quot;&#x2F;&gt;
       ---
       &gt;     &lt;fileSystem xfs&#x3D;&quot;false&quot;&#x2F;&gt;
       15c15
       &lt;       &lt;createFile start&#x3D;&quot;true&quot;&#x2F;&gt;
       ---
       &gt;       &lt;createFile start&#x3D;&quot;false&quot;&#x2F;&gt;
       19,20c19,20
       &lt;       &lt;attrib start&#x3D;&quot;true&quot;&#x2F;&gt;
       &lt;       &lt;modify start&#x3D;&quot;true&quot;&#x2F;&gt;
       ---
       &gt;       &lt;attrib start&#x3D;&quot;false&quot;&#x2F;&gt;
       &gt;       &lt;modify start&#x3D;&quot;false&quot;&#x2F;&gt;
       24,25c24,25
       &lt;       &lt;localpath watch&#x3D;&quot;&#x2F;data&quot;&gt;
       &lt;           &lt;remote ip&#x3D;&quot;172.16.1.41&quot; name&#x3D;&quot;data&quot;&#x2F;&gt;
       ---
       &gt;       &lt;localpath watch&#x3D;&quot;&#x2F;opt&#x2F;tongbu&quot;&gt;
       &gt;           &lt;remote ip&#x3D;&quot;127.0.0.1&quot; name&#x3D;&quot;tongbu1&quot;&#x2F;&gt;
       30,31c30,31
       &lt;           &lt;commonParams params&#x3D;&quot;-az&quot;&#x2F;&gt;
       &lt;           &lt;auth start&#x3D;&quot;true&quot; users&#x3D;&quot;rsync_backup&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pass&quot;&#x2F;&gt;
       ---
       &gt;           &lt;commonParams params&#x3D;&quot;-artuz&quot;&#x2F;&gt;
       &gt;           &lt;auth start&#x3D;&quot;false&quot; users&#x3D;&quot;root&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pas&quot;&#x2F;&gt;
       33c33
       &lt;           &lt;timeout start&#x3D;&quot;true&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;
       ---
       &gt;           &lt;timeout start&#x3D;&quot;false&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;

	创建客户端密码文件
	[root@nfs ~]# cat &#x2F;etc&#x2F;rsync.pass
	123456
	[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass

3.启动
[root@nfs ~]# &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2  -h
set the system param
execute：echo 50000000 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_user_watches
execute：echo 327679 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_queued_events
parse the command param
_______________________________________________________
参数-d:启用守护进程模式
参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
参数-n: 指定开启守护线程的数量，默认为10个
参数-o:指定配置文件，默认使用confxml.xml文件
参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块
参数-m:单独启用其他模块，使用 -m socket 开启socket模块
参数-m:单独启用其他模块，使用 -m http 开启http模块
不加-m参数，则默认执行同步程序

启动
[root@nfs ~]#  &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2 -dro &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;confxml.xml

#启动sersync后一定要提取同步的命令，手动运行一次，检查是否存在错误
[root@nfs ~]#  cd &#x2F;data &amp;&amp; rsync -az -R --delete .&#x2F;  --timeout&#x3D;100 rsync_backup@172.16.1.41::data --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass

停止
[root@nfs data]# pkill sersync<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）"><a href="#4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）" class="headerlink" title="4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）"></a>4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.backup服务器上需要运行和nfs服务器上一样的业务环境 
	创建用户
	[root@backup ~]# groupadd -g 666 www
	[root@backup ~]# useradd -u666 -g666 www
	配置
	[root@backup ~]# yum install -y nfs-utils -y
	[root@backup ~]# cat &#x2F;etc&#x2F;exports
	&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)
	启动
	[root@backup ~]# systemctl restart nfs-server
	
2.先实现实时的同步 √

3.在web上实现切换，卸载nfs的&#x2F;data目录，重新挂载backup服务的&#x2F;data目录
	[root@web01 ~]# umount -lf &#x2F;var&#x2F;www&#x2F;html&#x2F; &amp;&amp; mount -t nfs 172.16.1.41:&#x2F;data &#x2F;var&#x2F;www&#x2F;html&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>








      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/05-ssh%E6%9C%8D%E5%8A%A1%E8%B7%B3%E6%9D%BF%E6%9C%BA%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/05-ssh%E6%9C%8D%E5%8A%A1%E8%B7%B3%E6%9D%BF%E6%9C%BA%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">运维之综合架构--05--SSH服务器搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 13:52:30" itemprop="dateModified" datetime="2022-07-11T13:52:30+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、SSH服务器介绍"><a href="#一、SSH服务器介绍" class="headerlink" title="一、SSH服务器介绍"></a>一、SSH服务器介绍</h2><blockquote>
<p>SSH是一个安全协议，在进行数据传输时，会对数据包进行加密处理，加密后在进行数据传输。确保了数据传输安全。</p>
</blockquote>
<p><img src="/img/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95.png" alt="ssh免密登录"></p>
<h3 id="1-ssh的功能"><a href="#1-ssh的功能" class="headerlink" title="1 ssh的功能"></a>1 ssh的功能</h3><ol>
<li>提供远程连接服务器的服务</li>
<li>对传输的数据进行加密</li>
</ol>
<h3 id="2-常用服务的端口"><a href="#2-常用服务的端口" class="headerlink" title="2 常用服务的端口"></a>2 常用服务的端口</h3><ul>
<li>ftp – tcp&#x2F;20  tcp&#x2F;21</li>
<li>dns – tcp&#x2F;53  udp&#x2F;53</li>
<li>ssh  –  tcp&#x2F;22</li>
<li>telnet – tcp&#x2F;23 </li>
<li>mysql – tcp&#x2F;3306</li>
<li>http – tcp&#x2F;80</li>
<li>https – tcp&#x2F;443</li>
</ul>
<h3 id="3-telnet服务搭建"><a href="#3-telnet服务搭建" class="headerlink" title="3 telnet服务搭建"></a>3 telnet服务搭建</h3><p>安装并启动telnet服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@backup ~]# yum install telnet-server -y
[root@backup ~]# systemctl start telnet.socket 
[root@backup ~]# useradd gs
[root@backup ~]# echo &quot;1&quot; | passwd --stdin gs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用终端软件通过telnet使用gs用户登录连接</p>
<h3 id="4-telnet与ssh的对比"><a href="#4-telnet与ssh的对比" class="headerlink" title="4 telnet与ssh的对比"></a>4 telnet与ssh的对比</h3><table>
<thead>
<tr>
<th>服务连接方式</th>
<th>服务数据传输</th>
<th>服务监听端口</th>
<th>服务登陆用户</th>
</tr>
</thead>
<tbody><tr>
<td>ssh</td>
<td>加密</td>
<td>tcp&#x2F;22</td>
<td>默认支持root登录</td>
</tr>
<tr>
<td>telnet</td>
<td>明文</td>
<td>tcp&#x2F;23</td>
<td>不支持root登录</td>
</tr>
</tbody></table>
<h2 id="二、ssh与scp的使用"><a href="#二、ssh与scp的使用" class="headerlink" title="二、ssh与scp的使用"></a>二、ssh与scp的使用</h2><h3 id="1-使用ssh"><a href="#1-使用ssh" class="headerlink" title="1 使用ssh"></a>1 使用ssh</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ssh命令
	ssh 172.16.1.31					#取决当前执行此命令的用户
	ssh root@172.16.1.31			#标准的写法
	ssh -p22 root@172.16.1.31		#带端口<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-使用scp"><a href="#2-使用scp" class="headerlink" title="2 使用scp"></a>2 使用scp</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">scp 
# -P 指定端口，默认22端口可不写
# -r 表示递归拷贝目录
# -p 表示在拷贝文件前后保持文件或目录属性不变
# -l 限制传输使用带宽(默认kb) &#x2F;8 -&gt;KB  &#x2F;1024  -&gt;MB <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、使用ssh密钥登录"><a href="#三、使用ssh密钥登录" class="headerlink" title="三、使用ssh密钥登录"></a>三、使用ssh密钥登录</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.生成密钥对    公钥  私钥
[root@m01 ~]# ssh-keygen -C 7242xxxxx@qq.com
	
2.将公钥推送到你需要连接的主机，第一次需要输入对端主机的密码
[root@m01 ~]# ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub root@172.16.1.31
root@172.16.1.31&#39;s password:
	
3.通过ssh命令测试连接是否需要密码
[root@m01 ~]# ssh 172.16.1.31
Last login: Wed Jan  9 10:39:16 2019 from 172.16.1.61<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="四、ssh安全"><a href="#四、ssh安全" class="headerlink" title="四、ssh安全"></a>四、ssh安全</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@jumpserver ~]# vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config
[root@jumpserver ~]# systemctl restart sshd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>SSH作为远程连接服务，通常我们需要考虑到该服务的安全，所以需要对该服务进行安全方面的配置。<br>1.更改远程连接登陆的端口		6666<br>2.禁止ROOT管理员直接登录		<br>3.密码认证方式改为密钥认证<br>4.重要服务不使用公网IP地址<br>5.使用防火墙限制来源IP地址</p>
<p>Port 6666                       # 变更SSH服务远程连接端口√<br>PermitRootLogin         no      # 禁止root用户直接远程登录√<br>PasswordAuthentication  no      # 禁止使用密码直接远程登录√<br>UseDNS                  no      # 禁止ssh进行dns反向解析，影响ssh连接效率参数√<br>GSSAPIAuthentication    no      # 禁止GSS认证，减少连接时产生的延迟√</p>
<h2 id="五、防ssh暴力破解工具fail2ban"><a href="#五、防ssh暴力破解工具fail2ban" class="headerlink" title="五、防ssh暴力破解工具fail2ban"></a>五、防ssh暴力破解工具fail2ban</h2><blockquote>
<p>fail2ban可以监控系统日志，并且根据一定规则匹配异常IP后使用Firewalld将其屏蔽，尤其是针对一些爆破&#x2F;扫描等非常有效。</p>
</blockquote>
<p>部署流程</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.开启Firewalld防火墙
[root@bgx ~]# systemctl start firewalld
[root@bgx ~]# systemctl enable firewalld
[root@bgx ~]# firewall-cmd --state
running

2.修改firewalld规则，启用Firewalld后会禁止一些服务的传输，但默认会放行常用的22端口, 如果想添加更多，以下是放行SSH端口（22）示例，供参考：
#放行SSHD服务端口
[root@bgx ~]# firewall-cmd --permanent --add-service&#x3D;ssh --add-service&#x3D;http 
#重载配
[root@bgx ~]# firewall-cmd --reload
#查看已放行端口
[root@bgx ~]# firewall-cmd  --list-service

3.安装fail2ban,需要有epel
[root@bgx ~]# yum install fail2ban fail2ban-firewalld mailx -y

4.配置fail2ban规则.local会覆盖.conf文件
[root@bgx fail2ban]# cat &#x2F;etc&#x2F;fail2ban&#x2F;jail.local
[DEFAULT]
ignoreip &#x3D; 127.0.0.1&#x2F;8
bantime  &#x3D; 86400
findtime &#x3D; 600
maxretry &#x3D; 5
banaction &#x3D; firewallcmd-ipset
action &#x3D; %(action_mwl)s

[sshd]
enabled &#x3D; true
filter  &#x3D; sshd
port    &#x3D; 22
action &#x3D; %(action_mwl)s
logpath &#x3D; &#x2F;var&#x2F;log&#x2F;secure

5.启动服务，并检查状态
[root@bgx ~]# systemctl start fail2ban.service
[root@bgx ~]# fail2ban-client status sshd

6.清除被封掉的IP地址
[root@bgx ~]# fail2ban-client set sshd unbanip 10.0.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/06-HTTP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/06-HTTP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">运维之综合架构--06--HTTP协议介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 13:52:47" itemprop="dateModified" datetime="2022-07-11T13:52:47+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、HTTP的发展历程"><a href="#一、HTTP的发展历程" class="headerlink" title="一、HTTP的发展历程"></a>一、HTTP的发展历程</h2><p>HTTP协议始于三十年前蒂姆·伯纳斯 - 李的一篇论文</p>
<p>HTTP&#x2F;0.9 (是个简单的文本协议，只能获取文本资源；)</p>
<p>HTTP&#x2F;1.0 - 1996年 （确立了大部分现在使用的技术，参考文档，不具备实际约束力）</p>
<p>HTTP&#x2F;1.1 - 1999年 （正式标准严格遵守，功能也非常完善，互联网爆发式增长，目前互联网上使用最广泛的协议） </p>
<p>HTTP&#x2F;2 - 2015年 （基于 Google 的 SPDY 协议，注重性能改善，但还未普及）</p>
<p>HTTP&#x2F;3 - 2018年 （基于 Google 的 QUIC 协议，是将来的发展方向）</p>
<hr>
<p>课下作业</p>
<ol>
<li>你认为推动 HTTP 发展的原动力是什么？</li>
<li>你是怎么理解 HTTP（超文本传输协议）的？</li>
</ol>
<h2 id="二、HTTP简介"><a href="#二、HTTP简介" class="headerlink" title="二、HTTP简介"></a>二、HTTP简介</h2><p>HyperText transfer protocol （超文本传输协议）</p>
<ul>
<li>HTTP 是一个用在计算机世界里的协议，它确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。</li>
<li>HTTP 专门用来在两点之间传输数据，不能用于广播、寻址或路由。</li>
<li>HTTP 传输的是文字、图片、音频、视频等超文本数据。</li>
<li>HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。</li>
</ul>
<hr>
<p>课下作业：</p>
<ol>
<li>有一种流行的说法：“HTTP 是用于从互联网服务器传输超文本到本地浏览器的协议”，你认为这种说法对吗？对在哪里，又错在哪里？</li>
<li>你能再说出几个“HTTP 不是什么”吗？</li>
</ol>
<p><img src="/img/http%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png" alt="http思维导图"></p>
<h3 id="三、HTTP的应用领域"><a href="#三、HTTP的应用领域" class="headerlink" title="三、HTTP的应用领域"></a>三、HTTP的应用领域</h3><ol>
<li>互联网上绝大部分资源都使用 HTTP 协议传输；</li>
<li>浏览器是 HTTP 协议里的请求方，即 User Agent；</li>
<li>服务器是 HTTP 协议里的应答方，常用的有 Apache 和 Nginx；</li>
<li>CDN 位于浏览器和服务器之间，主要起到缓存加速的作用；</li>
<li>爬虫是另一类 User Agent，是自动访问网络资源的程序。</li>
</ol>
<hr>
<p>课后作业：</p>
<ol>
<li>你觉得 CDN 在对待浏览器和爬虫时会有差异吗？为什么？</li>
<li>你怎么理解 WebService 与 Web Server 这两个非常相似的词？</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-Nginx(%E4%B8%80)%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-Nginx(%E4%B8%80)%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">运维之综合架构--07--Nginx(一)安装与配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:16:03" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、Nginx简介"><a href="#一、Nginx简介" class="headerlink" title="一、Nginx简介"></a>一、Nginx简介</h2><p>参考网站：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/266153320">https://zhuanlan.zhihu.com/p/266153320</a></p>
<h2 id="二、Nginx安装"><a href="#二、Nginx安装" class="headerlink" title="二、Nginx安装"></a>二、Nginx安装</h2><p>​	nginx有两种安装方式，yum安装和源码编译安装</p>
<h3 id="2-1-yum安装（epel源）"><a href="#2-1-yum安装（epel源）" class="headerlink" title="2.1 yum安装（epel源）"></a>2.1 yum安装（epel源）</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo
[nginx]
name&#x3D;nginx repo
baseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;
gpgcheck&#x3D;0
enabled&#x3D;1

yum clean all
yum makecache

yum install nginx -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-编译安装"><a href="#2-2-编译安装" class="headerlink" title="2.2 编译安装"></a>2.2 编译安装</h3><p>查看yum安装的nginx的编译参数</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# nginx -V
nginx version: nginx&#x2F;1.20.1
built by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)
built with OpenSSL 1.1.1g FIPS  21 Apr 2020
TLS SNI support enabled
configure arguments: --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>源码获取</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.20.1.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>构建与编译</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 解压源码文件并进入文件夹内
tar -vxf nginx-1.20.1.tar.gz &amp;&amp; cd nginx-1.20.1

# configure构建
.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;

# 编译并安装
make -j 4 &amp;&amp; make install<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>错误解决</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 错误1：
.&#x2F;configure: error: the invalid value in --with-ld-opt&#x3D;&quot;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&quot;
解决方法：
yum -y install redhat-rpm-config.noarch

# 错误2：
.&#x2F;configure: error: the HTTP rewrite module requires the PCRE library.
You can either disable the module by using --without-http_rewrite_module
option, or install the PCRE library into the system, or build the PCRE library
statically from the source with nginx by using --with-pcre&#x3D;&lt;path&gt; option.
解决方法：
yum install pcre-devel -y

# 错误3：
.&#x2F;configure: error: SSL modules require the OpenSSL library.
You can either do not enable the modules, or install the OpenSSL library
into the system, or build the OpenSSL library statically from the source
with nginx by using --with-openssl&#x3D;&lt;path&gt; option.
解决方法：
yum install openssl openssl-devel -y

# 错误4：
.&#x2F;configure: error: the HTTP XSLT module requires the libxml2&#x2F;libxslt
libraries. You can either do not enable the module or install the libraries.
解决方法：
yum install libxml2 libxml2-devel libxslt  libxslt-devel -y

# 错误5：
.&#x2F;configure: error: the HTTP image filter module requires the GD library.
You can either do not enable the module or install the libraries.
解决方法：
yum -y install gd-devel

# 错误6：
.&#x2F;configure: error: perl module ExtUtils::Embed is required

解决方法： 
yum -y install perl-devel perl-ExtUtils-Embed

# 错误7：
.&#x2F;configure: error: the Google perftools module requires the Google perftools library
解决方法：
yum install gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64 -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-启动和停止服务"><a href="#2-3-启动和停止服务" class="headerlink" title="2.3 启动和停止服务"></a>2.3 启动和停止服务</h3><p>启动服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 先关闭httpd服务，防止冲突
[root@web01 ~]# systemctl stop httpd
[root@web01 ~]# systemctl disable httpd

# 再启动nginx服务
[root@web01 ~]# systemctl enable nginx
[root@web01 html]# systemctl start nginx
# 另一种启动方式
nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>停止服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl stop nginx 
# 或者
nginx -s stop <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>重启&#x2F;重载服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl restart&#x2F;reload nginx
nginx -s restart&#x2F;reload <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>PS：重载reload和重启restart的差别</p>
<p>reload将会等服务进程执行完再重启，而restart则是强制重启</p>
</blockquote>
<h2 id="三、Nginx目录结构说明"><a href="#三、Nginx目录结构说明" class="headerlink" title="三、Nginx目录结构说明"></a>三、Nginx目录结构说明</h2><p>查看nginx的目录结构</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 html]# rpm -ql nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137262519">https://zhuanlan.zhihu.com/p/137262519</a></p>
<h2 id="四、Nginx配置文件说明"><a href="#四、Nginx配置文件说明" class="headerlink" title="四、Nginx配置文件说明"></a>四、Nginx配置文件说明</h2><blockquote>
<p>http server location扩展了解项<br>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location<br>http{} 标签主要用来解决用户的请求与响应。<br>server{} 标签主要用来响应具体的某一个网站。<br>location{} 标签主要用于匹配网站具体URL路径。</p>
</blockquote>
<p>主配置文件说明</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 html]# cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf
---核心模块---
user nginx;	#nginx进程运行的用户
worker_processes auto;	#nginx工作的进程数量
error_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;	#nginx的错误日志【警告及其警告以上的都记录】
pid &#x2F;run&#x2F;nginx.pid;	#nginx进程运行后的进程id
---核心模块---

# Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx&#x2F;README.dynamic.
include &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;

---事件模块---
events &#123;
    worker_connections 1024; # 一个work进程的最大连接数
    use epool;				 #使用epool网络模型
&#125;
---事件模块---

---http核心层模块---
http &#123;
	# 日志格式定义
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;

    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;	# 访问日志

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;	# 长连接超时时间
    types_hash_max_size 4096;
    #gzip on;			#是否开启压缩功能			

    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;
    default_type        application&#x2F;octet-stream;

    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;	# 包含哪个目录下面的*.conf文件，用于写server

    server &#123;
        listen       80;	# 监听端口
        listen       [::]:80;
        server_name  _;		# 域名
        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;

		#charset koi8-r;			#字符集

		location &#x2F; &#123;	 			#位置
			root   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;	#代码的主文件位置
			index  index.html index.htm;	#服务端默认返回给用户的文件
		&#125;
		location &#x2F;test &#123;	 			#位置
			root   &#x2F;code&#x2F;test&#x2F;123&#x2F;;	#代码的主文件位置
			index  index.html index.htm;	#服务端默认返回给用户的文件
		&#125;

        # Load configuration files for the default server block.
        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;

        error_page 404 &#x2F;404.html;
        location &#x3D; &#x2F;404.html &#123;
        &#125;

        error_page 500 502 503 504 &#x2F;50x.html;
        location &#x3D; &#x2F;50x.html &#123;
        &#125;
    &#125;
&#125;
---http核心层模块---<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、案例：搭建web网站"><a href="#五、案例：搭建web网站" class="headerlink" title="五、案例：搭建web网站"></a>五、案例：搭建web网站</h2><p>准备配置文件ds</p>
<pre class="line-numbers language-she" data-language="she"><code class="language-she">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;game.conf
server &#123;
        listen 80;
        server_name game.oldboy.com;

        location &#x2F; &#123;
                root &#x2F;code;
                index index.html;
        &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>按照配置文件创建文件夹并放入html项目文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir &#x2F;code
cp html5.zip &#x2F;code
cd &#x2F;code
unzip html5.zip

[root@web01 code]# ls
ceshi  game  html5.zip  img  index.html  __MACOSX  readme.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重启nginx服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl restart nginx
systemctl reload nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>通过物理机浏览器浏览</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 修改hosts文件
10.0.0.7 game.oldboy.com
# 网页访问
game.oldboy.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="六、Nginx虚拟主机"><a href="#六、Nginx虚拟主机" class="headerlink" title="六、Nginx虚拟主机"></a>六、Nginx虚拟主机</h2><p>Nginx配置虚拟主机有如下三种方式：</p>
<ul>
<li>单主机多IP</li>
<li>单主机多端口</li>
<li>单主机多域名</li>
</ul>
<h3 id="6-1-基于主机多IP方式-不常用"><a href="#6-1-基于主机多IP方式-不常用" class="headerlink" title="6.1 基于主机多IP方式(不常用)"></a>6.1 基于主机多IP方式(不常用)</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cat ip.conf 
server &#123;
	listen 10.0.0.7:80;
	server_name _;

	location &#x2F; &#123;
		root &#x2F;code_ip_eth0;
		index index.html;
	&#125;
&#125;

server &#123;
	listen 172.16.1.7:80;
	server_name _;

	location &#x2F; &#123;
		root &#x2F;code_ip_eth1;
		index index.html;
	&#125;
&#125;

2.根据配置创建目录
[root@web01 conf.d]# mkdir &#x2F;code_ip_eth0
[root@web01 conf.d]# echo &quot;Eth0&quot; &gt; &#x2F;code_ip_eth0&#x2F;index.html

[root@web01 conf.d]# mkdir &#x2F;code_ip_eth1
[root@web01 conf.d]# echo &quot;Eth1&quot; &gt; &#x2F;code_ip_eth1&#x2F;index.html

3.重启nginx服务
[root@web01 conf.d]# systemctl restart nginx

4.使用curl命令测试
[root@web01 ~]# curl 172.16.1.7
Eth1
[root@web01 ~]# curl 10.0.0.7
Eth0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-2-基于主机多端口方式（多用于内部测试）"><a href="#6-2-基于主机多端口方式（多用于内部测试）" class="headerlink" title="6.2 基于主机多端口方式（多用于内部测试）"></a>6.2 基于主机多端口方式（多用于内部测试）</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.配置多端口的虚拟主机
[root@web01 conf.d]# vim port.conf
server &#123;
        listen 81;
        
        location &#x2F; &#123; 
                root &#x2F;code_81;
                index index.html;
        &#125;
&#125;
server &#123;
        listen 82;
        
        location &#x2F; &#123; 
                root &#x2F;code_82;
                index index.html;
        &#125;
&#125;		

2.根据配置文件创建所需的目录
[root@web01 conf.d]# mkdir &#x2F;code_8&#123;1..2&#125;
[root@web01 conf.d]# echo &quot;81&quot; &gt; &#x2F;code_81&#x2F;index.html
[root@web01 conf.d]# echo &quot;82&quot; &gt; &#x2F;code_82&#x2F;index.html

3.检查语法并重启服务
[root@web01 conf.d]# nginx -t
nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok
nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful
[root@web01 conf.d]# systemctl restart nginx


4.如何去访问
	http:&#x2F;&#x2F;10.0.0.7:82&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-3-基于主机多域名方式（常用）"><a href="#6-3-基于主机多域名方式（常用）" class="headerlink" title="6.3 基于主机多域名方式（常用）"></a>6.3 基于主机多域名方式（常用）</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.准备多虚拟主机配置文件
[root@web01 conf.d]# cat test1.oldboy.com.conf 
server &#123;
	listen 80;
	server_name test1.oldboy.com;

	location &#x2F; &#123;
		root &#x2F;code&#x2F;test1;
		index index.html;
	&#125;
&#125;

[root@web01 conf.d]# cat test2.oldboy.com.conf 
server &#123;
	listen 80;
	server_name test2.oldboy.com;

	location &#x2F; &#123;
		root &#x2F;code&#x2F;test2;
		index index.html;
	&#125;
&#125;

2.根据配置文件创建对应的目录
[root@web01 conf.d]# mkdir &#x2F;code&#x2F;test&#123;1..2&#125; -p
[root@web01 conf.d]# echo &quot;test1_server&quot; &gt; &#x2F;code&#x2F;test1&#x2F;index.html
[root@web01 conf.d]# echo &quot;test2_server&quot; &gt; &#x2F;code&#x2F;test2&#x2F;index.html
[root@web01 conf.d]# nginx -t
[root@web01 conf.d]# systemctl restart nginx

3.配置域名解析
10.0.0.7      test1.oldboy.com
10.0.0.7      test2.oldboy.com

4.通过浏览器访问该网站<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="七、日志与错误排查"><a href="#七、日志与错误排查" class="headerlink" title="七、日志与错误排查"></a>七、日志与错误排查</h2><h3 id="7-1-nginx配置文件自查"><a href="#7-1-nginx配置文件自查" class="headerlink" title="7.1 nginx配置文件自查"></a>7.1 nginx配置文件自查</h3><p>1.修改完配置记得检查语法</p>
<pre class="line-numbers language-none"><code class="language-none">nginx -t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2.如果没有检查语法，直接重载导致报错，可查看错误信息</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl status nginx -l <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="7-2-访问日志"><a href="#7-2-访问日志" class="headerlink" title="7.2 访问日志"></a>7.2 访问日志</h3><p>可以为server和location单独设置访问日志（<em><strong>涉及日志作用域</strong></em>）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">server &#123;
    listen 80;
    server_name code.oldboy.com;
    
    # 将当前的server网站的访问日志记录至对应的目录，使用main格式
    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;code.oldboy.com.log main;
    location &#x2F; &#123;
        root &#x2F;code;
    &#125;
	
    # 当有人请求改favicon.ico时，不记录日志
    location &#x2F;favicon.ico &#123;
        access_log off;  # off 关闭
        return 200;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>访问日志参数详解</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;
                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;
                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th><strong>变量名称</strong></th>
<th><strong>变量描述</strong></th>
<th><strong>举例说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td>$remote_addr</td>
<td>客户端地址</td>
<td>113.140.15.90</td>
</tr>
<tr>
<td>$remote_user</td>
<td>客户端用户名称</td>
<td>–</td>
</tr>
<tr>
<td>$time_local</td>
<td>访问时间和时区</td>
<td>18&#x2F;Jul&#x2F;2012:17:00:01 +0800</td>
</tr>
<tr>
<td>$request</td>
<td>请求的URI和HTTP协议</td>
<td>“GET &#x2F;pa&#x2F;img&#x2F;home&#x2F;logo-alipay-t.png HTTP&#x2F;1.1″</td>
</tr>
<tr>
<td>$http_host</td>
<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>
<td>img.alipay.com10.253.70.103</td>
</tr>
<tr>
<td>$status</td>
<td>HTTP请求状态</td>
<td>200</td>
</tr>
<tr>
<td>$upstream_status</td>
<td>upstream状态</td>
<td>200</td>
</tr>
<tr>
<td>$body_bytes_sent</td>
<td>发送给客户端文件内容大小</td>
<td>547</td>
</tr>
<tr>
<td>$http_referer</td>
<td>跳转来源</td>
<td>“<a target="_blank" rel="noopener" href="https://cashier.alip/">https://cashier.alip</a>ay.com…&#x2F;”</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>用户终端代理</td>
<td>“Mozilla&#x2F;4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident&#x2F;4.0; SV1; GTB7.0; .NET4.0C;</td>
</tr>
<tr>
<td>$ssl_protocol</td>
<td>SSL协议版本</td>
<td>TLSv1</td>
</tr>
<tr>
<td>$ssl_cipher</td>
<td>交换数据中的算法</td>
<td>RC4-SHA</td>
</tr>
<tr>
<td>$upstream_addr</td>
<td>后台upstream的地址，即真正提供服务的主机地址</td>
<td>10.228.35.247:80</td>
</tr>
<tr>
<td>$request_time</td>
<td>整个请求的总时间</td>
<td>0.205</td>
</tr>
<tr>
<td>$upstream_response_time</td>
<td>请求过程中，upstream响应时间</td>
<td>0.002</td>
</tr>
</tbody></table>
<h3 id="7-3-错误日志"><a href="#7-3-错误日志" class="headerlink" title="7.3 错误日志"></a>7.3 错误日志</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="7-4-日志切割logrotate"><a href="#7-4-日志切割logrotate" class="headerlink" title="7.4 日志切割logrotate"></a>7.4 日志切割logrotate</h3><p>配置文件，一般不需要修改，默认就行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 logrotate.d]# cat &#x2F;etc&#x2F;logrotate.d&#x2F;nginx
&#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log &#123;
    create 0640 nginx root	 	
    daily	# 每天切割日志
    rotate 10
    missingok	# 日志丢失忽略
    notifempty
    compress	# 日志文件压缩
    sharedscripts
    postrotate
        &#x2F;bin&#x2F;kill -USR1 &#96;cat &#x2F;run&#x2F;nginx.pid 2&gt;&#x2F;dev&#x2F;null&#96; 2&gt;&#x2F;dev&#x2F;null || true
    endscript
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>






      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/08-Nginx(%E4%BA%8C)%E5%B8%B8%E7%94%A8%E5%AE%98%E6%96%B9%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/08-Nginx(%E4%BA%8C)%E5%B8%B8%E7%94%A8%E5%AE%98%E6%96%B9%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">运维之综合架构--07--Nginx(二)常用官方模块</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:16:20" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>本篇主要介绍Nginx的常用官方模块</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<h2 id="一、目录索引-autoindex"><a href="#一、目录索引-autoindex" class="headerlink" title="一、目录索引-autoindex"></a>一、目录索引-autoindex</h2><h3 id="1-1-使用方法1"><a href="#1-1-使用方法1" class="headerlink" title="1.1 使用方法1"></a>1.1 使用方法1</h3><p>按此方法设置后，访问网页<a target="_blank" rel="noopener" href="http://module.test.com将显示文件目录/">http://module.test.com将显示文件目录</a></p>
<p>实际目录位于: &#x2F;module</p>
<p>a.准备配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf
server &#123;
	listen 80;
	server_name module.test.com;
	charset utf-8,gbk; # 解决中文乱码

	location &#x2F; &#123;
		root &#x2F;module;
		autoindex on;	# 开启目录索引
		autoindex_exact_size off;	# 显示文件大小，默认为on显示字节，off显示大概单位
		autoindex_localtime on;	# 默认off显示UTC时间，on显示本地时间
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>b.准备对应的目录，并往目录中添加文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mkdir &#x2F;module&#x2F;&#123;centos,ubuntu,redhat&#125;&#x2F; -p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>c.检查语法并重新加载nginx</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nginx -t 
systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="1-2-使用方法2（推荐）"><a href="#1-2-使用方法2（推荐）" class="headerlink" title="1.2 使用方法2（推荐）"></a>1.2 使用方法2（推荐）</h3><p>按此方法设置后，访问网页<a target="_blank" rel="noopener" href="http://www.module.test.com/download%E5%B0%86%E6%98%BE%E7%A4%BA%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95,%E4%B8%BB%E9%A1%B5%E5%8F%AF%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE">http://www.module.test.com/download将显示文件目录,主页可正常访问</a></p>
<p>实际目录位于：&#x2F;module&#x2F;download</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf 
server &#123;
	listen 80;
	server_name module.oldboy.com;
	charset utf-8,gbk;

	location &#x2F; &#123;	# 主页可以正常访问
		root &#x2F;code;
		index index.html index.htm;
	&#125;

	location &#x2F;download &#123;	# 当访问http:&#x2F;&#x2F;xxxx&#x2F;download则访问&#x2F;module&#x2F;download文件夹，显示目录索引
		root &#x2F;module; # 此时，访问的文件夹是&#x2F;module&#x2F;download
		autoindex on;
		autoindex_exact_size off;
		autoindex_localtime on;
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、-状态监控页面-stub-status"><a href="#二、-状态监控页面-stub-status" class="headerlink" title="二、 状态监控页面-stub_status"></a>二、 状态监控页面-stub_status</h2><blockquote>
<p>需要nginx附带–with-http_stub_status_module模块才能使用</p>
</blockquote>
<h3 id="2-1-使用方法"><a href="#2-1-使用方法" class="headerlink" title="2.1 使用方法"></a>2.1 使用方法</h3><p>a.设置配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面附加内容
location &#x2F;nginx_status &#123;
	stub_status;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>b.重启Nginx服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">重启nginx服务
systemctl reload nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>c.网页访问测试</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">访问:
http:&#x2F;&#x2F;module.test.com&#x2F;nginx_status
网页显示：
Active connections: 2 
server accepts handled requests
		3 			3 	33 
Reading: 0 Writing: 1 Waiting: 1 <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>d.通过选项关闭长连接</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证
keepalive_timeout  0;   # 类似于关闭长连接
keepalive_timeout  65;  # 65s没有活动则断开连接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面的附加内容修改为
location &#x2F;nginx_status &#123;
	stub_status;
	keepalive_timeout  0; 
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>e.再次测试网页访问</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">关闭长连接后的显示：
Active connections: 2 
server accepts handled requests
 21 21 20 
Reading: 0 Writing: 1 Waiting: 1 
# 可见每次HTTP请求都要重新发起TCP连接<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-监控页面内容解释"><a href="#2-2-监控页面内容解释" class="headerlink" title="2.2 监控页面内容解释"></a>2.2 监控页面内容解释</h3><table>
<thead>
<tr>
<th>参数项</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>Active connections</td>
<td>当前活动客户端连接数，包括Waiting等待连接数</td>
</tr>
<tr>
<td>accepts</td>
<td>已接受总的TCP连接数</td>
</tr>
<tr>
<td>handled</td>
<td>已处理总的TCP连接数</td>
</tr>
<tr>
<td>requests</td>
<td>客户端总的http请求数</td>
</tr>
<tr>
<td>Reading</td>
<td>当前nginx读取请求头的连接数</td>
</tr>
<tr>
<td>Writing</td>
<td>当前nginx将响应写回客户端的连接数</td>
</tr>
<tr>
<td>Waiting</td>
<td>当前等待请求的空闲客户端连接数</td>
</tr>
</tbody></table>
<h2 id="三、基于IP的访问控制"><a href="#三、基于IP的访问控制" class="headerlink" title="三、基于IP的访问控制"></a>三、基于IP的访问控制</h2><blockquote>
<p>某网页内的数据比较重要，怎么控制那些人可以访问，那些人不能访问呢？</p>
</blockquote>
<p>可以来源的IP地址做限制，常用的三种控制方法：</p>
<ul>
<li><p>拒绝10.0.0.1来源IP访问，其他人允许</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">location &#x2F;nginx_status &#123;
    stub_status;
    deny 10.0.0.1&#x2F;32;
    allow all;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>允许10.0.0.1来源IP访问，其他人全部拒绝</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">location &#x2F;nginx_status &#123;
    stub_status;
    allow 10.0.0.1&#x2F;32;
    deny all;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>实际配置监控Nginx状态时，仅允许该服务器的回环地址访问127.0.0.1</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 最安全
location &#x2F;nginx_status &#123;
    stub_status;
    allow 127.0.0.1;
    deny all;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="四、基于密码的身份验证"><a href="#四、基于密码的身份验证" class="headerlink" title="四、基于密码的身份验证"></a>四、基于密码的身份验证</h2><blockquote>
<p>重要数据网站，要实现需要用户名密码认证，怎么做呢？</p>
</blockquote>
<ol>
<li><p>生成一个密码文件，密码文件的格式  name:password(加密)  （建议使用htpasswd）  openssl password</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# yum install httpd-tools -y
[root@web01 conf.d]# htpasswd -c -b &#x2F;etc&#x2F;nginx&#x2F;auth_conf oldboy oldboy
[root@web01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;auth_conf
oldboy:$apr1$Kp87VSae$658Nt5bm4iiblQkUvP7u61<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>配置Nginx，限制对应的资源</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">location &#x2F;download &#123;
	root &#x2F;module;
	autoindex on;
	autoindex_exact_size off;
	autoindex_localtime on;
	
	auth_basic &quot;Please Password!!!&quot;;
	auth_basic_user_file &#x2F;etc&#x2F;nginx&#x2F;auth_conf; 
	# 注意认证文件路径，否则网页认证后会403，可是为什么放其他目录就不行？
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h2 id="五、Nginx连接限制"><a href="#五、Nginx连接限制" class="headerlink" title="五、Nginx连接限制"></a>五、Nginx连接限制</h2><blockquote>
<p>网站请求数太多，不堪重负了，怎么保障部分用户能够正常访问</p>
</blockquote>
<h3 id="5-1-限制连接数"><a href="#5-1-限制连接数" class="headerlink" title="5.1 限制连接数"></a>5.1 限制连接数</h3><p><code>设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求</code></p>
<ul>
<li><p>编辑配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># http标签段定义连接限制
http&#123;
    limit_conn_zone $binary_remote_addr zone&#x3D;conn_zone:10m;
&#125;
server &#123;
    # 同一时刻只允许一个客户端连接
    limit_conn conn_zone 1; 

    location &#x2F; &#123;
        root &#x2F;code;
        index index.html;
    &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>使用ab工具进行压力测试</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 使用ab工具进行压力测试
[root@xuliangwei ~]# yum install -y httpd-tools
[root@xuliangwei ~]# ab -n 500 -c 2  http:&#x2F;&#x2F;127.0.0.1&#x2F;index.html
# 可见500次中有失败的请求<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>查看拦截日志</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log
类似于
2019&#x2F;01&#x2F;14 11:11:22 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;
2019&#x2F;01&#x2F;14 11:11:23 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;
2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;
2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="5-2-限制请求数（更精准）"><a href="#5-2-限制请求数（更精准）" class="headerlink" title="5.2 限制请求数（更精准）"></a>5.2 限制请求数（更精准）</h3><p><code>设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。</code></p>
<ul>
<li><p>定义限制的Key</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cat test1.oldboy.com.conf 
limit_req_zone $binary_remote_addr zone&#x3D;req_zone:10m rate&#x3D;1r&#x2F;s;
server &#123;
	listen 80;
	server_name test1.oldboy.com;
	
	limit_req zone&#x3D;req_zone burst&#x3D;5 nodelay;
	limit_req_status 412;
	error_page 412 &#x2F;err.html;    #这个文件必须存在&#x2F;code&#x2F;test1&#x2F;err.html

	location &#x2F; &#123;
		root &#x2F;code&#x2F;test1;
		index index.html;
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>填写hosts域名解析 （测试：域名访问才有效果，直接访问没效果）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">echo &quot;10.0.0.7 test1.oldboy.com&quot; &gt;&gt; &#x2F;etc&#x2F;hosts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>压力测试</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ab -n 50 -c 20 http:&#x2F;&#x2F;test1.oldboy.com&#x2F;index.html<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>查看错误日志</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.737 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;
2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.611 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;
2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.450 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="六、Nginx匹配符和优先级"><a href="#六、Nginx匹配符和优先级" class="headerlink" title="六、Nginx匹配符和优先级"></a>六、Nginx匹配符和优先级</h2><p>Location语法示例</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">location [&#x3D;|^~|~|~*|!~|!~*|&#x2F;] &#x2F;uri&#x2F; &#123; ...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>匹配优先级</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">匹配符	匹配规则						优先级
&#x3D;		精确匹配						1 	用到
^~		以某个字符串开头				2
~		区分大小写的正则匹配			3	常用
~*		不区分大小写的正则匹配			4
!~		区分大小写不匹配的正则			5
!~*		不区分大小写不匹配的正则		6
&#x2F;		通用匹配，任何请求都会匹配到	7	常用<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="6-1-匹配案例"><a href="#6-1-匹配案例" class="headerlink" title="6.1 匹配案例"></a>6.1 匹配案例</h3><blockquote>
<p>参考网站：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41980405/article/details/111402208">https://blog.csdn.net/qq_41980405/article/details/111402208</a></p>
</blockquote>
<ul>
<li><p>通用匹配，任何请求都会匹配到</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
    ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>严格区分大小写，匹配以.php结尾的都走这个location    </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~ \.php$</span> <span class="token punctuation">&#123;</span>
    ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>严格区分大小写，匹配以.jsp结尾的都走这个location </p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~ \.jsp$</span> <span class="token punctuation">&#123;</span>
    ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~* .*\.(jpg|gif|png|js|css|mp4)$</span> <span class="token punctuation">&#123;</span>
    ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>不区分大小写匹配</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~* <span class="token string">"\.(sql|bak|tgz|tar.gz|.git)$"</span></span> <span class="token punctuation">&#123;</span>
    ...
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/10-Nginx(%E5%9B%9B)LNMP%E6%9E%B6%E6%9E%84%E6%8B%86%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/10-Nginx(%E5%9B%9B)LNMP%E6%9E%B6%E6%9E%84%E6%8B%86%E5%88%86/" class="post-title-link" itemprop="url">运维之综合架构--07--Nginx(四)LNMP架构拆分</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:16:31" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、拆分数据库"><a href="#一、拆分数据库" class="headerlink" title="一、拆分数据库"></a>一、拆分数据库</h2><blockquote>
<p>为什么要拆分数据库?</p>
<p>mysql内存占用大，容易引起网页访问速度变慢，甚至oom(out of memory)被系统自动kill掉，不安全</p>
</blockquote>
<h3 id="1-2-环境准备"><a href="#1-2-环境准备" class="headerlink" title="1.2 环境准备"></a>1.2 环境准备</h3><table>
<thead>
<tr>
<th>主机名称</th>
<th>应用环境</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody><tr>
<td>web01</td>
<td>nginx+php</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td></td>
<td>172.16.1.51</td>
</tr>
</tbody></table>
<h3 id="1-2-拆分过程"><a href="#1-2-拆分过程" class="headerlink" title="1.2 拆分过程"></a>1.2 拆分过程</h3><p>1、备份172.16.1.7服务器上mysql的数据</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# mysqldump -uroot -p&#39;Bgx123.com&#39; --all-databases --single-transaction &gt; mysql-all.sql<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>2、传输172.16.1.7的备份数据至172.16.1.51的服务器上</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# scp mysql-all.sql root@172.16.1.51:&#x2F;tmp<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>3、需要先在172.16.1.51服务器上安装mysql服务，然后使用mysql命令进行还原。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@db01 ~]# yum install mariadb-server mariadb -y
[root@db01 ~]# systemctl enable mariadb
[root@db01 ~]# systemctl start mariadb
[root@db01 ~]# mysql &lt;&#x2F;tmp&#x2F;mysql-all.sql
[root@db01 ~]# systemctl restart mariadb
[root@db01 ~]# mysql -uroot -pBgx123.com
MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| edusoho            |
| mysql              |
| performance_schema |
| test               |
| wordpress          |
| zh                 |
+--------------------+
7 rows in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、将web程序连接的本地数据库修改到远程数据库上。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1）先在本地172.16.1.7服务器上停止本地的数据库
[root@web01 ~]# systemctl disable mariadb
[root@web01 ~]# systemctl stop mariadb

2）在172.16.1.51的服务器上授权远程主机能够能连接mysql数据库
[root@db01 ~]# mysql -uroot -pBgx123.com
MariaDB [(none)]&gt; grant all privileges on *.* to oldboy@&#39;%&#39; identified by &#39;Bgx123.com&#39;;
解释：
*.*: 所有数据库下的所有表
oldboy@&#39;%&#39;: 允许所有网段的oldboy用户访问
identify: 设置密码

3）在172.16.1.7服务器上测试远程账户能否连接172.16.1.51的数据库
[root@web01 wordpress]# yum install mariadb -y
[root@web01 wordpress]# mysql -h 172.16.1.51 -uoldboy -pBgx123.com
MariaDB [(none)]&gt; 

4）在172.16.1.7服务器上修改web程序连接数据库的配置文件
[root@web01 wordpress]# vim &#x2F;code&#x2F;wordpress&#x2F;wp-config.php
&#x2F;&#x2F; ** MySQL 设置 - 具体信息来自您正在使用的主机 ** &#x2F;&#x2F;
&#x2F;** WordPress数据库的名称 *&#x2F;
define(&#39;DB_NAME&#39;, &#39;wordpress&#39;);

&#x2F;** MySQL数据库用户名 *&#x2F;
define(&#39;DB_USER&#39;, &#39;oldboy&#39;);

&#x2F;** MySQL数据库密码 *&#x2F;
define(&#39;DB_PASSWORD&#39;, &#39;Bgx123.com&#39;);

&#x2F;** MySQL主机 *&#x2F;
define(&#39;DB_HOST&#39;, &#39;172.16.1.51&#39;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5、拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 zh]# grep -R &quot;Bgx123.com&quot; *
	system&#x2F;config&#x2F;database.php:  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,
[root@web01 zh]# vim &#x2F;code&#x2F;zh&#x2F;system&#x2F;config&#x2F;database.php 
	$config[&#39;driver&#39;] &#x3D; &#39;MySQLi&#39;;^M
	$config[&#39;master&#39;] &#x3D; array (
	  &#39;charset&#39; &#x3D;&gt; &#39;utf8&#39;,
	  &#39;host&#39; &#x3D;&gt; &#39;172.16.1.51&#39;,
	  &#39;username&#39; &#x3D;&gt; &#39;oldboy&#39;,
	  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,
	  &#39;dbname&#39; &#x3D;&gt; &#39;zh&#39;,
	);^M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>6、拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 edusoho]# vim &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;config&#x2F;parameters.yml
database_driver: pdo_mysql
database_host: 172.16.1.51
database_port: 3306
database_name: edusoho
database_user: oldboy
database_password: &#39;Bgx123.com&#39;

必须清理缓存
[root@web01 edusoho]# rm -rf &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;cache&#x2F;*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="二、扩展多台web服务器"><a href="#二、扩展多台web服务器" class="headerlink" title="二、扩展多台web服务器"></a>二、扩展多台web服务器</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.统一环境
    0）准备对应的www用户
    [root@web02 ~]# groupadd -g666 www
    [root@web02 ~]# useradd -u666 -g666 www

    1）拷贝web01上面的yum仓库
    [root@web02 ~]# scp root@172.16.1.7:&#x2F;etc&#x2F;yum.repos.d&#x2F;*.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;

    2）安装nginx和php
    [root@web02 ~]# yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb

2.统一配置（同步web01上面的配置到web02）
    1）同步nginx
    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;nginx&#x2F; &#x2F;etc&#x2F;nginx&#x2F;
    [root@web02 ~]# nginx -t
    [root@web02 ~]# systemctl enable nginx
    [root@web02 ~]# systemctl start nginx

    2）同步php（&#x2F;etc&#x2F;php-fpm.conf &#x2F;etc&#x2F;php-fpm.d  &#x2F;etc&#x2F;php.ini）
    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;php* &#x2F;etc&#x2F;
    [root@web02 ~]# systemctl enable php-fpm
    [root@web02 ~]# systemctl start php-fpm

3.统一代码
    [root@web01 ~]# tar czf code.tar.gz &#x2F;code				#在web01上打包站点
    [root@web01 ~]# scp code.tar.gz root@172.16.1.8:&#x2F;tmp	#在web01上将打包好的代码发送给web02
    [root@web02 ~]# tar xf &#x2F;tmp&#x2F;code.tar.gz -C &#x2F;			#在web02上进行解压，并解压到&#x2F;目录下

4.配置解析，进行访问<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、NFS共享多台web的静态资源"><a href="#三、NFS共享多台web的静态资源" class="headerlink" title="三、NFS共享多台web的静态资源"></a>三、NFS共享多台web的静态资源</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">1.准备172.16.1.31共享存储服务器，规划目录，配置好权限
    0）创建用户
    [root@nfs ~]# groupadd -g666 www
    [root@nfs ~]# useradd -u666 -g666 www	

    1）安装
    [root@nfs ~]# yum install nfs-utils -y

    2）配置
    [root@nfs ~]# cat &#x2F;etc&#x2F;exports
    &#x2F;data&#x2F;blog 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)
    &#x2F;data&#x2F;zh 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)
    &#x2F;data&#x2F;edu 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)

    3）根据配置，创建目录，准备用户，授权等等
    [root@nfs ~]# rm -rf &#x2F;data&#x2F;
    [root@nfs ~]# mkdir &#x2F;data&#x2F;&#123;blog,zh,edu&#125; -p
    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;

    4）启动
    [root@nfs ~]# systemctl enable nfs-utils 
    [root@nfs ~]# systemctl restart nfs-utils

2.将图片较多的web02服务器，推送到nfs共享存储上
    http:&#x2F;&#x2F;blog.oldboy.com&#x2F;wp-content&#x2F;uploads&#x2F;2019&#x2F;01&#x2F;timg.jpg

    [root@web02 ~]# cd &#x2F;code&#x2F;wordpress&#x2F;wp-content
    [root@web02 wp-content]# scp -r uploads&#x2F;* root@172.16.1.31:&#x2F;data&#x2F;blog&#x2F;

    注意：需要上nfs服务器上进行重新的递归授权，否则会出现无法上传文件的错误
    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;

3.web01和web02分别都进行挂载，此时图片进行实现了共享
    mount -t nfs 172.16.1.31:&#x2F;data&#x2F;blog  &#x2F;code&#x2F;wordpress&#x2F;wp-content&#x2F;uploads&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/09-Nginx(%E4%B8%89)LNMP%E6%9E%B6%E6%9E%84%E5%AE%89%E8%A3%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/09-Nginx(%E4%B8%89)LNMP%E6%9E%B6%E6%9E%84%E5%AE%89%E8%A3%85/" class="post-title-link" itemprop="url">运维之综合架构--07--Nginx(三)LNMP介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-07-06 11:19:52 / 修改时间：15:16:26" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、LNMP简介-需补充"><a href="#一、LNMP简介-需补充" class="headerlink" title="一、LNMP简介(需补充)"></a>一、LNMP简介(需补充)</h2><h3 id="1-1-什么是LNMP"><a href="#1-1-什么是LNMP" class="headerlink" title="1.1 什么是LNMP"></a>1.1 什么是LNMP</h3><h3 id="1-2-LNMP架构是如何工作的"><a href="#1-2-LNMP架构是如何工作的" class="headerlink" title="1.2 LNMP架构是如何工作的"></a>1.2 LNMP架构是如何工作的</h3><p>浏览器 –http–&gt; Nginx(fastcgi_pass) –fastcgi–&gt;php(fastcgi_fpm调动wrapper再调动php解析再调用mysql)</p>
<p>大致流程：</p>
<p>用户在浏览器发起请求，如果请求的是静态资源，Nginx则直接返回，如果请求的是动态资源，Nginx会通过fastcgi协议，将请求交给PHP服务器，再返回动态资源。</p>
<h3 id="1-3-LNMP和LAMP的区别是什么"><a href="#1-3-LNMP和LAMP的区别是什么" class="headerlink" title="1.3 LNMP和LAMP的区别是什么"></a>1.3 LNMP和LAMP的区别是什么</h3><p>nginx 是以fastcgi协议调用的php<br>apache是以模块的方式加载的php</p>
<h2 id="二、LNMP架构简单搭建"><a href="#二、LNMP架构简单搭建" class="headerlink" title="二、LNMP架构简单搭建"></a>二、LNMP架构简单搭建</h2><p>1、准备一台名为nginx的服务器</p>
<p>2、使用官方仓库安装nginx</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 添加安装源
[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo 
[nginx]
name&#x3D;nginx repo
baseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;
gpgcheck&#x3D;0
enabled&#x3D;1

#安装Nginx
[root@nginx ~]# yum install nginx -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、安装php7.1</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common # 卸载默认5.4版本的php
[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;php.repo
[php]
name &#x3D; php Repository
baseurl &#x3D; http:&#x2F;&#x2F;us-east.repo.webtatic.com&#x2F;yum&#x2F;el7&#x2F;x86_64&#x2F;
gpgcheck &#x3D; 0

[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、安装maria数据库</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@nginx ~]# yum install mariadb-server mariadb -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>5、配置nginx和php集成</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;
[root@web01 conf.d]# cat php.conf 
server &#123;
	listen 80;
	server_name php.oldboy.com;
	root &#x2F;code;

	location &#x2F; &#123;
		index index.php index.html;
	&#125;

	location ~ \.php$ &#123;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>6、重载nginx</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# nginx -t
nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok
nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful
[root@web01 conf.d]# systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>7、启动php-fpm，并加入开机自启</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# systemctl start php-fpm
[root@web01 conf.d]# systemctl enable  php-fpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>8、准备一个php文件，测试nginx和php是否继承成功</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cat &#x2F;code&#x2F;page.php
&lt;?php
	phpinfo();
?&gt;
# 测试：网页访问:http:&#x2F;&#x2F;php.oldboy.com&#x2F;page.php<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>9、启动数据库</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# systemctl start mariadb
[root@web01 conf.d]# systemctl enable mariadb
[root@web01 conf.d]# mysqladmin password &#39;Bgx123.com&#39;		#配置密码（默认mysql是空密码）
[root@web01 conf.d]# mysql -uroot -pBgx123.com				#使用账号和密码登录mysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>10、准备一个php文件，测试是否可以正常连接数据库</p>
<pre class="line-numbers language-she" data-language="she"><code class="language-she">&lt;?php
  $servername &#x3D; &quot;localhost&quot;;
  $username &#x3D; &quot;root&quot;;
  $password &#x3D; &quot;Bgx123.com&quot;;

  &#x2F;&#x2F; 创建连接
  $conn &#x3D; mysqli_connect($servername, $username, $password);

  &#x2F;&#x2F; 检测连接
  if (!$conn) &#123;
      die(&quot;Connection failed: &quot; . mysqli_connect_error()); &#x2F;&#x2F; 注意格式
  &#125;
  echo &quot;php连接MySQL数据库成功&quot;;
  ?&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三、案例-搭建wordpress博客"><a href="#三、案例-搭建wordpress博客" class="headerlink" title="三、案例-搭建wordpress博客"></a>三、案例-搭建wordpress博客</h2><h3 id="3-1-环境准备"><a href="#3-1-环境准备" class="headerlink" title="3.1 环境准备"></a>3.1 环境准备</h3><table>
<thead>
<tr>
<th>用途</th>
<th>公网IP地址</th>
<th>内网IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>web服务器01</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
</tbody></table>
<h3 id="3-2-部署安装"><a href="#3-2-部署安装" class="headerlink" title="3.2 部署安装"></a>3.2 部署安装</h3><p>1、添加nginx配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cat blog.oldboy.com.conf 
server &#123;
	listen 80;
	server_name blog.oldboy.com;
	root &#x2F;code&#x2F;wordpress;

	location &#x2F; &#123;
		index index.php index.html;
	&#125;

	location ~ \.php$ &#123;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、根据nginx中定义的内容，创建站点目录并进行授权</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# mkdir &#x2F;code
[root@web01 conf.d]# cd &#x2F;code
[root@web01 code]# wget https:&#x2F;&#x2F;cn.wordpress.org&#x2F;wordpress-5.0.3-zh_CN.tar.gz
[root@web01 code]# tar xf wordpress-5.0.3-zh_CN.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#注意：如果没有该用户，启动一定会报错
[root@web01 code]# groupadd -g 666 www
[root@web01 code]# useradd -u666 -g666 www

修改nginx与php-fpm管理进程，的运行身份为www
[root@web01 code]# sed -i &#39;&#x2F;^user &#x2F;c user  www;&#39; &#x2F;etc&#x2F;nginx&#x2F;nginx.conf
[root@web01 code]# sed -i &#39;&#x2F;^user&#x2F;c user &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf 
[root@web01 code]# sed -i &#39;&#x2F;^group&#x2F;c group &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf 

一定要重启才生效
[root@web01 code]# systemctl restart nginx
[root@web01 code]# systemctl restart php-fpm

最后授权代码为www
[root@web01 code]# chown -R www.www &#x2F;code&#x2F;wordpress	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、创建数据库</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">MariaDB [(none)]&gt; create database wordpress;			#创建一个库，名称叫wordpress
Query OK, 1 row affected (0.00 sec)

MariaDB [(none)]&gt; show databases;						#查询该台数据库服务有多少个库
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
| wordpress          |
+--------------------+
5 rows in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5、解决nginx上传文件大小限制（默认1M，超过大小会报413）</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">在wordpress的nginx配置文件中添加：client_max_body_size 100m;
[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;blog.oldboy.com.conf 
server &#123;
        listen 80;
        server_name blog.oldboy.com;
        root &#x2F;code&#x2F;wordpress;
        client_max_body_size 100m;  # 默认1M，超过大小会报413

        location &#x2F; &#123;
                index index.php index.html;
        &#125;

        location ~ \.php$ &#123;
                fastcgi_pass 127.0.0.1:9000;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                include fastcgi_params;
        &#125;
&#125;
重启nginx：systemctl restart nginx	<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>测试在wordpress页面上传主题或者写文章上传图片，均出现500报错<br>查看日志文件&#x2F;var&#x2F;log&#x2F;nginx&#x2F;err.log<br>2021&#x2F;08&#x2F;16 18:59:31 [crit] 1228#1228: *2 open() “&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000001” failed (13: Permission denied), client: 10.0.0.1, server: php.gs.com, request: “POST &#x2F;wp-admin&#x2F;update.php?action&#x3D;upload-theme HTTP&#x2F;1.1”, host: “php.gs.com”, referrer: “<a target="_blank" rel="noopener" href="http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;">http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;</a><br>解决方法，参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_15941409/article/details/114640122">https://blog.csdn.net/qq_15941409/article/details/114640122</a><br>chown www:www -R &#x2F;var&#x2F;lib&#x2F;nginx&#x2F;</p>
</blockquote>
<h2 id="四、案例-搭建wecenter知乎"><a href="#四、案例-搭建wecenter知乎" class="headerlink" title="四、案例-搭建wecenter知乎"></a>四、案例-搭建wecenter知乎</h2><h3 id="4-1-部署安装"><a href="#4-1-部署安装" class="headerlink" title="4.1 部署安装"></a>4.1 部署安装</h3><p>1、添加nginx配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">server &#123;
	listen 80;
	server_name zh.oldboy.com;
	root &#x2F;code&#x2F;zh;
	client_max_body_size 100m;

	location &#x2F; &#123;
		index index.php index.html;
	&#125;

	location ~ \.php$ &#123;
		fastcgi_pass 127.0.0.1:9000;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		include fastcgi_params;
	&#125;
&#125;
[root@web01 code]# systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、wencenter部署</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 code]# rz -E WeCenter_3-2-1.zip
[root@web01 code]# unzip WeCenter_3-2-1.zip
[root@web01 code]# mv WeCenter_3-2-1 zh
[root@web01 code]# chown -R www.www zh&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>3、配置数据库</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 code]# mysql -uroot -pBgx123.com
MariaDB [(none)]&gt; create database zh;
MariaDB [(none)]&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
| wordpress          |
| zh                 |
+--------------------+
6 rows in set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="五、案例-搭建edusoho在线视频教育"><a href="#五、案例-搭建edusoho在线视频教育" class="headerlink" title="五、案例-搭建edusoho在线视频教育"></a>五、案例-搭建edusoho在线视频教育</h2><h3 id="5-1-部署安装"><a href="#5-1-部署安装" class="headerlink" title="5.1 部署安装"></a>5.1 部署安装</h3><p>1、添加nginx配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;edu.oldboy.com.conf 
server &#123;
    listen 80;
    server_name edu.oldboy.com;
    root &#x2F;code&#x2F;edusoho&#x2F;web;
    client_max_body_size 200m;

    location &#x2F; &#123;
        index app.php;
        try_files $uri @rewriteapp;
    &#125;
    location @rewriteapp &#123;
        rewrite ^(.*)$ &#x2F;app.php&#x2F;$1 last;
    &#125;

    location ~ ^&#x2F;udisk &#123;
        internal;
        root &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;;
    &#125;

    location ~ ^&#x2F;(app|app_dev)\.php(&#x2F;|$) &#123;
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_split_path_info ^(.+\.php)(&#x2F;.*)$;
        include fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
        fastcgi_param  HTTPS              off;
        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;
        fastcgi_param HTTP_X-Accel-Mapping &#x2F;udisk&#x3D;&#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;udisk;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 8 128k;
    &#125;

    # 配置设置图片格式文件
    location ~* \.(jpg|jpeg|gif|png|ico|swf)$ &#123;
        # 过期时间为3年
        expires 3y;
        # 关闭日志记录
        access_log off;
        # 关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。
        gzip off;
    &#125;
    # 配置css&#x2F;js文件
    location ~* \.(css|js)$ &#123;
        access_log off;
        expires 3y;
    &#125;
    # 禁止用户上传目录下所有.php文件的访问，提高安全性
    location ~ ^&#x2F;files&#x2F;.*\.(php|php5)$ &#123;
        deny all;
    &#125;

    # 以下配置允许运行.php的程序，方便于其他第三方系统的集成。
    location ~ \.php$ &#123;
        fastcgi_pass   127.0.0.1:9000;
        fastcgi_split_path_info ^(.+\.php)(&#x2F;.*)$;
        include fastcgi_params;
        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;
        fastcgi_param  HTTPS              off;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、下载edusoho,并授权文件夹</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">wget http:&#x2F;&#x2F;download.edusoho.com&#x2F;edusoho-8.2.17.tar.gz
tar xf edusoho-8.2.17.tar.gz
chown -R www.www edusoho<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>3、调整php的上传大小(上传文件默认有限制大小)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini
post_max_size &#x3D; 200M
upload_max_filesize &#x3D; 200M
[root@web01 code]# systemctl restart php-fpm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="六、各开源项目网站"><a href="#六、各开源项目网站" class="headerlink" title="六、各开源项目网站"></a>六、各开源项目网站</h2><p>phpmyadmin	<a target="_blank" rel="noopener" href="https://www.phpmyadmin.net/">https://www.phpmyadmin.net/</a><br>zblog	<a target="_blank" rel="noopener" href="https://www.zblogcn.com/">https://www.zblogcn.com/</a><br>wordpress	<a target="_blank" rel="noopener" href="https://cn.wordpress.org/">https://cn.wordpress.org/</a><br>wecenter	<a target="_blank" rel="noopener" href="http://www.wecenter.com/downloads/">http://www.wecenter.com/downloads/</a><br>edusohu	<a target="_blank" rel="noopener" href="http://www.edusoho.com/open/show">http://www.edusoho.com/open/show</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://gsproj.github.io/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/11-Nginx(%E4%BA%94)Nginx%E4%BB%A3%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.png">
      <meta itemprop="name" content="GongSheng">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="GongSheng Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/01_%E8%BF%90%E7%BB%B4/02-%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/11-Nginx(%E4%BA%94)Nginx%E4%BB%A3%E7%90%86/" class="post-title-link" itemprop="url">运维之综合架构--07--Nginx(五)代理介绍</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-07-06 11:19:52" itemprop="dateCreated datePublished" datetime="2022-07-06T11:19:52+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-11 13:54:01" itemprop="dateModified" datetime="2022-07-11T13:54:01+08:00">2022-07-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">（二）综合架构</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="一、什么是代理"><a href="#一、什么是代理" class="headerlink" title="一、什么是代理"></a>一、什么是代理</h2><h3 id="1-1-正向代理和反向代理的区别"><a href="#1-1-正向代理和反向代理的区别" class="headerlink" title="1.1 正向代理和反向代理的区别"></a>1.1 正向代理和反向代理的区别</h3><p>区别在于形式上服务的”对象”不一样<br>    正向代理代理的对象是客户端，为客户端服务   PC电脑<br>    反向代理代理的对象是服务端，为服务端服务	服务器</p>
<h3 id="1-2-Nginx反向代理模式配置模块"><a href="#1-2-Nginx反向代理模式配置模块" class="headerlink" title="1.2 Nginx反向代理模式配置模块"></a>1.2 Nginx反向代理模式配置模块</h3><p>反向代理模式				Nginx配置模块<br>http、websocket、https		ngx_http_proxy_module<br>fastcgi						ngx_http_fastcgi_module<br>uwsgi						ngx_http_uwsgi_module<br>grpc						ngx_http_v2_module</p>
<h2 id="二、Nginx代理配置"><a href="#二、Nginx代理配置" class="headerlink" title="二、Nginx代理配置"></a>二、Nginx代理配置</h2><h3 id="2-1-测试环境准备"><a href="#2-1-测试环境准备" class="headerlink" title="2.1 测试环境准备"></a>2.1 测试环境准备</h3><table>
<thead>
<tr>
<th>主机名称</th>
<th>应用环境</th>
<th>外网地址</th>
<th>内网地址</th>
</tr>
</thead>
<tbody><tr>
<td>web01</td>
<td>nginx + php（提供网页服务）</td>
<td>10.0.0.7</td>
<td>172.16.1.7</td>
</tr>
<tr>
<td>lb01</td>
<td>nginx（提供代理服务）</td>
<td>10.0.0.5</td>
<td>172.16.1.5</td>
</tr>
<tr>
<td>db01</td>
<td>mysql</td>
<td>10.0.0.51</td>
<td>172.16.1.51</td>
</tr>
</tbody></table>
<h3 id="2-2-Nginx代理配置步骤"><a href="#2-2-Nginx代理配置步骤" class="headerlink" title="2.2 Nginx代理配置步骤"></a>2.2 Nginx代理配置步骤</h3><p>1、<code>web01</code>-配置后端的web</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# cat web.oldboy.com.conf 
server &#123;
	listen 80;
	server_name web.oldboy.com;
	root &#x2F;web;

	location &#x2F; &#123;
		index index.php index.html;
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、创建文件夹和网页文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# mkdir &#x2F;web
[root@web01 conf.d]# echo &quot;Web01.....&quot; &gt; &#x2F;web&#x2F;index.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>3、重启nginx服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@web01 conf.d]# nginx -t
sysnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok
nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful
t[root@web01 conf.d]# systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、<code>lb01</code>-nginx代理配置</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@lb01 conf.d]# cat proxy_web.conf
server &#123;
	listen 80;
	server_name web.oldboy.com;
	location &#x2F; &#123;
		proxy_pass http:&#x2F;&#x2F;10.0.0.7:80;
		# 设置header将域名传过去
		proxy_set_header Host $http_host; 
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>5、重启Nginx服务</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">systemctl restart nginx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>6、客户机设置hosts，并测试访问网页，可以正常显示web01页面</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">10.0.0.5 web.oldboy.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/img/image-20210820101740471.png" alt="image-20210820101740471"></p>
<h2 id="三、代理流程分析"><a href="#三、代理流程分析" class="headerlink" title="三、代理流程分析"></a>三、代理流程分析</h2><p>1、走10网关，wireshark的抓包截图如下</p>
<p><img src="/img/image-20210820102735419.png" alt="image-20210820102735419"></p>
<p>2、流程图</p>
<p><img src="/img/image-20210820103041679.png" alt="image-20210820103041679"></p>
<p>3、测试，关掉web01的公网ip网口(10.0.0.7)，再尝试访问，也可以正常访问到web01的网页</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_web.conf
server &#123;
        listen 80;
        server_name  web.oldboy.com;
        location &#x2F; &#123;
                proxy_pass http:&#x2F;&#x2F;172.16.1.7:80;
                include &#x2F;etc&#x2F;nginx&#x2F;proxy_params;
        &#125;

&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>4、抓包分析</p>
<p>因为172网段走的虚拟机内部网络，抓不到</p>
<p><img src="/img/image-20210820111454152.png" alt="image-20210820111454152"></p>
<h2 id="三、Nginx代理常用参数"><a href="#三、Nginx代理常用参数" class="headerlink" title="三、Nginx代理常用参数"></a>三、Nginx代理常用参数</h2><h3 id="3-1-常用参数解释"><a href="#3-1-常用参数解释" class="headerlink" title="3.1 常用参数解释"></a>3.1 常用参数解释</h3><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>proxy_pass <a target="_blank" rel="noopener" href="http://10.0.0.7/">http://10.0.0.7:80</a>;</td>
<td></td>
</tr>
<tr>
<td>proxy_http_version 1.1;</td>
<td>代理向后端请求使用的版本</td>
</tr>
<tr>
<td>proxy_set_header Host $http_host;</td>
<td>代理向后端请求携带的域名</td>
</tr>
<tr>
<td>proxy_set_header X-Real-IP $remote_addr;</td>
<td><font color="blue">用于获取客户端真实IP（不如x-forward）</font></td>
</tr>
<tr>
<td>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</td>
<td><font color="blue">获取客户端真实IP及全链路IP</font></td>
</tr>
<tr>
<td>proxy_connect_timeout 30;</td>
<td>代理接连后端超时时间</td>
</tr>
<tr>
<td>proxy_send_timeout 60;</td>
<td>后端传递数据至代理的超时时间</td>
</tr>
<tr>
<td>proxy_read_timeout 60;</td>
<td>后端相应代理的超时时间</td>
</tr>
<tr>
<td>proxy_buffering on;</td>
<td>是否开启proxy的buffer功能</td>
</tr>
<tr>
<td>proxy_buffer_size 32k;</td>
<td>设置buffer大小</td>
</tr>
<tr>
<td>proxy_buffers 4 128k;</td>
<td>设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小</td>
</tr>
</tbody></table>
<p>X-Forwarded-For可以nginx的日志查看到</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="3-2-参数多的时候如何配置"><a href="#3-2-参数多的时候如何配置" class="headerlink" title="3.2 参数多的时候如何配置"></a>3.2 参数多的时候如何配置</h3><blockquote>
<p>可将参数写到一个文件中，然后在nginx配置文件里include包含进去</p>
</blockquote>
<p>1、创建包含参数的文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;proxy_params
proxy_set_header Host $http_host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

proxy_connect_timeout 30;
proxy_send_timeout 60;
proxy_read_timeout 60;

proxy_buffering on;
proxy_buffer_size 32k;
proxy_buffers 4 128k;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2、在配置文件中导入，方便后续多个location使用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">location &#x2F; &#123;
    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;
    include proxy_params;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="GongSheng"
      src="/images/myavatar.png">
  <p class="site-author-name" itemprop="name">GongSheng</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">69</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GongSheng</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

  <script async src="/js/cursor/fireworks.js"></script>


</body>
</html>
