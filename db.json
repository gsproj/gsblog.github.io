{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"themes/next/source/css/noscript.styl","path":"css/noscript.styl","modified":0,"renderable":1},{"_id":"themes/next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","path":"images/logo-algolia-nebula-blue-full.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"themes/next/source/images/myavatar.png","path":"images/myavatar.png","modified":0,"renderable":1},{"_id":"themes/next/source/images/xhc.jpg","path":"images/xhc.jpg","modified":0,"renderable":1},{"_id":"themes/next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/comments-buttons.js","path":"js/comments-buttons.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/comments.js","path":"js/comments.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/config.js","path":"js/config.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/pjax.js","path":"js/pjax.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schedule.js","path":"js/schedule.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/cursor/fireworks.js","path":"js/cursor/fireworks.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/schemes/muse.js","path":"js/schemes/muse.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/fancybox.js","path":"js/third-party/fancybox.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/pace.js","path":"js/third-party/pace.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/quicklink.js","path":"js/third-party/quicklink.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/rating.js","path":"js/third-party/rating.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/baidu-analytics.js","path":"js/third-party/analytics/baidu-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/google-analytics.js","path":"js/third-party/analytics/google-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/analytics/growingio.js","path":"js/third-party/analytics/growingio.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/gitter.js","path":"js/third-party/chat/gitter.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/chatra.js","path":"js/third-party/chat/chatra.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/chat/tidio.js","path":"js/third-party/chat/tidio.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/changyan.js","path":"js/third-party/comments/changyan.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/disqus.js","path":"js/third-party/comments/disqus.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/disqusjs.js","path":"js/third-party/comments/disqusjs.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/gitalk.js","path":"js/third-party/comments/gitalk.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/isso.js","path":"js/third-party/comments/isso.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/livere.js","path":"js/third-party/comments/livere.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/comments/utterances.js","path":"js/third-party/comments/utterances.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/math/katex.js","path":"js/third-party/math/katex.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/math/mathjax.js","path":"js/third-party/math/mathjax.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/search/algolia-search.js","path":"js/third-party/search/algolia-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/search/local-search.js","path":"js/third-party/search/local-search.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/statistics/lean-analytics.js","path":"js/third-party/statistics/lean-analytics.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/statistics/firestore.js","path":"js/third-party/statistics/firestore.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/tags/mermaid.js","path":"js/third-party/tags/mermaid.js","modified":0,"renderable":1},{"_id":"themes/next/source/js/third-party/tags/pdf.js","path":"js/third-party/tags/pdf.js","modified":0,"renderable":1},{"_id":"source/img/2108785-20210605105334455-1251950822.png","path":"img/2108785-20210605105334455-1251950822.png","modified":0,"renderable":0},{"_id":"source/img/http思维导图.png","path":"img/http思维导图.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820101740471.png","path":"img/image-20210820101740471.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820101707762.png","path":"img/image-20210820101707762.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820103041679.png","path":"img/image-20210820103041679.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820102735419.png","path":"img/image-20210820102735419.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820111454152.png","path":"img/image-20210820111454152.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820132420586.png","path":"img/image-20210820132420586.png","modified":0,"renderable":0},{"_id":"source/img/image-20210820132431971.png","path":"img/image-20210820132431971.png","modified":0,"renderable":0},{"_id":"source/img/image-20210821114011230.png","path":"img/image-20210821114011230.png","modified":0,"renderable":0},{"_id":"source/img/image-20210821113447825.png","path":"img/image-20210821113447825.png","modified":0,"renderable":0},{"_id":"source/img/image-20210823225246243.png","path":"img/image-20210823225246243.png","modified":0,"renderable":0},{"_id":"source/img/image-20210823225305632.png","path":"img/image-20210823225305632.png","modified":0,"renderable":0},{"_id":"source/img/image-20210823225412626.png","path":"img/image-20210823225412626.png","modified":0,"renderable":0},{"_id":"source/img/image-20210823230415237.png","path":"img/image-20210823230415237.png","modified":0,"renderable":0},{"_id":"source/img/image-20210824001613717.png","path":"img/image-20210824001613717.png","modified":0,"renderable":0},{"_id":"source/img/image-20210824001638506.png","path":"img/image-20210824001638506.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825141330005.png","path":"img/image-20210825141330005.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825141416567.png","path":"img/image-20210825141416567.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825141423629.png","path":"img/image-20210825141423629.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825142256349.png","path":"img/image-20210825142256349.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825143746986.png","path":"img/image-20210825143746986.png","modified":0,"renderable":0},{"_id":"source/img/image-20210825162829977.png","path":"img/image-20210825162829977.png","modified":0,"renderable":0},{"_id":"source/img/image-20220713102756709.png","path":"img/image-20220713102756709.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110156372.png","path":"img/image-20220715110156372.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110139880.png","path":"img/image-20220715110139880.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110229082.png","path":"img/image-20220715110229082.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110833863.png","path":"img/image-20220715110833863.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110810985.png","path":"img/image-20220715110810985.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110856325.png","path":"img/image-20220715110856325.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110908252.png","path":"img/image-20220715110908252.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715110934572.png","path":"img/image-20220715110934572.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111047082.png","path":"img/image-20220715111047082.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111100262.png","path":"img/image-20220715111100262.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111232260.png","path":"img/image-20220715111232260.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111243920.png","path":"img/image-20220715111243920.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111746387.png","path":"img/image-20220715111746387.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111737349.png","path":"img/image-20220715111737349.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715111759964.png","path":"img/image-20220715111759964.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145007138.png","path":"img/image-20220715145007138.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715144835831.png","path":"img/image-20220715144835831.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145306545.png","path":"img/image-20220715145306545.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145353695.png","path":"img/image-20220715145353695.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145556778.png","path":"img/image-20220715145556778.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145640940.png","path":"img/image-20220715145640940.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145722733.png","path":"img/image-20220715145722733.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715150723654.png","path":"img/image-20220715150723654.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715150619814.png","path":"img/image-20220715150619814.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715145825655.png","path":"img/image-20220715145825655.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715150801833.png","path":"img/image-20220715150801833.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715150832903.png","path":"img/image-20220715150832903.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715151138944.png","path":"img/image-20220715151138944.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715151303012.png","path":"img/image-20220715151303012.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715151454194.png","path":"img/image-20220715151454194.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715151735023.png","path":"img/image-20220715151735023.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715151954505.png","path":"img/image-20220715151954505.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715154822649.png","path":"img/image-20220715154822649.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715155109519.png","path":"img/image-20220715155109519.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715154849451.png","path":"img/image-20220715154849451.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715155122886.png","path":"img/image-20220715155122886.png","modified":0,"renderable":0},{"_id":"source/img/image-20220718091017221.png","path":"img/image-20220718091017221.png","modified":0,"renderable":0},{"_id":"source/img/image-20220715155230097.png","path":"img/image-20220715155230097.png","modified":0,"renderable":0},{"_id":"source/img/image-20220718091033465.png","path":"img/image-20220718091033465.png","modified":0,"renderable":0},{"_id":"source/img/image-20220718111923212.png","path":"img/image-20220718111923212.png","modified":0,"renderable":0},{"_id":"source/img/image-20220718111616313.png","path":"img/image-20220718111616313.png","modified":0,"renderable":0},{"_id":"source/img/image-20220719104324299.png","path":"img/image-20220719104324299.png","modified":0,"renderable":0},{"_id":"source/img/image-20220719101836015.png","path":"img/image-20220719101836015.png","modified":0,"renderable":0},{"_id":"source/img/image-20220718112050165.png","path":"img/image-20220718112050165.png","modified":0,"renderable":0},{"_id":"source/img/image-20220719104519550.png","path":"img/image-20220719104519550.png","modified":0,"renderable":0},{"_id":"source/img/sersync流程-1628145534424.png","path":"img/sersync流程-1628145534424.png","modified":0,"renderable":0},{"_id":"source/img/sersync流程.png","path":"img/sersync流程.png","modified":0,"renderable":0},{"_id":"source/img/单台服务器动静分离.png","path":"img/单台服务器动静分离.png","modified":0,"renderable":0},{"_id":"source/img/ssh免密登录.png","path":"img/ssh免密登录.png","modified":0,"renderable":0},{"_id":"source/img/综合架构图.png","path":"img/综合架构图.png","modified":0,"renderable":0},{"_id":"source/img/多台服务器动静分离.png","path":"img/多台服务器动静分离.png","modified":0,"renderable":0}],"Cache":[{"_id":"source/_posts/03_Python/01_Python基础/hinting.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1658128219389},{"_id":"source/_posts/03_Python/02_Python进阶/01_类与对象.md","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1658128219405},{"_id":"source/404/index.md","hash":"ba3cfc426257d1a6a56373380f0810fed451c356","modified":1657073512486},{"_id":"source/categories/index.md","hash":"717dcc1b28ff7be9d481d2558beb481f765232db","modified":1657073512517},{"_id":"source/tags/index.md","hash":"ebe0f7fb48ad73a86194375cb605a251688f0532","modified":1657073512517},{"_id":"source/img/image-20210820101740471.png","hash":"18e7ea278cd1dd9138ddb245e6e4a3c2078d0abd","modified":1631845756687},{"_id":"source/img/image-20210820111454152.png","hash":"01061728bc91403d55c29826ec53086402d7f6c4","modified":1631845756689},{"_id":"source/img/image-20210820132420586.png","hash":"81f056a663693191889f4e3ea39b8737462633f2","modified":1631845756690},{"_id":"source/img/image-20210820132431971.png","hash":"9afafddcd9c5172b54cf9cffc429803bc93a3d19","modified":1631845756692},{"_id":"source/img/image-20210823225246243.png","hash":"86b6bf04356086dc8a53cb85c50de6916411b81d","modified":1631845756695},{"_id":"source/img/image-20210823225305632.png","hash":"ba738c7ab15bdb767ab303cabaf58663f1c883f2","modified":1631845756695},{"_id":"source/img/image-20210825141416567.png","hash":"102a08731f7912e3c325a91b477a85cc2484dbbf","modified":1631845756710},{"_id":"source/img/image-20210825141423629.png","hash":"102a08731f7912e3c325a91b477a85cc2484dbbf","modified":1631845756711},{"_id":"source/img/image-20210825141330005.png","hash":"4f5886fbc1d9e766e66a8e726a0c4056f9ad7f08","modified":1631845756710},{"_id":"source/img/image-20210825162829977.png","hash":"ea24141de36016be7a97f8f53af9e02266f6954e","modified":1631845756714},{"_id":"source/img/image-20220715110156372.png","hash":"2d4c020c4e749a9a3026eff115b08570a50be2d0","modified":1658128219405},{"_id":"source/img/image-20220715110139880.png","hash":"a2afc304b3fb2b24024871b76af64d624c531e1e","modified":1658128219405},{"_id":"source/img/image-20220715110908252.png","hash":"5d8a4bcfd2325cf460ec6ee7b10810bf688bf82f","modified":1658128219405},{"_id":"source/img/image-20220715111232260.png","hash":"c36299479a7f30b1da00cf55358b372ddd78740b","modified":1658128219420},{"_id":"source/img/image-20220715111243920.png","hash":"9736ee6dd4b26281ad74b6d9dd66bfdea57675a3","modified":1658128219420},{"_id":"source/img/image-20220715145007138.png","hash":"24d4771ab5df18c1b318d0f8fbebb7714f431826","modified":1658128219420},{"_id":"source/img/image-20220715144835831.png","hash":"2aec7390254037a15688c2ec176efcc7a3afb2c6","modified":1658128219420},{"_id":"source/img/image-20220715145640940.png","hash":"1920520daa9427baa1862bfad2208ed271c1e770","modified":1658128219436},{"_id":"source/img/image-20220715145722733.png","hash":"306b324abc8be4fe8520236617c983c8f92e0d10","modified":1658128219436},{"_id":"source/img/image-20220715150723654.png","hash":"6d4e295a9fb045a9784371c5dee7e2d6b9f77569","modified":1658128219452},{"_id":"source/img/image-20220715145825655.png","hash":"1da5b3bb3ae0c63e985980eced6955066bb30b45","modified":1658128219436},{"_id":"source/img/image-20220715150801833.png","hash":"660bf52bf982adb3f0433ea2d23b76d59d117214","modified":1658128219452},{"_id":"source/img/image-20220715150832903.png","hash":"aba081cf5a4e59d1ba8aea7a730aa02474fe7abe","modified":1658128219452},{"_id":"source/img/image-20220715151303012.png","hash":"0006df733f2e0c604f224237d0a273207a8be0a8","modified":1658128219452},{"_id":"source/img/image-20220715151138944.png","hash":"e75c1990b60c7397a7e6d04242bf9f992d33b52c","modified":1658128219452},{"_id":"source/img/image-20220715151954505.png","hash":"0e2f71d5d606d8f78850af80949a68ca923f9d74","modified":1658128219452},{"_id":"source/img/image-20220715151735023.png","hash":"51b824c211dfacbfb413dacccfb0d5b4753695b2","modified":1658128219452},{"_id":"source/img/image-20220715155122886.png","hash":"cd34ad37abe749304e49b09ebd6793a2e5e7a1f7","modified":1658128219452},{"_id":"source/img/image-20220718091017221.png","hash":"7d1645bf2495606b795c5043beb7a3a98aa23e72","modified":1658128219467},{"_id":"source/img/image-20220719104324299.png","hash":"77133bde9068ea63951a610d13523be7989ecd87","modified":1658198604304},{"_id":"source/img/image-20220718111616313.png","hash":"c7a286cdb7656514d1ccbc440bf1a5c68a4c538d","modified":1658128219467},{"_id":"source/img/image-20220718112050165.png","hash":"afc8efb48f64c6b3b52421c8f7b3c045966d1314","modified":1658128219467},{"_id":"source/img/image-20220719101836015.png","hash":"01d987294b31309c8642f8665fc712acd02c2d68","modified":1658197116020},{"_id":"source/img/image-20220719104519550.png","hash":"fd48c4492cff2435b93eee25575f8f69e86913d3","modified":1658198719562},{"_id":"source/img/ssh免密登录.png","hash":"254369e6f885605d0149d9d5c1865a3c4c728779","modified":1631845756680},{"_id":"source/_posts/00_博客维护/hexo维护.md","hash":"8d30ecd2ced52ed004b04eca6f2739e3357e3f8a","modified":1658200812758},{"_id":"source/_posts/02_测试/01_POC测试工具使用指南.md","hash":"ef04b1c4b0e56b665032a87db1be2ed9781590c4","modified":1657160830604},{"_id":"source/_posts/02_测试/02_测试工具使用说明-完善中.md","hash":"324f29814eeb94b639167c2a7b18d262d83f4ef4","modified":1657161003481},{"_id":"source/_posts/04_杂记/Githubio如何绑定域名.md","hash":"05c001deb5b657059a2c9fe8ccd4235a27966aec","modified":1658128219405},{"_id":"source/_posts/04_杂记/SVN搭建.md","hash":"24a5187b216a6a98e91c450443dc82e4d490f857","modified":1657517862467},{"_id":"source/_posts/04_杂记/甲骨文VPS搭建梯子.md","hash":"7f87eb1953b725dce1028538dfe67e169151b816","modified":1658128219405},{"_id":"source/_posts/01_运维/02-综合架构/01-整体架构规划.md","hash":"10a2f443ad7bad196ca3d19002a18222f4fb7014","modified":1657518159229},{"_id":"source/_posts/04_杂记/长城TD120A2安装OpenEuler.md","hash":"73a1f46f81a4b71f44ad9ea6b161ce233a4f56ae","modified":1657517853685},{"_id":"source/_posts/01_运维/02-综合架构/02-Rsync服务搭建.md","hash":"c9601725c9f9fa16e0374deb442ebaab6e9e792e","modified":1657091740429},{"_id":"source/_posts/01_运维/02-综合架构/03-NFS服务搭建.md","hash":"c301bbe2d6d060703dfb3bf4bd0a063a53102749","modified":1657091748532},{"_id":"source/_posts/01_运维/02-综合架构/04-sersync实时同步备份.md","hash":"707203d3c5b85b97b8f2b0fad16544c7740ef457","modified":1657518733498},{"_id":"source/_posts/01_运维/02-综合架构/05-ssh服务跳板机搭建.md","hash":"8bd0947887cc3421faecbe5745e283758a8d1b16","modified":1657518750725},{"_id":"source/_posts/01_运维/02-综合架构/06-HTTP协议.md","hash":"87c85d303ac8b2cf52114db61222689ed60aec62","modified":1657518767425},{"_id":"source/_posts/01_运维/02-综合架构/07-Nginx(一)安装与配置.md","hash":"ca0cb44d0a34715852333707a106d27b1697a35b","modified":1657091763655},{"_id":"source/_posts/01_运维/02-综合架构/08-Nginx(二)常用官方模块.md","hash":"5726a8c3cd9569db3daa108c30db8b7c0d0010b7","modified":1657091780254},{"_id":"source/_posts/01_运维/02-综合架构/09-Nginx(三)LNMP架构安装.md","hash":"9c05d43b8c22d76d96eef3261bee1060715be8ab","modified":1657091786333},{"_id":"source/_posts/01_运维/02-综合架构/10-Nginx(四)LNMP架构拆分.md","hash":"18c3d5c6677345ede3a8dc54996cb68ef7f7a1b5","modified":1657091791962},{"_id":"source/_posts/01_运维/02-综合架构/11-Nginx(五)Nginx代理.md","hash":"15fa196ee3765444b8d6f649522c408504ff19ff","modified":1657518841571},{"_id":"source/_posts/01_运维/02-综合架构/13-Nginx(七)Nginx七层负载均衡调度与健康检查.md","hash":"6f710598c93206ece2ae0677e7af2496e023116f","modified":1657518906515},{"_id":"source/_posts/01_运维/02-综合架构/12-Nginx(六)Nginx七层负载均衡.md","hash":"9a6ba5a6777c6aba3d89740ce716770dcb728130","modified":1657518862015},{"_id":"source/_posts/01_运维/02-综合架构/14-Nginx(八)Nginx四层负载均衡.md","hash":"30c05204f057c9ad9412e4fcf2dc491ac058e2fa","modified":1657518926726},{"_id":"source/_posts/01_运维/02-综合架构/15-Nginx(九)动静分离和rewrite.md","hash":"55b189582e796addd071b3f0cd9884fe7767c15e","modified":1657518946377},{"_id":"source/_posts/01_运维/04-虚拟化/OpenStack学习笔记.md","hash":"4d005970ee53dcf441e1dc1f34b45468d0f27565","modified":1657092029878},{"_id":"source/_posts/01_运维/05-K8S/K8S系列-一-安装K8S.md","hash":"746ec494228ca9542ab32f6bcd2ec5d9456280d2","modified":1657092060122},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-一-安装Docker.md","hash":"02a663e4e3691fe2e3ddbd4bbc63a2a8673ee49f","modified":1657092002090},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-七-Docker镜像分层与同主机中容器互连.md","hash":"428bb59df682781a3784dd13f06e3b57f5f13df4","modified":1657091975581},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-三-容器的网络访问.md","hash":"018b97123814f60a8f5d1728ecae8468e8aa4972","modified":1657091980271},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-二-Docker常用管理命令.md","hash":"61262932d2bc74500b6475ed597c90a7e7763ab1","modified":1657091954156},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连.md","hash":"0346dbee26a54168b9c490d4d56cf6ac43805852","modified":1657091958592},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-五-手动制作docker镜像.md","hash":"227f1a287fb0128edc228160a5d1e215b6f073fc","modified":1657091997436},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-八-Docker私有仓库.md","hash":"601559e38750d5a63da90dba5f0276aa73bd6a58","modified":1657091948230},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-六-Dockfile的使用.md","hash":"0b2c2224b359bb62b9ee420fceb248227f7c5f68","modified":1657091970843},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose.md","hash":"22e018df149d9b8f339ca52bbb2217ea0d4d045b","modified":1657091985956},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-四-容器的数据卷挂载与小案例练习.md","hash":"c7c8d6c4f0b6be41b4b35a7083f065ac465233a0","modified":1657091990579},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-零-Docker介绍.md","hash":"4d84f1d9d45ec8ee3687fdbe5ca79920d600a1ff","modified":1657091964402},{"_id":"source/_posts/03_Python/01_MySQL/01-MySQL数据库-一.md","hash":"781bbd341e42a4e5b89101ca09f197ac1834bca3","modified":1658127641197},{"_id":"source/_posts/03_Python/01_Python基础/01_变量与数据类型.md","hash":"5a533eab17aac80ff0d019b1e343ac8906a9ac98","modified":1658127641198},{"_id":"source/_posts/03_Python/01_MySQL/01_MySQL数据库-一.md","hash":"4feb7fbbba5cab7788c2e47b7099ff2c72de0faa","modified":1658128219366},{"_id":"source/_posts/03_Python/01_Python基础/01_计算机核心基础.md","hash":"aef74cfb94c9486ae22adde87daa935dd6054b3e","modified":1658128219367},{"_id":"source/_posts/03_Python/01_Python基础/02_编程语言与Python介绍.md","hash":"4afbad87f35609e9707b7be96d1d062d5484bdc0","modified":1658128219368},{"_id":"source/_posts/03_Python/01_Python基础/03_Python语法入门之变量.md","hash":"6f5bad4ae019c8cc9286e49f80f7a6924fcbc506","modified":1658128219369},{"_id":"source/_posts/03_Python/01_Python基础/04_Python语法入门之基本数据类型.md","hash":"32d21ddd408d87e384cfa30796ed07c473314183","modified":1658128219370},{"_id":"source/_posts/03_Python/01_Python基础/05_Python语法入门之垃圾回收机制.md","hash":"a289b566ff37daf39a3136ac0e6285cb26332188","modified":1658128219370},{"_id":"source/_posts/03_Python/01_Python基础/06_Python语法入门之用户交互、运算符.md","hash":"a4f90aa52d0d7f73cb2bd26ef4b4457ec709179d","modified":1658128219371},{"_id":"source/_posts/03_Python/01_Python基础/07_Python语法入门之流程控制.md","hash":"f60036d5af63ef28a4987d37626acd88024376c4","modified":1658128219372},{"_id":"source/_posts/03_Python/01_Python基础/08_基本数据类型及内置方法.md","hash":"54cea55f6dc874e990b6f377e3833e390a9cc7ce","modified":1658128219373},{"_id":"source/_posts/03_Python/01_Python基础/11_函数的基本使用.md","hash":"88fabb9a979a296d7d7742e6f691244447e3e5f0","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/12_函数的参数.md","hash":"021ac11e5c1322f7008a4e5ab7fe88f4f2934e91","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/09_字符编码.md","hash":"a92ce5709c075b7aa6bbd9d2682e0724681448c5","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/13_名称空间与作用域.md","hash":"fd66fce3d0bdc60dc6fa4b55ef4352a666db4073","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/10_文件处理.md","hash":"6c466ff4bd5341c4ab68bb8e6de24d5dc06e08d6","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/15_装饰器.md","hash":"f782e11285c7c0d1e59d243a5150d7b4be627344","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/16_迭代器.md","hash":"f08ea2b7fd50a53c75fea96f46951b5e7bc85a58","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/14_函数对象和闭包.md","hash":"7dfdbe125dba88de401bf00c58b3afdd36103cd9","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/17_生成器.md","hash":"1d6c27d100a0eb6d4cda007101c4bae156263760","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/18_函数递归.md","hash":"83aa4c6e72922b548b02a2d728cfa85fba50f18d","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/19_面向过程与函数式.md","hash":"8ce183b112c1078f62b2d738f1536b2730f3ea22","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/20_模块.md","hash":"71f95b49d609774c7e631bba6eeb9a05b4043079","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/21_包.md","hash":"a6e76127c6e721de76127b19d78dc8aaac3f5f94","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/22_软件开发的目录规范.md","hash":"fd3236fc7975d54cfefeeb7746eadaad747ad345","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/24_封装.md","hash":"151a87488a66668fdd4cd2fc9c4a411b25ae64a9","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/25_继承与派生.md","hash":"cf8a9646fbb9004cedf18990523650638e53d78d","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/23_面向对象编程.md","hash":"6fe163de9afdeefeea3a81558f93bdae03ad1481","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/26_多态性与鸭子类型.md","hash":"9bbd004d9ebf0beffb5ad1cfbf41fa6152b18a0f","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/27_绑定方法与非绑定方法.md","hash":"583a73add617249ce95c0269a63a470bb88f760f","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/30_异常处理.md","hash":"08a7369172665c4638c6364ade6991b0ecbb23ad","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/28_反射、内置方法.md","hash":"1ca481f5bafd51067c1edd63a32b40acb05952e6","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/31_网络编程.md","hash":"54b9d88e4fbe444eaedd48ebb6bf245faf6e9ce4","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/29_元类.md","hash":"26a4a1f563ff1a488619f46c380e0a75df493e46","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/32_python并发编程之背景知识.md","hash":"9d32d2d2cc50f9d04dbb50d3e3aad8ea89478b5f","modified":1658128219374},{"_id":"source/_posts/03_Python/01_Python基础/33_python并发编程之多进程（理论篇）.md","hash":"86ba0edd130ee96cc59a75cc5728a76e02c0598d","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/34_python并发编程之多进程（操作篇）.md","hash":"e730d98c5d6f1eff99970e62fba716b9b5f27b97","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/36_python并发编程之多线程（操作篇）.md","hash":"5dfcda6918573e981343c184aaa3a5be165857f4","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/35_python并发编程之多线程（理论篇）.md","hash":"347f209a7bb921f7c4dc27b4fbce0e3ef76babe4","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/37_python并发编程之协程.md","hash":"1ab6e2440e6fe0d70be28f2918c22fbbc5b2c5d3","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/39_初识数据库.md","hash":"6a02acf996f0271d2956346bd20d597e5fc119d3","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/40_库相关.md","hash":"59c027329c993a2eb1c6a7cc7db0edc6d3db5323","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/38_python并发编程之IO模型.md","hash":"e1644d172c3c0f189c3c9dbad0df9abda47e8504","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/41_表相关操作.md","hash":"d2d97a5fbf411f5dd661b33e1968d65953de3db7","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/42_记录相关操作.md","hash":"f71febf1fab12a8eaeb694756c36d2d720f11b7f","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/43_数据备份、pymysql模块.md","hash":"032dcfd146d78d7ab721a03a5cbb24660e7e24e5","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/45_ORM框架SQLAlchemy.md","hash":"0a4d665cc9ed742a70e4929a62c49a6b099a68e0","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/48_附录三：Python是解释型的强类型动态语言.md","hash":"b9b6a63a605b5ca630ae75637e1ec3972adcef57","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/44_视图、触发器、事务、存储过程、函数.md","hash":"afc4cb1ee5562ac216f7a9e9079b09304aa8c884","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/46_附录一：PEP8规范.md","hash":"be00c15ed35ac2115eb05098638b39ad661dfa74","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/47_附录二：GIL新解.md","hash":"39fef2fd9c4d0a9098c1d0242d29e49284e5cc8f","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/49_附录四：Python格式化字符串的4中方式.md","hash":"b22440452be799e7f35c9eee9f9ad991f06bd274","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/51_附录六：轻松搞定位运算.md","hash":"19c0a7b4c83c8795a4c9a392b13bc52f39e0aa5a","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/50_附录五：性能测试之timeit.md","hash":"b8c3436d8d0f5049c5e8a881e7be97b0d441f712","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/52_附录七：collections之OrderedDict.md","hash":"863da1f4cbe42f13c0769a6bd5423874b29acb7c","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/53_附录八：collections--容器数据类型.md","hash":"730740430a2c63244ffc5739c5da6889af1e58a6","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/54_附录九：Type.md","hash":"75f27fec3121a2963fdd9265e174124401a378a6","modified":1658128219389},{"_id":"source/_posts/03_Python/01_Python基础/log.txt","hash":"96399e7bfcc948abf6b0dccd640d55140fcd83a8","modified":1658128219405},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/课堂笔记.md","hash":"322f17b3864ebf9d6875901c150c172597d00a4a","modified":1657091338094},{"_id":"source/_posts/01_运维/01-基础命令/day08-打包与压缩/打包与压缩笔记.md","hash":"4c4b0f2c498bb29a692e93e682d78924f2e6c6ed","modified":1657091605722},{"_id":"source/_posts/01_运维/01-基础命令/day10-Linux文件权限/笔记.md","hash":"f444b0fceb3420ae3c72f89c82046e8131c44bfd","modified":1657091599071},{"_id":"source/_posts/01_运维/01-基础命令/day09-用户组管理/笔记.md","hash":"5ff374f0f72221526c7b79179ebd4afbba075791","modified":1657091591710},{"_id":"source/_posts/01_运维/01-基础命令/day12-软件包管理/软件包.md","hash":"19f6208dc9cace38613e49dc00f74cb57fa24f7c","modified":1657091642380},{"_id":"source/_posts/01_运维/01-基础命令/day13-yum仓库/yum仓库.md","hash":"e4df917a3e683f82fe2e0daabfdbb9d8f2d2035b","modified":1657091649239},{"_id":"source/_posts/01_运维/01-基础命令/day11-sudo与su/facl.md","hash":"f7846b0b95e3a3258d28ea207a4684feaba58a9e","modified":1657091633865},{"_id":"source/_posts/01_运维/01-基础命令/day11-sudo与su/sudo and su.md","hash":"58d4a9b4921adf726900ba96446e8b8faabf626e","modified":1657091628988},{"_id":"source/_posts/01_运维/01-基础命令/day18-netstat使用/笔记.md","hash":"0d31e83c00b6942451b13de2c1a74f1a425d4455","modified":1657091669922},{"_id":"source/_posts/01_运维/01-基础命令/day16-进程管理/笔记.md","hash":"a50a37b553fae948e2bf2d1b8be7e7641a9b019f","modified":1657091655906},{"_id":"source/_posts/01_运维/01-基础命令/day20-dd与文件系统备份/笔记.md","hash":"535b57c7c2fafef4a0b88d813b5bcf013b3a6f4c","modified":1657091688372},{"_id":"source/_posts/01_运维/01-基础命令/day17-Linux信号/笔记.md","hash":"e1b67f0464b18cfcfa254d050a5867a575be8fef","modified":1657091663575},{"_id":"source/_posts/01_运维/01-基础命令/day19-磁盘分区/01_磁盘分区笔记.md","hash":"101ac19e1e5c83e8c18faa0fbd0722b8bef2a8b2","modified":1657091676999},{"_id":"source/_posts/01_运维/01-基础命令/day19-磁盘分区/02_逻辑卷管理.md","hash":"d70c7e7d3b55cbeb5ed251a12a2e94943f539035","modified":1657091681390},{"_id":"source/_posts/01_运维/01-基础命令/day21-计划任务/计划任务.md","hash":"2e4bf45ad88a22081a79990cae897ae53fbffea3","modified":1657091695036},{"_id":"source/_posts/01_运维/01-基础命令/day22-防火墙与iptables/iptables使用.md","hash":"edf1b399b540d6d1a1fe1fd8204011482e0be9ae","modified":1657091701813},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose/显示不全.png","hash":"1fcbd38eaf60396e4d1fcb9905a109f37fd3ecb3","modified":1631845756728},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121456338.png","hash":"be37c057724af25693bcc9bb9fa9d95dd29d0820","modified":1631845756506},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121236930.png","hash":"5a892a646f4abaa10164edac98f91c4d67722797","modified":1631845756505},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121745568.png","hash":"2a6598053d5db9d7a43b4ccb3f13c3c9620277f1","modified":1631845756509},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121622000.png","hash":"979d66ea72abe29ae60c1ab02dd932dd66f15b8a","modified":1631845756508},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121550128.png","hash":"ec625dcae5f1c629ef5c3e652a0c8817400774d4","modified":1631845756507},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302121408360.png","hash":"2526aabcfc8b08dd008fd1f8b1ed19925d2ded9f","modified":1631845756505},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302122035359.png","hash":"43da9a636722fb1a85d490df3c50cadc6cf22c7a","modified":1631845756510},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302122256831.png","hash":"fe4ecd61dcdaa110061184f421f21f92b9a1bb2c","modified":1631845756510},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302122359568.png","hash":"010b13c82e801141f0f553925025b324cac4860f","modified":1631845756511},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302122657199.png","hash":"a516756db669450c67b604375f93537dc9f455d0","modified":1631845756512},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302122603313.png","hash":"da5f4b898068f4a284a4e67cf96d63fd8457c3f2","modified":1631845756511},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124229475.png","hash":"3759508463e35a9ef7602bd3ade98aadbed7c1b3","modified":1631845756513},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302123826623.png","hash":"a9a5dae6f9856bf78e1dffc171a7c9bd53fd5ea1","modified":1631845756512},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124308081.png","hash":"418abe00cee9c561e0ff5803e5fc1d4fa9c72166","modified":1631845756513},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124327456.png","hash":"d15c28ec8f5adc33d67df020194ae5af8b7248fc","modified":1631845756513},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124404318.png","hash":"785f5b4a56a97dcf42b6493cf7b5d7f299227f89","modified":1631845756514},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124713502.png","hash":"e0b0f2975310efd9194eeeb25acfe275da937561","modified":1631845756514},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302124741038.png","hash":"f0eb0e76f5e1f203aae490e2a8098faa88a60d74","modified":1631845756515},{"_id":"source/_posts/01_运维/01-基础命令/day01-虚拟机安装/assets/image-20210302125049653.png","hash":"0c785d5fb81156c43ef02b5f2662706467a9210a","modified":1631845756515},{"_id":"source/_posts/01_运维/01-基础命令/day19-磁盘分区/02_逻辑卷管理.assets/134408sa12dauefffyszfg.jpg","hash":"98bb1b411ecbcd44d650eefefb16e6b0266db6e1","modified":1631845756653},{"_id":"themes/next/.editorconfig","hash":"8570735a8d8d034a3a175afd1dd40b39140b3e6a","modified":1656981398000},{"_id":"themes/next/.eslintrc.json","hash":"9c0762486f24a8c5e60f8b6c875e4c4728942649","modified":1656981398000},{"_id":"themes/next/.gitattributes","hash":"ec43734985e1cafd53d88ded3020103f7416123c","modified":1656981398000},{"_id":"themes/next/.stylintrc","hash":"2cf4d637b56d8eb423f59656a11f6403aa90f550","modified":1656981398000},{"_id":"themes/next/README.md","hash":"56638e4978154a2f2a3f03ba84047b77b4a499cc","modified":1656981398000},{"_id":"themes/next/.gitignore","hash":"417520c4dbbeab9c7e3ab10d944da0886366a0ee","modified":1656981398000},{"_id":"themes/next/LICENSE.md","hash":"68fc9a03d50fd4b5ea97092b05967d1819dea2c4","modified":1656981398000},{"_id":"themes/next/_config.yml","hash":"46e72ec53641e2cb9099c24a4e136e0eeb3374c8","modified":1658202968230},{"_id":"themes/next/_vendors.yml","hash":"4a00898e7f4e08e6b42604a33dd926ba57e11939","modified":1656981398000},{"_id":"themes/next/package.json","hash":"ed04579cb05e09d83946d898edcca4677897e328","modified":1656981398000},{"_id":"themes/next/crowdin.yml","hash":"e026078448c77dcdd9ef50256bb6635a8f83dca6","modified":1656981398000},{"_id":"themes/next/.githooks/install.js","hash":"4d77dbddf2eac1f3fc78f151d12ed22208ed655b","modified":1656981398000},{"_id":"themes/next/renovate.json","hash":"cb29cc16e61b0b8a6dac34657d76822ae29ad5aa","modified":1656981398000},{"_id":"themes/next/.githooks/pre-commit","hash":"f473eac1aaaa96c947d67988bbed140bbab1a821","modified":1656981398000},{"_id":"themes/next/.github/CODE_OF_CONDUCT.md","hash":"21cbff565a0445d3a880fff1ee417e309740a9ab","modified":1656981398000},{"_id":"themes/next/.github/CONTRIBUTING.md","hash":"330656d93b6c03df9fb1f2f0e3534c971969473b","modified":1656981398000},{"_id":"themes/next/.github/config.yml","hash":"7984e665e9de481a0e0e51fca5668337713f810b","modified":1656981398000},{"_id":"themes/next/.github/PULL_REQUEST_TEMPLATE.md","hash":"3e9fbb78e3dee0ca1dc886d0c28b0148ba0ca499","modified":1656981398000},{"_id":"themes/next/.github/label-commenter-config.yml","hash":"1097fc47beeacfc1edb0248c27b17bf64bde3565","modified":1656981398000},{"_id":"themes/next/.github/issue_label_bot.yaml","hash":"fca600ddef6f80c5e61aeed21722d191e5606e5b","modified":1656981398000},{"_id":"themes/next/.github/labeler.yml","hash":"5c4bc2bd561e6d9b33ee118cc12218c5de46f72d","modified":1656981398000},{"_id":"themes/next/.github/release-drafter.yml","hash":"423275ec021104b263cd88776936a8c8d6872b66","modified":1656981398000},{"_id":"themes/next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1656981398000},{"_id":"themes/next/docs/AUTHORS.md","hash":"a648823121563c34a177ae91f5a774b5e29f01a0","modified":1656981398000},{"_id":"themes/next/docs/LICENSE.txt","hash":"f5b14f791b7cfa1d16da981d929152e088a5d1b8","modified":1656981398000},{"_id":"themes/next/languages/README.md","hash":"b2567e32805dda79601157351a07e5ca9fe01315","modified":1656981398000},{"_id":"themes/next/languages/ar.yml","hash":"bca66db21c015dbd32970d8708b898518a773e1e","modified":1656981398000},{"_id":"themes/next/languages/bn.yml","hash":"fccbf2855392186e11daa8590121073594037b7b","modified":1656981398000},{"_id":"themes/next/languages/de.yml","hash":"4be7b8b76c81bf1853eb36d2e874b17546a0e792","modified":1656981398000},{"_id":"themes/next/languages/default.yml","hash":"ea5e6aee4cb14510793ac4593a3bddffe23e530c","modified":1656981398000},{"_id":"themes/next/languages/en.yml","hash":"814d81c27fed736055ee300e0a6505b26ff4313c","modified":1656981398000},{"_id":"themes/next/languages/es.yml","hash":"b813da5aed9d73b809133db4dfb08f90ec56afd9","modified":1656981398000},{"_id":"themes/next/languages/fa.yml","hash":"6456d40dd42f44101d9d6e7054e9884e9163f948","modified":1656981398000},{"_id":"themes/next/languages/fr.yml","hash":"b15dc05afdc94de02e5d3fee4f8d3dc5594dd37e","modified":1656981398000},{"_id":"themes/next/languages/id.yml","hash":"14e794db4eca36b257994d81eb513e61d1edcbd6","modified":1656981398000},{"_id":"themes/next/languages/it.yml","hash":"c1eeab4992c76bfd436bb205ce58b1cfeef55ee6","modified":1656981398000},{"_id":"themes/next/languages/ko.yml","hash":"819c19eb9d142e5411f77cf3821d90f740ee114a","modified":1656981398000},{"_id":"themes/next/languages/nl.yml","hash":"ecb8e39c6225f3c068a5fdd569ee7dafd5c41a1f","modified":1656981398000},{"_id":"themes/next/languages/pt-BR.yml","hash":"a1f27b3a592fc58f17d247f5563ff4a90a3da5f2","modified":1656981398000},{"_id":"themes/next/languages/pt.yml","hash":"63a3e1e728ba5e6e22150de7331bb8a654f34960","modified":1656981398000},{"_id":"themes/next/languages/si.yml","hash":"615d18d044f44df476d6bfbf73f7b0edc2632168","modified":1656981398000},{"_id":"themes/next/languages/ja.yml","hash":"d48c4157e0e02e847aac7b513580d3364c81948c","modified":1656981398000},{"_id":"themes/next/languages/ru.yml","hash":"8c2b6361f2de17561c1a3eede2bf47b4e2ba6ce5","modified":1656981398000},{"_id":"themes/next/languages/tk.yml","hash":"519239e35c3bda7b62b00ff5d34644f45b16fe6a","modified":1656981398000},{"_id":"themes/next/languages/tr.yml","hash":"0bebba73d6f06c7dad61f80c0d7ad5f6f1791a01","modified":1656981398000},{"_id":"themes/next/languages/uk.yml","hash":"7dd24580c0865c5a7bc4d391855045366a598936","modified":1656981398000},{"_id":"themes/next/languages/vi.yml","hash":"c669c34da544a563ceae3e196addc9df6a78e024","modified":1656981398000},{"_id":"themes/next/languages/zh-HK.yml","hash":"f195bb0502ffe66e850077a1af1033455ea65f93","modified":1656981398000},{"_id":"themes/next/languages/zh-CN.yml","hash":"5a3ab21210304efef736e96bad254f789f42c567","modified":1656981398000},{"_id":"themes/next/languages/zh-TW.yml","hash":"92256b90028de9a1e79c6bc0e5885b93e7fb4b17","modified":1656981398000},{"_id":"themes/next/layout/_layout.njk","hash":"edb80f170ac8782b3af610fb13965f65552c75ea","modified":1658197912917},{"_id":"themes/next/layout/archive.njk","hash":"d759f4d2cf5ddc6875ea250113a00662c1caf6d1","modified":1656981398000},{"_id":"themes/next/layout/category.njk","hash":"c68b7343d0f8145010f93351908cc36ef6212ec1","modified":1656981398000},{"_id":"themes/next/layout/index.njk","hash":"dd63e488ae8cc144335a5958acedf6a16edd7a92","modified":1656981398000},{"_id":"themes/next/layout/tag.njk","hash":"9e16ba20c28a7f2c6bc75aa427f48122301a30aa","modified":1656981398000},{"_id":"themes/next/layout/post.njk","hash":"6abeb85fb3e4c382ed4bb6049b12a807e6226e67","modified":1656981398000},{"_id":"themes/next/layout/page.njk","hash":"6c40aa438c658eb7f0cd0f6a759f18b43e7e8f93","modified":1656981398000},{"_id":"themes/next/test/index.js","hash":"6bf0289846538be3e9a63809af98f00e1fbdd90b","modified":1656981398000},{"_id":"themes/next/.github/ISSUE_TEMPLATE/bug-report.md","hash":"fc4dce84ed9a5d21d3a8833ff6d776c46f876115","modified":1656981398000},{"_id":"themes/next/.github/ISSUE_TEMPLATE/config.yml","hash":"c40ae7903b6cc99f94c9d45ac7ba8c2850bb1309","modified":1656981398000},{"_id":"themes/next/.github/ISSUE_TEMPLATE/feature-request.md","hash":"4ecac91716eac59d7c2bc53cf6e95612d44da97b","modified":1656981398000},{"_id":"themes/next/.github/ISSUE_TEMPLATE/other.md","hash":"8cc5b5c116f6a052865a324512362f145d699202","modified":1656981398000},{"_id":"themes/next/.github/workflows/label-commenter.yml","hash":"434cc0674290958b1e9bbc46c3486f073c0722db","modified":1656981398000},{"_id":"themes/next/.github/workflows/labeler.yml","hash":"e9d51e93f239a2d4b69722c69db3463b4baf0f4c","modified":1656981398000},{"_id":"themes/next/.github/workflows/linter.yml","hash":"49d96d5d150d348805d55c6bac044fa9b5244bd0","modified":1656981398000},{"_id":"themes/next/.github/workflows/lock.yml","hash":"e48d1ced9a673d3f0911a700d3e68c0f4ca79263","modified":1656981398000},{"_id":"themes/next/.github/workflows/release-drafter.yml","hash":"4f3af81009cb922be91f718a67425377515ea69d","modified":1656981398000},{"_id":"themes/next/.github/workflows/tester.yml","hash":"80a20c3a7522249f051a48239db41d1317e9b552","modified":1656981398000},{"_id":"themes/next/docs/ru/README.md","hash":"6c82bfd2ec8248c248da701f091b548a7a133580","modified":1656981398000},{"_id":"themes/next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"7a06d443f374bd1e84294067a0ac796afd9fbe60","modified":1656981398000},{"_id":"themes/next/docs/zh-CN/CONTRIBUTING.md","hash":"a089f7a8368ab0b7d7b9b7ec0ac3767a453435df","modified":1656981398000},{"_id":"themes/next/docs/zh-CN/README.md","hash":"ccf27b9249524b9fec1c15497b4353c8d1748c6c","modified":1656981398000},{"_id":"themes/next/layout/_custom/custom.swig","hash":"f91fe05ad5caad2c505e30bbfe28d943b6dfc739","modified":1658128730700},{"_id":"themes/next/layout/_partials/comments.njk","hash":"d0c470b0f6690aa217e9ada848c5e2e73fb27c6f","modified":1656981398000},{"_id":"themes/next/layout/_partials/footer.njk","hash":"19713f472972caac33ae5fbcfe9105da61257de4","modified":1656981398000},{"_id":"themes/next/layout/_partials/languages.njk","hash":"e43f22198cccb5f6e306b1ce0d28d12a4fb891f8","modified":1656981398000},{"_id":"themes/next/layout/_partials/pagination.njk","hash":"9876dbfc15713c7a47d4bcaa301f4757bd978269","modified":1656981398000},{"_id":"themes/next/layout/_partials/widgets.njk","hash":"852a750524decf1efa587cd52b09e387ed8315de","modified":1656981398000},{"_id":"themes/next/layout/_macro/post-collapse.njk","hash":"1a30d751871dabfa80940042ddb1f77d07d830b9","modified":1656981398000},{"_id":"themes/next/layout/_macro/post.njk","hash":"434b3e76a040a816169e1929657e4176e7b8164c","modified":1656981398000},{"_id":"themes/next/layout/_scripts/index.njk","hash":"6668878a0f9a1166c6a879755f54a08d942da870","modified":1656981398000},{"_id":"themes/next/layout/_macro/sidebar.njk","hash":"eb786e8b35e354287cda345c524cd35ec955f692","modified":1656981398000},{"_id":"themes/next/layout/_scripts/vendors.njk","hash":"be80b9fe415a9a09d74c28e230995fd292dfc123","modified":1656981398000},{"_id":"themes/next/layout/_third-party/fancybox.njk","hash":"844559f46e2ff1c8be234d5763703106e2072a7b","modified":1656981398000},{"_id":"themes/next/layout/_third-party/index.njk","hash":"d41eeb262978e34de4679d8971a9e7ac5d90ecbc","modified":1656981398000},{"_id":"themes/next/layout/_third-party/pace.njk","hash":"d7ad5714079f7f65446f880baf14722435ca9061","modified":1656981398000},{"_id":"themes/next/layout/_third-party/rating.njk","hash":"1bcdbc7fde26d6d9ef4e7fa43ffcff5a9506b20e","modified":1656981398000},{"_id":"themes/next/layout/_third-party/quicklink.njk","hash":"0efed71ed530447718c4ea5bbd5fc8695b0b0d5f","modified":1656981398000},{"_id":"themes/next/scripts/events/index.js","hash":"3ce10d4cce94e3d4c482c2e18bb6f0f0ca380d3d","modified":1656981398000},{"_id":"themes/next/scripts/filters/locals.js","hash":"9eb5310664759931287dd28ea39165dfb67f12ed","modified":1656981398000},{"_id":"themes/next/scripts/filters/default-injects.js","hash":"872f01cb10e422a648ea505436532e776e92926b","modified":1656981398000},{"_id":"themes/next/scripts/filters/post.js","hash":"30e03a1d4828259f82d46e64cbfe2955b6cff9a9","modified":1656981398000},{"_id":"themes/next/scripts/filters/minify.js","hash":"f160e39943e39d7276da86adb47c3f08e5f22c7a","modified":1656981398000},{"_id":"themes/next/scripts/helpers/font.js","hash":"3394185a7f0393c16ce52c8028f90da3e9239c55","modified":1656981398000},{"_id":"themes/next/scripts/helpers/engine.js","hash":"d292b78485e8e8055712b0ed6de7cf559c5fbdcd","modified":1656981398000},{"_id":"themes/next/scripts/helpers/navigation.js","hash":"78107021101553c3d23e89290f7530b60cf4aa86","modified":1656981398000},{"_id":"themes/next/scripts/helpers/next-config.js","hash":"226fccbe9c93265e65a300e3cb4bf6f9065cfdd7","modified":1656981398000},{"_id":"themes/next/scripts/helpers/next-url.js","hash":"a11b71ba0c5012e2cdcab31c15439156b215563e","modified":1656981398000},{"_id":"themes/next/scripts/helpers/next-vendors.js","hash":"afdd6a188a74c188f0dd154fac70efd4080ca262","modified":1656981398000},{"_id":"themes/next/scripts/tags/button.js","hash":"c6ad2ed544fbb25ecb5d820c36e76302504271b7","modified":1656981398000},{"_id":"themes/next/scripts/tags/caniuse.js","hash":"935a311142a409c1896b3ae3f01fe7a9e2db1134","modified":1656981398000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"9ed799c329abf830f623689d7e136991256a24ca","modified":1656981398000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"92c19d796bdb3320df9caea59bf52df7a95d9da9","modified":1656981398000},{"_id":"themes/next/scripts/tags/index.js","hash":"17f9451ce1f10f78437f52218757d38d4e1591b0","modified":1656981398000},{"_id":"themes/next/scripts/tags/label.js","hash":"8a73348186113bae0a51ea2f891c1bb882fab05a","modified":1656981398000},{"_id":"themes/next/scripts/tags/mermaid.js","hash":"4fb01ca650fa8b256b8d48f50dc1b18350bd3d6d","modified":1656981398000},{"_id":"themes/next/scripts/tags/link-grid.js","hash":"18a483c2d5afd701f6080ffdddf2d1321370336c","modified":1656981398000},{"_id":"themes/next/scripts/tags/pdf.js","hash":"344636b6fd7e27e8831c1e194039afc0d61931cd","modified":1656981398000},{"_id":"themes/next/scripts/tags/note.js","hash":"7b94ddb46b7d4b0fe815f2fbe4bd375f07f55363","modified":1656981398000},{"_id":"themes/next/scripts/tags/tabs.js","hash":"0eabe51da40b4b13e16419c8fe02452d9a4fef73","modified":1656981398000},{"_id":"themes/next/scripts/tags/video.js","hash":"2ee926448583be8f95af1f2884ae2c9c4830151d","modified":1656981398000},{"_id":"themes/next/source/css/_colors.styl","hash":"3c6798c10cc220d83481cb3f3782e78558cee789","modified":1656981398000},{"_id":"themes/next/source/css/_mixins.styl","hash":"32d31cb5a155681c19f5ad0bb56dcb08429f93ef","modified":1656981398000},{"_id":"themes/next/source/_data/styles.styl","hash":"f189c0e1bc4620396f1dd87a4ce384e3621b06e3","modified":1658202885009},{"_id":"themes/next/source/css/main.styl","hash":"78ce791cc4ac95386cf6839ca72f5f7b51f86ee9","modified":1658200983375},{"_id":"themes/next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1656981398000},{"_id":"themes/next/source/css/noscript.styl","hash":"263eddabfae40e54c0591e7baa8403ade8cdd56d","modified":1656981398000},{"_id":"themes/next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1656981398000},{"_id":"themes/next/source/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1656981398000},{"_id":"themes/next/source/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1656981398000},{"_id":"themes/next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1656981398000},{"_id":"themes/next/source/images/logo.svg","hash":"2cb74fd3ea2635e015eabc58a8d488aed6cf6417","modified":1656981398000},{"_id":"themes/next/source/images/myavatar.png","hash":"1a7dfcae2f2167c6cc7bf74ccddd96129d37211a","modified":1657091016595},{"_id":"themes/next/source/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1656981398000},{"_id":"themes/next/source/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1656981398000},{"_id":"themes/next/source/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1656981398000},{"_id":"themes/next/source/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1656981398000},{"_id":"themes/next/source/js/motion.js","hash":"f7c825cbff11885fa0dffa64824fd00e505d6a8d","modified":1656981398000},{"_id":"themes/next/source/js/next-boot.js","hash":"da0f07f9eaaa83de70128b0feaea3fdadb90457a","modified":1656981398000},{"_id":"themes/next/source/js/pjax.js","hash":"919f5281c4a04d11cfd94573ecf57b3dbabd3cc8","modified":1656981398000},{"_id":"themes/next/source/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1656981398000},{"_id":"themes/next/test/helpers/font.js","hash":"342ef3c6fd2dcca2a8802a516ed6d7f389fd2ca2","modified":1656981398000},{"_id":"themes/next/source/js/utils.js","hash":"200088bfd042f5304b2a04befab0829148845e0e","modified":1656981398000},{"_id":"themes/next/test/helpers/index.js","hash":"63ba28afed697f7b3574436b1133b8ecc9c0c357","modified":1656981398000},{"_id":"themes/next/test/helpers/next-url.js","hash":"a91d880cb75e0a8e65a7be4c7362b2c8ebfb7c4f","modified":1656981398000},{"_id":"themes/next/test/tags/button.js","hash":"48f2aa4c513e9e24bd6a811410520b74cd7ea88b","modified":1656981398000},{"_id":"themes/next/test/tags/caniuse.js","hash":"aa5e728445caeaf7c2ccd0f3fcb2cad0c93ca6d1","modified":1656981398000},{"_id":"themes/next/test/tags/group-pictures.js","hash":"5c68ae0184f9da6e00ba199f2554d503d8e6da71","modified":1656981398000},{"_id":"themes/next/test/tags/center-quote.js","hash":"7667342fd1a1417eaf6a254012b84ae40e8d13dd","modified":1656981398000},{"_id":"themes/next/test/tags/index.js","hash":"e8779e54f0979b221858f8bb74dd081bb503b910","modified":1656981398000},{"_id":"themes/next/test/tags/label.js","hash":"4ebf3698c258ca978b997acbdd0dece44069c09d","modified":1656981398000},{"_id":"themes/next/test/tags/link-grid.js","hash":"43d298fafb7c45a874b766d443843bd26346e689","modified":1656981398000},{"_id":"themes/next/test/tags/mermaid.js","hash":"ab77be5f3c6d9a57c7b9dda6decf1906a736fef9","modified":1656981398000},{"_id":"themes/next/test/tags/note.js","hash":"3dcfcd65bf9f326972ea7571fdb1444200f5d07e","modified":1656981398000},{"_id":"themes/next/test/tags/pdf.js","hash":"fd6ea5123560a90f7e7c1eface23dbe1455db25f","modified":1656981398000},{"_id":"themes/next/test/tags/tabs.js","hash":"d63722919f9da2e44d6b952801e10a2915ea9c12","modified":1656981398000},{"_id":"themes/next/test/tags/video.js","hash":"b796fc4dceb20a30e730c322bb5474c0162464cc","modified":1656981398000},{"_id":"themes/next/test/validate/index.js","hash":"5a95ccc8598667535bd022e988055c0e019f3670","modified":1656981398000},{"_id":"themes/next/layout/_partials/head/head-unique.njk","hash":"8da52a144060db1a0a088ccb2e6cc8376d1fce70","modified":1656981398000},{"_id":"themes/next/layout/_partials/head/head.njk","hash":"0ba2bf0266f1fcb8edbd961869f8521b29685c56","modified":1656981398000},{"_id":"themes/next/layout/_partials/header/index.njk","hash":"650de421a8ce4cf685428ffbe0087ff84cbd1356","modified":1656981398000},{"_id":"themes/next/layout/_partials/header/brand.njk","hash":"aff4613756456be26415febc668860fdab8d33c5","modified":1656981398000},{"_id":"themes/next/layout/_partials/header/menu-item.njk","hash":"41a8b0cc16f60fa085cb719d07216d86b6bc4bf8","modified":1656981398000},{"_id":"themes/next/layout/_partials/header/menu.njk","hash":"ee6fc2f111572d3eeab0a2fecbb2d6b3e37ab26b","modified":1656981398000},{"_id":"themes/next/layout/_partials/header/sub-menu.njk","hash":"06480d8ec5f0b87eafd47f082f07968d7282dd5c","modified":1656981398000},{"_id":"themes/next/layout/_partials/page/breadcrumb.njk","hash":"89825e75cc45e9709fa6ba89883669eedaff6f46","modified":1656981398000},{"_id":"themes/next/layout/_partials/page/categories.njk","hash":"17156d99941f28a225951ffdcfa9a115e20dc2d2","modified":1656981398000},{"_id":"themes/next/layout/_partials/page/page-header.njk","hash":"7ed4f102a1825195cff8d7995bf9219f323a9034","modified":1656981398000},{"_id":"themes/next/layout/_partials/page/schedule.njk","hash":"0f4bc8e257da60f77c0c1738607b2bde55810684","modified":1656981398000},{"_id":"themes/next/layout/_partials/page/tags.njk","hash":"a18d1598e36cc72f2b0b24c3cc3c5990dfaa3254","modified":1656981398000},{"_id":"themes/next/layout/_partials/search/algolia-search.njk","hash":"efb2b6f19df02ba5ae623a1f274fff52aed21e6f","modified":1656981398000},{"_id":"themes/next/layout/_partials/search/localsearch.njk","hash":"661f7acae43f0be694266323320f977d84119abe","modified":1656981398000},{"_id":"themes/next/layout/_partials/search/index.njk","hash":"8f6f256ab3b351ffc80f1f3f1d9834e9a7cfac31","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-copyright.njk","hash":"133942922e34abae9e4de7ea5591d77c0caa4b37","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-followme.njk","hash":"154df0bb323c332d8c25343f258ee865e5553423","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-footer.njk","hash":"bde2c7356d9362972bde41cc206d5816f8ed714d","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-meta.njk","hash":"9fa47e4fb342811da590ee4adc91cf81118c0a39","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-related.njk","hash":"57eca76cfbbe9a65bc2a77f1deebf003ed335673","modified":1656981398000},{"_id":"themes/next/layout/_partials/post/post-reward.njk","hash":"002b51d0cae3f2e2e008bdc58be90c728282de5b","modified":1656981398000},{"_id":"themes/next/layout/_partials/sidebar/site-overview.njk","hash":"3d8591bb92df77ceb9d5b07bc76da1ca89e5bd76","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/baidu-analytics.njk","hash":"6215309aee028dcb734452beec448c5afb6c63fc","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/cloudflare.njk","hash":"a5b8297c2c383124dd6a56e256ecc0c0dcf489be","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/google-analytics.njk","hash":"d89066ff53879693f023e540d59c86137172c529","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/microsoft-clarity.njk","hash":"9dc00fcb0a05899f048eace9f9160b78956655d5","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/growingio.njk","hash":"8afaa772c390bd9d53a5cff9645ac3168334eb98","modified":1656981398000},{"_id":"themes/next/layout/_third-party/analytics/index.njk","hash":"45477a04cf2b3c077061c8c3ada216c1ae288e0e","modified":1656981398000},{"_id":"themes/next/layout/_third-party/chat/chatra.njk","hash":"d7263fca16d0278ccf1f6aa1c6df6902a6344a09","modified":1656981398000},{"_id":"themes/next/layout/_third-party/chat/gitter.njk","hash":"f8cc14b7aa949999a1faaeb7855e2f20b59a386d","modified":1656981398000},{"_id":"themes/next/layout/_third-party/chat/tidio.njk","hash":"02aab857c27fc103216029be991688b12a73a525","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/changyan.njk","hash":"d1c950f8fbdf85e7a3eae5463767a89e858e8220","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/disqus.njk","hash":"9375b19a89b7fa9474e558d085af5448d4c5c50c","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/disqusjs.njk","hash":"0749cb6902baecdfd01f779a2a2513f6d2f6a823","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/gitalk.njk","hash":"b63b7e2ede0d3e66e732fa1a06bda9b19e1e85d4","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/isso.njk","hash":"64cc3bdaf644fd32c0d0a247f29f5b6904da9af3","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/livere.njk","hash":"3b13b09fba84ec6000886890a6710736a2b8fafe","modified":1656981398000},{"_id":"themes/next/layout/_third-party/comments/utterances.njk","hash":"5a94032bc3512a10ad4328fc19ec07b819a1d687","modified":1656981398000},{"_id":"themes/next/layout/_third-party/math/index.njk","hash":"abf37fc55aa86702118e8fdf5bf2d389dd589aa0","modified":1656981398000},{"_id":"themes/next/layout/_third-party/math/katex.njk","hash":"1ebf658690468ea197bdd0416eb7cfa4bd0b083a","modified":1656981398000},{"_id":"themes/next/layout/_third-party/math/mathjax.njk","hash":"3677017fd4572b158311f5f5d870590ab25184e0","modified":1656981398000},{"_id":"themes/next/layout/_third-party/search/algolia-search.njk","hash":"24ed76e0c72a25ac152820c750a05826a706b6f4","modified":1656981398000},{"_id":"themes/next/layout/_third-party/search/localsearch.njk","hash":"e45ea3542cdc9ed7ec8447b5e6f35df4c5e82758","modified":1656981398000},{"_id":"themes/next/layout/_third-party/statistics/busuanzi-counter.njk","hash":"a4bc501da0f22f7e420f0ca47e83988ce90b1368","modified":1656981398000},{"_id":"themes/next/layout/_third-party/statistics/firestore.njk","hash":"d32ebe94560fa95824478ebbff531bffc47b194d","modified":1656981398000},{"_id":"themes/next/layout/_third-party/statistics/lean-analytics.njk","hash":"2446e748cdc102c78492216319ac02148db7daf6","modified":1656981398000},{"_id":"themes/next/layout/_third-party/statistics/index.njk","hash":"568ddf7955d11d93fb5e842b403a7ac8b1b7fdb1","modified":1656981398000},{"_id":"themes/next/layout/_third-party/tags/pdf.njk","hash":"2c81984cc4f5123103460442f6e046f5b6c97127","modified":1656981398000},{"_id":"themes/next/layout/_third-party/tags/mermaid.njk","hash":"099e031f52fb8e47b3af5b2684737efc9e643ee7","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/config.js","hash":"c8b59b404f5d2a0b3b5cd1a6c9a10af5f30e43b5","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/highlight.js","hash":"6aec7b2c38c50989a23bfaa0d560e75c7f553e12","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/injects.js","hash":"d987709267a1bc6e5014411e9983d7c49c102c16","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/navigation.js","hash":"dd3562686d95a50375e6fd32e717ccb0d99c1e3d","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/utils.js","hash":"ec996d0673f766167c86df0966e9da1ae036e103","modified":1656981398000},{"_id":"themes/next/scripts/events/lib/vendors.js","hash":"64e4024376b51fe81be7ad80235abdf0a83853bd","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/changyan.js","hash":"7fa8701c86485b2fe7324e017101a32417902397","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/common.js","hash":"19a402a225c31edffc50f202a14e0d582d3db23e","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/default-config.js","hash":"93ee5f9109dad885dc38c49bcee630c10f9dce6e","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/disqus.js","hash":"7f71d6b271ba65ff333d5682e7575711d368c0d2","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/disqusjs.js","hash":"135b87d151055eefdbc711d9e704b112b3214a84","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/gitalk.js","hash":"7bb7dafdd7f6bca8464b54e17e552ce7f1714195","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/isso.js","hash":"ff8b5b5145220a17d0ecd9508ba9bd2d3b2da47d","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/livere.js","hash":"5a07d8bb52bc1d51a624ca8db54be144566c306b","modified":1656981398000},{"_id":"themes/next/scripts/filters/comment/utterances.js","hash":"d3bded697bc32dace689d2a6dfb6eb7514169d15","modified":1656981398000},{"_id":"themes/next/source/css/_variables/Gemini.styl","hash":"96e0a7c2a65ce68215e17e369085b2ea2f1334f2","modified":1656981398000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"e1fbf169b9b6a194b518240cbd06ec3c48b83d61","modified":1656981398000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"e3be898f5ebcf435a26542653a9297ff2c71aeb0","modified":1656981398000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"c65536a128b9bc9dbe2fbb1b235a3cded2891002","modified":1656981398000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"163c7441d777bee87042d475e6ce0fde199add28","modified":1656981398000},{"_id":"themes/next/source/js/cursor/fireworks.js","hash":"e7c544b3ef8abf82c11f6bc983660cf0f9769833","modified":1658198208356},{"_id":"themes/next/source/js/schemes/muse.js","hash":"9794bd4fc6a458322949d6a0ade89cd1026bc69f","modified":1656981398000},{"_id":"themes/next/source/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1656981398000},{"_id":"themes/next/source/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1656981398000},{"_id":"themes/next/source/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1656981398000},{"_id":"themes/next/source/js/third-party/rating.js","hash":"4e92c2d107ba47b47826829f9668030d5ea9bfb8","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"bab653bcf226311381e8411a0492202f1bf1fce9","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/index.styl","hash":"fe1868f47681e00a33a96199302be85377282f63","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/index.styl","hash":"8e34df131830d4fa3725e4590a672ba1cf1903e5","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/reading-progress.styl","hash":"90a86045a33c1bae49fc2f6fa1e1b53170c7f77b","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/mobile.styl","hash":"64775c729512b30b144ab5ae9dc4a4dfd4e13f35","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"d0a7c99095f490b0d2ed6b1be43d435960798cec","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/buttons.styl","hash":"a042571d85ff7265f799004239a45f36b716b8a6","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/index.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/comments.styl","hash":"e4fecc889ba3317a64e9abba5842c79dff9b7827","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/pagination.styl","hash":"b5c7782368889fa9fd93807d28ff2daf270e3703","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"e840b23d33023e6d45e018f6e84b683dd56efd8d","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"4817e77577896ab5c0da434549917ee703a3f4cf","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/toggles.styl","hash":"572a41499391677d84b16d8dbd6a996a3d5ce041","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Gemini/index.styl","hash":"fd49b521d67eaccc629f77b4e095cb7310327565","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Mist/_layout.styl","hash":"5604ac1e161099a4d3e5657d53507268866dc717","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"fb550935d374e0bdf1097fce187337dc05cad3e1","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expand.styl","hash":"be6cf377ae8f4a01ee76f9b3014e74161d4d5d17","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/_header.styl","hash":"06080fd963c904d96c00eff098a284e337953013","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"ab16a3dcdc0393b9b582ef59dcc13db9320e917c","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/_sidebar.styl","hash":"944364893bd7160d954c10ba931af641c91515a4","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"82a29572dd90451f75358a2ee2522b87304a0bb8","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"b7f48be3c43bfa393d62142544a5487a67871713","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/_header.styl","hash":"b741ab96e73370711c63a6581159f2ea8b5bfa1b","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"72dc825c50357402c342d62ab60fc0c478ab6bc1","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"6eee86c8f0175d6c09e434053516cd8556f78d44","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"8000075b227749a7495eaf417cac6ccfbe441580","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"778ed2ad5643b93970c95626b325defeb586733f","modified":1656981398000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"d9141e6e14a56b5952488101e9a8388c2170e270","modified":1656981398000},{"_id":"themes/next/source/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1656981398000},{"_id":"themes/next/source/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1656981398000},{"_id":"themes/next/source/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1656981398000},{"_id":"themes/next/source/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1656981398000},{"_id":"themes/next/source/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1656981398000},{"_id":"themes/next/source/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/disqus.js","hash":"e1cc671b0d524864fd445e3ab4ade9ee6d07e565","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/disqusjs.js","hash":"b6c58f098473b526d6a3cd35655caf34b77f7cff","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1656981398000},{"_id":"themes/next/source/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1656981398000},{"_id":"themes/next/source/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1656981398000},{"_id":"themes/next/source/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1656981398000},{"_id":"themes/next/source/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1656981398000},{"_id":"themes/next/source/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1656981398000},{"_id":"themes/next/source/js/third-party/statistics/lean-analytics.js","hash":"5a928990856b8e456f0663cf3b6b406733672e39","modified":1656981398000},{"_id":"themes/next/source/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1656981398000},{"_id":"themes/next/source/js/third-party/statistics/firestore.js","hash":"411a72df581f5b21317dc28633c7993207eb9e1c","modified":1656981398000},{"_id":"themes/next/source/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/pages/breadcrumb.styl","hash":"8afdc311c6b8db121758371f95cf1c5e77354f42","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/pages/index.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"b6e2eb1550a7845cb2adf86081a4ab6c7bde1e68","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/pages/schedule.styl","hash":"6b816c2511242ee503fb5f34cd3e4dcdafc06b85","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/pages/tag-cloud.styl","hash":"1a81d1a71fcf0699629ce6e72dfd0a15f3a2dd0a","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/index.styl","hash":"d0805a763176b3c0003967401644f41dfe3bc9e8","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-body.styl","hash":"d757768a58743601d0d84158ba955eb15d4c3c01","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"ec37a36e94ba791663607a5022f763915778578f","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-followme.styl","hash":"fc1a7bac6493f24aa50665574f37f3dd954f210c","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-footer.styl","hash":"1d284f3ea03ba9b4feb76b375e539a8e0bccf1c3","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"aa366d37389760c8595529b850f461569577a1c5","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"9ac6f477177264c26a46e8333b8456720a0444dc","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-header.styl","hash":"010c901e4ef49a606f8a350efbf09044e76d2ff3","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"07cff69f2d57e6321595f64c16d8b763dc88df6a","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/post/post-widgets.styl","hash":"b6677dc2a2368084ab82bb4f145ac79e5966c150","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/disqusjs.styl","hash":"c2326ee3e8b724d99c24a818ddee32813ea5bf89","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/gitalk.styl","hash":"070737d101e7cd58e997e8c7af09958268c43a21","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/gitter.styl","hash":"35104dc6883a61c31e0e368dac8ac2f697be62fe","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/index.styl","hash":"979486a41a81f2a9fd8b0b87c4f87d6416c68c7d","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/related-posts.styl","hash":"41ed817e1eb64078074e245e771446ee041e5790","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/search.styl","hash":"e72799ce3f9b79753e365b2f8c8ef6c310668d4a","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/math.styl","hash":"9d995eb4871a6c273d9d51558676a1fdabf69e72","modified":1656981398000},{"_id":"themes/next/source/css/_common/components/third-party/utterances.styl","hash":"56d90ae0559caa55b75f3c300ff2711f9ed65fc4","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/footer/index.styl","hash":"8b9407e5cfd0571ef8de7df19022b268f962fa2f","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/bookmark.styl","hash":"e74f4bb47a101b014ee2a1783c87f3b87323f9a0","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/github-banner.styl","hash":"38c64c2d04e46848382bfa246a0e9c508294767b","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/menu.styl","hash":"392fd53a8dd4e3f33a853ebb24290a622300e0ff","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/index.styl","hash":"ff642130354a0b3be0d708c43044ed4d710b5e83","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/site-meta.styl","hash":"759e582d34d08e3386c55d87a835a9523608619f","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/header/site-nav.styl","hash":"bf3ad8b4268f763a1e26377681644887694bc009","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/index.styl","hash":"cee43480eba028c37d51cb620c2d81486aa24e01","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"52fc98b1435129eb3edb9293ced9e507741f1350","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"5b38ac4a0f1ade0e681aff0e3366c481d9cf3dcd","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"b926e368f702f8686aaa2eb98d3d2e533418958c","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"9950c3188a28e1c63b5498b7bdcd14b12ace3e28","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-dimmer.styl","hash":"fbdb63c6a8887d19b7137325ba7d6806f728139c","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"ee94a1a27090ad24e3ed579093088d97ff96d77d","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"021a37cf178440cc341940a299d3bca359996c6b","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"3103b81fc76b59e1e2c161e2c484625c770ed66f","modified":1656981398000},{"_id":"themes/next/source/css/_common/outline/sidebar/site-state.styl","hash":"26dd0adfcb1db6df29c6090c8d7e9b5a43583fb0","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"670fc109b56a010b166b86b616823a1aae97a738","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/highlight/index.styl","hash":"f2328caa94645836e06fb39a6a9c9a84ed68a8b5","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"d6418fd2bbfba7b73ddf11ec62db9637fdf5d8af","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"393ff96234e4196b569d4b11496774eb78e147de","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/index.styl","hash":"3f76c73a891bbc10679753e702feba9e8a5ffdd2","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/link-grid.styl","hash":"7f8a7345e6537a62cd9e9a94c8f7065b541d9b04","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/label.styl","hash":"debee14539272fbe3835a7d3853af2230baa3501","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/mermaid.styl","hash":"48d35dba575a7c9e8845b16652e76b7d4a4646de","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/note.styl","hash":"d27fbf7799695295dd5860a161a13ac4d90c5ba4","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b6654a1d7cf82577d8263faffee8af3ad4a5c0e8","modified":1656981398000},{"_id":"themes/next/source/css/_common/scaffolding/tags/tabs.styl","hash":"7a39bcce7274284e87388743db62afc847fe6897","modified":1656981398000},{"_id":"source/img/image-20210820101707762.png","hash":"5dc1ee403e711df7850924478b12e8fb3a41dbd6","modified":1631845756686},{"_id":"source/img/image-20210820103041679.png","hash":"08e9fbfe5b12254f05295080ec01879bbeac3a23","modified":1631845756688},{"_id":"source/img/image-20210820102735419.png","hash":"75b5c1af684a04d824f12a8d541234ac66164937","modified":1631845756687},{"_id":"source/img/image-20210821114011230.png","hash":"a2483f63a5949bc4116ed35fdadf0272c04a05ec","modified":1631845756694},{"_id":"source/img/image-20210821113447825.png","hash":"3acef8fc3161f6712ee27e56dc8e221f6851083f","modified":1631845756693},{"_id":"source/img/image-20220713102756709.png","hash":"a6997a2f70658014c965f4f95415c63f34d54e75","modified":1657679276752},{"_id":"source/img/image-20220715110810985.png","hash":"6559106e5ffbddec553b6e64175ecd17db72b6f1","modified":1658128219405},{"_id":"source/img/image-20220715110856325.png","hash":"7d5c8e988846297c4d43abdf729879a9a9e8c5aa","modified":1658128219405},{"_id":"source/img/image-20220715110934572.png","hash":"427aff513a1effee9a915de2fb9a8082e85b3fa3","modified":1658128219405},{"_id":"source/img/image-20220715151454194.png","hash":"6bbc8fca2f75b412288ee0b1b661a4ed359051b7","modified":1658128219452},{"_id":"source/img/image-20220715155109519.png","hash":"cdd761a98372de1b6c231c9032d009501ebf078e","modified":1658128219452},{"_id":"source/img/image-20220715154822649.png","hash":"fd21c139660c4f89c4edad4ca83678c25aa8790d","modified":1658128219452},{"_id":"source/img/image-20220715154849451.png","hash":"a365dea44e7e8acd8929218c4fe50b150b367fd4","modified":1658128219452},{"_id":"source/img/image-20220715155230097.png","hash":"97ffaea29e35e0ca4104afa80b2b29a443acd127","modified":1658128219467},{"_id":"source/img/image-20220718091033465.png","hash":"f1841db1c0eeab42193b0b22bd303391b2d2551e","modified":1658128219467},{"_id":"source/img/image-20220718111923212.png","hash":"e9bcea6cc69c98d051bada439726785f407d9f57","modified":1658128219467},{"_id":"source/img/sersync流程-1628145534424.png","hash":"228e9f6a0450e5cd4e7c90b2ebf3d38f3d27167e","modified":1631845756678},{"_id":"source/img/sersync流程.png","hash":"39fb8fed727a7a667889cc658559a6e955e0fa71","modified":1631845756679},{"_id":"source/_posts/01_运维/01-基础命令/day13-yum仓库/assets/image-20210318112338781.png","hash":"4ff986d8e1808583bfce374eb1f1b55ef22dca39","modified":1631845756634},{"_id":"source/img/2108785-20210605105334455-1251950822.png","hash":"6c3302c81bb50192b3fe9a7e06653964abfbdcdd","modified":1631845756710},{"_id":"source/img/image-20210825142256349.png","hash":"24825deaff8207e96279d925c1009f89c04258cd","modified":1631845756712},{"_id":"source/img/image-20220715110833863.png","hash":"85baf64c1821de62f59f42b2dbc6cfd65ea2a28e","modified":1658128219405},{"_id":"source/img/image-20220715110229082.png","hash":"48c8fa553153bd559318bf200fc4bb819978a007","modified":1658128219405},{"_id":"source/img/image-20220715111100262.png","hash":"c838816a1eea6fd45116bfec10f0b98e216efd22","modified":1658128219420},{"_id":"source/img/image-20220715111746387.png","hash":"189ef7f96878806ac71495de8e2b652e77535723","modified":1658128219420},{"_id":"source/img/image-20220715111737349.png","hash":"66f0f77624304fe1210ff902241cd932c9c16f79","modified":1658128219420},{"_id":"source/img/image-20220715145556778.png","hash":"a43857886b5abce8ad8581c7e2fd3498a952aca5","modified":1658128219436},{"_id":"source/img/单台服务器动静分离.png","hash":"6c3302c81bb50192b3fe9a7e06653964abfbdcdd","modified":1631845756715},{"_id":"source/img/多台服务器动静分离.png","hash":"fa547a44ad0a5843c0d1260adc94e105494a262e","modified":1631845756716},{"_id":"themes/next/source/images/xhc.jpg","hash":"95904aee6e54ecd19b8cdd8de2dcd16265c9e901","modified":1658200461728},{"_id":"source/img/image-20210824001613717.png","hash":"082afde2f0a22acc5fec2d71f49542903bc0f688","modified":1631845756706},{"_id":"source/img/image-20210824001638506.png","hash":"2da46e4a6d8cd0d1054f5b3797a475ac587c3c86","modified":1631845756708},{"_id":"source/img/image-20210825143746986.png","hash":"64f558fc85b92c6e9eeb5b18c062ec5bad206716","modified":1631845756714},{"_id":"source/img/image-20220715111047082.png","hash":"4ee6c0bff2ef7bbf496360cb84f8661bb11bd853","modified":1658128219420},{"_id":"source/img/image-20220715111759964.png","hash":"ece7d258fe16f7594b6ca0aa7a86bd7bd59e7f09","modified":1658128219420},{"_id":"source/img/image-20210823225412626.png","hash":"fa08782400eebc5428e18c9b56a4f8e78b4c77b1","modified":1631845756698},{"_id":"source/img/image-20220715150619814.png","hash":"c3da2db5ada41f3b60fb935b0ee4eef12dd5fcb0","modified":1658128219452},{"_id":"source/img/http思维导图.png","hash":"aa2c10bf35b713b190031148ecb9abd53ba79c13","modified":1631845756684},{"_id":"source/img/image-20220715145306545.png","hash":"32cc7bae1b3407b7a81ce5b3bb872d50974c5b57","modified":1658128219436},{"_id":"source/img/image-20220715145353695.png","hash":"899aaa04030872e3976a9e0653e2fc614fd3bc52","modified":1658128219436},{"_id":"source/img/综合架构图.png","hash":"04f5ed6843cdc824626f4d62ee63f260c848607e","modified":1631845756676},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连/overlay网络访问.png","hash":"432a81e36eff99a9b53c0af6f7d186d85e664fe6","modified":1631845756726},{"_id":"source/img/image-20210823230415237.png","hash":"05cb3071c72e7e7248b8f4ed7a1be329f7b39d4d","modified":1631845756704},{"_id":"public/search.xml","hash":"8e1cfc833a6532356936f5881203e38a4f890c62","modified":1658202973470},{"_id":"public/categories/index.html","hash":"d9bfcd010026ac7fa0d32fcc85db6d7ba4a44c2d","modified":1658202973470},{"_id":"public/tags/index.html","hash":"2e70a67bd9ba7558d6cde9fd4eb49474bb95e1e1","modified":1658202973470},{"_id":"public/404/index.html","hash":"8544b6f08bc1e925d45a78e41a4ccc8ee9f7bf68","modified":1658202973470},{"_id":"public/2022/07/18/04_杂记/Githubio如何绑定域名/index.html","hash":"91a87d3a09fabf9f2559cf2f31553dbee0f67b55","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/02_Python进阶/01_类与对象/index.html","hash":"31fef14873c76bd638c88f6191a44dc104591d1c","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/54_附录九：Type/index.html","hash":"70f2baa23062089b21aba8831a6455f0c0ee81d5","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/hinting/index.html","hash":"7232dc2a584054983f4ed343e92b7824a13f6e2f","modified":1658202973470},{"_id":"public/2022/07/13/03_Python/01_MySQL/01-MySQL数据库-一/index.html","hash":"0a284a87bde66371d6337448eec804a370f0ad73","modified":1658202973470},{"_id":"public/2022/07/13/03_Python/01_MySQL/01_MySQL数据库-一/index.html","hash":"1ca96d30e45cd686d797ca8a27ecd1a4ae5d4197","modified":1658202973470},{"_id":"public/2022/07/11/04_杂记/长城TD120A2安装OpenEuler/index.html","hash":"2c26278d9f1249d7705e9e03885fa7530a3f62d7","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day09-用户组管理/笔记/index.html","hash":"d125b429a9ce5b4861537584c94ea9d0df42f5a1","modified":1658202973470},{"_id":"public/archives/page/6/index.html","hash":"864fdb6864ff52ee2da3a098155b0b1c782c1d9f","modified":1658202973470},{"_id":"public/archives/2021/06/index.html","hash":"0e5b60e08a61d0c7fe449c361b7b3f7ac5f45792","modified":1658202973470},{"_id":"public/archives/2021/07/index.html","hash":"fdd5c8b1b6f5b1059bdba612df6dff27853f5576","modified":1658202973470},{"_id":"public/archives/2022/page/5/index.html","hash":"d43bdb121cda4723cd91857f2286e54571a08a4b","modified":1658202973470},{"_id":"public/archives/2022/07/page/5/index.html","hash":"1fedd992e5102448670672db1faf16985ae15a7c","modified":1658202973470},{"_id":"public/categories/博客维护/index.html","hash":"8a04328c322c675f25e47c4e0b6c0468c8e2aa95","modified":1658202973470},{"_id":"public/categories/测试/index.html","hash":"4e6f04ea1af2e9a299c239df57e8228f23faedb8","modified":1658202973470},{"_id":"public/categories/杂记/index.html","hash":"0a485ec89b414d456f554fb9c353823e6e2f1f7e","modified":1658202973470},{"_id":"public/categories/测试/信创POC测试/index.html","hash":"9db6564ae87a29b0850031ad1d561ba1bc53298d","modified":1658202973470},{"_id":"public/categories/运维/page/4/index.html","hash":"0bae93590c50d2f73006371f265b52fea622fd39","modified":1658202973470},{"_id":"public/categories/运维/（二）综合架构/page/2/index.html","hash":"23c74106e27d06dacefb9e16022fafce866a7f4c","modified":1658202973470},{"_id":"public/categories/运维/（五）K8S/index.html","hash":"5ae81ff09996a9dc73b41e1f771288223c668f6d","modified":1658202973470},{"_id":"public/categories/运维/（四）虚拟化之OpenStack/index.html","hash":"c25ff489dca01345df1bf289a9575dcc316535af","modified":1658202973470},{"_id":"public/categories/Python/index.html","hash":"437eb77f02b852c72f7502893afb68ed3689f146","modified":1658202973470},{"_id":"public/categories/运维/（一）基础命令/page/2/index.html","hash":"2b6895426b80dcbef1372d6f8a7e509e662397bc","modified":1658202973470},{"_id":"public/categories/Python/MySQL/index.html","hash":"1e66a30dd11bf1e4b278315248c5ecc20a52ec34","modified":1658202973470},{"_id":"public/categories/Python/Python入门/index.html","hash":"97596e045bd52f8778e03af2a0b0a0bc94e89bd0","modified":1658202973470},{"_id":"public/tags/工作/index.html","hash":"4856b81566ee392e65c5d78f5d8dc9434ee4a426","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/11_函数的基本使用/index.html","hash":"d726f34233957e18b42cfb15d6ecda98a3942b66","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/12_函数的参数/index.html","hash":"9fdee99d032741c3a7786c87dc38f5db1bc68ab9","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/10_文件处理/index.html","hash":"520ff734634b2d2399e524a11e487e8e5a4eb9d8","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/13_名称空间与作用域/index.html","hash":"bf3d5aa914c9f3dd3b4c2c285baab39722bf7749","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/14_函数对象和闭包/index.html","hash":"c1a6d93f43daac9340fae42722033cd8a37bab28","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/15_装饰器/index.html","hash":"75841d0404ca5be6d79fecdc3cd18589282bc917","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/16_迭代器/index.html","hash":"2cb4acc47586d9a208339de19bd808d81a7a159b","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/17_生成器/index.html","hash":"5fef38a3f114c191f26afc47a96e19f775ec1536","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/09_字符编码/index.html","hash":"ea5f37401dc59fcf78f9fd0a20c256b5696d9fce","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/05_Python语法入门之垃圾回收机制/index.html","hash":"71540f788e3f856d679050e7087c3c69847e00f5","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/04_Python语法入门之基本数据类型/index.html","hash":"55f10d78ac7dc611547bfbd138a73fbc9dda9492","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/03_Python语法入门之变量/index.html","hash":"4bd4e2050ddf7fdd711b54b334bf406c0a76bc27","modified":1658202973470},{"_id":"public/2022/07/18/03_Python/01_Python基础/01_计算机核心基础/index.html","hash":"6240a91df7d01c4e88399bebc8deb05c2947f465","modified":1658202973470},{"_id":"public/2022/07/15/04_杂记/甲骨文VPS搭建梯子/index.html","hash":"7478c91e3d7f17d6a0dbe952d6ebb537c46366ef","modified":1658202973470},{"_id":"public/2022/07/11/04_杂记/SVN搭建/index.html","hash":"7ef1e65e9823aede8b3efee67c96bbe3f500f63c","modified":1658202973470},{"_id":"public/2022/07/07/00_博客维护/hexo维护/index.html","hash":"d22a00324d1068d505877b2f31fc606d73164ef7","modified":1658202973470},{"_id":"public/2022/07/06/02_测试/01_POC测试工具使用指南/index.html","hash":"443dbeb7bb43b282a266322ba864c5fa32bdd376","modified":1658202973470},{"_id":"public/2022/07/06/02_测试/02_测试工具使用说明-完善中/index.html","hash":"f564883eaa22d85e5aa0b406f15311fd852908fa","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/01-整体架构规划/index.html","hash":"c50274fdad3173e9546e6787359185a576dabeb4","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/03-NFS服务搭建/index.html","hash":"6c8632ba085708244eb512fecc6b90f6a9186183","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/02-Rsync服务搭建/index.html","hash":"8d7307afbba4496b8cb9f6c17c4f31ce893aa518","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/05-ssh服务跳板机搭建/index.html","hash":"d7a2456c80086259526d54d5fb0f4c5a798a4fab","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/04-sersync实时同步备份/index.html","hash":"47f48f7e174f43235f4b59d2e5aac46258029792","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/06-HTTP协议/index.html","hash":"06cd844c25ed736a0deaf5d2db239cf3a0fbfedc","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/07-Nginx(一)安装与配置/index.html","hash":"b9359cd5bb3f4af0aab0945f135810835f1b071f","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/09-Nginx(三)LNMP架构安装/index.html","hash":"56e0e065703256b1c24ab81ee1c0e14b90a1f8fb","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/08-Nginx(二)常用官方模块/index.html","hash":"ef49443a71008b4ce9fef4eddcb95e944eef487a","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/11-Nginx(五)Nginx代理/index.html","hash":"8038b90b6c933ecaa4ac76740bf0d5540446eee0","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/10-Nginx(四)LNMP架构拆分/index.html","hash":"26f1b1d38a782bd887091c2a461708d02745550d","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/13-Nginx(七)Nginx七层负载均衡调度与健康检查/index.html","hash":"5915553e6de69721f7e59dde53888f862e975d8e","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/12-Nginx(六)Nginx七层负载均衡/index.html","hash":"e781d70165a23ef016927d8eaeb5745d3291e5a8","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/14-Nginx(八)Nginx四层负载均衡/index.html","hash":"4c2ffb266011f9fc14a9b322b36cf9b1329a0bc3","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/02-综合架构/15-Nginx(九)动静分离和rewrite/index.html","hash":"b0859ee9ea47c8bd470662126c2bd98e8605845e","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day01-虚拟机安装/课堂笔记/index.html","hash":"de178793558c31656b1e403975f335d5c9524b38","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day08-打包与压缩/打包与压缩笔记/index.html","hash":"870bf6f9ae2261c922c9fb53d9827bd06d4261cf","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day10-Linux文件权限/笔记/index.html","hash":"500d12faf035221361ca093ab05b37dc2fbc4d5d","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day12-软件包管理/软件包/index.html","hash":"a71015eb019943af51841494478fe81957e325f3","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day13-yum仓库/yum仓库/index.html","hash":"b911881743c4747dc8ecd3c1f752be3fbe3fe8a5","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day11-sudo与su/facl/index.html","hash":"64ba3c214be7345dca5d3870ce11fdcbde73f27b","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day18-netstat使用/笔记/index.html","hash":"d6f7f352c53ff1c9f988ad46faabdbef7479f7da","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day11-sudo与su/sudo and su/index.html","hash":"388a72711ec578d676765bfe02a34195e654c21c","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day16-进程管理/笔记/index.html","hash":"f962eab46813b0da08d0ca2f27d70e4d426e869e","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day17-Linux信号/笔记/index.html","hash":"4bac33e3df683d5b8ea7259f76ce479606347cb7","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day20-dd与文件系统备份/笔记/index.html","hash":"91983cd13cc102f86b7aafdfaabb43c019cc3bdf","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day19-磁盘分区/02_逻辑卷管理/index.html","hash":"ed2bc33e48d79a89e9bea70f0000ced91bd7daa3","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day19-磁盘分区/01_磁盘分区笔记/index.html","hash":"c36c4ac93555c95d41ac728c3dcb06dc7d4793d2","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day22-防火墙与iptables/iptables使用/index.html","hash":"84796612733fb27d15b3cc26b518d9ff7bb53492","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/01-基础命令/day21-计划任务/计划任务/index.html","hash":"e1f243deb6697c7cb20f7f8ad2edb234cabdaf51","modified":1658202973470},{"_id":"public/2022/07/06/01_运维/04-虚拟化/OpenStack学习笔记/index.html","hash":"1ae3c7819e7ffcbde836640e6e231da1c587eaa7","modified":1658202973470},{"_id":"public/2021/07/08/01_运维/05-K8S/K8S系列-一-安装K8S/index.html","hash":"e1d29ed9abe45523fa900e22e8563eb0baf3e97f","modified":1658202973470},{"_id":"public/2021/07/07/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose/index.html","hash":"7ec4cf23a4cfd2bf8608cbd5c8de00d3bbcb3336","modified":1658202973470},{"_id":"public/2021/07/06/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连/index.html","hash":"f0493ea3553a28292fbe5e5d2a92db6bdec926be","modified":1658202973470},{"_id":"public/2021/07/06/01_运维/03-Docker/Docker系列-八-Docker私有仓库/index.html","hash":"8c01288f55de243cee0a9e56e4292cbcf0213b52","modified":1658202973470},{"_id":"public/2021/06/30/01_运维/03-Docker/Docker系列-六-Dockfile的使用/index.html","hash":"e595da9146063a6f9e602b2262a64eaa6c8ee3a0","modified":1658202973470},{"_id":"public/2021/07/05/01_运维/03-Docker/Docker系列-七-Docker镜像分层与同主机中容器互连/index.html","hash":"97f3d5bac26550fea6e5a477ffc09433949e9d79","modified":1658202973470},{"_id":"public/2021/06/29/01_运维/03-Docker/Docker系列-五-手动制作docker镜像/index.html","hash":"8d74299111cd90b9a762160ae7b0691e0442363c","modified":1658202973470},{"_id":"public/2021/06/29/01_运维/03-Docker/Docker系列-四-容器的数据卷挂载与小案例练习/index.html","hash":"380e1c21f9cbe3110c38bf0c5ddcfc1143cf2256","modified":1658202973470},{"_id":"public/2021/06/29/01_运维/03-Docker/Docker系列-三-容器的网络访问/index.html","hash":"7706d8538c2402ec9fa4b114cfd7b34a94c05306","modified":1658202973470},{"_id":"public/2021/06/28/01_运维/03-Docker/Docker系列-一-安装Docker/index.html","hash":"195889ae93c13f4f59ba8b1dc5bca7647882f00a","modified":1658202973470},{"_id":"public/2021/06/28/01_运维/03-Docker/Docker系列-二-Docker常用管理命令/index.html","hash":"412bae67024c4f723c0be1922ed931efbfaa9a46","modified":1658202973470},{"_id":"public/2021/06/28/01_运维/03-Docker/Docker系列-零-Docker介绍/index.html","hash":"a215373302e4f8988afb796016daae0744a12a5e","modified":1658202973470},{"_id":"public/archives/index.html","hash":"a1988aa15eb819be35914b396849edab8257a02a","modified":1658202973470},{"_id":"public/archives/page/3/index.html","hash":"ee42fe849b793ab9baeb6213115514d6aee273a5","modified":1658202973470},{"_id":"public/archives/page/2/index.html","hash":"20388ee3e8ffaf142041960ec6a3add464fb4db8","modified":1658202973470},{"_id":"public/archives/page/4/index.html","hash":"6a55ed50a39e2585be0d7eb4de0fbe73c0bce352","modified":1658202973470},{"_id":"public/archives/page/5/index.html","hash":"adff4700e38a639579d9b137961d558db9147549","modified":1658202973470},{"_id":"public/archives/2021/index.html","hash":"19556249fe774fbdac6e59ec1a09244c89b30505","modified":1658202973470},{"_id":"public/archives/2022/index.html","hash":"fb977064512e10d1780534ec2a0bc5e36d4b53de","modified":1658202973470},{"_id":"public/archives/2022/page/3/index.html","hash":"85951537b198f61d261a71e2e434732b88973347","modified":1658202973470},{"_id":"public/archives/2022/page/2/index.html","hash":"0bde5437fc8cb15a90c336ba97fecc70c0b071ce","modified":1658202973470},{"_id":"public/archives/2022/page/4/index.html","hash":"c9c8c10f636cfb0f0c6cf4931bdcb0d702e0d337","modified":1658202973470},{"_id":"public/archives/2022/07/index.html","hash":"6fd85cb4c3236885767343b423840907e82e568f","modified":1658202973470},{"_id":"public/archives/2022/07/page/2/index.html","hash":"5540756e004d593813d9cd30c5a3f9b87b5154a7","modified":1658202973470},{"_id":"public/archives/2022/07/page/3/index.html","hash":"08ffa09ef8359e732bb8640d8bbb03366b0aff67","modified":1658202973470},{"_id":"public/archives/2022/07/page/4/index.html","hash":"8959f2de5e6411ce53f02848d90f1f25b3622053","modified":1658202973470},{"_id":"public/categories/运维/index.html","hash":"d55faef25bdce81364cc67a70a89ae30cc67e9b1","modified":1658202973470},{"_id":"public/categories/运维/page/2/index.html","hash":"7bb31f5f4a709f5406a1ad0b5a30dc96b4dec982","modified":1658202973470},{"_id":"public/categories/运维/page/3/index.html","hash":"6d1324ee6e4dd03f1b0600c90800e561c7647bc0","modified":1658202973470},{"_id":"public/categories/运维/（二）综合架构/index.html","hash":"ac0565f068dabce4d5217295cdfcde68348b11fb","modified":1658202973470},{"_id":"public/categories/运维/（三）Docker/index.html","hash":"af0cbf9bac1e1ec0a3fdab3e332ff29b3453549b","modified":1658202973470},{"_id":"public/categories/运维/（一）基础命令/index.html","hash":"0575ee645201afd95b08ca6249ebd211172236b7","modified":1658202973470},{"_id":"public/index.html","hash":"46e5c7f354b4de44e7e86e6f2a87febd4543d73d","modified":1658202973470},{"_id":"public/page/2/index.html","hash":"d207b7acb9ea73b588e7d92c87be5cb7f6c9eae5","modified":1658202973470},{"_id":"public/page/3/index.html","hash":"df4cfa746a1a38d52f543123caa05e69e3897443","modified":1658202973470},{"_id":"public/page/4/index.html","hash":"7affc383aa82e9c18397d4af38966bb8fb6d9fae","modified":1658202973470},{"_id":"public/page/5/index.html","hash":"6caef366ba93debd01dd376ff034f250fb1d2aa7","modified":1658202973470},{"_id":"public/page/6/index.html","hash":"c70272976f5ae89e80c44f7c7ffa211256933aa8","modified":1658202973470},{"_id":"public/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1658202973470},{"_id":"public/images/logo-algolia-nebula-blue-full.svg","hash":"b85e274207b1392782476a0430feac98db1e7da0","modified":1658202973470},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1658202973470},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1658202973470},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1658202973470},{"_id":"public/images/myavatar.png","hash":"1a7dfcae2f2167c6cc7bf74ccddd96129d37211a","modified":1658202973470},{"_id":"public/images/logo.svg","hash":"2cb74fd3ea2635e015eabc58a8d488aed6cf6417","modified":1658202973470},{"_id":"public/img/image-20210820101740471.png","hash":"18e7ea278cd1dd9138ddb245e6e4a3c2078d0abd","modified":1658202973470},{"_id":"public/img/image-20210820111454152.png","hash":"01061728bc91403d55c29826ec53086402d7f6c4","modified":1658202973470},{"_id":"public/img/image-20210820132420586.png","hash":"81f056a663693191889f4e3ea39b8737462633f2","modified":1658202973470},{"_id":"public/img/image-20210820132431971.png","hash":"9afafddcd9c5172b54cf9cffc429803bc93a3d19","modified":1658202973470},{"_id":"public/img/image-20210823225305632.png","hash":"ba738c7ab15bdb767ab303cabaf58663f1c883f2","modified":1658202973470},{"_id":"public/img/image-20210823225246243.png","hash":"86b6bf04356086dc8a53cb85c50de6916411b81d","modified":1658202973470},{"_id":"public/img/image-20210825141416567.png","hash":"102a08731f7912e3c325a91b477a85cc2484dbbf","modified":1658202973470},{"_id":"public/img/image-20210825141330005.png","hash":"4f5886fbc1d9e766e66a8e726a0c4056f9ad7f08","modified":1658202973470},{"_id":"public/img/image-20210825141423629.png","hash":"102a08731f7912e3c325a91b477a85cc2484dbbf","modified":1658202973470},{"_id":"public/img/image-20210825162829977.png","hash":"ea24141de36016be7a97f8f53af9e02266f6954e","modified":1658202973470},{"_id":"public/img/image-20220715110156372.png","hash":"2d4c020c4e749a9a3026eff115b08570a50be2d0","modified":1658202973470},{"_id":"public/img/image-20220715110139880.png","hash":"a2afc304b3fb2b24024871b76af64d624c531e1e","modified":1658202973470},{"_id":"public/img/image-20220715110908252.png","hash":"5d8a4bcfd2325cf460ec6ee7b10810bf688bf82f","modified":1658202973470},{"_id":"public/img/image-20220715111232260.png","hash":"c36299479a7f30b1da00cf55358b372ddd78740b","modified":1658202973470},{"_id":"public/img/image-20220715111243920.png","hash":"9736ee6dd4b26281ad74b6d9dd66bfdea57675a3","modified":1658202973470},{"_id":"public/img/image-20220715145007138.png","hash":"24d4771ab5df18c1b318d0f8fbebb7714f431826","modified":1658202973470},{"_id":"public/img/image-20220715144835831.png","hash":"2aec7390254037a15688c2ec176efcc7a3afb2c6","modified":1658202973470},{"_id":"public/img/image-20220715145640940.png","hash":"1920520daa9427baa1862bfad2208ed271c1e770","modified":1658202973470},{"_id":"public/img/image-20220715150723654.png","hash":"6d4e295a9fb045a9784371c5dee7e2d6b9f77569","modified":1658202973470},{"_id":"public/img/image-20220715145722733.png","hash":"306b324abc8be4fe8520236617c983c8f92e0d10","modified":1658202973470},{"_id":"public/img/image-20220715145825655.png","hash":"1da5b3bb3ae0c63e985980eced6955066bb30b45","modified":1658202973470},{"_id":"public/img/image-20220715150801833.png","hash":"660bf52bf982adb3f0433ea2d23b76d59d117214","modified":1658202973470},{"_id":"public/img/image-20220715150832903.png","hash":"aba081cf5a4e59d1ba8aea7a730aa02474fe7abe","modified":1658202973470},{"_id":"public/img/image-20220715151138944.png","hash":"e75c1990b60c7397a7e6d04242bf9f992d33b52c","modified":1658202973470},{"_id":"public/img/image-20220715151303012.png","hash":"0006df733f2e0c604f224237d0a273207a8be0a8","modified":1658202973470},{"_id":"public/img/image-20220715151954505.png","hash":"0e2f71d5d606d8f78850af80949a68ca923f9d74","modified":1658202973470},{"_id":"public/img/image-20220715151735023.png","hash":"51b824c211dfacbfb413dacccfb0d5b4753695b2","modified":1658202973470},{"_id":"public/img/image-20220715155122886.png","hash":"cd34ad37abe749304e49b09ebd6793a2e5e7a1f7","modified":1658202973470},{"_id":"public/img/image-20220718091017221.png","hash":"7d1645bf2495606b795c5043beb7a3a98aa23e72","modified":1658202973470},{"_id":"public/img/image-20220718111616313.png","hash":"c7a286cdb7656514d1ccbc440bf1a5c68a4c538d","modified":1658202973470},{"_id":"public/img/image-20220719101836015.png","hash":"01d987294b31309c8642f8665fc712acd02c2d68","modified":1658202973470},{"_id":"public/img/image-20220719104519550.png","hash":"fd48c4492cff2435b93eee25575f8f69e86913d3","modified":1658202973470},{"_id":"public/img/image-20220719104324299.png","hash":"77133bde9068ea63951a610d13523be7989ecd87","modified":1658202973470},{"_id":"public/img/image-20220718112050165.png","hash":"afc8efb48f64c6b3b52421c8f7b3c045966d1314","modified":1658202973470},{"_id":"public/img/ssh免密登录.png","hash":"254369e6f885605d0149d9d5c1865a3c4c728779","modified":1658202973470},{"_id":"public/2021/07/07/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose/显示不全.png","hash":"1fcbd38eaf60396e4d1fcb9905a109f37fd3ecb3","modified":1658202973470},{"_id":"public/img/image-20210820101707762.png","hash":"5dc1ee403e711df7850924478b12e8fb3a41dbd6","modified":1658202973470},{"_id":"public/img/image-20210820102735419.png","hash":"75b5c1af684a04d824f12a8d541234ac66164937","modified":1658202973470},{"_id":"public/img/image-20210820103041679.png","hash":"08e9fbfe5b12254f05295080ec01879bbeac3a23","modified":1658202973470},{"_id":"public/img/image-20210821114011230.png","hash":"a2483f63a5949bc4116ed35fdadf0272c04a05ec","modified":1658202973470},{"_id":"public/img/image-20210821113447825.png","hash":"3acef8fc3161f6712ee27e56dc8e221f6851083f","modified":1658202973470},{"_id":"public/img/image-20220713102756709.png","hash":"a6997a2f70658014c965f4f95415c63f34d54e75","modified":1658202973470},{"_id":"public/img/image-20220715110810985.png","hash":"6559106e5ffbddec553b6e64175ecd17db72b6f1","modified":1658202973470},{"_id":"public/img/image-20220715110856325.png","hash":"7d5c8e988846297c4d43abdf729879a9a9e8c5aa","modified":1658202973470},{"_id":"public/img/image-20220715110934572.png","hash":"427aff513a1effee9a915de2fb9a8082e85b3fa3","modified":1658202973470},{"_id":"public/img/image-20220715151454194.png","hash":"6bbc8fca2f75b412288ee0b1b661a4ed359051b7","modified":1658202973470},{"_id":"public/img/image-20220715155109519.png","hash":"cdd761a98372de1b6c231c9032d009501ebf078e","modified":1658202973470},{"_id":"public/img/image-20220715154849451.png","hash":"a365dea44e7e8acd8929218c4fe50b150b367fd4","modified":1658202973470},{"_id":"public/img/image-20220715154822649.png","hash":"fd21c139660c4f89c4edad4ca83678c25aa8790d","modified":1658202973470},{"_id":"public/img/image-20220715155230097.png","hash":"97ffaea29e35e0ca4104afa80b2b29a443acd127","modified":1658202973470},{"_id":"public/img/image-20220718091033465.png","hash":"f1841db1c0eeab42193b0b22bd303391b2d2551e","modified":1658202973470},{"_id":"public/img/image-20220718111923212.png","hash":"e9bcea6cc69c98d051bada439726785f407d9f57","modified":1658202973470},{"_id":"public/img/sersync流程.png","hash":"39fb8fed727a7a667889cc658559a6e955e0fa71","modified":1658202973470},{"_id":"public/img/sersync流程-1628145534424.png","hash":"228e9f6a0450e5cd4e7c90b2ebf3d38f3d27167e","modified":1658202973470},{"_id":"public/css/noscript.css","hash":"ec89b3425fbce20863d554c6fd495ea29c3c303d","modified":1658202973470},{"_id":"public/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1658202973470},{"_id":"public/js/bookmark.js","hash":"0f563ffbf05fad30e854e413ab17ff7164ab5a53","modified":1658202973470},{"_id":"public/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1658202973470},{"_id":"public/js/motion.js","hash":"f7c825cbff11885fa0dffa64824fd00e505d6a8d","modified":1658202973470},{"_id":"public/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1658202973470},{"_id":"public/js/pjax.js","hash":"919f5281c4a04d11cfd94573ecf57b3dbabd3cc8","modified":1658202973470},{"_id":"public/js/next-boot.js","hash":"da0f07f9eaaa83de70128b0feaea3fdadb90457a","modified":1658202973470},{"_id":"public/js/cursor/fireworks.js","hash":"0b5f9d5510d56f1a0cc074ba9f6df72cafdbd3d9","modified":1658202973470},{"_id":"public/js/utils.js","hash":"200088bfd042f5304b2a04befab0829148845e0e","modified":1658202973470},{"_id":"public/js/schedule.js","hash":"a1333258726caf84f368a8f8454639c7dc1626bb","modified":1658202973470},{"_id":"public/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1658202973470},{"_id":"public/js/third-party/fancybox.js","hash":"c098d14e65dd170537134358d4b8359ad0539c2c","modified":1658202973470},{"_id":"public/js/schemes/muse.js","hash":"9794bd4fc6a458322949d6a0ade89cd1026bc69f","modified":1658202973470},{"_id":"public/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1658202973470},{"_id":"public/js/third-party/rating.js","hash":"4e92c2d107ba47b47826829f9668030d5ea9bfb8","modified":1658202973470},{"_id":"public/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1658202973470},{"_id":"public/js/third-party/analytics/google-analytics.js","hash":"59684383385059dc4f8a1ff85dbbeb703bcdbcb5","modified":1658202973470},{"_id":"public/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1658202973470},{"_id":"public/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1658202973470},{"_id":"public/js/third-party/chat/gitter.js","hash":"cc38c94125f90dadde11b5ebac7d8bf99a1a08a2","modified":1658202973470},{"_id":"public/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1658202973470},{"_id":"public/js/third-party/comments/gitalk.js","hash":"0ec038cf83e8ec067534f16a54041e47a3c1e59a","modified":1658202973470},{"_id":"public/js/third-party/comments/disqus.js","hash":"e1cc671b0d524864fd445e3ab4ade9ee6d07e565","modified":1658202973470},{"_id":"public/js/third-party/comments/changyan.js","hash":"260d1a77d6a3bb33a579d3e4cca1997003e799b5","modified":1658202973470},{"_id":"public/js/third-party/comments/disqusjs.js","hash":"b6c58f098473b526d6a3cd35655caf34b77f7cff","modified":1658202973470},{"_id":"public/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1658202973470},{"_id":"public/js/third-party/comments/isso.js","hash":"753a873b6f566aff5ba77ca23f91b78eb880ca64","modified":1658202973470},{"_id":"public/js/third-party/search/algolia-search.js","hash":"fdb7b7cef1a147d897e7f7cd8903b58368ec2062","modified":1658202973470},{"_id":"public/js/third-party/comments/utterances.js","hash":"f67f90eb03e284c82da2b8cf2f1e31801813c16d","modified":1658202973470},{"_id":"public/js/third-party/statistics/lean-analytics.js","hash":"5a928990856b8e456f0663cf3b6b406733672e39","modified":1658202973470},{"_id":"public/js/third-party/tags/pdf.js","hash":"af78c22f0e61c8c8aa8794e585e0d632c6d4fcb8","modified":1658202973470},{"_id":"public/js/third-party/statistics/firestore.js","hash":"411a72df581f5b21317dc28633c7993207eb9e1c","modified":1658202973470},{"_id":"public/js/third-party/search/local-search.js","hash":"4536cb6d0a9bbaaa86fab3fa0101f6a3a3ec5a76","modified":1658202973470},{"_id":"public/js/third-party/tags/mermaid.js","hash":"f27d817b0c2138dd3215b1f46af0753f60a008f3","modified":1658202973470},{"_id":"public/js/third-party/comments/livere.js","hash":"2247d88c934c765c43013337860774aaa99f0b31","modified":1658202973470},{"_id":"public/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1658202973470},{"_id":"public/css/main.css","hash":"3e64be5f98ba0135985922719beba28ab47598d6","modified":1658202973470},{"_id":"public/images/xhc.jpg","hash":"95904aee6e54ecd19b8cdd8de2dcd16265c9e901","modified":1658202973470},{"_id":"public/img/2108785-20210605105334455-1251950822.png","hash":"6c3302c81bb50192b3fe9a7e06653964abfbdcdd","modified":1658202973470},{"_id":"public/img/image-20210825142256349.png","hash":"24825deaff8207e96279d925c1009f89c04258cd","modified":1658202973470},{"_id":"public/img/image-20220715110229082.png","hash":"48c8fa553153bd559318bf200fc4bb819978a007","modified":1658202973470},{"_id":"public/img/image-20220715110833863.png","hash":"85baf64c1821de62f59f42b2dbc6cfd65ea2a28e","modified":1658202973470},{"_id":"public/img/image-20220715111100262.png","hash":"c838816a1eea6fd45116bfec10f0b98e216efd22","modified":1658202973470},{"_id":"public/img/image-20220715111746387.png","hash":"189ef7f96878806ac71495de8e2b652e77535723","modified":1658202973470},{"_id":"public/img/image-20220715111737349.png","hash":"66f0f77624304fe1210ff902241cd932c9c16f79","modified":1658202973470},{"_id":"public/img/image-20220715145556778.png","hash":"a43857886b5abce8ad8581c7e2fd3498a952aca5","modified":1658202973470},{"_id":"public/img/单台服务器动静分离.png","hash":"6c3302c81bb50192b3fe9a7e06653964abfbdcdd","modified":1658202973470},{"_id":"public/img/多台服务器动静分离.png","hash":"fa547a44ad0a5843c0d1260adc94e105494a262e","modified":1658202973470},{"_id":"public/img/image-20210824001613717.png","hash":"082afde2f0a22acc5fec2d71f49542903bc0f688","modified":1658202973470},{"_id":"public/img/image-20210824001638506.png","hash":"2da46e4a6d8cd0d1054f5b3797a475ac587c3c86","modified":1658202973470},{"_id":"public/img/image-20210825143746986.png","hash":"64f558fc85b92c6e9eeb5b18c062ec5bad206716","modified":1658202973470},{"_id":"public/img/image-20220715111047082.png","hash":"4ee6c0bff2ef7bbf496360cb84f8661bb11bd853","modified":1658202973470},{"_id":"public/img/image-20220715111759964.png","hash":"ece7d258fe16f7594b6ca0aa7a86bd7bd59e7f09","modified":1658202973470},{"_id":"public/img/image-20210823225412626.png","hash":"fa08782400eebc5428e18c9b56a4f8e78b4c77b1","modified":1658202973470},{"_id":"public/img/image-20220715150619814.png","hash":"c3da2db5ada41f3b60fb935b0ee4eef12dd5fcb0","modified":1658202973470},{"_id":"public/img/http思维导图.png","hash":"aa2c10bf35b713b190031148ecb9abd53ba79c13","modified":1658202973470},{"_id":"public/img/image-20220715145306545.png","hash":"32cc7bae1b3407b7a81ce5b3bb872d50974c5b57","modified":1658202973470},{"_id":"public/img/image-20220715145353695.png","hash":"899aaa04030872e3976a9e0653e2fc614fd3bc52","modified":1658202973470},{"_id":"public/2021/07/06/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连/overlay网络访问.png","hash":"432a81e36eff99a9b53c0af6f7d186d85e664fe6","modified":1658202973470},{"_id":"public/img/综合架构图.png","hash":"04f5ed6843cdc824626f4d62ee63f260c848607e","modified":1658202973470},{"_id":"public/img/image-20210823230415237.png","hash":"05cb3071c72e7e7248b8f4ed7a1be329f7b39d4d","modified":1658202973470}],"Category":[{"name":"博客维护","_id":"cl5rn8k030004a8v7aiqq3xlc"},{"name":"测试","_id":"cl5rn8k08000aa8v7gnu7f8ox"},{"name":"杂记","_id":"cl5rn8k0a000ea8v752r29yr9"},{"name":"信创POC测试","parent":"cl5rn8k08000aa8v7gnu7f8ox","_id":"cl5rn8k0g000qa8v70td33ov6"},{"name":"运维","_id":"cl5rn8k0j000ya8v7elmocoau"},{"name":"（二）综合架构","parent":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k130020a8v7bv2fgmf6"},{"name":"（五）K8S","parent":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1b002qa8v7ft1ghawz"},{"name":"（四）虚拟化之OpenStack","parent":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1e0030a8v7eril9qx2"},{"name":"（三）Docker","parent":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1f0036a8v74l9h0ndu"},{"name":"Python","_id":"cl5rn8k1s004ra8v73iq90d0m"},{"name":"（一）基础命令","parent":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1t0052a8v7dyfv419p"},{"name":"MySQL","parent":"cl5rn8k1s004ra8v73iq90d0m","_id":"cl5rn8k200060a8v7b9fsbgc4"},{"name":"Python入门","parent":"cl5rn8k1s004ra8v73iq90d0m","_id":"cl5rn8k210066a8v7glxsfd9m"}],"Data":[],"Page":[{"title":"categories","date":"2021-06-28T06:08:54.000Z","type":"categories","layout":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2021-06-28 14:08:54\ntype: \"categories\"\nlayout: \"categories\"\n---\n","updated":"2022-07-06T02:11:52.517Z","path":"categories/index.html","comments":1,"_id":"cl5rn8jzq0000a8v70wbm6bt0","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"tags","date":"2021-06-28T06:09:10.000Z","type":"tags","layout":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2021-06-28 14:09:10\ntype: \"tags\"\nlayout: \"tags\"\n---\n","updated":"2022-07-06T02:11:52.517Z","path":"tags/index.html","comments":1,"_id":"cl5rn8k010002a8v702jp68yc","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"404","date":"2021-06-28T06:09:23.000Z","type":"404","layout":"404","description":"Oops～，我崩溃了！找不到你想要的页面 :(","_content":"","source":"404/index.md","raw":"---\ntitle: 404\ndate: 2021-06-28 14:09:23\ntype: \"404\"\nlayout: \"404\"\ndescription: \"Oops～，我崩溃了！找不到你想要的页面 :(\"\n---\n","updated":"2022-07-06T02:11:52.486Z","path":"404/index.html","comments":1,"_id":"cl5rn8k040005a8v7amhihbzz","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"Hexo博客维护","date":"2022-07-07T06:10:52.000Z","_content":"\n## 1 Hexo博客维护\n\n版本：`Next 8.12.2`\n\n1、下载安装nodejs\n\nhttps://nodejs.org/en/\n\n2、切换npm为阿里源\n\n```shell\n npm config set registry https://registry.npm.taobao.org\n```\n\n3、使用npm安装hexo\n\n```shell\nnpm install -g hexo-cli\n```\n\n>否则会报错:\n>\n>$ hexo clean\n>ERROR Cannot find module 'hexo' from 'C:\\Users\\fr724\\Desktop\\新建文件夹\\gsproj.github.io'\n>ERROR Local hexo loading failed in ~\\Desktop\\新建文件夹\\gsproj.github.io\n>ERROR Try running: 'rm -rf node_modules && npm install --force'\n\n4、使用npm安装搜索功能依赖\n\n```shell\n\nnpm install hexo-excerpt --save\n```\n\n5、内容上线\n\n```shell\nhexo clean\nhexo g\nhexo d # 上线到githubio\nhexo s # 本地试运行\n```\n\n\n\n## 2 功能添加\n\n### 2.1 搜索功能\n\n安装依赖\n\n```shell\nnpm install hexo-generator-searchdb --save\n```\n\n修改主题设置文件`themes/next/_config.yml`\n\n```yml\n# Local Search\n# Dependencies: https://github.com/next-theme/hexo-generator-searchdb\nlocal_search:\n  enable: true\t# 此处改为true\n  # If auto, trigger search by changing input.\n  # If manual, trigger search by pressing enter key or search button.\n  trigger: auto\n  # Show top n results per article, show all results by setting to -1\n  top_n_per_article: 1\n  # Unescape html strings to the readable one.\n  unescape: false\n  # Preload the search data when the page loads.\n  preload: false\n```\n\n### 2.2 菜单显示归档/书签\n\n修改主题设置文件next/_config.yml\n\n```yaml\nmenu:\n  #home: / || fa fa-home\n  #about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\t# 取消注释\n  categories: /categories/ || fa fa-th\t# 取消注释\n  archives: /archives/ || fa fa-archive\t# 取消注释\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n效果如下图：\n\n![image-20220719101836015](../../img/image-20220719101836015.png)\n\n### 2.3 鼠标点击烟花效果\n\n下载[fireworks.js](https://aliyun-oss-pic-bucket.oss-cn-beijing.aliyuncs.com/file/fireworks.js)文件放到`themes/next/source\\js\\cursor`中\n\n创建`themes/next/layout/_custom`文件夹，并在其中创建`custom.swig`文件，内容如下\n\n```python\n{# 鼠标点击烟花特效 #}\n{% if theme.cursor_effect == \"fireworks\" %}\n  <script async src=\"/js/cursor/fireworks.js\"></script>\n{% elseif theme.cursor_effect == \"explosion\" %}\n  <canvas class=\"fireworks\" style=\"position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;\" ></canvas>\n  <script src=\"//cdn.bootcss.com/animejs/2.2.0/anime.min.js\"></script>\n  <script async src=\"/js/cursor/explosion.min.js\"></script>\n{% elseif theme.cursor_effect == \"love\" %}\n  <script async src=\"/js/cursor/love.min.js\"></script>\n{% elseif theme.cursor_effect == \"text\" %}\n  <script async src=\"/js/cursor/text.js\"></script>\n{% endif %}\n```\n\n编辑`themes/next/layout/_layout.njk文件，在尾行导入swig文件\n\n```shell\n...\n  {{ partial('_scripts/index.njk', {}, {cache: theme.cache.enable}) }}\n  {{ partial('_third-party/index.njk', {}, {cache: theme.cache.enable}) }}\n  {{ partial('_third-party/statistics/index.njk', {}, {cache: theme.cache.enable}) }}\n\n  {%- include '_third-party/math/index.njk' -%}\n  {%- include '_third-party/quicklink.njk' -%}\n\n  {{- next_inject('bodyEnd') }}\n  {% include '_custom/custom.swig' %}\t# 导入swig文件\n</body>\n</html>\n```\n\n编辑`themes/next/_config.yml`文件，添加\n\n```yaml\n# 鼠标点击烟花特效\ncursor_effect: fireworks\n```\n\n> **PS:一个小修改，防止烟花残留**\n>\n> 参考：https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/\n>\n> 修改firewaors.js文件\n>\n> ```javascript\n>   handlePageHide() {\n>     this.booms = []\n>     this.running = false\n>     // 简单修改，清理停留不动的烟火特效\n>     this.computerContext.clearRect(0, 0, this.globalWidth, this.globalHeight)\n>     this.renderContext.clearRect(0, 0, this.globalWidth, this.globalHeight)\n>   }\n> ```\n\n### 2.4 关闭文章目录的自动章节号\n\n未修改前，自动排了序号，看上去很乱：\n\n![image-20220719104324299](../../img/image-20220719104324299.png)\n\n\n\n修改主题配置文件`/themes/next/_config.yml`\n\n```yaml\ntoc:\n  enable: true\n  # Automatically add list number to toc.\n  number: false\t# 改为false关闭\n  # If true, all words will placed on next lines if header width longer then sidebar width.\n  wrap: false\n  # If true, all level of TOC in a post will be displayed, rather than the activated part of it.\n  expand_all: false\n  # Maximum heading depth of generated toc.\n  max_depth: 6\n```\n\n修改后，清爽了很多：\n\n![image-20220719104519550](../../img/image-20220719104519550.png)\n\n### 2.5 添加头像\n\n将头像文件放到`themes/next/source/images`中\n\n修改主题配置文件`/themes/next/_config.yml`\n\n```shell\n# Sidebar Avatar\navatar:\n  # Replace the default image and set the url here.\n  url: /images/myavatar.png\n```\n\n### 2.6 修改背景图片\n\n>白花花的有点单调\n\n将背景图片放到`themes\\next\\source\\images`\n\n新建`themes\\next\\source\\_data`文件夹\n\n在`_data`中新建`styles.styl`文件\n\n```yaml\nbody {\n    background:url(/images/xhc.jpg);\n    background-repeat: no-repeat;\n    background-attachment:fixed;\n    background-position:50% 50%;\n    // background-size: 100% 100%;\n    background-size: cover;\n    -webkit-background-size: cover;\n    -o-background-size: cover;\n    -moz-background-size: cover;\n    -ms-background-size: cover;\n}\n```\n\n然后将`themes/next/_config.yml`配置文件中`custom_file_path:`下的`#style: source/_data/styles.styl`#号去掉，如下\n\n```yaml\ncustom_file_path:\n  #head: source/_data/head.njk\n  #header: source/_data/header.njk\n  #sidebar: source/_data/sidebar.njk\n  #postMeta: source/_data/post-meta.njk\n  #postBodyEnd: source/_data/post-body-end.njk\n  #footer: source/_data/footer.njk\n  #bodyEnd: source/_data/body-end.njk\n  #variable: source/_data/variables.styl\n  #mixin: source/_data/mixins.styl\n  style: source/_data/styles.styl\n```\n\n\n\n","source":"_posts/00_博客维护/hexo维护.md","raw":"---\ntitle: Hexo博客维护\ndate: 2022-07-07 14:10:52\ncategories:\n- 博客维护\ntags:\n---\n\n## 1 Hexo博客维护\n\n版本：`Next 8.12.2`\n\n1、下载安装nodejs\n\nhttps://nodejs.org/en/\n\n2、切换npm为阿里源\n\n```shell\n npm config set registry https://registry.npm.taobao.org\n```\n\n3、使用npm安装hexo\n\n```shell\nnpm install -g hexo-cli\n```\n\n>否则会报错:\n>\n>$ hexo clean\n>ERROR Cannot find module 'hexo' from 'C:\\Users\\fr724\\Desktop\\新建文件夹\\gsproj.github.io'\n>ERROR Local hexo loading failed in ~\\Desktop\\新建文件夹\\gsproj.github.io\n>ERROR Try running: 'rm -rf node_modules && npm install --force'\n\n4、使用npm安装搜索功能依赖\n\n```shell\n\nnpm install hexo-excerpt --save\n```\n\n5、内容上线\n\n```shell\nhexo clean\nhexo g\nhexo d # 上线到githubio\nhexo s # 本地试运行\n```\n\n\n\n## 2 功能添加\n\n### 2.1 搜索功能\n\n安装依赖\n\n```shell\nnpm install hexo-generator-searchdb --save\n```\n\n修改主题设置文件`themes/next/_config.yml`\n\n```yml\n# Local Search\n# Dependencies: https://github.com/next-theme/hexo-generator-searchdb\nlocal_search:\n  enable: true\t# 此处改为true\n  # If auto, trigger search by changing input.\n  # If manual, trigger search by pressing enter key or search button.\n  trigger: auto\n  # Show top n results per article, show all results by setting to -1\n  top_n_per_article: 1\n  # Unescape html strings to the readable one.\n  unescape: false\n  # Preload the search data when the page loads.\n  preload: false\n```\n\n### 2.2 菜单显示归档/书签\n\n修改主题设置文件next/_config.yml\n\n```yaml\nmenu:\n  #home: / || fa fa-home\n  #about: /about/ || fa fa-user\n  tags: /tags/ || fa fa-tags\t# 取消注释\n  categories: /categories/ || fa fa-th\t# 取消注释\n  archives: /archives/ || fa fa-archive\t# 取消注释\n  #schedule: /schedule/ || fa fa-calendar\n  #sitemap: /sitemap.xml || fa fa-sitemap\n  #commonweal: /404/ || fa fa-heartbeat\n```\n\n效果如下图：\n\n![image-20220719101836015](../../img/image-20220719101836015.png)\n\n### 2.3 鼠标点击烟花效果\n\n下载[fireworks.js](https://aliyun-oss-pic-bucket.oss-cn-beijing.aliyuncs.com/file/fireworks.js)文件放到`themes/next/source\\js\\cursor`中\n\n创建`themes/next/layout/_custom`文件夹，并在其中创建`custom.swig`文件，内容如下\n\n```python\n{# 鼠标点击烟花特效 #}\n{% if theme.cursor_effect == \"fireworks\" %}\n  <script async src=\"/js/cursor/fireworks.js\"></script>\n{% elseif theme.cursor_effect == \"explosion\" %}\n  <canvas class=\"fireworks\" style=\"position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;\" ></canvas>\n  <script src=\"//cdn.bootcss.com/animejs/2.2.0/anime.min.js\"></script>\n  <script async src=\"/js/cursor/explosion.min.js\"></script>\n{% elseif theme.cursor_effect == \"love\" %}\n  <script async src=\"/js/cursor/love.min.js\"></script>\n{% elseif theme.cursor_effect == \"text\" %}\n  <script async src=\"/js/cursor/text.js\"></script>\n{% endif %}\n```\n\n编辑`themes/next/layout/_layout.njk文件，在尾行导入swig文件\n\n```shell\n...\n  {{ partial('_scripts/index.njk', {}, {cache: theme.cache.enable}) }}\n  {{ partial('_third-party/index.njk', {}, {cache: theme.cache.enable}) }}\n  {{ partial('_third-party/statistics/index.njk', {}, {cache: theme.cache.enable}) }}\n\n  {%- include '_third-party/math/index.njk' -%}\n  {%- include '_third-party/quicklink.njk' -%}\n\n  {{- next_inject('bodyEnd') }}\n  {% include '_custom/custom.swig' %}\t# 导入swig文件\n</body>\n</html>\n```\n\n编辑`themes/next/_config.yml`文件，添加\n\n```yaml\n# 鼠标点击烟花特效\ncursor_effect: fireworks\n```\n\n> **PS:一个小修改，防止烟花残留**\n>\n> 参考：https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/\n>\n> 修改firewaors.js文件\n>\n> ```javascript\n>   handlePageHide() {\n>     this.booms = []\n>     this.running = false\n>     // 简单修改，清理停留不动的烟火特效\n>     this.computerContext.clearRect(0, 0, this.globalWidth, this.globalHeight)\n>     this.renderContext.clearRect(0, 0, this.globalWidth, this.globalHeight)\n>   }\n> ```\n\n### 2.4 关闭文章目录的自动章节号\n\n未修改前，自动排了序号，看上去很乱：\n\n![image-20220719104324299](../../img/image-20220719104324299.png)\n\n\n\n修改主题配置文件`/themes/next/_config.yml`\n\n```yaml\ntoc:\n  enable: true\n  # Automatically add list number to toc.\n  number: false\t# 改为false关闭\n  # If true, all words will placed on next lines if header width longer then sidebar width.\n  wrap: false\n  # If true, all level of TOC in a post will be displayed, rather than the activated part of it.\n  expand_all: false\n  # Maximum heading depth of generated toc.\n  max_depth: 6\n```\n\n修改后，清爽了很多：\n\n![image-20220719104519550](../../img/image-20220719104519550.png)\n\n### 2.5 添加头像\n\n将头像文件放到`themes/next/source/images`中\n\n修改主题配置文件`/themes/next/_config.yml`\n\n```shell\n# Sidebar Avatar\navatar:\n  # Replace the default image and set the url here.\n  url: /images/myavatar.png\n```\n\n### 2.6 修改背景图片\n\n>白花花的有点单调\n\n将背景图片放到`themes\\next\\source\\images`\n\n新建`themes\\next\\source\\_data`文件夹\n\n在`_data`中新建`styles.styl`文件\n\n```yaml\nbody {\n    background:url(/images/xhc.jpg);\n    background-repeat: no-repeat;\n    background-attachment:fixed;\n    background-position:50% 50%;\n    // background-size: 100% 100%;\n    background-size: cover;\n    -webkit-background-size: cover;\n    -o-background-size: cover;\n    -moz-background-size: cover;\n    -ms-background-size: cover;\n}\n```\n\n然后将`themes/next/_config.yml`配置文件中`custom_file_path:`下的`#style: source/_data/styles.styl`#号去掉，如下\n\n```yaml\ncustom_file_path:\n  #head: source/_data/head.njk\n  #header: source/_data/header.njk\n  #sidebar: source/_data/sidebar.njk\n  #postMeta: source/_data/post-meta.njk\n  #postBodyEnd: source/_data/post-body-end.njk\n  #footer: source/_data/footer.njk\n  #bodyEnd: source/_data/body-end.njk\n  #variable: source/_data/variables.styl\n  #mixin: source/_data/mixins.styl\n  style: source/_data/styles.styl\n```\n\n\n\n","slug":"00_博客维护/hexo维护","published":1,"updated":"2022-07-19T03:20:12.758Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8jzs0001a8v71g0yfan1","content":"<h2 id=\"1-Hexo博客维护\"><a href=\"#1-Hexo博客维护\" class=\"headerlink\" title=\"1 Hexo博客维护\"></a>1 Hexo博客维护</h2><p>版本：<code>Next 8.12.2</code></p>\n<p>1、下载安装nodejs</p>\n<p><a href=\"https://nodejs.org/en/\">https://nodejs.org/en/</a></p>\n<p>2、切换npm为阿里源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm config set registry https:&#x2F;&#x2F;registry.npm.taobao.org<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、使用npm安装hexo</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm install -g hexo-cli<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>否则会报错:</p>\n<p>$ hexo clean<br>ERROR Cannot find module ‘hexo’ from ‘C:\\Users\\fr724\\Desktop\\新建文件夹\\gsproj.github.io’<br>ERROR Local hexo loading failed in ~\\Desktop\\新建文件夹\\gsproj.github.io<br>ERROR Try running: ‘rm -rf node_modules &amp;&amp; npm install –force’</p>\n</blockquote>\n<p>4、使用npm安装搜索功能依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">\nnpm install hexo-excerpt --save<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、内容上线</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">hexo clean\nhexo g\nhexo d # 上线到githubio\nhexo s # 本地试运行<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"2-功能添加\"><a href=\"#2-功能添加\" class=\"headerlink\" title=\"2 功能添加\"></a>2 功能添加</h2><h3 id=\"2-1-搜索功能\"><a href=\"#2-1-搜索功能\" class=\"headerlink\" title=\"2.1 搜索功能\"></a>2.1 搜索功能</h3><p>安装依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm install hexo-generator-searchdb --save<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改主题设置文件<code>themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-yml\" data-language=\"yml\"><code class=\"language-yml\"># Local Search\n# Dependencies: https:&#x2F;&#x2F;github.com&#x2F;next-theme&#x2F;hexo-generator-searchdb\nlocal_search:\n  enable: true\t# 此处改为true\n  # If auto, trigger search by changing input.\n  # If manual, trigger search by pressing enter key or search button.\n  trigger: auto\n  # Show top n results per article, show all results by setting to -1\n  top_n_per_article: 1\n  # Unescape html strings to the readable one.\n  unescape: false\n  # Preload the search data when the page loads.\n  preload: false<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-菜单显示归档-x2F-书签\"><a href=\"#2-2-菜单显示归档-x2F-书签\" class=\"headerlink\" title=\"2.2 菜单显示归档&#x2F;书签\"></a>2.2 菜单显示归档&#x2F;书签</h3><p>修改主题设置文件next&#x2F;_config.yml</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">menu</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\">#home: / || fa fa-home</span>\n  <span class=\"token comment\">#about: /about/ || fa fa-user</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> /tags/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>tags\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token key atrule\">categories</span><span class=\"token punctuation\">:</span> /categories/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>th\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token key atrule\">archives</span><span class=\"token punctuation\">:</span> /archives/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>archive\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token comment\">#schedule: /schedule/ || fa fa-calendar</span>\n  <span class=\"token comment\">#sitemap: /sitemap.xml || fa fa-sitemap</span>\n  <span class=\"token comment\">#commonweal: /404/ || fa fa-heartbeat</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>效果如下图：</p>\n<p><img src=\"/../../img/image-20220719101836015.png\" alt=\"image-20220719101836015\"></p>\n<h3 id=\"2-3-鼠标点击烟花效果\"><a href=\"#2-3-鼠标点击烟花效果\" class=\"headerlink\" title=\"2.3 鼠标点击烟花效果\"></a>2.3 鼠标点击烟花效果</h3><p>下载<a href=\"https://aliyun-oss-pic-bucket.oss-cn-beijing.aliyuncs.com/file/fireworks.js\">fireworks.js</a>文件放到<code>themes/next/source\\js\\cursor</code>中</p>\n<p>创建<code>themes/next/layout/_custom</code>文件夹，并在其中创建<code>custom.swig</code>文件，内容如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">&#123;</span><span class=\"token comment\"># 鼠标点击烟花特效 #&#125;</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">if</span> theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"fireworks\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/fireworks.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"explosion\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>canvas <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"fireworks\"</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;\"</span> <span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>canvas<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script src<span class=\"token operator\">=</span><span class=\"token string\">\"//cdn.bootcss.com/animejs/2.2.0/anime.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/explosion.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"love\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/love.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"text\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/text.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> endif <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑&#96;themes&#x2F;next&#x2F;layout&#x2F;_layout.njk文件，在尾行导入swig文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">...\n  &#123;&#123; partial(&#39;_scripts&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n  &#123;&#123; partial(&#39;_third-party&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n  &#123;&#123; partial(&#39;_third-party&#x2F;statistics&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n\n  &#123;%- include &#39;_third-party&#x2F;math&#x2F;index.njk&#39; -%&#125;\n  &#123;%- include &#39;_third-party&#x2F;quicklink.njk&#39; -%&#125;\n\n  &#123;&#123;- next_inject(&#39;bodyEnd&#39;) &#125;&#125;\n  &#123;% include &#39;_custom&#x2F;custom.swig&#39; %&#125;\t# 导入swig文件\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑<code>themes/next/_config.yml</code>文件，添加</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># 鼠标点击烟花特效</span>\n<span class=\"token key atrule\">cursor_effect</span><span class=\"token punctuation\">:</span> fireworks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p><strong>PS:一个小修改，防止烟花残留</strong></p>\n<p>参考：<a href=\"https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/\">https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/</a></p>\n<p>修改firewaors.js文件</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token function\">handlePageHide</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>booms <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>running <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token comment\">// 简单修改，清理停留不动的烟火特效</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>computerContext<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalWidth<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalHeight<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>renderContext<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalWidth<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalHeight<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<h3 id=\"2-4-关闭文章目录的自动章节号\"><a href=\"#2-4-关闭文章目录的自动章节号\" class=\"headerlink\" title=\"2.4 关闭文章目录的自动章节号\"></a>2.4 关闭文章目录的自动章节号</h3><p>未修改前，自动排了序号，看上去很乱：</p>\n<p><img src=\"/../../img/image-20220719104324299.png\" alt=\"image-20220719104324299\"></p>\n<p>修改主题配置文件<code>/themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">toc</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token comment\"># Automatically add list number to toc.</span>\n  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\t<span class=\"token comment\"># 改为false关闭</span>\n  <span class=\"token comment\"># If true, all words will placed on next lines if header width longer then sidebar width.</span>\n  <span class=\"token key atrule\">wrap</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token comment\"># If true, all level of TOC in a post will be displayed, rather than the activated part of it.</span>\n  <span class=\"token key atrule\">expand_all</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token comment\"># Maximum heading depth of generated toc.</span>\n  <span class=\"token key atrule\">max_depth</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改后，清爽了很多：</p>\n<p><img src=\"/../../img/image-20220719104519550.png\" alt=\"image-20220719104519550\"></p>\n<h3 id=\"2-5-添加头像\"><a href=\"#2-5-添加头像\" class=\"headerlink\" title=\"2.5 添加头像\"></a>2.5 添加头像</h3><p>将头像文件放到<code>themes/next/source/images</code>中</p>\n<p>修改主题配置文件<code>/themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># Sidebar Avatar\navatar:\n  # Replace the default image and set the url here.\n  url: &#x2F;images&#x2F;myavatar.png<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-修改背景图片\"><a href=\"#2-6-修改背景图片\" class=\"headerlink\" title=\"2.6 修改背景图片\"></a>2.6 修改背景图片</h3><blockquote>\n<p>白花花的有点单调</p>\n</blockquote>\n<p>将背景图片放到<code>themes\\next\\source\\images</code></p>\n<p>新建<code>themes\\next\\source\\_data</code>文件夹</p>\n<p>在<code>_data</code>中新建<code>styles.styl</code>文件</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">body <span class=\"token punctuation\">&#123;</span>\n    background<span class=\"token punctuation\">:</span>url(/images/xhc.jpg);\n    <span class=\"token key atrule\">background-repeat</span><span class=\"token punctuation\">:</span> no<span class=\"token punctuation\">-</span>repeat;\n    background<span class=\"token punctuation\">-</span>attachment<span class=\"token punctuation\">:</span>fixed;\n    background<span class=\"token punctuation\">-</span>position<span class=\"token punctuation\">:</span>50% 50%;\n    <span class=\"token key atrule\">// background-size</span><span class=\"token punctuation\">:</span> 100% 100%;\n    <span class=\"token key atrule\">background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-webkit-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-o-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-moz-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-ms-background-size</span><span class=\"token punctuation\">:</span> cover;\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>然后将<code>themes/next/_config.yml</code>配置文件中<code>custom_file_path:</code>下的<code>#style: source/_data/styles.styl</code>#号去掉，如下</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">custom_file_path</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\">#head: source/_data/head.njk</span>\n  <span class=\"token comment\">#header: source/_data/header.njk</span>\n  <span class=\"token comment\">#sidebar: source/_data/sidebar.njk</span>\n  <span class=\"token comment\">#postMeta: source/_data/post-meta.njk</span>\n  <span class=\"token comment\">#postBodyEnd: source/_data/post-body-end.njk</span>\n  <span class=\"token comment\">#footer: source/_data/footer.njk</span>\n  <span class=\"token comment\">#bodyEnd: source/_data/body-end.njk</span>\n  <span class=\"token comment\">#variable: source/_data/variables.styl</span>\n  <span class=\"token comment\">#mixin: source/_data/mixins.styl</span>\n  <span class=\"token key atrule\">style</span><span class=\"token punctuation\">:</span> source/_data/styles.styl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-Hexo博客维护\"><a href=\"#1-Hexo博客维护\" class=\"headerlink\" title=\"1 Hexo博客维护\"></a>1 Hexo博客维护</h2><p>版本：<code>Next 8.12.2</code></p>\n<p>1、下载安装nodejs</p>\n<p><a href=\"https://nodejs.org/en/\">https://nodejs.org/en/</a></p>\n<p>2、切换npm为阿里源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm config set registry https:&#x2F;&#x2F;registry.npm.taobao.org<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、使用npm安装hexo</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm install -g hexo-cli<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>否则会报错:</p>\n<p>$ hexo clean<br>ERROR Cannot find module ‘hexo’ from ‘C:\\Users\\fr724\\Desktop\\新建文件夹\\gsproj.github.io’<br>ERROR Local hexo loading failed in ~\\Desktop\\新建文件夹\\gsproj.github.io<br>ERROR Try running: ‘rm -rf node_modules &amp;&amp; npm install –force’</p>\n</blockquote>\n<p>4、使用npm安装搜索功能依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">\nnpm install hexo-excerpt --save<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、内容上线</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">hexo clean\nhexo g\nhexo d # 上线到githubio\nhexo s # 本地试运行<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"2-功能添加\"><a href=\"#2-功能添加\" class=\"headerlink\" title=\"2 功能添加\"></a>2 功能添加</h2><h3 id=\"2-1-搜索功能\"><a href=\"#2-1-搜索功能\" class=\"headerlink\" title=\"2.1 搜索功能\"></a>2.1 搜索功能</h3><p>安装依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">npm install hexo-generator-searchdb --save<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改主题设置文件<code>themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-yml\" data-language=\"yml\"><code class=\"language-yml\"># Local Search\n# Dependencies: https:&#x2F;&#x2F;github.com&#x2F;next-theme&#x2F;hexo-generator-searchdb\nlocal_search:\n  enable: true\t# 此处改为true\n  # If auto, trigger search by changing input.\n  # If manual, trigger search by pressing enter key or search button.\n  trigger: auto\n  # Show top n results per article, show all results by setting to -1\n  top_n_per_article: 1\n  # Unescape html strings to the readable one.\n  unescape: false\n  # Preload the search data when the page loads.\n  preload: false<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-菜单显示归档-x2F-书签\"><a href=\"#2-2-菜单显示归档-x2F-书签\" class=\"headerlink\" title=\"2.2 菜单显示归档&#x2F;书签\"></a>2.2 菜单显示归档&#x2F;书签</h3><p>修改主题设置文件next&#x2F;_config.yml</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">menu</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\">#home: / || fa fa-home</span>\n  <span class=\"token comment\">#about: /about/ || fa fa-user</span>\n  <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> /tags/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>tags\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token key atrule\">categories</span><span class=\"token punctuation\">:</span> /categories/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>th\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token key atrule\">archives</span><span class=\"token punctuation\">:</span> /archives/ <span class=\"token punctuation\">|</span><span class=\"token punctuation\">|</span> fa fa<span class=\"token punctuation\">-</span>archive\t<span class=\"token comment\"># 取消注释</span>\n  <span class=\"token comment\">#schedule: /schedule/ || fa fa-calendar</span>\n  <span class=\"token comment\">#sitemap: /sitemap.xml || fa fa-sitemap</span>\n  <span class=\"token comment\">#commonweal: /404/ || fa fa-heartbeat</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>效果如下图：</p>\n<p><img src=\"/../../img/image-20220719101836015.png\" alt=\"image-20220719101836015\"></p>\n<h3 id=\"2-3-鼠标点击烟花效果\"><a href=\"#2-3-鼠标点击烟花效果\" class=\"headerlink\" title=\"2.3 鼠标点击烟花效果\"></a>2.3 鼠标点击烟花效果</h3><p>下载<a href=\"https://aliyun-oss-pic-bucket.oss-cn-beijing.aliyuncs.com/file/fireworks.js\">fireworks.js</a>文件放到<code>themes/next/source\\js\\cursor</code>中</p>\n<p>创建<code>themes/next/layout/_custom</code>文件夹，并在其中创建<code>custom.swig</code>文件，内容如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">&#123;</span><span class=\"token comment\"># 鼠标点击烟花特效 #&#125;</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> <span class=\"token keyword\">if</span> theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"fireworks\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/fireworks.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"explosion\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>canvas <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"fireworks\"</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;\"</span> <span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>canvas<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script src<span class=\"token operator\">=</span><span class=\"token string\">\"//cdn.bootcss.com/animejs/2.2.0/anime.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/explosion.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"love\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/love.min.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> elseif theme<span class=\"token punctuation\">.</span>cursor_effect <span class=\"token operator\">==</span> <span class=\"token string\">\"text\"</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span>\n  <span class=\"token operator\">&lt;</span>script <span class=\"token keyword\">async</span> src<span class=\"token operator\">=</span><span class=\"token string\">\"/js/cursor/text.js\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token operator\">%</span> endif <span class=\"token operator\">%</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑&#96;themes&#x2F;next&#x2F;layout&#x2F;_layout.njk文件，在尾行导入swig文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">...\n  &#123;&#123; partial(&#39;_scripts&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n  &#123;&#123; partial(&#39;_third-party&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n  &#123;&#123; partial(&#39;_third-party&#x2F;statistics&#x2F;index.njk&#39;, &#123;&#125;, &#123;cache: theme.cache.enable&#125;) &#125;&#125;\n\n  &#123;%- include &#39;_third-party&#x2F;math&#x2F;index.njk&#39; -%&#125;\n  &#123;%- include &#39;_third-party&#x2F;quicklink.njk&#39; -%&#125;\n\n  &#123;&#123;- next_inject(&#39;bodyEnd&#39;) &#125;&#125;\n  &#123;% include &#39;_custom&#x2F;custom.swig&#39; %&#125;\t# 导入swig文件\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑<code>themes/next/_config.yml</code>文件，添加</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># 鼠标点击烟花特效</span>\n<span class=\"token key atrule\">cursor_effect</span><span class=\"token punctuation\">:</span> fireworks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p><strong>PS:一个小修改，防止烟花残留</strong></p>\n<p>参考：<a href=\"https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/\">https://yfx2012.top/2022/01/17/hexo/mouse-click-fireworks/</a></p>\n<p>修改firewaors.js文件</p>\n<pre class=\"line-numbers language-javascript\" data-language=\"javascript\"><code class=\"language-javascript\"><span class=\"token function\">handlePageHide</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>booms <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>running <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token comment\">// 简单修改，清理停留不动的烟火特效</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>computerContext<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalWidth<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalHeight<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>renderContext<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalWidth<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>globalHeight<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<h3 id=\"2-4-关闭文章目录的自动章节号\"><a href=\"#2-4-关闭文章目录的自动章节号\" class=\"headerlink\" title=\"2.4 关闭文章目录的自动章节号\"></a>2.4 关闭文章目录的自动章节号</h3><p>未修改前，自动排了序号，看上去很乱：</p>\n<p><img src=\"/../../img/image-20220719104324299.png\" alt=\"image-20220719104324299\"></p>\n<p>修改主题配置文件<code>/themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">toc</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enable</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token comment\"># Automatically add list number to toc.</span>\n  <span class=\"token key atrule\">number</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\t<span class=\"token comment\"># 改为false关闭</span>\n  <span class=\"token comment\"># If true, all words will placed on next lines if header width longer then sidebar width.</span>\n  <span class=\"token key atrule\">wrap</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token comment\"># If true, all level of TOC in a post will be displayed, rather than the activated part of it.</span>\n  <span class=\"token key atrule\">expand_all</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n  <span class=\"token comment\"># Maximum heading depth of generated toc.</span>\n  <span class=\"token key atrule\">max_depth</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改后，清爽了很多：</p>\n<p><img src=\"/../../img/image-20220719104519550.png\" alt=\"image-20220719104519550\"></p>\n<h3 id=\"2-5-添加头像\"><a href=\"#2-5-添加头像\" class=\"headerlink\" title=\"2.5 添加头像\"></a>2.5 添加头像</h3><p>将头像文件放到<code>themes/next/source/images</code>中</p>\n<p>修改主题配置文件<code>/themes/next/_config.yml</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># Sidebar Avatar\navatar:\n  # Replace the default image and set the url here.\n  url: &#x2F;images&#x2F;myavatar.png<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-修改背景图片\"><a href=\"#2-6-修改背景图片\" class=\"headerlink\" title=\"2.6 修改背景图片\"></a>2.6 修改背景图片</h3><blockquote>\n<p>白花花的有点单调</p>\n</blockquote>\n<p>将背景图片放到<code>themes\\next\\source\\images</code></p>\n<p>新建<code>themes\\next\\source\\_data</code>文件夹</p>\n<p>在<code>_data</code>中新建<code>styles.styl</code>文件</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">body <span class=\"token punctuation\">&#123;</span>\n    background<span class=\"token punctuation\">:</span>url(/images/xhc.jpg);\n    <span class=\"token key atrule\">background-repeat</span><span class=\"token punctuation\">:</span> no<span class=\"token punctuation\">-</span>repeat;\n    background<span class=\"token punctuation\">-</span>attachment<span class=\"token punctuation\">:</span>fixed;\n    background<span class=\"token punctuation\">-</span>position<span class=\"token punctuation\">:</span>50% 50%;\n    <span class=\"token key atrule\">// background-size</span><span class=\"token punctuation\">:</span> 100% 100%;\n    <span class=\"token key atrule\">background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-webkit-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-o-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-moz-background-size</span><span class=\"token punctuation\">:</span> cover;\n    <span class=\"token key atrule\">-ms-background-size</span><span class=\"token punctuation\">:</span> cover;\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>然后将<code>themes/next/_config.yml</code>配置文件中<code>custom_file_path:</code>下的<code>#style: source/_data/styles.styl</code>#号去掉，如下</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">custom_file_path</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\">#head: source/_data/head.njk</span>\n  <span class=\"token comment\">#header: source/_data/header.njk</span>\n  <span class=\"token comment\">#sidebar: source/_data/sidebar.njk</span>\n  <span class=\"token comment\">#postMeta: source/_data/post-meta.njk</span>\n  <span class=\"token comment\">#postBodyEnd: source/_data/post-body-end.njk</span>\n  <span class=\"token comment\">#footer: source/_data/footer.njk</span>\n  <span class=\"token comment\">#bodyEnd: source/_data/body-end.njk</span>\n  <span class=\"token comment\">#variable: source/_data/variables.styl</span>\n  <span class=\"token comment\">#mixin: source/_data/mixins.styl</span>\n  <span class=\"token key atrule\">style</span><span class=\"token punctuation\">:</span> source/_data/styles.styl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n"},{"_content":"## 1 获取原地址IP\n\n通过ping获取\n\n```shell\n[root@3yserver ~]# ping gsproj.github.io\nPING gsproj.github.io (185.199.110.153) 56(84) bytes of data.\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=1 ttl=54 time=36.1 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=2 ttl=54 time=36.0 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=3 ttl=54 time=35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=4 ttl=54 time=35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=5 ttl=54 time=38.3 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=6 ttl=54 time=36.1 ms\n```\n\n## 2 在CDN将IP地址和域名绑定\n\n![image-20220718111616313](../../img/image-20220718111616313.png)\n\n## 3 域名申请网站填写DNS解析地址\n\n![image-20220718112050165](../../img/image-20220718112050165.png)\n\n## 3 确保新域名能ping通，解析正常\n\n```shell\n[root@3yserver ~]# ping codefish.cf\nPING codefish.cf (104.21.96.42) 56(84) bytes of data.\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=1 ttl=59 time=2.63 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=2 ttl=59 time=2.64 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=3 ttl=59 time=2.73 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=4 ttl=59 time=2.71 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=5 ttl=59 time=2.62 ms\n```\n\n> PS: 此处IP不是185开头的IP，是因为cloudflare做了代理，不影响使用，可以通就可以\n\n## 4 在Github添加域名\n\n![image-20220718111923212](../../img/image-20220718111923212.png)","source":"_posts/04_杂记/Githubio如何绑定域名.md","raw":"## 1 获取原地址IP\n\n通过ping获取\n\n```shell\n[root@3yserver ~]# ping gsproj.github.io\nPING gsproj.github.io (185.199.110.153) 56(84) bytes of data.\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=1 ttl=54 time=36.1 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=2 ttl=54 time=36.0 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=3 ttl=54 time=35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=4 ttl=54 time=35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=5 ttl=54 time=38.3 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq=6 ttl=54 time=36.1 ms\n```\n\n## 2 在CDN将IP地址和域名绑定\n\n![image-20220718111616313](../../img/image-20220718111616313.png)\n\n## 3 域名申请网站填写DNS解析地址\n\n![image-20220718112050165](../../img/image-20220718112050165.png)\n\n## 3 确保新域名能ping通，解析正常\n\n```shell\n[root@3yserver ~]# ping codefish.cf\nPING codefish.cf (104.21.96.42) 56(84) bytes of data.\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=1 ttl=59 time=2.63 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=2 ttl=59 time=2.64 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=3 ttl=59 time=2.73 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=4 ttl=59 time=2.71 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq=5 ttl=59 time=2.62 ms\n```\n\n> PS: 此处IP不是185开头的IP，是因为cloudflare做了代理，不影响使用，可以通就可以\n\n## 4 在Github添加域名\n\n![image-20220718111923212](../../img/image-20220718111923212.png)","slug":"04_杂记/Githubio如何绑定域名","published":1,"date":"2022-07-18T07:10:19.405Z","updated":"2022-07-18T07:10:19.405Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k010003a8v74m8eaes3","content":"<h2 id=\"1-获取原地址IP\"><a href=\"#1-获取原地址IP\" class=\"headerlink\" title=\"1 获取原地址IP\"></a>1 获取原地址IP</h2><p>通过ping获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@3yserver ~]# ping gsproj.github.io\nPING gsproj.github.io (185.199.110.153) 56(84) bytes of data.\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;1 ttl&#x3D;54 time&#x3D;36.1 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;2 ttl&#x3D;54 time&#x3D;36.0 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;3 ttl&#x3D;54 time&#x3D;35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;4 ttl&#x3D;54 time&#x3D;35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;5 ttl&#x3D;54 time&#x3D;38.3 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;6 ttl&#x3D;54 time&#x3D;36.1 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-在CDN将IP地址和域名绑定\"><a href=\"#2-在CDN将IP地址和域名绑定\" class=\"headerlink\" title=\"2 在CDN将IP地址和域名绑定\"></a>2 在CDN将IP地址和域名绑定</h2><p><img src=\"/../../img/image-20220718111616313.png\" alt=\"image-20220718111616313\"></p>\n<h2 id=\"3-域名申请网站填写DNS解析地址\"><a href=\"#3-域名申请网站填写DNS解析地址\" class=\"headerlink\" title=\"3 域名申请网站填写DNS解析地址\"></a>3 域名申请网站填写DNS解析地址</h2><p><img src=\"/../../img/image-20220718112050165.png\" alt=\"image-20220718112050165\"></p>\n<h2 id=\"3-确保新域名能ping通，解析正常\"><a href=\"#3-确保新域名能ping通，解析正常\" class=\"headerlink\" title=\"3 确保新域名能ping通，解析正常\"></a>3 确保新域名能ping通，解析正常</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@3yserver ~]# ping codefish.cf\nPING codefish.cf (104.21.96.42) 56(84) bytes of data.\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;1 ttl&#x3D;59 time&#x3D;2.63 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;2 ttl&#x3D;59 time&#x3D;2.64 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;3 ttl&#x3D;59 time&#x3D;2.73 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;4 ttl&#x3D;59 time&#x3D;2.71 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;5 ttl&#x3D;59 time&#x3D;2.62 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS: 此处IP不是185开头的IP，是因为cloudflare做了代理，不影响使用，可以通就可以</p>\n</blockquote>\n<h2 id=\"4-在Github添加域名\"><a href=\"#4-在Github添加域名\" class=\"headerlink\" title=\"4 在Github添加域名\"></a>4 在Github添加域名</h2><p><img src=\"/../../img/image-20220718111923212.png\" alt=\"image-20220718111923212\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-获取原地址IP\"><a href=\"#1-获取原地址IP\" class=\"headerlink\" title=\"1 获取原地址IP\"></a>1 获取原地址IP</h2><p>通过ping获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@3yserver ~]# ping gsproj.github.io\nPING gsproj.github.io (185.199.110.153) 56(84) bytes of data.\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;1 ttl&#x3D;54 time&#x3D;36.1 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;2 ttl&#x3D;54 time&#x3D;36.0 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;3 ttl&#x3D;54 time&#x3D;35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;4 ttl&#x3D;54 time&#x3D;35.9 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;5 ttl&#x3D;54 time&#x3D;38.3 ms\n64 bytes from cdn-185-199-110-153.github.com (185.199.110.153): icmp_seq&#x3D;6 ttl&#x3D;54 time&#x3D;36.1 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-在CDN将IP地址和域名绑定\"><a href=\"#2-在CDN将IP地址和域名绑定\" class=\"headerlink\" title=\"2 在CDN将IP地址和域名绑定\"></a>2 在CDN将IP地址和域名绑定</h2><p><img src=\"/../../img/image-20220718111616313.png\" alt=\"image-20220718111616313\"></p>\n<h2 id=\"3-域名申请网站填写DNS解析地址\"><a href=\"#3-域名申请网站填写DNS解析地址\" class=\"headerlink\" title=\"3 域名申请网站填写DNS解析地址\"></a>3 域名申请网站填写DNS解析地址</h2><p><img src=\"/../../img/image-20220718112050165.png\" alt=\"image-20220718112050165\"></p>\n<h2 id=\"3-确保新域名能ping通，解析正常\"><a href=\"#3-确保新域名能ping通，解析正常\" class=\"headerlink\" title=\"3 确保新域名能ping通，解析正常\"></a>3 确保新域名能ping通，解析正常</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@3yserver ~]# ping codefish.cf\nPING codefish.cf (104.21.96.42) 56(84) bytes of data.\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;1 ttl&#x3D;59 time&#x3D;2.63 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;2 ttl&#x3D;59 time&#x3D;2.64 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;3 ttl&#x3D;59 time&#x3D;2.73 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;4 ttl&#x3D;59 time&#x3D;2.71 ms\n64 bytes from 104.21.96.42 (104.21.96.42): icmp_seq&#x3D;5 ttl&#x3D;59 time&#x3D;2.62 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS: 此处IP不是185开头的IP，是因为cloudflare做了代理，不影响使用，可以通就可以</p>\n</blockquote>\n<h2 id=\"4-在Github添加域名\"><a href=\"#4-在Github添加域名\" class=\"headerlink\" title=\"4 在Github添加域名\"></a>4 在Github添加域名</h2><p><img src=\"/../../img/image-20220718111923212.png\" alt=\"image-20220718111923212\"></p>\n"},{"title":"国产化POC测试工具使用指南","date":"2022-07-06T03:19:52.000Z","_content":"\n# 一、性能测试\n\n>测试台式机/笔记本的软硬件性能\n\n## 1 开机时间\n\n> 测试整机启动的时间（从按下电源开始计时，到出现登录界面计时结束）\n\n测试步骤\n\n```shell\n手机计时\n从按下电源的一刻到进入系统的时间\n```\n\n\n\n## 2 CPU性能测试（整型/浮点型）\n\n>测试CPU整型计算性能，包括单线程基准值、满线程基准值\n>\n>测试CPU浮点计算性能，包括单线程基准值、满线程基准值\n\n### 2.1 CPU2006\n\n>测试环境:\n>\n>​\tCPU：飞腾D2000\n>\n>​\t内存：16G\n>\n>​\t系统：麒麟V10-SP1-2107 桌面操作系统\n\n1、准备\n\n```shell\n测试工具包：\nd2000-spec2006test.tar.gz\n```\n\n2、测试步骤\n\n```shell\n1、把下载好的d2000-spec2006test.tar.gz测试包放到根目录下（建议整机内存≥16GB，否则会影响测试跑分）\n#如果不知道如何放到根目录下，可以先把d2000-spec2006test.tar.gz这个包放到桌面，然后点击鼠标右键打开终端，sudo su ，然后输入密码进入root权限，然后输入cp -r d2000-spec2006test.tar.gz /  ，这样就复制到了根目录下。 \n2、cd / ，进入根目录，sudo su ，然后输入密码，进入root权限。\n3、解压，tar -xvf d2000-spec2006test.tar.gz\n4、更改权限，chmod -R 777 cpu2006-1.2\n5、进入spec2006目录，cd cpu2006-1.2\n6、执行脚本，bash run.sh   #配置依赖环境，！！需要联网，会自动下载部分依赖！！\n7、source /etc/profile  #更新profile文件,此处一定要更新\n8、source ./shrc    #配置环境变量\t\n9、ulimit -s unlimited #内存分配无限制，大于或者等于16G内存的机器可以加此命令，如果是8G内存的机器不要运行此命令，会因内存不够用影响整型测试的429测试项\n10、echo 3 > /proc/sys/vm/drop_caches   #执行测试前，建议清一下缓存\n11、gcc -v   #测试前查看一下gcc的版本是否为GCC931,若不是GCC931，输入source /etc/profile， 再gcc -v查看版本，是GCC931即可执行第12步启动测试\n12、bash d2000-test.sh  #执行8核、单核的整形和浮点测试\n```\n\n3、结果查看\n\n```shell\nPDF测试结果存放在results文件夹\n```\n\n4、编译问题处理（如遇到编译问题，可参考）\n\n```shell\n# 450报错：\n# mpsinput.cc: In member function 'bool soplex::MPSInput::readLine()': mpsinput.cc:75:52: error: no match for 'operator==' (operand types are 'std::basic_istream<char>::__istream_type' {aka 'std::basic_istream<char>'} and 'int')\ng++ -std=c++03\n\n# lto1 fatal error bytecode stream generated with lto version \n编译选项添加: fno-lto\n\n# 解决zfnlm问题:\nactual argument contains too few elements for dummy argument 'zfnlm'\ncfg文件编译选项设置： -std=legacy\n\n# undefined reference to '__gcov_exit'\n-lgcov --coverage\n\n# glob.c:(.text+0x53c): undefined reference to `__alloca'\n编辑glob.c文件\n修改第54行\"==\"改为\">=\"\n# if _GNU_GLOB_INTERFACE_VERSION >= GLOB_INTERFACE_VERSION\n\n# 2006的题483在v10-sp1-2107跑起来，我干了什么？ 否则老是报错483.xalancbmk  non-zero return code (rc=254, signal=0) XML等\n1、安装统信UOS的GCC8.3.0\n2、SPEC2006的工具集重新编译，再安装\n3、清除题下面的run/build/exe\n4、执行了一次apt-get install gcc?? 不知道有没有影响\n5、放到没有中文的路径/home/gretwall/cpu2006\n6、使用普通用户greatwall执行\n\n# 416报错\n# Note: The following floating-point exceptions are signalling: IEEE_UNDERFLOW_FLAG IEEE_DENORMAL\n\n```\n\n4、测试项说明\n\n```shell\nsource shrc\n# 多核测试（8）\nrunspec -c greatwall.cfg -r 8 -n 1 -i ref -T base -I all\n选项解析：\n\t-c # 指定config/中的配置文件\n\t-r # --rate的缩写，跑rate测试，指定测试的副本数（Copies）\n\t--speed # 指定跑speed测试，和测试副本数（Copies）（默认跑speed测试）\n\t-n # 指定测试的次数\t\n\t-i（-size） # 指定测试的规模，由小到大为test/train/ref,其中test最快，适合用来验证CPU的完整性，跑分要用ref\n\t--reportable / --noreportable # 表示检测/不检测生成的二进制文件是否修改过\n\t--action=build\t# 只编译，不测试\n\t--rebuild\t# 重新编译选题的二进制文件\n\t--tune（-T） # 可选peak / base / all，默认跑all\n\t最后的参数\t# int-(int选题) / fp-(fp选题) / all-(所有选题) / 单个选题-（如483） \n```\n\n5、去除PDF报告的Invalid标记\n\n```shell\ncp CINT2006.559.ref.rsf CINT2006.559.ref.rsf.retry\nrawformat --flagsurl myfixedflags.xml --output_format pdf,raw CINT2006.559.ref.rsf.retry\n```\n\n\n\n### 2.2 CPU2017\n\n\n\n\n\n## 3 lmbench测试（用时3小时）\n\n>测试简单的系统调用时间、shell命令启动时间、系统信号处理时间、统计2p/16K的上下文切换性能、16p/64K的上下文切换性能、0K/10K文件创建时间、0K/10K文件删除时间\n\n源码包准备：\n\n```shell\nwget http://www.bitmover.com/lmbench/lmbench3.tar.gz\n```\n\n编译前的准备：\n\n```shell\ntar xvf lmbench3.tar.gz\ncd lmbench3\nmkdir SCCS\ntouch  SCCS/s.ChangeSet\n```\n\n编译并测试\n\n```she\nmake results OS=arch-linux\n```\n\n读取测试结果\n\n```shell\nmake see\n```\n\n错误：\n\n```shell\n报错: undefined reference to 'llseek'\n解决方法:\n修改src/disk.c文件\n将llseek改为lseek64\n```\n\n## 4 文件读写测试\n\n>测试硬盘内文件（10G）拷贝性能，记录时间\n\n测试步骤\n\n```shell\n# 创建10G的大文件\ndd if=/dev/zero of=big_file count=10 bs=1G\n\n# 测试拷贝时间\ntime cp big_file  big_file_bak\n```\n\n\n\n## 5 USB存储设备读写性能\n\n>测试USB存储设备读写性能（Mb/s），平均读写速度等\n\n```shell\n# 可选准备\n1.将U盘（USB3.0）插入被测试机器,假定识别设备为sdc\n2.创建vfat文件系统分区\n/dev/sdb1分区容量大于30GB\numount /dev/sdc1\nmkfs -t vfat /dev/sdc1\nmkdir /upan\nmount -t vfat /dev/sdc1 /upan\n```\n\n```shell\n# 测试写性能\ncd /upan\ndd if=/dev/zero of=./largefile bs=64k count=10000\n\n# 测试读性能\nsync && echo 3 > /proc/sys/vm/drop_caches\ndd if=./largefile of=/dev/null bs=64k\n```\n\n\n\n## 6 硬盘读写测试-IOZONE/\n\n安装步骤：\n\n```shell\n# 下载源码包\nwget http://www.iozone.org/src/current/iozone3_487.tar\n# 解压\ntar -vxf iozone3_487.tar && cd iozone3_489/src/current\n# 编译\nmake linux\n```\n\n参数说明：\n\n```shell\niozone\n    -a 全面测试，比如块大小它会自动加\n    -i N 用来选择测试项, 比如Read/Write/Random 比较常用的是0 1 2,可以指定成-i 0 -i 1 -i2.这些别的详细内容请查man\n        0=write/rewrite\n        1=read/re-read\n        2=random-read/write\n        3=Read-backwards\n        4=Re-write-record\n        5=stride-read\n        6=fwrite/re-fwrite\n        7=fread/Re-fread\n        8=random mix\n        9=pwrite/Re-pwrite\n        10=pread/Re-pread\n        11=pwritev/Re-pwritev\n    \t12=preadv/Re-preadv\n    -r block size 指定一次写入/读出的块大小\n    -s file size 指定测试文件的大小\n    -f filename 指定测试文件的名字,完成后会自动删除(这个文件必须指定你要测试的那个硬盘中)\n    -F file1 file2… 指定多线程下测试的文件名\n    \n    批量测试项:\n    -g -n 指定测试文件大小范围,最大测试文件为4G,可以这样写 -g 4G\n    -y -q 指定测试块的大小范围\n    \n    输出:\n    下面是几个日志记录的参数.好像要输出成图象进行分析，需要指定-a的测试才能输出\n    -R 产生Excel到标准输出\n    -b 指定输出到指定文件上. 比如 -Rb ttt.xls\n```\n\n> 1、测试硬盘读写性能（Mb/s），包括随机和顺序读写平均读写速度（IOzone设置块大小16M，文件大小为物理内存2倍、1倍、1/2倍三组数据）\n\n测试步骤\n\n```shell\n# 需要root权限\nsudo su\n# 块大小16M，文件大小为物理内存2倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 16g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_16G_0.xls\n# 块大小16M，文件大小为物理内存1倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 8g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_8G_0.xls\n# 块大小16M，文件大小为物理内存0.5倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 4g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_4G_0.xls\n```\n\n>2、测试数据盘（裸设备）的在块大小为512B、1MB下的读写性能（包括IOPS、带宽和响应时间）\n\n\n\n## 7 内存读写性能测试-Stream\n\n>测试单线和并发读写性能（Mb/s）\n\n测试步骤\n\n```shell\n# 安装gfortran\nsudo apt-get install gfortran\n\n# 编译stream\nmake\n\n# 测试\nstream_c 200000000   # 参数为Array大小\n```\n\n多线程测试\n\n```she\n# 单线程编译\ngcc -O3 stream.c -o stream\n# 多线程编译\ngcc -O3 -fopenmp stream.c -o stream.omp\n```\n\n## 10 操作系统综合性能测试-unixbench（用时1小时）\n\n```shell\n# 解压UnixBench工具包：\nunzip Unixbench-Kylin.zip\n# 进入Unixbench解压后的目录下\ncd UnixBench\n# 修改Makefile文件74行\nOPTON = -O3 -fomit-frame-pointer -fforce-addr -ffast-math -Wall -static -flto\n# 编译：\nsudo make clean && make\n# 清除缓存：\nsudo su\nsync\necho 3 > /proc/sys/vm/drop_caches\n# 测试单线程和多线程性能，执行命令：\nsudo ./Run -c 1 -c N\n// 其中N代表cpu核数\n```\n\n\n\n## 11 显卡性能测试-unixbench（用时约半小时）\n\n>1、测试2D显示处理性能，主要包括画点、画线、画三角形、画平行四边形、画正方形、画多边形等性能测试\n>\n>2、测试3D显示处理性能，主要包括3D的显示、色彩填充、渲染、旋转等性能测试\n\n编译Unibench\n\n```shell\n# 安装依赖\napt-get install libgl1-mesa-dev\n# 修改Makefile文件,防止编译报错\nvim UnixBench/Makefile\n# 第47行取消注释\nGRAPHIC_TESTS = defined\n# 第50行加上-lm\nGL_LIBS = -lGL -lXext -lX11 -lm\n# 第74行修改\nOPTON = -O2 -fomit-frame-pointer -fforce-addr -ffast-math -Wall\n\n# 修改Run文件\nvim UnixBench/Run\n# 第109-112行，修改可支持的最大核数，当前是8\n'system'    => { 'name' => \"System Benchmarks\", 'maxCopies' => 8 },\n'2d'        => { 'name' => \"2D Graphics Benchmarks\", 'maxCopies' => 8 },\n'3d'        => { 'name' => \"3D Graphics Benchmarks\", 'maxCopies' => 8 },\n'misc'      => { 'name' => \"Non-Index Benchmarks\", 'maxCopies' => 8 },\n```\n\n编译运行\n\n```shell\nmake clean && make -j 8\n./Run graphics\n```\n\n3D测试优化\n\n```shell\n# 创建文件10-vsync.conf\n<driconf>\n    <option name=\"vblank_mode\" value=\"0\" />\n</driconf>\n\n# 拷贝文件到指定路径\nsudo cp 10-vsync.conf  ~/.drirc\n\n# 运行测试\nvblank_mode=0 ./Run ubgears\n```\n\n## 11 显卡测试-Glmark2\n\n安装\n\n```shell\nsudo ./waf configure --with-flavors=x11-gl\nsudo ./waf build -j 4\nsudo ./waf install\n```\n\n测试\n\n```shell\nglmark2\n```\n\n## 12 显卡测试-Glxgears\n\n安装\n\n```she\nsudo apt-get install mesa-utils\n```\n\n测试\n\n```shell\n# 终端执行\nglxgears\n```\n\n## 12 网络性能测试-Netperf\n\n>测试网络传输速率、网络吞吐率、网络响应时间等，包括TCP、UDP流吞吐速率等","source":"_posts/02_测试/01_POC测试工具使用指南.md","raw":"---\ntitle: 国产化POC测试工具使用指南\ndate: 2022-07-06 11:19:52\ncategories:\n- 测试\n- 信创POC测试\ntags:\n- 工作\n---\n\n# 一、性能测试\n\n>测试台式机/笔记本的软硬件性能\n\n## 1 开机时间\n\n> 测试整机启动的时间（从按下电源开始计时，到出现登录界面计时结束）\n\n测试步骤\n\n```shell\n手机计时\n从按下电源的一刻到进入系统的时间\n```\n\n\n\n## 2 CPU性能测试（整型/浮点型）\n\n>测试CPU整型计算性能，包括单线程基准值、满线程基准值\n>\n>测试CPU浮点计算性能，包括单线程基准值、满线程基准值\n\n### 2.1 CPU2006\n\n>测试环境:\n>\n>​\tCPU：飞腾D2000\n>\n>​\t内存：16G\n>\n>​\t系统：麒麟V10-SP1-2107 桌面操作系统\n\n1、准备\n\n```shell\n测试工具包：\nd2000-spec2006test.tar.gz\n```\n\n2、测试步骤\n\n```shell\n1、把下载好的d2000-spec2006test.tar.gz测试包放到根目录下（建议整机内存≥16GB，否则会影响测试跑分）\n#如果不知道如何放到根目录下，可以先把d2000-spec2006test.tar.gz这个包放到桌面，然后点击鼠标右键打开终端，sudo su ，然后输入密码进入root权限，然后输入cp -r d2000-spec2006test.tar.gz /  ，这样就复制到了根目录下。 \n2、cd / ，进入根目录，sudo su ，然后输入密码，进入root权限。\n3、解压，tar -xvf d2000-spec2006test.tar.gz\n4、更改权限，chmod -R 777 cpu2006-1.2\n5、进入spec2006目录，cd cpu2006-1.2\n6、执行脚本，bash run.sh   #配置依赖环境，！！需要联网，会自动下载部分依赖！！\n7、source /etc/profile  #更新profile文件,此处一定要更新\n8、source ./shrc    #配置环境变量\t\n9、ulimit -s unlimited #内存分配无限制，大于或者等于16G内存的机器可以加此命令，如果是8G内存的机器不要运行此命令，会因内存不够用影响整型测试的429测试项\n10、echo 3 > /proc/sys/vm/drop_caches   #执行测试前，建议清一下缓存\n11、gcc -v   #测试前查看一下gcc的版本是否为GCC931,若不是GCC931，输入source /etc/profile， 再gcc -v查看版本，是GCC931即可执行第12步启动测试\n12、bash d2000-test.sh  #执行8核、单核的整形和浮点测试\n```\n\n3、结果查看\n\n```shell\nPDF测试结果存放在results文件夹\n```\n\n4、编译问题处理（如遇到编译问题，可参考）\n\n```shell\n# 450报错：\n# mpsinput.cc: In member function 'bool soplex::MPSInput::readLine()': mpsinput.cc:75:52: error: no match for 'operator==' (operand types are 'std::basic_istream<char>::__istream_type' {aka 'std::basic_istream<char>'} and 'int')\ng++ -std=c++03\n\n# lto1 fatal error bytecode stream generated with lto version \n编译选项添加: fno-lto\n\n# 解决zfnlm问题:\nactual argument contains too few elements for dummy argument 'zfnlm'\ncfg文件编译选项设置： -std=legacy\n\n# undefined reference to '__gcov_exit'\n-lgcov --coverage\n\n# glob.c:(.text+0x53c): undefined reference to `__alloca'\n编辑glob.c文件\n修改第54行\"==\"改为\">=\"\n# if _GNU_GLOB_INTERFACE_VERSION >= GLOB_INTERFACE_VERSION\n\n# 2006的题483在v10-sp1-2107跑起来，我干了什么？ 否则老是报错483.xalancbmk  non-zero return code (rc=254, signal=0) XML等\n1、安装统信UOS的GCC8.3.0\n2、SPEC2006的工具集重新编译，再安装\n3、清除题下面的run/build/exe\n4、执行了一次apt-get install gcc?? 不知道有没有影响\n5、放到没有中文的路径/home/gretwall/cpu2006\n6、使用普通用户greatwall执行\n\n# 416报错\n# Note: The following floating-point exceptions are signalling: IEEE_UNDERFLOW_FLAG IEEE_DENORMAL\n\n```\n\n4、测试项说明\n\n```shell\nsource shrc\n# 多核测试（8）\nrunspec -c greatwall.cfg -r 8 -n 1 -i ref -T base -I all\n选项解析：\n\t-c # 指定config/中的配置文件\n\t-r # --rate的缩写，跑rate测试，指定测试的副本数（Copies）\n\t--speed # 指定跑speed测试，和测试副本数（Copies）（默认跑speed测试）\n\t-n # 指定测试的次数\t\n\t-i（-size） # 指定测试的规模，由小到大为test/train/ref,其中test最快，适合用来验证CPU的完整性，跑分要用ref\n\t--reportable / --noreportable # 表示检测/不检测生成的二进制文件是否修改过\n\t--action=build\t# 只编译，不测试\n\t--rebuild\t# 重新编译选题的二进制文件\n\t--tune（-T） # 可选peak / base / all，默认跑all\n\t最后的参数\t# int-(int选题) / fp-(fp选题) / all-(所有选题) / 单个选题-（如483） \n```\n\n5、去除PDF报告的Invalid标记\n\n```shell\ncp CINT2006.559.ref.rsf CINT2006.559.ref.rsf.retry\nrawformat --flagsurl myfixedflags.xml --output_format pdf,raw CINT2006.559.ref.rsf.retry\n```\n\n\n\n### 2.2 CPU2017\n\n\n\n\n\n## 3 lmbench测试（用时3小时）\n\n>测试简单的系统调用时间、shell命令启动时间、系统信号处理时间、统计2p/16K的上下文切换性能、16p/64K的上下文切换性能、0K/10K文件创建时间、0K/10K文件删除时间\n\n源码包准备：\n\n```shell\nwget http://www.bitmover.com/lmbench/lmbench3.tar.gz\n```\n\n编译前的准备：\n\n```shell\ntar xvf lmbench3.tar.gz\ncd lmbench3\nmkdir SCCS\ntouch  SCCS/s.ChangeSet\n```\n\n编译并测试\n\n```she\nmake results OS=arch-linux\n```\n\n读取测试结果\n\n```shell\nmake see\n```\n\n错误：\n\n```shell\n报错: undefined reference to 'llseek'\n解决方法:\n修改src/disk.c文件\n将llseek改为lseek64\n```\n\n## 4 文件读写测试\n\n>测试硬盘内文件（10G）拷贝性能，记录时间\n\n测试步骤\n\n```shell\n# 创建10G的大文件\ndd if=/dev/zero of=big_file count=10 bs=1G\n\n# 测试拷贝时间\ntime cp big_file  big_file_bak\n```\n\n\n\n## 5 USB存储设备读写性能\n\n>测试USB存储设备读写性能（Mb/s），平均读写速度等\n\n```shell\n# 可选准备\n1.将U盘（USB3.0）插入被测试机器,假定识别设备为sdc\n2.创建vfat文件系统分区\n/dev/sdb1分区容量大于30GB\numount /dev/sdc1\nmkfs -t vfat /dev/sdc1\nmkdir /upan\nmount -t vfat /dev/sdc1 /upan\n```\n\n```shell\n# 测试写性能\ncd /upan\ndd if=/dev/zero of=./largefile bs=64k count=10000\n\n# 测试读性能\nsync && echo 3 > /proc/sys/vm/drop_caches\ndd if=./largefile of=/dev/null bs=64k\n```\n\n\n\n## 6 硬盘读写测试-IOZONE/\n\n安装步骤：\n\n```shell\n# 下载源码包\nwget http://www.iozone.org/src/current/iozone3_487.tar\n# 解压\ntar -vxf iozone3_487.tar && cd iozone3_489/src/current\n# 编译\nmake linux\n```\n\n参数说明：\n\n```shell\niozone\n    -a 全面测试，比如块大小它会自动加\n    -i N 用来选择测试项, 比如Read/Write/Random 比较常用的是0 1 2,可以指定成-i 0 -i 1 -i2.这些别的详细内容请查man\n        0=write/rewrite\n        1=read/re-read\n        2=random-read/write\n        3=Read-backwards\n        4=Re-write-record\n        5=stride-read\n        6=fwrite/re-fwrite\n        7=fread/Re-fread\n        8=random mix\n        9=pwrite/Re-pwrite\n        10=pread/Re-pread\n        11=pwritev/Re-pwritev\n    \t12=preadv/Re-preadv\n    -r block size 指定一次写入/读出的块大小\n    -s file size 指定测试文件的大小\n    -f filename 指定测试文件的名字,完成后会自动删除(这个文件必须指定你要测试的那个硬盘中)\n    -F file1 file2… 指定多线程下测试的文件名\n    \n    批量测试项:\n    -g -n 指定测试文件大小范围,最大测试文件为4G,可以这样写 -g 4G\n    -y -q 指定测试块的大小范围\n    \n    输出:\n    下面是几个日志记录的参数.好像要输出成图象进行分析，需要指定-a的测试才能输出\n    -R 产生Excel到标准输出\n    -b 指定输出到指定文件上. 比如 -Rb ttt.xls\n```\n\n> 1、测试硬盘读写性能（Mb/s），包括随机和顺序读写平均读写速度（IOzone设置块大小16M，文件大小为物理内存2倍、1倍、1/2倍三组数据）\n\n测试步骤\n\n```shell\n# 需要root权限\nsudo su\n# 块大小16M，文件大小为物理内存2倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 16g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_16G_0.xls\n# 块大小16M，文件大小为物理内存1倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 8g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_8G_0.xls\n# 块大小16M，文件大小为物理内存0.5倍（测试机器内存为8G的情况下）\n./iozone -i 0 -i 1 -i 2 -s 4g -r 16m -f /iozone.tmpfile -Rb ./report/iotest_4G_0.xls\n```\n\n>2、测试数据盘（裸设备）的在块大小为512B、1MB下的读写性能（包括IOPS、带宽和响应时间）\n\n\n\n## 7 内存读写性能测试-Stream\n\n>测试单线和并发读写性能（Mb/s）\n\n测试步骤\n\n```shell\n# 安装gfortran\nsudo apt-get install gfortran\n\n# 编译stream\nmake\n\n# 测试\nstream_c 200000000   # 参数为Array大小\n```\n\n多线程测试\n\n```she\n# 单线程编译\ngcc -O3 stream.c -o stream\n# 多线程编译\ngcc -O3 -fopenmp stream.c -o stream.omp\n```\n\n## 10 操作系统综合性能测试-unixbench（用时1小时）\n\n```shell\n# 解压UnixBench工具包：\nunzip Unixbench-Kylin.zip\n# 进入Unixbench解压后的目录下\ncd UnixBench\n# 修改Makefile文件74行\nOPTON = -O3 -fomit-frame-pointer -fforce-addr -ffast-math -Wall -static -flto\n# 编译：\nsudo make clean && make\n# 清除缓存：\nsudo su\nsync\necho 3 > /proc/sys/vm/drop_caches\n# 测试单线程和多线程性能，执行命令：\nsudo ./Run -c 1 -c N\n// 其中N代表cpu核数\n```\n\n\n\n## 11 显卡性能测试-unixbench（用时约半小时）\n\n>1、测试2D显示处理性能，主要包括画点、画线、画三角形、画平行四边形、画正方形、画多边形等性能测试\n>\n>2、测试3D显示处理性能，主要包括3D的显示、色彩填充、渲染、旋转等性能测试\n\n编译Unibench\n\n```shell\n# 安装依赖\napt-get install libgl1-mesa-dev\n# 修改Makefile文件,防止编译报错\nvim UnixBench/Makefile\n# 第47行取消注释\nGRAPHIC_TESTS = defined\n# 第50行加上-lm\nGL_LIBS = -lGL -lXext -lX11 -lm\n# 第74行修改\nOPTON = -O2 -fomit-frame-pointer -fforce-addr -ffast-math -Wall\n\n# 修改Run文件\nvim UnixBench/Run\n# 第109-112行，修改可支持的最大核数，当前是8\n'system'    => { 'name' => \"System Benchmarks\", 'maxCopies' => 8 },\n'2d'        => { 'name' => \"2D Graphics Benchmarks\", 'maxCopies' => 8 },\n'3d'        => { 'name' => \"3D Graphics Benchmarks\", 'maxCopies' => 8 },\n'misc'      => { 'name' => \"Non-Index Benchmarks\", 'maxCopies' => 8 },\n```\n\n编译运行\n\n```shell\nmake clean && make -j 8\n./Run graphics\n```\n\n3D测试优化\n\n```shell\n# 创建文件10-vsync.conf\n<driconf>\n    <option name=\"vblank_mode\" value=\"0\" />\n</driconf>\n\n# 拷贝文件到指定路径\nsudo cp 10-vsync.conf  ~/.drirc\n\n# 运行测试\nvblank_mode=0 ./Run ubgears\n```\n\n## 11 显卡测试-Glmark2\n\n安装\n\n```shell\nsudo ./waf configure --with-flavors=x11-gl\nsudo ./waf build -j 4\nsudo ./waf install\n```\n\n测试\n\n```shell\nglmark2\n```\n\n## 12 显卡测试-Glxgears\n\n安装\n\n```she\nsudo apt-get install mesa-utils\n```\n\n测试\n\n```shell\n# 终端执行\nglxgears\n```\n\n## 12 网络性能测试-Netperf\n\n>测试网络传输速率、网络吞吐率、网络响应时间等，包括TCP、UDP流吞吐速率等","slug":"02_测试/01_POC测试工具使用指南","published":1,"updated":"2022-07-07T02:27:10.604Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k050006a8v7b5zg9onp","content":"<h1 id=\"一、性能测试\"><a href=\"#一、性能测试\" class=\"headerlink\" title=\"一、性能测试\"></a>一、性能测试</h1><blockquote>\n<p>测试台式机&#x2F;笔记本的软硬件性能</p>\n</blockquote>\n<h2 id=\"1-开机时间\"><a href=\"#1-开机时间\" class=\"headerlink\" title=\"1 开机时间\"></a>1 开机时间</h2><blockquote>\n<p>测试整机启动的时间（从按下电源开始计时，到出现登录界面计时结束）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">手机计时\n从按下电源的一刻到进入系统的时间<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"2-CPU性能测试（整型-x2F-浮点型）\"><a href=\"#2-CPU性能测试（整型-x2F-浮点型）\" class=\"headerlink\" title=\"2 CPU性能测试（整型&#x2F;浮点型）\"></a>2 CPU性能测试（整型&#x2F;浮点型）</h2><blockquote>\n<p>测试CPU整型计算性能，包括单线程基准值、满线程基准值</p>\n<p>测试CPU浮点计算性能，包括单线程基准值、满线程基准值</p>\n</blockquote>\n<h3 id=\"2-1-CPU2006\"><a href=\"#2-1-CPU2006\" class=\"headerlink\" title=\"2.1 CPU2006\"></a>2.1 CPU2006</h3><blockquote>\n<p>测试环境:</p>\n<p>​\tCPU：飞腾D2000</p>\n<p>​\t内存：16G</p>\n<p>​\t系统：麒麟V10-SP1-2107 桌面操作系统</p>\n</blockquote>\n<p>1、准备</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">测试工具包：\nd2000-spec2006test.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>2、测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、把下载好的d2000-spec2006test.tar.gz测试包放到根目录下（建议整机内存≥16GB，否则会影响测试跑分）\n#如果不知道如何放到根目录下，可以先把d2000-spec2006test.tar.gz这个包放到桌面，然后点击鼠标右键打开终端，sudo su ，然后输入密码进入root权限，然后输入cp -r d2000-spec2006test.tar.gz &#x2F;  ，这样就复制到了根目录下。 \n2、cd &#x2F; ，进入根目录，sudo su ，然后输入密码，进入root权限。\n3、解压，tar -xvf d2000-spec2006test.tar.gz\n4、更改权限，chmod -R 777 cpu2006-1.2\n5、进入spec2006目录，cd cpu2006-1.2\n6、执行脚本，bash run.sh   #配置依赖环境，！！需要联网，会自动下载部分依赖！！\n7、source &#x2F;etc&#x2F;profile  #更新profile文件,此处一定要更新\n8、source .&#x2F;shrc    #配置环境变量\t\n9、ulimit -s unlimited #内存分配无限制，大于或者等于16G内存的机器可以加此命令，如果是8G内存的机器不要运行此命令，会因内存不够用影响整型测试的429测试项\n10、echo 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches   #执行测试前，建议清一下缓存\n11、gcc -v   #测试前查看一下gcc的版本是否为GCC931,若不是GCC931，输入source &#x2F;etc&#x2F;profile， 再gcc -v查看版本，是GCC931即可执行第12步启动测试\n12、bash d2000-test.sh  #执行8核、单核的整形和浮点测试<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、结果查看</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">PDF测试结果存放在results文件夹<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>4、编译问题处理（如遇到编译问题，可参考）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 450报错：\n# mpsinput.cc: In member function &#39;bool soplex::MPSInput::readLine()&#39;: mpsinput.cc:75:52: error: no match for &#39;operator&#x3D;&#x3D;&#39; (operand types are &#39;std::basic_istream&lt;char&gt;::__istream_type&#39; &#123;aka &#39;std::basic_istream&lt;char&gt;&#39;&#125; and &#39;int&#39;)\ng++ -std&#x3D;c++03\n\n# lto1 fatal error bytecode stream generated with lto version \n编译选项添加: fno-lto\n\n# 解决zfnlm问题:\nactual argument contains too few elements for dummy argument &#39;zfnlm&#39;\ncfg文件编译选项设置： -std&#x3D;legacy\n\n# undefined reference to &#39;__gcov_exit&#39;\n-lgcov --coverage\n\n# glob.c:(.text+0x53c): undefined reference to &#96;__alloca&#39;\n编辑glob.c文件\n修改第54行&quot;&#x3D;&#x3D;&quot;改为&quot;&gt;&#x3D;&quot;\n# if _GNU_GLOB_INTERFACE_VERSION &gt;&#x3D; GLOB_INTERFACE_VERSION\n\n# 2006的题483在v10-sp1-2107跑起来，我干了什么？ 否则老是报错483.xalancbmk  non-zero return code (rc&#x3D;254, signal&#x3D;0) XML等\n1、安装统信UOS的GCC8.3.0\n2、SPEC2006的工具集重新编译，再安装\n3、清除题下面的run&#x2F;build&#x2F;exe\n4、执行了一次apt-get install gcc?? 不知道有没有影响\n5、放到没有中文的路径&#x2F;home&#x2F;gretwall&#x2F;cpu2006\n6、使用普通用户greatwall执行\n\n# 416报错\n# Note: The following floating-point exceptions are signalling: IEEE_UNDERFLOW_FLAG IEEE_DENORMAL\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、测试项说明</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\n# 多核测试（8）\nrunspec -c greatwall.cfg -r 8 -n 1 -i ref -T base -I all\n选项解析：\n\t-c # 指定config&#x2F;中的配置文件\n\t-r # --rate的缩写，跑rate测试，指定测试的副本数（Copies）\n\t--speed # 指定跑speed测试，和测试副本数（Copies）（默认跑speed测试）\n\t-n # 指定测试的次数\t\n\t-i（-size） # 指定测试的规模，由小到大为test&#x2F;train&#x2F;ref,其中test最快，适合用来验证CPU的完整性，跑分要用ref\n\t--reportable &#x2F; --noreportable # 表示检测&#x2F;不检测生成的二进制文件是否修改过\n\t--action&#x3D;build\t# 只编译，不测试\n\t--rebuild\t# 重新编译选题的二进制文件\n\t--tune（-T） # 可选peak &#x2F; base &#x2F; all，默认跑all\n\t最后的参数\t# int-(int选题) &#x2F; fp-(fp选题) &#x2F; all-(所有选题) &#x2F; 单个选题-（如483） <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、去除PDF报告的Invalid标记</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cp CINT2006.559.ref.rsf CINT2006.559.ref.rsf.retry\nrawformat --flagsurl myfixedflags.xml --output_format pdf,raw CINT2006.559.ref.rsf.retry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"2-2-CPU2017\"><a href=\"#2-2-CPU2017\" class=\"headerlink\" title=\"2.2 CPU2017\"></a>2.2 CPU2017</h3><h2 id=\"3-lmbench测试（用时3小时）\"><a href=\"#3-lmbench测试（用时3小时）\" class=\"headerlink\" title=\"3 lmbench测试（用时3小时）\"></a>3 lmbench测试（用时3小时）</h2><blockquote>\n<p>测试简单的系统调用时间、shell命令启动时间、系统信号处理时间、统计2p&#x2F;16K的上下文切换性能、16p&#x2F;64K的上下文切换性能、0K&#x2F;10K文件创建时间、0K&#x2F;10K文件删除时间</p>\n</blockquote>\n<p>源码包准备：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget http:&#x2F;&#x2F;www.bitmover.com&#x2F;lmbench&#x2F;lmbench3.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>编译前的准备：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar xvf lmbench3.tar.gz\ncd lmbench3\nmkdir SCCS\ntouch  SCCS&#x2F;s.ChangeSet<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编译并测试</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">make results OS&#x3D;arch-linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>读取测试结果</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make see<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>错误：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">报错: undefined reference to &#39;llseek&#39;\n解决方法:\n修改src&#x2F;disk.c文件\n将llseek改为lseek64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"4-文件读写测试\"><a href=\"#4-文件读写测试\" class=\"headerlink\" title=\"4 文件读写测试\"></a>4 文件读写测试</h2><blockquote>\n<p>测试硬盘内文件（10G）拷贝性能，记录时间</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建10G的大文件\ndd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;big_file count&#x3D;10 bs&#x3D;1G\n\n# 测试拷贝时间\ntime cp big_file  big_file_bak<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"5-USB存储设备读写性能\"><a href=\"#5-USB存储设备读写性能\" class=\"headerlink\" title=\"5 USB存储设备读写性能\"></a>5 USB存储设备读写性能</h2><blockquote>\n<p>测试USB存储设备读写性能（Mb&#x2F;s），平均读写速度等</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 可选准备\n1.将U盘（USB3.0）插入被测试机器,假定识别设备为sdc\n2.创建vfat文件系统分区\n&#x2F;dev&#x2F;sdb1分区容量大于30GB\numount &#x2F;dev&#x2F;sdc1\nmkfs -t vfat &#x2F;dev&#x2F;sdc1\nmkdir &#x2F;upan\nmount -t vfat &#x2F;dev&#x2F;sdc1 &#x2F;upan<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 测试写性能\ncd &#x2F;upan\ndd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;largefile bs&#x3D;64k count&#x3D;10000\n\n# 测试读性能\nsync &amp;&amp; echo 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches\ndd if&#x3D;.&#x2F;largefile of&#x3D;&#x2F;dev&#x2F;null bs&#x3D;64k<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"6-硬盘读写测试-IOZONE-x2F\"><a href=\"#6-硬盘读写测试-IOZONE-x2F\" class=\"headerlink\" title=\"6 硬盘读写测试-IOZONE&#x2F;\"></a>6 硬盘读写测试-IOZONE&#x2F;</h2><p>安装步骤：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 下载源码包\nwget http:&#x2F;&#x2F;www.iozone.org&#x2F;src&#x2F;current&#x2F;iozone3_487.tar\n# 解压\ntar -vxf iozone3_487.tar &amp;&amp; cd iozone3_489&#x2F;src&#x2F;current\n# 编译\nmake linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>参数说明：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">iozone\n    -a 全面测试，比如块大小它会自动加\n    -i N 用来选择测试项, 比如Read&#x2F;Write&#x2F;Random 比较常用的是0 1 2,可以指定成-i 0 -i 1 -i2.这些别的详细内容请查man\n        0&#x3D;write&#x2F;rewrite\n        1&#x3D;read&#x2F;re-read\n        2&#x3D;random-read&#x2F;write\n        3&#x3D;Read-backwards\n        4&#x3D;Re-write-record\n        5&#x3D;stride-read\n        6&#x3D;fwrite&#x2F;re-fwrite\n        7&#x3D;fread&#x2F;Re-fread\n        8&#x3D;random mix\n        9&#x3D;pwrite&#x2F;Re-pwrite\n        10&#x3D;pread&#x2F;Re-pread\n        11&#x3D;pwritev&#x2F;Re-pwritev\n    \t12&#x3D;preadv&#x2F;Re-preadv\n    -r block size 指定一次写入&#x2F;读出的块大小\n    -s file size 指定测试文件的大小\n    -f filename 指定测试文件的名字,完成后会自动删除(这个文件必须指定你要测试的那个硬盘中)\n    -F file1 file2… 指定多线程下测试的文件名\n    \n    批量测试项:\n    -g -n 指定测试文件大小范围,最大测试文件为4G,可以这样写 -g 4G\n    -y -q 指定测试块的大小范围\n    \n    输出:\n    下面是几个日志记录的参数.好像要输出成图象进行分析，需要指定-a的测试才能输出\n    -R 产生Excel到标准输出\n    -b 指定输出到指定文件上. 比如 -Rb ttt.xls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>1、测试硬盘读写性能（Mb&#x2F;s），包括随机和顺序读写平均读写速度（IOzone设置块大小16M，文件大小为物理内存2倍、1倍、1&#x2F;2倍三组数据）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 需要root权限\nsudo su\n# 块大小16M，文件大小为物理内存2倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 16g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_16G_0.xls\n# 块大小16M，文件大小为物理内存1倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 8g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_8G_0.xls\n# 块大小16M，文件大小为物理内存0.5倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 4g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_4G_0.xls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>2、测试数据盘（裸设备）的在块大小为512B、1MB下的读写性能（包括IOPS、带宽和响应时间）</p>\n</blockquote>\n<h2 id=\"7-内存读写性能测试-Stream\"><a href=\"#7-内存读写性能测试-Stream\" class=\"headerlink\" title=\"7 内存读写性能测试-Stream\"></a>7 内存读写性能测试-Stream</h2><blockquote>\n<p>测试单线和并发读写性能（Mb&#x2F;s）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装gfortran\nsudo apt-get install gfortran\n\n# 编译stream\nmake\n\n# 测试\nstream_c 200000000   # 参数为Array大小<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>多线程测试</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\"># 单线程编译\ngcc -O3 stream.c -o stream\n# 多线程编译\ngcc -O3 -fopenmp stream.c -o stream.omp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"10-操作系统综合性能测试-unixbench（用时1小时）\"><a href=\"#10-操作系统综合性能测试-unixbench（用时1小时）\" class=\"headerlink\" title=\"10 操作系统综合性能测试-unixbench（用时1小时）\"></a>10 操作系统综合性能测试-unixbench（用时1小时）</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 解压UnixBench工具包：\nunzip Unixbench-Kylin.zip\n# 进入Unixbench解压后的目录下\ncd UnixBench\n# 修改Makefile文件74行\nOPTON &#x3D; -O3 -fomit-frame-pointer -fforce-addr -ffast-math -Wall -static -flto\n# 编译：\nsudo make clean &amp;&amp; make\n# 清除缓存：\nsudo su\nsync\necho 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches\n# 测试单线程和多线程性能，执行命令：\nsudo .&#x2F;Run -c 1 -c N\n&#x2F;&#x2F; 其中N代表cpu核数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"11-显卡性能测试-unixbench（用时约半小时）\"><a href=\"#11-显卡性能测试-unixbench（用时约半小时）\" class=\"headerlink\" title=\"11 显卡性能测试-unixbench（用时约半小时）\"></a>11 显卡性能测试-unixbench（用时约半小时）</h2><blockquote>\n<p>1、测试2D显示处理性能，主要包括画点、画线、画三角形、画平行四边形、画正方形、画多边形等性能测试</p>\n<p>2、测试3D显示处理性能，主要包括3D的显示、色彩填充、渲染、旋转等性能测试</p>\n</blockquote>\n<p>编译Unibench</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装依赖\napt-get install libgl1-mesa-dev\n# 修改Makefile文件,防止编译报错\nvim UnixBench&#x2F;Makefile\n# 第47行取消注释\nGRAPHIC_TESTS &#x3D; defined\n# 第50行加上-lm\nGL_LIBS &#x3D; -lGL -lXext -lX11 -lm\n# 第74行修改\nOPTON &#x3D; -O2 -fomit-frame-pointer -fforce-addr -ffast-math -Wall\n\n# 修改Run文件\nvim UnixBench&#x2F;Run\n# 第109-112行，修改可支持的最大核数，当前是8\n&#39;system&#39;    &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;System Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;2d&#39;        &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;2D Graphics Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;3d&#39;        &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;3D Graphics Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;misc&#39;      &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;Non-Index Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编译运行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make clean &amp;&amp; make -j 8\n.&#x2F;Run graphics<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3D测试优化</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建文件10-vsync.conf\n&lt;driconf&gt;\n    &lt;option name&#x3D;&quot;vblank_mode&quot; value&#x3D;&quot;0&quot; &#x2F;&gt;\n&lt;&#x2F;driconf&gt;\n\n# 拷贝文件到指定路径\nsudo cp 10-vsync.conf  ~&#x2F;.drirc\n\n# 运行测试\nvblank_mode&#x3D;0 .&#x2F;Run ubgears<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"11-显卡测试-Glmark2\"><a href=\"#11-显卡测试-Glmark2\" class=\"headerlink\" title=\"11 显卡测试-Glmark2\"></a>11 显卡测试-Glmark2</h2><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo .&#x2F;waf configure --with-flavors&#x3D;x11-gl\nsudo .&#x2F;waf build -j 4\nsudo .&#x2F;waf install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">glmark2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"12-显卡测试-Glxgears\"><a href=\"#12-显卡测试-Glxgears\" class=\"headerlink\" title=\"12 显卡测试-Glxgears\"></a>12 显卡测试-Glxgears</h2><p>安装</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">sudo apt-get install mesa-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 终端执行\nglxgears<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"12-网络性能测试-Netperf\"><a href=\"#12-网络性能测试-Netperf\" class=\"headerlink\" title=\"12 网络性能测试-Netperf\"></a>12 网络性能测试-Netperf</h2><blockquote>\n<p>测试网络传输速率、网络吞吐率、网络响应时间等，包括TCP、UDP流吞吐速率等</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"一、性能测试\"><a href=\"#一、性能测试\" class=\"headerlink\" title=\"一、性能测试\"></a>一、性能测试</h1><blockquote>\n<p>测试台式机&#x2F;笔记本的软硬件性能</p>\n</blockquote>\n<h2 id=\"1-开机时间\"><a href=\"#1-开机时间\" class=\"headerlink\" title=\"1 开机时间\"></a>1 开机时间</h2><blockquote>\n<p>测试整机启动的时间（从按下电源开始计时，到出现登录界面计时结束）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">手机计时\n从按下电源的一刻到进入系统的时间<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"2-CPU性能测试（整型-x2F-浮点型）\"><a href=\"#2-CPU性能测试（整型-x2F-浮点型）\" class=\"headerlink\" title=\"2 CPU性能测试（整型&#x2F;浮点型）\"></a>2 CPU性能测试（整型&#x2F;浮点型）</h2><blockquote>\n<p>测试CPU整型计算性能，包括单线程基准值、满线程基准值</p>\n<p>测试CPU浮点计算性能，包括单线程基准值、满线程基准值</p>\n</blockquote>\n<h3 id=\"2-1-CPU2006\"><a href=\"#2-1-CPU2006\" class=\"headerlink\" title=\"2.1 CPU2006\"></a>2.1 CPU2006</h3><blockquote>\n<p>测试环境:</p>\n<p>​\tCPU：飞腾D2000</p>\n<p>​\t内存：16G</p>\n<p>​\t系统：麒麟V10-SP1-2107 桌面操作系统</p>\n</blockquote>\n<p>1、准备</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">测试工具包：\nd2000-spec2006test.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>2、测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、把下载好的d2000-spec2006test.tar.gz测试包放到根目录下（建议整机内存≥16GB，否则会影响测试跑分）\n#如果不知道如何放到根目录下，可以先把d2000-spec2006test.tar.gz这个包放到桌面，然后点击鼠标右键打开终端，sudo su ，然后输入密码进入root权限，然后输入cp -r d2000-spec2006test.tar.gz &#x2F;  ，这样就复制到了根目录下。 \n2、cd &#x2F; ，进入根目录，sudo su ，然后输入密码，进入root权限。\n3、解压，tar -xvf d2000-spec2006test.tar.gz\n4、更改权限，chmod -R 777 cpu2006-1.2\n5、进入spec2006目录，cd cpu2006-1.2\n6、执行脚本，bash run.sh   #配置依赖环境，！！需要联网，会自动下载部分依赖！！\n7、source &#x2F;etc&#x2F;profile  #更新profile文件,此处一定要更新\n8、source .&#x2F;shrc    #配置环境变量\t\n9、ulimit -s unlimited #内存分配无限制，大于或者等于16G内存的机器可以加此命令，如果是8G内存的机器不要运行此命令，会因内存不够用影响整型测试的429测试项\n10、echo 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches   #执行测试前，建议清一下缓存\n11、gcc -v   #测试前查看一下gcc的版本是否为GCC931,若不是GCC931，输入source &#x2F;etc&#x2F;profile， 再gcc -v查看版本，是GCC931即可执行第12步启动测试\n12、bash d2000-test.sh  #执行8核、单核的整形和浮点测试<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、结果查看</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">PDF测试结果存放在results文件夹<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>4、编译问题处理（如遇到编译问题，可参考）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 450报错：\n# mpsinput.cc: In member function &#39;bool soplex::MPSInput::readLine()&#39;: mpsinput.cc:75:52: error: no match for &#39;operator&#x3D;&#x3D;&#39; (operand types are &#39;std::basic_istream&lt;char&gt;::__istream_type&#39; &#123;aka &#39;std::basic_istream&lt;char&gt;&#39;&#125; and &#39;int&#39;)\ng++ -std&#x3D;c++03\n\n# lto1 fatal error bytecode stream generated with lto version \n编译选项添加: fno-lto\n\n# 解决zfnlm问题:\nactual argument contains too few elements for dummy argument &#39;zfnlm&#39;\ncfg文件编译选项设置： -std&#x3D;legacy\n\n# undefined reference to &#39;__gcov_exit&#39;\n-lgcov --coverage\n\n# glob.c:(.text+0x53c): undefined reference to &#96;__alloca&#39;\n编辑glob.c文件\n修改第54行&quot;&#x3D;&#x3D;&quot;改为&quot;&gt;&#x3D;&quot;\n# if _GNU_GLOB_INTERFACE_VERSION &gt;&#x3D; GLOB_INTERFACE_VERSION\n\n# 2006的题483在v10-sp1-2107跑起来，我干了什么？ 否则老是报错483.xalancbmk  non-zero return code (rc&#x3D;254, signal&#x3D;0) XML等\n1、安装统信UOS的GCC8.3.0\n2、SPEC2006的工具集重新编译，再安装\n3、清除题下面的run&#x2F;build&#x2F;exe\n4、执行了一次apt-get install gcc?? 不知道有没有影响\n5、放到没有中文的路径&#x2F;home&#x2F;gretwall&#x2F;cpu2006\n6、使用普通用户greatwall执行\n\n# 416报错\n# Note: The following floating-point exceptions are signalling: IEEE_UNDERFLOW_FLAG IEEE_DENORMAL\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、测试项说明</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\n# 多核测试（8）\nrunspec -c greatwall.cfg -r 8 -n 1 -i ref -T base -I all\n选项解析：\n\t-c # 指定config&#x2F;中的配置文件\n\t-r # --rate的缩写，跑rate测试，指定测试的副本数（Copies）\n\t--speed # 指定跑speed测试，和测试副本数（Copies）（默认跑speed测试）\n\t-n # 指定测试的次数\t\n\t-i（-size） # 指定测试的规模，由小到大为test&#x2F;train&#x2F;ref,其中test最快，适合用来验证CPU的完整性，跑分要用ref\n\t--reportable &#x2F; --noreportable # 表示检测&#x2F;不检测生成的二进制文件是否修改过\n\t--action&#x3D;build\t# 只编译，不测试\n\t--rebuild\t# 重新编译选题的二进制文件\n\t--tune（-T） # 可选peak &#x2F; base &#x2F; all，默认跑all\n\t最后的参数\t# int-(int选题) &#x2F; fp-(fp选题) &#x2F; all-(所有选题) &#x2F; 单个选题-（如483） <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、去除PDF报告的Invalid标记</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cp CINT2006.559.ref.rsf CINT2006.559.ref.rsf.retry\nrawformat --flagsurl myfixedflags.xml --output_format pdf,raw CINT2006.559.ref.rsf.retry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"2-2-CPU2017\"><a href=\"#2-2-CPU2017\" class=\"headerlink\" title=\"2.2 CPU2017\"></a>2.2 CPU2017</h3><h2 id=\"3-lmbench测试（用时3小时）\"><a href=\"#3-lmbench测试（用时3小时）\" class=\"headerlink\" title=\"3 lmbench测试（用时3小时）\"></a>3 lmbench测试（用时3小时）</h2><blockquote>\n<p>测试简单的系统调用时间、shell命令启动时间、系统信号处理时间、统计2p&#x2F;16K的上下文切换性能、16p&#x2F;64K的上下文切换性能、0K&#x2F;10K文件创建时间、0K&#x2F;10K文件删除时间</p>\n</blockquote>\n<p>源码包准备：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget http:&#x2F;&#x2F;www.bitmover.com&#x2F;lmbench&#x2F;lmbench3.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>编译前的准备：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar xvf lmbench3.tar.gz\ncd lmbench3\nmkdir SCCS\ntouch  SCCS&#x2F;s.ChangeSet<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编译并测试</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">make results OS&#x3D;arch-linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>读取测试结果</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make see<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>错误：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">报错: undefined reference to &#39;llseek&#39;\n解决方法:\n修改src&#x2F;disk.c文件\n将llseek改为lseek64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"4-文件读写测试\"><a href=\"#4-文件读写测试\" class=\"headerlink\" title=\"4 文件读写测试\"></a>4 文件读写测试</h2><blockquote>\n<p>测试硬盘内文件（10G）拷贝性能，记录时间</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建10G的大文件\ndd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;big_file count&#x3D;10 bs&#x3D;1G\n\n# 测试拷贝时间\ntime cp big_file  big_file_bak<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"5-USB存储设备读写性能\"><a href=\"#5-USB存储设备读写性能\" class=\"headerlink\" title=\"5 USB存储设备读写性能\"></a>5 USB存储设备读写性能</h2><blockquote>\n<p>测试USB存储设备读写性能（Mb&#x2F;s），平均读写速度等</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 可选准备\n1.将U盘（USB3.0）插入被测试机器,假定识别设备为sdc\n2.创建vfat文件系统分区\n&#x2F;dev&#x2F;sdb1分区容量大于30GB\numount &#x2F;dev&#x2F;sdc1\nmkfs -t vfat &#x2F;dev&#x2F;sdc1\nmkdir &#x2F;upan\nmount -t vfat &#x2F;dev&#x2F;sdc1 &#x2F;upan<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 测试写性能\ncd &#x2F;upan\ndd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;largefile bs&#x3D;64k count&#x3D;10000\n\n# 测试读性能\nsync &amp;&amp; echo 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches\ndd if&#x3D;.&#x2F;largefile of&#x3D;&#x2F;dev&#x2F;null bs&#x3D;64k<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"6-硬盘读写测试-IOZONE-x2F\"><a href=\"#6-硬盘读写测试-IOZONE-x2F\" class=\"headerlink\" title=\"6 硬盘读写测试-IOZONE&#x2F;\"></a>6 硬盘读写测试-IOZONE&#x2F;</h2><p>安装步骤：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 下载源码包\nwget http:&#x2F;&#x2F;www.iozone.org&#x2F;src&#x2F;current&#x2F;iozone3_487.tar\n# 解压\ntar -vxf iozone3_487.tar &amp;&amp; cd iozone3_489&#x2F;src&#x2F;current\n# 编译\nmake linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>参数说明：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">iozone\n    -a 全面测试，比如块大小它会自动加\n    -i N 用来选择测试项, 比如Read&#x2F;Write&#x2F;Random 比较常用的是0 1 2,可以指定成-i 0 -i 1 -i2.这些别的详细内容请查man\n        0&#x3D;write&#x2F;rewrite\n        1&#x3D;read&#x2F;re-read\n        2&#x3D;random-read&#x2F;write\n        3&#x3D;Read-backwards\n        4&#x3D;Re-write-record\n        5&#x3D;stride-read\n        6&#x3D;fwrite&#x2F;re-fwrite\n        7&#x3D;fread&#x2F;Re-fread\n        8&#x3D;random mix\n        9&#x3D;pwrite&#x2F;Re-pwrite\n        10&#x3D;pread&#x2F;Re-pread\n        11&#x3D;pwritev&#x2F;Re-pwritev\n    \t12&#x3D;preadv&#x2F;Re-preadv\n    -r block size 指定一次写入&#x2F;读出的块大小\n    -s file size 指定测试文件的大小\n    -f filename 指定测试文件的名字,完成后会自动删除(这个文件必须指定你要测试的那个硬盘中)\n    -F file1 file2… 指定多线程下测试的文件名\n    \n    批量测试项:\n    -g -n 指定测试文件大小范围,最大测试文件为4G,可以这样写 -g 4G\n    -y -q 指定测试块的大小范围\n    \n    输出:\n    下面是几个日志记录的参数.好像要输出成图象进行分析，需要指定-a的测试才能输出\n    -R 产生Excel到标准输出\n    -b 指定输出到指定文件上. 比如 -Rb ttt.xls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>1、测试硬盘读写性能（Mb&#x2F;s），包括随机和顺序读写平均读写速度（IOzone设置块大小16M，文件大小为物理内存2倍、1倍、1&#x2F;2倍三组数据）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 需要root权限\nsudo su\n# 块大小16M，文件大小为物理内存2倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 16g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_16G_0.xls\n# 块大小16M，文件大小为物理内存1倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 8g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_8G_0.xls\n# 块大小16M，文件大小为物理内存0.5倍（测试机器内存为8G的情况下）\n.&#x2F;iozone -i 0 -i 1 -i 2 -s 4g -r 16m -f &#x2F;iozone.tmpfile -Rb .&#x2F;report&#x2F;iotest_4G_0.xls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>2、测试数据盘（裸设备）的在块大小为512B、1MB下的读写性能（包括IOPS、带宽和响应时间）</p>\n</blockquote>\n<h2 id=\"7-内存读写性能测试-Stream\"><a href=\"#7-内存读写性能测试-Stream\" class=\"headerlink\" title=\"7 内存读写性能测试-Stream\"></a>7 内存读写性能测试-Stream</h2><blockquote>\n<p>测试单线和并发读写性能（Mb&#x2F;s）</p>\n</blockquote>\n<p>测试步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装gfortran\nsudo apt-get install gfortran\n\n# 编译stream\nmake\n\n# 测试\nstream_c 200000000   # 参数为Array大小<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>多线程测试</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\"># 单线程编译\ngcc -O3 stream.c -o stream\n# 多线程编译\ngcc -O3 -fopenmp stream.c -o stream.omp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"10-操作系统综合性能测试-unixbench（用时1小时）\"><a href=\"#10-操作系统综合性能测试-unixbench（用时1小时）\" class=\"headerlink\" title=\"10 操作系统综合性能测试-unixbench（用时1小时）\"></a>10 操作系统综合性能测试-unixbench（用时1小时）</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 解压UnixBench工具包：\nunzip Unixbench-Kylin.zip\n# 进入Unixbench解压后的目录下\ncd UnixBench\n# 修改Makefile文件74行\nOPTON &#x3D; -O3 -fomit-frame-pointer -fforce-addr -ffast-math -Wall -static -flto\n# 编译：\nsudo make clean &amp;&amp; make\n# 清除缓存：\nsudo su\nsync\necho 3 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;drop_caches\n# 测试单线程和多线程性能，执行命令：\nsudo .&#x2F;Run -c 1 -c N\n&#x2F;&#x2F; 其中N代表cpu核数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"11-显卡性能测试-unixbench（用时约半小时）\"><a href=\"#11-显卡性能测试-unixbench（用时约半小时）\" class=\"headerlink\" title=\"11 显卡性能测试-unixbench（用时约半小时）\"></a>11 显卡性能测试-unixbench（用时约半小时）</h2><blockquote>\n<p>1、测试2D显示处理性能，主要包括画点、画线、画三角形、画平行四边形、画正方形、画多边形等性能测试</p>\n<p>2、测试3D显示处理性能，主要包括3D的显示、色彩填充、渲染、旋转等性能测试</p>\n</blockquote>\n<p>编译Unibench</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装依赖\napt-get install libgl1-mesa-dev\n# 修改Makefile文件,防止编译报错\nvim UnixBench&#x2F;Makefile\n# 第47行取消注释\nGRAPHIC_TESTS &#x3D; defined\n# 第50行加上-lm\nGL_LIBS &#x3D; -lGL -lXext -lX11 -lm\n# 第74行修改\nOPTON &#x3D; -O2 -fomit-frame-pointer -fforce-addr -ffast-math -Wall\n\n# 修改Run文件\nvim UnixBench&#x2F;Run\n# 第109-112行，修改可支持的最大核数，当前是8\n&#39;system&#39;    &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;System Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;2d&#39;        &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;2D Graphics Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;3d&#39;        &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;3D Graphics Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,\n&#39;misc&#39;      &#x3D;&gt; &#123; &#39;name&#39; &#x3D;&gt; &quot;Non-Index Benchmarks&quot;, &#39;maxCopies&#39; &#x3D;&gt; 8 &#125;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编译运行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make clean &amp;&amp; make -j 8\n.&#x2F;Run graphics<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3D测试优化</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建文件10-vsync.conf\n&lt;driconf&gt;\n    &lt;option name&#x3D;&quot;vblank_mode&quot; value&#x3D;&quot;0&quot; &#x2F;&gt;\n&lt;&#x2F;driconf&gt;\n\n# 拷贝文件到指定路径\nsudo cp 10-vsync.conf  ~&#x2F;.drirc\n\n# 运行测试\nvblank_mode&#x3D;0 .&#x2F;Run ubgears<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"11-显卡测试-Glmark2\"><a href=\"#11-显卡测试-Glmark2\" class=\"headerlink\" title=\"11 显卡测试-Glmark2\"></a>11 显卡测试-Glmark2</h2><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo .&#x2F;waf configure --with-flavors&#x3D;x11-gl\nsudo .&#x2F;waf build -j 4\nsudo .&#x2F;waf install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">glmark2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"12-显卡测试-Glxgears\"><a href=\"#12-显卡测试-Glxgears\" class=\"headerlink\" title=\"12 显卡测试-Glxgears\"></a>12 显卡测试-Glxgears</h2><p>安装</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">sudo apt-get install mesa-utils<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 终端执行\nglxgears<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"12-网络性能测试-Netperf\"><a href=\"#12-网络性能测试-Netperf\" class=\"headerlink\" title=\"12 网络性能测试-Netperf\"></a>12 网络性能测试-Netperf</h2><blockquote>\n<p>测试网络传输速率、网络吞吐率、网络响应时间等，包括TCP、UDP流吞吐速率等</p>\n</blockquote>\n"},{"title":"KylinV10 桌面版SVN搭建","date":"2022-07-11T01:29:52.000Z","_content":"\n## 一、服务端配置\n\n### 1.1 安装SVN\n\n```shell\nsudo apt-get install subversion\n```\n\n### 1.2 新建仓库文件夹\n\n```shell\n# 创建项目仓库文件夹\nmkdir /data/svn/project\n\n# 修改文件夹权限\nchmod -R 777 /data/svn/project\n```\n\n### 1.3 创建版本库\n\n```shell\nsvnadmin create /data/svn/project\n```\n\n完成后会在文件夹中生成一系列文件\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project$ ls\nconf  db  format  hooks  locks  README.txt\n```\n\n修改db权限\n\n```shell\nchmod -R 777 db\n```\n\n### 1.4 设置访问权限\n\n```she\nvim /data/svn/project/conf/svnserve.conf\n```\n\n做如下修改\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat svnserve.conf\n### This file controls the configuration of the svnserve daemon, if you\n### use it to allow access to this repository.  (If you only allow\n### access through http: and/or file: URLs, then this file is\n### irrelevant.)\n\n### Visit http://subversion.apache.org/ for more information.\n\n[general]\n### The anon-access and auth-access options control access to the\n### repository for unauthenticated (a.k.a. anonymous) users and\n### authenticated users, respectively.\n### Valid values are \"write\", \"read\", and \"none\".\n### Setting the value to \"none\" prohibits both reading and writing;\n### \"read\" allows read-only access, and \"write\" allows complete\n### read/write access to the repository.\n### The sample settings below are the defaults and specify that anonymous\n### users have read-only access to the repository, while authenticated\n### users have read and write access to the repository.\nanon-access = none\t# 非认证用户不让写\nauth-access = write\n### The password-db option controls the location of the password\n### database file.  Unless you specify a path starting with a /,\n### the file's location is relative to the directory containing\n### this configuration file.\n### If SASL is enabled (see below), this file will NOT be used.\n### Uncomment the line below to use the default password file.\npassword-db = passwd\n### The authz-db option controls the location of the authorization\n### rules for path-based access control.  Unless you specify a path\n### starting with a /, the file's location is relative to the\n### directory containing this file.  The specified path may be a\n### repository relative URL (^/) or an absolute file:// URL to a text\n### file in a Subversion repository.  If you don't specify an authz-db,\n### no path-based access control is done.\n### Uncomment the line below to use the default authorization file.\nauthz-db = authz\n### The groups-db option controls the location of the groups file.\n### Unless you specify a path starting with a /, the file's location is\n### relative to the directory containing this file.  The specified path\n### may be a repository relative URL (^/) or an absolute file:// URL to a\n### text file in a Subversion repository.\n# groups-db = groups\n### This option specifies the authentication realm of the repository.\n### If two repositories have the same authentication realm, they should\n### have the same password database, and vice versa.  The default realm\n### is repository's uuid.\nrealm = My First Repository\n### The force-username-case option causes svnserve to case-normalize\n### usernames before comparing them against the authorization rules in the\n### authz-db file configured above.  Valid values are \"upper\" (to upper-\n### case the usernames), \"lower\" (to lowercase the usernames), and\n### \"none\" (to compare usernames as-is without case conversion, which\n### is the default behavior).\n# force-username-case = none\n### The hooks-env options specifies a path to the hook script environment\n### configuration file. This option overrides the per-repository default\n### and can be used to configure the hook script environment for multiple\n### repositories in a single file, if an absolute path is specified.\n### Unless you specify an absolute path, the file's location is relative\n### to the directory containing this file.\n# hooks-env = hooks-env\n\n[sasl]\n### This option specifies whether you want to use the Cyrus SASL\n### library for authentication. Default is false.\n### This section will be ignored if svnserve is not built with Cyrus\n### SASL support; to check, run 'svnserve --version' and look for a line\n### reading 'Cyrus SASL authentication is available.'\n# use-sasl = true\n### These options specify the desired strength of the security layer\n### that you want SASL to provide. 0 means no encryption, 1 means\n### integrity-checking only, values larger than 1 are correlated\n### to the effective key length for encryption (e.g. 128 means 128-bit\n### encryption). The values below are the defaults.\n# min-encryption = 0\n# max-encryption = 256\n```\n\n### 1.5 添加访问用户\n\n修改passwd文件，添加访问用户\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat passwd\n### This file is an example password file for svnserve.\n### Its format is similar to that of svnserve.conf. As shown in the\n### example below it contains one section labelled [users].\n### The name and password for each user follow, one account per line.\n\n[users]\n# harry = harryssecret\n# sally = sallyssecret\nadmin=mysecret\ngs=mysecret\n```\n\n### 1.6 设置用户权限\n\n修改authz文件，设置用户权限\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat authz\n### This file is an example authorization file for svnserve.\n### Its format is identical to that of mod_authz_svn authorization\n### files.\n### As shown below each section defines authorizations for the path and\n### (optional) repository specified by the section name.\n### The authorizations follow. An authorization line can refer to:\n###  - a single user,\n###  - a group of users defined in a special [groups] section,\n###  - an alias defined in a special [aliases] section,\n###  - all authenticated users, using the '$authenticated' token,\n###  - only anonymous users, using the '$anonymous' token,\n###  - anyone, using the '*' wildcard.\n###\n### A match can be inverted by prefixing the rule with '~'. Rules can\n### grant read ('r') access, read-write ('rw') access, or no access\n### ('').\n\n[aliases]\n# joe = /C=XZ/ST=Dessert/L=Snake City/O=Snake Oil, Ltd./OU=Research Institute/CN=Joe Average\n\n[groups]\n# harry_and_sally = harry,sally\n# harry_sally_and_joe = harry,sally,&joe\n\n# [/foo/bar]\n# harry = rw\n# &joe = r\n# * =\n\n# [repository:/baz/fuz]\n# @harry_and_sally = rw\n# * = r\n\nteam1=admin,gs\t# 创建用户组\n\n[/]\n@team1 = rw # 用户组权限设置为读写\n* = r\n```\n\n### 1.7 启动服务\n\n```shell\nsvnserve -d -r /data/svn\n```\n\n查看服务是否在运行\n\n```shell\nps aux | grep svnserve\n```\n\n干掉服务\n\n```shell\nkillall svnserve\n```\n\n## 二、客户端连接\n\nsvn://10.47.76.90/project\n\n","source":"_posts/04_杂记/SVN搭建.md","raw":"---\ntitle: KylinV10 桌面版SVN搭建\ndate: 2022-07-11 9:29:52\ncategories:\n- 杂记\ntags:\n---\n\n## 一、服务端配置\n\n### 1.1 安装SVN\n\n```shell\nsudo apt-get install subversion\n```\n\n### 1.2 新建仓库文件夹\n\n```shell\n# 创建项目仓库文件夹\nmkdir /data/svn/project\n\n# 修改文件夹权限\nchmod -R 777 /data/svn/project\n```\n\n### 1.3 创建版本库\n\n```shell\nsvnadmin create /data/svn/project\n```\n\n完成后会在文件夹中生成一系列文件\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project$ ls\nconf  db  format  hooks  locks  README.txt\n```\n\n修改db权限\n\n```shell\nchmod -R 777 db\n```\n\n### 1.4 设置访问权限\n\n```she\nvim /data/svn/project/conf/svnserve.conf\n```\n\n做如下修改\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat svnserve.conf\n### This file controls the configuration of the svnserve daemon, if you\n### use it to allow access to this repository.  (If you only allow\n### access through http: and/or file: URLs, then this file is\n### irrelevant.)\n\n### Visit http://subversion.apache.org/ for more information.\n\n[general]\n### The anon-access and auth-access options control access to the\n### repository for unauthenticated (a.k.a. anonymous) users and\n### authenticated users, respectively.\n### Valid values are \"write\", \"read\", and \"none\".\n### Setting the value to \"none\" prohibits both reading and writing;\n### \"read\" allows read-only access, and \"write\" allows complete\n### read/write access to the repository.\n### The sample settings below are the defaults and specify that anonymous\n### users have read-only access to the repository, while authenticated\n### users have read and write access to the repository.\nanon-access = none\t# 非认证用户不让写\nauth-access = write\n### The password-db option controls the location of the password\n### database file.  Unless you specify a path starting with a /,\n### the file's location is relative to the directory containing\n### this configuration file.\n### If SASL is enabled (see below), this file will NOT be used.\n### Uncomment the line below to use the default password file.\npassword-db = passwd\n### The authz-db option controls the location of the authorization\n### rules for path-based access control.  Unless you specify a path\n### starting with a /, the file's location is relative to the\n### directory containing this file.  The specified path may be a\n### repository relative URL (^/) or an absolute file:// URL to a text\n### file in a Subversion repository.  If you don't specify an authz-db,\n### no path-based access control is done.\n### Uncomment the line below to use the default authorization file.\nauthz-db = authz\n### The groups-db option controls the location of the groups file.\n### Unless you specify a path starting with a /, the file's location is\n### relative to the directory containing this file.  The specified path\n### may be a repository relative URL (^/) or an absolute file:// URL to a\n### text file in a Subversion repository.\n# groups-db = groups\n### This option specifies the authentication realm of the repository.\n### If two repositories have the same authentication realm, they should\n### have the same password database, and vice versa.  The default realm\n### is repository's uuid.\nrealm = My First Repository\n### The force-username-case option causes svnserve to case-normalize\n### usernames before comparing them against the authorization rules in the\n### authz-db file configured above.  Valid values are \"upper\" (to upper-\n### case the usernames), \"lower\" (to lowercase the usernames), and\n### \"none\" (to compare usernames as-is without case conversion, which\n### is the default behavior).\n# force-username-case = none\n### The hooks-env options specifies a path to the hook script environment\n### configuration file. This option overrides the per-repository default\n### and can be used to configure the hook script environment for multiple\n### repositories in a single file, if an absolute path is specified.\n### Unless you specify an absolute path, the file's location is relative\n### to the directory containing this file.\n# hooks-env = hooks-env\n\n[sasl]\n### This option specifies whether you want to use the Cyrus SASL\n### library for authentication. Default is false.\n### This section will be ignored if svnserve is not built with Cyrus\n### SASL support; to check, run 'svnserve --version' and look for a line\n### reading 'Cyrus SASL authentication is available.'\n# use-sasl = true\n### These options specify the desired strength of the security layer\n### that you want SASL to provide. 0 means no encryption, 1 means\n### integrity-checking only, values larger than 1 are correlated\n### to the effective key length for encryption (e.g. 128 means 128-bit\n### encryption). The values below are the defaults.\n# min-encryption = 0\n# max-encryption = 256\n```\n\n### 1.5 添加访问用户\n\n修改passwd文件，添加访问用户\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat passwd\n### This file is an example password file for svnserve.\n### Its format is similar to that of svnserve.conf. As shown in the\n### example below it contains one section labelled [users].\n### The name and password for each user follow, one account per line.\n\n[users]\n# harry = harryssecret\n# sally = sallyssecret\nadmin=mysecret\ngs=mysecret\n```\n\n### 1.6 设置用户权限\n\n修改authz文件，设置用户权限\n\n```shell\ngreatwall@greatwall-GW-001M1A-FTF:/data/svn/project/conf$ cat authz\n### This file is an example authorization file for svnserve.\n### Its format is identical to that of mod_authz_svn authorization\n### files.\n### As shown below each section defines authorizations for the path and\n### (optional) repository specified by the section name.\n### The authorizations follow. An authorization line can refer to:\n###  - a single user,\n###  - a group of users defined in a special [groups] section,\n###  - an alias defined in a special [aliases] section,\n###  - all authenticated users, using the '$authenticated' token,\n###  - only anonymous users, using the '$anonymous' token,\n###  - anyone, using the '*' wildcard.\n###\n### A match can be inverted by prefixing the rule with '~'. Rules can\n### grant read ('r') access, read-write ('rw') access, or no access\n### ('').\n\n[aliases]\n# joe = /C=XZ/ST=Dessert/L=Snake City/O=Snake Oil, Ltd./OU=Research Institute/CN=Joe Average\n\n[groups]\n# harry_and_sally = harry,sally\n# harry_sally_and_joe = harry,sally,&joe\n\n# [/foo/bar]\n# harry = rw\n# &joe = r\n# * =\n\n# [repository:/baz/fuz]\n# @harry_and_sally = rw\n# * = r\n\nteam1=admin,gs\t# 创建用户组\n\n[/]\n@team1 = rw # 用户组权限设置为读写\n* = r\n```\n\n### 1.7 启动服务\n\n```shell\nsvnserve -d -r /data/svn\n```\n\n查看服务是否在运行\n\n```shell\nps aux | grep svnserve\n```\n\n干掉服务\n\n```shell\nkillall svnserve\n```\n\n## 二、客户端连接\n\nsvn://10.47.76.90/project\n\n","slug":"04_杂记/SVN搭建","published":1,"updated":"2022-07-11T05:37:42.467Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k060007a8v781pyfwyr","content":"<h2 id=\"一、服务端配置\"><a href=\"#一、服务端配置\" class=\"headerlink\" title=\"一、服务端配置\"></a>一、服务端配置</h2><h3 id=\"1-1-安装SVN\"><a href=\"#1-1-安装SVN\" class=\"headerlink\" title=\"1.1 安装SVN\"></a>1.1 安装SVN</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo apt-get install subversion<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-2-新建仓库文件夹\"><a href=\"#1-2-新建仓库文件夹\" class=\"headerlink\" title=\"1.2 新建仓库文件夹\"></a>1.2 新建仓库文件夹</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建项目仓库文件夹\nmkdir &#x2F;data&#x2F;svn&#x2F;project\n\n# 修改文件夹权限\nchmod -R 777 &#x2F;data&#x2F;svn&#x2F;project<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-创建版本库\"><a href=\"#1-3-创建版本库\" class=\"headerlink\" title=\"1.3 创建版本库\"></a>1.3 创建版本库</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">svnadmin create &#x2F;data&#x2F;svn&#x2F;project<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>完成后会在文件夹中生成一系列文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project$ ls\nconf  db  format  hooks  locks  README.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改db权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">chmod -R 777 db<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-4-设置访问权限\"><a href=\"#1-4-设置访问权限\" class=\"headerlink\" title=\"1.4 设置访问权限\"></a>1.4 设置访问权限</h3><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">vim &#x2F;data&#x2F;svn&#x2F;project&#x2F;conf&#x2F;svnserve.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>做如下修改</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat svnserve.conf\n### This file controls the configuration of the svnserve daemon, if you\n### use it to allow access to this repository.  (If you only allow\n### access through http: and&#x2F;or file: URLs, then this file is\n### irrelevant.)\n\n### Visit http:&#x2F;&#x2F;subversion.apache.org&#x2F; for more information.\n\n[general]\n### The anon-access and auth-access options control access to the\n### repository for unauthenticated (a.k.a. anonymous) users and\n### authenticated users, respectively.\n### Valid values are &quot;write&quot;, &quot;read&quot;, and &quot;none&quot;.\n### Setting the value to &quot;none&quot; prohibits both reading and writing;\n### &quot;read&quot; allows read-only access, and &quot;write&quot; allows complete\n### read&#x2F;write access to the repository.\n### The sample settings below are the defaults and specify that anonymous\n### users have read-only access to the repository, while authenticated\n### users have read and write access to the repository.\nanon-access &#x3D; none\t# 非认证用户不让写\nauth-access &#x3D; write\n### The password-db option controls the location of the password\n### database file.  Unless you specify a path starting with a &#x2F;,\n### the file&#39;s location is relative to the directory containing\n### this configuration file.\n### If SASL is enabled (see below), this file will NOT be used.\n### Uncomment the line below to use the default password file.\npassword-db &#x3D; passwd\n### The authz-db option controls the location of the authorization\n### rules for path-based access control.  Unless you specify a path\n### starting with a &#x2F;, the file&#39;s location is relative to the\n### directory containing this file.  The specified path may be a\n### repository relative URL (^&#x2F;) or an absolute file:&#x2F;&#x2F; URL to a text\n### file in a Subversion repository.  If you don&#39;t specify an authz-db,\n### no path-based access control is done.\n### Uncomment the line below to use the default authorization file.\nauthz-db &#x3D; authz\n### The groups-db option controls the location of the groups file.\n### Unless you specify a path starting with a &#x2F;, the file&#39;s location is\n### relative to the directory containing this file.  The specified path\n### may be a repository relative URL (^&#x2F;) or an absolute file:&#x2F;&#x2F; URL to a\n### text file in a Subversion repository.\n# groups-db &#x3D; groups\n### This option specifies the authentication realm of the repository.\n### If two repositories have the same authentication realm, they should\n### have the same password database, and vice versa.  The default realm\n### is repository&#39;s uuid.\nrealm &#x3D; My First Repository\n### The force-username-case option causes svnserve to case-normalize\n### usernames before comparing them against the authorization rules in the\n### authz-db file configured above.  Valid values are &quot;upper&quot; (to upper-\n### case the usernames), &quot;lower&quot; (to lowercase the usernames), and\n### &quot;none&quot; (to compare usernames as-is without case conversion, which\n### is the default behavior).\n# force-username-case &#x3D; none\n### The hooks-env options specifies a path to the hook script environment\n### configuration file. This option overrides the per-repository default\n### and can be used to configure the hook script environment for multiple\n### repositories in a single file, if an absolute path is specified.\n### Unless you specify an absolute path, the file&#39;s location is relative\n### to the directory containing this file.\n# hooks-env &#x3D; hooks-env\n\n[sasl]\n### This option specifies whether you want to use the Cyrus SASL\n### library for authentication. Default is false.\n### This section will be ignored if svnserve is not built with Cyrus\n### SASL support; to check, run &#39;svnserve --version&#39; and look for a line\n### reading &#39;Cyrus SASL authentication is available.&#39;\n# use-sasl &#x3D; true\n### These options specify the desired strength of the security layer\n### that you want SASL to provide. 0 means no encryption, 1 means\n### integrity-checking only, values larger than 1 are correlated\n### to the effective key length for encryption (e.g. 128 means 128-bit\n### encryption). The values below are the defaults.\n# min-encryption &#x3D; 0\n# max-encryption &#x3D; 256<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-5-添加访问用户\"><a href=\"#1-5-添加访问用户\" class=\"headerlink\" title=\"1.5 添加访问用户\"></a>1.5 添加访问用户</h3><p>修改passwd文件，添加访问用户</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat passwd\n### This file is an example password file for svnserve.\n### Its format is similar to that of svnserve.conf. As shown in the\n### example below it contains one section labelled [users].\n### The name and password for each user follow, one account per line.\n\n[users]\n# harry &#x3D; harryssecret\n# sally &#x3D; sallyssecret\nadmin&#x3D;mysecret\ngs&#x3D;mysecret<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-6-设置用户权限\"><a href=\"#1-6-设置用户权限\" class=\"headerlink\" title=\"1.6 设置用户权限\"></a>1.6 设置用户权限</h3><p>修改authz文件，设置用户权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat authz\n### This file is an example authorization file for svnserve.\n### Its format is identical to that of mod_authz_svn authorization\n### files.\n### As shown below each section defines authorizations for the path and\n### (optional) repository specified by the section name.\n### The authorizations follow. An authorization line can refer to:\n###  - a single user,\n###  - a group of users defined in a special [groups] section,\n###  - an alias defined in a special [aliases] section,\n###  - all authenticated users, using the &#39;$authenticated&#39; token,\n###  - only anonymous users, using the &#39;$anonymous&#39; token,\n###  - anyone, using the &#39;*&#39; wildcard.\n###\n### A match can be inverted by prefixing the rule with &#39;~&#39;. Rules can\n### grant read (&#39;r&#39;) access, read-write (&#39;rw&#39;) access, or no access\n### (&#39;&#39;).\n\n[aliases]\n# joe &#x3D; &#x2F;C&#x3D;XZ&#x2F;ST&#x3D;Dessert&#x2F;L&#x3D;Snake City&#x2F;O&#x3D;Snake Oil, Ltd.&#x2F;OU&#x3D;Research Institute&#x2F;CN&#x3D;Joe Average\n\n[groups]\n# harry_and_sally &#x3D; harry,sally\n# harry_sally_and_joe &#x3D; harry,sally,&amp;joe\n\n# [&#x2F;foo&#x2F;bar]\n# harry &#x3D; rw\n# &amp;joe &#x3D; r\n# * &#x3D;\n\n# [repository:&#x2F;baz&#x2F;fuz]\n# @harry_and_sally &#x3D; rw\n# * &#x3D; r\n\nteam1&#x3D;admin,gs\t# 创建用户组\n\n[&#x2F;]\n@team1 &#x3D; rw # 用户组权限设置为读写\n* &#x3D; r<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-7-启动服务\"><a href=\"#1-7-启动服务\" class=\"headerlink\" title=\"1.7 启动服务\"></a>1.7 启动服务</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">svnserve -d -r &#x2F;data&#x2F;svn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看服务是否在运行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ps aux | grep svnserve<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>干掉服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">killall svnserve<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、客户端连接\"><a href=\"#二、客户端连接\" class=\"headerlink\" title=\"二、客户端连接\"></a>二、客户端连接</h2><p>svn:&#x2F;&#x2F;10.47.76.90&#x2F;project</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、服务端配置\"><a href=\"#一、服务端配置\" class=\"headerlink\" title=\"一、服务端配置\"></a>一、服务端配置</h2><h3 id=\"1-1-安装SVN\"><a href=\"#1-1-安装SVN\" class=\"headerlink\" title=\"1.1 安装SVN\"></a>1.1 安装SVN</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo apt-get install subversion<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-2-新建仓库文件夹\"><a href=\"#1-2-新建仓库文件夹\" class=\"headerlink\" title=\"1.2 新建仓库文件夹\"></a>1.2 新建仓库文件夹</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建项目仓库文件夹\nmkdir &#x2F;data&#x2F;svn&#x2F;project\n\n# 修改文件夹权限\nchmod -R 777 &#x2F;data&#x2F;svn&#x2F;project<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-创建版本库\"><a href=\"#1-3-创建版本库\" class=\"headerlink\" title=\"1.3 创建版本库\"></a>1.3 创建版本库</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">svnadmin create &#x2F;data&#x2F;svn&#x2F;project<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>完成后会在文件夹中生成一系列文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project$ ls\nconf  db  format  hooks  locks  README.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改db权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">chmod -R 777 db<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-4-设置访问权限\"><a href=\"#1-4-设置访问权限\" class=\"headerlink\" title=\"1.4 设置访问权限\"></a>1.4 设置访问权限</h3><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">vim &#x2F;data&#x2F;svn&#x2F;project&#x2F;conf&#x2F;svnserve.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>做如下修改</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat svnserve.conf\n### This file controls the configuration of the svnserve daemon, if you\n### use it to allow access to this repository.  (If you only allow\n### access through http: and&#x2F;or file: URLs, then this file is\n### irrelevant.)\n\n### Visit http:&#x2F;&#x2F;subversion.apache.org&#x2F; for more information.\n\n[general]\n### The anon-access and auth-access options control access to the\n### repository for unauthenticated (a.k.a. anonymous) users and\n### authenticated users, respectively.\n### Valid values are &quot;write&quot;, &quot;read&quot;, and &quot;none&quot;.\n### Setting the value to &quot;none&quot; prohibits both reading and writing;\n### &quot;read&quot; allows read-only access, and &quot;write&quot; allows complete\n### read&#x2F;write access to the repository.\n### The sample settings below are the defaults and specify that anonymous\n### users have read-only access to the repository, while authenticated\n### users have read and write access to the repository.\nanon-access &#x3D; none\t# 非认证用户不让写\nauth-access &#x3D; write\n### The password-db option controls the location of the password\n### database file.  Unless you specify a path starting with a &#x2F;,\n### the file&#39;s location is relative to the directory containing\n### this configuration file.\n### If SASL is enabled (see below), this file will NOT be used.\n### Uncomment the line below to use the default password file.\npassword-db &#x3D; passwd\n### The authz-db option controls the location of the authorization\n### rules for path-based access control.  Unless you specify a path\n### starting with a &#x2F;, the file&#39;s location is relative to the\n### directory containing this file.  The specified path may be a\n### repository relative URL (^&#x2F;) or an absolute file:&#x2F;&#x2F; URL to a text\n### file in a Subversion repository.  If you don&#39;t specify an authz-db,\n### no path-based access control is done.\n### Uncomment the line below to use the default authorization file.\nauthz-db &#x3D; authz\n### The groups-db option controls the location of the groups file.\n### Unless you specify a path starting with a &#x2F;, the file&#39;s location is\n### relative to the directory containing this file.  The specified path\n### may be a repository relative URL (^&#x2F;) or an absolute file:&#x2F;&#x2F; URL to a\n### text file in a Subversion repository.\n# groups-db &#x3D; groups\n### This option specifies the authentication realm of the repository.\n### If two repositories have the same authentication realm, they should\n### have the same password database, and vice versa.  The default realm\n### is repository&#39;s uuid.\nrealm &#x3D; My First Repository\n### The force-username-case option causes svnserve to case-normalize\n### usernames before comparing them against the authorization rules in the\n### authz-db file configured above.  Valid values are &quot;upper&quot; (to upper-\n### case the usernames), &quot;lower&quot; (to lowercase the usernames), and\n### &quot;none&quot; (to compare usernames as-is without case conversion, which\n### is the default behavior).\n# force-username-case &#x3D; none\n### The hooks-env options specifies a path to the hook script environment\n### configuration file. This option overrides the per-repository default\n### and can be used to configure the hook script environment for multiple\n### repositories in a single file, if an absolute path is specified.\n### Unless you specify an absolute path, the file&#39;s location is relative\n### to the directory containing this file.\n# hooks-env &#x3D; hooks-env\n\n[sasl]\n### This option specifies whether you want to use the Cyrus SASL\n### library for authentication. Default is false.\n### This section will be ignored if svnserve is not built with Cyrus\n### SASL support; to check, run &#39;svnserve --version&#39; and look for a line\n### reading &#39;Cyrus SASL authentication is available.&#39;\n# use-sasl &#x3D; true\n### These options specify the desired strength of the security layer\n### that you want SASL to provide. 0 means no encryption, 1 means\n### integrity-checking only, values larger than 1 are correlated\n### to the effective key length for encryption (e.g. 128 means 128-bit\n### encryption). The values below are the defaults.\n# min-encryption &#x3D; 0\n# max-encryption &#x3D; 256<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-5-添加访问用户\"><a href=\"#1-5-添加访问用户\" class=\"headerlink\" title=\"1.5 添加访问用户\"></a>1.5 添加访问用户</h3><p>修改passwd文件，添加访问用户</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat passwd\n### This file is an example password file for svnserve.\n### Its format is similar to that of svnserve.conf. As shown in the\n### example below it contains one section labelled [users].\n### The name and password for each user follow, one account per line.\n\n[users]\n# harry &#x3D; harryssecret\n# sally &#x3D; sallyssecret\nadmin&#x3D;mysecret\ngs&#x3D;mysecret<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-6-设置用户权限\"><a href=\"#1-6-设置用户权限\" class=\"headerlink\" title=\"1.6 设置用户权限\"></a>1.6 设置用户权限</h3><p>修改authz文件，设置用户权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">greatwall@greatwall-GW-001M1A-FTF:&#x2F;data&#x2F;svn&#x2F;project&#x2F;conf$ cat authz\n### This file is an example authorization file for svnserve.\n### Its format is identical to that of mod_authz_svn authorization\n### files.\n### As shown below each section defines authorizations for the path and\n### (optional) repository specified by the section name.\n### The authorizations follow. An authorization line can refer to:\n###  - a single user,\n###  - a group of users defined in a special [groups] section,\n###  - an alias defined in a special [aliases] section,\n###  - all authenticated users, using the &#39;$authenticated&#39; token,\n###  - only anonymous users, using the &#39;$anonymous&#39; token,\n###  - anyone, using the &#39;*&#39; wildcard.\n###\n### A match can be inverted by prefixing the rule with &#39;~&#39;. Rules can\n### grant read (&#39;r&#39;) access, read-write (&#39;rw&#39;) access, or no access\n### (&#39;&#39;).\n\n[aliases]\n# joe &#x3D; &#x2F;C&#x3D;XZ&#x2F;ST&#x3D;Dessert&#x2F;L&#x3D;Snake City&#x2F;O&#x3D;Snake Oil, Ltd.&#x2F;OU&#x3D;Research Institute&#x2F;CN&#x3D;Joe Average\n\n[groups]\n# harry_and_sally &#x3D; harry,sally\n# harry_sally_and_joe &#x3D; harry,sally,&amp;joe\n\n# [&#x2F;foo&#x2F;bar]\n# harry &#x3D; rw\n# &amp;joe &#x3D; r\n# * &#x3D;\n\n# [repository:&#x2F;baz&#x2F;fuz]\n# @harry_and_sally &#x3D; rw\n# * &#x3D; r\n\nteam1&#x3D;admin,gs\t# 创建用户组\n\n[&#x2F;]\n@team1 &#x3D; rw # 用户组权限设置为读写\n* &#x3D; r<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-7-启动服务\"><a href=\"#1-7-启动服务\" class=\"headerlink\" title=\"1.7 启动服务\"></a>1.7 启动服务</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">svnserve -d -r &#x2F;data&#x2F;svn<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看服务是否在运行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ps aux | grep svnserve<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>干掉服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">killall svnserve<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、客户端连接\"><a href=\"#二、客户端连接\" class=\"headerlink\" title=\"二、客户端连接\"></a>二、客户端连接</h2><p>svn:&#x2F;&#x2F;10.47.76.90&#x2F;project</p>\n"},{"title":"Oracle VPS部署V2Ray","date":"2022-07-15T06:27:52.000Z","_content":"\n\n\n## 1 前言\n\n​\t本文介绍如何使用甲骨文（Oracle）的免费VPS部署V2Ray\n\n甲骨文服务器申请地址：\n\nhttps://www.oracle.com/cloud/free/\n\n> c7 / 7q / F+\n\n\n\n## 2 域名申请\n\n<font color='red'>**！！本节使用Firefox浏览器操作！！**</font>\n\n### 2.1 Firefox浏览器Gooreplacer插件设置\n\n>防止freenom在订单提交阶段失败\n\n安装完插件后，点击“配置规则”\n\n![image-20220715144835831](../../img/image-20220715144835831.png)\n\n规则配置\n\n```python\n重定向填写：\nhttps://www.google.com/recaptcha\n目标地址填写：\nhttps://www.recaptcha.net/recaptcha\n```\n\n![image-20220715145007138](../../img/image-20220715145007138.png)\n\n\n\n### 2.2 freenom域名申请\n\n>freenom可以申请免费的域名，申请地址：\n>\n>https://www.freenom.com/en/index.html\n\n- 登录，选择\"注册一个新域名\"![image-20220715145353695](../../img/image-20220715145353695.png)\n\n- 输入需要注册的域名名\n\n![image-20220715145306545](../../img/image-20220715145306545.png)\n\n- 选择免费域名，加入购物车\n\n![image-20220715145556778](../../img/image-20220715145556778.png)\n\n- 期限修改为12个月\n\n![image-20220715145640940](../../img/image-20220715145640940.png)\n\n- 勾选允许协议，点击完成\n\n![image-20220715145722733](../../img/image-20220715145722733.png)\n\n- 看到此界面，说明申请成功，如果申请失败，回到2.1检查Gooreplacer插件是否配置正常\n\n![image-20220715145825655](../../img/image-20220715145825655.png)\n\n- 查看我的域名\n\n![image-20220715150619814](../../img/image-20220715150619814.png)\n\n- 设置域名\n\n  ![image-20220715150723654](../../img/image-20220715150723654.png)\n\n- 添加域名解析\n\n![image-20220715150801833](../../img/image-20220715150801833.png)\n\n- 填写域名解析服务器\n\n  ```python\n  PAITYN.NS.CLOUDFLARE.COM\n  SYEEF.NS.CLOUDFLARE.COM\n  ```\n\n![image-20220715150832903](../../img/image-20220715150832903.png)\n\n## 3 域名解析配置（CDN）\n\n>这里使用cloudflare\n\n添加站点\n\n![image-20220715151303012](../../img/image-20220715151303012.png)\n\n选择免费的方案\n\n![image-20220715151454194](../../img/image-20220715151454194.png)\n\n添加VPS服务器地址\n\n![image-20220715151735023](../../img/image-20220715151735023.png)\n\n校验服务器是否生效：\n\n>解析的IP不一致，是因为勾选了”代理“，不影响正常使用\n\n![image-20220715151954505](../../img/image-20220715151954505.png)\n\n## 4 VPS部署V2Ray\n\n>参考：https://www.ioiox.com/archives/99.html\n\n### 4.1 系统设置\n\n#### SSH服务\n\n切换至root创建密码\n\n```shell\nsudo -i\n# 切换至 root 账号\npasswd\n# 修改密码\n```\n\n修改ssh配置\n\n```shell\nvi /etc/ssh/sshd_config\n# 编辑 sshd_config\n\n添加或修改Port 22222以确保SSH端口安全.\n查找到#PermitRootLogin yes,去掉#注释符号.\n查找到#PasswordAuthentication yes,去掉#注释符号.\n查找到#ClientAliveInterval 0,去掉#注释符号,0改为30.\n查找到#MaxSessions 10,去掉#注释符号.\n```\n\n重启ssh服务\n\n```shell\nsystemctl restart sshd\n# 重启 sshd 生效\n```\n\n#### 防火墙\n\n关闭防火墙\n\n```shell\nsystemctl stop firewalld\nsystemctl disable firewalld\n```\n\n#### 修改主机名\n\n>甲骨文云的`CentOS 7`在使用`hostnamectl set-hostname`命令修改主机名时,重启服务器后依旧会恢复为 Web 端创建实例时所设置的名字.网上查找了各种方法都无效,最终找到了解决方案.\n\n编辑修改`oci-hostname.conf`文件\n\n```shell\nvi /etc/oci-hostname.conf\n```\n\n将`PRESERVE_HOSTINFO=0`中的的值`0`修改为`1`\n\n```shell\n# This configuration file controls the hostname persistence behavior for Oracle Linux\n# compute instance on Oracle Cloud Infrastructure (formerly Baremetal Cloud Services)\n# Set PRESERVE_HOSTINFO to one of the following values\n#   0 -- default behavior to update hostname, /etc/hosts and /etc/resolv.conf to \n#        reflect the hostname set during instance creation from the metadata service\n#   1 -- preserve user configured hostname across reboots; update /etc/hosts and \n#           /etc/resolv.conf from the metadata service  \n#   2 -- preserve user configured hostname across instance reboots; no custom  \n#        changes to /etc/hosts and /etc/resolv.conf from the metadata service,\n#        but dhclient will still overwrite /etc/resolv.conf\n#   3 -- preserve hostname and /etc/hosts entries across instance reboots; \n#        update /etc/resolv.conf from instance metadata service\nPRESERVE_HOSTINFO=0\n```\n\n使用`hostnamectl set-hostname`命令修改主机名即可.重启也不会失效.\n\n```shell\nhostnamectl set-hostname xxxxxx\n```\n\n#### 卸载相关程序\n\n##### rpcbind\n\n使用`netstat -ntlp`命令发现`rpcbind`监听了`111`端口,如担心安全可执行以下命令卸载禁用:\n\n```shell\nsystemctl stop rpcbind\nsystemctl stop rpcbind.socket\nsystemctl disable rpcbind\nsystemctl disable rpcbind.socket \n```\n\n##### oracle-cloud-agent\n\n卸载甲骨文云官方后台监控程序\n\n```shell\nsystemctl stop oracle-cloud-agent\nsystemctl disable oracle-cloud-agent\nsystemctl stop oracle-cloud-agent-updater\nsystemctl disable oracle-cloud-agent-updater\n```\n\n\n\n### 4.2 安装BBRPlus\n\n>参考：https://www.ioiox.com/archives/63.html\n>\n>Oracle VPS部署BBR，按普通的方式安装，将导致BBR安装并重启机器后，服务器失联，需要安装特定的内核，并作一些列设置\n\n#### 升级内核\n\n更新 yum\n\n```shell\nyum -y update\n```\n\n查看内核\n\n```shell\nuname -r\n# 内核版本 3.10.0-1062.12.1.el7.x86_64\n```\n\n手动下载`秋水 BBRPlus`版内核\n\n```shell\nwget https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/bbrplus/centos/7/kernel-4.14.129-bbrplus.rpm\n```\n\n手动安装内核\n\n```shell\nyum -y install kernel-4.14.129-bbrplus.rpm\n```\n\n更新引导\n\n```shell\ngrub2-mkconfig -o /boot/grub2/grub.cfg\ngrub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg\n```\n\n列出系统开机启动项\n\n```shell\nsudo awk -F\\' '$1==\"menuentry \" {print i++ \" : \" $2}' /boot/efi/EFI/centos/grub.cfg\n```\n\n设置新版内核默认启动项\n\n```shell\ngrub2-set-default 0\n```\n\n重启\n\n```shell\nreboot\n```\n\n#### 开启 BBRPlus 及优化\n\n秋水一键脚本,选择`7`开启`BBRPlus`加速.\n再次`./tcp.sh`运行脚本,选择`10`优化并重启完成.\n\n```shell\nwget -N --no-check-certificate \"https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/tcp.sh\" && chmod +x tcp.sh && ./tc\n```\n\n\n\n### 4.3 安装V2Ray\n\n在梯子服务器，执行一键搭建脚本\n\n```shell\nbash <(curl -sL https://gist.githubusercontent.com/JodenHe/815dd91277b722d36a860d39c2296083/raw/7f2b5ac0f8137b245d44741fc4a9f40cffa36755/v2Ray-install.sh)\n```\n\n![image-20220715155109519](../../img/image-20220715155109519.png)\n\nBBR已经安装过，这里选n （笔者第一次在这选y直接安装BBR，结果服务器重启后失联，没法登录，后采用4.2小节的方式，先安装BBRPlus）\n\n![image-20220715155122886](../../img/image-20220715155122886.png)\n\n安装成功，可以使用链接配置V2RayN\n\n![image-20220715155230097](../../img/image-20220715155230097.png)\n\n\n\n## 5 v2Ray 客户端\n\n参考：https://tlanyan.pp.ua/v2ray-clients-download/\n\n笔者使用的windows客户端为：`V2rayN`, 安卓客户端为：`V2rayNG`\n\n\n\n## 6 参考\n\nhttps://toutyrater.github.io/\n\nhttps://tlanyan.pp.ua/v2ray-clients-download/\n\nhttps://baijiahao.baidu.com/s?id=1689185764130254565&wfr=spider&for=pc\n\nhttps://www.ioiox.com/archives/99.html\n\nhttps://blog.joden123.top/2022/02/20/proxy/v2ray-install/","source":"_posts/04_杂记/甲骨文VPS搭建梯子.md","raw":"---\ntitle: Oracle VPS部署V2Ray\ndate: 2022-07-15 14:27:52\ncategories:\n- 杂记\ntags:\n---\n\n\n\n## 1 前言\n\n​\t本文介绍如何使用甲骨文（Oracle）的免费VPS部署V2Ray\n\n甲骨文服务器申请地址：\n\nhttps://www.oracle.com/cloud/free/\n\n> c7 / 7q / F+\n\n\n\n## 2 域名申请\n\n<font color='red'>**！！本节使用Firefox浏览器操作！！**</font>\n\n### 2.1 Firefox浏览器Gooreplacer插件设置\n\n>防止freenom在订单提交阶段失败\n\n安装完插件后，点击“配置规则”\n\n![image-20220715144835831](../../img/image-20220715144835831.png)\n\n规则配置\n\n```python\n重定向填写：\nhttps://www.google.com/recaptcha\n目标地址填写：\nhttps://www.recaptcha.net/recaptcha\n```\n\n![image-20220715145007138](../../img/image-20220715145007138.png)\n\n\n\n### 2.2 freenom域名申请\n\n>freenom可以申请免费的域名，申请地址：\n>\n>https://www.freenom.com/en/index.html\n\n- 登录，选择\"注册一个新域名\"![image-20220715145353695](../../img/image-20220715145353695.png)\n\n- 输入需要注册的域名名\n\n![image-20220715145306545](../../img/image-20220715145306545.png)\n\n- 选择免费域名，加入购物车\n\n![image-20220715145556778](../../img/image-20220715145556778.png)\n\n- 期限修改为12个月\n\n![image-20220715145640940](../../img/image-20220715145640940.png)\n\n- 勾选允许协议，点击完成\n\n![image-20220715145722733](../../img/image-20220715145722733.png)\n\n- 看到此界面，说明申请成功，如果申请失败，回到2.1检查Gooreplacer插件是否配置正常\n\n![image-20220715145825655](../../img/image-20220715145825655.png)\n\n- 查看我的域名\n\n![image-20220715150619814](../../img/image-20220715150619814.png)\n\n- 设置域名\n\n  ![image-20220715150723654](../../img/image-20220715150723654.png)\n\n- 添加域名解析\n\n![image-20220715150801833](../../img/image-20220715150801833.png)\n\n- 填写域名解析服务器\n\n  ```python\n  PAITYN.NS.CLOUDFLARE.COM\n  SYEEF.NS.CLOUDFLARE.COM\n  ```\n\n![image-20220715150832903](../../img/image-20220715150832903.png)\n\n## 3 域名解析配置（CDN）\n\n>这里使用cloudflare\n\n添加站点\n\n![image-20220715151303012](../../img/image-20220715151303012.png)\n\n选择免费的方案\n\n![image-20220715151454194](../../img/image-20220715151454194.png)\n\n添加VPS服务器地址\n\n![image-20220715151735023](../../img/image-20220715151735023.png)\n\n校验服务器是否生效：\n\n>解析的IP不一致，是因为勾选了”代理“，不影响正常使用\n\n![image-20220715151954505](../../img/image-20220715151954505.png)\n\n## 4 VPS部署V2Ray\n\n>参考：https://www.ioiox.com/archives/99.html\n\n### 4.1 系统设置\n\n#### SSH服务\n\n切换至root创建密码\n\n```shell\nsudo -i\n# 切换至 root 账号\npasswd\n# 修改密码\n```\n\n修改ssh配置\n\n```shell\nvi /etc/ssh/sshd_config\n# 编辑 sshd_config\n\n添加或修改Port 22222以确保SSH端口安全.\n查找到#PermitRootLogin yes,去掉#注释符号.\n查找到#PasswordAuthentication yes,去掉#注释符号.\n查找到#ClientAliveInterval 0,去掉#注释符号,0改为30.\n查找到#MaxSessions 10,去掉#注释符号.\n```\n\n重启ssh服务\n\n```shell\nsystemctl restart sshd\n# 重启 sshd 生效\n```\n\n#### 防火墙\n\n关闭防火墙\n\n```shell\nsystemctl stop firewalld\nsystemctl disable firewalld\n```\n\n#### 修改主机名\n\n>甲骨文云的`CentOS 7`在使用`hostnamectl set-hostname`命令修改主机名时,重启服务器后依旧会恢复为 Web 端创建实例时所设置的名字.网上查找了各种方法都无效,最终找到了解决方案.\n\n编辑修改`oci-hostname.conf`文件\n\n```shell\nvi /etc/oci-hostname.conf\n```\n\n将`PRESERVE_HOSTINFO=0`中的的值`0`修改为`1`\n\n```shell\n# This configuration file controls the hostname persistence behavior for Oracle Linux\n# compute instance on Oracle Cloud Infrastructure (formerly Baremetal Cloud Services)\n# Set PRESERVE_HOSTINFO to one of the following values\n#   0 -- default behavior to update hostname, /etc/hosts and /etc/resolv.conf to \n#        reflect the hostname set during instance creation from the metadata service\n#   1 -- preserve user configured hostname across reboots; update /etc/hosts and \n#           /etc/resolv.conf from the metadata service  \n#   2 -- preserve user configured hostname across instance reboots; no custom  \n#        changes to /etc/hosts and /etc/resolv.conf from the metadata service,\n#        but dhclient will still overwrite /etc/resolv.conf\n#   3 -- preserve hostname and /etc/hosts entries across instance reboots; \n#        update /etc/resolv.conf from instance metadata service\nPRESERVE_HOSTINFO=0\n```\n\n使用`hostnamectl set-hostname`命令修改主机名即可.重启也不会失效.\n\n```shell\nhostnamectl set-hostname xxxxxx\n```\n\n#### 卸载相关程序\n\n##### rpcbind\n\n使用`netstat -ntlp`命令发现`rpcbind`监听了`111`端口,如担心安全可执行以下命令卸载禁用:\n\n```shell\nsystemctl stop rpcbind\nsystemctl stop rpcbind.socket\nsystemctl disable rpcbind\nsystemctl disable rpcbind.socket \n```\n\n##### oracle-cloud-agent\n\n卸载甲骨文云官方后台监控程序\n\n```shell\nsystemctl stop oracle-cloud-agent\nsystemctl disable oracle-cloud-agent\nsystemctl stop oracle-cloud-agent-updater\nsystemctl disable oracle-cloud-agent-updater\n```\n\n\n\n### 4.2 安装BBRPlus\n\n>参考：https://www.ioiox.com/archives/63.html\n>\n>Oracle VPS部署BBR，按普通的方式安装，将导致BBR安装并重启机器后，服务器失联，需要安装特定的内核，并作一些列设置\n\n#### 升级内核\n\n更新 yum\n\n```shell\nyum -y update\n```\n\n查看内核\n\n```shell\nuname -r\n# 内核版本 3.10.0-1062.12.1.el7.x86_64\n```\n\n手动下载`秋水 BBRPlus`版内核\n\n```shell\nwget https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/bbrplus/centos/7/kernel-4.14.129-bbrplus.rpm\n```\n\n手动安装内核\n\n```shell\nyum -y install kernel-4.14.129-bbrplus.rpm\n```\n\n更新引导\n\n```shell\ngrub2-mkconfig -o /boot/grub2/grub.cfg\ngrub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg\n```\n\n列出系统开机启动项\n\n```shell\nsudo awk -F\\' '$1==\"menuentry \" {print i++ \" : \" $2}' /boot/efi/EFI/centos/grub.cfg\n```\n\n设置新版内核默认启动项\n\n```shell\ngrub2-set-default 0\n```\n\n重启\n\n```shell\nreboot\n```\n\n#### 开启 BBRPlus 及优化\n\n秋水一键脚本,选择`7`开启`BBRPlus`加速.\n再次`./tcp.sh`运行脚本,选择`10`优化并重启完成.\n\n```shell\nwget -N --no-check-certificate \"https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/tcp.sh\" && chmod +x tcp.sh && ./tc\n```\n\n\n\n### 4.3 安装V2Ray\n\n在梯子服务器，执行一键搭建脚本\n\n```shell\nbash <(curl -sL https://gist.githubusercontent.com/JodenHe/815dd91277b722d36a860d39c2296083/raw/7f2b5ac0f8137b245d44741fc4a9f40cffa36755/v2Ray-install.sh)\n```\n\n![image-20220715155109519](../../img/image-20220715155109519.png)\n\nBBR已经安装过，这里选n （笔者第一次在这选y直接安装BBR，结果服务器重启后失联，没法登录，后采用4.2小节的方式，先安装BBRPlus）\n\n![image-20220715155122886](../../img/image-20220715155122886.png)\n\n安装成功，可以使用链接配置V2RayN\n\n![image-20220715155230097](../../img/image-20220715155230097.png)\n\n\n\n## 5 v2Ray 客户端\n\n参考：https://tlanyan.pp.ua/v2ray-clients-download/\n\n笔者使用的windows客户端为：`V2rayN`, 安卓客户端为：`V2rayNG`\n\n\n\n## 6 参考\n\nhttps://toutyrater.github.io/\n\nhttps://tlanyan.pp.ua/v2ray-clients-download/\n\nhttps://baijiahao.baidu.com/s?id=1689185764130254565&wfr=spider&for=pc\n\nhttps://www.ioiox.com/archives/99.html\n\nhttps://blog.joden123.top/2022/02/20/proxy/v2ray-install/","slug":"04_杂记/甲骨文VPS搭建梯子","published":1,"updated":"2022-07-18T07:10:19.405Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k070009a8v74uu24p63","content":"<h2 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1 前言\"></a>1 前言</h2><p>​\t本文介绍如何使用甲骨文（Oracle）的免费VPS部署V2Ray</p>\n<p>甲骨文服务器申请地址：</p>\n<p><a href=\"https://www.oracle.com/cloud/free/\">https://www.oracle.com/cloud/free/</a></p>\n<blockquote>\n<p>c7 &#x2F; 7q &#x2F; F+</p>\n</blockquote>\n<h2 id=\"2-域名申请\"><a href=\"#2-域名申请\" class=\"headerlink\" title=\"2 域名申请\"></a>2 域名申请</h2><p><font color='red'><strong>！！本节使用Firefox浏览器操作！！</strong></font></p>\n<h3 id=\"2-1-Firefox浏览器Gooreplacer插件设置\"><a href=\"#2-1-Firefox浏览器Gooreplacer插件设置\" class=\"headerlink\" title=\"2.1 Firefox浏览器Gooreplacer插件设置\"></a>2.1 Firefox浏览器Gooreplacer插件设置</h3><blockquote>\n<p>防止freenom在订单提交阶段失败</p>\n</blockquote>\n<p>安装完插件后，点击“配置规则”</p>\n<p><img src=\"/../../img/image-20220715144835831.png\" alt=\"image-20220715144835831\"></p>\n<p>规则配置</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">重定向填写：\nhttps<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span>www<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>recaptcha\n目标地址填写：\nhttps<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span>www<span class=\"token punctuation\">.</span>recaptcha<span class=\"token punctuation\">.</span>net<span class=\"token operator\">/</span>recaptcha<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/../../img/image-20220715145007138.png\" alt=\"image-20220715145007138\"></p>\n<h3 id=\"2-2-freenom域名申请\"><a href=\"#2-2-freenom域名申请\" class=\"headerlink\" title=\"2.2 freenom域名申请\"></a>2.2 freenom域名申请</h3><blockquote>\n<p>freenom可以申请免费的域名，申请地址：</p>\n<p><a href=\"https://www.freenom.com/en/index.html\">https://www.freenom.com/en/index.html</a></p>\n</blockquote>\n<ul>\n<li><p>登录，选择”注册一个新域名”<img src=\"/../../img/image-20220715145353695.png\" alt=\"image-20220715145353695\"></p>\n</li>\n<li><p>输入需要注册的域名名</p>\n</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145306545.png\" alt=\"image-20220715145306545\"></p>\n<ul>\n<li>选择免费域名，加入购物车</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145556778.png\" alt=\"image-20220715145556778\"></p>\n<ul>\n<li>期限修改为12个月</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145640940.png\" alt=\"image-20220715145640940\"></p>\n<ul>\n<li>勾选允许协议，点击完成</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145722733.png\" alt=\"image-20220715145722733\"></p>\n<ul>\n<li>看到此界面，说明申请成功，如果申请失败，回到2.1检查Gooreplacer插件是否配置正常</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145825655.png\" alt=\"image-20220715145825655\"></p>\n<ul>\n<li>查看我的域名</li>\n</ul>\n<p><img src=\"/../../img/image-20220715150619814.png\" alt=\"image-20220715150619814\"></p>\n<ul>\n<li><p>设置域名</p>\n<p><img src=\"/../../img/image-20220715150723654.png\" alt=\"image-20220715150723654\"></p>\n</li>\n<li><p>添加域名解析</p>\n</li>\n</ul>\n<p><img src=\"/../../img/image-20220715150801833.png\" alt=\"image-20220715150801833\"></p>\n<ul>\n<li><p>填写域名解析服务器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">PAITYN<span class=\"token punctuation\">.</span>NS<span class=\"token punctuation\">.</span>CLOUDFLARE<span class=\"token punctuation\">.</span>COM\nSYEEF<span class=\"token punctuation\">.</span>NS<span class=\"token punctuation\">.</span>CLOUDFLARE<span class=\"token punctuation\">.</span>COM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<p><img src=\"/../../img/image-20220715150832903.png\" alt=\"image-20220715150832903\"></p>\n<h2 id=\"3-域名解析配置（CDN）\"><a href=\"#3-域名解析配置（CDN）\" class=\"headerlink\" title=\"3 域名解析配置（CDN）\"></a>3 域名解析配置（CDN）</h2><blockquote>\n<p>这里使用cloudflare</p>\n</blockquote>\n<p>添加站点</p>\n<p><img src=\"/../../img/image-20220715151303012.png\" alt=\"image-20220715151303012\"></p>\n<p>选择免费的方案</p>\n<p><img src=\"/../../img/image-20220715151454194.png\" alt=\"image-20220715151454194\"></p>\n<p>添加VPS服务器地址</p>\n<p><img src=\"/../../img/image-20220715151735023.png\" alt=\"image-20220715151735023\"></p>\n<p>校验服务器是否生效：</p>\n<blockquote>\n<p>解析的IP不一致，是因为勾选了”代理“，不影响正常使用</p>\n</blockquote>\n<p><img src=\"/../../img/image-20220715151954505.png\" alt=\"image-20220715151954505\"></p>\n<h2 id=\"4-VPS部署V2Ray\"><a href=\"#4-VPS部署V2Ray\" class=\"headerlink\" title=\"4 VPS部署V2Ray\"></a>4 VPS部署V2Ray</h2><blockquote>\n<p>参考：<a href=\"https://www.ioiox.com/archives/99.html\">https://www.ioiox.com/archives/99.html</a></p>\n</blockquote>\n<h3 id=\"4-1-系统设置\"><a href=\"#4-1-系统设置\" class=\"headerlink\" title=\"4.1 系统设置\"></a>4.1 系统设置</h3><h4 id=\"SSH服务\"><a href=\"#SSH服务\" class=\"headerlink\" title=\"SSH服务\"></a>SSH服务</h4><p>切换至root创建密码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo -i\n# 切换至 root 账号\npasswd\n# 修改密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改ssh配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n# 编辑 sshd_config\n\n添加或修改Port 22222以确保SSH端口安全.\n查找到#PermitRootLogin yes,去掉#注释符号.\n查找到#PasswordAuthentication yes,去掉#注释符号.\n查找到#ClientAliveInterval 0,去掉#注释符号,0改为30.\n查找到#MaxSessions 10,去掉#注释符号.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启ssh服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart sshd\n# 重启 sshd 生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"防火墙\"><a href=\"#防火墙\" class=\"headerlink\" title=\"防火墙\"></a>防火墙</h4><p>关闭防火墙</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop firewalld\nsystemctl disable firewalld<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"修改主机名\"><a href=\"#修改主机名\" class=\"headerlink\" title=\"修改主机名\"></a>修改主机名</h4><blockquote>\n<p>甲骨文云的<code>CentOS 7</code>在使用<code>hostnamectl set-hostname</code>命令修改主机名时,重启服务器后依旧会恢复为 Web 端创建实例时所设置的名字.网上查找了各种方法都无效,最终找到了解决方案.</p>\n</blockquote>\n<p>编辑修改<code>oci-hostname.conf</code>文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;oci-hostname.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将<code>PRESERVE_HOSTINFO=0</code>中的的值<code>0</code>修改为<code>1</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># This configuration file controls the hostname persistence behavior for Oracle Linux\n# compute instance on Oracle Cloud Infrastructure (formerly Baremetal Cloud Services)\n# Set PRESERVE_HOSTINFO to one of the following values\n#   0 -- default behavior to update hostname, &#x2F;etc&#x2F;hosts and &#x2F;etc&#x2F;resolv.conf to \n#        reflect the hostname set during instance creation from the metadata service\n#   1 -- preserve user configured hostname across reboots; update &#x2F;etc&#x2F;hosts and \n#           &#x2F;etc&#x2F;resolv.conf from the metadata service  \n#   2 -- preserve user configured hostname across instance reboots; no custom  \n#        changes to &#x2F;etc&#x2F;hosts and &#x2F;etc&#x2F;resolv.conf from the metadata service,\n#        but dhclient will still overwrite &#x2F;etc&#x2F;resolv.conf\n#   3 -- preserve hostname and &#x2F;etc&#x2F;hosts entries across instance reboots; \n#        update &#x2F;etc&#x2F;resolv.conf from instance metadata service\nPRESERVE_HOSTINFO&#x3D;0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用<code>hostnamectl set-hostname</code>命令修改主机名即可.重启也不会失效.</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">hostnamectl set-hostname xxxxxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"卸载相关程序\"><a href=\"#卸载相关程序\" class=\"headerlink\" title=\"卸载相关程序\"></a>卸载相关程序</h4><h5 id=\"rpcbind\"><a href=\"#rpcbind\" class=\"headerlink\" title=\"rpcbind\"></a>rpcbind</h5><p>使用<code>netstat -ntlp</code>命令发现<code>rpcbind</code>监听了<code>111</code>端口,如担心安全可执行以下命令卸载禁用:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop rpcbind\nsystemctl stop rpcbind.socket\nsystemctl disable rpcbind\nsystemctl disable rpcbind.socket <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"oracle-cloud-agent\"><a href=\"#oracle-cloud-agent\" class=\"headerlink\" title=\"oracle-cloud-agent\"></a>oracle-cloud-agent</h5><p>卸载甲骨文云官方后台监控程序</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop oracle-cloud-agent\nsystemctl disable oracle-cloud-agent\nsystemctl stop oracle-cloud-agent-updater\nsystemctl disable oracle-cloud-agent-updater<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"4-2-安装BBRPlus\"><a href=\"#4-2-安装BBRPlus\" class=\"headerlink\" title=\"4.2 安装BBRPlus\"></a>4.2 安装BBRPlus</h3><blockquote>\n<p>参考：<a href=\"https://www.ioiox.com/archives/63.html\">https://www.ioiox.com/archives/63.html</a></p>\n<p>Oracle VPS部署BBR，按普通的方式安装，将导致BBR安装并重启机器后，服务器失联，需要安装特定的内核，并作一些列设置</p>\n</blockquote>\n<h4 id=\"升级内核\"><a href=\"#升级内核\" class=\"headerlink\" title=\"升级内核\"></a>升级内核</h4><p>更新 yum</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum -y update<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">uname -r\n# 内核版本 3.10.0-1062.12.1.el7.x86_64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>手动下载<code>秋水 BBRPlus</code>版内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;chiakge&#x2F;Linux-NetSpeed&#x2F;master&#x2F;bbrplus&#x2F;centos&#x2F;7&#x2F;kernel-4.14.129-bbrplus.rpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>手动安装内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum -y install kernel-4.14.129-bbrplus.rpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>更新引导</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg\ngrub2-mkconfig -o &#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;centos&#x2F;grub.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>列出系统开机启动项</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo awk -F\\&#39; &#39;$1&#x3D;&#x3D;&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&#39; &#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;centos&#x2F;grub.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>设置新版内核默认启动项</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">grub2-set-default 0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>重启</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">reboot<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"开启-BBRPlus-及优化\"><a href=\"#开启-BBRPlus-及优化\" class=\"headerlink\" title=\"开启 BBRPlus 及优化\"></a>开启 BBRPlus 及优化</h4><p>秋水一键脚本,选择<code>7</code>开启<code>BBRPlus</code>加速.<br>再次<code>./tcp.sh</code>运行脚本,选择<code>10</code>优化并重启完成.</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget -N --no-check-certificate &quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;chiakge&#x2F;Linux-NetSpeed&#x2F;master&#x2F;tcp.sh&quot; &amp;&amp; chmod +x tcp.sh &amp;&amp; .&#x2F;tc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h3 id=\"4-3-安装V2Ray\"><a href=\"#4-3-安装V2Ray\" class=\"headerlink\" title=\"4.3 安装V2Ray\"></a>4.3 安装V2Ray</h3><p>在梯子服务器，执行一键搭建脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">bash &lt;(curl -sL https:&#x2F;&#x2F;gist.githubusercontent.com&#x2F;JodenHe&#x2F;815dd91277b722d36a860d39c2296083&#x2F;raw&#x2F;7f2b5ac0f8137b245d44741fc4a9f40cffa36755&#x2F;v2Ray-install.sh)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../img/image-20220715155109519.png\" alt=\"image-20220715155109519\"></p>\n<p>BBR已经安装过，这里选n （笔者第一次在这选y直接安装BBR，结果服务器重启后失联，没法登录，后采用4.2小节的方式，先安装BBRPlus）</p>\n<p><img src=\"/../../img/image-20220715155122886.png\" alt=\"image-20220715155122886\"></p>\n<p>安装成功，可以使用链接配置V2RayN</p>\n<p><img src=\"/../../img/image-20220715155230097.png\" alt=\"image-20220715155230097\"></p>\n<h2 id=\"5-v2Ray-客户端\"><a href=\"#5-v2Ray-客户端\" class=\"headerlink\" title=\"5 v2Ray 客户端\"></a>5 v2Ray 客户端</h2><p>参考：<a href=\"https://tlanyan.pp.ua/v2ray-clients-download/\">https://tlanyan.pp.ua/v2ray-clients-download/</a></p>\n<p>笔者使用的windows客户端为：<code>V2rayN</code>, 安卓客户端为：<code>V2rayNG</code></p>\n<h2 id=\"6-参考\"><a href=\"#6-参考\" class=\"headerlink\" title=\"6 参考\"></a>6 参考</h2><p><a href=\"https://toutyrater.github.io/\">https://toutyrater.github.io/</a></p>\n<p><a href=\"https://tlanyan.pp.ua/v2ray-clients-download/\">https://tlanyan.pp.ua/v2ray-clients-download/</a></p>\n<p><a href=\"https://baijiahao.baidu.com/s?id=1689185764130254565&amp;wfr=spider&amp;for=pc\">https://baijiahao.baidu.com/s?id=1689185764130254565&amp;wfr=spider&amp;for=pc</a></p>\n<p><a href=\"https://www.ioiox.com/archives/99.html\">https://www.ioiox.com/archives/99.html</a></p>\n<p><a href=\"https://blog.joden123.top/2022/02/20/proxy/v2ray-install/\">https://blog.joden123.top/2022/02/20/proxy/v2ray-install/</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1 前言\"></a>1 前言</h2><p>​\t本文介绍如何使用甲骨文（Oracle）的免费VPS部署V2Ray</p>\n<p>甲骨文服务器申请地址：</p>\n<p><a href=\"https://www.oracle.com/cloud/free/\">https://www.oracle.com/cloud/free/</a></p>\n<blockquote>\n<p>c7 &#x2F; 7q &#x2F; F+</p>\n</blockquote>\n<h2 id=\"2-域名申请\"><a href=\"#2-域名申请\" class=\"headerlink\" title=\"2 域名申请\"></a>2 域名申请</h2><p><font color='red'><strong>！！本节使用Firefox浏览器操作！！</strong></font></p>\n<h3 id=\"2-1-Firefox浏览器Gooreplacer插件设置\"><a href=\"#2-1-Firefox浏览器Gooreplacer插件设置\" class=\"headerlink\" title=\"2.1 Firefox浏览器Gooreplacer插件设置\"></a>2.1 Firefox浏览器Gooreplacer插件设置</h3><blockquote>\n<p>防止freenom在订单提交阶段失败</p>\n</blockquote>\n<p>安装完插件后，点击“配置规则”</p>\n<p><img src=\"/../../img/image-20220715144835831.png\" alt=\"image-20220715144835831\"></p>\n<p>规则配置</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">重定向填写：\nhttps<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span>www<span class=\"token punctuation\">.</span>google<span class=\"token punctuation\">.</span>com<span class=\"token operator\">/</span>recaptcha\n目标地址填写：\nhttps<span class=\"token punctuation\">:</span><span class=\"token operator\">//</span>www<span class=\"token punctuation\">.</span>recaptcha<span class=\"token punctuation\">.</span>net<span class=\"token operator\">/</span>recaptcha<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/../../img/image-20220715145007138.png\" alt=\"image-20220715145007138\"></p>\n<h3 id=\"2-2-freenom域名申请\"><a href=\"#2-2-freenom域名申请\" class=\"headerlink\" title=\"2.2 freenom域名申请\"></a>2.2 freenom域名申请</h3><blockquote>\n<p>freenom可以申请免费的域名，申请地址：</p>\n<p><a href=\"https://www.freenom.com/en/index.html\">https://www.freenom.com/en/index.html</a></p>\n</blockquote>\n<ul>\n<li><p>登录，选择”注册一个新域名”<img src=\"/../../img/image-20220715145353695.png\" alt=\"image-20220715145353695\"></p>\n</li>\n<li><p>输入需要注册的域名名</p>\n</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145306545.png\" alt=\"image-20220715145306545\"></p>\n<ul>\n<li>选择免费域名，加入购物车</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145556778.png\" alt=\"image-20220715145556778\"></p>\n<ul>\n<li>期限修改为12个月</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145640940.png\" alt=\"image-20220715145640940\"></p>\n<ul>\n<li>勾选允许协议，点击完成</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145722733.png\" alt=\"image-20220715145722733\"></p>\n<ul>\n<li>看到此界面，说明申请成功，如果申请失败，回到2.1检查Gooreplacer插件是否配置正常</li>\n</ul>\n<p><img src=\"/../../img/image-20220715145825655.png\" alt=\"image-20220715145825655\"></p>\n<ul>\n<li>查看我的域名</li>\n</ul>\n<p><img src=\"/../../img/image-20220715150619814.png\" alt=\"image-20220715150619814\"></p>\n<ul>\n<li><p>设置域名</p>\n<p><img src=\"/../../img/image-20220715150723654.png\" alt=\"image-20220715150723654\"></p>\n</li>\n<li><p>添加域名解析</p>\n</li>\n</ul>\n<p><img src=\"/../../img/image-20220715150801833.png\" alt=\"image-20220715150801833\"></p>\n<ul>\n<li><p>填写域名解析服务器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">PAITYN<span class=\"token punctuation\">.</span>NS<span class=\"token punctuation\">.</span>CLOUDFLARE<span class=\"token punctuation\">.</span>COM\nSYEEF<span class=\"token punctuation\">.</span>NS<span class=\"token punctuation\">.</span>CLOUDFLARE<span class=\"token punctuation\">.</span>COM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre></li>\n</ul>\n<p><img src=\"/../../img/image-20220715150832903.png\" alt=\"image-20220715150832903\"></p>\n<h2 id=\"3-域名解析配置（CDN）\"><a href=\"#3-域名解析配置（CDN）\" class=\"headerlink\" title=\"3 域名解析配置（CDN）\"></a>3 域名解析配置（CDN）</h2><blockquote>\n<p>这里使用cloudflare</p>\n</blockquote>\n<p>添加站点</p>\n<p><img src=\"/../../img/image-20220715151303012.png\" alt=\"image-20220715151303012\"></p>\n<p>选择免费的方案</p>\n<p><img src=\"/../../img/image-20220715151454194.png\" alt=\"image-20220715151454194\"></p>\n<p>添加VPS服务器地址</p>\n<p><img src=\"/../../img/image-20220715151735023.png\" alt=\"image-20220715151735023\"></p>\n<p>校验服务器是否生效：</p>\n<blockquote>\n<p>解析的IP不一致，是因为勾选了”代理“，不影响正常使用</p>\n</blockquote>\n<p><img src=\"/../../img/image-20220715151954505.png\" alt=\"image-20220715151954505\"></p>\n<h2 id=\"4-VPS部署V2Ray\"><a href=\"#4-VPS部署V2Ray\" class=\"headerlink\" title=\"4 VPS部署V2Ray\"></a>4 VPS部署V2Ray</h2><blockquote>\n<p>参考：<a href=\"https://www.ioiox.com/archives/99.html\">https://www.ioiox.com/archives/99.html</a></p>\n</blockquote>\n<h3 id=\"4-1-系统设置\"><a href=\"#4-1-系统设置\" class=\"headerlink\" title=\"4.1 系统设置\"></a>4.1 系统设置</h3><h4 id=\"SSH服务\"><a href=\"#SSH服务\" class=\"headerlink\" title=\"SSH服务\"></a>SSH服务</h4><p>切换至root创建密码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo -i\n# 切换至 root 账号\npasswd\n# 修改密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改ssh配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n# 编辑 sshd_config\n\n添加或修改Port 22222以确保SSH端口安全.\n查找到#PermitRootLogin yes,去掉#注释符号.\n查找到#PasswordAuthentication yes,去掉#注释符号.\n查找到#ClientAliveInterval 0,去掉#注释符号,0改为30.\n查找到#MaxSessions 10,去掉#注释符号.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启ssh服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart sshd\n# 重启 sshd 生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"防火墙\"><a href=\"#防火墙\" class=\"headerlink\" title=\"防火墙\"></a>防火墙</h4><p>关闭防火墙</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop firewalld\nsystemctl disable firewalld<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"修改主机名\"><a href=\"#修改主机名\" class=\"headerlink\" title=\"修改主机名\"></a>修改主机名</h4><blockquote>\n<p>甲骨文云的<code>CentOS 7</code>在使用<code>hostnamectl set-hostname</code>命令修改主机名时,重启服务器后依旧会恢复为 Web 端创建实例时所设置的名字.网上查找了各种方法都无效,最终找到了解决方案.</p>\n</blockquote>\n<p>编辑修改<code>oci-hostname.conf</code>文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;oci-hostname.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将<code>PRESERVE_HOSTINFO=0</code>中的的值<code>0</code>修改为<code>1</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># This configuration file controls the hostname persistence behavior for Oracle Linux\n# compute instance on Oracle Cloud Infrastructure (formerly Baremetal Cloud Services)\n# Set PRESERVE_HOSTINFO to one of the following values\n#   0 -- default behavior to update hostname, &#x2F;etc&#x2F;hosts and &#x2F;etc&#x2F;resolv.conf to \n#        reflect the hostname set during instance creation from the metadata service\n#   1 -- preserve user configured hostname across reboots; update &#x2F;etc&#x2F;hosts and \n#           &#x2F;etc&#x2F;resolv.conf from the metadata service  \n#   2 -- preserve user configured hostname across instance reboots; no custom  \n#        changes to &#x2F;etc&#x2F;hosts and &#x2F;etc&#x2F;resolv.conf from the metadata service,\n#        but dhclient will still overwrite &#x2F;etc&#x2F;resolv.conf\n#   3 -- preserve hostname and &#x2F;etc&#x2F;hosts entries across instance reboots; \n#        update &#x2F;etc&#x2F;resolv.conf from instance metadata service\nPRESERVE_HOSTINFO&#x3D;0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用<code>hostnamectl set-hostname</code>命令修改主机名即可.重启也不会失效.</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">hostnamectl set-hostname xxxxxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"卸载相关程序\"><a href=\"#卸载相关程序\" class=\"headerlink\" title=\"卸载相关程序\"></a>卸载相关程序</h4><h5 id=\"rpcbind\"><a href=\"#rpcbind\" class=\"headerlink\" title=\"rpcbind\"></a>rpcbind</h5><p>使用<code>netstat -ntlp</code>命令发现<code>rpcbind</code>监听了<code>111</code>端口,如担心安全可执行以下命令卸载禁用:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop rpcbind\nsystemctl stop rpcbind.socket\nsystemctl disable rpcbind\nsystemctl disable rpcbind.socket <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"oracle-cloud-agent\"><a href=\"#oracle-cloud-agent\" class=\"headerlink\" title=\"oracle-cloud-agent\"></a>oracle-cloud-agent</h5><p>卸载甲骨文云官方后台监控程序</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop oracle-cloud-agent\nsystemctl disable oracle-cloud-agent\nsystemctl stop oracle-cloud-agent-updater\nsystemctl disable oracle-cloud-agent-updater<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"4-2-安装BBRPlus\"><a href=\"#4-2-安装BBRPlus\" class=\"headerlink\" title=\"4.2 安装BBRPlus\"></a>4.2 安装BBRPlus</h3><blockquote>\n<p>参考：<a href=\"https://www.ioiox.com/archives/63.html\">https://www.ioiox.com/archives/63.html</a></p>\n<p>Oracle VPS部署BBR，按普通的方式安装，将导致BBR安装并重启机器后，服务器失联，需要安装特定的内核，并作一些列设置</p>\n</blockquote>\n<h4 id=\"升级内核\"><a href=\"#升级内核\" class=\"headerlink\" title=\"升级内核\"></a>升级内核</h4><p>更新 yum</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum -y update<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">uname -r\n# 内核版本 3.10.0-1062.12.1.el7.x86_64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>手动下载<code>秋水 BBRPlus</code>版内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;chiakge&#x2F;Linux-NetSpeed&#x2F;master&#x2F;bbrplus&#x2F;centos&#x2F;7&#x2F;kernel-4.14.129-bbrplus.rpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>手动安装内核</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum -y install kernel-4.14.129-bbrplus.rpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>更新引导</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">grub2-mkconfig -o &#x2F;boot&#x2F;grub2&#x2F;grub.cfg\ngrub2-mkconfig -o &#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;centos&#x2F;grub.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>列出系统开机启动项</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo awk -F\\&#39; &#39;$1&#x3D;&#x3D;&quot;menuentry &quot; &#123;print i++ &quot; : &quot; $2&#125;&#39; &#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;centos&#x2F;grub.cfg<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>设置新版内核默认启动项</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">grub2-set-default 0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>重启</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">reboot<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"开启-BBRPlus-及优化\"><a href=\"#开启-BBRPlus-及优化\" class=\"headerlink\" title=\"开启 BBRPlus 及优化\"></a>开启 BBRPlus 及优化</h4><p>秋水一键脚本,选择<code>7</code>开启<code>BBRPlus</code>加速.<br>再次<code>./tcp.sh</code>运行脚本,选择<code>10</code>优化并重启完成.</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget -N --no-check-certificate &quot;https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;chiakge&#x2F;Linux-NetSpeed&#x2F;master&#x2F;tcp.sh&quot; &amp;&amp; chmod +x tcp.sh &amp;&amp; .&#x2F;tc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h3 id=\"4-3-安装V2Ray\"><a href=\"#4-3-安装V2Ray\" class=\"headerlink\" title=\"4.3 安装V2Ray\"></a>4.3 安装V2Ray</h3><p>在梯子服务器，执行一键搭建脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">bash &lt;(curl -sL https:&#x2F;&#x2F;gist.githubusercontent.com&#x2F;JodenHe&#x2F;815dd91277b722d36a860d39c2296083&#x2F;raw&#x2F;7f2b5ac0f8137b245d44741fc4a9f40cffa36755&#x2F;v2Ray-install.sh)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../img/image-20220715155109519.png\" alt=\"image-20220715155109519\"></p>\n<p>BBR已经安装过，这里选n （笔者第一次在这选y直接安装BBR，结果服务器重启后失联，没法登录，后采用4.2小节的方式，先安装BBRPlus）</p>\n<p><img src=\"/../../img/image-20220715155122886.png\" alt=\"image-20220715155122886\"></p>\n<p>安装成功，可以使用链接配置V2RayN</p>\n<p><img src=\"/../../img/image-20220715155230097.png\" alt=\"image-20220715155230097\"></p>\n<h2 id=\"5-v2Ray-客户端\"><a href=\"#5-v2Ray-客户端\" class=\"headerlink\" title=\"5 v2Ray 客户端\"></a>5 v2Ray 客户端</h2><p>参考：<a href=\"https://tlanyan.pp.ua/v2ray-clients-download/\">https://tlanyan.pp.ua/v2ray-clients-download/</a></p>\n<p>笔者使用的windows客户端为：<code>V2rayN</code>, 安卓客户端为：<code>V2rayNG</code></p>\n<h2 id=\"6-参考\"><a href=\"#6-参考\" class=\"headerlink\" title=\"6 参考\"></a>6 参考</h2><p><a href=\"https://toutyrater.github.io/\">https://toutyrater.github.io/</a></p>\n<p><a href=\"https://tlanyan.pp.ua/v2ray-clients-download/\">https://tlanyan.pp.ua/v2ray-clients-download/</a></p>\n<p><a href=\"https://baijiahao.baidu.com/s?id=1689185764130254565&amp;wfr=spider&amp;for=pc\">https://baijiahao.baidu.com/s?id=1689185764130254565&amp;wfr=spider&amp;for=pc</a></p>\n<p><a href=\"https://www.ioiox.com/archives/99.html\">https://www.ioiox.com/archives/99.html</a></p>\n<p><a href=\"https://blog.joden123.top/2022/02/20/proxy/v2ray-install/\">https://blog.joden123.top/2022/02/20/proxy/v2ray-install/</a></p>\n"},{"title":"长城TD120A2安装OpenEuler","date":"2022-07-11T01:29:52.000Z","_content":"\n>记录安装过程\n\n### 一、环境\n\n|          | 型号            |\n| -------- | --------------- |\n| CPU      | 飞腾D2000/8核   |\n| 内存     | 紫光DDR4 3200   |\n| 显卡     | AMD RX520       |\n| 安装系统 | OpenEuler 20.09 |\n\n### 二、OpenEuler安装\n\n1、镜像准备：\n\n```she\nopenEuler-20.09-aarch64-dvd.iso\n```\n\n2、制作启动盘\n\n```shell\n使用win32diskimager制作U盘启动器\n```\n\n3、安装\n\n```shell\n进入安装界面：\nInstall openEuler 20.09...\nTest this media & install openEuler 20.09...\nTroubleshooting\n\n选择到Install openEuler 20.09...行\nCtrl + e 进入编辑界面\n删除\"video=efifb:off\"\nCtrl + x 保存并退出，进入图形化安装界面\n```\n\n>为什么要删除此grub参数？ ---直接安装将卡在此界面\n>\n>EFI stub: Booting Linux Kernel...\n>\n>EFI stub: EFI_RNG_PROTOCOL unavaliable, no randomness supplied\n>\n>EFI stub: Using DTB from configuration table\n>\n>EFT stub: Exiting boot services and installing virtual address map...\n\n4、启动系统\n\n```shell\n进入系统后，修改/boot/efi/EFI/openEuler/grub.cfg文件\n同样，将\"video=efifb:off\"注释或者删除\n>>防止重启卡在引导界面\n```\n\n5、无线网卡连接wifi\n\n>TD120A2安装OpenEuler后,有线网卡无法识别，需要安装USB无线网卡，并安装配套的驱动，无线网卡识别后可以连接wifi\n\n```shell\nnmcli dev wifi # 查询wifi\nnmcli dev wifi connet 网络名 password 密码\n```\n\n6、图形化界面安装\n\n```shell\nsudo dnf makecache\nsudo dnf groupinstall ukui\nsystemctl set-default graphical\n```","source":"_posts/04_杂记/长城TD120A2安装OpenEuler.md","raw":"---\ntitle: 长城TD120A2安装OpenEuler\ndate: 2022-07-11 9:29:52\ncategories:\n- 杂记\ntags:\n---\n\n>记录安装过程\n\n### 一、环境\n\n|          | 型号            |\n| -------- | --------------- |\n| CPU      | 飞腾D2000/8核   |\n| 内存     | 紫光DDR4 3200   |\n| 显卡     | AMD RX520       |\n| 安装系统 | OpenEuler 20.09 |\n\n### 二、OpenEuler安装\n\n1、镜像准备：\n\n```she\nopenEuler-20.09-aarch64-dvd.iso\n```\n\n2、制作启动盘\n\n```shell\n使用win32diskimager制作U盘启动器\n```\n\n3、安装\n\n```shell\n进入安装界面：\nInstall openEuler 20.09...\nTest this media & install openEuler 20.09...\nTroubleshooting\n\n选择到Install openEuler 20.09...行\nCtrl + e 进入编辑界面\n删除\"video=efifb:off\"\nCtrl + x 保存并退出，进入图形化安装界面\n```\n\n>为什么要删除此grub参数？ ---直接安装将卡在此界面\n>\n>EFI stub: Booting Linux Kernel...\n>\n>EFI stub: EFI_RNG_PROTOCOL unavaliable, no randomness supplied\n>\n>EFI stub: Using DTB from configuration table\n>\n>EFT stub: Exiting boot services and installing virtual address map...\n\n4、启动系统\n\n```shell\n进入系统后，修改/boot/efi/EFI/openEuler/grub.cfg文件\n同样，将\"video=efifb:off\"注释或者删除\n>>防止重启卡在引导界面\n```\n\n5、无线网卡连接wifi\n\n>TD120A2安装OpenEuler后,有线网卡无法识别，需要安装USB无线网卡，并安装配套的驱动，无线网卡识别后可以连接wifi\n\n```shell\nnmcli dev wifi # 查询wifi\nnmcli dev wifi connet 网络名 password 密码\n```\n\n6、图形化界面安装\n\n```shell\nsudo dnf makecache\nsudo dnf groupinstall ukui\nsystemctl set-default graphical\n```","slug":"04_杂记/长城TD120A2安装OpenEuler","published":1,"updated":"2022-07-11T05:37:33.685Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k08000ba8v780bo9cya","content":"<blockquote>\n<p>记录安装过程</p>\n</blockquote>\n<h3 id=\"一、环境\"><a href=\"#一、环境\" class=\"headerlink\" title=\"一、环境\"></a>一、环境</h3><table>\n<thead>\n<tr>\n<th></th>\n<th>型号</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CPU</td>\n<td>飞腾D2000&#x2F;8核</td>\n</tr>\n<tr>\n<td>内存</td>\n<td>紫光DDR4 3200</td>\n</tr>\n<tr>\n<td>显卡</td>\n<td>AMD RX520</td>\n</tr>\n<tr>\n<td>安装系统</td>\n<td>OpenEuler 20.09</td>\n</tr>\n</tbody></table>\n<h3 id=\"二、OpenEuler安装\"><a href=\"#二、OpenEuler安装\" class=\"headerlink\" title=\"二、OpenEuler安装\"></a>二、OpenEuler安装</h3><p>1、镜像准备：</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">openEuler-20.09-aarch64-dvd.iso<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、制作启动盘</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">使用win32diskimager制作U盘启动器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">进入安装界面：\nInstall openEuler 20.09...\nTest this media &amp; install openEuler 20.09...\nTroubleshooting\n\n选择到Install openEuler 20.09...行\nCtrl + e 进入编辑界面\n删除&quot;video&#x3D;efifb:off&quot;\nCtrl + x 保存并退出，进入图形化安装界面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>为什么要删除此grub参数？ —直接安装将卡在此界面</p>\n<p>EFI stub: Booting Linux Kernel…</p>\n<p>EFI stub: EFI_RNG_PROTOCOL unavaliable, no randomness supplied</p>\n<p>EFI stub: Using DTB from configuration table</p>\n<p>EFT stub: Exiting boot services and installing virtual address map…</p>\n</blockquote>\n<p>4、启动系统</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">进入系统后，修改&#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;openEuler&#x2F;grub.cfg文件\n同样，将&quot;video&#x3D;efifb:off&quot;注释或者删除\n&gt;&gt;防止重启卡在引导界面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>5、无线网卡连接wifi</p>\n<blockquote>\n<p>TD120A2安装OpenEuler后,有线网卡无法识别，需要安装USB无线网卡，并安装配套的驱动，无线网卡识别后可以连接wifi</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nmcli dev wifi # 查询wifi\nnmcli dev wifi connet 网络名 password 密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>6、图形化界面安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo dnf makecache\nsudo dnf groupinstall ukui\nsystemctl set-default graphical<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>记录安装过程</p>\n</blockquote>\n<h3 id=\"一、环境\"><a href=\"#一、环境\" class=\"headerlink\" title=\"一、环境\"></a>一、环境</h3><table>\n<thead>\n<tr>\n<th></th>\n<th>型号</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CPU</td>\n<td>飞腾D2000&#x2F;8核</td>\n</tr>\n<tr>\n<td>内存</td>\n<td>紫光DDR4 3200</td>\n</tr>\n<tr>\n<td>显卡</td>\n<td>AMD RX520</td>\n</tr>\n<tr>\n<td>安装系统</td>\n<td>OpenEuler 20.09</td>\n</tr>\n</tbody></table>\n<h3 id=\"二、OpenEuler安装\"><a href=\"#二、OpenEuler安装\" class=\"headerlink\" title=\"二、OpenEuler安装\"></a>二、OpenEuler安装</h3><p>1、镜像准备：</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">openEuler-20.09-aarch64-dvd.iso<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、制作启动盘</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">使用win32diskimager制作U盘启动器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">进入安装界面：\nInstall openEuler 20.09...\nTest this media &amp; install openEuler 20.09...\nTroubleshooting\n\n选择到Install openEuler 20.09...行\nCtrl + e 进入编辑界面\n删除&quot;video&#x3D;efifb:off&quot;\nCtrl + x 保存并退出，进入图形化安装界面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>为什么要删除此grub参数？ —直接安装将卡在此界面</p>\n<p>EFI stub: Booting Linux Kernel…</p>\n<p>EFI stub: EFI_RNG_PROTOCOL unavaliable, no randomness supplied</p>\n<p>EFI stub: Using DTB from configuration table</p>\n<p>EFT stub: Exiting boot services and installing virtual address map…</p>\n</blockquote>\n<p>4、启动系统</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">进入系统后，修改&#x2F;boot&#x2F;efi&#x2F;EFI&#x2F;openEuler&#x2F;grub.cfg文件\n同样，将&quot;video&#x3D;efifb:off&quot;注释或者删除\n&gt;&gt;防止重启卡在引导界面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>5、无线网卡连接wifi</p>\n<blockquote>\n<p>TD120A2安装OpenEuler后,有线网卡无法识别，需要安装USB无线网卡，并安装配套的驱动，无线网卡识别后可以连接wifi</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nmcli dev wifi # 查询wifi\nnmcli dev wifi connet 网络名 password 密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>6、图形化界面安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo dnf makecache\nsudo dnf groupinstall ukui\nsystemctl set-default graphical<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>"},{"title":"测试工具使用说明-完善中","date":"2022-07-06T03:19:52.000Z","_content":"\n# 测试工具使用说明-汇总\n\n# 一、SPEC CPU 2017 测试\n\n## 1.1 概述\n\n​\t标准性能评测机构（SPEC）开发的用于评测CPU性能的基准程序测试组，是一套CPU子系统测试工具。处理器、内存和编译都会影响最终的测试结果，目前SPEC CPU是业界首选的CPU评测工具。 \n\n## 1.2 工具安装\n\n获取镜像包：\n\n​\tcpu2017-1_0_5.iso\n\n挂载IOS\n\n```shell\nmount -o loop -t iso9660 cpu2017-1_0_5.iso /xxx/cpu2017CD\n```\n\n安装工具\n\n```shell\ncd /xxx/cpu2017CD\n./install.sh\n```\n\n## 1.3 测试步骤\n\nspec2017主要分为四项测试：\n\n- ​\tintrate\n- ​\tfprate\n- ​\tintspeed\n- ​\tfpspeed\n\n​\t根据需要测试的cpu型号，可以到官网下载相应的cfg文件，修改icc、Jemalloc库、qkmalloc库的路径，放入config文件夹中。\n\n测试命令如下：\n\n```shell\nsource shrc\nulimit -s unlimited\n# speed 测试\nruncpu --config=icc-speed-official.cfg --threads=48 --define cores=48 -n 3 -i ref fpspeed intspeed\n\n# rate 测试\nruncpu --config=icc-rate-official.cfg -copies=48 -n 3 -i ref intrate fprate\n\n-----------------------------------------------------------------------\n\n# 仅编译不跑测试\n--action=build\n# 重新编译\n--rebuild\n# 绑核跑\ntaskset -c \n```\n\n## 1.4 测试优化\n\n>Bios设置：\n>\n>​\t开启超线程\n>\n>​\t 尝试开启LLC-PREFETCH\n\n## 1.5 其他事项：\n\n```shell\ncfg文件中的submit可以设置绑核选项\n```\n\n# 二、SPEC CPU 2006 测试\n\n## 2.1 概述\n\n​\t作用同Spec CPU 2017, 近年来逐渐被淘汰\n\n## 2.2 测试步骤\n\n1、spec2006.tgz 解压，使用install.sh安装\n\n```shell\nSPEC CPU2006 Installation\nTop of the CPU2006 tree is '/vol8/tarball/cpu2006'\nThese appear to be valid toolsets:\nft-spec2006-tool\naarch64-linux\nEnter the architecture you are using:\n>> aarch64-linux\n```\n\n```shell\nsource shrc\n# 单核测试\nrunspec -c linux64-arm64-gcc52.cfg -i ref -n 3 -I all \n# 多核测试（16）\nrunspec -c linux64-arm64-gcc52.cfg -r 16 -n 3 -i ref -I all\n```\n\n# 三、 SPEC OMP 2012 测试\n\n## 3.1 概述\n\n​\t基于SPEC测试套件的OpenMP评测工具，其中包含15个基于OpenMP的并行程序。\n\n## 3.2 工具安装\n\n​\t获取源包：\n\n​\t\tomp2012-1.1.zip\n\n​\t解压后使用install.sh安装\n\n```shell\n# 安装\n./install.sh -d /home/xx\n# 仅编译\nrunspec --action=build --config=gcc.cfg -i ref -I all\n```\n\n## 3.3 测试步骤\n\n```shell\nsource shrc\nulimit -s unlimited\nexport OMP_NUM_THREADS=48\nrunspec --config=gcc.cfg --threads 48 -n 3 -i ref -I all\n```\n\n# 四、NPB 测试\n\n## 4.1 概述\n\n​\tNAS并行基准测试程序（NPB），是由美国航空航天局开发的一套代表流体动力学计算的应用程序集，它已经成为公认的用于测评大规模并行机和超级计算机的标准测试程序。NPB可用于常用的编程模型，如MPI和OpenMP。\n\n## 4.2 工具安装\n\n源包获取：\n\n​\tNPB3.4.tar.gz         OpenMP || MPICH\n\n​\tNPB3.4-MZ.tar.gz  OpenMP && MPICH\n\n解压即可。\n\n## 4.3 测试步骤\n\n```shell\nmake suite\ncd bin\nmpirun -np 4 ./xxx\n```\n\n# 五、Stream 测试\n\n## 5.1 概述\n\n​\tSTREAM是一套综合性能测试程序集，通过fortran和C两种高级且高效的语言编写完成，由于这两种语言在数学计算方面的高效率， 使得 STREAM 测试例程可以充分发挥出内存的能力。Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。\n\n## 5.2 工具安装\n\n源包获取：\n\n​\tstream.tgz  刘新娃修改过\n\n​\t<font color='red'>Intel平台请用ICC</font>\n\n解压后编译stream.c, 生成可执行文件\n\n```shell\nicc -O3 -fopenmp -DNTIMES=10 -mcmodel=large -o stream_c stream.c\n```\n\n没有修改过的怎么编译呢？\n\n```shell\nicc -mtune=native -march=native -O3 -mcmodel=large -fopenmp -DSTREAM_ARRAY_SIZE=100000000 -DNTIMES=30 -DOFFSET=512 stream.c -o stream-gs\n```\n\n## 5.3 测试步骤\n\n```shell\nexport OMP_NUM_THREADS=48/32/16/8/4  # 设置每个进程的线程数\n./stream_c 200000 # 使用200G内存\n```\n\n## 5.4 其他事项\n\n>`STREAM_ARRAY_SIZE`即`N`指定计算中a[],b[],c[]三个数组的大小，且数组的值采用了双精度（8个字节）。数组的维数 N定义时需要注意以下几点：\n>\n>一、要充分考虑内存容量的需求，粗略估计是 N× 8（双精度浮点类型） × 3 （三个数组）<= 0.6*M；M 是用户的可用内存。\n>\n>二、要保证测试过程中，使用到的内存容量要大于处理器内的缓存，只有这样才会有内存的操作，而不仅仅是对处理器内缓存的操作。\n>\n>三、为了保证测试可以持续一段时间，测试过程中内存带宽可以达到一定的最大值， 从而避免得不到实际最大峰值的情况，如果四项测试中有完成时间小于20微秒的情况，就需要适当的增大测试数组的维度 N。\n\n# 六、Linpack 测试\n\n## 6.1 概述\n\n​\tLinpack是国际上使用最广泛的测试高性能计算机系统浮点性能的基准测试。通过对高性能计算机采用高斯消元法求解一元 N次稠密线性代数方程组的测试，评价高性能计算机的浮点计算性能。Linpack的结果按每秒浮点运算次数（flops）表示。\n\n```shell\n N ^ 2 * 8 = 总内存\n```\n\n## 6.2 工具安装\n\n源包获取：\n\n​\tlinpack.tgz\n\n解压即可。\n\n## 6.3 测试步骤\n\n```shell\n# 1进48线100G内存\n./xhpl -n 1 -b 384 -p 1 -q 1 -m 100000\n# 1进48线200G内存\n./xhpl -n 1 -b 384 -p 1 -q 1 -m 200000\n# 2进24线共100G内存\nmpirun -n 2 ./xhpl -b 384 -p 1 -q 2 -m 50000\n# 2进24线共200G内存\nmpirun -n 2 ./xhpl -b 384 -p 1 -q 2 -m 100000\n```\n\n用mpirun提交xhplrun.sh效果更好\n\n```shell\nPRO_SIZE=${PMI_SIZE}\nthreads=`echo ${Cores}/${PMI_SIZE} | bc`\nPMI_RANK_my=${PMI_RANK}\n```\n\n## 6.4 测试优化（重点）\n\n>一、计算理论内存总带宽\n>\n>```shell\n>计算方法：\n>查看内存带宽：\n>dmidecode | grep -A 16 \"Memory Device\"\n>例如内存信息为：\n>三星 DDR4 \n>16G 每根\n>2666 MT/s（Mhz）\n>查看cpu支持的通道数，例如intel 6252N支持6通道，两个CPU支持12通道\n>理论带宽计算DDR4：\n>单条内存带宽 = 内存核心频率 x 内存总线位数 x 倍增系数\n>\t = 2666 * 64 / 8 = 21328 MB/s = 21.3G/s\n>12通道总内存带宽 = 21328 * 12 = 255936 = 250G/s\n>```\n>\n>二、使用stream测试实际内存总带宽\n>\n>​\t如果可以达到90%或以上，说明内存带宽正常, 继续Linpack测试\n>\n>三、计算CPU理论峰值\n>\n>```shell\n>计算方法：\n>\tMhz * 每个时钟周期执行浮点运算的次数 * CPU数目\n>=\n>\t2.3 x ( 8 x 2 x 2 ) x 48 = 3532.8 Gflops\n>说明：\n>\t峰值计算分为单精度和双精度浮点运算\n>单精度：\n>\t32bit的指令长度的运算，对应32位操作系统\n>双精度：\n>\t64bit的指令长度的运算，对应64位操作系统\n>查找CPU可以处理什么样的指令集：\n>\t例如Intel官网查到Intel Xeon 6252N\n>\t支持AVX-512，\n>\t# of AVX-512 FMA Units = 2\n>\t(Fused Multiply Add instructions) 融合了 乘法 和 加法\n>\t即可以单个周期同时执行2条512bit的加法和2条512bit的乘法\n>理解上述两个概念，可以开始计算（CPU单周期浮点计算能力）\n>Intel 6252N (支持avx512，有512位)\n>单精度：\n>\t2.3 x 512/32 x 2 x 2 = 147.2Gflops \n>双精度\n>\t2.3 x 512/64 x 2 x 2 = 73.6Gflops\n>双精度共48核\n>\t74.6 x 48 = 3580\n>\t\n>FT2000+ 和 FT1500A (只有128位)，FT3000加入sve指令集(128-256位)\n>单精度： \n>\t2.2 x 128/32 * 2 = 4.4\n>双精度:\n>\t2.2 x 128/64 * 2 = 8.8\n>双精度共64核\n>\t8.8 x 64 = 563.2\n>```\n>\n>四、使用Linapack测试CPU实际峰值\n>\n>```shell\n>如果性能达到理论峰值的70%说明正常，如果未达到尝试以下优化\n>```\n>\n>```shell\n>1、使用mpirun运行xhpl, 按`lscpu` 中的NUMA分组绑定,`比如48核，分为两个Numa Node`, 则用mpirun`跑两个xhpl进程`，每个进程使用 OMP_NUM_THREADS=24, 跑24线程，这样可以将核用满。\n>在`Intel`平台，两个进程分别使用 HPL_HOST_CORE='0-23' 以及 HPL_HOST_CORE='24-47' 绑定核\n>在`Arm64`平台，则使用 GOMP_CPU_AFFINITY='0-23' 以及 GOMP_CPU_AFFINITY='24-47' 绑定\n>2、内存不用分配太大，根据stream测试结果分配，从小开始测\n>3、Intel平台编译器使用ICC，测试linpack使用icc自带的linpack，mpi使用icc自带的\n>4、Bios中关闭超线程，开启超频(turbo/P-state)\n>```\n>\n>**<font color=\"blue\">先测stream,判断带宽是否正常，再测linpack，然后再测Spec Cpu</font>**\n\n```shell\n# Intel平台可以使用的控制频率的命令\ncpupower -c all frequency-set -g performance\ncpupower -c 0-95 frequency-set -g userspace\ncpupower -c 0-95 frequency-set -f 2700000\n\n# 查看当前频率控制是否为perfomance？\ncat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor\n\n# 跑xhpl之前设置指令集，或许有用\nexport MKL_ENABLE_INSTRUCTIONS=AVX512\n```\n\n![image-20200415171716940](G:\\工作\\2020年3月\\CN9性能测试\\测试组合.png)\n\n## 6.5 HPL.dat修改\n\n```shell\n# 第1-2行，注释说明行\nHPLinpack benchmark input file   \nInnovative Computing Laboratory, University of Tennessee  \n\n# 第 3-4 行，输出结果文件的形式\nHPL.out      output file name (if any)  \n6            device out (6=stdout,7=stderr,file) \n\n# 5-6行，求解矩阵的大小\n1            # of problems sizes (N)  \n1000         Ns   \n\n# 7-8行 求解矩阵分块的大小\n1            # of NBs\n192 256      NBs\n\n# 9行 处理器阵列的排列方式，行还是列\n0：适用于节点较少，单个节点CPU较多的胖系统\n1：适用于节点较多，单个节点CPU较少的瘦系统（机群上远好于按行排列）\n1            PMAP process mapping (0=Row-,1=Column-major) \n\n# 10-12行 定义二维处理网格P/Q\n# P X Q = 进程数，P尽量小于Q\n# P=2^n,P最好选择2的幂\n1            # of process grids (P x Q) \n1 2          Ps\n1 2          Qs\n\n# 13行 设置阀值，不用修改\n16.0         threshold\n\n# 14-21行 设置L的分解方式\n1            # of panel fact\n2 1 0        PFACTs (0=left, 1=Crout, 2=Right) # 对性能影响不大\n1            # of recursive stopping criterium\n4 8          NBMINs (>= 1)   # 4或8都不错\n1            # of panels in recursion\n2            NDIVs  # 选2比较理想\n1            # of recursive panel fact.\n1 0 2        RFACTs (0=left, 1=Crout, 2=Right) # 对性能影响不大\n\n# 22-23行 设置L的横向广播方式\n# 前四种，适用于快速网络，后两种适用于速度较慢的网络\n# 小规模系统，选择0/1，大规模系统选择3\n1            # of broadcast\n0            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)\n\n# 24-25行 设置横向通信的通信深度\n# 小规模系统选择1/2，大规模系统2-5之间\n1            # of lookahead depth\n1            DEPTHs (>=0)\n\n# 26-27 设置U的广播算法\n# 小规模系统，使用缺省值即可\n0            SWAP (0=bin-exch,1=long,2=mix)\n1            swapping threshold\n\n# 28-29行 L和U的数据存放格式\n0：按列存放\n1：按行存放\n0            L1 in (0=transposed,1=no-transposed) form\n0            U  in (0=transposed,1=no-transposed) form\n\n# 30-31 缺省值即可\n0            Equilibration (0=no,1=yes)\n8            memory alignment in double (> 0)\n\n```\n\n## 6.6 测试脚本编写\n\n### 6.6.1 本地mpirun测试脚本（Intel版本）\n\n```shell\n# 本地单节点测试，需要根据`lscpu`中numa分区情况(node)的使用mpirun测试xhpl\n# eg:在未开超线程的情况下，分为两个node，每个node中有12个核，则最佳测试方法为mpirun -np 2 ./myrun.sh\n# 以下为myrun.sh的具体实现\n\n#!/bin/bash\nulimit -s unlimited\nCores=48\nThreadsNum=`echo \"${Cores}/${PMI_SIZE}\" | bc` # 计算每个进程跑的线程数\ncase ${PMI_SIZE} in\n2)\n        case ${PMI_RANK} in\n        0)\n        export OMP_NUM_THREADS=${ThreadsNum}\n        export HPL_HOST_CORE='0-23'\n        ./xhpl -n 1 -b 384 -p ${1} -q ${2} -m ${3}\n        ;;\n        1)\n        export OMP_NUM_THREADS=${ThreadsNum}\n        export HPL_HOST_CORE='24-47'\n        ./xhpl -n 1 -b 384 -p ${1} -q ${2} -m ${3}\n        ;;\n        esac\n;;\nesac\n\n```\n\n## 6.6.2 Slurm srun测试脚本(FT版本)\n\nxhplrun.sh\n\n```shell\n#!/bin/bash\nulimit -s unlimited\nCores=48\n\n\n==================================================================\nPMI_SIZE=$SLURM_NPROCS\nPMI_RANK=$SLURM_PROCID\nMPI_NUM_NODE=$SLURM_NNODES\nMPI_PER_NODE=$((PMI_SIZE / MPI_NUM_NODES))\nMPI_RANK_FOR_NODE=$((PMI_RANK % MPI_PER_NODE))\n\nPRO_SIZE=${MPI_PER_NODE}\nPMI_RANK_my=${MPI_RANK_FOR_NODE}\n==================================================================\n\necho ${PRO_SIZE} ${PMI_RANK_my} ${threads} ${PMI_SIZE} ${PMI_RANK} ${MPI_NUM_NODES} ${MPI_PER_NODE} ${MPI_RANK_FOR_NODE}\n\nexport HPL_CMDLINE=1\ncase ${PRO_SIZE} in\n1)\n#numactl -i 0-1 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0,4 -N 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\ncase ${PMI_RANK_my} in\n0)\n#numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-31'\nnumactl -i 4-7 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\n#numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-63'\nnumactl -i 0-3 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3} : -n 1 numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n```\n\nyhrun 提交作业 runpro.sh\n\n```shell\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE=1\n\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:$LD_LIBRARY_PATH\n\nnodes=${1}\nnnodes=${2}\nnprocs=${3}\nnmem=${4}\nlogdir=${5}\n\n\nmkdir -p ${logdir}\n\ntnprocs=$((${nnodes}*${nprocs}))\nP=1\nQ=1\nfor i in `seq 1 ${tnprocs}`\ndo\n        for j in `seq 1 ${tnprocs}`\n        do\n                PQ=$((${i}*${j}))\n                if [ ${PQ} -eq ${tnprocs} ] && [ ${i} -le ${j} ]\n                then\n                        P=${i}\n                        Q=${j}\n                fi\n        done\ndone\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        scp HPL.dat $i:/root/linpack &\ndone\nwait\nsleep 1\n\nj=0\nrunnodes=''\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        runnodes+=${i},\n        let j++\n        if [ ${j} -eq ${nnodes} ]\n        then\n                echo \"yhrun -p all -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\"\n                echo ${runnodes} &>> ${logdir}/${i}.log\n                yhrun -p all -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\n                j=0\n                runnodes=''\n        fi\ndone\n```\n\n## 6.7 Bios设置\n\n````shell\n琦哥的：\n    UPI Configuration\n        Link Lop -> disable\n        Link L1  -> disable \n        IO Directory Cache -> enable\n        Isoc Mode -> enable\n\n    Memory Configuration\n        Eufsrce POR -> enable\n        PPR Type -> Soft PPR\n        Memory Frequency -> 2666\n        Data Scrambling for NVMDIMM -> enable\n        Data Scrambling for DDR4 -> enable\n        Enable AOR -> enable\n        Refresh Option -> enable\n        Memory RAS\n            Memory Rank Sparing -> enable\n\n    IIO Configuration\n        PCI-E Port Max Payload Size -> 256B\n\n    CPU P-State\n        SpeedStep -> disable/enable?\n        PBF \n        Hardware P-State -> enable\n        Package c state -> No limit \n\t\n网上找的系统Bios设置优化\n    关闭超线程\n    打开EIST\n    打开Turbo Mode\n    Boot Performance mode设置为max performance\n    Energy Performance BIAS设置为Performance\n    打开Monitor/Mwait\n    Package C stat limit设置为C0/C1 state\n    关闭CPU C3 report\n    关闭CPU C6 report\n    关闭Enhanced Halt State\n    关闭Intel VT for Directed I/O\n    Linux OS下CPU Power Management设置为max performance\n    QPI及Memory Frequency保持为Max Frequency\n    关闭NUMA功能 \n````\n\n## 6.8 <span id=\"jump\">结果反馈</span>\n\n```shell\n#linpack测试以我们为主导\n\n1、grep FAILED 关键字,查看是否有节点计算错误\n2、grep WR 查看节点性能是否正常\n3、统计跑死的点\n\n# 如何反馈？\n一轮Linpack40分钟测试完成\n\t一、6个点本是drain*状态\n\t二、3个点跑死，cn[1,2,3]\n\t三、5个点Linpack计算FAILED\n\t四、其他点linpakc性能正常\n可以考虑更换下一批\n```\n\n## 6.9 风冷系统linpack测试全过程记录\n\n>##### 1、了解风冷系统的架构\n>\n>按批次测试，测完一批换下一批\n>\n>一批为192个节点，每个框32个节点，共6个框\n>\n>每个节点128G内存，芯片为FT2000+, 通过mhz获取频率为2000（降频），64物理核\n>\n>系统版本： 4.19.46-cn+\n>\n>##### 2、计算每个节点的理论峰值\n>\n>2000 * 128 / 64 * 2 * 64= 512000\n>\n>##### 3、开始测试\n>\n>runpro.sh脚本参数说明:\n>\n>```shell\n>./runpro.sh NodeList NodeBind ProcessesPerNode MemSize\n>NodeList 节点列表,例如cn[0-8]\n>NodeBind 几个节点绑定运行，例如2，则计算效率时，需要将结果得到的效率/2/512\n>ProcessesPerNode 每给节点运行几个xhpl进程，根据numa node来，FT一般是8\n>MemSize 每个节点中，每个进程分配的内存，一般使用到约总内存的80%，例如单节点128G，填写12000（单位为Mb），则总使用96G内存\n>```\n>\n>单节点测试：\n>\n>​\t不需要互联测试网络联通性，仅对单节点进行压力测试\n>\n>```shell\n>./runpro.sh cn0 1 8 12000 logdir\n>```\n>\n>多节点测试：\n>\n>​\t需要互联测试网络联通性， 2，4， 8， 16， 32， 64， 128，如果要求测多节点稳定性，测试的8点8进8线，结果按[章节6.8](#jump)反馈\n>\n>```shell\n>./runpro.sh cn0 1 8 12000 logdir\n>```\n>\n>问题解决一：\n>\n>​\t测试到128节点，性能异常，效率仅有43%\n>\n>互联那边回应：\n>\n>​\t节点数超过64，通信就跨框\n>\n>琦哥建议的做法：\n>\n>​\t把128个节点分到4个框，测试一下，看是不是带宽的原因\n>\n>最后的解决方法：\n>\n>​\t网络拓扑更换，矩阵值不能相等，使用原本32 x 32，改为16 x 64，但是换成160节点后还是有问题\n>\n>```shell\n>./runpro.sh cn[xx-xx] 128 8 12000 dir\n>其中执行的xhplrun.sh的参数为\n>xhplrun.sh 32 32 12000\n>```\n>\n>\n\n# 七、Lmbench 测试\n\n## 7.1 概述\n\n​\tLmbench是一套简易，可移植的，符合ANSI/C标准为UNIX/POSIX而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。LmBench旨在使系统开发者深入了解关键操作的基础成本。\n\n## 7.2 工具安装\n\n获取源包：\n\n​\tlmbench3.tar.gz\n\ngcc编译安装\n\n## 7.3 测试步骤\n\n```shell\ncd src\nmake results\nmake see\n内存10G。\n```\n\n```shell\n错误处理：\n[root@cn9 lmbench3]# cd src/\n[root@cn9 src]# make results\ngmake[1]: Entering directory `/home/testcpu/test652/tools/lmbench3/src'\ngmake[1]: *** No rule to make target `../SCCS/s.ChangeSet', needed by `bk.ver'.  Stop.\ngmake[1]: Leaving directory `/home/testcpu/test652/tools/lmbench3/src'\n解决方法：\n\tvim Makefile\n\t231行修改：\n\t$O/lmbench : ../scripts/lmbench bk.ver\n\t改为\n\t$O/lmbench : ../scripts/lmbench\n```\n\n# 八、IOR 测试（暂无）\n\n# 九、alltoall测试\n\n```shell\nyhrun -n 128 -N 8 -w cn34,cn35,cn36,cn37,cn38,cn39,cn40,cn41, /root/xm_alltoall 102400 1000\n```\n\n# 附录：常用工具链编译方法\n\n## 一、GCC编译\n\n需要依次编译依赖软件，然后在编译gcc中使用\n\n```shell\n# 设置isl的库路径\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib:$LD_LIBRARY_PATH\n# 编译GCC\n../configure --prefix=/home/testcpu/test652/tools/gcc830 --enable-lto --disable-bootstrap --enable-languages=c,c++,fortran --with-gmp=/home/testcpu/test652/tools/gcc830 --with-mpfr=/home/testcpu/test652/tools/gcc830 --with-mpc=/home/testcpu/test652/tools/gcc830 --with-isl=/home/testcpu/test652/tools/gcc830\n```\n\n### 1.1 依赖软件编译\n\n#### 1.1.2 编译安装gmp\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830\nmake \nmake install\n\n./configure --with-gmp=/home/testcpu/test652/tools/gcc83 --with-mpfr=/home/testcpu/test652/tools/gcc83  --prefix=/home/testcpu/test652/tools/gcc83\n```\n\n#### 1.1.3 编译安装mpfr\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp=/home/testcpu/test652/tools/gcc830\nmake \nmake install\n```\n\n#### 1.1.4 编译安装mpc\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp=/home/testcpu/test652/tools/gcc830 --with-mpfr=/home/testcpu/test652/tools/gcc830\nmake\nmake install\n```\n\n#### 1.1.5 编译安装isl\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp-prefix=/home/testcpu/test652/tools/gcc830\n```\n\n```shell\n yum install gcc-* gtk2 gtk3 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686\nglibc.i686 glibc-devel.i686 libgcc* xulrunner.x86_64 xulrunner.i686 glibc-devel.x86_64 glibc.x86_64 autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n```\n\n```shell\n#!/bin/bash\nmount -o loop -t iso9660 /home/testcpu/test652/images/rhel-server-7.6-x86_64-dvd.iso /home/testcpu/test652/mnt/CDROM\n\n\nyum install gcc-* gtk2 gtk3 glibc-devel.i686 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686 glibc* libgcc* xulrunner* autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n\n```\n\n## 二、MPICH3编译\n\n设置gcc830的环境变量\n\n```shell\nexport PATH=/home/testcpu/test652/tools/gcc830/bin:$PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH=/home/testcpu/test652/tools/gcc830/include:$LD_INCLUDE_PATH\nexport CPATH=/home/testcpu/test652/tools/gcc830/include:$CPATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib64:$LD_LIBRARY_PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/libexec:$LD_LIBRARY_PATH\n```\n\n再编译\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/mpi3-gcc830 --enable-fast --enable-shared=yes --enable-threads=runtime --with-ch3-rank-bits=32 --enable-romio --with-file-system=ufs+nfs --with-mpe\nmake \nmake install\n```\n\n设置环境变量使用\n\n```shell\nexport PATH=/home/testcpu/test652/tools/mpi3-gcc830/bin:$PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/mpi3-gcc830/lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH=/home/testcpu/test652/tools/mpi3-gcc830/include:$LD_INCLUDE_PATH\n```\n\n\n\n### 三、Redhat设置本地镜像源\n\n```shell\n mount -o loop -t iso9660 /home/IOSYS/test652/images/rhel-server-7.6-x86_64-dvd.iso /home/IOSYS/test652/mnt/CDROM\n```\n\n```shell\nvim /etc/yum.repos.d/redhat.repo\n\n[rhel7.6]\nname=rhel7.6\nbaseurl=file:///home/testcpu/test652/mnt/CDROM\nenabled=1\ngpgcheck=0\npriority=1\n\nyum clean\nyum update\nyum repolist\n```\n\n## 四、找不到so库的解决方法\n\n```shell\n# 方法一：\n\t设置LD_LIBRARY_PATH\n# 方法二：\n \tvim /etc/ld.so.conf\n \t----------------------------------------------------\n \tinclude ld.so.conf.d/*.conf\n\t/opt/intel/compilers_and_libraries/linux/lib/intel64\n\tldconfig 更新\n```\n\n## 五、复制以及查看端口占用\n\n```shell\n# 查看端口占用\nnetstat -nultp | grep 8080\nnetstat -anp  | grep 80\nnetstat -ano | grep 18130\nlsof -i:18130\n\n# 复制\nrsync -chavP /var/opt/gitlab/postgresql .\nrsync -avzP 复制显示进度\n\n# 查看Bios版本\ndmidecode\n```\n\n```shell\n\nmpiicc -DAdd__ -DF77_INTEGER=int -DStringSunStyle -DHPL_DETAILED_TIMING -DHPL_PROGRESS_REPORT -I/root/hpl/include -I/root/hpl/include/Linux_Intel64 -I/opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/mkl/include  -O3 -w -ansi-alias -i-static -z noexecstack -z relro -z now -nocompchk -Wall -qopenmp -mt_mpi -o /root/hpl/bin/Linux_Intel64/xhpl HPL_pddriver.o         HPL_pdinfo.o           HPL_pdtest.o /root/hpl/lib/Linux_Intel64/libhpl.a  -L/opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/mkl/lib/intel64 -Wl,--start-group /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_intel_lp64.a /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_intel_thread.a /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_core.a -Wl,--end-group -lpthread -ldl\n```\n\n##  六、查看cpu主频率 和 内存信息\n\n```shell\n# 查看CPU信息\nlscpu 其中 sockets个数代表物理核个数\ncat /proc/cpuinfo\nlmbench的mhz\n/usr/bin/turbostat\n\n# 查看内存信息\ncat /proc/meminfo\ndmidecode | grep -A 16 \"Memory Device\"、\n```\n\n## 七、GLSL 1.50 is not supported\n\n```shell\n# 报错：\nERROR: In /home/gs/src/VTK8.2/VTK-8.2.0/Rendering/OpenGL2/vtkShaderProgram.cxx, line 447\nvtkShaderProgram (0x2b87270): 0:1(10): error: GLSL 1.50 is not supported. Supported versions are: 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES\n\n# 解决方法\nexport MESA_GL_VERSION_OVERRIDE=3.2\n```\n\n```shell\ncn[16-19,24-27,144-147,152-155]\n```\n\n## 八、附录\n\n### 8.1 Linpack脚本\n\n> runpro.sh\n>\n> ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n>\n> node_list 节点列表\n>\n> nodes_num 几个点连在一起跑，单点 双点 多点\n>\n>  proc_per_node 每个节点跑几个进程，看node分为几个，FT一般是8\n>\n>  mem 12000 每个进程分配的内存，*8 大概= 总内存的80%\n>\n>  logdir 日志文件\n>\n>  单点8进程，一轮≈35分钟\n\n```shell\n#! /bin/bash\n\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE=1\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:LD_LIBRARY_PATH\n\nnodes=${1}\nnnodes=${2}\nnprocs=${3}\nnmem=${4}\nlogdir=${5}\n\n\nmkdir -p ${logdir}\n\ntnprocs=$((${nnodes}*${nprocs}))\nP=1\nQ=1\n\n\nnum_max=1\nfor i in `seq 1 ${tnprocs}`\ndo\n        j=$((${i}*${i}))\n        if [ ${tnprocs} -le ${j} ]; then\n                num_max=${i}\n                break\n        fi\ndone\nfor i in `seq 1 ${num_max}`\ndo\n        for j in `seq ${num_max} ${tnprocs}`\n        do\n                PQ=$((${i}*${j}))\n                if [ ${PQ} -eq ${tnprocs} ]\n                then\n                        P=${i}\n                        Q=${j}\n                fi\n        done\ndone\n\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        scp HPL.dat $i:/root/linpack &\ndone\nsleep 1\n\nj=0\nrunnodes=''\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        runnodes+=${i},\n        let j++\n        if [ ${j} -eq ${nnodes} ]\n        then\n                echo \"yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\"\n                echo ${runnodes} &>> ${logdir}/${i}.log &\n                echo \"yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem}\" &>> ${logdir}/list.log\n                yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\n                j=0\n                runnodes=''\n        fi\ndone\n\n```\n\n>xhplrun.sh\n\n```shell\n#! /bin/bash\n\n#duqi\n\nulimit -s unlimited\n\nCores=64\n#==========================================================\nPMI_SIZE=$SLURM_NPROCS\n\nPMI_RANK=$SLURM_PROCID\n\nMPI_NUM_NODES=$SLURM_NNODES\n\nMPI_PER_NODE=$((PMI_SIZE / MPI_NUM_NODES))\n\nMPI_RANK_FOR_NODE=$((PMI_RANK % MPI_PER_NODE))\n#==========================================================\n\n\nthreads=`echo ${Cores}*${SLURM_NNODES}/${PMI_SIZE} | bc`\n\nPRO_SIZE=${MPI_PER_NODE}\nPMI_RANK_my=${MPI_RANK_FOR_NODE}\n\necho ${PRO_SIZE} ${PMI_RANK_my} ${threads} ${PMI_SIZE} ${PMI_RANK} ${MPI_NUM_NODES} ${MPI_PER_NODE} ${MPI_RANK_FOR_NODE}\n\nexport HPL_CMDLINE=1\ncase ${PRO_SIZE} in\n1)\n#numactl -i 0-1 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0,4 -N 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\ncase ${PMI_RANK_my} in\n0)\n#numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-31'\nnumactl -i 4-7 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\n#numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-63'\nnumactl -i 0-3 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3} : -n 1 numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-15'\nnumactl -i 0-7 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 2-3 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-31'\nnumactl -i 0-7 -N 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 4-5 -N 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-47'\nnumactl -i 0-7 -N 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 6-7 -N 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-63'\nnumactl -i 0-7 -N 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-1 -N 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n8)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-7'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 4 -N 0 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-15'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 2 -N 1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-23'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 6 -N 2 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-31'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 1 -N 3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-39'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0 -N 4 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-47'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 7 -N 5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-55'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 5 -N 6 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 3 -N 7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n16)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-3'\nnumactl -i 0-7 -C 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4-7'\nnumactl -i 0-7 -C 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-11'\nnumactl -i 0-7 -C 8-11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12-15'\nnumactl -i 0-7 -C 12-15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-19'\nnumactl -i 0-7 -C 16-19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20-23'\nnumactl -i 0-7 -C 20-23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-27'\nnumactl -i 0-7 -C 24-27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28-31'\nnumactl -i 0-7 -C 28-31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-35'\nnumactl -i 0-7 -C 32-35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36-39'\nnumactl -i 0-7 -C 36-39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-43'\nnumactl -i 0-7 -C 40-43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44-47'\nnumactl -i 0-7 -C 44-47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-51'\nnumactl -i 0-7 -C 48-51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52-55'\nnumactl -i 0-7 -C 52-55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-59'\nnumactl -i 0-7 -C 56-59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60-63'\nnumactl -i 0-7 -C 60-63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n32)\n#export OMP_NUM_THREADS=${threads}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#;;\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-1'\nnumactl -i 0-7 -C 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='2-3'\nnumactl -i 0-7 -C 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4-5'\nnumactl -i 0-7 -C 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='6-7'\nnumactl -i 0-7 -C 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-9'\nnumactl -i 0-7 -C 8-9 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='10-11'\nnumactl -i 0-7 -C 10-11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12-13'\nnumactl -i 0-7 -C 12-13 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='14-15'\nnumactl -i 0-7 -C 14-15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-17'\nnumactl -i 0-7 -C 16-17 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='18-19'\nnumactl -i 0-7 -C 18-19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20-21'\nnumactl -i 0-7 -C 20-21 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='22-23'\nnumactl -i 0-7 -C 22-23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-25'\nnumactl -i 0-7 -C 24-25 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='26-27'\nnumactl -i 0-7 -C 26-27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28-29'\nnumactl -i 0-7 -C 28-29 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='30-31'\nnumactl -i 0-7 -C 30-31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n16)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-33'\nnumactl -i 0-7 -C 32-33 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n17)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='34-35'\nnumactl -i 0-7 -C 34-35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n18)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36-37'\nnumactl -i 0-7 -C 36-37 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n19)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='38-39'\nnumactl -i 0-7 -C 38-39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n20)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-41'\nnumactl -i 0-7 -C 40-41 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n21)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='42-43'\nnumactl -i 0-7 -C 42-43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n22)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44-45'\nnumactl -i 0-7 -C 44-45 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n23)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='46-47'\nnumactl -i 0-7 -C 46-47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n24)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-49'\nnumactl -i 0-7 -C 48-49 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n25)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='50-51'\nnumactl -i 0-7 -C 50-51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n26)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52-53'\nnumactl -i 0-7 -C 52-53 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n27)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='54-55'\nnumactl -i 0-7 -C 54-55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n28)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-57'\nnumactl -i 0-7 -C 56-57 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n29)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='58-59'\nnumactl -i 0-7 -C 58-59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n30)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60-61'\nnumactl -i 0-7 -C 60-61 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n31)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='62-63'\nnumactl -i 0-7 -C 62-63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n64)\nexport OMP_NUM_THREADS=${threads}\n#export GOMP_CPU_AFFINITY='0-63'\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#;;\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0'\nnumactl -i 0-7 -C 0 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='1'\nnumactl -i 0-7 -C 1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='2'\nnumactl -i 0-7 -C 2 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='3'\nnumactl -i 0-7 -C 3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4'\nnumactl -i 0-7 -C 4 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='5'\nnumactl -i 0-7 -C 5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='6'\nnumactl -i 0-7 -C 6 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='7'\nnumactl -i 0-7 -C 7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8'\nnumactl -i 0-7 -C 8 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='9'\nnumactl -i 0-7 -C 9 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='10'\nnumactl -i 0-7 -C 10 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='11'\nnumactl -i 0-7 -C 11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12'\nnumactl -i 0-7 -C 12 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='13'\nnumactl -i 0-7 -C 13 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='14'\nnumactl -i 0-7 -C 14 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='15'\nnumactl -i 0-7 -C 15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n16)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16'\nnumactl -i 0-7 -C 16 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n17)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='17'\nnumactl -i 0-7 -C 17 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n18)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='18'\nnumactl -i 0-7 -C 18 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n19)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='19'\nnumactl -i 0-7 -C 19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n20)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20'\nnumactl -i 0-7 -C 20 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n21)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='21'\nnumactl -i 0-7 -C 21 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n22)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='22'\nnumactl -i 0-7 -C 22 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n23)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='23'\nnumactl -i 0-7 -C 23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n24)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24'\nnumactl -i 0-7 -C 24 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n25)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='25'\nnumactl -i 0-7 -C 25 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n26)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='26'\nnumactl -i 0-7 -C 26 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n27)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='27'\nnumactl -i 0-7 -C 27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n28)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28'\nnumactl -i 0-7 -C 28 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n29)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='29'\nnumactl -i 0-7 -C 29 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n30)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='30'\nnumactl -i 0-7 -C 30 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n31)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='31'\nnumactl -i 0-7 -C 31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n32)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32'\nnumactl -i 0-7 -C 32 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n33)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='33'\nnumactl -i 0-7 -C 33 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n34)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='34'\nnumactl -i 0-7 -C 34 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n35)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='35'\nnumactl -i 0-7 -C 35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n36)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36'\nnumactl -i 0-7 -C 36 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n37)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='37'\nnumactl -i 0-7 -C 37 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n38)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='38'\nnumactl -i 0-7 -C 38 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n39)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='39'\nnumactl -i 0-7 -C 39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n40)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40'\nnumactl -i 0-7 -C 40 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n41)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='41'\nnumactl -i 0-7 -C 41 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n42)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='42'\nnumactl -i 0-7 -C 42 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n43)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='43'\nnumactl -i 0-7 -C 43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n44)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44'\nnumactl -i 0-7 -C 44 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n45)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='45'\nnumactl -i 0-7 -C 45 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n46)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='46'\nnumactl -i 0-7 -C 46 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n47)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='47'\nnumactl -i 0-7 -C 47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n48)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48'\nnumactl -i 0-7 -C 48 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n49)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='49'\nnumactl -i 0-7 -C 49 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n50)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='50'\nnumactl -i 0-7 -C 50 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n51)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='51'\nnumactl -i 0-7 -C 51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n52)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52'\nnumactl -i 0-7 -C 52 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n53)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='53'\nnumactl -i 0-7 -C 53 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n54)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='54'\nnumactl -i 0-7 -C 54 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n55)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='55'\nnumactl -i 0-7 -C 55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n56)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56'\nnumactl -i 0-7 -C 56 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n57)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='57'\nnumactl -i 0-7 -C 57 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n58)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='58'\nnumactl -i 0-7 -C 58 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n59)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='59'\nnumactl -i 0-7 -C 59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n60)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60'\nnumactl -i 0-7 -C 60 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n61)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='61'\nnumactl -i 0-7 -C 61 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n62)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='62'\nnumactl -i 0-7 -C 62 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n63)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='63'\nnumactl -i 0-7 -C 63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\nesac\n```\n\n### 8.2 编译问题\n\n```shell\n-lc \n\t解决找不到memcpy问题 \n-lstdc++\n\t解决vtable for xxxx 问题\n-lgcc_s\n\tundefined reference to `_Unwind_Resume'\n\tundefined reference to `__popcountdi2'\n\t\n#include <sys/types.h>\n#include <sys/types.h>\n\t implicit declaration of function ‘fstat’\n\n#include <sys/sysmacros.h>\n\timplicit declaration of function ‘major’\n```\n\n# 十、Linux操作\n\n## 10.1 ncat端口转发\n\n```shell\nncat --sh-exec \"ncat 25.8.27.6 15929\" -l 15929 --keep-open\n```\n\n# 十一、DDT安装\n\n```shell\n# cp Licence /home/gs/tools/arm/forge/licences/\n# cp Licence.14713 /home/gs/tools/arm/licenceserver/licences/\n\nexport PATH=/opt/mpi3.3/bin:/home/gs/tools/arm/forge/bin:/home/gs/tools/arm/licenceserver/bin:$PATH\nexport LD_LIBRARY_PATH=/opt/mpi3.3/lib:$LD_LIBRARY_PATH\nifconfig eth3 hw ether 00:1b:21:14:15:60\n```\n\n```shell\n#glex高速网版本的MPI改为本地调试用\nexport MPICH_NO_LOCAL=0 //？不一定需要\nexport MPICH_NEMESIS_NETMOD=tcp\nexport PATH=/usr/local/mpi3/bin:$PATH\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:$LD_LIBRARY_PATH\n```\n\n\n\n# 十二、SPEC使用\n\n## 12.1 SPEC使用系统工具\n\n```shell\n# SEPC设置使用系统的工具\nvim /home/gs/tools/spack-v5/etc/spack/defaults/packages.yaml\n# 参考：\n../../../lib/spack/docs/build_settings.rst\n```\n\n# 十三、mi协议\n\n## 13.1 使用mi启动调试\n\n```shell\ngs@ft-svr:~/matrix$ gdb --interpreter mi test\n=thread-group-added,id=\"i1\"\n~\"GNU gdb (Ubuntu 8.2.91.20190405-0ubuntu3) 8.2.91.20190405-git\\n\"\n~\"Copyright (C) 2019 Free Software Foundation, Inc.\\n\"\n~\"License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\\nThis is free software: you are free to change and redistribute it.\\nThere is NO WARRANTY, to the extent permitted by law.\"\n~\"\\nType \\\"show copying\\\" and \\\"show warranty\\\" for details.\\n\"\n~\"This GDB was configured as \\\"aarch64-linux-gnu\\\".\\n\"\n~\"Type \\\"show configuration\\\" for configuration details.\\n\"\n~\"For bug reporting instructions, please see:\\n\"\n~\"<http://www.gnu.org/software/gdb/bugs/>.\\n\"\n~\"Find the GDB manual and other documentation resources online at:\\n    <http://www.gnu.org/software/gdb/documentation/>.\"\n~\"\\n\\n\"\n~\"For help, type \\\"help\\\".\\n\"\n~\"Type \\\"apropos word\\\" to search for commands related to \\\"word\\\"...\\n\"\n~\"Reading symbols from test...\\n\"\n(gdb)\n```\n\n## 13.2 断点命令（BreakPoint）\n\n### 13.2.1 -break-after\n\n```shell\n-break-after number count\n第number个断点在执行count次后有效\n```\n\n### 13.2.2 -break-condition\n\n```shell\n-break-condition number expr\n第number个断点在表达式expr为true时有效\n```\n\n### 13.2.3 -break-delete\n\n```shell\n-break-delete(breakpoint number)+\n删除指定number的多个断点\n```\n\n### 13.2.4 -break-disable\n\n```shell\n-break-disable(breakpoint number)+\n使用指定Number的多个断点失效\n```\n\n### 13.2.5 -break-enable\n\n```shell\n-break-enable(breakpoint number)+\n使用指定Number的多个断点生效\n```\n\n### 13.2.6 -break-info\n\n```shell\n-break-info breakpoint\n得到指定断点的信息\n```\n\n### 13.2.7 -break-insert\n\n```shell\n-break-insert\n\t-t\t\t\t\t插入临时断点\n\t-h\t\t\t\t插入硬件断点\n\t-r\t\t\t\t插入正则断点，当函数名匹配正则表达式时生效\n\t-c condition    插入条件断点\n\t-i ignore-count 插入一个指定无效次数的断点\n\t-p thread  \t\t\n\tline | addr(func) \n```\n\n### 13.2.8. -break-list\n\n```shell\n-break-list\n显示已插入的断点列表\n```\n\n### 13.2.9 -break-watch\n\n```shell\n-break-watch [-a|-r] variable\n创建一个观察点，-a标识对variable读写时有效，-r标识只读时有效\n```\n\n## 13.3 程序环境命令(Program Context)\n\n## 13.4 线程(thread)\n\n## 13.5 程序执行(Program Execution)\n\n\n\n## 13.6 栈(Stack)\n\n## 13.7 变量(Variable)\n\n## 13.8 数据(Data)\n\n## 13.9 跟踪点(TracePoint)\n\n## 13.10 符号(Symbol)\n\n## 13.11 文件(File)\n\n## 13.12 目标数据(Target Manipulation)\n\n## 13.13 其他\n\n```shell\n-enable-pretty-printing\n-var-create - * map\n-var-list-children --all-values var1 0 10\n\n-data-evaluate-expression map\n^done,value=\"std::map with 140737353945088 elements<error reading variable: Cannot access memory at address 0x1f0fc35f415e51>\"\n```\n\n\n\n```shell\n//    // 设置标记类型与颜色\n//    this->markerDefine(QsciScintilla::Circle, 0);\n//    this->setMarkerBackgroundColor(QColor(\"#ee6666\"), 0);\n//    this->markerDefine(QsciScintilla::Circle, 1);\n//    this->setMarkerBackgroundColor(QColor(\"#aaaaaa\"), 1);\n//    this->markerDefine(QsciScintilla::RightArrow, 2);\n//    this->setMarkerBackgroundColor(QColor(\"#eaf593\"), 2);\n```\n\n# 十四、Git改密码\n\n```shell\ngitlab-rails console production\n\nirb(main):002:0> user=User.where(email:'cuiyingbomail@163.com').first\n=> #<User id:30 @cyb>\nirb(main):003:0> user.password=12345678\n=> 12345678\nirb(main):004:0> user.password_confirmation=12345678\n=> 12345678\nirb(main):005:0> user.save!\nEnqueued ActionMailer::DeliveryJob (Job ID: 540244db-c6ec-44f9-880e-72338b955aa5) to Sidekiq(mailers) with arguments: \"DeviseMailer\", \"password_change\", \"deliver_now\", #<GlobalID:0x00007f57f5da3208 @uri=#<URI::GID gid://gitlab/User/30>>\n=> true\n\n```\n\n# 十五、YHPDE（eclipse）FT部署\n\n```shell\n1、安装eclipse:\n\tgitlab\n2、插件安装，参考手册\n2、新版SLURM需要\nvim org.eclipse.ptp.rm.slurm.proxy_4.0.7.201104291906/src/ptp_slurm_proxy.c\n1625行：slurm_allocation_lookup_lite -> slurm_allocation_lookup\n2942行: primary = 1; ->  primary = 0;\n2943行：secondary = 2; -> secondary = 1;\n```\n\n","source":"_posts/02_测试/02_测试工具使用说明-完善中.md","raw":"---\ntitle: 测试工具使用说明-完善中\ndate: 2022-07-06 11:19:52\ncategories:\n- 测试\n- 信创POC测试\ntags:\n- 工作\n---\n\n# 测试工具使用说明-汇总\n\n# 一、SPEC CPU 2017 测试\n\n## 1.1 概述\n\n​\t标准性能评测机构（SPEC）开发的用于评测CPU性能的基准程序测试组，是一套CPU子系统测试工具。处理器、内存和编译都会影响最终的测试结果，目前SPEC CPU是业界首选的CPU评测工具。 \n\n## 1.2 工具安装\n\n获取镜像包：\n\n​\tcpu2017-1_0_5.iso\n\n挂载IOS\n\n```shell\nmount -o loop -t iso9660 cpu2017-1_0_5.iso /xxx/cpu2017CD\n```\n\n安装工具\n\n```shell\ncd /xxx/cpu2017CD\n./install.sh\n```\n\n## 1.3 测试步骤\n\nspec2017主要分为四项测试：\n\n- ​\tintrate\n- ​\tfprate\n- ​\tintspeed\n- ​\tfpspeed\n\n​\t根据需要测试的cpu型号，可以到官网下载相应的cfg文件，修改icc、Jemalloc库、qkmalloc库的路径，放入config文件夹中。\n\n测试命令如下：\n\n```shell\nsource shrc\nulimit -s unlimited\n# speed 测试\nruncpu --config=icc-speed-official.cfg --threads=48 --define cores=48 -n 3 -i ref fpspeed intspeed\n\n# rate 测试\nruncpu --config=icc-rate-official.cfg -copies=48 -n 3 -i ref intrate fprate\n\n-----------------------------------------------------------------------\n\n# 仅编译不跑测试\n--action=build\n# 重新编译\n--rebuild\n# 绑核跑\ntaskset -c \n```\n\n## 1.4 测试优化\n\n>Bios设置：\n>\n>​\t开启超线程\n>\n>​\t 尝试开启LLC-PREFETCH\n\n## 1.5 其他事项：\n\n```shell\ncfg文件中的submit可以设置绑核选项\n```\n\n# 二、SPEC CPU 2006 测试\n\n## 2.1 概述\n\n​\t作用同Spec CPU 2017, 近年来逐渐被淘汰\n\n## 2.2 测试步骤\n\n1、spec2006.tgz 解压，使用install.sh安装\n\n```shell\nSPEC CPU2006 Installation\nTop of the CPU2006 tree is '/vol8/tarball/cpu2006'\nThese appear to be valid toolsets:\nft-spec2006-tool\naarch64-linux\nEnter the architecture you are using:\n>> aarch64-linux\n```\n\n```shell\nsource shrc\n# 单核测试\nrunspec -c linux64-arm64-gcc52.cfg -i ref -n 3 -I all \n# 多核测试（16）\nrunspec -c linux64-arm64-gcc52.cfg -r 16 -n 3 -i ref -I all\n```\n\n# 三、 SPEC OMP 2012 测试\n\n## 3.1 概述\n\n​\t基于SPEC测试套件的OpenMP评测工具，其中包含15个基于OpenMP的并行程序。\n\n## 3.2 工具安装\n\n​\t获取源包：\n\n​\t\tomp2012-1.1.zip\n\n​\t解压后使用install.sh安装\n\n```shell\n# 安装\n./install.sh -d /home/xx\n# 仅编译\nrunspec --action=build --config=gcc.cfg -i ref -I all\n```\n\n## 3.3 测试步骤\n\n```shell\nsource shrc\nulimit -s unlimited\nexport OMP_NUM_THREADS=48\nrunspec --config=gcc.cfg --threads 48 -n 3 -i ref -I all\n```\n\n# 四、NPB 测试\n\n## 4.1 概述\n\n​\tNAS并行基准测试程序（NPB），是由美国航空航天局开发的一套代表流体动力学计算的应用程序集，它已经成为公认的用于测评大规模并行机和超级计算机的标准测试程序。NPB可用于常用的编程模型，如MPI和OpenMP。\n\n## 4.2 工具安装\n\n源包获取：\n\n​\tNPB3.4.tar.gz         OpenMP || MPICH\n\n​\tNPB3.4-MZ.tar.gz  OpenMP && MPICH\n\n解压即可。\n\n## 4.3 测试步骤\n\n```shell\nmake suite\ncd bin\nmpirun -np 4 ./xxx\n```\n\n# 五、Stream 测试\n\n## 5.1 概述\n\n​\tSTREAM是一套综合性能测试程序集，通过fortran和C两种高级且高效的语言编写完成，由于这两种语言在数学计算方面的高效率， 使得 STREAM 测试例程可以充分发挥出内存的能力。Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。\n\n## 5.2 工具安装\n\n源包获取：\n\n​\tstream.tgz  刘新娃修改过\n\n​\t<font color='red'>Intel平台请用ICC</font>\n\n解压后编译stream.c, 生成可执行文件\n\n```shell\nicc -O3 -fopenmp -DNTIMES=10 -mcmodel=large -o stream_c stream.c\n```\n\n没有修改过的怎么编译呢？\n\n```shell\nicc -mtune=native -march=native -O3 -mcmodel=large -fopenmp -DSTREAM_ARRAY_SIZE=100000000 -DNTIMES=30 -DOFFSET=512 stream.c -o stream-gs\n```\n\n## 5.3 测试步骤\n\n```shell\nexport OMP_NUM_THREADS=48/32/16/8/4  # 设置每个进程的线程数\n./stream_c 200000 # 使用200G内存\n```\n\n## 5.4 其他事项\n\n>`STREAM_ARRAY_SIZE`即`N`指定计算中a[],b[],c[]三个数组的大小，且数组的值采用了双精度（8个字节）。数组的维数 N定义时需要注意以下几点：\n>\n>一、要充分考虑内存容量的需求，粗略估计是 N× 8（双精度浮点类型） × 3 （三个数组）<= 0.6*M；M 是用户的可用内存。\n>\n>二、要保证测试过程中，使用到的内存容量要大于处理器内的缓存，只有这样才会有内存的操作，而不仅仅是对处理器内缓存的操作。\n>\n>三、为了保证测试可以持续一段时间，测试过程中内存带宽可以达到一定的最大值， 从而避免得不到实际最大峰值的情况，如果四项测试中有完成时间小于20微秒的情况，就需要适当的增大测试数组的维度 N。\n\n# 六、Linpack 测试\n\n## 6.1 概述\n\n​\tLinpack是国际上使用最广泛的测试高性能计算机系统浮点性能的基准测试。通过对高性能计算机采用高斯消元法求解一元 N次稠密线性代数方程组的测试，评价高性能计算机的浮点计算性能。Linpack的结果按每秒浮点运算次数（flops）表示。\n\n```shell\n N ^ 2 * 8 = 总内存\n```\n\n## 6.2 工具安装\n\n源包获取：\n\n​\tlinpack.tgz\n\n解压即可。\n\n## 6.3 测试步骤\n\n```shell\n# 1进48线100G内存\n./xhpl -n 1 -b 384 -p 1 -q 1 -m 100000\n# 1进48线200G内存\n./xhpl -n 1 -b 384 -p 1 -q 1 -m 200000\n# 2进24线共100G内存\nmpirun -n 2 ./xhpl -b 384 -p 1 -q 2 -m 50000\n# 2进24线共200G内存\nmpirun -n 2 ./xhpl -b 384 -p 1 -q 2 -m 100000\n```\n\n用mpirun提交xhplrun.sh效果更好\n\n```shell\nPRO_SIZE=${PMI_SIZE}\nthreads=`echo ${Cores}/${PMI_SIZE} | bc`\nPMI_RANK_my=${PMI_RANK}\n```\n\n## 6.4 测试优化（重点）\n\n>一、计算理论内存总带宽\n>\n>```shell\n>计算方法：\n>查看内存带宽：\n>dmidecode | grep -A 16 \"Memory Device\"\n>例如内存信息为：\n>三星 DDR4 \n>16G 每根\n>2666 MT/s（Mhz）\n>查看cpu支持的通道数，例如intel 6252N支持6通道，两个CPU支持12通道\n>理论带宽计算DDR4：\n>单条内存带宽 = 内存核心频率 x 内存总线位数 x 倍增系数\n>\t = 2666 * 64 / 8 = 21328 MB/s = 21.3G/s\n>12通道总内存带宽 = 21328 * 12 = 255936 = 250G/s\n>```\n>\n>二、使用stream测试实际内存总带宽\n>\n>​\t如果可以达到90%或以上，说明内存带宽正常, 继续Linpack测试\n>\n>三、计算CPU理论峰值\n>\n>```shell\n>计算方法：\n>\tMhz * 每个时钟周期执行浮点运算的次数 * CPU数目\n>=\n>\t2.3 x ( 8 x 2 x 2 ) x 48 = 3532.8 Gflops\n>说明：\n>\t峰值计算分为单精度和双精度浮点运算\n>单精度：\n>\t32bit的指令长度的运算，对应32位操作系统\n>双精度：\n>\t64bit的指令长度的运算，对应64位操作系统\n>查找CPU可以处理什么样的指令集：\n>\t例如Intel官网查到Intel Xeon 6252N\n>\t支持AVX-512，\n>\t# of AVX-512 FMA Units = 2\n>\t(Fused Multiply Add instructions) 融合了 乘法 和 加法\n>\t即可以单个周期同时执行2条512bit的加法和2条512bit的乘法\n>理解上述两个概念，可以开始计算（CPU单周期浮点计算能力）\n>Intel 6252N (支持avx512，有512位)\n>单精度：\n>\t2.3 x 512/32 x 2 x 2 = 147.2Gflops \n>双精度\n>\t2.3 x 512/64 x 2 x 2 = 73.6Gflops\n>双精度共48核\n>\t74.6 x 48 = 3580\n>\t\n>FT2000+ 和 FT1500A (只有128位)，FT3000加入sve指令集(128-256位)\n>单精度： \n>\t2.2 x 128/32 * 2 = 4.4\n>双精度:\n>\t2.2 x 128/64 * 2 = 8.8\n>双精度共64核\n>\t8.8 x 64 = 563.2\n>```\n>\n>四、使用Linapack测试CPU实际峰值\n>\n>```shell\n>如果性能达到理论峰值的70%说明正常，如果未达到尝试以下优化\n>```\n>\n>```shell\n>1、使用mpirun运行xhpl, 按`lscpu` 中的NUMA分组绑定,`比如48核，分为两个Numa Node`, 则用mpirun`跑两个xhpl进程`，每个进程使用 OMP_NUM_THREADS=24, 跑24线程，这样可以将核用满。\n>在`Intel`平台，两个进程分别使用 HPL_HOST_CORE='0-23' 以及 HPL_HOST_CORE='24-47' 绑定核\n>在`Arm64`平台，则使用 GOMP_CPU_AFFINITY='0-23' 以及 GOMP_CPU_AFFINITY='24-47' 绑定\n>2、内存不用分配太大，根据stream测试结果分配，从小开始测\n>3、Intel平台编译器使用ICC，测试linpack使用icc自带的linpack，mpi使用icc自带的\n>4、Bios中关闭超线程，开启超频(turbo/P-state)\n>```\n>\n>**<font color=\"blue\">先测stream,判断带宽是否正常，再测linpack，然后再测Spec Cpu</font>**\n\n```shell\n# Intel平台可以使用的控制频率的命令\ncpupower -c all frequency-set -g performance\ncpupower -c 0-95 frequency-set -g userspace\ncpupower -c 0-95 frequency-set -f 2700000\n\n# 查看当前频率控制是否为perfomance？\ncat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor\n\n# 跑xhpl之前设置指令集，或许有用\nexport MKL_ENABLE_INSTRUCTIONS=AVX512\n```\n\n![image-20200415171716940](G:\\工作\\2020年3月\\CN9性能测试\\测试组合.png)\n\n## 6.5 HPL.dat修改\n\n```shell\n# 第1-2行，注释说明行\nHPLinpack benchmark input file   \nInnovative Computing Laboratory, University of Tennessee  \n\n# 第 3-4 行，输出结果文件的形式\nHPL.out      output file name (if any)  \n6            device out (6=stdout,7=stderr,file) \n\n# 5-6行，求解矩阵的大小\n1            # of problems sizes (N)  \n1000         Ns   \n\n# 7-8行 求解矩阵分块的大小\n1            # of NBs\n192 256      NBs\n\n# 9行 处理器阵列的排列方式，行还是列\n0：适用于节点较少，单个节点CPU较多的胖系统\n1：适用于节点较多，单个节点CPU较少的瘦系统（机群上远好于按行排列）\n1            PMAP process mapping (0=Row-,1=Column-major) \n\n# 10-12行 定义二维处理网格P/Q\n# P X Q = 进程数，P尽量小于Q\n# P=2^n,P最好选择2的幂\n1            # of process grids (P x Q) \n1 2          Ps\n1 2          Qs\n\n# 13行 设置阀值，不用修改\n16.0         threshold\n\n# 14-21行 设置L的分解方式\n1            # of panel fact\n2 1 0        PFACTs (0=left, 1=Crout, 2=Right) # 对性能影响不大\n1            # of recursive stopping criterium\n4 8          NBMINs (>= 1)   # 4或8都不错\n1            # of panels in recursion\n2            NDIVs  # 选2比较理想\n1            # of recursive panel fact.\n1 0 2        RFACTs (0=left, 1=Crout, 2=Right) # 对性能影响不大\n\n# 22-23行 设置L的横向广播方式\n# 前四种，适用于快速网络，后两种适用于速度较慢的网络\n# 小规模系统，选择0/1，大规模系统选择3\n1            # of broadcast\n0            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)\n\n# 24-25行 设置横向通信的通信深度\n# 小规模系统选择1/2，大规模系统2-5之间\n1            # of lookahead depth\n1            DEPTHs (>=0)\n\n# 26-27 设置U的广播算法\n# 小规模系统，使用缺省值即可\n0            SWAP (0=bin-exch,1=long,2=mix)\n1            swapping threshold\n\n# 28-29行 L和U的数据存放格式\n0：按列存放\n1：按行存放\n0            L1 in (0=transposed,1=no-transposed) form\n0            U  in (0=transposed,1=no-transposed) form\n\n# 30-31 缺省值即可\n0            Equilibration (0=no,1=yes)\n8            memory alignment in double (> 0)\n\n```\n\n## 6.6 测试脚本编写\n\n### 6.6.1 本地mpirun测试脚本（Intel版本）\n\n```shell\n# 本地单节点测试，需要根据`lscpu`中numa分区情况(node)的使用mpirun测试xhpl\n# eg:在未开超线程的情况下，分为两个node，每个node中有12个核，则最佳测试方法为mpirun -np 2 ./myrun.sh\n# 以下为myrun.sh的具体实现\n\n#!/bin/bash\nulimit -s unlimited\nCores=48\nThreadsNum=`echo \"${Cores}/${PMI_SIZE}\" | bc` # 计算每个进程跑的线程数\ncase ${PMI_SIZE} in\n2)\n        case ${PMI_RANK} in\n        0)\n        export OMP_NUM_THREADS=${ThreadsNum}\n        export HPL_HOST_CORE='0-23'\n        ./xhpl -n 1 -b 384 -p ${1} -q ${2} -m ${3}\n        ;;\n        1)\n        export OMP_NUM_THREADS=${ThreadsNum}\n        export HPL_HOST_CORE='24-47'\n        ./xhpl -n 1 -b 384 -p ${1} -q ${2} -m ${3}\n        ;;\n        esac\n;;\nesac\n\n```\n\n## 6.6.2 Slurm srun测试脚本(FT版本)\n\nxhplrun.sh\n\n```shell\n#!/bin/bash\nulimit -s unlimited\nCores=48\n\n\n==================================================================\nPMI_SIZE=$SLURM_NPROCS\nPMI_RANK=$SLURM_PROCID\nMPI_NUM_NODE=$SLURM_NNODES\nMPI_PER_NODE=$((PMI_SIZE / MPI_NUM_NODES))\nMPI_RANK_FOR_NODE=$((PMI_RANK % MPI_PER_NODE))\n\nPRO_SIZE=${MPI_PER_NODE}\nPMI_RANK_my=${MPI_RANK_FOR_NODE}\n==================================================================\n\necho ${PRO_SIZE} ${PMI_RANK_my} ${threads} ${PMI_SIZE} ${PMI_RANK} ${MPI_NUM_NODES} ${MPI_PER_NODE} ${MPI_RANK_FOR_NODE}\n\nexport HPL_CMDLINE=1\ncase ${PRO_SIZE} in\n1)\n#numactl -i 0-1 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0,4 -N 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\ncase ${PMI_RANK_my} in\n0)\n#numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-31'\nnumactl -i 4-7 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\n#numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-63'\nnumactl -i 0-3 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3} : -n 1 numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n```\n\nyhrun 提交作业 runpro.sh\n\n```shell\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE=1\n\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:$LD_LIBRARY_PATH\n\nnodes=${1}\nnnodes=${2}\nnprocs=${3}\nnmem=${4}\nlogdir=${5}\n\n\nmkdir -p ${logdir}\n\ntnprocs=$((${nnodes}*${nprocs}))\nP=1\nQ=1\nfor i in `seq 1 ${tnprocs}`\ndo\n        for j in `seq 1 ${tnprocs}`\n        do\n                PQ=$((${i}*${j}))\n                if [ ${PQ} -eq ${tnprocs} ] && [ ${i} -le ${j} ]\n                then\n                        P=${i}\n                        Q=${j}\n                fi\n        done\ndone\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        scp HPL.dat $i:/root/linpack &\ndone\nwait\nsleep 1\n\nj=0\nrunnodes=''\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        runnodes+=${i},\n        let j++\n        if [ ${j} -eq ${nnodes} ]\n        then\n                echo \"yhrun -p all -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\"\n                echo ${runnodes} &>> ${logdir}/${i}.log\n                yhrun -p all -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\n                j=0\n                runnodes=''\n        fi\ndone\n```\n\n## 6.7 Bios设置\n\n````shell\n琦哥的：\n    UPI Configuration\n        Link Lop -> disable\n        Link L1  -> disable \n        IO Directory Cache -> enable\n        Isoc Mode -> enable\n\n    Memory Configuration\n        Eufsrce POR -> enable\n        PPR Type -> Soft PPR\n        Memory Frequency -> 2666\n        Data Scrambling for NVMDIMM -> enable\n        Data Scrambling for DDR4 -> enable\n        Enable AOR -> enable\n        Refresh Option -> enable\n        Memory RAS\n            Memory Rank Sparing -> enable\n\n    IIO Configuration\n        PCI-E Port Max Payload Size -> 256B\n\n    CPU P-State\n        SpeedStep -> disable/enable?\n        PBF \n        Hardware P-State -> enable\n        Package c state -> No limit \n\t\n网上找的系统Bios设置优化\n    关闭超线程\n    打开EIST\n    打开Turbo Mode\n    Boot Performance mode设置为max performance\n    Energy Performance BIAS设置为Performance\n    打开Monitor/Mwait\n    Package C stat limit设置为C0/C1 state\n    关闭CPU C3 report\n    关闭CPU C6 report\n    关闭Enhanced Halt State\n    关闭Intel VT for Directed I/O\n    Linux OS下CPU Power Management设置为max performance\n    QPI及Memory Frequency保持为Max Frequency\n    关闭NUMA功能 \n````\n\n## 6.8 <span id=\"jump\">结果反馈</span>\n\n```shell\n#linpack测试以我们为主导\n\n1、grep FAILED 关键字,查看是否有节点计算错误\n2、grep WR 查看节点性能是否正常\n3、统计跑死的点\n\n# 如何反馈？\n一轮Linpack40分钟测试完成\n\t一、6个点本是drain*状态\n\t二、3个点跑死，cn[1,2,3]\n\t三、5个点Linpack计算FAILED\n\t四、其他点linpakc性能正常\n可以考虑更换下一批\n```\n\n## 6.9 风冷系统linpack测试全过程记录\n\n>##### 1、了解风冷系统的架构\n>\n>按批次测试，测完一批换下一批\n>\n>一批为192个节点，每个框32个节点，共6个框\n>\n>每个节点128G内存，芯片为FT2000+, 通过mhz获取频率为2000（降频），64物理核\n>\n>系统版本： 4.19.46-cn+\n>\n>##### 2、计算每个节点的理论峰值\n>\n>2000 * 128 / 64 * 2 * 64= 512000\n>\n>##### 3、开始测试\n>\n>runpro.sh脚本参数说明:\n>\n>```shell\n>./runpro.sh NodeList NodeBind ProcessesPerNode MemSize\n>NodeList 节点列表,例如cn[0-8]\n>NodeBind 几个节点绑定运行，例如2，则计算效率时，需要将结果得到的效率/2/512\n>ProcessesPerNode 每给节点运行几个xhpl进程，根据numa node来，FT一般是8\n>MemSize 每个节点中，每个进程分配的内存，一般使用到约总内存的80%，例如单节点128G，填写12000（单位为Mb），则总使用96G内存\n>```\n>\n>单节点测试：\n>\n>​\t不需要互联测试网络联通性，仅对单节点进行压力测试\n>\n>```shell\n>./runpro.sh cn0 1 8 12000 logdir\n>```\n>\n>多节点测试：\n>\n>​\t需要互联测试网络联通性， 2，4， 8， 16， 32， 64， 128，如果要求测多节点稳定性，测试的8点8进8线，结果按[章节6.8](#jump)反馈\n>\n>```shell\n>./runpro.sh cn0 1 8 12000 logdir\n>```\n>\n>问题解决一：\n>\n>​\t测试到128节点，性能异常，效率仅有43%\n>\n>互联那边回应：\n>\n>​\t节点数超过64，通信就跨框\n>\n>琦哥建议的做法：\n>\n>​\t把128个节点分到4个框，测试一下，看是不是带宽的原因\n>\n>最后的解决方法：\n>\n>​\t网络拓扑更换，矩阵值不能相等，使用原本32 x 32，改为16 x 64，但是换成160节点后还是有问题\n>\n>```shell\n>./runpro.sh cn[xx-xx] 128 8 12000 dir\n>其中执行的xhplrun.sh的参数为\n>xhplrun.sh 32 32 12000\n>```\n>\n>\n\n# 七、Lmbench 测试\n\n## 7.1 概述\n\n​\tLmbench是一套简易，可移植的，符合ANSI/C标准为UNIX/POSIX而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。LmBench旨在使系统开发者深入了解关键操作的基础成本。\n\n## 7.2 工具安装\n\n获取源包：\n\n​\tlmbench3.tar.gz\n\ngcc编译安装\n\n## 7.3 测试步骤\n\n```shell\ncd src\nmake results\nmake see\n内存10G。\n```\n\n```shell\n错误处理：\n[root@cn9 lmbench3]# cd src/\n[root@cn9 src]# make results\ngmake[1]: Entering directory `/home/testcpu/test652/tools/lmbench3/src'\ngmake[1]: *** No rule to make target `../SCCS/s.ChangeSet', needed by `bk.ver'.  Stop.\ngmake[1]: Leaving directory `/home/testcpu/test652/tools/lmbench3/src'\n解决方法：\n\tvim Makefile\n\t231行修改：\n\t$O/lmbench : ../scripts/lmbench bk.ver\n\t改为\n\t$O/lmbench : ../scripts/lmbench\n```\n\n# 八、IOR 测试（暂无）\n\n# 九、alltoall测试\n\n```shell\nyhrun -n 128 -N 8 -w cn34,cn35,cn36,cn37,cn38,cn39,cn40,cn41, /root/xm_alltoall 102400 1000\n```\n\n# 附录：常用工具链编译方法\n\n## 一、GCC编译\n\n需要依次编译依赖软件，然后在编译gcc中使用\n\n```shell\n# 设置isl的库路径\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib:$LD_LIBRARY_PATH\n# 编译GCC\n../configure --prefix=/home/testcpu/test652/tools/gcc830 --enable-lto --disable-bootstrap --enable-languages=c,c++,fortran --with-gmp=/home/testcpu/test652/tools/gcc830 --with-mpfr=/home/testcpu/test652/tools/gcc830 --with-mpc=/home/testcpu/test652/tools/gcc830 --with-isl=/home/testcpu/test652/tools/gcc830\n```\n\n### 1.1 依赖软件编译\n\n#### 1.1.2 编译安装gmp\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830\nmake \nmake install\n\n./configure --with-gmp=/home/testcpu/test652/tools/gcc83 --with-mpfr=/home/testcpu/test652/tools/gcc83  --prefix=/home/testcpu/test652/tools/gcc83\n```\n\n#### 1.1.3 编译安装mpfr\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp=/home/testcpu/test652/tools/gcc830\nmake \nmake install\n```\n\n#### 1.1.4 编译安装mpc\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp=/home/testcpu/test652/tools/gcc830 --with-mpfr=/home/testcpu/test652/tools/gcc830\nmake\nmake install\n```\n\n#### 1.1.5 编译安装isl\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/gcc830 --with-gmp-prefix=/home/testcpu/test652/tools/gcc830\n```\n\n```shell\n yum install gcc-* gtk2 gtk3 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686\nglibc.i686 glibc-devel.i686 libgcc* xulrunner.x86_64 xulrunner.i686 glibc-devel.x86_64 glibc.x86_64 autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n```\n\n```shell\n#!/bin/bash\nmount -o loop -t iso9660 /home/testcpu/test652/images/rhel-server-7.6-x86_64-dvd.iso /home/testcpu/test652/mnt/CDROM\n\n\nyum install gcc-* gtk2 gtk3 glibc-devel.i686 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686 glibc* libgcc* xulrunner* autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n\n```\n\n## 二、MPICH3编译\n\n设置gcc830的环境变量\n\n```shell\nexport PATH=/home/testcpu/test652/tools/gcc830/bin:$PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH=/home/testcpu/test652/tools/gcc830/include:$LD_INCLUDE_PATH\nexport CPATH=/home/testcpu/test652/tools/gcc830/include:$CPATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/lib64:$LD_LIBRARY_PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/gcc830/libexec:$LD_LIBRARY_PATH\n```\n\n再编译\n\n```shell\n./configure --prefix=/home/testcpu/test652/tools/mpi3-gcc830 --enable-fast --enable-shared=yes --enable-threads=runtime --with-ch3-rank-bits=32 --enable-romio --with-file-system=ufs+nfs --with-mpe\nmake \nmake install\n```\n\n设置环境变量使用\n\n```shell\nexport PATH=/home/testcpu/test652/tools/mpi3-gcc830/bin:$PATH\nexport LD_LIBRARY_PATH=/home/testcpu/test652/tools/mpi3-gcc830/lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH=/home/testcpu/test652/tools/mpi3-gcc830/include:$LD_INCLUDE_PATH\n```\n\n\n\n### 三、Redhat设置本地镜像源\n\n```shell\n mount -o loop -t iso9660 /home/IOSYS/test652/images/rhel-server-7.6-x86_64-dvd.iso /home/IOSYS/test652/mnt/CDROM\n```\n\n```shell\nvim /etc/yum.repos.d/redhat.repo\n\n[rhel7.6]\nname=rhel7.6\nbaseurl=file:///home/testcpu/test652/mnt/CDROM\nenabled=1\ngpgcheck=0\npriority=1\n\nyum clean\nyum update\nyum repolist\n```\n\n## 四、找不到so库的解决方法\n\n```shell\n# 方法一：\n\t设置LD_LIBRARY_PATH\n# 方法二：\n \tvim /etc/ld.so.conf\n \t----------------------------------------------------\n \tinclude ld.so.conf.d/*.conf\n\t/opt/intel/compilers_and_libraries/linux/lib/intel64\n\tldconfig 更新\n```\n\n## 五、复制以及查看端口占用\n\n```shell\n# 查看端口占用\nnetstat -nultp | grep 8080\nnetstat -anp  | grep 80\nnetstat -ano | grep 18130\nlsof -i:18130\n\n# 复制\nrsync -chavP /var/opt/gitlab/postgresql .\nrsync -avzP 复制显示进度\n\n# 查看Bios版本\ndmidecode\n```\n\n```shell\n\nmpiicc -DAdd__ -DF77_INTEGER=int -DStringSunStyle -DHPL_DETAILED_TIMING -DHPL_PROGRESS_REPORT -I/root/hpl/include -I/root/hpl/include/Linux_Intel64 -I/opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/mkl/include  -O3 -w -ansi-alias -i-static -z noexecstack -z relro -z now -nocompchk -Wall -qopenmp -mt_mpi -o /root/hpl/bin/Linux_Intel64/xhpl HPL_pddriver.o         HPL_pdinfo.o           HPL_pdtest.o /root/hpl/lib/Linux_Intel64/libhpl.a  -L/opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/mkl/lib/intel64 -Wl,--start-group /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_intel_lp64.a /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_intel_thread.a /opt/intel/compilers_and_libraries_2019.4.243/linux/mkl/lib/intel64/libmkl_core.a -Wl,--end-group -lpthread -ldl\n```\n\n##  六、查看cpu主频率 和 内存信息\n\n```shell\n# 查看CPU信息\nlscpu 其中 sockets个数代表物理核个数\ncat /proc/cpuinfo\nlmbench的mhz\n/usr/bin/turbostat\n\n# 查看内存信息\ncat /proc/meminfo\ndmidecode | grep -A 16 \"Memory Device\"、\n```\n\n## 七、GLSL 1.50 is not supported\n\n```shell\n# 报错：\nERROR: In /home/gs/src/VTK8.2/VTK-8.2.0/Rendering/OpenGL2/vtkShaderProgram.cxx, line 447\nvtkShaderProgram (0x2b87270): 0:1(10): error: GLSL 1.50 is not supported. Supported versions are: 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES\n\n# 解决方法\nexport MESA_GL_VERSION_OVERRIDE=3.2\n```\n\n```shell\ncn[16-19,24-27,144-147,152-155]\n```\n\n## 八、附录\n\n### 8.1 Linpack脚本\n\n> runpro.sh\n>\n> ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n>\n> node_list 节点列表\n>\n> nodes_num 几个点连在一起跑，单点 双点 多点\n>\n>  proc_per_node 每个节点跑几个进程，看node分为几个，FT一般是8\n>\n>  mem 12000 每个进程分配的内存，*8 大概= 总内存的80%\n>\n>  logdir 日志文件\n>\n>  单点8进程，一轮≈35分钟\n\n```shell\n#! /bin/bash\n\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: ./runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE=1\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:LD_LIBRARY_PATH\n\nnodes=${1}\nnnodes=${2}\nnprocs=${3}\nnmem=${4}\nlogdir=${5}\n\n\nmkdir -p ${logdir}\n\ntnprocs=$((${nnodes}*${nprocs}))\nP=1\nQ=1\n\n\nnum_max=1\nfor i in `seq 1 ${tnprocs}`\ndo\n        j=$((${i}*${i}))\n        if [ ${tnprocs} -le ${j} ]; then\n                num_max=${i}\n                break\n        fi\ndone\nfor i in `seq 1 ${num_max}`\ndo\n        for j in `seq ${num_max} ${tnprocs}`\n        do\n                PQ=$((${i}*${j}))\n                if [ ${PQ} -eq ${tnprocs} ]\n                then\n                        P=${i}\n                        Q=${j}\n                fi\n        done\ndone\n\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        scp HPL.dat $i:/root/linpack &\ndone\nsleep 1\n\nj=0\nrunnodes=''\n\nfor i in `yhcontrol show hostname ${nodes}`\ndo\n        runnodes+=${i},\n        let j++\n        if [ ${j} -eq ${nnodes} ]\n        then\n                echo \"yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\"\n                echo ${runnodes} &>> ${logdir}/${i}.log &\n                echo \"yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem}\" &>> ${logdir}/list.log\n                yhrun -p All -N ${nnodes} -n ${tnprocs} -w ${runnodes} -D /root/linpack /root/linpack/xhplrun.sh ${P} ${Q} ${nmem} &>> ${logdir}/${i}.log &\n                j=0\n                runnodes=''\n        fi\ndone\n\n```\n\n>xhplrun.sh\n\n```shell\n#! /bin/bash\n\n#duqi\n\nulimit -s unlimited\n\nCores=64\n#==========================================================\nPMI_SIZE=$SLURM_NPROCS\n\nPMI_RANK=$SLURM_PROCID\n\nMPI_NUM_NODES=$SLURM_NNODES\n\nMPI_PER_NODE=$((PMI_SIZE / MPI_NUM_NODES))\n\nMPI_RANK_FOR_NODE=$((PMI_RANK % MPI_PER_NODE))\n#==========================================================\n\n\nthreads=`echo ${Cores}*${SLURM_NNODES}/${PMI_SIZE} | bc`\n\nPRO_SIZE=${MPI_PER_NODE}\nPMI_RANK_my=${MPI_RANK_FOR_NODE}\n\necho ${PRO_SIZE} ${PMI_RANK_my} ${threads} ${PMI_SIZE} ${PMI_RANK} ${MPI_NUM_NODES} ${MPI_PER_NODE} ${MPI_RANK_FOR_NODE}\n\nexport HPL_CMDLINE=1\ncase ${PRO_SIZE} in\n1)\n#numactl -i 0-1 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0,4 -N 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\ncase ${PMI_RANK_my} in\n0)\n#numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-31'\nnumactl -i 4-7 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\n#numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -m 7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-63'\nnumactl -i 0-3 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3} : -n 1 numactl -i 4-7 -N 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-15'\nnumactl -i 0-7 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 2-3 -N 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-31'\nnumactl -i 0-7 -N 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 4-5 -N 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-47'\nnumactl -i 0-7 -N 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 6-7 -N 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-63'\nnumactl -i 0-7 -N 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0-1 -N 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n8)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-7'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 4 -N 0 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-15'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 2 -N 1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-23'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 6 -N 2 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-31'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 1 -N 3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-39'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 0 -N 4 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-47'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 7 -N 5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-55'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 5 -N 6 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-63'\nnumactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#numactl -i 3 -N 7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n16)\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-3'\nnumactl -i 0-7 -C 0-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4-7'\nnumactl -i 0-7 -C 4-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-11'\nnumactl -i 0-7 -C 8-11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12-15'\nnumactl -i 0-7 -C 12-15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-19'\nnumactl -i 0-7 -C 16-19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20-23'\nnumactl -i 0-7 -C 20-23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-27'\nnumactl -i 0-7 -C 24-27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28-31'\nnumactl -i 0-7 -C 28-31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-35'\nnumactl -i 0-7 -C 32-35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36-39'\nnumactl -i 0-7 -C 36-39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-43'\nnumactl -i 0-7 -C 40-43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44-47'\nnumactl -i 0-7 -C 44-47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-51'\nnumactl -i 0-7 -C 48-51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52-55'\nnumactl -i 0-7 -C 52-55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-59'\nnumactl -i 0-7 -C 56-59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60-63'\nnumactl -i 0-7 -C 60-63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n32)\n#export OMP_NUM_THREADS=${threads}\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#;;\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0-1'\nnumactl -i 0-7 -C 0-1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='2-3'\nnumactl -i 0-7 -C 2-3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4-5'\nnumactl -i 0-7 -C 4-5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='6-7'\nnumactl -i 0-7 -C 6-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8-9'\nnumactl -i 0-7 -C 8-9 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='10-11'\nnumactl -i 0-7 -C 10-11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12-13'\nnumactl -i 0-7 -C 12-13 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='14-15'\nnumactl -i 0-7 -C 14-15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16-17'\nnumactl -i 0-7 -C 16-17 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='18-19'\nnumactl -i 0-7 -C 18-19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20-21'\nnumactl -i 0-7 -C 20-21 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='22-23'\nnumactl -i 0-7 -C 22-23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24-25'\nnumactl -i 0-7 -C 24-25 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='26-27'\nnumactl -i 0-7 -C 26-27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28-29'\nnumactl -i 0-7 -C 28-29 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='30-31'\nnumactl -i 0-7 -C 30-31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n16)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32-33'\nnumactl -i 0-7 -C 32-33 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n17)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='34-35'\nnumactl -i 0-7 -C 34-35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n18)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36-37'\nnumactl -i 0-7 -C 36-37 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n19)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='38-39'\nnumactl -i 0-7 -C 38-39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n20)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40-41'\nnumactl -i 0-7 -C 40-41 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n21)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='42-43'\nnumactl -i 0-7 -C 42-43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n22)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44-45'\nnumactl -i 0-7 -C 44-45 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n23)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='46-47'\nnumactl -i 0-7 -C 46-47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n24)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48-49'\nnumactl -i 0-7 -C 48-49 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n25)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='50-51'\nnumactl -i 0-7 -C 50-51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n26)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52-53'\nnumactl -i 0-7 -C 52-53 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n27)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='54-55'\nnumactl -i 0-7 -C 54-55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n28)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56-57'\nnumactl -i 0-7 -C 56-57 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n29)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='58-59'\nnumactl -i 0-7 -C 58-59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n30)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60-61'\nnumactl -i 0-7 -C 60-61 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n31)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='62-63'\nnumactl -i 0-7 -C 62-63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\n64)\nexport OMP_NUM_THREADS=${threads}\n#export GOMP_CPU_AFFINITY='0-63'\n#numactl -i 0-7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n#;;\ncase ${PMI_RANK_my} in\n0)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='0'\nnumactl -i 0-7 -C 0 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n1)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='1'\nnumactl -i 0-7 -C 1 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n2)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='2'\nnumactl -i 0-7 -C 2 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n3)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='3'\nnumactl -i 0-7 -C 3 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n4)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='4'\nnumactl -i 0-7 -C 4 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n5)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='5'\nnumactl -i 0-7 -C 5 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n6)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='6'\nnumactl -i 0-7 -C 6 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n7)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='7'\nnumactl -i 0-7 -C 7 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n8)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='8'\nnumactl -i 0-7 -C 8 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n9)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='9'\nnumactl -i 0-7 -C 9 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n10)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='10'\nnumactl -i 0-7 -C 10 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n11)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='11'\nnumactl -i 0-7 -C 11 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n12)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='12'\nnumactl -i 0-7 -C 12 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n13)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='13'\nnumactl -i 0-7 -C 13 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n14)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='14'\nnumactl -i 0-7 -C 14 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n15)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='15'\nnumactl -i 0-7 -C 15 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n16)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='16'\nnumactl -i 0-7 -C 16 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n17)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='17'\nnumactl -i 0-7 -C 17 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n18)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='18'\nnumactl -i 0-7 -C 18 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n19)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='19'\nnumactl -i 0-7 -C 19 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n20)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='20'\nnumactl -i 0-7 -C 20 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n21)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='21'\nnumactl -i 0-7 -C 21 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n22)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='22'\nnumactl -i 0-7 -C 22 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n23)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='23'\nnumactl -i 0-7 -C 23 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n24)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='24'\nnumactl -i 0-7 -C 24 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n25)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='25'\nnumactl -i 0-7 -C 25 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n26)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='26'\nnumactl -i 0-7 -C 26 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n27)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='27'\nnumactl -i 0-7 -C 27 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n28)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='28'\nnumactl -i 0-7 -C 28 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n29)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='29'\nnumactl -i 0-7 -C 29 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n30)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='30'\nnumactl -i 0-7 -C 30 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n31)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='31'\nnumactl -i 0-7 -C 31 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n32)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='32'\nnumactl -i 0-7 -C 32 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n33)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='33'\nnumactl -i 0-7 -C 33 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n34)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='34'\nnumactl -i 0-7 -C 34 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n35)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='35'\nnumactl -i 0-7 -C 35 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n36)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='36'\nnumactl -i 0-7 -C 36 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n37)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='37'\nnumactl -i 0-7 -C 37 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n38)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='38'\nnumactl -i 0-7 -C 38 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n39)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='39'\nnumactl -i 0-7 -C 39 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n40)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='40'\nnumactl -i 0-7 -C 40 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n41)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='41'\nnumactl -i 0-7 -C 41 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n42)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='42'\nnumactl -i 0-7 -C 42 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n43)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='43'\nnumactl -i 0-7 -C 43 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n44)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='44'\nnumactl -i 0-7 -C 44 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n45)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='45'\nnumactl -i 0-7 -C 45 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n46)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='46'\nnumactl -i 0-7 -C 46 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n47)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='47'\nnumactl -i 0-7 -C 47 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n48)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='48'\nnumactl -i 0-7 -C 48 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n49)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='49'\nnumactl -i 0-7 -C 49 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n50)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='50'\nnumactl -i 0-7 -C 50 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n51)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='51'\nnumactl -i 0-7 -C 51 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n52)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='52'\nnumactl -i 0-7 -C 52 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n53)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='53'\nnumactl -i 0-7 -C 53 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n54)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='54'\nnumactl -i 0-7 -C 54 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n55)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='55'\nnumactl -i 0-7 -C 55 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n56)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='56'\nnumactl -i 0-7 -C 56 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n57)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='57'\nnumactl -i 0-7 -C 57 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n58)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='58'\nnumactl -i 0-7 -C 58 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n59)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='59'\nnumactl -i 0-7 -C 59 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n60)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='60'\nnumactl -i 0-7 -C 60 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n61)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='61'\nnumactl -i 0-7 -C 61 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n62)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='62'\nnumactl -i 0-7 -C 62 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\n63)\nexport OMP_NUM_THREADS=${threads}\nexport GOMP_CPU_AFFINITY='63'\nnumactl -i 0-7 -C 63 ./xhpl -n 1 -b 192 -p ${1} -q ${2} -m ${3}\n;;\nesac\n;;\nesac\n```\n\n### 8.2 编译问题\n\n```shell\n-lc \n\t解决找不到memcpy问题 \n-lstdc++\n\t解决vtable for xxxx 问题\n-lgcc_s\n\tundefined reference to `_Unwind_Resume'\n\tundefined reference to `__popcountdi2'\n\t\n#include <sys/types.h>\n#include <sys/types.h>\n\t implicit declaration of function ‘fstat’\n\n#include <sys/sysmacros.h>\n\timplicit declaration of function ‘major’\n```\n\n# 十、Linux操作\n\n## 10.1 ncat端口转发\n\n```shell\nncat --sh-exec \"ncat 25.8.27.6 15929\" -l 15929 --keep-open\n```\n\n# 十一、DDT安装\n\n```shell\n# cp Licence /home/gs/tools/arm/forge/licences/\n# cp Licence.14713 /home/gs/tools/arm/licenceserver/licences/\n\nexport PATH=/opt/mpi3.3/bin:/home/gs/tools/arm/forge/bin:/home/gs/tools/arm/licenceserver/bin:$PATH\nexport LD_LIBRARY_PATH=/opt/mpi3.3/lib:$LD_LIBRARY_PATH\nifconfig eth3 hw ether 00:1b:21:14:15:60\n```\n\n```shell\n#glex高速网版本的MPI改为本地调试用\nexport MPICH_NO_LOCAL=0 //？不一定需要\nexport MPICH_NEMESIS_NETMOD=tcp\nexport PATH=/usr/local/mpi3/bin:$PATH\nexport LD_LIBRARY_PATH=/usr/local/mpi3/lib:$LD_LIBRARY_PATH\n```\n\n\n\n# 十二、SPEC使用\n\n## 12.1 SPEC使用系统工具\n\n```shell\n# SEPC设置使用系统的工具\nvim /home/gs/tools/spack-v5/etc/spack/defaults/packages.yaml\n# 参考：\n../../../lib/spack/docs/build_settings.rst\n```\n\n# 十三、mi协议\n\n## 13.1 使用mi启动调试\n\n```shell\ngs@ft-svr:~/matrix$ gdb --interpreter mi test\n=thread-group-added,id=\"i1\"\n~\"GNU gdb (Ubuntu 8.2.91.20190405-0ubuntu3) 8.2.91.20190405-git\\n\"\n~\"Copyright (C) 2019 Free Software Foundation, Inc.\\n\"\n~\"License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\\nThis is free software: you are free to change and redistribute it.\\nThere is NO WARRANTY, to the extent permitted by law.\"\n~\"\\nType \\\"show copying\\\" and \\\"show warranty\\\" for details.\\n\"\n~\"This GDB was configured as \\\"aarch64-linux-gnu\\\".\\n\"\n~\"Type \\\"show configuration\\\" for configuration details.\\n\"\n~\"For bug reporting instructions, please see:\\n\"\n~\"<http://www.gnu.org/software/gdb/bugs/>.\\n\"\n~\"Find the GDB manual and other documentation resources online at:\\n    <http://www.gnu.org/software/gdb/documentation/>.\"\n~\"\\n\\n\"\n~\"For help, type \\\"help\\\".\\n\"\n~\"Type \\\"apropos word\\\" to search for commands related to \\\"word\\\"...\\n\"\n~\"Reading symbols from test...\\n\"\n(gdb)\n```\n\n## 13.2 断点命令（BreakPoint）\n\n### 13.2.1 -break-after\n\n```shell\n-break-after number count\n第number个断点在执行count次后有效\n```\n\n### 13.2.2 -break-condition\n\n```shell\n-break-condition number expr\n第number个断点在表达式expr为true时有效\n```\n\n### 13.2.3 -break-delete\n\n```shell\n-break-delete(breakpoint number)+\n删除指定number的多个断点\n```\n\n### 13.2.4 -break-disable\n\n```shell\n-break-disable(breakpoint number)+\n使用指定Number的多个断点失效\n```\n\n### 13.2.5 -break-enable\n\n```shell\n-break-enable(breakpoint number)+\n使用指定Number的多个断点生效\n```\n\n### 13.2.6 -break-info\n\n```shell\n-break-info breakpoint\n得到指定断点的信息\n```\n\n### 13.2.7 -break-insert\n\n```shell\n-break-insert\n\t-t\t\t\t\t插入临时断点\n\t-h\t\t\t\t插入硬件断点\n\t-r\t\t\t\t插入正则断点，当函数名匹配正则表达式时生效\n\t-c condition    插入条件断点\n\t-i ignore-count 插入一个指定无效次数的断点\n\t-p thread  \t\t\n\tline | addr(func) \n```\n\n### 13.2.8. -break-list\n\n```shell\n-break-list\n显示已插入的断点列表\n```\n\n### 13.2.9 -break-watch\n\n```shell\n-break-watch [-a|-r] variable\n创建一个观察点，-a标识对variable读写时有效，-r标识只读时有效\n```\n\n## 13.3 程序环境命令(Program Context)\n\n## 13.4 线程(thread)\n\n## 13.5 程序执行(Program Execution)\n\n\n\n## 13.6 栈(Stack)\n\n## 13.7 变量(Variable)\n\n## 13.8 数据(Data)\n\n## 13.9 跟踪点(TracePoint)\n\n## 13.10 符号(Symbol)\n\n## 13.11 文件(File)\n\n## 13.12 目标数据(Target Manipulation)\n\n## 13.13 其他\n\n```shell\n-enable-pretty-printing\n-var-create - * map\n-var-list-children --all-values var1 0 10\n\n-data-evaluate-expression map\n^done,value=\"std::map with 140737353945088 elements<error reading variable: Cannot access memory at address 0x1f0fc35f415e51>\"\n```\n\n\n\n```shell\n//    // 设置标记类型与颜色\n//    this->markerDefine(QsciScintilla::Circle, 0);\n//    this->setMarkerBackgroundColor(QColor(\"#ee6666\"), 0);\n//    this->markerDefine(QsciScintilla::Circle, 1);\n//    this->setMarkerBackgroundColor(QColor(\"#aaaaaa\"), 1);\n//    this->markerDefine(QsciScintilla::RightArrow, 2);\n//    this->setMarkerBackgroundColor(QColor(\"#eaf593\"), 2);\n```\n\n# 十四、Git改密码\n\n```shell\ngitlab-rails console production\n\nirb(main):002:0> user=User.where(email:'cuiyingbomail@163.com').first\n=> #<User id:30 @cyb>\nirb(main):003:0> user.password=12345678\n=> 12345678\nirb(main):004:0> user.password_confirmation=12345678\n=> 12345678\nirb(main):005:0> user.save!\nEnqueued ActionMailer::DeliveryJob (Job ID: 540244db-c6ec-44f9-880e-72338b955aa5) to Sidekiq(mailers) with arguments: \"DeviseMailer\", \"password_change\", \"deliver_now\", #<GlobalID:0x00007f57f5da3208 @uri=#<URI::GID gid://gitlab/User/30>>\n=> true\n\n```\n\n# 十五、YHPDE（eclipse）FT部署\n\n```shell\n1、安装eclipse:\n\tgitlab\n2、插件安装，参考手册\n2、新版SLURM需要\nvim org.eclipse.ptp.rm.slurm.proxy_4.0.7.201104291906/src/ptp_slurm_proxy.c\n1625行：slurm_allocation_lookup_lite -> slurm_allocation_lookup\n2942行: primary = 1; ->  primary = 0;\n2943行：secondary = 2; -> secondary = 1;\n```\n\n","slug":"02_测试/02_测试工具使用说明-完善中","published":1,"updated":"2022-07-07T02:30:03.481Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k09000ca8v7bweg8ici","content":"<h1 id=\"测试工具使用说明-汇总\"><a href=\"#测试工具使用说明-汇总\" class=\"headerlink\" title=\"测试工具使用说明-汇总\"></a>测试工具使用说明-汇总</h1><h1 id=\"一、SPEC-CPU-2017-测试\"><a href=\"#一、SPEC-CPU-2017-测试\" class=\"headerlink\" title=\"一、SPEC CPU 2017 测试\"></a>一、SPEC CPU 2017 测试</h1><h2 id=\"1-1-概述\"><a href=\"#1-1-概述\" class=\"headerlink\" title=\"1.1 概述\"></a>1.1 概述</h2><p>​\t标准性能评测机构（SPEC）开发的用于评测CPU性能的基准程序测试组，是一套CPU子系统测试工具。处理器、内存和编译都会影响最终的测试结果，目前SPEC CPU是业界首选的CPU评测工具。 </p>\n<h2 id=\"1-2-工具安装\"><a href=\"#1-2-工具安装\" class=\"headerlink\" title=\"1.2 工具安装\"></a>1.2 工具安装</h2><p>获取镜像包：</p>\n<p>​\tcpu2017-1_0_5.iso</p>\n<p>挂载IOS</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mount -o loop -t iso9660 cpu2017-1_0_5.iso &#x2F;xxx&#x2F;cpu2017CD<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>安装工具</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd &#x2F;xxx&#x2F;cpu2017CD\n.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-3-测试步骤\"><a href=\"#1-3-测试步骤\" class=\"headerlink\" title=\"1.3 测试步骤\"></a>1.3 测试步骤</h2><p>spec2017主要分为四项测试：</p>\n<ul>\n<li>​\tintrate</li>\n<li>​\tfprate</li>\n<li>​\tintspeed</li>\n<li>​\tfpspeed</li>\n</ul>\n<p>​\t根据需要测试的cpu型号，可以到官网下载相应的cfg文件，修改icc、Jemalloc库、qkmalloc库的路径，放入config文件夹中。</p>\n<p>测试命令如下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\nulimit -s unlimited\n# speed 测试\nruncpu --config&#x3D;icc-speed-official.cfg --threads&#x3D;48 --define cores&#x3D;48 -n 3 -i ref fpspeed intspeed\n\n# rate 测试\nruncpu --config&#x3D;icc-rate-official.cfg -copies&#x3D;48 -n 3 -i ref intrate fprate\n\n-----------------------------------------------------------------------\n\n# 仅编译不跑测试\n--action&#x3D;build\n# 重新编译\n--rebuild\n# 绑核跑\ntaskset -c <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-4-测试优化\"><a href=\"#1-4-测试优化\" class=\"headerlink\" title=\"1.4 测试优化\"></a>1.4 测试优化</h2><blockquote>\n<p>Bios设置：</p>\n<p>​\t开启超线程</p>\n<p>​\t 尝试开启LLC-PREFETCH</p>\n</blockquote>\n<h2 id=\"1-5-其他事项：\"><a href=\"#1-5-其他事项：\" class=\"headerlink\" title=\"1.5 其他事项：\"></a>1.5 其他事项：</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cfg文件中的submit可以设置绑核选项<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"二、SPEC-CPU-2006-测试\"><a href=\"#二、SPEC-CPU-2006-测试\" class=\"headerlink\" title=\"二、SPEC CPU 2006 测试\"></a>二、SPEC CPU 2006 测试</h1><h2 id=\"2-1-概述\"><a href=\"#2-1-概述\" class=\"headerlink\" title=\"2.1 概述\"></a>2.1 概述</h2><p>​\t作用同Spec CPU 2017, 近年来逐渐被淘汰</p>\n<h2 id=\"2-2-测试步骤\"><a href=\"#2-2-测试步骤\" class=\"headerlink\" title=\"2.2 测试步骤\"></a>2.2 测试步骤</h2><p>1、spec2006.tgz 解压，使用install.sh安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">SPEC CPU2006 Installation\nTop of the CPU2006 tree is &#39;&#x2F;vol8&#x2F;tarball&#x2F;cpu2006&#39;\nThese appear to be valid toolsets:\nft-spec2006-tool\naarch64-linux\nEnter the architecture you are using:\n&gt;&gt; aarch64-linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\n# 单核测试\nrunspec -c linux64-arm64-gcc52.cfg -i ref -n 3 -I all \n# 多核测试（16）\nrunspec -c linux64-arm64-gcc52.cfg -r 16 -n 3 -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"三、-SPEC-OMP-2012-测试\"><a href=\"#三、-SPEC-OMP-2012-测试\" class=\"headerlink\" title=\"三、 SPEC OMP 2012 测试\"></a>三、 SPEC OMP 2012 测试</h1><h2 id=\"3-1-概述\"><a href=\"#3-1-概述\" class=\"headerlink\" title=\"3.1 概述\"></a>3.1 概述</h2><p>​\t基于SPEC测试套件的OpenMP评测工具，其中包含15个基于OpenMP的并行程序。</p>\n<h2 id=\"3-2-工具安装\"><a href=\"#3-2-工具安装\" class=\"headerlink\" title=\"3.2 工具安装\"></a>3.2 工具安装</h2><p>​\t获取源包：</p>\n<p>​\t\tomp2012-1.1.zip</p>\n<p>​\t解压后使用install.sh安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装\n.&#x2F;install.sh -d &#x2F;home&#x2F;xx\n# 仅编译\nrunspec --action&#x3D;build --config&#x3D;gcc.cfg -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-3-测试步骤\"><a href=\"#3-3-测试步骤\" class=\"headerlink\" title=\"3.3 测试步骤\"></a>3.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\nulimit -s unlimited\nexport OMP_NUM_THREADS&#x3D;48\nrunspec --config&#x3D;gcc.cfg --threads 48 -n 3 -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"四、NPB-测试\"><a href=\"#四、NPB-测试\" class=\"headerlink\" title=\"四、NPB 测试\"></a>四、NPB 测试</h1><h2 id=\"4-1-概述\"><a href=\"#4-1-概述\" class=\"headerlink\" title=\"4.1 概述\"></a>4.1 概述</h2><p>​\tNAS并行基准测试程序（NPB），是由美国航空航天局开发的一套代表流体动力学计算的应用程序集，它已经成为公认的用于测评大规模并行机和超级计算机的标准测试程序。NPB可用于常用的编程模型，如MPI和OpenMP。</p>\n<h2 id=\"4-2-工具安装\"><a href=\"#4-2-工具安装\" class=\"headerlink\" title=\"4.2 工具安装\"></a>4.2 工具安装</h2><p>源包获取：</p>\n<p>​\tNPB3.4.tar.gz         OpenMP || MPICH</p>\n<p>​\tNPB3.4-MZ.tar.gz  OpenMP &amp;&amp; MPICH</p>\n<p>解压即可。</p>\n<h2 id=\"4-3-测试步骤\"><a href=\"#4-3-测试步骤\" class=\"headerlink\" title=\"4.3 测试步骤\"></a>4.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make suite\ncd bin\nmpirun -np 4 .&#x2F;xxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"五、Stream-测试\"><a href=\"#五、Stream-测试\" class=\"headerlink\" title=\"五、Stream 测试\"></a>五、Stream 测试</h1><h2 id=\"5-1-概述\"><a href=\"#5-1-概述\" class=\"headerlink\" title=\"5.1 概述\"></a>5.1 概述</h2><p>​\tSTREAM是一套综合性能测试程序集，通过fortran和C两种高级且高效的语言编写完成，由于这两种语言在数学计算方面的高效率， 使得 STREAM 测试例程可以充分发挥出内存的能力。Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。</p>\n<h2 id=\"5-2-工具安装\"><a href=\"#5-2-工具安装\" class=\"headerlink\" title=\"5.2 工具安装\"></a>5.2 工具安装</h2><p>源包获取：</p>\n<p>​\tstream.tgz  刘新娃修改过</p>\n<p>​\t<font color='red'>Intel平台请用ICC</font></p>\n<p>解压后编译stream.c, 生成可执行文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">icc -O3 -fopenmp -DNTIMES&#x3D;10 -mcmodel&#x3D;large -o stream_c stream.c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>没有修改过的怎么编译呢？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">icc -mtune&#x3D;native -march&#x3D;native -O3 -mcmodel&#x3D;large -fopenmp -DSTREAM_ARRAY_SIZE&#x3D;100000000 -DNTIMES&#x3D;30 -DOFFSET&#x3D;512 stream.c -o stream-gs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"5-3-测试步骤\"><a href=\"#5-3-测试步骤\" class=\"headerlink\" title=\"5.3 测试步骤\"></a>5.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export OMP_NUM_THREADS&#x3D;48&#x2F;32&#x2F;16&#x2F;8&#x2F;4  # 设置每个进程的线程数\n.&#x2F;stream_c 200000 # 使用200G内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"5-4-其他事项\"><a href=\"#5-4-其他事项\" class=\"headerlink\" title=\"5.4 其他事项\"></a>5.4 其他事项</h2><blockquote>\n<p><code>STREAM_ARRAY_SIZE</code>即<code>N</code>指定计算中a[],b[],c[]三个数组的大小，且数组的值采用了双精度（8个字节）。数组的维数 N定义时需要注意以下几点：</p>\n<p>一、要充分考虑内存容量的需求，粗略估计是 N× 8（双精度浮点类型） × 3 （三个数组）&lt;&#x3D; 0.6*M；M 是用户的可用内存。</p>\n<p>二、要保证测试过程中，使用到的内存容量要大于处理器内的缓存，只有这样才会有内存的操作，而不仅仅是对处理器内缓存的操作。</p>\n<p>三、为了保证测试可以持续一段时间，测试过程中内存带宽可以达到一定的最大值， 从而避免得不到实际最大峰值的情况，如果四项测试中有完成时间小于20微秒的情况，就需要适当的增大测试数组的维度 N。</p>\n</blockquote>\n<h1 id=\"六、Linpack-测试\"><a href=\"#六、Linpack-测试\" class=\"headerlink\" title=\"六、Linpack 测试\"></a>六、Linpack 测试</h1><h2 id=\"6-1-概述\"><a href=\"#6-1-概述\" class=\"headerlink\" title=\"6.1 概述\"></a>6.1 概述</h2><p>​\tLinpack是国际上使用最广泛的测试高性能计算机系统浮点性能的基准测试。通过对高性能计算机采用高斯消元法求解一元 N次稠密线性代数方程组的测试，评价高性能计算机的浮点计算性能。Linpack的结果按每秒浮点运算次数（flops）表示。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">N ^ 2 * 8 &#x3D; 总内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"6-2-工具安装\"><a href=\"#6-2-工具安装\" class=\"headerlink\" title=\"6.2 工具安装\"></a>6.2 工具安装</h2><p>源包获取：</p>\n<p>​\tlinpack.tgz</p>\n<p>解压即可。</p>\n<h2 id=\"6-3-测试步骤\"><a href=\"#6-3-测试步骤\" class=\"headerlink\" title=\"6.3 测试步骤\"></a>6.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1进48线100G内存\n.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 100000\n# 1进48线200G内存\n.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 200000\n# 2进24线共100G内存\nmpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 50000\n# 2进24线共200G内存\nmpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 100000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用mpirun提交xhplrun.sh效果更好</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">PRO_SIZE&#x3D;$&#123;PMI_SIZE&#125;\nthreads&#x3D;&#96;echo $&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;\nPMI_RANK_my&#x3D;$&#123;PMI_RANK&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-4-测试优化（重点）\"><a href=\"#6-4-测试优化（重点）\" class=\"headerlink\" title=\"6.4 测试优化（重点）\"></a>6.4 测试优化（重点）</h2><blockquote>\n<p>一、计算理论内存总带宽</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;计算方法：\n&gt;查看内存带宽：\n&gt;dmidecode | grep -A 16 &quot;Memory Device&quot;\n&gt;例如内存信息为：\n&gt;三星 DDR4 \n&gt;16G 每根\n&gt;2666 MT&#x2F;s（Mhz）\n&gt;查看cpu支持的通道数，例如intel 6252N支持6通道，两个CPU支持12通道\n&gt;理论带宽计算DDR4：\n&gt;单条内存带宽 &#x3D; 内存核心频率 x 内存总线位数 x 倍增系数\n &#x3D; 2666 * 64 &#x2F; 8 &#x3D; 21328 MB&#x2F;s &#x3D; 21.3G&#x2F;s\n&gt;12通道总内存带宽 &#x3D; 21328 * 12 &#x3D; 255936 &#x3D; 250G&#x2F;s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>二、使用stream测试实际内存总带宽</p>\n<p>​\t如果可以达到90%或以上，说明内存带宽正常, 继续Linpack测试</p>\n<p>三、计算CPU理论峰值</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;计算方法：\nMhz * 每个时钟周期执行浮点运算的次数 * CPU数目\n&gt;&#x3D;\n2.3 x ( 8 x 2 x 2 ) x 48 &#x3D; 3532.8 Gflops\n&gt;说明：\n峰值计算分为单精度和双精度浮点运算\n&gt;单精度：\n32bit的指令长度的运算，对应32位操作系统\n&gt;双精度：\n64bit的指令长度的运算，对应64位操作系统\n&gt;查找CPU可以处理什么样的指令集：\n例如Intel官网查到Intel Xeon 6252N\n支持AVX-512，\n# of AVX-512 FMA Units &#x3D; 2\n(Fused Multiply Add instructions) 融合了 乘法 和 加法\n即可以单个周期同时执行2条512bit的加法和2条512bit的乘法\n&gt;理解上述两个概念，可以开始计算（CPU单周期浮点计算能力）\n&gt;Intel 6252N (支持avx512，有512位)\n&gt;单精度：\n2.3 x 512&#x2F;32 x 2 x 2 &#x3D; 147.2Gflops \n&gt;双精度\n2.3 x 512&#x2F;64 x 2 x 2 &#x3D; 73.6Gflops\n&gt;双精度共48核\n74.6 x 48 &#x3D; 3580\n\n&gt;FT2000+ 和 FT1500A (只有128位)，FT3000加入sve指令集(128-256位)\n&gt;单精度： \n2.2 x 128&#x2F;32 * 2 &#x3D; 4.4\n&gt;双精度:\n2.2 x 128&#x2F;64 * 2 &#x3D; 8.8\n&gt;双精度共64核\n8.8 x 64 &#x3D; 563.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>四、使用Linapack测试CPU实际峰值</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;如果性能达到理论峰值的70%说明正常，如果未达到尝试以下优化<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;1、使用mpirun运行xhpl, 按&#96;lscpu&#96; 中的NUMA分组绑定,&#96;比如48核，分为两个Numa Node&#96;, 则用mpirun&#96;跑两个xhpl进程&#96;，每个进程使用 OMP_NUM_THREADS&#x3D;24, 跑24线程，这样可以将核用满。\n&gt;在&#96;Intel&#96;平台，两个进程分别使用 HPL_HOST_CORE&#x3D;&#39;0-23&#39; 以及 HPL_HOST_CORE&#x3D;&#39;24-47&#39; 绑定核\n&gt;在&#96;Arm64&#96;平台，则使用 GOMP_CPU_AFFINITY&#x3D;&#39;0-23&#39; 以及 GOMP_CPU_AFFINITY&#x3D;&#39;24-47&#39; 绑定\n&gt;2、内存不用分配太大，根据stream测试结果分配，从小开始测\n&gt;3、Intel平台编译器使用ICC，测试linpack使用icc自带的linpack，mpi使用icc自带的\n&gt;4、Bios中关闭超线程，开启超频(turbo&#x2F;P-state)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><strong><font color=\"blue\">先测stream,判断带宽是否正常，再测linpack，然后再测Spec Cpu</font></strong></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># Intel平台可以使用的控制频率的命令\ncpupower -c all frequency-set -g performance\ncpupower -c 0-95 frequency-set -g userspace\ncpupower -c 0-95 frequency-set -f 2700000\n\n# 查看当前频率控制是否为perfomance？\ncat &#x2F;sys&#x2F;devices&#x2F;system&#x2F;cpu&#x2F;cpu0&#x2F;cpufreq&#x2F;scaling_governor\n\n# 跑xhpl之前设置指令集，或许有用\nexport MKL_ENABLE_INSTRUCTIONS&#x3D;AVX512<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"G:\\工作\\2020年3月\\CN9性能测试\\测试组合.png\" alt=\"image-20200415171716940\"></p>\n<h2 id=\"6-5-HPL-dat修改\"><a href=\"#6-5-HPL-dat修改\" class=\"headerlink\" title=\"6.5 HPL.dat修改\"></a>6.5 HPL.dat修改</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 第1-2行，注释说明行\nHPLinpack benchmark input file   \nInnovative Computing Laboratory, University of Tennessee  \n\n# 第 3-4 行，输出结果文件的形式\nHPL.out      output file name (if any)  \n6            device out (6&#x3D;stdout,7&#x3D;stderr,file) \n\n# 5-6行，求解矩阵的大小\n1            # of problems sizes (N)  \n1000         Ns   \n\n# 7-8行 求解矩阵分块的大小\n1            # of NBs\n192 256      NBs\n\n# 9行 处理器阵列的排列方式，行还是列\n0：适用于节点较少，单个节点CPU较多的胖系统\n1：适用于节点较多，单个节点CPU较少的瘦系统（机群上远好于按行排列）\n1            PMAP process mapping (0&#x3D;Row-,1&#x3D;Column-major) \n\n# 10-12行 定义二维处理网格P&#x2F;Q\n# P X Q &#x3D; 进程数，P尽量小于Q\n# P&#x3D;2^n,P最好选择2的幂\n1            # of process grids (P x Q) \n1 2          Ps\n1 2          Qs\n\n# 13行 设置阀值，不用修改\n16.0         threshold\n\n# 14-21行 设置L的分解方式\n1            # of panel fact\n2 1 0        PFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大\n1            # of recursive stopping criterium\n4 8          NBMINs (&gt;&#x3D; 1)   # 4或8都不错\n1            # of panels in recursion\n2            NDIVs  # 选2比较理想\n1            # of recursive panel fact.\n1 0 2        RFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大\n\n# 22-23行 设置L的横向广播方式\n# 前四种，适用于快速网络，后两种适用于速度较慢的网络\n# 小规模系统，选择0&#x2F;1，大规模系统选择3\n1            # of broadcast\n0            BCASTs (0&#x3D;1rg,1&#x3D;1rM,2&#x3D;2rg,3&#x3D;2rM,4&#x3D;Lng,5&#x3D;LnM)\n\n# 24-25行 设置横向通信的通信深度\n# 小规模系统选择1&#x2F;2，大规模系统2-5之间\n1            # of lookahead depth\n1            DEPTHs (&gt;&#x3D;0)\n\n# 26-27 设置U的广播算法\n# 小规模系统，使用缺省值即可\n0            SWAP (0&#x3D;bin-exch,1&#x3D;long,2&#x3D;mix)\n1            swapping threshold\n\n# 28-29行 L和U的数据存放格式\n0：按列存放\n1：按行存放\n0            L1 in (0&#x3D;transposed,1&#x3D;no-transposed) form\n0            U  in (0&#x3D;transposed,1&#x3D;no-transposed) form\n\n# 30-31 缺省值即可\n0            Equilibration (0&#x3D;no,1&#x3D;yes)\n8            memory alignment in double (&gt; 0)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-6-测试脚本编写\"><a href=\"#6-6-测试脚本编写\" class=\"headerlink\" title=\"6.6 测试脚本编写\"></a>6.6 测试脚本编写</h2><h3 id=\"6-6-1-本地mpirun测试脚本（Intel版本）\"><a href=\"#6-6-1-本地mpirun测试脚本（Intel版本）\" class=\"headerlink\" title=\"6.6.1 本地mpirun测试脚本（Intel版本）\"></a>6.6.1 本地mpirun测试脚本（Intel版本）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 本地单节点测试，需要根据&#96;lscpu&#96;中numa分区情况(node)的使用mpirun测试xhpl\n# eg:在未开超线程的情况下，分为两个node，每个node中有12个核，则最佳测试方法为mpirun -np 2 .&#x2F;myrun.sh\n# 以下为myrun.sh的具体实现\n\n#!&#x2F;bin&#x2F;bash\nulimit -s unlimited\nCores&#x3D;48\nThreadsNum&#x3D;&#96;echo &quot;$&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125;&quot; | bc&#96; # 计算每个进程跑的线程数\ncase $&#123;PMI_SIZE&#125; in\n2)\n        case $&#123;PMI_RANK&#125; in\n        0)\n        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;\n        export HPL_HOST_CORE&#x3D;&#39;0-23&#39;\n        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n        ;;\n        1)\n        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;\n        export HPL_HOST_CORE&#x3D;&#39;24-47&#39;\n        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n        ;;\n        esac\n;;\nesac\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-6-2-Slurm-srun测试脚本-FT版本\"><a href=\"#6-6-2-Slurm-srun测试脚本-FT版本\" class=\"headerlink\" title=\"6.6.2 Slurm srun测试脚本(FT版本)\"></a>6.6.2 Slurm srun测试脚本(FT版本)</h2><p>xhplrun.sh</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\nulimit -s unlimited\nCores&#x3D;48\n\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nPMI_SIZE&#x3D;$SLURM_NPROCS\nPMI_RANK&#x3D;$SLURM_PROCID\nMPI_NUM_NODE&#x3D;$SLURM_NNODES\nMPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))\nMPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))\n\nPRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;\nPMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n\necho $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;\n\nexport HPL_CMDLINE&#x3D;1\ncase $&#123;PRO_SIZE&#125; in\n1)\n#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\ncase $&#123;PMI_RANK_my&#125; in\n0)\n#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;\nnumactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\n#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;\nnumactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>yhrun 提交作业 runpro.sh</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE&#x3D;1\n\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH\n\nnodes&#x3D;$&#123;1&#125;\nnnodes&#x3D;$&#123;2&#125;\nnprocs&#x3D;$&#123;3&#125;\nnmem&#x3D;$&#123;4&#125;\nlogdir&#x3D;$&#123;5&#125;\n\n\nmkdir -p $&#123;logdir&#125;\n\ntnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))\nP&#x3D;1\nQ&#x3D;1\nfor i in &#96;seq 1 $&#123;tnprocs&#125;&#96;\ndo\n        for j in &#96;seq 1 $&#123;tnprocs&#125;&#96;\n        do\n                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))\n                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ] &amp;&amp; [ $&#123;i&#125; -le $&#123;j&#125; ]\n                then\n                        P&#x3D;$&#123;i&#125;\n                        Q&#x3D;$&#123;j&#125;\n                fi\n        done\ndone\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;\ndone\nwait\nsleep 1\n\nj&#x3D;0\nrunnodes&#x3D;&#39;&#39;\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        runnodes+&#x3D;$&#123;i&#125;,\n        let j++\n        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]\n        then\n                echo &quot;yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;\n                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log\n                yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                j&#x3D;0\n                runnodes&#x3D;&#39;&#39;\n        fi\ndone<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-7-Bios设置\"><a href=\"#6-7-Bios设置\" class=\"headerlink\" title=\"6.7 Bios设置\"></a>6.7 Bios设置</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">琦哥的：\n    UPI Configuration\n        Link Lop -&gt; disable\n        Link L1  -&gt; disable \n        IO Directory Cache -&gt; enable\n        Isoc Mode -&gt; enable\n\n    Memory Configuration\n        Eufsrce POR -&gt; enable\n        PPR Type -&gt; Soft PPR\n        Memory Frequency -&gt; 2666\n        Data Scrambling for NVMDIMM -&gt; enable\n        Data Scrambling for DDR4 -&gt; enable\n        Enable AOR -&gt; enable\n        Refresh Option -&gt; enable\n        Memory RAS\n            Memory Rank Sparing -&gt; enable\n\n    IIO Configuration\n        PCI-E Port Max Payload Size -&gt; 256B\n\n    CPU P-State\n        SpeedStep -&gt; disable&#x2F;enable?\n        PBF \n        Hardware P-State -&gt; enable\n        Package c state -&gt; No limit \n\t\n网上找的系统Bios设置优化\n    关闭超线程\n    打开EIST\n    打开Turbo Mode\n    Boot Performance mode设置为max performance\n    Energy Performance BIAS设置为Performance\n    打开Monitor&#x2F;Mwait\n    Package C stat limit设置为C0&#x2F;C1 state\n    关闭CPU C3 report\n    关闭CPU C6 report\n    关闭Enhanced Halt State\n    关闭Intel VT for Directed I&#x2F;O\n    Linux OS下CPU Power Management设置为max performance\n    QPI及Memory Frequency保持为Max Frequency\n    关闭NUMA功能 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-8-结果反馈\"><a href=\"#6-8-结果反馈\" class=\"headerlink\" title=\"6.8 结果反馈\"></a>6.8 <span id=\"jump\">结果反馈</span></h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#linpack测试以我们为主导\n\n1、grep FAILED 关键字,查看是否有节点计算错误\n2、grep WR 查看节点性能是否正常\n3、统计跑死的点\n\n# 如何反馈？\n一轮Linpack40分钟测试完成\n\t一、6个点本是drain*状态\n\t二、3个点跑死，cn[1,2,3]\n\t三、5个点Linpack计算FAILED\n\t四、其他点linpakc性能正常\n可以考虑更换下一批<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-9-风冷系统linpack测试全过程记录\"><a href=\"#6-9-风冷系统linpack测试全过程记录\" class=\"headerlink\" title=\"6.9 风冷系统linpack测试全过程记录\"></a>6.9 风冷系统linpack测试全过程记录</h2><blockquote>\n<h5 id=\"1、了解风冷系统的架构\"><a href=\"#1、了解风冷系统的架构\" class=\"headerlink\" title=\"1、了解风冷系统的架构\"></a>1、了解风冷系统的架构</h5><p>按批次测试，测完一批换下一批</p>\n<p>一批为192个节点，每个框32个节点，共6个框</p>\n<p>每个节点128G内存，芯片为FT2000+, 通过mhz获取频率为2000（降频），64物理核</p>\n<p>系统版本： 4.19.46-cn+</p>\n<h5 id=\"2、计算每个节点的理论峰值\"><a href=\"#2、计算每个节点的理论峰值\" class=\"headerlink\" title=\"2、计算每个节点的理论峰值\"></a>2、计算每个节点的理论峰值</h5><p>2000 * 128 &#x2F; 64 * 2 * 64&#x3D; 512000</p>\n<h5 id=\"3、开始测试\"><a href=\"#3、开始测试\" class=\"headerlink\" title=\"3、开始测试\"></a>3、开始测试</h5><p>runpro.sh脚本参数说明:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh NodeList NodeBind ProcessesPerNode MemSize\n&gt;NodeList 节点列表,例如cn[0-8]\n&gt;NodeBind 几个节点绑定运行，例如2，则计算效率时，需要将结果得到的效率&#x2F;2&#x2F;512\n&gt;ProcessesPerNode 每给节点运行几个xhpl进程，根据numa node来，FT一般是8\n&gt;MemSize 每个节点中，每个进程分配的内存，一般使用到约总内存的80%，例如单节点128G，填写12000（单位为Mb），则总使用96G内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>单节点测试：</p>\n<p>​\t不需要互联测试网络联通性，仅对单节点进行压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>多节点测试：</p>\n<p>​\t需要互联测试网络联通性， 2，4， 8， 16， 32， 64， 128，如果要求测多节点稳定性，测试的8点8进8线，结果按<a href=\"#jump\">章节6.8</a>反馈</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>问题解决一：</p>\n<p>​\t测试到128节点，性能异常，效率仅有43%</p>\n<p>互联那边回应：</p>\n<p>​\t节点数超过64，通信就跨框</p>\n<p>琦哥建议的做法：</p>\n<p>​\t把128个节点分到4个框，测试一下，看是不是带宽的原因</p>\n<p>最后的解决方法：</p>\n<p>​\t网络拓扑更换，矩阵值不能相等，使用原本32 x 32，改为16 x 64，但是换成160节点后还是有问题</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn[xx-xx] 128 8 12000 dir\n&gt;其中执行的xhplrun.sh的参数为\n&gt;xhplrun.sh 32 32 12000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n</blockquote>\n<h1 id=\"七、Lmbench-测试\"><a href=\"#七、Lmbench-测试\" class=\"headerlink\" title=\"七、Lmbench 测试\"></a>七、Lmbench 测试</h1><h2 id=\"7-1-概述\"><a href=\"#7-1-概述\" class=\"headerlink\" title=\"7.1 概述\"></a>7.1 概述</h2><p>​\tLmbench是一套简易，可移植的，符合ANSI&#x2F;C标准为UNIX&#x2F;POSIX而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。LmBench旨在使系统开发者深入了解关键操作的基础成本。</p>\n<h2 id=\"7-2-工具安装\"><a href=\"#7-2-工具安装\" class=\"headerlink\" title=\"7.2 工具安装\"></a>7.2 工具安装</h2><p>获取源包：</p>\n<p>​\tlmbench3.tar.gz</p>\n<p>gcc编译安装</p>\n<h2 id=\"7-3-测试步骤\"><a href=\"#7-3-测试步骤\" class=\"headerlink\" title=\"7.3 测试步骤\"></a>7.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd src\nmake results\nmake see\n内存10G。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">错误处理：\n[root@cn9 lmbench3]# cd src&#x2F;\n[root@cn9 src]# make results\ngmake[1]: Entering directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;\ngmake[1]: *** No rule to make target &#96;..&#x2F;SCCS&#x2F;s.ChangeSet&#39;, needed by &#96;bk.ver&#39;.  Stop.\ngmake[1]: Leaving directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;\n解决方法：\n\tvim Makefile\n\t231行修改：\n\t$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench bk.ver\n\t改为\n\t$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"八、IOR-测试（暂无）\"><a href=\"#八、IOR-测试（暂无）\" class=\"headerlink\" title=\"八、IOR 测试（暂无）\"></a>八、IOR 测试（暂无）</h1><h1 id=\"九、alltoall测试\"><a href=\"#九、alltoall测试\" class=\"headerlink\" title=\"九、alltoall测试\"></a>九、alltoall测试</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yhrun -n 128 -N 8 -w cn34,cn35,cn36,cn37,cn38,cn39,cn40,cn41, &#x2F;root&#x2F;xm_alltoall 102400 1000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"附录：常用工具链编译方法\"><a href=\"#附录：常用工具链编译方法\" class=\"headerlink\" title=\"附录：常用工具链编译方法\"></a>附录：常用工具链编译方法</h1><h2 id=\"一、GCC编译\"><a href=\"#一、GCC编译\" class=\"headerlink\" title=\"一、GCC编译\"></a>一、GCC编译</h2><p>需要依次编译依赖软件，然后在编译gcc中使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 设置isl的库路径\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH\n# 编译GCC\n..&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --enable-lto --disable-bootstrap --enable-languages&#x3D;c,c++,fortran --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpc&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-isl&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-1-依赖软件编译\"><a href=\"#1-1-依赖软件编译\" class=\"headerlink\" title=\"1.1 依赖软件编译\"></a>1.1 依赖软件编译</h3><h4 id=\"1-1-2-编译安装gmp\"><a href=\"#1-1-2-编译安装gmp\" class=\"headerlink\" title=\"1.1.2 编译安装gmp\"></a>1.1.2 编译安装gmp</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake \nmake install\n\n.&#x2F;configure --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83  --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-3-编译安装mpfr\"><a href=\"#1-1-3-编译安装mpfr\" class=\"headerlink\" title=\"1.1.3 编译安装mpfr\"></a>1.1.3 编译安装mpfr</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake \nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-4-编译安装mpc\"><a href=\"#1-1-4-编译安装mpc\" class=\"headerlink\" title=\"1.1.4 编译安装mpc\"></a>1.1.4 编译安装mpc</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake\nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-5-编译安装isl\"><a href=\"#1-1-5-编译安装isl\" class=\"headerlink\" title=\"1.1.5 编译安装isl\"></a>1.1.5 编译安装isl</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp-prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"> yum install gcc-* gtk2 gtk3 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686\nglibc.i686 glibc-devel.i686 libgcc* xulrunner.x86_64 xulrunner.i686 glibc-devel.x86_64 glibc.x86_64 autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\nmount -o loop -t iso9660 &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM\n\n\nyum install gcc-* gtk2 gtk3 glibc-devel.i686 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686 glibc* libgcc* xulrunner* autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、MPICH3编译\"><a href=\"#二、MPICH3编译\" class=\"headerlink\" title=\"二、MPICH3编译\"></a>二、MPICH3编译</h2><p>设置gcc830的环境变量</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$LD_INCLUDE_PATH\nexport CPATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$CPATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib64:$LD_LIBRARY_PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;libexec:$LD_LIBRARY_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>再编译</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830 --enable-fast --enable-shared&#x3D;yes --enable-threads&#x3D;runtime --with-ch3-rank-bits&#x3D;32 --enable-romio --with-file-system&#x3D;ufs+nfs --with-mpe\nmake \nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>设置环境变量使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;include:$LD_INCLUDE_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"三、Redhat设置本地镜像源\"><a href=\"#三、Redhat设置本地镜像源\" class=\"headerlink\" title=\"三、Redhat设置本地镜像源\"></a>三、Redhat设置本地镜像源</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mount -o loop -t iso9660 &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;mnt&#x2F;CDROM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;redhat.repo\n\n[rhel7.6]\nname&#x3D;rhel7.6\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM\nenabled&#x3D;1\ngpgcheck&#x3D;0\npriority&#x3D;1\n\nyum clean\nyum update\nyum repolist<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、找不到so库的解决方法\"><a href=\"#四、找不到so库的解决方法\" class=\"headerlink\" title=\"四、找不到so库的解决方法\"></a>四、找不到so库的解决方法</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 方法一：\n\t设置LD_LIBRARY_PATH\n# 方法二：\n \tvim &#x2F;etc&#x2F;ld.so.conf\n \t----------------------------------------------------\n \tinclude ld.so.conf.d&#x2F;*.conf\n\t&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries&#x2F;linux&#x2F;lib&#x2F;intel64\n\tldconfig 更新<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、复制以及查看端口占用\"><a href=\"#五、复制以及查看端口占用\" class=\"headerlink\" title=\"五、复制以及查看端口占用\"></a>五、复制以及查看端口占用</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 查看端口占用\nnetstat -nultp | grep 8080\nnetstat -anp  | grep 80\nnetstat -ano | grep 18130\nlsof -i:18130\n\n# 复制\nrsync -chavP &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;postgresql .\nrsync -avzP 复制显示进度\n\n# 查看Bios版本\ndmidecode<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">\nmpiicc -DAdd__ -DF77_INTEGER&#x3D;int -DStringSunStyle -DHPL_DETAILED_TIMING -DHPL_PROGRESS_REPORT -I&#x2F;root&#x2F;hpl&#x2F;include -I&#x2F;root&#x2F;hpl&#x2F;include&#x2F;Linux_Intel64 -I&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;include  -O3 -w -ansi-alias -i-static -z noexecstack -z relro -z now -nocompchk -Wall -qopenmp -mt_mpi -o &#x2F;root&#x2F;hpl&#x2F;bin&#x2F;Linux_Intel64&#x2F;xhpl HPL_pddriver.o         HPL_pdinfo.o           HPL_pdtest.o &#x2F;root&#x2F;hpl&#x2F;lib&#x2F;Linux_Intel64&#x2F;libhpl.a  -L&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;lib&#x2F;intel64 -Wl,--start-group &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_lp64.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_thread.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_core.a -Wl,--end-group -lpthread -ldl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、查看cpu主频率-和-内存信息\"><a href=\"#六、查看cpu主频率-和-内存信息\" class=\"headerlink\" title=\"六、查看cpu主频率 和 内存信息\"></a>六、查看cpu主频率 和 内存信息</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 查看CPU信息\nlscpu 其中 sockets个数代表物理核个数\ncat &#x2F;proc&#x2F;cpuinfo\nlmbench的mhz\n&#x2F;usr&#x2F;bin&#x2F;turbostat\n\n# 查看内存信息\ncat &#x2F;proc&#x2F;meminfo\ndmidecode | grep -A 16 &quot;Memory Device&quot;、<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"七、GLSL-1-50-is-not-supported\"><a href=\"#七、GLSL-1-50-is-not-supported\" class=\"headerlink\" title=\"七、GLSL 1.50 is not supported\"></a>七、GLSL 1.50 is not supported</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 报错：\nERROR: In &#x2F;home&#x2F;gs&#x2F;src&#x2F;VTK8.2&#x2F;VTK-8.2.0&#x2F;Rendering&#x2F;OpenGL2&#x2F;vtkShaderProgram.cxx, line 447\nvtkShaderProgram (0x2b87270): 0:1(10): error: GLSL 1.50 is not supported. Supported versions are: 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES\n\n# 解决方法\nexport MESA_GL_VERSION_OVERRIDE&#x3D;3.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cn[16-19,24-27,144-147,152-155]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"八、附录\"><a href=\"#八、附录\" class=\"headerlink\" title=\"八、附录\"></a>八、附录</h2><h3 id=\"8-1-Linpack脚本\"><a href=\"#8-1-Linpack脚本\" class=\"headerlink\" title=\"8.1 Linpack脚本\"></a>8.1 Linpack脚本</h3><blockquote>\n<p>runpro.sh</p>\n<p>.&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir</p>\n<p>node_list 节点列表</p>\n<p>nodes_num 几个点连在一起跑，单点 双点 多点</p>\n<p> proc_per_node 每个节点跑几个进程，看node分为几个，FT一般是8</p>\n<p> mem 12000 每个进程分配的内存，*8 大概&#x3D; 总内存的80%</p>\n<p> logdir 日志文件</p>\n<p> 单点8进程，一轮≈35分钟</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#! &#x2F;bin&#x2F;bash\n\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE&#x3D;1\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:LD_LIBRARY_PATH\n\nnodes&#x3D;$&#123;1&#125;\nnnodes&#x3D;$&#123;2&#125;\nnprocs&#x3D;$&#123;3&#125;\nnmem&#x3D;$&#123;4&#125;\nlogdir&#x3D;$&#123;5&#125;\n\n\nmkdir -p $&#123;logdir&#125;\n\ntnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))\nP&#x3D;1\nQ&#x3D;1\n\n\nnum_max&#x3D;1\nfor i in &#96;seq 1 $&#123;tnprocs&#125;&#96;\ndo\n        j&#x3D;$(($&#123;i&#125;*$&#123;i&#125;))\n        if [ $&#123;tnprocs&#125; -le $&#123;j&#125; ]; then\n                num_max&#x3D;$&#123;i&#125;\n                break\n        fi\ndone\nfor i in &#96;seq 1 $&#123;num_max&#125;&#96;\ndo\n        for j in &#96;seq $&#123;num_max&#125; $&#123;tnprocs&#125;&#96;\n        do\n                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))\n                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ]\n                then\n                        P&#x3D;$&#123;i&#125;\n                        Q&#x3D;$&#123;j&#125;\n                fi\n        done\ndone\n\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;\ndone\nsleep 1\n\nj&#x3D;0\nrunnodes&#x3D;&#39;&#39;\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        runnodes+&#x3D;$&#123;i&#125;,\n        let j++\n        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]\n        then\n                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;\n                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125;&quot; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;list.log\n                yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                j&#x3D;0\n                runnodes&#x3D;&#39;&#39;\n        fi\ndone\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>xhplrun.sh</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#! &#x2F;bin&#x2F;bash\n\n#duqi\n\nulimit -s unlimited\n\nCores&#x3D;64\n#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nPMI_SIZE&#x3D;$SLURM_NPROCS\n\nPMI_RANK&#x3D;$SLURM_PROCID\n\nMPI_NUM_NODES&#x3D;$SLURM_NNODES\n\nMPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))\n\nMPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))\n#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n\n\nthreads&#x3D;&#96;echo $&#123;Cores&#125;*$&#123;SLURM_NNODES&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;\n\nPRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;\nPMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;\n\necho $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;\n\nexport HPL_CMDLINE&#x3D;1\ncase $&#123;PRO_SIZE&#125; in\n1)\n#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\ncase $&#123;PMI_RANK_my&#125; in\n0)\n#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;\nnumactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\n#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;\nnumactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-15&#39;\nnumactl -i 0-7 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 2-3 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-31&#39;\nnumactl -i 0-7 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 4-5 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-47&#39;\nnumactl -i 0-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 6-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-63&#39;\nnumactl -i 0-7 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-1 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n8)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-7&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 4 -N 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-15&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 2 -N 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-23&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 6 -N 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-31&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 1 -N 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-39&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0 -N 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-47&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 7 -N 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-55&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 5 -N 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 3 -N 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n16)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-3&#39;\nnumactl -i 0-7 -C 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4-7&#39;\nnumactl -i 0-7 -C 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-11&#39;\nnumactl -i 0-7 -C 8-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12-15&#39;\nnumactl -i 0-7 -C 12-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-19&#39;\nnumactl -i 0-7 -C 16-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20-23&#39;\nnumactl -i 0-7 -C 20-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-27&#39;\nnumactl -i 0-7 -C 24-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28-31&#39;\nnumactl -i 0-7 -C 28-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-35&#39;\nnumactl -i 0-7 -C 32-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36-39&#39;\nnumactl -i 0-7 -C 36-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-43&#39;\nnumactl -i 0-7 -C 40-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44-47&#39;\nnumactl -i 0-7 -C 44-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-51&#39;\nnumactl -i 0-7 -C 48-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52-55&#39;\nnumactl -i 0-7 -C 52-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-59&#39;\nnumactl -i 0-7 -C 56-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60-63&#39;\nnumactl -i 0-7 -C 60-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n32)\n#export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#;;\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-1&#39;\nnumactl -i 0-7 -C 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;2-3&#39;\nnumactl -i 0-7 -C 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4-5&#39;\nnumactl -i 0-7 -C 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;6-7&#39;\nnumactl -i 0-7 -C 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-9&#39;\nnumactl -i 0-7 -C 8-9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;10-11&#39;\nnumactl -i 0-7 -C 10-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12-13&#39;\nnumactl -i 0-7 -C 12-13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;14-15&#39;\nnumactl -i 0-7 -C 14-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-17&#39;\nnumactl -i 0-7 -C 16-17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;18-19&#39;\nnumactl -i 0-7 -C 18-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20-21&#39;\nnumactl -i 0-7 -C 20-21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;22-23&#39;\nnumactl -i 0-7 -C 22-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-25&#39;\nnumactl -i 0-7 -C 24-25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;26-27&#39;\nnumactl -i 0-7 -C 26-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28-29&#39;\nnumactl -i 0-7 -C 28-29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;30-31&#39;\nnumactl -i 0-7 -C 30-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n16)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-33&#39;\nnumactl -i 0-7 -C 32-33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n17)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;34-35&#39;\nnumactl -i 0-7 -C 34-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n18)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36-37&#39;\nnumactl -i 0-7 -C 36-37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n19)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;38-39&#39;\nnumactl -i 0-7 -C 38-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n20)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-41&#39;\nnumactl -i 0-7 -C 40-41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n21)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;42-43&#39;\nnumactl -i 0-7 -C 42-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n22)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44-45&#39;\nnumactl -i 0-7 -C 44-45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n23)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;46-47&#39;\nnumactl -i 0-7 -C 46-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n24)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-49&#39;\nnumactl -i 0-7 -C 48-49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n25)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;50-51&#39;\nnumactl -i 0-7 -C 50-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n26)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52-53&#39;\nnumactl -i 0-7 -C 52-53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n27)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;54-55&#39;\nnumactl -i 0-7 -C 54-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n28)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-57&#39;\nnumactl -i 0-7 -C 56-57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n29)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;58-59&#39;\nnumactl -i 0-7 -C 58-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n30)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60-61&#39;\nnumactl -i 0-7 -C 60-61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n31)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;62-63&#39;\nnumactl -i 0-7 -C 62-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n64)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\n#export GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#;;\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0&#39;\nnumactl -i 0-7 -C 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;1&#39;\nnumactl -i 0-7 -C 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;2&#39;\nnumactl -i 0-7 -C 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;3&#39;\nnumactl -i 0-7 -C 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4&#39;\nnumactl -i 0-7 -C 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;5&#39;\nnumactl -i 0-7 -C 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;6&#39;\nnumactl -i 0-7 -C 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;7&#39;\nnumactl -i 0-7 -C 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8&#39;\nnumactl -i 0-7 -C 8 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;9&#39;\nnumactl -i 0-7 -C 9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;10&#39;\nnumactl -i 0-7 -C 10 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;11&#39;\nnumactl -i 0-7 -C 11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12&#39;\nnumactl -i 0-7 -C 12 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;13&#39;\nnumactl -i 0-7 -C 13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;14&#39;\nnumactl -i 0-7 -C 14 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;15&#39;\nnumactl -i 0-7 -C 15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n16)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16&#39;\nnumactl -i 0-7 -C 16 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n17)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;17&#39;\nnumactl -i 0-7 -C 17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n18)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;18&#39;\nnumactl -i 0-7 -C 18 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n19)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;19&#39;\nnumactl -i 0-7 -C 19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n20)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20&#39;\nnumactl -i 0-7 -C 20 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n21)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;21&#39;\nnumactl -i 0-7 -C 21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n22)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;22&#39;\nnumactl -i 0-7 -C 22 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n23)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;23&#39;\nnumactl -i 0-7 -C 23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n24)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24&#39;\nnumactl -i 0-7 -C 24 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n25)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;25&#39;\nnumactl -i 0-7 -C 25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n26)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;26&#39;\nnumactl -i 0-7 -C 26 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n27)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;27&#39;\nnumactl -i 0-7 -C 27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n28)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28&#39;\nnumactl -i 0-7 -C 28 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n29)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;29&#39;\nnumactl -i 0-7 -C 29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n30)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;30&#39;\nnumactl -i 0-7 -C 30 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n31)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;31&#39;\nnumactl -i 0-7 -C 31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n32)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32&#39;\nnumactl -i 0-7 -C 32 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n33)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;33&#39;\nnumactl -i 0-7 -C 33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n34)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;34&#39;\nnumactl -i 0-7 -C 34 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n35)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;35&#39;\nnumactl -i 0-7 -C 35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n36)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36&#39;\nnumactl -i 0-7 -C 36 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n37)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;37&#39;\nnumactl -i 0-7 -C 37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n38)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;38&#39;\nnumactl -i 0-7 -C 38 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n39)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;39&#39;\nnumactl -i 0-7 -C 39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n40)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40&#39;\nnumactl -i 0-7 -C 40 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n41)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;41&#39;\nnumactl -i 0-7 -C 41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n42)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;42&#39;\nnumactl -i 0-7 -C 42 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n43)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;43&#39;\nnumactl -i 0-7 -C 43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n44)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44&#39;\nnumactl -i 0-7 -C 44 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n45)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;45&#39;\nnumactl -i 0-7 -C 45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n46)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;46&#39;\nnumactl -i 0-7 -C 46 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n47)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;47&#39;\nnumactl -i 0-7 -C 47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n48)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48&#39;\nnumactl -i 0-7 -C 48 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n49)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;49&#39;\nnumactl -i 0-7 -C 49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n50)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;50&#39;\nnumactl -i 0-7 -C 50 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n51)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;51&#39;\nnumactl -i 0-7 -C 51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n52)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52&#39;\nnumactl -i 0-7 -C 52 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n53)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;53&#39;\nnumactl -i 0-7 -C 53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n54)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;54&#39;\nnumactl -i 0-7 -C 54 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n55)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;55&#39;\nnumactl -i 0-7 -C 55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n56)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56&#39;\nnumactl -i 0-7 -C 56 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n57)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;57&#39;\nnumactl -i 0-7 -C 57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n58)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;58&#39;\nnumactl -i 0-7 -C 58 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n59)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;59&#39;\nnumactl -i 0-7 -C 59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n60)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60&#39;\nnumactl -i 0-7 -C 60 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n61)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;61&#39;\nnumactl -i 0-7 -C 61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n62)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;62&#39;\nnumactl -i 0-7 -C 62 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n63)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;63&#39;\nnumactl -i 0-7 -C 63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\nesac<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"8-2-编译问题\"><a href=\"#8-2-编译问题\" class=\"headerlink\" title=\"8.2 编译问题\"></a>8.2 编译问题</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-lc \n\t解决找不到memcpy问题 \n-lstdc++\n\t解决vtable for xxxx 问题\n-lgcc_s\n\tundefined reference to &#96;_Unwind_Resume&#39;\n\tundefined reference to &#96;__popcountdi2&#39;\n\t\n#include &lt;sys&#x2F;types.h&gt;\n#include &lt;sys&#x2F;types.h&gt;\n\t implicit declaration of function ‘fstat’\n\n#include &lt;sys&#x2F;sysmacros.h&gt;\n\timplicit declaration of function ‘major’<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十、Linux操作\"><a href=\"#十、Linux操作\" class=\"headerlink\" title=\"十、Linux操作\"></a>十、Linux操作</h1><h2 id=\"10-1-ncat端口转发\"><a href=\"#10-1-ncat端口转发\" class=\"headerlink\" title=\"10.1 ncat端口转发\"></a>10.1 ncat端口转发</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ncat --sh-exec &quot;ncat 25.8.27.6 15929&quot; -l 15929 --keep-open<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"十一、DDT安装\"><a href=\"#十一、DDT安装\" class=\"headerlink\" title=\"十一、DDT安装\"></a>十一、DDT安装</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># cp Licence &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;licences&#x2F;\n# cp Licence.14713 &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;licences&#x2F;\n\nexport PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;lib:$LD_LIBRARY_PATH\nifconfig eth3 hw ether 00:1b:21:14:15:60<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#glex高速网版本的MPI改为本地调试用\nexport MPICH_NO_LOCAL&#x3D;0 &#x2F;&#x2F;？不一定需要\nexport MPICH_NEMESIS_NETMOD&#x3D;tcp\nexport PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h1 id=\"十二、SPEC使用\"><a href=\"#十二、SPEC使用\" class=\"headerlink\" title=\"十二、SPEC使用\"></a>十二、SPEC使用</h1><h2 id=\"12-1-SPEC使用系统工具\"><a href=\"#12-1-SPEC使用系统工具\" class=\"headerlink\" title=\"12.1 SPEC使用系统工具\"></a>12.1 SPEC使用系统工具</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># SEPC设置使用系统的工具\nvim &#x2F;home&#x2F;gs&#x2F;tools&#x2F;spack-v5&#x2F;etc&#x2F;spack&#x2F;defaults&#x2F;packages.yaml\n# 参考：\n..&#x2F;..&#x2F;..&#x2F;lib&#x2F;spack&#x2F;docs&#x2F;build_settings.rst<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十三、mi协议\"><a href=\"#十三、mi协议\" class=\"headerlink\" title=\"十三、mi协议\"></a>十三、mi协议</h1><h2 id=\"13-1-使用mi启动调试\"><a href=\"#13-1-使用mi启动调试\" class=\"headerlink\" title=\"13.1 使用mi启动调试\"></a>13.1 使用mi启动调试</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">gs@ft-svr:~&#x2F;matrix$ gdb --interpreter mi test\n&#x3D;thread-group-added,id&#x3D;&quot;i1&quot;\n~&quot;GNU gdb (Ubuntu 8.2.91.20190405-0ubuntu3) 8.2.91.20190405-git\\n&quot;\n~&quot;Copyright (C) 2019 Free Software Foundation, Inc.\\n&quot;\n~&quot;License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;\\nThis is free software: you are free to change and redistribute it.\\nThere is NO WARRANTY, to the extent permitted by law.&quot;\n~&quot;\\nType \\&quot;show copying\\&quot; and \\&quot;show warranty\\&quot; for details.\\n&quot;\n~&quot;This GDB was configured as \\&quot;aarch64-linux-gnu\\&quot;.\\n&quot;\n~&quot;Type \\&quot;show configuration\\&quot; for configuration details.\\n&quot;\n~&quot;For bug reporting instructions, please see:\\n&quot;\n~&quot;&lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;bugs&#x2F;&gt;.\\n&quot;\n~&quot;Find the GDB manual and other documentation resources online at:\\n    &lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;documentation&#x2F;&gt;.&quot;\n~&quot;\\n\\n&quot;\n~&quot;For help, type \\&quot;help\\&quot;.\\n&quot;\n~&quot;Type \\&quot;apropos word\\&quot; to search for commands related to \\&quot;word\\&quot;...\\n&quot;\n~&quot;Reading symbols from test...\\n&quot;\n(gdb)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"13-2-断点命令（BreakPoint）\"><a href=\"#13-2-断点命令（BreakPoint）\" class=\"headerlink\" title=\"13.2 断点命令（BreakPoint）\"></a>13.2 断点命令（BreakPoint）</h2><h3 id=\"13-2-1-break-after\"><a href=\"#13-2-1-break-after\" class=\"headerlink\" title=\"13.2.1 -break-after\"></a>13.2.1 -break-after</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-after number count\n第number个断点在执行count次后有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-2-break-condition\"><a href=\"#13-2-2-break-condition\" class=\"headerlink\" title=\"13.2.2 -break-condition\"></a>13.2.2 -break-condition</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-condition number expr\n第number个断点在表达式expr为true时有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-3-break-delete\"><a href=\"#13-2-3-break-delete\" class=\"headerlink\" title=\"13.2.3 -break-delete\"></a>13.2.3 -break-delete</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-delete(breakpoint number)+\n删除指定number的多个断点<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-4-break-disable\"><a href=\"#13-2-4-break-disable\" class=\"headerlink\" title=\"13.2.4 -break-disable\"></a>13.2.4 -break-disable</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-disable(breakpoint number)+\n使用指定Number的多个断点失效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-5-break-enable\"><a href=\"#13-2-5-break-enable\" class=\"headerlink\" title=\"13.2.5 -break-enable\"></a>13.2.5 -break-enable</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-enable(breakpoint number)+\n使用指定Number的多个断点生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-6-break-info\"><a href=\"#13-2-6-break-info\" class=\"headerlink\" title=\"13.2.6 -break-info\"></a>13.2.6 -break-info</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-info breakpoint\n得到指定断点的信息<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-7-break-insert\"><a href=\"#13-2-7-break-insert\" class=\"headerlink\" title=\"13.2.7 -break-insert\"></a>13.2.7 -break-insert</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-insert\n\t-t\t\t\t\t插入临时断点\n\t-h\t\t\t\t插入硬件断点\n\t-r\t\t\t\t插入正则断点，当函数名匹配正则表达式时生效\n\t-c condition    插入条件断点\n\t-i ignore-count 插入一个指定无效次数的断点\n\t-p thread  \t\t\n\tline | addr(func) <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-8-break-list\"><a href=\"#13-2-8-break-list\" class=\"headerlink\" title=\"13.2.8. -break-list\"></a>13.2.8. -break-list</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-list\n显示已插入的断点列表<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-9-break-watch\"><a href=\"#13-2-9-break-watch\" class=\"headerlink\" title=\"13.2.9 -break-watch\"></a>13.2.9 -break-watch</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-watch [-a|-r] variable\n创建一个观察点，-a标识对variable读写时有效，-r标识只读时有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"13-3-程序环境命令-Program-Context\"><a href=\"#13-3-程序环境命令-Program-Context\" class=\"headerlink\" title=\"13.3 程序环境命令(Program Context)\"></a>13.3 程序环境命令(Program Context)</h2><h2 id=\"13-4-线程-thread\"><a href=\"#13-4-线程-thread\" class=\"headerlink\" title=\"13.4 线程(thread)\"></a>13.4 线程(thread)</h2><h2 id=\"13-5-程序执行-Program-Execution\"><a href=\"#13-5-程序执行-Program-Execution\" class=\"headerlink\" title=\"13.5 程序执行(Program Execution)\"></a>13.5 程序执行(Program Execution)</h2><h2 id=\"13-6-栈-Stack\"><a href=\"#13-6-栈-Stack\" class=\"headerlink\" title=\"13.6 栈(Stack)\"></a>13.6 栈(Stack)</h2><h2 id=\"13-7-变量-Variable\"><a href=\"#13-7-变量-Variable\" class=\"headerlink\" title=\"13.7 变量(Variable)\"></a>13.7 变量(Variable)</h2><h2 id=\"13-8-数据-Data\"><a href=\"#13-8-数据-Data\" class=\"headerlink\" title=\"13.8 数据(Data)\"></a>13.8 数据(Data)</h2><h2 id=\"13-9-跟踪点-TracePoint\"><a href=\"#13-9-跟踪点-TracePoint\" class=\"headerlink\" title=\"13.9 跟踪点(TracePoint)\"></a>13.9 跟踪点(TracePoint)</h2><h2 id=\"13-10-符号-Symbol\"><a href=\"#13-10-符号-Symbol\" class=\"headerlink\" title=\"13.10 符号(Symbol)\"></a>13.10 符号(Symbol)</h2><h2 id=\"13-11-文件-File\"><a href=\"#13-11-文件-File\" class=\"headerlink\" title=\"13.11 文件(File)\"></a>13.11 文件(File)</h2><h2 id=\"13-12-目标数据-Target-Manipulation\"><a href=\"#13-12-目标数据-Target-Manipulation\" class=\"headerlink\" title=\"13.12 目标数据(Target Manipulation)\"></a>13.12 目标数据(Target Manipulation)</h2><h2 id=\"13-13-其他\"><a href=\"#13-13-其他\" class=\"headerlink\" title=\"13.13 其他\"></a>13.13 其他</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-enable-pretty-printing\n-var-create - * map\n-var-list-children --all-values var1 0 10\n\n-data-evaluate-expression map\n^done,value&#x3D;&quot;std::map with 140737353945088 elements&lt;error reading variable: Cannot access memory at address 0x1f0fc35f415e51&gt;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&#x2F;&#x2F;    &#x2F;&#x2F; 设置标记类型与颜色\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 0);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#ee6666&quot;), 0);\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 1);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#aaaaaa&quot;), 1);\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::RightArrow, 2);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#eaf593&quot;), 2);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十四、Git改密码\"><a href=\"#十四、Git改密码\" class=\"headerlink\" title=\"十四、Git改密码\"></a>十四、Git改密码</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">gitlab-rails console production\n\nirb(main):002:0&gt; user&#x3D;User.where(email:&#39;cuiyingbomail@163.com&#39;).first\n&#x3D;&gt; #&lt;User id:30 @cyb&gt;\nirb(main):003:0&gt; user.password&#x3D;12345678\n&#x3D;&gt; 12345678\nirb(main):004:0&gt; user.password_confirmation&#x3D;12345678\n&#x3D;&gt; 12345678\nirb(main):005:0&gt; user.save!\nEnqueued ActionMailer::DeliveryJob (Job ID: 540244db-c6ec-44f9-880e-72338b955aa5) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, #&lt;GlobalID:0x00007f57f5da3208 @uri&#x3D;#&lt;URI::GID gid:&#x2F;&#x2F;gitlab&#x2F;User&#x2F;30&gt;&gt;\n&#x3D;&gt; true\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十五、YHPDE（eclipse）FT部署\"><a href=\"#十五、YHPDE（eclipse）FT部署\" class=\"headerlink\" title=\"十五、YHPDE（eclipse）FT部署\"></a>十五、YHPDE（eclipse）FT部署</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、安装eclipse:\n\tgitlab\n2、插件安装，参考手册\n2、新版SLURM需要\nvim org.eclipse.ptp.rm.slurm.proxy_4.0.7.201104291906&#x2F;src&#x2F;ptp_slurm_proxy.c\n1625行：slurm_allocation_lookup_lite -&gt; slurm_allocation_lookup\n2942行: primary &#x3D; 1; -&gt;  primary &#x3D; 0;\n2943行：secondary &#x3D; 2; -&gt; secondary &#x3D; 1;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"测试工具使用说明-汇总\"><a href=\"#测试工具使用说明-汇总\" class=\"headerlink\" title=\"测试工具使用说明-汇总\"></a>测试工具使用说明-汇总</h1><h1 id=\"一、SPEC-CPU-2017-测试\"><a href=\"#一、SPEC-CPU-2017-测试\" class=\"headerlink\" title=\"一、SPEC CPU 2017 测试\"></a>一、SPEC CPU 2017 测试</h1><h2 id=\"1-1-概述\"><a href=\"#1-1-概述\" class=\"headerlink\" title=\"1.1 概述\"></a>1.1 概述</h2><p>​\t标准性能评测机构（SPEC）开发的用于评测CPU性能的基准程序测试组，是一套CPU子系统测试工具。处理器、内存和编译都会影响最终的测试结果，目前SPEC CPU是业界首选的CPU评测工具。 </p>\n<h2 id=\"1-2-工具安装\"><a href=\"#1-2-工具安装\" class=\"headerlink\" title=\"1.2 工具安装\"></a>1.2 工具安装</h2><p>获取镜像包：</p>\n<p>​\tcpu2017-1_0_5.iso</p>\n<p>挂载IOS</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mount -o loop -t iso9660 cpu2017-1_0_5.iso &#x2F;xxx&#x2F;cpu2017CD<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>安装工具</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd &#x2F;xxx&#x2F;cpu2017CD\n.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-3-测试步骤\"><a href=\"#1-3-测试步骤\" class=\"headerlink\" title=\"1.3 测试步骤\"></a>1.3 测试步骤</h2><p>spec2017主要分为四项测试：</p>\n<ul>\n<li>​\tintrate</li>\n<li>​\tfprate</li>\n<li>​\tintspeed</li>\n<li>​\tfpspeed</li>\n</ul>\n<p>​\t根据需要测试的cpu型号，可以到官网下载相应的cfg文件，修改icc、Jemalloc库、qkmalloc库的路径，放入config文件夹中。</p>\n<p>测试命令如下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\nulimit -s unlimited\n# speed 测试\nruncpu --config&#x3D;icc-speed-official.cfg --threads&#x3D;48 --define cores&#x3D;48 -n 3 -i ref fpspeed intspeed\n\n# rate 测试\nruncpu --config&#x3D;icc-rate-official.cfg -copies&#x3D;48 -n 3 -i ref intrate fprate\n\n-----------------------------------------------------------------------\n\n# 仅编译不跑测试\n--action&#x3D;build\n# 重新编译\n--rebuild\n# 绑核跑\ntaskset -c <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-4-测试优化\"><a href=\"#1-4-测试优化\" class=\"headerlink\" title=\"1.4 测试优化\"></a>1.4 测试优化</h2><blockquote>\n<p>Bios设置：</p>\n<p>​\t开启超线程</p>\n<p>​\t 尝试开启LLC-PREFETCH</p>\n</blockquote>\n<h2 id=\"1-5-其他事项：\"><a href=\"#1-5-其他事项：\" class=\"headerlink\" title=\"1.5 其他事项：\"></a>1.5 其他事项：</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cfg文件中的submit可以设置绑核选项<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"二、SPEC-CPU-2006-测试\"><a href=\"#二、SPEC-CPU-2006-测试\" class=\"headerlink\" title=\"二、SPEC CPU 2006 测试\"></a>二、SPEC CPU 2006 测试</h1><h2 id=\"2-1-概述\"><a href=\"#2-1-概述\" class=\"headerlink\" title=\"2.1 概述\"></a>2.1 概述</h2><p>​\t作用同Spec CPU 2017, 近年来逐渐被淘汰</p>\n<h2 id=\"2-2-测试步骤\"><a href=\"#2-2-测试步骤\" class=\"headerlink\" title=\"2.2 测试步骤\"></a>2.2 测试步骤</h2><p>1、spec2006.tgz 解压，使用install.sh安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">SPEC CPU2006 Installation\nTop of the CPU2006 tree is &#39;&#x2F;vol8&#x2F;tarball&#x2F;cpu2006&#39;\nThese appear to be valid toolsets:\nft-spec2006-tool\naarch64-linux\nEnter the architecture you are using:\n&gt;&gt; aarch64-linux<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\n# 单核测试\nrunspec -c linux64-arm64-gcc52.cfg -i ref -n 3 -I all \n# 多核测试（16）\nrunspec -c linux64-arm64-gcc52.cfg -r 16 -n 3 -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"三、-SPEC-OMP-2012-测试\"><a href=\"#三、-SPEC-OMP-2012-测试\" class=\"headerlink\" title=\"三、 SPEC OMP 2012 测试\"></a>三、 SPEC OMP 2012 测试</h1><h2 id=\"3-1-概述\"><a href=\"#3-1-概述\" class=\"headerlink\" title=\"3.1 概述\"></a>3.1 概述</h2><p>​\t基于SPEC测试套件的OpenMP评测工具，其中包含15个基于OpenMP的并行程序。</p>\n<h2 id=\"3-2-工具安装\"><a href=\"#3-2-工具安装\" class=\"headerlink\" title=\"3.2 工具安装\"></a>3.2 工具安装</h2><p>​\t获取源包：</p>\n<p>​\t\tomp2012-1.1.zip</p>\n<p>​\t解压后使用install.sh安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装\n.&#x2F;install.sh -d &#x2F;home&#x2F;xx\n# 仅编译\nrunspec --action&#x3D;build --config&#x3D;gcc.cfg -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-3-测试步骤\"><a href=\"#3-3-测试步骤\" class=\"headerlink\" title=\"3.3 测试步骤\"></a>3.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">source shrc\nulimit -s unlimited\nexport OMP_NUM_THREADS&#x3D;48\nrunspec --config&#x3D;gcc.cfg --threads 48 -n 3 -i ref -I all<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"四、NPB-测试\"><a href=\"#四、NPB-测试\" class=\"headerlink\" title=\"四、NPB 测试\"></a>四、NPB 测试</h1><h2 id=\"4-1-概述\"><a href=\"#4-1-概述\" class=\"headerlink\" title=\"4.1 概述\"></a>4.1 概述</h2><p>​\tNAS并行基准测试程序（NPB），是由美国航空航天局开发的一套代表流体动力学计算的应用程序集，它已经成为公认的用于测评大规模并行机和超级计算机的标准测试程序。NPB可用于常用的编程模型，如MPI和OpenMP。</p>\n<h2 id=\"4-2-工具安装\"><a href=\"#4-2-工具安装\" class=\"headerlink\" title=\"4.2 工具安装\"></a>4.2 工具安装</h2><p>源包获取：</p>\n<p>​\tNPB3.4.tar.gz         OpenMP || MPICH</p>\n<p>​\tNPB3.4-MZ.tar.gz  OpenMP &amp;&amp; MPICH</p>\n<p>解压即可。</p>\n<h2 id=\"4-3-测试步骤\"><a href=\"#4-3-测试步骤\" class=\"headerlink\" title=\"4.3 测试步骤\"></a>4.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">make suite\ncd bin\nmpirun -np 4 .&#x2F;xxx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"五、Stream-测试\"><a href=\"#五、Stream-测试\" class=\"headerlink\" title=\"五、Stream 测试\"></a>五、Stream 测试</h1><h2 id=\"5-1-概述\"><a href=\"#5-1-概述\" class=\"headerlink\" title=\"5.1 概述\"></a>5.1 概述</h2><p>​\tSTREAM是一套综合性能测试程序集，通过fortran和C两种高级且高效的语言编写完成，由于这两种语言在数学计算方面的高效率， 使得 STREAM 测试例程可以充分发挥出内存的能力。Stream测试是内存测试中业界公认的内存带宽性能测试基准工具。</p>\n<h2 id=\"5-2-工具安装\"><a href=\"#5-2-工具安装\" class=\"headerlink\" title=\"5.2 工具安装\"></a>5.2 工具安装</h2><p>源包获取：</p>\n<p>​\tstream.tgz  刘新娃修改过</p>\n<p>​\t<font color='red'>Intel平台请用ICC</font></p>\n<p>解压后编译stream.c, 生成可执行文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">icc -O3 -fopenmp -DNTIMES&#x3D;10 -mcmodel&#x3D;large -o stream_c stream.c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>没有修改过的怎么编译呢？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">icc -mtune&#x3D;native -march&#x3D;native -O3 -mcmodel&#x3D;large -fopenmp -DSTREAM_ARRAY_SIZE&#x3D;100000000 -DNTIMES&#x3D;30 -DOFFSET&#x3D;512 stream.c -o stream-gs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"5-3-测试步骤\"><a href=\"#5-3-测试步骤\" class=\"headerlink\" title=\"5.3 测试步骤\"></a>5.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export OMP_NUM_THREADS&#x3D;48&#x2F;32&#x2F;16&#x2F;8&#x2F;4  # 设置每个进程的线程数\n.&#x2F;stream_c 200000 # 使用200G内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"5-4-其他事项\"><a href=\"#5-4-其他事项\" class=\"headerlink\" title=\"5.4 其他事项\"></a>5.4 其他事项</h2><blockquote>\n<p><code>STREAM_ARRAY_SIZE</code>即<code>N</code>指定计算中a[],b[],c[]三个数组的大小，且数组的值采用了双精度（8个字节）。数组的维数 N定义时需要注意以下几点：</p>\n<p>一、要充分考虑内存容量的需求，粗略估计是 N× 8（双精度浮点类型） × 3 （三个数组）&lt;&#x3D; 0.6*M；M 是用户的可用内存。</p>\n<p>二、要保证测试过程中，使用到的内存容量要大于处理器内的缓存，只有这样才会有内存的操作，而不仅仅是对处理器内缓存的操作。</p>\n<p>三、为了保证测试可以持续一段时间，测试过程中内存带宽可以达到一定的最大值， 从而避免得不到实际最大峰值的情况，如果四项测试中有完成时间小于20微秒的情况，就需要适当的增大测试数组的维度 N。</p>\n</blockquote>\n<h1 id=\"六、Linpack-测试\"><a href=\"#六、Linpack-测试\" class=\"headerlink\" title=\"六、Linpack 测试\"></a>六、Linpack 测试</h1><h2 id=\"6-1-概述\"><a href=\"#6-1-概述\" class=\"headerlink\" title=\"6.1 概述\"></a>6.1 概述</h2><p>​\tLinpack是国际上使用最广泛的测试高性能计算机系统浮点性能的基准测试。通过对高性能计算机采用高斯消元法求解一元 N次稠密线性代数方程组的测试，评价高性能计算机的浮点计算性能。Linpack的结果按每秒浮点运算次数（flops）表示。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">N ^ 2 * 8 &#x3D; 总内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"6-2-工具安装\"><a href=\"#6-2-工具安装\" class=\"headerlink\" title=\"6.2 工具安装\"></a>6.2 工具安装</h2><p>源包获取：</p>\n<p>​\tlinpack.tgz</p>\n<p>解压即可。</p>\n<h2 id=\"6-3-测试步骤\"><a href=\"#6-3-测试步骤\" class=\"headerlink\" title=\"6.3 测试步骤\"></a>6.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1进48线100G内存\n.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 100000\n# 1进48线200G内存\n.&#x2F;xhpl -n 1 -b 384 -p 1 -q 1 -m 200000\n# 2进24线共100G内存\nmpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 50000\n# 2进24线共200G内存\nmpirun -n 2 .&#x2F;xhpl -b 384 -p 1 -q 2 -m 100000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用mpirun提交xhplrun.sh效果更好</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">PRO_SIZE&#x3D;$&#123;PMI_SIZE&#125;\nthreads&#x3D;&#96;echo $&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;\nPMI_RANK_my&#x3D;$&#123;PMI_RANK&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-4-测试优化（重点）\"><a href=\"#6-4-测试优化（重点）\" class=\"headerlink\" title=\"6.4 测试优化（重点）\"></a>6.4 测试优化（重点）</h2><blockquote>\n<p>一、计算理论内存总带宽</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;计算方法：\n&gt;查看内存带宽：\n&gt;dmidecode | grep -A 16 &quot;Memory Device&quot;\n&gt;例如内存信息为：\n&gt;三星 DDR4 \n&gt;16G 每根\n&gt;2666 MT&#x2F;s（Mhz）\n&gt;查看cpu支持的通道数，例如intel 6252N支持6通道，两个CPU支持12通道\n&gt;理论带宽计算DDR4：\n&gt;单条内存带宽 &#x3D; 内存核心频率 x 内存总线位数 x 倍增系数\n &#x3D; 2666 * 64 &#x2F; 8 &#x3D; 21328 MB&#x2F;s &#x3D; 21.3G&#x2F;s\n&gt;12通道总内存带宽 &#x3D; 21328 * 12 &#x3D; 255936 &#x3D; 250G&#x2F;s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>二、使用stream测试实际内存总带宽</p>\n<p>​\t如果可以达到90%或以上，说明内存带宽正常, 继续Linpack测试</p>\n<p>三、计算CPU理论峰值</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;计算方法：\nMhz * 每个时钟周期执行浮点运算的次数 * CPU数目\n&gt;&#x3D;\n2.3 x ( 8 x 2 x 2 ) x 48 &#x3D; 3532.8 Gflops\n&gt;说明：\n峰值计算分为单精度和双精度浮点运算\n&gt;单精度：\n32bit的指令长度的运算，对应32位操作系统\n&gt;双精度：\n64bit的指令长度的运算，对应64位操作系统\n&gt;查找CPU可以处理什么样的指令集：\n例如Intel官网查到Intel Xeon 6252N\n支持AVX-512，\n# of AVX-512 FMA Units &#x3D; 2\n(Fused Multiply Add instructions) 融合了 乘法 和 加法\n即可以单个周期同时执行2条512bit的加法和2条512bit的乘法\n&gt;理解上述两个概念，可以开始计算（CPU单周期浮点计算能力）\n&gt;Intel 6252N (支持avx512，有512位)\n&gt;单精度：\n2.3 x 512&#x2F;32 x 2 x 2 &#x3D; 147.2Gflops \n&gt;双精度\n2.3 x 512&#x2F;64 x 2 x 2 &#x3D; 73.6Gflops\n&gt;双精度共48核\n74.6 x 48 &#x3D; 3580\n\n&gt;FT2000+ 和 FT1500A (只有128位)，FT3000加入sve指令集(128-256位)\n&gt;单精度： \n2.2 x 128&#x2F;32 * 2 &#x3D; 4.4\n&gt;双精度:\n2.2 x 128&#x2F;64 * 2 &#x3D; 8.8\n&gt;双精度共64核\n8.8 x 64 &#x3D; 563.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>四、使用Linapack测试CPU实际峰值</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;如果性能达到理论峰值的70%说明正常，如果未达到尝试以下优化<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;1、使用mpirun运行xhpl, 按&#96;lscpu&#96; 中的NUMA分组绑定,&#96;比如48核，分为两个Numa Node&#96;, 则用mpirun&#96;跑两个xhpl进程&#96;，每个进程使用 OMP_NUM_THREADS&#x3D;24, 跑24线程，这样可以将核用满。\n&gt;在&#96;Intel&#96;平台，两个进程分别使用 HPL_HOST_CORE&#x3D;&#39;0-23&#39; 以及 HPL_HOST_CORE&#x3D;&#39;24-47&#39; 绑定核\n&gt;在&#96;Arm64&#96;平台，则使用 GOMP_CPU_AFFINITY&#x3D;&#39;0-23&#39; 以及 GOMP_CPU_AFFINITY&#x3D;&#39;24-47&#39; 绑定\n&gt;2、内存不用分配太大，根据stream测试结果分配，从小开始测\n&gt;3、Intel平台编译器使用ICC，测试linpack使用icc自带的linpack，mpi使用icc自带的\n&gt;4、Bios中关闭超线程，开启超频(turbo&#x2F;P-state)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><strong><font color=\"blue\">先测stream,判断带宽是否正常，再测linpack，然后再测Spec Cpu</font></strong></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># Intel平台可以使用的控制频率的命令\ncpupower -c all frequency-set -g performance\ncpupower -c 0-95 frequency-set -g userspace\ncpupower -c 0-95 frequency-set -f 2700000\n\n# 查看当前频率控制是否为perfomance？\ncat &#x2F;sys&#x2F;devices&#x2F;system&#x2F;cpu&#x2F;cpu0&#x2F;cpufreq&#x2F;scaling_governor\n\n# 跑xhpl之前设置指令集，或许有用\nexport MKL_ENABLE_INSTRUCTIONS&#x3D;AVX512<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"G:\\工作\\2020年3月\\CN9性能测试\\测试组合.png\" alt=\"image-20200415171716940\"></p>\n<h2 id=\"6-5-HPL-dat修改\"><a href=\"#6-5-HPL-dat修改\" class=\"headerlink\" title=\"6.5 HPL.dat修改\"></a>6.5 HPL.dat修改</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 第1-2行，注释说明行\nHPLinpack benchmark input file   \nInnovative Computing Laboratory, University of Tennessee  \n\n# 第 3-4 行，输出结果文件的形式\nHPL.out      output file name (if any)  \n6            device out (6&#x3D;stdout,7&#x3D;stderr,file) \n\n# 5-6行，求解矩阵的大小\n1            # of problems sizes (N)  \n1000         Ns   \n\n# 7-8行 求解矩阵分块的大小\n1            # of NBs\n192 256      NBs\n\n# 9行 处理器阵列的排列方式，行还是列\n0：适用于节点较少，单个节点CPU较多的胖系统\n1：适用于节点较多，单个节点CPU较少的瘦系统（机群上远好于按行排列）\n1            PMAP process mapping (0&#x3D;Row-,1&#x3D;Column-major) \n\n# 10-12行 定义二维处理网格P&#x2F;Q\n# P X Q &#x3D; 进程数，P尽量小于Q\n# P&#x3D;2^n,P最好选择2的幂\n1            # of process grids (P x Q) \n1 2          Ps\n1 2          Qs\n\n# 13行 设置阀值，不用修改\n16.0         threshold\n\n# 14-21行 设置L的分解方式\n1            # of panel fact\n2 1 0        PFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大\n1            # of recursive stopping criterium\n4 8          NBMINs (&gt;&#x3D; 1)   # 4或8都不错\n1            # of panels in recursion\n2            NDIVs  # 选2比较理想\n1            # of recursive panel fact.\n1 0 2        RFACTs (0&#x3D;left, 1&#x3D;Crout, 2&#x3D;Right) # 对性能影响不大\n\n# 22-23行 设置L的横向广播方式\n# 前四种，适用于快速网络，后两种适用于速度较慢的网络\n# 小规模系统，选择0&#x2F;1，大规模系统选择3\n1            # of broadcast\n0            BCASTs (0&#x3D;1rg,1&#x3D;1rM,2&#x3D;2rg,3&#x3D;2rM,4&#x3D;Lng,5&#x3D;LnM)\n\n# 24-25行 设置横向通信的通信深度\n# 小规模系统选择1&#x2F;2，大规模系统2-5之间\n1            # of lookahead depth\n1            DEPTHs (&gt;&#x3D;0)\n\n# 26-27 设置U的广播算法\n# 小规模系统，使用缺省值即可\n0            SWAP (0&#x3D;bin-exch,1&#x3D;long,2&#x3D;mix)\n1            swapping threshold\n\n# 28-29行 L和U的数据存放格式\n0：按列存放\n1：按行存放\n0            L1 in (0&#x3D;transposed,1&#x3D;no-transposed) form\n0            U  in (0&#x3D;transposed,1&#x3D;no-transposed) form\n\n# 30-31 缺省值即可\n0            Equilibration (0&#x3D;no,1&#x3D;yes)\n8            memory alignment in double (&gt; 0)\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-6-测试脚本编写\"><a href=\"#6-6-测试脚本编写\" class=\"headerlink\" title=\"6.6 测试脚本编写\"></a>6.6 测试脚本编写</h2><h3 id=\"6-6-1-本地mpirun测试脚本（Intel版本）\"><a href=\"#6-6-1-本地mpirun测试脚本（Intel版本）\" class=\"headerlink\" title=\"6.6.1 本地mpirun测试脚本（Intel版本）\"></a>6.6.1 本地mpirun测试脚本（Intel版本）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 本地单节点测试，需要根据&#96;lscpu&#96;中numa分区情况(node)的使用mpirun测试xhpl\n# eg:在未开超线程的情况下，分为两个node，每个node中有12个核，则最佳测试方法为mpirun -np 2 .&#x2F;myrun.sh\n# 以下为myrun.sh的具体实现\n\n#!&#x2F;bin&#x2F;bash\nulimit -s unlimited\nCores&#x3D;48\nThreadsNum&#x3D;&#96;echo &quot;$&#123;Cores&#125;&#x2F;$&#123;PMI_SIZE&#125;&quot; | bc&#96; # 计算每个进程跑的线程数\ncase $&#123;PMI_SIZE&#125; in\n2)\n        case $&#123;PMI_RANK&#125; in\n        0)\n        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;\n        export HPL_HOST_CORE&#x3D;&#39;0-23&#39;\n        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n        ;;\n        1)\n        export OMP_NUM_THREADS&#x3D;$&#123;ThreadsNum&#125;\n        export HPL_HOST_CORE&#x3D;&#39;24-47&#39;\n        .&#x2F;xhpl -n 1 -b 384 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n        ;;\n        esac\n;;\nesac\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-6-2-Slurm-srun测试脚本-FT版本\"><a href=\"#6-6-2-Slurm-srun测试脚本-FT版本\" class=\"headerlink\" title=\"6.6.2 Slurm srun测试脚本(FT版本)\"></a>6.6.2 Slurm srun测试脚本(FT版本)</h2><p>xhplrun.sh</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\nulimit -s unlimited\nCores&#x3D;48\n\n\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nPMI_SIZE&#x3D;$SLURM_NPROCS\nPMI_RANK&#x3D;$SLURM_PROCID\nMPI_NUM_NODE&#x3D;$SLURM_NNODES\nMPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))\nMPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))\n\nPRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;\nPMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;\n&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n\necho $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;\n\nexport HPL_CMDLINE&#x3D;1\ncase $&#123;PRO_SIZE&#125; in\n1)\n#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\ncase $&#123;PMI_RANK_my&#125; in\n0)\n#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;\nnumactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\n#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;\nnumactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>yhrun 提交作业 runpro.sh</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE&#x3D;1\n\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH\n\nnodes&#x3D;$&#123;1&#125;\nnnodes&#x3D;$&#123;2&#125;\nnprocs&#x3D;$&#123;3&#125;\nnmem&#x3D;$&#123;4&#125;\nlogdir&#x3D;$&#123;5&#125;\n\n\nmkdir -p $&#123;logdir&#125;\n\ntnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))\nP&#x3D;1\nQ&#x3D;1\nfor i in &#96;seq 1 $&#123;tnprocs&#125;&#96;\ndo\n        for j in &#96;seq 1 $&#123;tnprocs&#125;&#96;\n        do\n                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))\n                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ] &amp;&amp; [ $&#123;i&#125; -le $&#123;j&#125; ]\n                then\n                        P&#x3D;$&#123;i&#125;\n                        Q&#x3D;$&#123;j&#125;\n                fi\n        done\ndone\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;\ndone\nwait\nsleep 1\n\nj&#x3D;0\nrunnodes&#x3D;&#39;&#39;\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        runnodes+&#x3D;$&#123;i&#125;,\n        let j++\n        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]\n        then\n                echo &quot;yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;\n                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log\n                yhrun -p all -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                j&#x3D;0\n                runnodes&#x3D;&#39;&#39;\n        fi\ndone<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-7-Bios设置\"><a href=\"#6-7-Bios设置\" class=\"headerlink\" title=\"6.7 Bios设置\"></a>6.7 Bios设置</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">琦哥的：\n    UPI Configuration\n        Link Lop -&gt; disable\n        Link L1  -&gt; disable \n        IO Directory Cache -&gt; enable\n        Isoc Mode -&gt; enable\n\n    Memory Configuration\n        Eufsrce POR -&gt; enable\n        PPR Type -&gt; Soft PPR\n        Memory Frequency -&gt; 2666\n        Data Scrambling for NVMDIMM -&gt; enable\n        Data Scrambling for DDR4 -&gt; enable\n        Enable AOR -&gt; enable\n        Refresh Option -&gt; enable\n        Memory RAS\n            Memory Rank Sparing -&gt; enable\n\n    IIO Configuration\n        PCI-E Port Max Payload Size -&gt; 256B\n\n    CPU P-State\n        SpeedStep -&gt; disable&#x2F;enable?\n        PBF \n        Hardware P-State -&gt; enable\n        Package c state -&gt; No limit \n\t\n网上找的系统Bios设置优化\n    关闭超线程\n    打开EIST\n    打开Turbo Mode\n    Boot Performance mode设置为max performance\n    Energy Performance BIAS设置为Performance\n    打开Monitor&#x2F;Mwait\n    Package C stat limit设置为C0&#x2F;C1 state\n    关闭CPU C3 report\n    关闭CPU C6 report\n    关闭Enhanced Halt State\n    关闭Intel VT for Directed I&#x2F;O\n    Linux OS下CPU Power Management设置为max performance\n    QPI及Memory Frequency保持为Max Frequency\n    关闭NUMA功能 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-8-结果反馈\"><a href=\"#6-8-结果反馈\" class=\"headerlink\" title=\"6.8 结果反馈\"></a>6.8 <span id=\"jump\">结果反馈</span></h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#linpack测试以我们为主导\n\n1、grep FAILED 关键字,查看是否有节点计算错误\n2、grep WR 查看节点性能是否正常\n3、统计跑死的点\n\n# 如何反馈？\n一轮Linpack40分钟测试完成\n\t一、6个点本是drain*状态\n\t二、3个点跑死，cn[1,2,3]\n\t三、5个点Linpack计算FAILED\n\t四、其他点linpakc性能正常\n可以考虑更换下一批<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-9-风冷系统linpack测试全过程记录\"><a href=\"#6-9-风冷系统linpack测试全过程记录\" class=\"headerlink\" title=\"6.9 风冷系统linpack测试全过程记录\"></a>6.9 风冷系统linpack测试全过程记录</h2><blockquote>\n<h5 id=\"1、了解风冷系统的架构\"><a href=\"#1、了解风冷系统的架构\" class=\"headerlink\" title=\"1、了解风冷系统的架构\"></a>1、了解风冷系统的架构</h5><p>按批次测试，测完一批换下一批</p>\n<p>一批为192个节点，每个框32个节点，共6个框</p>\n<p>每个节点128G内存，芯片为FT2000+, 通过mhz获取频率为2000（降频），64物理核</p>\n<p>系统版本： 4.19.46-cn+</p>\n<h5 id=\"2、计算每个节点的理论峰值\"><a href=\"#2、计算每个节点的理论峰值\" class=\"headerlink\" title=\"2、计算每个节点的理论峰值\"></a>2、计算每个节点的理论峰值</h5><p>2000 * 128 &#x2F; 64 * 2 * 64&#x3D; 512000</p>\n<h5 id=\"3、开始测试\"><a href=\"#3、开始测试\" class=\"headerlink\" title=\"3、开始测试\"></a>3、开始测试</h5><p>runpro.sh脚本参数说明:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh NodeList NodeBind ProcessesPerNode MemSize\n&gt;NodeList 节点列表,例如cn[0-8]\n&gt;NodeBind 几个节点绑定运行，例如2，则计算效率时，需要将结果得到的效率&#x2F;2&#x2F;512\n&gt;ProcessesPerNode 每给节点运行几个xhpl进程，根据numa node来，FT一般是8\n&gt;MemSize 每个节点中，每个进程分配的内存，一般使用到约总内存的80%，例如单节点128G，填写12000（单位为Mb），则总使用96G内存<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>单节点测试：</p>\n<p>​\t不需要互联测试网络联通性，仅对单节点进行压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>多节点测试：</p>\n<p>​\t需要互联测试网络联通性， 2，4， 8， 16， 32， 64， 128，如果要求测多节点稳定性，测试的8点8进8线，结果按<a href=\"#jump\">章节6.8</a>反馈</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn0 1 8 12000 logdir<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>问题解决一：</p>\n<p>​\t测试到128节点，性能异常，效率仅有43%</p>\n<p>互联那边回应：</p>\n<p>​\t节点数超过64，通信就跨框</p>\n<p>琦哥建议的做法：</p>\n<p>​\t把128个节点分到4个框，测试一下，看是不是带宽的原因</p>\n<p>最后的解决方法：</p>\n<p>​\t网络拓扑更换，矩阵值不能相等，使用原本32 x 32，改为16 x 64，但是换成160节点后还是有问题</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&gt;.&#x2F;runpro.sh cn[xx-xx] 128 8 12000 dir\n&gt;其中执行的xhplrun.sh的参数为\n&gt;xhplrun.sh 32 32 12000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n</blockquote>\n<h1 id=\"七、Lmbench-测试\"><a href=\"#七、Lmbench-测试\" class=\"headerlink\" title=\"七、Lmbench 测试\"></a>七、Lmbench 测试</h1><h2 id=\"7-1-概述\"><a href=\"#7-1-概述\" class=\"headerlink\" title=\"7.1 概述\"></a>7.1 概述</h2><p>​\tLmbench是一套简易，可移植的，符合ANSI&#x2F;C标准为UNIX&#x2F;POSIX而制定的微型测评工具。一般来说，它衡量两个关键特征：反应时间和带宽。LmBench旨在使系统开发者深入了解关键操作的基础成本。</p>\n<h2 id=\"7-2-工具安装\"><a href=\"#7-2-工具安装\" class=\"headerlink\" title=\"7.2 工具安装\"></a>7.2 工具安装</h2><p>获取源包：</p>\n<p>​\tlmbench3.tar.gz</p>\n<p>gcc编译安装</p>\n<h2 id=\"7-3-测试步骤\"><a href=\"#7-3-测试步骤\" class=\"headerlink\" title=\"7.3 测试步骤\"></a>7.3 测试步骤</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd src\nmake results\nmake see\n内存10G。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">错误处理：\n[root@cn9 lmbench3]# cd src&#x2F;\n[root@cn9 src]# make results\ngmake[1]: Entering directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;\ngmake[1]: *** No rule to make target &#96;..&#x2F;SCCS&#x2F;s.ChangeSet&#39;, needed by &#96;bk.ver&#39;.  Stop.\ngmake[1]: Leaving directory &#96;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;lmbench3&#x2F;src&#39;\n解决方法：\n\tvim Makefile\n\t231行修改：\n\t$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench bk.ver\n\t改为\n\t$O&#x2F;lmbench : ..&#x2F;scripts&#x2F;lmbench<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"八、IOR-测试（暂无）\"><a href=\"#八、IOR-测试（暂无）\" class=\"headerlink\" title=\"八、IOR 测试（暂无）\"></a>八、IOR 测试（暂无）</h1><h1 id=\"九、alltoall测试\"><a href=\"#九、alltoall测试\" class=\"headerlink\" title=\"九、alltoall测试\"></a>九、alltoall测试</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yhrun -n 128 -N 8 -w cn34,cn35,cn36,cn37,cn38,cn39,cn40,cn41, &#x2F;root&#x2F;xm_alltoall 102400 1000<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"附录：常用工具链编译方法\"><a href=\"#附录：常用工具链编译方法\" class=\"headerlink\" title=\"附录：常用工具链编译方法\"></a>附录：常用工具链编译方法</h1><h2 id=\"一、GCC编译\"><a href=\"#一、GCC编译\" class=\"headerlink\" title=\"一、GCC编译\"></a>一、GCC编译</h2><p>需要依次编译依赖软件，然后在编译gcc中使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 设置isl的库路径\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH\n# 编译GCC\n..&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --enable-lto --disable-bootstrap --enable-languages&#x3D;c,c++,fortran --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpc&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-isl&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-1-依赖软件编译\"><a href=\"#1-1-依赖软件编译\" class=\"headerlink\" title=\"1.1 依赖软件编译\"></a>1.1 依赖软件编译</h3><h4 id=\"1-1-2-编译安装gmp\"><a href=\"#1-1-2-编译安装gmp\" class=\"headerlink\" title=\"1.1.2 编译安装gmp\"></a>1.1.2 编译安装gmp</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake \nmake install\n\n.&#x2F;configure --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83  --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc83<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-3-编译安装mpfr\"><a href=\"#1-1-3-编译安装mpfr\" class=\"headerlink\" title=\"1.1.3 编译安装mpfr\"></a>1.1.3 编译安装mpfr</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake \nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-4-编译安装mpc\"><a href=\"#1-1-4-编译安装mpc\" class=\"headerlink\" title=\"1.1.4 编译安装mpc\"></a>1.1.4 编译安装mpc</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-mpfr&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830\nmake\nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-1-5-编译安装isl\"><a href=\"#1-1-5-编译安装isl\" class=\"headerlink\" title=\"1.1.5 编译安装isl\"></a>1.1.5 编译安装isl</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830 --with-gmp-prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"> yum install gcc-* gtk2 gtk3 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686\nglibc.i686 glibc-devel.i686 libgcc* xulrunner.x86_64 xulrunner.i686 glibc-devel.x86_64 glibc.x86_64 autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\nmount -o loop -t iso9660 &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM\n\n\nyum install gcc-* gtk2 gtk3 glibc-devel.i686 x11 libX11.x86_64 libX11-devel.x86_64 libXorg libXss libXScrnSaver.x86_64 xorg-x11-server-Xorg.x86_64 xulrunner.x86_64 xulrunner.i686 libstdc++.i686 libstdc++-devel.i686 glibc* libgcc* xulrunner* autoconf-archive.noarch gtk2 gtk3 pango libXScrnSaver libX11.x86_64 libX11-devel.x86_64 libX11-common.noarch libxkbcommon-x11.x86_64 xorg-x11-server-common.x86_64 libstdc++* -y\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、MPICH3编译\"><a href=\"#二、MPICH3编译\" class=\"headerlink\" title=\"二、MPICH3编译\"></a>二、MPICH3编译</h2><p>设置gcc830的环境变量</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$LD_INCLUDE_PATH\nexport CPATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;include:$CPATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;lib64:$LD_LIBRARY_PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;gcc830&#x2F;libexec:$LD_LIBRARY_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>再编译</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;configure --prefix&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830 --enable-fast --enable-shared&#x3D;yes --enable-threads&#x3D;runtime --with-ch3-rank-bits&#x3D;32 --enable-romio --with-file-system&#x3D;ufs+nfs --with-mpe\nmake \nmake install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>设置环境变量使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">export PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;lib:$LD_LIBRARY_PATH\nexport LD_INCLUDE_PATH&#x3D;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;tools&#x2F;mpi3-gcc830&#x2F;include:$LD_INCLUDE_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"三、Redhat设置本地镜像源\"><a href=\"#三、Redhat设置本地镜像源\" class=\"headerlink\" title=\"三、Redhat设置本地镜像源\"></a>三、Redhat设置本地镜像源</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mount -o loop -t iso9660 &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;images&#x2F;rhel-server-7.6-x86_64-dvd.iso &#x2F;home&#x2F;IOSYS&#x2F;test652&#x2F;mnt&#x2F;CDROM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;redhat.repo\n\n[rhel7.6]\nname&#x3D;rhel7.6\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;home&#x2F;testcpu&#x2F;test652&#x2F;mnt&#x2F;CDROM\nenabled&#x3D;1\ngpgcheck&#x3D;0\npriority&#x3D;1\n\nyum clean\nyum update\nyum repolist<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、找不到so库的解决方法\"><a href=\"#四、找不到so库的解决方法\" class=\"headerlink\" title=\"四、找不到so库的解决方法\"></a>四、找不到so库的解决方法</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 方法一：\n\t设置LD_LIBRARY_PATH\n# 方法二：\n \tvim &#x2F;etc&#x2F;ld.so.conf\n \t----------------------------------------------------\n \tinclude ld.so.conf.d&#x2F;*.conf\n\t&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries&#x2F;linux&#x2F;lib&#x2F;intel64\n\tldconfig 更新<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、复制以及查看端口占用\"><a href=\"#五、复制以及查看端口占用\" class=\"headerlink\" title=\"五、复制以及查看端口占用\"></a>五、复制以及查看端口占用</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 查看端口占用\nnetstat -nultp | grep 8080\nnetstat -anp  | grep 80\nnetstat -ano | grep 18130\nlsof -i:18130\n\n# 复制\nrsync -chavP &#x2F;var&#x2F;opt&#x2F;gitlab&#x2F;postgresql .\nrsync -avzP 复制显示进度\n\n# 查看Bios版本\ndmidecode<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">\nmpiicc -DAdd__ -DF77_INTEGER&#x3D;int -DStringSunStyle -DHPL_DETAILED_TIMING -DHPL_PROGRESS_REPORT -I&#x2F;root&#x2F;hpl&#x2F;include -I&#x2F;root&#x2F;hpl&#x2F;include&#x2F;Linux_Intel64 -I&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;include  -O3 -w -ansi-alias -i-static -z noexecstack -z relro -z now -nocompchk -Wall -qopenmp -mt_mpi -o &#x2F;root&#x2F;hpl&#x2F;bin&#x2F;Linux_Intel64&#x2F;xhpl HPL_pddriver.o         HPL_pdinfo.o           HPL_pdtest.o &#x2F;root&#x2F;hpl&#x2F;lib&#x2F;Linux_Intel64&#x2F;libhpl.a  -L&#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;mkl&#x2F;lib&#x2F;intel64 -Wl,--start-group &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_lp64.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_intel_thread.a &#x2F;opt&#x2F;intel&#x2F;compilers_and_libraries_2019.4.243&#x2F;linux&#x2F;mkl&#x2F;lib&#x2F;intel64&#x2F;libmkl_core.a -Wl,--end-group -lpthread -ldl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、查看cpu主频率-和-内存信息\"><a href=\"#六、查看cpu主频率-和-内存信息\" class=\"headerlink\" title=\"六、查看cpu主频率 和 内存信息\"></a>六、查看cpu主频率 和 内存信息</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 查看CPU信息\nlscpu 其中 sockets个数代表物理核个数\ncat &#x2F;proc&#x2F;cpuinfo\nlmbench的mhz\n&#x2F;usr&#x2F;bin&#x2F;turbostat\n\n# 查看内存信息\ncat &#x2F;proc&#x2F;meminfo\ndmidecode | grep -A 16 &quot;Memory Device&quot;、<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"七、GLSL-1-50-is-not-supported\"><a href=\"#七、GLSL-1-50-is-not-supported\" class=\"headerlink\" title=\"七、GLSL 1.50 is not supported\"></a>七、GLSL 1.50 is not supported</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 报错：\nERROR: In &#x2F;home&#x2F;gs&#x2F;src&#x2F;VTK8.2&#x2F;VTK-8.2.0&#x2F;Rendering&#x2F;OpenGL2&#x2F;vtkShaderProgram.cxx, line 447\nvtkShaderProgram (0x2b87270): 0:1(10): error: GLSL 1.50 is not supported. Supported versions are: 1.10, 1.20, 1.30, 1.00 ES, and 3.00 ES\n\n# 解决方法\nexport MESA_GL_VERSION_OVERRIDE&#x3D;3.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cn[16-19,24-27,144-147,152-155]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"八、附录\"><a href=\"#八、附录\" class=\"headerlink\" title=\"八、附录\"></a>八、附录</h2><h3 id=\"8-1-Linpack脚本\"><a href=\"#8-1-Linpack脚本\" class=\"headerlink\" title=\"8.1 Linpack脚本\"></a>8.1 Linpack脚本</h3><blockquote>\n<p>runpro.sh</p>\n<p>.&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir</p>\n<p>node_list 节点列表</p>\n<p>nodes_num 几个点连在一起跑，单点 双点 多点</p>\n<p> proc_per_node 每个节点跑几个进程，看node分为几个，FT一般是8</p>\n<p> mem 12000 每个进程分配的内存，*8 大概&#x3D; 总内存的80%</p>\n<p> logdir 日志文件</p>\n<p> 单点8进程，一轮≈35分钟</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#! &#x2F;bin&#x2F;bash\n\n#duqi\n\nif [ $# -ne 5 ]\nthen\n        echo Usage: .&#x2F;runpro.sh nodes_list nodes_num proc_per_node mem_per_proc logdir\n        exit 0\nfi\n\nexport HPL_CMDLINE&#x3D;1\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:LD_LIBRARY_PATH\n\nnodes&#x3D;$&#123;1&#125;\nnnodes&#x3D;$&#123;2&#125;\nnprocs&#x3D;$&#123;3&#125;\nnmem&#x3D;$&#123;4&#125;\nlogdir&#x3D;$&#123;5&#125;\n\n\nmkdir -p $&#123;logdir&#125;\n\ntnprocs&#x3D;$(($&#123;nnodes&#125;*$&#123;nprocs&#125;))\nP&#x3D;1\nQ&#x3D;1\n\n\nnum_max&#x3D;1\nfor i in &#96;seq 1 $&#123;tnprocs&#125;&#96;\ndo\n        j&#x3D;$(($&#123;i&#125;*$&#123;i&#125;))\n        if [ $&#123;tnprocs&#125; -le $&#123;j&#125; ]; then\n                num_max&#x3D;$&#123;i&#125;\n                break\n        fi\ndone\nfor i in &#96;seq 1 $&#123;num_max&#125;&#96;\ndo\n        for j in &#96;seq $&#123;num_max&#125; $&#123;tnprocs&#125;&#96;\n        do\n                PQ&#x3D;$(($&#123;i&#125;*$&#123;j&#125;))\n                if [ $&#123;PQ&#125; -eq $&#123;tnprocs&#125; ]\n                then\n                        P&#x3D;$&#123;i&#125;\n                        Q&#x3D;$&#123;j&#125;\n                fi\n        done\ndone\n\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        scp HPL.dat $i:&#x2F;root&#x2F;linpack &amp;\ndone\nsleep 1\n\nj&#x3D;0\nrunnodes&#x3D;&#39;&#39;\n\nfor i in &#96;yhcontrol show hostname $&#123;nodes&#125;&#96;\ndo\n        runnodes+&#x3D;$&#123;i&#125;,\n        let j++\n        if [ $&#123;j&#125; -eq $&#123;nnodes&#125; ]\n        then\n                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;&quot;\n                echo $&#123;runnodes&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                echo &quot;yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125;&quot; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;list.log\n                yhrun -p All -N $&#123;nnodes&#125; -n $&#123;tnprocs&#125; -w $&#123;runnodes&#125; -D &#x2F;root&#x2F;linpack &#x2F;root&#x2F;linpack&#x2F;xhplrun.sh $&#123;P&#125; $&#123;Q&#125; $&#123;nmem&#125; &amp;&gt;&gt; $&#123;logdir&#125;&#x2F;$&#123;i&#125;.log &amp;\n                j&#x3D;0\n                runnodes&#x3D;&#39;&#39;\n        fi\ndone\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>xhplrun.sh</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#! &#x2F;bin&#x2F;bash\n\n#duqi\n\nulimit -s unlimited\n\nCores&#x3D;64\n#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\nPMI_SIZE&#x3D;$SLURM_NPROCS\n\nPMI_RANK&#x3D;$SLURM_PROCID\n\nMPI_NUM_NODES&#x3D;$SLURM_NNODES\n\nMPI_PER_NODE&#x3D;$((PMI_SIZE &#x2F; MPI_NUM_NODES))\n\nMPI_RANK_FOR_NODE&#x3D;$((PMI_RANK % MPI_PER_NODE))\n#&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n\n\nthreads&#x3D;&#96;echo $&#123;Cores&#125;*$&#123;SLURM_NNODES&#125;&#x2F;$&#123;PMI_SIZE&#125; | bc&#96;\n\nPRO_SIZE&#x3D;$&#123;MPI_PER_NODE&#125;\nPMI_RANK_my&#x3D;$&#123;MPI_RANK_FOR_NODE&#125;\n\necho $&#123;PRO_SIZE&#125; $&#123;PMI_RANK_my&#125; $&#123;threads&#125; $&#123;PMI_SIZE&#125; $&#123;PMI_RANK&#125; $&#123;MPI_NUM_NODES&#125; $&#123;MPI_PER_NODE&#125; $&#123;MPI_RANK_FOR_NODE&#125;\n\nexport HPL_CMDLINE&#x3D;1\ncase $&#123;PRO_SIZE&#125; in\n1)\n#numactl -i 0-1 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0,4 -N 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\ncase $&#123;PMI_RANK_my&#125; in\n0)\n#numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-31&#39;\nnumactl -i 4-7 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\n#numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -m 7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-63&#39;\nnumactl -i 0-3 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n#mpirun -n 1 numactl -i 0-3 -N 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125; : -n 1 numactl -i 4-7 -N 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-15&#39;\nnumactl -i 0-7 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 2-3 -N 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-31&#39;\nnumactl -i 0-7 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 4-5 -N 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-47&#39;\nnumactl -i 0-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 6-7 -N 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-63&#39;\nnumactl -i 0-7 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0-1 -N 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n8)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-7&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 4 -N 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-15&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 2 -N 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-23&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 6 -N 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-31&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 1 -N 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-39&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 0 -N 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-47&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 7 -N 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-55&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 5 -N 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-63&#39;\nnumactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#numactl -i 3 -N 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#.&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n16)\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-3&#39;\nnumactl -i 0-7 -C 0-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4-7&#39;\nnumactl -i 0-7 -C 4-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-11&#39;\nnumactl -i 0-7 -C 8-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12-15&#39;\nnumactl -i 0-7 -C 12-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-19&#39;\nnumactl -i 0-7 -C 16-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20-23&#39;\nnumactl -i 0-7 -C 20-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-27&#39;\nnumactl -i 0-7 -C 24-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28-31&#39;\nnumactl -i 0-7 -C 28-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-35&#39;\nnumactl -i 0-7 -C 32-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36-39&#39;\nnumactl -i 0-7 -C 36-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-43&#39;\nnumactl -i 0-7 -C 40-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44-47&#39;\nnumactl -i 0-7 -C 44-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-51&#39;\nnumactl -i 0-7 -C 48-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52-55&#39;\nnumactl -i 0-7 -C 52-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-59&#39;\nnumactl -i 0-7 -C 56-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60-63&#39;\nnumactl -i 0-7 -C 60-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n32)\n#export OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#;;\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0-1&#39;\nnumactl -i 0-7 -C 0-1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;2-3&#39;\nnumactl -i 0-7 -C 2-3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4-5&#39;\nnumactl -i 0-7 -C 4-5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;6-7&#39;\nnumactl -i 0-7 -C 6-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8-9&#39;\nnumactl -i 0-7 -C 8-9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;10-11&#39;\nnumactl -i 0-7 -C 10-11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12-13&#39;\nnumactl -i 0-7 -C 12-13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;14-15&#39;\nnumactl -i 0-7 -C 14-15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16-17&#39;\nnumactl -i 0-7 -C 16-17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;18-19&#39;\nnumactl -i 0-7 -C 18-19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20-21&#39;\nnumactl -i 0-7 -C 20-21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;22-23&#39;\nnumactl -i 0-7 -C 22-23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24-25&#39;\nnumactl -i 0-7 -C 24-25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;26-27&#39;\nnumactl -i 0-7 -C 26-27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28-29&#39;\nnumactl -i 0-7 -C 28-29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;30-31&#39;\nnumactl -i 0-7 -C 30-31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n16)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32-33&#39;\nnumactl -i 0-7 -C 32-33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n17)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;34-35&#39;\nnumactl -i 0-7 -C 34-35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n18)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36-37&#39;\nnumactl -i 0-7 -C 36-37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n19)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;38-39&#39;\nnumactl -i 0-7 -C 38-39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n20)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40-41&#39;\nnumactl -i 0-7 -C 40-41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n21)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;42-43&#39;\nnumactl -i 0-7 -C 42-43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n22)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44-45&#39;\nnumactl -i 0-7 -C 44-45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n23)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;46-47&#39;\nnumactl -i 0-7 -C 46-47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n24)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48-49&#39;\nnumactl -i 0-7 -C 48-49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n25)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;50-51&#39;\nnumactl -i 0-7 -C 50-51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n26)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52-53&#39;\nnumactl -i 0-7 -C 52-53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n27)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;54-55&#39;\nnumactl -i 0-7 -C 54-55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n28)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56-57&#39;\nnumactl -i 0-7 -C 56-57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n29)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;58-59&#39;\nnumactl -i 0-7 -C 58-59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n30)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60-61&#39;\nnumactl -i 0-7 -C 60-61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n31)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;62-63&#39;\nnumactl -i 0-7 -C 62-63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\n64)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\n#export GOMP_CPU_AFFINITY&#x3D;&#39;0-63&#39;\n#numactl -i 0-7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n#;;\ncase $&#123;PMI_RANK_my&#125; in\n0)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;0&#39;\nnumactl -i 0-7 -C 0 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n1)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;1&#39;\nnumactl -i 0-7 -C 1 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n2)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;2&#39;\nnumactl -i 0-7 -C 2 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n3)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;3&#39;\nnumactl -i 0-7 -C 3 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n4)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;4&#39;\nnumactl -i 0-7 -C 4 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n5)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;5&#39;\nnumactl -i 0-7 -C 5 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n6)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;6&#39;\nnumactl -i 0-7 -C 6 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n7)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;7&#39;\nnumactl -i 0-7 -C 7 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n8)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;8&#39;\nnumactl -i 0-7 -C 8 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n9)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;9&#39;\nnumactl -i 0-7 -C 9 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n10)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;10&#39;\nnumactl -i 0-7 -C 10 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n11)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;11&#39;\nnumactl -i 0-7 -C 11 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n12)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;12&#39;\nnumactl -i 0-7 -C 12 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n13)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;13&#39;\nnumactl -i 0-7 -C 13 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n14)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;14&#39;\nnumactl -i 0-7 -C 14 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n15)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;15&#39;\nnumactl -i 0-7 -C 15 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n16)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;16&#39;\nnumactl -i 0-7 -C 16 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n17)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;17&#39;\nnumactl -i 0-7 -C 17 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n18)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;18&#39;\nnumactl -i 0-7 -C 18 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n19)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;19&#39;\nnumactl -i 0-7 -C 19 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n20)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;20&#39;\nnumactl -i 0-7 -C 20 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n21)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;21&#39;\nnumactl -i 0-7 -C 21 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n22)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;22&#39;\nnumactl -i 0-7 -C 22 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n23)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;23&#39;\nnumactl -i 0-7 -C 23 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n24)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;24&#39;\nnumactl -i 0-7 -C 24 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n25)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;25&#39;\nnumactl -i 0-7 -C 25 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n26)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;26&#39;\nnumactl -i 0-7 -C 26 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n27)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;27&#39;\nnumactl -i 0-7 -C 27 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n28)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;28&#39;\nnumactl -i 0-7 -C 28 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n29)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;29&#39;\nnumactl -i 0-7 -C 29 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n30)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;30&#39;\nnumactl -i 0-7 -C 30 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n31)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;31&#39;\nnumactl -i 0-7 -C 31 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n32)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;32&#39;\nnumactl -i 0-7 -C 32 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n33)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;33&#39;\nnumactl -i 0-7 -C 33 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n34)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;34&#39;\nnumactl -i 0-7 -C 34 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n35)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;35&#39;\nnumactl -i 0-7 -C 35 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n36)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;36&#39;\nnumactl -i 0-7 -C 36 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n37)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;37&#39;\nnumactl -i 0-7 -C 37 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n38)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;38&#39;\nnumactl -i 0-7 -C 38 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n39)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;39&#39;\nnumactl -i 0-7 -C 39 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n40)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;40&#39;\nnumactl -i 0-7 -C 40 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n41)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;41&#39;\nnumactl -i 0-7 -C 41 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n42)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;42&#39;\nnumactl -i 0-7 -C 42 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n43)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;43&#39;\nnumactl -i 0-7 -C 43 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n44)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;44&#39;\nnumactl -i 0-7 -C 44 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n45)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;45&#39;\nnumactl -i 0-7 -C 45 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n46)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;46&#39;\nnumactl -i 0-7 -C 46 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n47)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;47&#39;\nnumactl -i 0-7 -C 47 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n48)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;48&#39;\nnumactl -i 0-7 -C 48 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n49)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;49&#39;\nnumactl -i 0-7 -C 49 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n50)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;50&#39;\nnumactl -i 0-7 -C 50 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n51)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;51&#39;\nnumactl -i 0-7 -C 51 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n52)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;52&#39;\nnumactl -i 0-7 -C 52 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n53)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;53&#39;\nnumactl -i 0-7 -C 53 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n54)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;54&#39;\nnumactl -i 0-7 -C 54 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n55)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;55&#39;\nnumactl -i 0-7 -C 55 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n56)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;56&#39;\nnumactl -i 0-7 -C 56 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n57)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;57&#39;\nnumactl -i 0-7 -C 57 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n58)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;58&#39;\nnumactl -i 0-7 -C 58 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n59)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;59&#39;\nnumactl -i 0-7 -C 59 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n60)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;60&#39;\nnumactl -i 0-7 -C 60 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n61)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;61&#39;\nnumactl -i 0-7 -C 61 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n62)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;62&#39;\nnumactl -i 0-7 -C 62 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\n63)\nexport OMP_NUM_THREADS&#x3D;$&#123;threads&#125;\nexport GOMP_CPU_AFFINITY&#x3D;&#39;63&#39;\nnumactl -i 0-7 -C 63 .&#x2F;xhpl -n 1 -b 192 -p $&#123;1&#125; -q $&#123;2&#125; -m $&#123;3&#125;\n;;\nesac\n;;\nesac<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"8-2-编译问题\"><a href=\"#8-2-编译问题\" class=\"headerlink\" title=\"8.2 编译问题\"></a>8.2 编译问题</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-lc \n\t解决找不到memcpy问题 \n-lstdc++\n\t解决vtable for xxxx 问题\n-lgcc_s\n\tundefined reference to &#96;_Unwind_Resume&#39;\n\tundefined reference to &#96;__popcountdi2&#39;\n\t\n#include &lt;sys&#x2F;types.h&gt;\n#include &lt;sys&#x2F;types.h&gt;\n\t implicit declaration of function ‘fstat’\n\n#include &lt;sys&#x2F;sysmacros.h&gt;\n\timplicit declaration of function ‘major’<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十、Linux操作\"><a href=\"#十、Linux操作\" class=\"headerlink\" title=\"十、Linux操作\"></a>十、Linux操作</h1><h2 id=\"10-1-ncat端口转发\"><a href=\"#10-1-ncat端口转发\" class=\"headerlink\" title=\"10.1 ncat端口转发\"></a>10.1 ncat端口转发</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ncat --sh-exec &quot;ncat 25.8.27.6 15929&quot; -l 15929 --keep-open<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h1 id=\"十一、DDT安装\"><a href=\"#十一、DDT安装\" class=\"headerlink\" title=\"十一、DDT安装\"></a>十一、DDT安装</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># cp Licence &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;licences&#x2F;\n# cp Licence.14713 &#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;licences&#x2F;\n\nexport PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;forge&#x2F;bin:&#x2F;home&#x2F;gs&#x2F;tools&#x2F;arm&#x2F;licenceserver&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;mpi3.3&#x2F;lib:$LD_LIBRARY_PATH\nifconfig eth3 hw ether 00:1b:21:14:15:60<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#glex高速网版本的MPI改为本地调试用\nexport MPICH_NO_LOCAL&#x3D;0 &#x2F;&#x2F;？不一定需要\nexport MPICH_NEMESIS_NETMOD&#x3D;tcp\nexport PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;bin:$PATH\nexport LD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;local&#x2F;mpi3&#x2F;lib:$LD_LIBRARY_PATH<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h1 id=\"十二、SPEC使用\"><a href=\"#十二、SPEC使用\" class=\"headerlink\" title=\"十二、SPEC使用\"></a>十二、SPEC使用</h1><h2 id=\"12-1-SPEC使用系统工具\"><a href=\"#12-1-SPEC使用系统工具\" class=\"headerlink\" title=\"12.1 SPEC使用系统工具\"></a>12.1 SPEC使用系统工具</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># SEPC设置使用系统的工具\nvim &#x2F;home&#x2F;gs&#x2F;tools&#x2F;spack-v5&#x2F;etc&#x2F;spack&#x2F;defaults&#x2F;packages.yaml\n# 参考：\n..&#x2F;..&#x2F;..&#x2F;lib&#x2F;spack&#x2F;docs&#x2F;build_settings.rst<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十三、mi协议\"><a href=\"#十三、mi协议\" class=\"headerlink\" title=\"十三、mi协议\"></a>十三、mi协议</h1><h2 id=\"13-1-使用mi启动调试\"><a href=\"#13-1-使用mi启动调试\" class=\"headerlink\" title=\"13.1 使用mi启动调试\"></a>13.1 使用mi启动调试</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">gs@ft-svr:~&#x2F;matrix$ gdb --interpreter mi test\n&#x3D;thread-group-added,id&#x3D;&quot;i1&quot;\n~&quot;GNU gdb (Ubuntu 8.2.91.20190405-0ubuntu3) 8.2.91.20190405-git\\n&quot;\n~&quot;Copyright (C) 2019 Free Software Foundation, Inc.\\n&quot;\n~&quot;License GPLv3+: GNU GPL version 3 or later &lt;http:&#x2F;&#x2F;gnu.org&#x2F;licenses&#x2F;gpl.html&gt;\\nThis is free software: you are free to change and redistribute it.\\nThere is NO WARRANTY, to the extent permitted by law.&quot;\n~&quot;\\nType \\&quot;show copying\\&quot; and \\&quot;show warranty\\&quot; for details.\\n&quot;\n~&quot;This GDB was configured as \\&quot;aarch64-linux-gnu\\&quot;.\\n&quot;\n~&quot;Type \\&quot;show configuration\\&quot; for configuration details.\\n&quot;\n~&quot;For bug reporting instructions, please see:\\n&quot;\n~&quot;&lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;bugs&#x2F;&gt;.\\n&quot;\n~&quot;Find the GDB manual and other documentation resources online at:\\n    &lt;http:&#x2F;&#x2F;www.gnu.org&#x2F;software&#x2F;gdb&#x2F;documentation&#x2F;&gt;.&quot;\n~&quot;\\n\\n&quot;\n~&quot;For help, type \\&quot;help\\&quot;.\\n&quot;\n~&quot;Type \\&quot;apropos word\\&quot; to search for commands related to \\&quot;word\\&quot;...\\n&quot;\n~&quot;Reading symbols from test...\\n&quot;\n(gdb)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"13-2-断点命令（BreakPoint）\"><a href=\"#13-2-断点命令（BreakPoint）\" class=\"headerlink\" title=\"13.2 断点命令（BreakPoint）\"></a>13.2 断点命令（BreakPoint）</h2><h3 id=\"13-2-1-break-after\"><a href=\"#13-2-1-break-after\" class=\"headerlink\" title=\"13.2.1 -break-after\"></a>13.2.1 -break-after</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-after number count\n第number个断点在执行count次后有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-2-break-condition\"><a href=\"#13-2-2-break-condition\" class=\"headerlink\" title=\"13.2.2 -break-condition\"></a>13.2.2 -break-condition</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-condition number expr\n第number个断点在表达式expr为true时有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-3-break-delete\"><a href=\"#13-2-3-break-delete\" class=\"headerlink\" title=\"13.2.3 -break-delete\"></a>13.2.3 -break-delete</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-delete(breakpoint number)+\n删除指定number的多个断点<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-4-break-disable\"><a href=\"#13-2-4-break-disable\" class=\"headerlink\" title=\"13.2.4 -break-disable\"></a>13.2.4 -break-disable</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-disable(breakpoint number)+\n使用指定Number的多个断点失效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-5-break-enable\"><a href=\"#13-2-5-break-enable\" class=\"headerlink\" title=\"13.2.5 -break-enable\"></a>13.2.5 -break-enable</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-enable(breakpoint number)+\n使用指定Number的多个断点生效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-6-break-info\"><a href=\"#13-2-6-break-info\" class=\"headerlink\" title=\"13.2.6 -break-info\"></a>13.2.6 -break-info</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-info breakpoint\n得到指定断点的信息<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-7-break-insert\"><a href=\"#13-2-7-break-insert\" class=\"headerlink\" title=\"13.2.7 -break-insert\"></a>13.2.7 -break-insert</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-insert\n\t-t\t\t\t\t插入临时断点\n\t-h\t\t\t\t插入硬件断点\n\t-r\t\t\t\t插入正则断点，当函数名匹配正则表达式时生效\n\t-c condition    插入条件断点\n\t-i ignore-count 插入一个指定无效次数的断点\n\t-p thread  \t\t\n\tline | addr(func) <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-8-break-list\"><a href=\"#13-2-8-break-list\" class=\"headerlink\" title=\"13.2.8. -break-list\"></a>13.2.8. -break-list</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-list\n显示已插入的断点列表<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"13-2-9-break-watch\"><a href=\"#13-2-9-break-watch\" class=\"headerlink\" title=\"13.2.9 -break-watch\"></a>13.2.9 -break-watch</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-break-watch [-a|-r] variable\n创建一个观察点，-a标识对variable读写时有效，-r标识只读时有效<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"13-3-程序环境命令-Program-Context\"><a href=\"#13-3-程序环境命令-Program-Context\" class=\"headerlink\" title=\"13.3 程序环境命令(Program Context)\"></a>13.3 程序环境命令(Program Context)</h2><h2 id=\"13-4-线程-thread\"><a href=\"#13-4-线程-thread\" class=\"headerlink\" title=\"13.4 线程(thread)\"></a>13.4 线程(thread)</h2><h2 id=\"13-5-程序执行-Program-Execution\"><a href=\"#13-5-程序执行-Program-Execution\" class=\"headerlink\" title=\"13.5 程序执行(Program Execution)\"></a>13.5 程序执行(Program Execution)</h2><h2 id=\"13-6-栈-Stack\"><a href=\"#13-6-栈-Stack\" class=\"headerlink\" title=\"13.6 栈(Stack)\"></a>13.6 栈(Stack)</h2><h2 id=\"13-7-变量-Variable\"><a href=\"#13-7-变量-Variable\" class=\"headerlink\" title=\"13.7 变量(Variable)\"></a>13.7 变量(Variable)</h2><h2 id=\"13-8-数据-Data\"><a href=\"#13-8-数据-Data\" class=\"headerlink\" title=\"13.8 数据(Data)\"></a>13.8 数据(Data)</h2><h2 id=\"13-9-跟踪点-TracePoint\"><a href=\"#13-9-跟踪点-TracePoint\" class=\"headerlink\" title=\"13.9 跟踪点(TracePoint)\"></a>13.9 跟踪点(TracePoint)</h2><h2 id=\"13-10-符号-Symbol\"><a href=\"#13-10-符号-Symbol\" class=\"headerlink\" title=\"13.10 符号(Symbol)\"></a>13.10 符号(Symbol)</h2><h2 id=\"13-11-文件-File\"><a href=\"#13-11-文件-File\" class=\"headerlink\" title=\"13.11 文件(File)\"></a>13.11 文件(File)</h2><h2 id=\"13-12-目标数据-Target-Manipulation\"><a href=\"#13-12-目标数据-Target-Manipulation\" class=\"headerlink\" title=\"13.12 目标数据(Target Manipulation)\"></a>13.12 目标数据(Target Manipulation)</h2><h2 id=\"13-13-其他\"><a href=\"#13-13-其他\" class=\"headerlink\" title=\"13.13 其他\"></a>13.13 其他</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-enable-pretty-printing\n-var-create - * map\n-var-list-children --all-values var1 0 10\n\n-data-evaluate-expression map\n^done,value&#x3D;&quot;std::map with 140737353945088 elements&lt;error reading variable: Cannot access memory at address 0x1f0fc35f415e51&gt;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&#x2F;&#x2F;    &#x2F;&#x2F; 设置标记类型与颜色\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 0);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#ee6666&quot;), 0);\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::Circle, 1);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#aaaaaa&quot;), 1);\n&#x2F;&#x2F;    this-&gt;markerDefine(QsciScintilla::RightArrow, 2);\n&#x2F;&#x2F;    this-&gt;setMarkerBackgroundColor(QColor(&quot;#eaf593&quot;), 2);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十四、Git改密码\"><a href=\"#十四、Git改密码\" class=\"headerlink\" title=\"十四、Git改密码\"></a>十四、Git改密码</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">gitlab-rails console production\n\nirb(main):002:0&gt; user&#x3D;User.where(email:&#39;cuiyingbomail@163.com&#39;).first\n&#x3D;&gt; #&lt;User id:30 @cyb&gt;\nirb(main):003:0&gt; user.password&#x3D;12345678\n&#x3D;&gt; 12345678\nirb(main):004:0&gt; user.password_confirmation&#x3D;12345678\n&#x3D;&gt; 12345678\nirb(main):005:0&gt; user.save!\nEnqueued ActionMailer::DeliveryJob (Job ID: 540244db-c6ec-44f9-880e-72338b955aa5) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, #&lt;GlobalID:0x00007f57f5da3208 @uri&#x3D;#&lt;URI::GID gid:&#x2F;&#x2F;gitlab&#x2F;User&#x2F;30&gt;&gt;\n&#x3D;&gt; true\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h1 id=\"十五、YHPDE（eclipse）FT部署\"><a href=\"#十五、YHPDE（eclipse）FT部署\" class=\"headerlink\" title=\"十五、YHPDE（eclipse）FT部署\"></a>十五、YHPDE（eclipse）FT部署</h1><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、安装eclipse:\n\tgitlab\n2、插件安装，参考手册\n2、新版SLURM需要\nvim org.eclipse.ptp.rm.slurm.proxy_4.0.7.201104291906&#x2F;src&#x2F;ptp_slurm_proxy.c\n1625行：slurm_allocation_lookup_lite -&gt; slurm_allocation_lookup\n2942行: primary &#x3D; 1; -&gt;  primary &#x3D; 0;\n2943行：secondary &#x3D; 2; -&gt; secondary &#x3D; 1;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--01-整体架构规划","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一 、综合架构规划\n\n>项目中涵盖了架构，架构中又涵盖了不同的角色（高可用、负载均衡、web集群）\n>五层架构模型--> 负载均衡 web服务 存储服务 缓存服务 数据库服务（通过tcp连接）\n\n![综合架构图](/img/综合架构图.png)\n\n### 1 架构访问流程 \n\n#### 1.1 用户视角\n\n```shell\n1.用户通过浏览器输入oldboyedu.com->回车\n2.浏览器会发生一次跳转，分析URL->然后进行DNS解析->获取真实的公网IP地址\n3.用户通过tcp的三次握手发起连接->真实的公网IP\n4.连接会通过公网->路由器->交换机->抵达前端的硬件防火墙\n5.防火墙根据自身访问规则，进行匹配->如果恶意的连接则拒绝->如果是正常的连接则放行\n6.防火墙会将连接转发给负载均衡器->查看用户请求的内容->根据内容进行任务下发->下发给web服务器\n7.web服务接收请求后会根据请求进行判断\n如果是请求图片或者附件->查找存储服务器存储的静态资源\n如果请求的网站上的内容->缓存服务器->如果缓存服务器没有->数据库\n数据库查询完数据之后会返回数据给web服务器->同时也会返回一份给缓存服务器\n8.数据库返回内容->web服务器->负载均衡->用户\n```\n\n#### 1.2 运维视角\n\n```shell\n1.用户通过公网连接（隧道）VPN服务器，这样方便管理内部主机，\n2.自动化配置管理，节省人力成本，便于后期维护。统一环境，标准化\n3.自动化监控服务，监控系统的运行状态，事前预警，事后追溯。\n```\n\n### 2 架构环境规划\n\n#### 2.1 IP分配\n\n```shell\n wanip         lanip       hostname\n10.0.0.5     172.16.1.5     lb01\n10.0.0.6     172.16.1.6     lb02\n10.0.0.7     172.16.1.7     web01\n10.0.0.8     172.16.1.8     web02\n10.0.0.9     172.16.1.9     web03\n10.0.0.31    172.16.1.31    nfs\n10.0.0.41    172.16.1.41    backup\n10.0.0.51    172.16.1.51    db01\n10.0.0.61    172.16.1.61    m01\n10.0.0.71    172.16.1.71    zabbix\n```\n\n#### 2.2 基础环境准备\n\n##### 2.2.1 虚拟机系统和网卡准备\n\n>安装全新Centos7系统，配置网卡为eth0及eth1命名模式\n>1.第一块网卡为NAT模式[公网环境]，配置的网段为10.0.0.0网段\n>2.第二块网卡为LAN模式[私网环境]，配置的网段为172.16.1.0网段\n>3.优化安装好的Centos7虚拟机，安装常用软件、关闭防火墙等等\n\n优化步骤\n\n```shell\n# 1.配置yum仓库\nrm -f /etc/yum.repos.d/*\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n\n# 2.安装基础软件包\nyum install net-tools vim tree htop iftop \\\niotop lrzsz sl wget unzip telnet nmap nc psmisc \\\ndos2unix bash-completion bash-completion-extra sysstat \\\nrsync nfs-utils httpd-tools -y\n\n# 3.关闭防火墙firewalld\nsystemctl disable firewalld\nsystemctl stop firewalld\n\n# 4.关闭selinux\nsed -i '/^SELINUX=/c SELINUX=disabled' /etc/selinux/config\n\n# 5.调整单个进程最大能打开文件的数量\necho '* - nofile 65535' >> /etc/security/limits.conf\n```\n\n基于优化后的虚拟机进行克隆\n\n```shell\n1.连接克隆（需要依赖于母体）\n2.完整克隆（完完全全的复制一份，占用磁盘空间）\n```\n\n对新克隆的主机进行如下操作：\n\n```shell\n# 1.修改主机名  \nhostnamectl set-hostname backup\n\n# 2.修改IP地址  \nsed -i 's#200#41#g' /etc/sysconfig/network-scripts/ifcfg-eth[01]\n\n# 3.重启服务器\n```\n","source":"_posts/01_运维/02-综合架构/01-整体架构规划.md","raw":"---\ntitle: 运维之综合架构--01-整体架构规划\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一 、综合架构规划\n\n>项目中涵盖了架构，架构中又涵盖了不同的角色（高可用、负载均衡、web集群）\n>五层架构模型--> 负载均衡 web服务 存储服务 缓存服务 数据库服务（通过tcp连接）\n\n![综合架构图](/img/综合架构图.png)\n\n### 1 架构访问流程 \n\n#### 1.1 用户视角\n\n```shell\n1.用户通过浏览器输入oldboyedu.com->回车\n2.浏览器会发生一次跳转，分析URL->然后进行DNS解析->获取真实的公网IP地址\n3.用户通过tcp的三次握手发起连接->真实的公网IP\n4.连接会通过公网->路由器->交换机->抵达前端的硬件防火墙\n5.防火墙根据自身访问规则，进行匹配->如果恶意的连接则拒绝->如果是正常的连接则放行\n6.防火墙会将连接转发给负载均衡器->查看用户请求的内容->根据内容进行任务下发->下发给web服务器\n7.web服务接收请求后会根据请求进行判断\n如果是请求图片或者附件->查找存储服务器存储的静态资源\n如果请求的网站上的内容->缓存服务器->如果缓存服务器没有->数据库\n数据库查询完数据之后会返回数据给web服务器->同时也会返回一份给缓存服务器\n8.数据库返回内容->web服务器->负载均衡->用户\n```\n\n#### 1.2 运维视角\n\n```shell\n1.用户通过公网连接（隧道）VPN服务器，这样方便管理内部主机，\n2.自动化配置管理，节省人力成本，便于后期维护。统一环境，标准化\n3.自动化监控服务，监控系统的运行状态，事前预警，事后追溯。\n```\n\n### 2 架构环境规划\n\n#### 2.1 IP分配\n\n```shell\n wanip         lanip       hostname\n10.0.0.5     172.16.1.5     lb01\n10.0.0.6     172.16.1.6     lb02\n10.0.0.7     172.16.1.7     web01\n10.0.0.8     172.16.1.8     web02\n10.0.0.9     172.16.1.9     web03\n10.0.0.31    172.16.1.31    nfs\n10.0.0.41    172.16.1.41    backup\n10.0.0.51    172.16.1.51    db01\n10.0.0.61    172.16.1.61    m01\n10.0.0.71    172.16.1.71    zabbix\n```\n\n#### 2.2 基础环境准备\n\n##### 2.2.1 虚拟机系统和网卡准备\n\n>安装全新Centos7系统，配置网卡为eth0及eth1命名模式\n>1.第一块网卡为NAT模式[公网环境]，配置的网段为10.0.0.0网段\n>2.第二块网卡为LAN模式[私网环境]，配置的网段为172.16.1.0网段\n>3.优化安装好的Centos7虚拟机，安装常用软件、关闭防火墙等等\n\n优化步骤\n\n```shell\n# 1.配置yum仓库\nrm -f /etc/yum.repos.d/*\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\n\n# 2.安装基础软件包\nyum install net-tools vim tree htop iftop \\\niotop lrzsz sl wget unzip telnet nmap nc psmisc \\\ndos2unix bash-completion bash-completion-extra sysstat \\\nrsync nfs-utils httpd-tools -y\n\n# 3.关闭防火墙firewalld\nsystemctl disable firewalld\nsystemctl stop firewalld\n\n# 4.关闭selinux\nsed -i '/^SELINUX=/c SELINUX=disabled' /etc/selinux/config\n\n# 5.调整单个进程最大能打开文件的数量\necho '* - nofile 65535' >> /etc/security/limits.conf\n```\n\n基于优化后的虚拟机进行克隆\n\n```shell\n1.连接克隆（需要依赖于母体）\n2.完整克隆（完完全全的复制一份，占用磁盘空间）\n```\n\n对新克隆的主机进行如下操作：\n\n```shell\n# 1.修改主机名  \nhostnamectl set-hostname backup\n\n# 2.修改IP地址  \nsed -i 's#200#41#g' /etc/sysconfig/network-scripts/ifcfg-eth[01]\n\n# 3.重启服务器\n```\n","slug":"01_运维/02-综合架构/01-整体架构规划","published":1,"updated":"2022-07-11T05:42:39.229Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0a000ga8v74vlk35mj","content":"<h2 id=\"一-、综合架构规划\"><a href=\"#一-、综合架构规划\" class=\"headerlink\" title=\"一 、综合架构规划\"></a>一 、综合架构规划</h2><blockquote>\n<p>项目中涵盖了架构，架构中又涵盖了不同的角色（高可用、负载均衡、web集群）<br>五层架构模型–&gt; 负载均衡 web服务 存储服务 缓存服务 数据库服务（通过tcp连接）</p>\n</blockquote>\n<p><img src=\"/img/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84%E5%9B%BE.png\" alt=\"综合架构图\"></p>\n<h3 id=\"1-架构访问流程\"><a href=\"#1-架构访问流程\" class=\"headerlink\" title=\"1 架构访问流程\"></a>1 架构访问流程</h3><h4 id=\"1-1-用户视角\"><a href=\"#1-1-用户视角\" class=\"headerlink\" title=\"1.1 用户视角\"></a>1.1 用户视角</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.用户通过浏览器输入oldboyedu.com-&gt;回车\n2.浏览器会发生一次跳转，分析URL-&gt;然后进行DNS解析-&gt;获取真实的公网IP地址\n3.用户通过tcp的三次握手发起连接-&gt;真实的公网IP\n4.连接会通过公网-&gt;路由器-&gt;交换机-&gt;抵达前端的硬件防火墙\n5.防火墙根据自身访问规则，进行匹配-&gt;如果恶意的连接则拒绝-&gt;如果是正常的连接则放行\n6.防火墙会将连接转发给负载均衡器-&gt;查看用户请求的内容-&gt;根据内容进行任务下发-&gt;下发给web服务器\n7.web服务接收请求后会根据请求进行判断\n如果是请求图片或者附件-&gt;查找存储服务器存储的静态资源\n如果请求的网站上的内容-&gt;缓存服务器-&gt;如果缓存服务器没有-&gt;数据库\n数据库查询完数据之后会返回数据给web服务器-&gt;同时也会返回一份给缓存服务器\n8.数据库返回内容-&gt;web服务器-&gt;负载均衡-&gt;用户<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-2-运维视角\"><a href=\"#1-2-运维视角\" class=\"headerlink\" title=\"1.2 运维视角\"></a>1.2 运维视角</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.用户通过公网连接（隧道）VPN服务器，这样方便管理内部主机，\n2.自动化配置管理，节省人力成本，便于后期维护。统一环境，标准化\n3.自动化监控服务，监控系统的运行状态，事前预警，事后追溯。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-架构环境规划\"><a href=\"#2-架构环境规划\" class=\"headerlink\" title=\"2 架构环境规划\"></a>2 架构环境规划</h3><h4 id=\"2-1-IP分配\"><a href=\"#2-1-IP分配\" class=\"headerlink\" title=\"2.1 IP分配\"></a>2.1 IP分配</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"> wanip         lanip       hostname\n10.0.0.5     172.16.1.5     lb01\n10.0.0.6     172.16.1.6     lb02\n10.0.0.7     172.16.1.7     web01\n10.0.0.8     172.16.1.8     web02\n10.0.0.9     172.16.1.9     web03\n10.0.0.31    172.16.1.31    nfs\n10.0.0.41    172.16.1.41    backup\n10.0.0.51    172.16.1.51    db01\n10.0.0.61    172.16.1.61    m01\n10.0.0.71    172.16.1.71    zabbix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-基础环境准备\"><a href=\"#2-2-基础环境准备\" class=\"headerlink\" title=\"2.2 基础环境准备\"></a>2.2 基础环境准备</h4><h5 id=\"2-2-1-虚拟机系统和网卡准备\"><a href=\"#2-2-1-虚拟机系统和网卡准备\" class=\"headerlink\" title=\"2.2.1 虚拟机系统和网卡准备\"></a>2.2.1 虚拟机系统和网卡准备</h5><blockquote>\n<p>安装全新Centos7系统，配置网卡为eth0及eth1命名模式<br>1.第一块网卡为NAT模式[公网环境]，配置的网段为10.0.0.0网段<br>2.第二块网卡为LAN模式[私网环境]，配置的网段为172.16.1.0网段<br>3.优化安装好的Centos7虚拟机，安装常用软件、关闭防火墙等等</p>\n</blockquote>\n<p>优化步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1.配置yum仓库\nrm -f &#x2F;etc&#x2F;yum.repos.d&#x2F;*\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\n\n# 2.安装基础软件包\nyum install net-tools vim tree htop iftop \\\niotop lrzsz sl wget unzip telnet nmap nc psmisc \\\ndos2unix bash-completion bash-completion-extra sysstat \\\nrsync nfs-utils httpd-tools -y\n\n# 3.关闭防火墙firewalld\nsystemctl disable firewalld\nsystemctl stop firewalld\n\n# 4.关闭selinux\nsed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;disabled&#39; &#x2F;etc&#x2F;selinux&#x2F;config\n\n# 5.调整单个进程最大能打开文件的数量\necho &#39;* - nofile 65535&#39; &gt;&gt; &#x2F;etc&#x2F;security&#x2F;limits.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>基于优化后的虚拟机进行克隆</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.连接克隆（需要依赖于母体）\n2.完整克隆（完完全全的复制一份，占用磁盘空间）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>对新克隆的主机进行如下操作：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1.修改主机名  \nhostnamectl set-hostname backup\n\n# 2.修改IP地址  \nsed -i &#39;s#200#41#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth[01]\n\n# 3.重启服务器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-、综合架构规划\"><a href=\"#一-、综合架构规划\" class=\"headerlink\" title=\"一 、综合架构规划\"></a>一 、综合架构规划</h2><blockquote>\n<p>项目中涵盖了架构，架构中又涵盖了不同的角色（高可用、负载均衡、web集群）<br>五层架构模型–&gt; 负载均衡 web服务 存储服务 缓存服务 数据库服务（通过tcp连接）</p>\n</blockquote>\n<p><img src=\"/img/%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84%E5%9B%BE.png\" alt=\"综合架构图\"></p>\n<h3 id=\"1-架构访问流程\"><a href=\"#1-架构访问流程\" class=\"headerlink\" title=\"1 架构访问流程\"></a>1 架构访问流程</h3><h4 id=\"1-1-用户视角\"><a href=\"#1-1-用户视角\" class=\"headerlink\" title=\"1.1 用户视角\"></a>1.1 用户视角</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.用户通过浏览器输入oldboyedu.com-&gt;回车\n2.浏览器会发生一次跳转，分析URL-&gt;然后进行DNS解析-&gt;获取真实的公网IP地址\n3.用户通过tcp的三次握手发起连接-&gt;真实的公网IP\n4.连接会通过公网-&gt;路由器-&gt;交换机-&gt;抵达前端的硬件防火墙\n5.防火墙根据自身访问规则，进行匹配-&gt;如果恶意的连接则拒绝-&gt;如果是正常的连接则放行\n6.防火墙会将连接转发给负载均衡器-&gt;查看用户请求的内容-&gt;根据内容进行任务下发-&gt;下发给web服务器\n7.web服务接收请求后会根据请求进行判断\n如果是请求图片或者附件-&gt;查找存储服务器存储的静态资源\n如果请求的网站上的内容-&gt;缓存服务器-&gt;如果缓存服务器没有-&gt;数据库\n数据库查询完数据之后会返回数据给web服务器-&gt;同时也会返回一份给缓存服务器\n8.数据库返回内容-&gt;web服务器-&gt;负载均衡-&gt;用户<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"1-2-运维视角\"><a href=\"#1-2-运维视角\" class=\"headerlink\" title=\"1.2 运维视角\"></a>1.2 运维视角</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.用户通过公网连接（隧道）VPN服务器，这样方便管理内部主机，\n2.自动化配置管理，节省人力成本，便于后期维护。统一环境，标准化\n3.自动化监控服务，监控系统的运行状态，事前预警，事后追溯。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-架构环境规划\"><a href=\"#2-架构环境规划\" class=\"headerlink\" title=\"2 架构环境规划\"></a>2 架构环境规划</h3><h4 id=\"2-1-IP分配\"><a href=\"#2-1-IP分配\" class=\"headerlink\" title=\"2.1 IP分配\"></a>2.1 IP分配</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"> wanip         lanip       hostname\n10.0.0.5     172.16.1.5     lb01\n10.0.0.6     172.16.1.6     lb02\n10.0.0.7     172.16.1.7     web01\n10.0.0.8     172.16.1.8     web02\n10.0.0.9     172.16.1.9     web03\n10.0.0.31    172.16.1.31    nfs\n10.0.0.41    172.16.1.41    backup\n10.0.0.51    172.16.1.51    db01\n10.0.0.61    172.16.1.61    m01\n10.0.0.71    172.16.1.71    zabbix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-基础环境准备\"><a href=\"#2-2-基础环境准备\" class=\"headerlink\" title=\"2.2 基础环境准备\"></a>2.2 基础环境准备</h4><h5 id=\"2-2-1-虚拟机系统和网卡准备\"><a href=\"#2-2-1-虚拟机系统和网卡准备\" class=\"headerlink\" title=\"2.2.1 虚拟机系统和网卡准备\"></a>2.2.1 虚拟机系统和网卡准备</h5><blockquote>\n<p>安装全新Centos7系统，配置网卡为eth0及eth1命名模式<br>1.第一块网卡为NAT模式[公网环境]，配置的网段为10.0.0.0网段<br>2.第二块网卡为LAN模式[私网环境]，配置的网段为172.16.1.0网段<br>3.优化安装好的Centos7虚拟机，安装常用软件、关闭防火墙等等</p>\n</blockquote>\n<p>优化步骤</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1.配置yum仓库\nrm -f &#x2F;etc&#x2F;yum.repos.d&#x2F;*\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\n\n# 2.安装基础软件包\nyum install net-tools vim tree htop iftop \\\niotop lrzsz sl wget unzip telnet nmap nc psmisc \\\ndos2unix bash-completion bash-completion-extra sysstat \\\nrsync nfs-utils httpd-tools -y\n\n# 3.关闭防火墙firewalld\nsystemctl disable firewalld\nsystemctl stop firewalld\n\n# 4.关闭selinux\nsed -i &#39;&#x2F;^SELINUX&#x3D;&#x2F;c SELINUX&#x3D;disabled&#39; &#x2F;etc&#x2F;selinux&#x2F;config\n\n# 5.调整单个进程最大能打开文件的数量\necho &#39;* - nofile 65535&#39; &gt;&gt; &#x2F;etc&#x2F;security&#x2F;limits.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>基于优化后的虚拟机进行克隆</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.连接克隆（需要依赖于母体）\n2.完整克隆（完完全全的复制一份，占用磁盘空间）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>对新克隆的主机进行如下操作：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1.修改主机名  \nhostnamectl set-hostname backup\n\n# 2.修改IP地址  \nsed -i &#39;s#200#41#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eth[01]\n\n# 3.重启服务器<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n"},{"title":"运维之综合架构--03-NFS服务器搭建","date":"2022-07-06T03:19:52.000Z","_content":"\n- 学习笔记\n---\n\n## 一、NFS简介\n\n>NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。\n>NFS系统和Windows网络共享、网络驱动器类似, 只不过windows用于局域网, NFS用于企业集群架构中\n>如果是大型网站, 会用到更复杂的分布式文件系统FastDFS（音频、小说、视频）,glusterfs（iso镜像）,HDFS\n>NFS（图片、）解决共享前端web共享\n\n### 1.1 NFS有什么用？\n\n解决前端web静态资源的共享\n解决前端web静态资源一致性\n解决前端web磁盘空间的浪费\n\n### 1.2 NFS的文件操作方式\n\n1.当用户执行mkdir命令, 该命令会调用shell解释器翻译给内核。\n2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。\n\n### 1.3 NFS的实现原理\n\n1.用户进程访问NFS客户端，使用不同的函数对数据进行处理\n2.NFS客户端通过TCP/IP的方式传递给NFS服务端。\n3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。\n4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。\n5.Rpc.mount进程判断客户端是否有对应的权限进行验证。\n6.idmap进程实现用户映射和压缩\n7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。\n注意: rpc是一个远程过程调用，那么使用nfs必须有rpc服务\n\n### 1.4 NFS的优缺点\n\n优点\n\n```shell\n1.NFS文件系统简单易用、方便部署、数据可靠、服务稳定、满足中小企业需求。\n2.NFS文件系统内存放的数据都在文件系统之上，所有数据都是能看得见。\n```\n\n缺点\n\n```shell\n1.存在单点故障, 如果构建高可用维护麻烦\nweb->nfs(sersync)->backup\n2.NFS数据明文, 并不对数据做任何校验。\n3.客户端挂载NFS服务没有密码验证, 安全性一般(内网使用)\n```\n\n>3.NFS应用建议\n>1.生产场景应将静态数据尽可能往前端推, 减少后端存储压力\n>2.必须将存储里的静态资源通过CDN缓存jpg\\png\\mp4\\avi\\css\\js\n>3.如果没有缓存或架构本身历史遗留问题太大, 在多存储也无用\n\n## 二、NFS部署\n\n### 2.1 服务端\n\n安装\n\n```shell\n[root@nfs ~]# yum install nfs-utils -y\n```\n\n配置\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(rw,sync,all_squash)\n```\n\n授权\n\n```shell\n[root@nfs ~]# mkdir /data\n[root@nfs ~]# chown -R nfsnobody.nfsnobody /data/\n```\n\n启动服务\n\n```shell\n[root@nfs ~]# systemctl start nfs-server\n[root@nfs ~]# systemctl enable nfs-server\n```\n\n检查\n\n```shell\n[root@nfs ~]# cat /var/lib/nfs/etab \n/data\t172.16.1.0/24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash)\n```\n\n### 2.2 客户端\n\n安装\n\n```shell\n[root@nfs ~]# yum install nfs-utils -y\n```\n\n检查nfs是否有共享内容\n\n```shell\n[root@web01 ~]# showmount -e 172.16.1.31\nExport list for 172.16.1.31:\t\n/data 172.16.1.0/24\n```\n\n挂载nfs目录（临时）\n\n```shell\n[root@web01 ~]# mount -t nfs 172.16.1.31:/data /opt\n[root@web01 ~]# df -h\nFilesystem         Size  Used Avail Use% Mounted on\n172.16.1.31:/data   99G  1.8G   98G   2% /opt\n```\n\n挂载nfs目录（永久）\n\n```shell\n[root@web01 ~]# vim /etc/fstab \n172.16.1.31:/data  /opt  nfs  defaults  0  0\n[root@web01 ~]# mount -a   #验证fstab开机启动是否填写错误。\n```\n\n### 2.3 NFS配置参数说明\n\n```shell\nro\t\t\t\t只读权限\nroot_squash\t\t当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash\t当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)\nno_all_squash\t无论NFS客户端使用什么账户访问，都不进行压缩\nasync\t\t\t优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\n\nrw*\t\t\t\t读写权限\nsync*\t\t\t同时将数据写入到内存与硬盘中，保证不丢失数据\nall_squash*\t\t无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nanonuid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\n```\n\n### 2.4 验证ro权限\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(ro,sync,all_squash)\n[root@nfs ~]# systemctl restart nfs-server\n\n[root@web01 ~]# touch /opt/ttt\ntouch: cannot touch ‘/opt/ttt’: Read-only file system\t\t#通常这样的错误都是设定的ro权限导致\n```\n\n### 2.5 验证all_squash、anonuid、anongid权限\n\n服务端\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n创建用户\n[root@nfs ~]# groupadd -g 666 www\n[root@nfs ~]# useradd -u666 -g666 www\n[root@nfs ~]# id www\nuid=666(www) gid=666(www) groups=666(www)\n授权\n[root@nfs ~]# chown -R www.www /data/\n重启\n[root@nfs ~]# systemctl restart nfs-server\n```\n\n客户端重新挂载验证\n\n```shell\n[root@web01 opt]# touch file\n[root@web01 opt]# touch test\n[root@web01 opt]# ll\ntotal 4\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 file\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 test\n```\n\n>PS:由于客户端没有创建id为666的www用户，因此看到的属组和属主都是666\n\n客户端如果觉得666不好看，建议在客户端上创建同名的用户以及uid\n\n```shell\n[root@web01 ~]# groupadd -g 666 www\n[root@web01 ~]# useradd -u 666 -g 666 www\n[root@web01 ~]# id www\nuid=666(www) gid=666(www) groups=666(www)\n[root@web01 ~]# ll /opt/\ntotal 4\n-rw-r--r-- 1 www www 0 Jan  7 11:29 file\n-rw-r--r-- 1 www www 0 Jan  7 11:29 test\n```\n\n","source":"_posts/01_运维/02-综合架构/03-NFS服务搭建.md","raw":"---\ntitle: 运维之综合架构--03-NFS服务器搭建\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n- 学习笔记\n---\n\n## 一、NFS简介\n\n>NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。\n>NFS系统和Windows网络共享、网络驱动器类似, 只不过windows用于局域网, NFS用于企业集群架构中\n>如果是大型网站, 会用到更复杂的分布式文件系统FastDFS（音频、小说、视频）,glusterfs（iso镜像）,HDFS\n>NFS（图片、）解决共享前端web共享\n\n### 1.1 NFS有什么用？\n\n解决前端web静态资源的共享\n解决前端web静态资源一致性\n解决前端web磁盘空间的浪费\n\n### 1.2 NFS的文件操作方式\n\n1.当用户执行mkdir命令, 该命令会调用shell解释器翻译给内核。\n2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。\n\n### 1.3 NFS的实现原理\n\n1.用户进程访问NFS客户端，使用不同的函数对数据进行处理\n2.NFS客户端通过TCP/IP的方式传递给NFS服务端。\n3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。\n4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。\n5.Rpc.mount进程判断客户端是否有对应的权限进行验证。\n6.idmap进程实现用户映射和压缩\n7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。\n注意: rpc是一个远程过程调用，那么使用nfs必须有rpc服务\n\n### 1.4 NFS的优缺点\n\n优点\n\n```shell\n1.NFS文件系统简单易用、方便部署、数据可靠、服务稳定、满足中小企业需求。\n2.NFS文件系统内存放的数据都在文件系统之上，所有数据都是能看得见。\n```\n\n缺点\n\n```shell\n1.存在单点故障, 如果构建高可用维护麻烦\nweb->nfs(sersync)->backup\n2.NFS数据明文, 并不对数据做任何校验。\n3.客户端挂载NFS服务没有密码验证, 安全性一般(内网使用)\n```\n\n>3.NFS应用建议\n>1.生产场景应将静态数据尽可能往前端推, 减少后端存储压力\n>2.必须将存储里的静态资源通过CDN缓存jpg\\png\\mp4\\avi\\css\\js\n>3.如果没有缓存或架构本身历史遗留问题太大, 在多存储也无用\n\n## 二、NFS部署\n\n### 2.1 服务端\n\n安装\n\n```shell\n[root@nfs ~]# yum install nfs-utils -y\n```\n\n配置\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(rw,sync,all_squash)\n```\n\n授权\n\n```shell\n[root@nfs ~]# mkdir /data\n[root@nfs ~]# chown -R nfsnobody.nfsnobody /data/\n```\n\n启动服务\n\n```shell\n[root@nfs ~]# systemctl start nfs-server\n[root@nfs ~]# systemctl enable nfs-server\n```\n\n检查\n\n```shell\n[root@nfs ~]# cat /var/lib/nfs/etab \n/data\t172.16.1.0/24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid=65534,anongid=65534,sec=sys,rw,secure,root_squash,all_squash)\n```\n\n### 2.2 客户端\n\n安装\n\n```shell\n[root@nfs ~]# yum install nfs-utils -y\n```\n\n检查nfs是否有共享内容\n\n```shell\n[root@web01 ~]# showmount -e 172.16.1.31\nExport list for 172.16.1.31:\t\n/data 172.16.1.0/24\n```\n\n挂载nfs目录（临时）\n\n```shell\n[root@web01 ~]# mount -t nfs 172.16.1.31:/data /opt\n[root@web01 ~]# df -h\nFilesystem         Size  Used Avail Use% Mounted on\n172.16.1.31:/data   99G  1.8G   98G   2% /opt\n```\n\n挂载nfs目录（永久）\n\n```shell\n[root@web01 ~]# vim /etc/fstab \n172.16.1.31:/data  /opt  nfs  defaults  0  0\n[root@web01 ~]# mount -a   #验证fstab开机启动是否填写错误。\n```\n\n### 2.3 NFS配置参数说明\n\n```shell\nro\t\t\t\t只读权限\nroot_squash\t\t当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash\t当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)\nno_all_squash\t无论NFS客户端使用什么账户访问，都不进行压缩\nasync\t\t\t优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\n\nrw*\t\t\t\t读写权限\nsync*\t\t\t同时将数据写入到内存与硬盘中，保证不丢失数据\nall_squash*\t\t无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nanonuid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\n```\n\n### 2.4 验证ro权限\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(ro,sync,all_squash)\n[root@nfs ~]# systemctl restart nfs-server\n\n[root@web01 ~]# touch /opt/ttt\ntouch: cannot touch ‘/opt/ttt’: Read-only file system\t\t#通常这样的错误都是设定的ro权限导致\n```\n\n### 2.5 验证all_squash、anonuid、anongid权限\n\n服务端\n\n```shell\n[root@nfs ~]# cat /etc/exports\n/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n创建用户\n[root@nfs ~]# groupadd -g 666 www\n[root@nfs ~]# useradd -u666 -g666 www\n[root@nfs ~]# id www\nuid=666(www) gid=666(www) groups=666(www)\n授权\n[root@nfs ~]# chown -R www.www /data/\n重启\n[root@nfs ~]# systemctl restart nfs-server\n```\n\n客户端重新挂载验证\n\n```shell\n[root@web01 opt]# touch file\n[root@web01 opt]# touch test\n[root@web01 opt]# ll\ntotal 4\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 file\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 test\n```\n\n>PS:由于客户端没有创建id为666的www用户，因此看到的属组和属主都是666\n\n客户端如果觉得666不好看，建议在客户端上创建同名的用户以及uid\n\n```shell\n[root@web01 ~]# groupadd -g 666 www\n[root@web01 ~]# useradd -u 666 -g 666 www\n[root@web01 ~]# id www\nuid=666(www) gid=666(www) groups=666(www)\n[root@web01 ~]# ll /opt/\ntotal 4\n-rw-r--r-- 1 www www 0 Jan  7 11:29 file\n-rw-r--r-- 1 www www 0 Jan  7 11:29 test\n```\n\n","slug":"01_运维/02-综合架构/03-NFS服务搭建","published":1,"updated":"2022-07-06T07:15:48.532Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0b000ia8v712mqhhxd","content":"<ul>\n<li>学习笔记</li>\n</ul>\n<hr>\n<h2 id=\"一、NFS简介\"><a href=\"#一、NFS简介\" class=\"headerlink\" title=\"一、NFS简介\"></a>一、NFS简介</h2><blockquote>\n<p>NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。<br>NFS系统和Windows网络共享、网络驱动器类似, 只不过windows用于局域网, NFS用于企业集群架构中<br>如果是大型网站, 会用到更复杂的分布式文件系统FastDFS（音频、小说、视频）,glusterfs（iso镜像）,HDFS<br>NFS（图片、）解决共享前端web共享</p>\n</blockquote>\n<h3 id=\"1-1-NFS有什么用？\"><a href=\"#1-1-NFS有什么用？\" class=\"headerlink\" title=\"1.1 NFS有什么用？\"></a>1.1 NFS有什么用？</h3><p>解决前端web静态资源的共享<br>解决前端web静态资源一致性<br>解决前端web磁盘空间的浪费</p>\n<h3 id=\"1-2-NFS的文件操作方式\"><a href=\"#1-2-NFS的文件操作方式\" class=\"headerlink\" title=\"1.2 NFS的文件操作方式\"></a>1.2 NFS的文件操作方式</h3><p>1.当用户执行mkdir命令, 该命令会调用shell解释器翻译给内核。<br>2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。</p>\n<h3 id=\"1-3-NFS的实现原理\"><a href=\"#1-3-NFS的实现原理\" class=\"headerlink\" title=\"1.3 NFS的实现原理\"></a>1.3 NFS的实现原理</h3><p>1.用户进程访问NFS客户端，使用不同的函数对数据进行处理<br>2.NFS客户端通过TCP&#x2F;IP的方式传递给NFS服务端。<br>3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。<br>4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。<br>5.Rpc.mount进程判断客户端是否有对应的权限进行验证。<br>6.idmap进程实现用户映射和压缩<br>7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。<br>注意: rpc是一个远程过程调用，那么使用nfs必须有rpc服务</p>\n<h3 id=\"1-4-NFS的优缺点\"><a href=\"#1-4-NFS的优缺点\" class=\"headerlink\" title=\"1.4 NFS的优缺点\"></a>1.4 NFS的优缺点</h3><p>优点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.NFS文件系统简单易用、方便部署、数据可靠、服务稳定、满足中小企业需求。\n2.NFS文件系统内存放的数据都在文件系统之上，所有数据都是能看得见。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>缺点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.存在单点故障, 如果构建高可用维护麻烦\nweb-&gt;nfs(sersync)-&gt;backup\n2.NFS数据明文, 并不对数据做任何校验。\n3.客户端挂载NFS服务没有密码验证, 安全性一般(内网使用)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>3.NFS应用建议<br>1.生产场景应将静态数据尽可能往前端推, 减少后端存储压力<br>2.必须将存储里的静态资源通过CDN缓存jpg\\png\\mp4\\avi\\css\\js<br>3.如果没有缓存或架构本身历史遗留问题太大, 在多存储也无用</p>\n</blockquote>\n<h2 id=\"二、NFS部署\"><a href=\"#二、NFS部署\" class=\"headerlink\" title=\"二、NFS部署\"></a>二、NFS部署</h2><h3 id=\"2-1-服务端\"><a href=\"#2-1-服务端\" class=\"headerlink\" title=\"2.1 服务端\"></a>2.1 服务端</h3><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# mkdir &#x2F;data\n[root@nfs ~]# chown -R nfsnobody.nfsnobody &#x2F;data&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# systemctl start nfs-server\n[root@nfs ~]# systemctl enable nfs-server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>检查</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;var&#x2F;lib&#x2F;nfs&#x2F;etab \n&#x2F;data\t172.16.1.0&#x2F;24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid&#x3D;65534,anongid&#x3D;65534,sec&#x3D;sys,rw,secure,root_squash,all_squash)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-客户端\"><a href=\"#2-2-客户端\" class=\"headerlink\" title=\"2.2 客户端\"></a>2.2 客户端</h3><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>检查nfs是否有共享内容</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# showmount -e 172.16.1.31\nExport list for 172.16.1.31:\t\n&#x2F;data 172.16.1.0&#x2F;24<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载nfs目录（临时）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;opt\n[root@web01 ~]# df -h\nFilesystem         Size  Used Avail Use% Mounted on\n172.16.1.31:&#x2F;data   99G  1.8G   98G   2% &#x2F;opt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载nfs目录（永久）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# vim &#x2F;etc&#x2F;fstab \n172.16.1.31:&#x2F;data  &#x2F;opt  nfs  defaults  0  0\n[root@web01 ~]# mount -a   #验证fstab开机启动是否填写错误。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-NFS配置参数说明\"><a href=\"#2-3-NFS配置参数说明\" class=\"headerlink\" title=\"2.3 NFS配置参数说明\"></a>2.3 NFS配置参数说明</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ro\t\t\t\t只读权限\nroot_squash\t\t当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash\t当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)\nno_all_squash\t无论NFS客户端使用什么账户访问，都不进行压缩\nasync\t\t\t优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\n\nrw*\t\t\t\t读写权限\nsync*\t\t\t同时将数据写入到内存与硬盘中，保证不丢失数据\nall_squash*\t\t无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nanonuid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-验证ro权限\"><a href=\"#2-4-验证ro权限\" class=\"headerlink\" title=\"2.4 验证ro权限\"></a>2.4 验证ro权限</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(ro,sync,all_squash)\n[root@nfs ~]# systemctl restart nfs-server\n\n[root@web01 ~]# touch &#x2F;opt&#x2F;ttt\ntouch: cannot touch ‘&#x2F;opt&#x2F;ttt’: Read-only file system\t\t#通常这样的错误都是设定的ro权限导致<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-验证all-squash、anonuid、anongid权限\"><a href=\"#2-5-验证all-squash、anonuid、anongid权限\" class=\"headerlink\" title=\"2.5 验证all_squash、anonuid、anongid权限\"></a>2.5 验证all_squash、anonuid、anongid权限</h3><p>服务端</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n创建用户\n[root@nfs ~]# groupadd -g 666 www\n[root@nfs ~]# useradd -u666 -g666 www\n[root@nfs ~]# id www\nuid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)\n授权\n[root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n重启\n[root@nfs ~]# systemctl restart nfs-server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>客户端重新挂载验证</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 opt]# touch file\n[root@web01 opt]# touch test\n[root@web01 opt]# ll\ntotal 4\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 file\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 test<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS:由于客户端没有创建id为666的www用户，因此看到的属组和属主都是666</p>\n</blockquote>\n<p>客户端如果觉得666不好看，建议在客户端上创建同名的用户以及uid</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# groupadd -g 666 www\n[root@web01 ~]# useradd -u 666 -g 666 www\n[root@web01 ~]# id www\nuid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)\n[root@web01 ~]# ll &#x2F;opt&#x2F;\ntotal 4\n-rw-r--r-- 1 www www 0 Jan  7 11:29 file\n-rw-r--r-- 1 www www 0 Jan  7 11:29 test<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<ul>\n<li>学习笔记</li>\n</ul>\n<hr>\n<h2 id=\"一、NFS简介\"><a href=\"#一、NFS简介\" class=\"headerlink\" title=\"一、NFS简介\"></a>一、NFS简介</h2><blockquote>\n<p>NFS是Network File System的缩写及网络文件系统。NFS主要功能是通过局域网络让不同的主机系统之间可以共享文件或目录。<br>NFS系统和Windows网络共享、网络驱动器类似, 只不过windows用于局域网, NFS用于企业集群架构中<br>如果是大型网站, 会用到更复杂的分布式文件系统FastDFS（音频、小说、视频）,glusterfs（iso镜像）,HDFS<br>NFS（图片、）解决共享前端web共享</p>\n</blockquote>\n<h3 id=\"1-1-NFS有什么用？\"><a href=\"#1-1-NFS有什么用？\" class=\"headerlink\" title=\"1.1 NFS有什么用？\"></a>1.1 NFS有什么用？</h3><p>解决前端web静态资源的共享<br>解决前端web静态资源一致性<br>解决前端web磁盘空间的浪费</p>\n<h3 id=\"1-2-NFS的文件操作方式\"><a href=\"#1-2-NFS的文件操作方式\" class=\"headerlink\" title=\"1.2 NFS的文件操作方式\"></a>1.2 NFS的文件操作方式</h3><p>1.当用户执行mkdir命令, 该命令会调用shell解释器翻译给内核。<br>2.内核解析完成后会驱动对应的硬件设备，完成相应的操作。</p>\n<h3 id=\"1-3-NFS的实现原理\"><a href=\"#1-3-NFS的实现原理\" class=\"headerlink\" title=\"1.3 NFS的实现原理\"></a>1.3 NFS的实现原理</h3><p>1.用户进程访问NFS客户端，使用不同的函数对数据进行处理<br>2.NFS客户端通过TCP&#x2F;IP的方式传递给NFS服务端。<br>3.NFS服务端接收到请求后，会先调用portmap进程进行端口映射。<br>4.nfsd进程用于判断NFS客户端是否拥有权限连接NFS服务端。<br>5.Rpc.mount进程判断客户端是否有对应的权限进行验证。<br>6.idmap进程实现用户映射和压缩<br>7.最后NFS服务端会将对应请求的函数转换为本地能识别的命令，传递至内核，由内核驱动硬件。<br>注意: rpc是一个远程过程调用，那么使用nfs必须有rpc服务</p>\n<h3 id=\"1-4-NFS的优缺点\"><a href=\"#1-4-NFS的优缺点\" class=\"headerlink\" title=\"1.4 NFS的优缺点\"></a>1.4 NFS的优缺点</h3><p>优点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.NFS文件系统简单易用、方便部署、数据可靠、服务稳定、满足中小企业需求。\n2.NFS文件系统内存放的数据都在文件系统之上，所有数据都是能看得见。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>缺点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.存在单点故障, 如果构建高可用维护麻烦\nweb-&gt;nfs(sersync)-&gt;backup\n2.NFS数据明文, 并不对数据做任何校验。\n3.客户端挂载NFS服务没有密码验证, 安全性一般(内网使用)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>3.NFS应用建议<br>1.生产场景应将静态数据尽可能往前端推, 减少后端存储压力<br>2.必须将存储里的静态资源通过CDN缓存jpg\\png\\mp4\\avi\\css\\js<br>3.如果没有缓存或架构本身历史遗留问题太大, 在多存储也无用</p>\n</blockquote>\n<h2 id=\"二、NFS部署\"><a href=\"#二、NFS部署\" class=\"headerlink\" title=\"二、NFS部署\"></a>二、NFS部署</h2><h3 id=\"2-1-服务端\"><a href=\"#2-1-服务端\" class=\"headerlink\" title=\"2.1 服务端\"></a>2.1 服务端</h3><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# mkdir &#x2F;data\n[root@nfs ~]# chown -R nfsnobody.nfsnobody &#x2F;data&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# systemctl start nfs-server\n[root@nfs ~]# systemctl enable nfs-server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>检查</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;var&#x2F;lib&#x2F;nfs&#x2F;etab \n&#x2F;data\t172.16.1.0&#x2F;24(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,all_squash,no_subtree_check,secure_locks,acl,no_pnfs,anonuid&#x3D;65534,anongid&#x3D;65534,sec&#x3D;sys,rw,secure,root_squash,all_squash)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-客户端\"><a href=\"#2-2-客户端\" class=\"headerlink\" title=\"2.2 客户端\"></a>2.2 客户端</h3><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# yum install nfs-utils -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>检查nfs是否有共享内容</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# showmount -e 172.16.1.31\nExport list for 172.16.1.31:\t\n&#x2F;data 172.16.1.0&#x2F;24<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载nfs目录（临时）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;opt\n[root@web01 ~]# df -h\nFilesystem         Size  Used Avail Use% Mounted on\n172.16.1.31:&#x2F;data   99G  1.8G   98G   2% &#x2F;opt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载nfs目录（永久）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# vim &#x2F;etc&#x2F;fstab \n172.16.1.31:&#x2F;data  &#x2F;opt  nfs  defaults  0  0\n[root@web01 ~]# mount -a   #验证fstab开机启动是否填写错误。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-NFS配置参数说明\"><a href=\"#2-3-NFS配置参数说明\" class=\"headerlink\" title=\"2.3 NFS配置参数说明\"></a>2.3 NFS配置参数说明</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ro\t\t\t\t只读权限\nroot_squash\t\t当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户(不常用)\nno_root_squash\t当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员(不常用)\nno_all_squash\t无论NFS客户端使用什么账户访问，都不进行压缩\nasync\t\t\t优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据\n\nrw*\t\t\t\t读写权限\nsync*\t\t\t同时将数据写入到内存与硬盘中，保证不丢失数据\nall_squash*\t\t无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户(常用)\nanonuid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统\nanongid*\t\t配置all_squash使用,指定NFS的用户UID,必须存在系统<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-验证ro权限\"><a href=\"#2-4-验证ro权限\" class=\"headerlink\" title=\"2.4 验证ro权限\"></a>2.4 验证ro权限</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(ro,sync,all_squash)\n[root@nfs ~]# systemctl restart nfs-server\n\n[root@web01 ~]# touch &#x2F;opt&#x2F;ttt\ntouch: cannot touch ‘&#x2F;opt&#x2F;ttt’: Read-only file system\t\t#通常这样的错误都是设定的ro权限导致<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-验证all-squash、anonuid、anongid权限\"><a href=\"#2-5-验证all-squash、anonuid、anongid权限\" class=\"headerlink\" title=\"2.5 验证all_squash、anonuid、anongid权限\"></a>2.5 验证all_squash、anonuid、anongid权限</h3><p>服务端</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n创建用户\n[root@nfs ~]# groupadd -g 666 www\n[root@nfs ~]# useradd -u666 -g666 www\n[root@nfs ~]# id www\nuid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)\n授权\n[root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n重启\n[root@nfs ~]# systemctl restart nfs-server<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>客户端重新挂载验证</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 opt]# touch file\n[root@web01 opt]# touch test\n[root@web01 opt]# ll\ntotal 4\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 file\n-rw-r--r-- 1 666 666 0 Jan  7 11:29 test<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS:由于客户端没有创建id为666的www用户，因此看到的属组和属主都是666</p>\n</blockquote>\n<p>客户端如果觉得666不好看，建议在客户端上创建同名的用户以及uid</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# groupadd -g 666 www\n[root@web01 ~]# useradd -u 666 -g 666 www\n[root@web01 ~]# id www\nuid&#x3D;666(www) gid&#x3D;666(www) groups&#x3D;666(www)\n[root@web01 ~]# ll &#x2F;opt&#x2F;\ntotal 4\n-rw-r--r-- 1 www www 0 Jan  7 11:29 file\n-rw-r--r-- 1 www www 0 Jan  7 11:29 test<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--02--Rsync服务器搭建","date":"2022-07-06T03:19:52.000Z","_content":"\n## 二、Rsync与数据备份\n\n### 2.1  备份概念\n\n为什么要做备份？\n\n```shell\n数据非常的重要\n保证数据不丢失\n便于快速的恢复\n```\n\n备份方式\n\n```shell\n完全备份，每次都进行全部备份 (效率低下, 占用空间)\n增量备份，仅备份客户端与服务端差异的部分 (提高备份效率,节省空间, 适合异地备份 )\n```\n\n用什么工具做备份？\n\n```shell\nscp  \t网络之间的拷贝，全量拷贝的方式  （ssh协议）\nrsync\t远程同步（增量）\n```\n\n### 2.2 rsync的基本概念\n\n>rsync是一款开源的备份工具，\n>\t可以在不同主机之间进行同步（windows和Linux之间   Mac和Linux   Linux和Linux）\n>\t可实现全量备份与增量备份\n>\t因此非常适合用于架构集中式备份或异地备份等应用\n\nrsync数据的同步模式\n\n```shell\n推送： 本地将数据上传至备份服务器上\t （上传）\n拉取： 备份服务器获取本地服务器的数据  （下载）\n```\n\nrsync的数据传输方式\n\n```shell\n本地传输（类似于使用cp命令）\n远程传输（通过网络传输  a-->b）\n守护进程（运行一个服务一直在后台）\n```\n\nrsync选项详解\n\n```shell\nrsync参数:\n-a           #归档模式传输, 等于-tropgDl *\n-v           #详细模式输出, 打印速率, 文件数量等 *\n-z           #传输时进行压缩以提高效率 *\n-r           #递归传输目录及子目录，即目录下得所有目录都同样传输。\n-t           #保持文件时间信息\n-o           #保持文件属主信息\n-p           #保持文件权限\n-g           #保持文件属组信息\n-l           #保留软连接\n-P           #显示同步的过程及传输时的进度等信息\n-D           #保持设备文件信息\n-L           #保留软连接指向的目标文件\n-e           #使用的信道协议,指定替代rsh的shell程序  ssh\n--exclude=PATTERN   #指定排除不需要传输的文件模式\n--exclude-from=file #文件名所在的目录文件\n--bwlimit=100       #限速传输 *\n--partial           #断点续传\n--delete            #让目标目录和源目录数据保持一致 *\n```\n\n### 2.3 本地传输\n\n将/boot文件夹拷贝到/tmp中\n\n```shell\nrsync -avz /boot /tmp/\n```\n\n将boot文件夹中的内容拷贝到/tmp中\n\n```shell\nrsync -avz /boot/ /tmp/\n```\n\n### 2.3 远程传输\n\n虚拟机准备\n\n| 主机名 | IP地址                         |\n| ------ | ------------------------------ |\n| nfs    | 172.16.1.31/24 和 10.0.0.31/24 |\n| backup | 172.16.1.41/24 和 10.0.0.41/24 |\n\nbackup从nfs拉取/boo目录到本地/tmp文件夹\n\n```she\nrsync -avz root@10.0.0.31:/boot /tmp\n```\n\nbackup上传/root/test.txt到nfs主机的/tmp文件夹中\n\n```shell\nrsync /root/test.txt root@10.0.0.31:/tmp\n```\n\n### 2.4 守护进程传输（服务搭建）\n\n>为什么需要使用rsync守护进程传输？\n>\n>\tRsync借助SSH协议同步数据存在的缺陷（临时发送数据）\n>\t\t1.使用系统用户（不安全）\n>\t\t2.使用普通用户（会导致权限不足情况）\n\nbackup充当rsync服务端，nfs充当客户端，配置步骤：\n\n#### 2.4.1 服务端配置\n\n获取配置文件路径\n\n```shell\n[root@backup ~]# rpm -qc rsync\n\t/etc/rsyncd.conf\t\t\t# 主配置文件\n\t/etc/sysconfig/rsyncd\t\t# 选项\n```\n\n编辑配置文件\n\n```shell\nvim /etc/rsyncd.conf\n---------------------\nuid = rsync\ngid = rsync\nport = 873\nfake super = yes\nuse chroot = no\nmax connections = 200\ntimeout = 600\nignore errors\nread only = false\nlist = false\nauth users = rsync_backup\nsecrets file = /etc/rsync.passwd\nlog file = /var/log/rsyncd.log\n#####################################\n[backup]\ncomment = welcome to oldboyedu backup!\npath = /backup\n```\n\n配置详细解析\n\n```shell\nuid = rsync                      # 运行进程的用户\ngid = rsync                      # 运行进程的用户组\nport = 873                       # 监听端口\nfake super = yes                 # 无需让rsync以root身份运行，允许接收文件的完整属性\nuse chroot = no                  # 禁锢推送的数据至某个目录, 不允许跳出该目录\nmax connections = 200            # 最大连接数\ntimeout = 600                    # 超时时间\nignore errors                    # 忽略错误信息\nread only = false                # 对备份数据可读写\nlist = false                     # 不允许查看模块信息\nauth users = rsync_backup        # 定义虚拟用户，作为连接认证用户\nsecrets file = /etc/rsync.passwd # 定义rsync服务用户连接认证密码文件路径\nlog file = /var/log/rsyncd.log   # 日志文件\n#####################################\n[backup]                # 定义模块信息\ncomment = commit        # 模块注释信息\npath = /backup          # 定义接收备份数据目录\n```\n\n创建rsync进程启动时需要使用的用户\n\n```shell\n[root@backup ~]# useradd rsync -M -s /sbin/nologin \n[root@backup ~]# id rsync\nuid=1000(rsync) gid=1000(rsync) groups=1000(rsync)\n```\n\n创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码\n\n```shell\n/etc/rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码\n[root@backup ~]# echo \"rsync_backup:123456\" > /etc/rsync.passwd\n[root@backup ~]# chmod 600 /etc/rsync.passwd \n```\n\n创建存储备份数据的目录，并进行授权\n\n```shell\n[root@backup ~]# mkdir /backup\n[root@backup ~]# chown -R rsync.rsync /backup/\n```\n\n启动rsync服务并加入开机自启动\n\n```shell\n[root@backup ~]# systemctl start rsyncd.service \n[root@backup ~]# systemctl enable rsyncd\n```\n\n检查rsync的873端口是否存在\n\n```shell\n[root@backup ~]# netstat -lntup\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp6       0      0 :::873                  :::*                    LISTEN      1269/rsync\n```\n\n#### 2.4.2 客户端测试\n\n推送/etc文件夹到服务端/backup\n\n```shell\nrsync -avz /etc/ rsync_backup@172.16.1.41::backup\n需要输入密码\n```\n\n从服务端/backup拉取文件到/tmp\n\n```shell\nrsync -avz rsync_backup@172.16.1.41::backup /tmp\n需要输入密码\n```\n\n### 2.5 rsync补充\n\n#### 2.5.1 无差异同步(慎用)\n\n```shell\n#推送方式实现无差异，以客户端为准，客户端有什么服务端就有什么\n[root@nfs ~]# rsync -avz --delete /root rsync_backup@172.16.1.41::backup\t\t\n\n#拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么\n[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup /opt/\n```\n\n#### 2.5.2 传输限速\n\n```shell\n# 生成大文件\n[root@nfs ~]# dd if=/dev/zero of=./size.disk bs=1M count=500  \n\n# 限制传输的速率为1MB \n[root@nfs ~]# rsync -avzP --bwlimit=1 ./size.disk rsync_backup@172.16.1.41::backup\nPassword: \nsending incremental file list\nsize.disk\n    118,358,016  22%    1.01MB/s    0:06:33\n```\n\n#### 2.5.3 取消每次传输需要输密码\n\n在客户端配置\n\n```shell\n方式一：\n[root@nfs ~]# echo \"123456\" > /etc/rsync.pass\n[root@nfs ~]# chmod 600 /etc/rsync.pass #上该文件找123456\n[root@nfs ~]# rsync -avzP --bwlimit=1 ./size.disk rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.pass\n\n方式二：写Shell脚本\n[root@nfs ~]# export RSYNC_PASSWORD=123456\n[root@nfs ~]# rsync -avzP ./size.disk rsync_backup@172.16.1.41::backup\n```\n\n## 三、Rsync备份案例\n\n>客户端需求\n>1.客户端提前准备存放的备份的目录，目录规则如下:/backup/nfs_172.16.1.31_2018-09-02 \n>2.客户端在本地打包备份(系统配置文件、应用配置等)拷贝至/backup/nfs_172.16.1.31_2018-09-02\n>3.客户端最后将备份的数据进行推送至备份服务器\n>4.客户端每天凌晨1点定时执行该脚本\n>5.客户端本地保留最近7天的数据, 避免浪费磁盘空间\n>\n>服务端需求\n>1.服务端部署rsync，用于接收客户端推送过来的备份数据\n>2.服务端需要每天校验客户端推送过来的数据是否完整\n>3.服务端需要每天校验的结果通知给管理员\n>4.服务端仅保留6个月的备份数据,其余的全部删除\n>\n>注意：所有服务器的备份目录必须都为/backup\n>\n>1.客户端将需要备份的文件放入指定的目录中   /backup/nfs_172.16.1.31_2018-09-02\n>2.客户端每天凌晨1点使用rsync命令推送一次nfs_172.16.1.31_2018-09-0\n>3.客户端保留最近7天的数据即可\n\n### 3.1 需求分析\n\n>1.我要备份什么？\n>\t/etc/fstab /var/spool/cron/USERNAME   /server/scripts\n>\n>2.我要怎么备份？\n>\t/backup/主机名_ip地址_时间  命名的目录中\n>\n>3.我要备份到哪？\n>\trsync备份服务器   172.16.1.41\n\n#### 3.1.1 服务端配置\n\n配置邮件服务\n\n```shell\n[root@backup ~]# yum install mailx -y\n[root@backup ~]# vim /etc/mail.rc\nset from=12345@qq.com\nset smtp=smtps://smtp.qq.com:465\nset smtp-auth-user=12345@qq.com\nset smtp-auth-password=xxxxxx # 授权码\nset smtp-auth=login\nset ssl-verify=ignore\nset nss-config-dir=/etc/pki/nssdb/\n```\n\n脚本编写\n\n```shell\n[root@backup ~]# mkdir /server/scripts -p\n[root@backup ~]# cat /server/scripts/check_client_data.sh\n#!/bin/bash\n#1.定义变量\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\nSRC=/backup\nDATE=$(date +%F)\n\n#1.使用md5进行校验，并保存校验的结果\nmd5sum -c $SRC/*_$DATE/flag_$DATE > $SRC/result_$DATE\n\n#2.将保存的结果文件发送给管理员\nmail -s \"Rsync Backup $DATE\" 572891887@qq.com <$SRC/result_$DATE\n\n#3.保留最近180天的数据\nfind $SRC/ -type d -mtime +180|xargs rm -rf \n```\n\n#### 3.1.2 客户端配置\n\n创建目录\n\n```shell\nmkdir /backup\nmkdir -p /server/scripts/\n```\n\n编写备份脚本\n\n```shell\n[root@nfs ~]# cat /server/scripts/client_push_data.sh\n#!/bin/bash\n#1.定义变量\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\nSRC=/backup\nHOST=$(hostname)\nADDR=$(ifconfig eth1|awk 'NR==2 {print $2}')\nDATE=$(date +%F)\nDEST=${HOST}_${ADDR}_${DATE}\n\n#2.创建目录\n[ -d $SRC/$DEST ] || mkdir -p $SRC/$DEST\n\n#3.备份文件\ncd / && \\\n[ -f $SRC/$DEST/sys.tar.gz ] || tar czf $SRC/$DEST/sys.tar.gz etc/fstab etc/passwd && \\\n[ -f $SRC/$DEST/other.tar.gz ] || tar czf $SRC/$DEST/other.tar.gz var/spool/cron/ server/scripts && \\\n\n#4.使用md5打标记\n[ -f $SRC/$DEST/flag_$DATE ] || md5sum $SRC/$DEST/*.tar.gz  > $SRC/$DEST/flag_$DATE \n\n#4.本地推送到备份服务器\nexport RSYNC_PASSWORD=123456\nrsync -avz $SRC/$DEST rsync_backup@172.16.1.41::backup\n\n#5.保留本地最近7天的数据\nfind $SRC/ -type d -mtime +7|xargs rm -rf \n```\n\n#### 3.1.3 整体测试:设置定时任务\n\n客户端每两分钟备份推送一次\n\n```shell\n[root@nfs backup]# crontab -e\n*/2 * * * * sh /server/scripts/client_push_data.sh\n```\n\n服务端每3分钟校验一次，并发送确认邮件\n\n```shell\n[root@backup scripts]# crontab -e\n*/3 * * * * sh /server/scripts/check_client_data.sh\n```\n\n#### 3.1.5 增加客户端数量\n\n```shell\n多创建几台客户端服务器，测试\n```\n\n","source":"_posts/01_运维/02-综合架构/02-Rsync服务搭建.md","raw":"---\ntitle: 运维之综合架构--02--Rsync服务器搭建\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 二、Rsync与数据备份\n\n### 2.1  备份概念\n\n为什么要做备份？\n\n```shell\n数据非常的重要\n保证数据不丢失\n便于快速的恢复\n```\n\n备份方式\n\n```shell\n完全备份，每次都进行全部备份 (效率低下, 占用空间)\n增量备份，仅备份客户端与服务端差异的部分 (提高备份效率,节省空间, 适合异地备份 )\n```\n\n用什么工具做备份？\n\n```shell\nscp  \t网络之间的拷贝，全量拷贝的方式  （ssh协议）\nrsync\t远程同步（增量）\n```\n\n### 2.2 rsync的基本概念\n\n>rsync是一款开源的备份工具，\n>\t可以在不同主机之间进行同步（windows和Linux之间   Mac和Linux   Linux和Linux）\n>\t可实现全量备份与增量备份\n>\t因此非常适合用于架构集中式备份或异地备份等应用\n\nrsync数据的同步模式\n\n```shell\n推送： 本地将数据上传至备份服务器上\t （上传）\n拉取： 备份服务器获取本地服务器的数据  （下载）\n```\n\nrsync的数据传输方式\n\n```shell\n本地传输（类似于使用cp命令）\n远程传输（通过网络传输  a-->b）\n守护进程（运行一个服务一直在后台）\n```\n\nrsync选项详解\n\n```shell\nrsync参数:\n-a           #归档模式传输, 等于-tropgDl *\n-v           #详细模式输出, 打印速率, 文件数量等 *\n-z           #传输时进行压缩以提高效率 *\n-r           #递归传输目录及子目录，即目录下得所有目录都同样传输。\n-t           #保持文件时间信息\n-o           #保持文件属主信息\n-p           #保持文件权限\n-g           #保持文件属组信息\n-l           #保留软连接\n-P           #显示同步的过程及传输时的进度等信息\n-D           #保持设备文件信息\n-L           #保留软连接指向的目标文件\n-e           #使用的信道协议,指定替代rsh的shell程序  ssh\n--exclude=PATTERN   #指定排除不需要传输的文件模式\n--exclude-from=file #文件名所在的目录文件\n--bwlimit=100       #限速传输 *\n--partial           #断点续传\n--delete            #让目标目录和源目录数据保持一致 *\n```\n\n### 2.3 本地传输\n\n将/boot文件夹拷贝到/tmp中\n\n```shell\nrsync -avz /boot /tmp/\n```\n\n将boot文件夹中的内容拷贝到/tmp中\n\n```shell\nrsync -avz /boot/ /tmp/\n```\n\n### 2.3 远程传输\n\n虚拟机准备\n\n| 主机名 | IP地址                         |\n| ------ | ------------------------------ |\n| nfs    | 172.16.1.31/24 和 10.0.0.31/24 |\n| backup | 172.16.1.41/24 和 10.0.0.41/24 |\n\nbackup从nfs拉取/boo目录到本地/tmp文件夹\n\n```she\nrsync -avz root@10.0.0.31:/boot /tmp\n```\n\nbackup上传/root/test.txt到nfs主机的/tmp文件夹中\n\n```shell\nrsync /root/test.txt root@10.0.0.31:/tmp\n```\n\n### 2.4 守护进程传输（服务搭建）\n\n>为什么需要使用rsync守护进程传输？\n>\n>\tRsync借助SSH协议同步数据存在的缺陷（临时发送数据）\n>\t\t1.使用系统用户（不安全）\n>\t\t2.使用普通用户（会导致权限不足情况）\n\nbackup充当rsync服务端，nfs充当客户端，配置步骤：\n\n#### 2.4.1 服务端配置\n\n获取配置文件路径\n\n```shell\n[root@backup ~]# rpm -qc rsync\n\t/etc/rsyncd.conf\t\t\t# 主配置文件\n\t/etc/sysconfig/rsyncd\t\t# 选项\n```\n\n编辑配置文件\n\n```shell\nvim /etc/rsyncd.conf\n---------------------\nuid = rsync\ngid = rsync\nport = 873\nfake super = yes\nuse chroot = no\nmax connections = 200\ntimeout = 600\nignore errors\nread only = false\nlist = false\nauth users = rsync_backup\nsecrets file = /etc/rsync.passwd\nlog file = /var/log/rsyncd.log\n#####################################\n[backup]\ncomment = welcome to oldboyedu backup!\npath = /backup\n```\n\n配置详细解析\n\n```shell\nuid = rsync                      # 运行进程的用户\ngid = rsync                      # 运行进程的用户组\nport = 873                       # 监听端口\nfake super = yes                 # 无需让rsync以root身份运行，允许接收文件的完整属性\nuse chroot = no                  # 禁锢推送的数据至某个目录, 不允许跳出该目录\nmax connections = 200            # 最大连接数\ntimeout = 600                    # 超时时间\nignore errors                    # 忽略错误信息\nread only = false                # 对备份数据可读写\nlist = false                     # 不允许查看模块信息\nauth users = rsync_backup        # 定义虚拟用户，作为连接认证用户\nsecrets file = /etc/rsync.passwd # 定义rsync服务用户连接认证密码文件路径\nlog file = /var/log/rsyncd.log   # 日志文件\n#####################################\n[backup]                # 定义模块信息\ncomment = commit        # 模块注释信息\npath = /backup          # 定义接收备份数据目录\n```\n\n创建rsync进程启动时需要使用的用户\n\n```shell\n[root@backup ~]# useradd rsync -M -s /sbin/nologin \n[root@backup ~]# id rsync\nuid=1000(rsync) gid=1000(rsync) groups=1000(rsync)\n```\n\n创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码\n\n```shell\n/etc/rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码\n[root@backup ~]# echo \"rsync_backup:123456\" > /etc/rsync.passwd\n[root@backup ~]# chmod 600 /etc/rsync.passwd \n```\n\n创建存储备份数据的目录，并进行授权\n\n```shell\n[root@backup ~]# mkdir /backup\n[root@backup ~]# chown -R rsync.rsync /backup/\n```\n\n启动rsync服务并加入开机自启动\n\n```shell\n[root@backup ~]# systemctl start rsyncd.service \n[root@backup ~]# systemctl enable rsyncd\n```\n\n检查rsync的873端口是否存在\n\n```shell\n[root@backup ~]# netstat -lntup\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp6       0      0 :::873                  :::*                    LISTEN      1269/rsync\n```\n\n#### 2.4.2 客户端测试\n\n推送/etc文件夹到服务端/backup\n\n```shell\nrsync -avz /etc/ rsync_backup@172.16.1.41::backup\n需要输入密码\n```\n\n从服务端/backup拉取文件到/tmp\n\n```shell\nrsync -avz rsync_backup@172.16.1.41::backup /tmp\n需要输入密码\n```\n\n### 2.5 rsync补充\n\n#### 2.5.1 无差异同步(慎用)\n\n```shell\n#推送方式实现无差异，以客户端为准，客户端有什么服务端就有什么\n[root@nfs ~]# rsync -avz --delete /root rsync_backup@172.16.1.41::backup\t\t\n\n#拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么\n[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup /opt/\n```\n\n#### 2.5.2 传输限速\n\n```shell\n# 生成大文件\n[root@nfs ~]# dd if=/dev/zero of=./size.disk bs=1M count=500  \n\n# 限制传输的速率为1MB \n[root@nfs ~]# rsync -avzP --bwlimit=1 ./size.disk rsync_backup@172.16.1.41::backup\nPassword: \nsending incremental file list\nsize.disk\n    118,358,016  22%    1.01MB/s    0:06:33\n```\n\n#### 2.5.3 取消每次传输需要输密码\n\n在客户端配置\n\n```shell\n方式一：\n[root@nfs ~]# echo \"123456\" > /etc/rsync.pass\n[root@nfs ~]# chmod 600 /etc/rsync.pass #上该文件找123456\n[root@nfs ~]# rsync -avzP --bwlimit=1 ./size.disk rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.pass\n\n方式二：写Shell脚本\n[root@nfs ~]# export RSYNC_PASSWORD=123456\n[root@nfs ~]# rsync -avzP ./size.disk rsync_backup@172.16.1.41::backup\n```\n\n## 三、Rsync备份案例\n\n>客户端需求\n>1.客户端提前准备存放的备份的目录，目录规则如下:/backup/nfs_172.16.1.31_2018-09-02 \n>2.客户端在本地打包备份(系统配置文件、应用配置等)拷贝至/backup/nfs_172.16.1.31_2018-09-02\n>3.客户端最后将备份的数据进行推送至备份服务器\n>4.客户端每天凌晨1点定时执行该脚本\n>5.客户端本地保留最近7天的数据, 避免浪费磁盘空间\n>\n>服务端需求\n>1.服务端部署rsync，用于接收客户端推送过来的备份数据\n>2.服务端需要每天校验客户端推送过来的数据是否完整\n>3.服务端需要每天校验的结果通知给管理员\n>4.服务端仅保留6个月的备份数据,其余的全部删除\n>\n>注意：所有服务器的备份目录必须都为/backup\n>\n>1.客户端将需要备份的文件放入指定的目录中   /backup/nfs_172.16.1.31_2018-09-02\n>2.客户端每天凌晨1点使用rsync命令推送一次nfs_172.16.1.31_2018-09-0\n>3.客户端保留最近7天的数据即可\n\n### 3.1 需求分析\n\n>1.我要备份什么？\n>\t/etc/fstab /var/spool/cron/USERNAME   /server/scripts\n>\n>2.我要怎么备份？\n>\t/backup/主机名_ip地址_时间  命名的目录中\n>\n>3.我要备份到哪？\n>\trsync备份服务器   172.16.1.41\n\n#### 3.1.1 服务端配置\n\n配置邮件服务\n\n```shell\n[root@backup ~]# yum install mailx -y\n[root@backup ~]# vim /etc/mail.rc\nset from=12345@qq.com\nset smtp=smtps://smtp.qq.com:465\nset smtp-auth-user=12345@qq.com\nset smtp-auth-password=xxxxxx # 授权码\nset smtp-auth=login\nset ssl-verify=ignore\nset nss-config-dir=/etc/pki/nssdb/\n```\n\n脚本编写\n\n```shell\n[root@backup ~]# mkdir /server/scripts -p\n[root@backup ~]# cat /server/scripts/check_client_data.sh\n#!/bin/bash\n#1.定义变量\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\nSRC=/backup\nDATE=$(date +%F)\n\n#1.使用md5进行校验，并保存校验的结果\nmd5sum -c $SRC/*_$DATE/flag_$DATE > $SRC/result_$DATE\n\n#2.将保存的结果文件发送给管理员\nmail -s \"Rsync Backup $DATE\" 572891887@qq.com <$SRC/result_$DATE\n\n#3.保留最近180天的数据\nfind $SRC/ -type d -mtime +180|xargs rm -rf \n```\n\n#### 3.1.2 客户端配置\n\n创建目录\n\n```shell\nmkdir /backup\nmkdir -p /server/scripts/\n```\n\n编写备份脚本\n\n```shell\n[root@nfs ~]# cat /server/scripts/client_push_data.sh\n#!/bin/bash\n#1.定义变量\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin\nSRC=/backup\nHOST=$(hostname)\nADDR=$(ifconfig eth1|awk 'NR==2 {print $2}')\nDATE=$(date +%F)\nDEST=${HOST}_${ADDR}_${DATE}\n\n#2.创建目录\n[ -d $SRC/$DEST ] || mkdir -p $SRC/$DEST\n\n#3.备份文件\ncd / && \\\n[ -f $SRC/$DEST/sys.tar.gz ] || tar czf $SRC/$DEST/sys.tar.gz etc/fstab etc/passwd && \\\n[ -f $SRC/$DEST/other.tar.gz ] || tar czf $SRC/$DEST/other.tar.gz var/spool/cron/ server/scripts && \\\n\n#4.使用md5打标记\n[ -f $SRC/$DEST/flag_$DATE ] || md5sum $SRC/$DEST/*.tar.gz  > $SRC/$DEST/flag_$DATE \n\n#4.本地推送到备份服务器\nexport RSYNC_PASSWORD=123456\nrsync -avz $SRC/$DEST rsync_backup@172.16.1.41::backup\n\n#5.保留本地最近7天的数据\nfind $SRC/ -type d -mtime +7|xargs rm -rf \n```\n\n#### 3.1.3 整体测试:设置定时任务\n\n客户端每两分钟备份推送一次\n\n```shell\n[root@nfs backup]# crontab -e\n*/2 * * * * sh /server/scripts/client_push_data.sh\n```\n\n服务端每3分钟校验一次，并发送确认邮件\n\n```shell\n[root@backup scripts]# crontab -e\n*/3 * * * * sh /server/scripts/check_client_data.sh\n```\n\n#### 3.1.5 增加客户端数量\n\n```shell\n多创建几台客户端服务器，测试\n```\n\n","slug":"01_运维/02-综合架构/02-Rsync服务搭建","published":1,"updated":"2022-07-06T07:15:40.429Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0d000ka8v766uw6d54","content":"<h2 id=\"二、Rsync与数据备份\"><a href=\"#二、Rsync与数据备份\" class=\"headerlink\" title=\"二、Rsync与数据备份\"></a>二、Rsync与数据备份</h2><h3 id=\"2-1-备份概念\"><a href=\"#2-1-备份概念\" class=\"headerlink\" title=\"2.1  备份概念\"></a>2.1  备份概念</h3><p>为什么要做备份？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">数据非常的重要\n保证数据不丢失\n便于快速的恢复<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>备份方式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">完全备份，每次都进行全部备份 (效率低下, 占用空间)\n增量备份，仅备份客户端与服务端差异的部分 (提高备份效率,节省空间, 适合异地备份 )<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>用什么工具做备份？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">scp  \t网络之间的拷贝，全量拷贝的方式  （ssh协议）\nrsync\t远程同步（增量）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-rsync的基本概念\"><a href=\"#2-2-rsync的基本概念\" class=\"headerlink\" title=\"2.2 rsync的基本概念\"></a>2.2 rsync的基本概念</h3><blockquote>\n<p>rsync是一款开源的备份工具，<br>可以在不同主机之间进行同步（windows和Linux之间   Mac和Linux   Linux和Linux）<br>可实现全量备份与增量备份<br>因此非常适合用于架构集中式备份或异地备份等应用</p>\n</blockquote>\n<p>rsync数据的同步模式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">推送： 本地将数据上传至备份服务器上\t （上传）\n拉取： 备份服务器获取本地服务器的数据  （下载）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>rsync的数据传输方式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">本地传输（类似于使用cp命令）\n远程传输（通过网络传输  a--&gt;b）\n守护进程（运行一个服务一直在后台）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>rsync选项详解</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync参数:\n-a           #归档模式传输, 等于-tropgDl *\n-v           #详细模式输出, 打印速率, 文件数量等 *\n-z           #传输时进行压缩以提高效率 *\n-r           #递归传输目录及子目录，即目录下得所有目录都同样传输。\n-t           #保持文件时间信息\n-o           #保持文件属主信息\n-p           #保持文件权限\n-g           #保持文件属组信息\n-l           #保留软连接\n-P           #显示同步的过程及传输时的进度等信息\n-D           #保持设备文件信息\n-L           #保留软连接指向的目标文件\n-e           #使用的信道协议,指定替代rsh的shell程序  ssh\n--exclude&#x3D;PATTERN   #指定排除不需要传输的文件模式\n--exclude-from&#x3D;file #文件名所在的目录文件\n--bwlimit&#x3D;100       #限速传输 *\n--partial           #断点续传\n--delete            #让目标目录和源目录数据保持一致 *<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-本地传输\"><a href=\"#2-3-本地传输\" class=\"headerlink\" title=\"2.3 本地传输\"></a>2.3 本地传输</h3><p>将&#x2F;boot文件夹拷贝到&#x2F;tmp中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;boot &#x2F;tmp&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将boot文件夹中的内容拷贝到&#x2F;tmp中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;boot&#x2F; &#x2F;tmp&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-3-远程传输\"><a href=\"#2-3-远程传输\" class=\"headerlink\" title=\"2.3 远程传输\"></a>2.3 远程传输</h3><p>虚拟机准备</p>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>nfs</td>\n<td>172.16.1.31&#x2F;24 和 10.0.0.31&#x2F;24</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>172.16.1.41&#x2F;24 和 10.0.0.41&#x2F;24</td>\n</tr>\n</tbody></table>\n<p>backup从nfs拉取&#x2F;boo目录到本地&#x2F;tmp文件夹</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">rsync -avz root@10.0.0.31:&#x2F;boot &#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>backup上传&#x2F;root&#x2F;test.txt到nfs主机的&#x2F;tmp文件夹中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync &#x2F;root&#x2F;test.txt root@10.0.0.31:&#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-4-守护进程传输（服务搭建）\"><a href=\"#2-4-守护进程传输（服务搭建）\" class=\"headerlink\" title=\"2.4 守护进程传输（服务搭建）\"></a>2.4 守护进程传输（服务搭建）</h3><blockquote>\n<p>为什么需要使用rsync守护进程传输？</p>\n<p>Rsync借助SSH协议同步数据存在的缺陷（临时发送数据）<br>    1.使用系统用户（不安全）<br>    2.使用普通用户（会导致权限不足情况）</p>\n</blockquote>\n<p>backup充当rsync服务端，nfs充当客户端，配置步骤：</p>\n<h4 id=\"2-4-1-服务端配置\"><a href=\"#2-4-1-服务端配置\" class=\"headerlink\" title=\"2.4.1 服务端配置\"></a>2.4.1 服务端配置</h4><p>获取配置文件路径</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# rpm -qc rsync\n\t&#x2F;etc&#x2F;rsyncd.conf\t\t\t# 主配置文件\n\t&#x2F;etc&#x2F;sysconfig&#x2F;rsyncd\t\t# 选项<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;rsyncd.conf\n---------------------\nuid &#x3D; rsync\ngid &#x3D; rsync\nport &#x3D; 873\nfake super &#x3D; yes\nuse chroot &#x3D; no\nmax connections &#x3D; 200\ntimeout &#x3D; 600\nignore errors\nread only &#x3D; false\nlist &#x3D; false\nauth users &#x3D; rsync_backup\nsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd\nlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log\n#####################################\n[backup]\ncomment &#x3D; welcome to oldboyedu backup!\npath &#x3D; &#x2F;backup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置详细解析</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">uid &#x3D; rsync                      # 运行进程的用户\ngid &#x3D; rsync                      # 运行进程的用户组\nport &#x3D; 873                       # 监听端口\nfake super &#x3D; yes                 # 无需让rsync以root身份运行，允许接收文件的完整属性\nuse chroot &#x3D; no                  # 禁锢推送的数据至某个目录, 不允许跳出该目录\nmax connections &#x3D; 200            # 最大连接数\ntimeout &#x3D; 600                    # 超时时间\nignore errors                    # 忽略错误信息\nread only &#x3D; false                # 对备份数据可读写\nlist &#x3D; false                     # 不允许查看模块信息\nauth users &#x3D; rsync_backup        # 定义虚拟用户，作为连接认证用户\nsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd # 定义rsync服务用户连接认证密码文件路径\nlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log   # 日志文件\n#####################################\n[backup]                # 定义模块信息\ncomment &#x3D; commit        # 模块注释信息\npath &#x3D; &#x2F;backup          # 定义接收备份数据目录<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>创建rsync进程启动时需要使用的用户</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# useradd rsync -M -s &#x2F;sbin&#x2F;nologin \n[root@backup ~]# id rsync\nuid&#x3D;1000(rsync) gid&#x3D;1000(rsync) groups&#x3D;1000(rsync)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&#x2F;etc&#x2F;rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码\n[root@backup ~]# echo &quot;rsync_backup:123456&quot; &gt; &#x2F;etc&#x2F;rsync.passwd\n[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建存储备份数据的目录，并进行授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# mkdir &#x2F;backup\n[root@backup ~]# chown -R rsync.rsync &#x2F;backup&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动rsync服务并加入开机自启动</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# systemctl start rsyncd.service \n[root@backup ~]# systemctl enable rsyncd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>检查rsync的873端口是否存在</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# netstat -lntup\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name\ntcp6       0      0 :::873                  :::*                    LISTEN      1269&#x2F;rsync<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-4-2-客户端测试\"><a href=\"#2-4-2-客户端测试\" class=\"headerlink\" title=\"2.4.2 客户端测试\"></a>2.4.2 客户端测试</h4><p>推送&#x2F;etc文件夹到服务端&#x2F;backup</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;etc&#x2F; rsync_backup@172.16.1.41::backup\n需要输入密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>从服务端&#x2F;backup拉取文件到&#x2F;tmp</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz rsync_backup@172.16.1.41::backup &#x2F;tmp\n需要输入密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-rsync补充\"><a href=\"#2-5-rsync补充\" class=\"headerlink\" title=\"2.5 rsync补充\"></a>2.5 rsync补充</h3><h4 id=\"2-5-1-无差异同步-慎用\"><a href=\"#2-5-1-无差异同步-慎用\" class=\"headerlink\" title=\"2.5.1 无差异同步(慎用)\"></a>2.5.1 无差异同步(慎用)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#推送方式实现无差异，以客户端为准，客户端有什么服务端就有什么\n[root@nfs ~]# rsync -avz --delete &#x2F;root rsync_backup@172.16.1.41::backup\t\t\n\n#拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么\n[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup &#x2F;opt&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-2-传输限速\"><a href=\"#2-5-2-传输限速\" class=\"headerlink\" title=\"2.5.2 传输限速\"></a>2.5.2 传输限速</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 生成大文件\n[root@nfs ~]# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;size.disk bs&#x3D;1M count&#x3D;500  \n\n# 限制传输的速率为1MB \n[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup\nPassword: \nsending incremental file list\nsize.disk\n    118,358,016  22%    1.01MB&#x2F;s    0:06:33<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-3-取消每次传输需要输密码\"><a href=\"#2-5-3-取消每次传输需要输密码\" class=\"headerlink\" title=\"2.5.3 取消每次传输需要输密码\"></a>2.5.3 取消每次传输需要输密码</h4><p>在客户端配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">方式一：\n[root@nfs ~]# echo &quot;123456&quot; &gt; &#x2F;etc&#x2F;rsync.pass\n[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass #上该文件找123456\n[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass\n\n方式二：写Shell脚本\n[root@nfs ~]# export RSYNC_PASSWORD&#x3D;123456\n[root@nfs ~]# rsync -avzP .&#x2F;size.disk rsync_backup@172.16.1.41::backup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、Rsync备份案例\"><a href=\"#三、Rsync备份案例\" class=\"headerlink\" title=\"三、Rsync备份案例\"></a>三、Rsync备份案例</h2><blockquote>\n<p>客户端需求<br>1.客户端提前准备存放的备份的目录，目录规则如下:&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端在本地打包备份(系统配置文件、应用配置等)拷贝至&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>3.客户端最后将备份的数据进行推送至备份服务器<br>4.客户端每天凌晨1点定时执行该脚本<br>5.客户端本地保留最近7天的数据, 避免浪费磁盘空间</p>\n<p>服务端需求<br>1.服务端部署rsync，用于接收客户端推送过来的备份数据<br>2.服务端需要每天校验客户端推送过来的数据是否完整<br>3.服务端需要每天校验的结果通知给管理员<br>4.服务端仅保留6个月的备份数据,其余的全部删除</p>\n<p>注意：所有服务器的备份目录必须都为&#x2F;backup</p>\n<p>1.客户端将需要备份的文件放入指定的目录中   &#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端每天凌晨1点使用rsync命令推送一次nfs_172.16.1.31_2018-09-0<br>3.客户端保留最近7天的数据即可</p>\n</blockquote>\n<h3 id=\"3-1-需求分析\"><a href=\"#3-1-需求分析\" class=\"headerlink\" title=\"3.1 需求分析\"></a>3.1 需求分析</h3><blockquote>\n<p>1.我要备份什么？<br>&#x2F;etc&#x2F;fstab &#x2F;var&#x2F;spool&#x2F;cron&#x2F;USERNAME   &#x2F;server&#x2F;scripts</p>\n<p>2.我要怎么备份？<br>&#x2F;backup&#x2F;主机名_ip地址_时间  命名的目录中</p>\n<p>3.我要备份到哪？<br>rsync备份服务器   172.16.1.41</p>\n</blockquote>\n<h4 id=\"3-1-1-服务端配置\"><a href=\"#3-1-1-服务端配置\" class=\"headerlink\" title=\"3.1.1 服务端配置\"></a>3.1.1 服务端配置</h4><p>配置邮件服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# yum install mailx -y\n[root@backup ~]# vim &#x2F;etc&#x2F;mail.rc\nset from&#x3D;12345@qq.com\nset smtp&#x3D;smtps:&#x2F;&#x2F;smtp.qq.com:465\nset smtp-auth-user&#x3D;12345@qq.com\nset smtp-auth-password&#x3D;xxxxxx # 授权码\nset smtp-auth&#x3D;login\nset ssl-verify&#x3D;ignore\nset nss-config-dir&#x3D;&#x2F;etc&#x2F;pki&#x2F;nssdb&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>脚本编写</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# mkdir &#x2F;server&#x2F;scripts -p\n[root@backup ~]# cat &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh\n#!&#x2F;bin&#x2F;bash\n#1.定义变量\nPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin\nSRC&#x3D;&#x2F;backup\nDATE&#x3D;$(date +%F)\n\n#1.使用md5进行校验，并保存校验的结果\nmd5sum -c $SRC&#x2F;*_$DATE&#x2F;flag_$DATE &gt; $SRC&#x2F;result_$DATE\n\n#2.将保存的结果文件发送给管理员\nmail -s &quot;Rsync Backup $DATE&quot; 572891887@qq.com &lt;$SRC&#x2F;result_$DATE\n\n#3.保留最近180天的数据\nfind $SRC&#x2F; -type d -mtime +180|xargs rm -rf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-2-客户端配置\"><a href=\"#3-1-2-客户端配置\" class=\"headerlink\" title=\"3.1.2 客户端配置\"></a>3.1.2 客户端配置</h4><p>创建目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;backup\nmkdir -p &#x2F;server&#x2F;scripts&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>编写备份脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh\n#!&#x2F;bin&#x2F;bash\n#1.定义变量\nPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin\nSRC&#x3D;&#x2F;backup\nHOST&#x3D;$(hostname)\nADDR&#x3D;$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2 &#123;print $2&#125;&#39;)\nDATE&#x3D;$(date +%F)\nDEST&#x3D;$&#123;HOST&#125;_$&#123;ADDR&#125;_$&#123;DATE&#125;\n\n#2.创建目录\n[ -d $SRC&#x2F;$DEST ] || mkdir -p $SRC&#x2F;$DEST\n\n#3.备份文件\ncd &#x2F; &amp;&amp; \\\n[ -f $SRC&#x2F;$DEST&#x2F;sys.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd &amp;&amp; \\\n[ -f $SRC&#x2F;$DEST&#x2F;other.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;other.tar.gz var&#x2F;spool&#x2F;cron&#x2F; server&#x2F;scripts &amp;&amp; \\\n\n#4.使用md5打标记\n[ -f $SRC&#x2F;$DEST&#x2F;flag_$DATE ] || md5sum $SRC&#x2F;$DEST&#x2F;*.tar.gz  &gt; $SRC&#x2F;$DEST&#x2F;flag_$DATE \n\n#4.本地推送到备份服务器\nexport RSYNC_PASSWORD&#x3D;123456\nrsync -avz $SRC&#x2F;$DEST rsync_backup@172.16.1.41::backup\n\n#5.保留本地最近7天的数据\nfind $SRC&#x2F; -type d -mtime +7|xargs rm -rf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-3-整体测试-设置定时任务\"><a href=\"#3-1-3-整体测试-设置定时任务\" class=\"headerlink\" title=\"3.1.3 整体测试:设置定时任务\"></a>3.1.3 整体测试:设置定时任务</h4><p>客户端每两分钟备份推送一次</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs backup]# crontab -e\n*&#x2F;2 * * * * sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>服务端每3分钟校验一次，并发送确认邮件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup scripts]# crontab -e\n*&#x2F;3 * * * * sh &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-5-增加客户端数量\"><a href=\"#3-1-5-增加客户端数量\" class=\"headerlink\" title=\"3.1.5 增加客户端数量\"></a>3.1.5 增加客户端数量</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">多创建几台客户端服务器，测试<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"二、Rsync与数据备份\"><a href=\"#二、Rsync与数据备份\" class=\"headerlink\" title=\"二、Rsync与数据备份\"></a>二、Rsync与数据备份</h2><h3 id=\"2-1-备份概念\"><a href=\"#2-1-备份概念\" class=\"headerlink\" title=\"2.1  备份概念\"></a>2.1  备份概念</h3><p>为什么要做备份？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">数据非常的重要\n保证数据不丢失\n便于快速的恢复<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>备份方式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">完全备份，每次都进行全部备份 (效率低下, 占用空间)\n增量备份，仅备份客户端与服务端差异的部分 (提高备份效率,节省空间, 适合异地备份 )<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>用什么工具做备份？</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">scp  \t网络之间的拷贝，全量拷贝的方式  （ssh协议）\nrsync\t远程同步（增量）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-rsync的基本概念\"><a href=\"#2-2-rsync的基本概念\" class=\"headerlink\" title=\"2.2 rsync的基本概念\"></a>2.2 rsync的基本概念</h3><blockquote>\n<p>rsync是一款开源的备份工具，<br>可以在不同主机之间进行同步（windows和Linux之间   Mac和Linux   Linux和Linux）<br>可实现全量备份与增量备份<br>因此非常适合用于架构集中式备份或异地备份等应用</p>\n</blockquote>\n<p>rsync数据的同步模式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">推送： 本地将数据上传至备份服务器上\t （上传）\n拉取： 备份服务器获取本地服务器的数据  （下载）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>rsync的数据传输方式</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">本地传输（类似于使用cp命令）\n远程传输（通过网络传输  a--&gt;b）\n守护进程（运行一个服务一直在后台）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>rsync选项详解</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync参数:\n-a           #归档模式传输, 等于-tropgDl *\n-v           #详细模式输出, 打印速率, 文件数量等 *\n-z           #传输时进行压缩以提高效率 *\n-r           #递归传输目录及子目录，即目录下得所有目录都同样传输。\n-t           #保持文件时间信息\n-o           #保持文件属主信息\n-p           #保持文件权限\n-g           #保持文件属组信息\n-l           #保留软连接\n-P           #显示同步的过程及传输时的进度等信息\n-D           #保持设备文件信息\n-L           #保留软连接指向的目标文件\n-e           #使用的信道协议,指定替代rsh的shell程序  ssh\n--exclude&#x3D;PATTERN   #指定排除不需要传输的文件模式\n--exclude-from&#x3D;file #文件名所在的目录文件\n--bwlimit&#x3D;100       #限速传输 *\n--partial           #断点续传\n--delete            #让目标目录和源目录数据保持一致 *<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-本地传输\"><a href=\"#2-3-本地传输\" class=\"headerlink\" title=\"2.3 本地传输\"></a>2.3 本地传输</h3><p>将&#x2F;boot文件夹拷贝到&#x2F;tmp中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;boot &#x2F;tmp&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将boot文件夹中的内容拷贝到&#x2F;tmp中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;boot&#x2F; &#x2F;tmp&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-3-远程传输\"><a href=\"#2-3-远程传输\" class=\"headerlink\" title=\"2.3 远程传输\"></a>2.3 远程传输</h3><p>虚拟机准备</p>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>nfs</td>\n<td>172.16.1.31&#x2F;24 和 10.0.0.31&#x2F;24</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>172.16.1.41&#x2F;24 和 10.0.0.41&#x2F;24</td>\n</tr>\n</tbody></table>\n<p>backup从nfs拉取&#x2F;boo目录到本地&#x2F;tmp文件夹</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">rsync -avz root@10.0.0.31:&#x2F;boot &#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>backup上传&#x2F;root&#x2F;test.txt到nfs主机的&#x2F;tmp文件夹中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync &#x2F;root&#x2F;test.txt root@10.0.0.31:&#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-4-守护进程传输（服务搭建）\"><a href=\"#2-4-守护进程传输（服务搭建）\" class=\"headerlink\" title=\"2.4 守护进程传输（服务搭建）\"></a>2.4 守护进程传输（服务搭建）</h3><blockquote>\n<p>为什么需要使用rsync守护进程传输？</p>\n<p>Rsync借助SSH协议同步数据存在的缺陷（临时发送数据）<br>    1.使用系统用户（不安全）<br>    2.使用普通用户（会导致权限不足情况）</p>\n</blockquote>\n<p>backup充当rsync服务端，nfs充当客户端，配置步骤：</p>\n<h4 id=\"2-4-1-服务端配置\"><a href=\"#2-4-1-服务端配置\" class=\"headerlink\" title=\"2.4.1 服务端配置\"></a>2.4.1 服务端配置</h4><p>获取配置文件路径</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# rpm -qc rsync\n\t&#x2F;etc&#x2F;rsyncd.conf\t\t\t# 主配置文件\n\t&#x2F;etc&#x2F;sysconfig&#x2F;rsyncd\t\t# 选项<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;rsyncd.conf\n---------------------\nuid &#x3D; rsync\ngid &#x3D; rsync\nport &#x3D; 873\nfake super &#x3D; yes\nuse chroot &#x3D; no\nmax connections &#x3D; 200\ntimeout &#x3D; 600\nignore errors\nread only &#x3D; false\nlist &#x3D; false\nauth users &#x3D; rsync_backup\nsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd\nlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log\n#####################################\n[backup]\ncomment &#x3D; welcome to oldboyedu backup!\npath &#x3D; &#x2F;backup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置详细解析</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">uid &#x3D; rsync                      # 运行进程的用户\ngid &#x3D; rsync                      # 运行进程的用户组\nport &#x3D; 873                       # 监听端口\nfake super &#x3D; yes                 # 无需让rsync以root身份运行，允许接收文件的完整属性\nuse chroot &#x3D; no                  # 禁锢推送的数据至某个目录, 不允许跳出该目录\nmax connections &#x3D; 200            # 最大连接数\ntimeout &#x3D; 600                    # 超时时间\nignore errors                    # 忽略错误信息\nread only &#x3D; false                # 对备份数据可读写\nlist &#x3D; false                     # 不允许查看模块信息\nauth users &#x3D; rsync_backup        # 定义虚拟用户，作为连接认证用户\nsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd # 定义rsync服务用户连接认证密码文件路径\nlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log   # 日志文件\n#####################################\n[backup]                # 定义模块信息\ncomment &#x3D; commit        # 模块注释信息\npath &#x3D; &#x2F;backup          # 定义接收备份数据目录<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>创建rsync进程启动时需要使用的用户</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# useradd rsync -M -s &#x2F;sbin&#x2F;nologin \n[root@backup ~]# id rsync\nuid&#x3D;1000(rsync) gid&#x3D;1000(rsync) groups&#x3D;1000(rsync)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建密码文件，在密码文件中写入对应的虚拟用户以及虚拟用户的密码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">&#x2F;etc&#x2F;rsync.passwd---》rsync虚拟用户以及rsync虚拟用户的密码\n[root@backup ~]# echo &quot;rsync_backup:123456&quot; &gt; &#x2F;etc&#x2F;rsync.passwd\n[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建存储备份数据的目录，并进行授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# mkdir &#x2F;backup\n[root@backup ~]# chown -R rsync.rsync &#x2F;backup&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动rsync服务并加入开机自启动</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# systemctl start rsyncd.service \n[root@backup ~]# systemctl enable rsyncd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>检查rsync的873端口是否存在</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# netstat -lntup\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID&#x2F;Program name\ntcp6       0      0 :::873                  :::*                    LISTEN      1269&#x2F;rsync<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-4-2-客户端测试\"><a href=\"#2-4-2-客户端测试\" class=\"headerlink\" title=\"2.4.2 客户端测试\"></a>2.4.2 客户端测试</h4><p>推送&#x2F;etc文件夹到服务端&#x2F;backup</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz &#x2F;etc&#x2F; rsync_backup@172.16.1.41::backup\n需要输入密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>从服务端&#x2F;backup拉取文件到&#x2F;tmp</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rsync -avz rsync_backup@172.16.1.41::backup &#x2F;tmp\n需要输入密码<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-rsync补充\"><a href=\"#2-5-rsync补充\" class=\"headerlink\" title=\"2.5 rsync补充\"></a>2.5 rsync补充</h3><h4 id=\"2-5-1-无差异同步-慎用\"><a href=\"#2-5-1-无差异同步-慎用\" class=\"headerlink\" title=\"2.5.1 无差异同步(慎用)\"></a>2.5.1 无差异同步(慎用)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#推送方式实现无差异，以客户端为准，客户端有什么服务端就有什么\n[root@nfs ~]# rsync -avz --delete &#x2F;root rsync_backup@172.16.1.41::backup\t\t\n\n#拉取方式实现无差异，以服务端为准，服务端有什么客户端就有什么\n[root@nfs ~]# rsync -avz --delete rsync_backup@172.16.1.41::backup &#x2F;opt&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-2-传输限速\"><a href=\"#2-5-2-传输限速\" class=\"headerlink\" title=\"2.5.2 传输限速\"></a>2.5.2 传输限速</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 生成大文件\n[root@nfs ~]# dd if&#x3D;&#x2F;dev&#x2F;zero of&#x3D;.&#x2F;size.disk bs&#x3D;1M count&#x3D;500  \n\n# 限制传输的速率为1MB \n[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup\nPassword: \nsending incremental file list\nsize.disk\n    118,358,016  22%    1.01MB&#x2F;s    0:06:33<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-3-取消每次传输需要输密码\"><a href=\"#2-5-3-取消每次传输需要输密码\" class=\"headerlink\" title=\"2.5.3 取消每次传输需要输密码\"></a>2.5.3 取消每次传输需要输密码</h4><p>在客户端配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">方式一：\n[root@nfs ~]# echo &quot;123456&quot; &gt; &#x2F;etc&#x2F;rsync.pass\n[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass #上该文件找123456\n[root@nfs ~]# rsync -avzP --bwlimit&#x3D;1 .&#x2F;size.disk rsync_backup@172.16.1.41::backup --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass\n\n方式二：写Shell脚本\n[root@nfs ~]# export RSYNC_PASSWORD&#x3D;123456\n[root@nfs ~]# rsync -avzP .&#x2F;size.disk rsync_backup@172.16.1.41::backup<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、Rsync备份案例\"><a href=\"#三、Rsync备份案例\" class=\"headerlink\" title=\"三、Rsync备份案例\"></a>三、Rsync备份案例</h2><blockquote>\n<p>客户端需求<br>1.客户端提前准备存放的备份的目录，目录规则如下:&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端在本地打包备份(系统配置文件、应用配置等)拷贝至&#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>3.客户端最后将备份的数据进行推送至备份服务器<br>4.客户端每天凌晨1点定时执行该脚本<br>5.客户端本地保留最近7天的数据, 避免浪费磁盘空间</p>\n<p>服务端需求<br>1.服务端部署rsync，用于接收客户端推送过来的备份数据<br>2.服务端需要每天校验客户端推送过来的数据是否完整<br>3.服务端需要每天校验的结果通知给管理员<br>4.服务端仅保留6个月的备份数据,其余的全部删除</p>\n<p>注意：所有服务器的备份目录必须都为&#x2F;backup</p>\n<p>1.客户端将需要备份的文件放入指定的目录中   &#x2F;backup&#x2F;nfs_172.16.1.31_2018-09-02<br>2.客户端每天凌晨1点使用rsync命令推送一次nfs_172.16.1.31_2018-09-0<br>3.客户端保留最近7天的数据即可</p>\n</blockquote>\n<h3 id=\"3-1-需求分析\"><a href=\"#3-1-需求分析\" class=\"headerlink\" title=\"3.1 需求分析\"></a>3.1 需求分析</h3><blockquote>\n<p>1.我要备份什么？<br>&#x2F;etc&#x2F;fstab &#x2F;var&#x2F;spool&#x2F;cron&#x2F;USERNAME   &#x2F;server&#x2F;scripts</p>\n<p>2.我要怎么备份？<br>&#x2F;backup&#x2F;主机名_ip地址_时间  命名的目录中</p>\n<p>3.我要备份到哪？<br>rsync备份服务器   172.16.1.41</p>\n</blockquote>\n<h4 id=\"3-1-1-服务端配置\"><a href=\"#3-1-1-服务端配置\" class=\"headerlink\" title=\"3.1.1 服务端配置\"></a>3.1.1 服务端配置</h4><p>配置邮件服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# yum install mailx -y\n[root@backup ~]# vim &#x2F;etc&#x2F;mail.rc\nset from&#x3D;12345@qq.com\nset smtp&#x3D;smtps:&#x2F;&#x2F;smtp.qq.com:465\nset smtp-auth-user&#x3D;12345@qq.com\nset smtp-auth-password&#x3D;xxxxxx # 授权码\nset smtp-auth&#x3D;login\nset ssl-verify&#x3D;ignore\nset nss-config-dir&#x3D;&#x2F;etc&#x2F;pki&#x2F;nssdb&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>脚本编写</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# mkdir &#x2F;server&#x2F;scripts -p\n[root@backup ~]# cat &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh\n#!&#x2F;bin&#x2F;bash\n#1.定义变量\nPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin\nSRC&#x3D;&#x2F;backup\nDATE&#x3D;$(date +%F)\n\n#1.使用md5进行校验，并保存校验的结果\nmd5sum -c $SRC&#x2F;*_$DATE&#x2F;flag_$DATE &gt; $SRC&#x2F;result_$DATE\n\n#2.将保存的结果文件发送给管理员\nmail -s &quot;Rsync Backup $DATE&quot; 572891887@qq.com &lt;$SRC&#x2F;result_$DATE\n\n#3.保留最近180天的数据\nfind $SRC&#x2F; -type d -mtime +180|xargs rm -rf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-2-客户端配置\"><a href=\"#3-1-2-客户端配置\" class=\"headerlink\" title=\"3.1.2 客户端配置\"></a>3.1.2 客户端配置</h4><p>创建目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;backup\nmkdir -p &#x2F;server&#x2F;scripts&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>编写备份脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs ~]# cat &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh\n#!&#x2F;bin&#x2F;bash\n#1.定义变量\nPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;root&#x2F;bin\nSRC&#x3D;&#x2F;backup\nHOST&#x3D;$(hostname)\nADDR&#x3D;$(ifconfig eth1|awk &#39;NR&#x3D;&#x3D;2 &#123;print $2&#125;&#39;)\nDATE&#x3D;$(date +%F)\nDEST&#x3D;$&#123;HOST&#125;_$&#123;ADDR&#125;_$&#123;DATE&#125;\n\n#2.创建目录\n[ -d $SRC&#x2F;$DEST ] || mkdir -p $SRC&#x2F;$DEST\n\n#3.备份文件\ncd &#x2F; &amp;&amp; \\\n[ -f $SRC&#x2F;$DEST&#x2F;sys.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;sys.tar.gz etc&#x2F;fstab etc&#x2F;passwd &amp;&amp; \\\n[ -f $SRC&#x2F;$DEST&#x2F;other.tar.gz ] || tar czf $SRC&#x2F;$DEST&#x2F;other.tar.gz var&#x2F;spool&#x2F;cron&#x2F; server&#x2F;scripts &amp;&amp; \\\n\n#4.使用md5打标记\n[ -f $SRC&#x2F;$DEST&#x2F;flag_$DATE ] || md5sum $SRC&#x2F;$DEST&#x2F;*.tar.gz  &gt; $SRC&#x2F;$DEST&#x2F;flag_$DATE \n\n#4.本地推送到备份服务器\nexport RSYNC_PASSWORD&#x3D;123456\nrsync -avz $SRC&#x2F;$DEST rsync_backup@172.16.1.41::backup\n\n#5.保留本地最近7天的数据\nfind $SRC&#x2F; -type d -mtime +7|xargs rm -rf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-3-整体测试-设置定时任务\"><a href=\"#3-1-3-整体测试-设置定时任务\" class=\"headerlink\" title=\"3.1.3 整体测试:设置定时任务\"></a>3.1.3 整体测试:设置定时任务</h4><p>客户端每两分钟备份推送一次</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nfs backup]# crontab -e\n*&#x2F;2 * * * * sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>服务端每3分钟校验一次，并发送确认邮件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup scripts]# crontab -e\n*&#x2F;3 * * * * sh &#x2F;server&#x2F;scripts&#x2F;check_client_data.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-1-5-增加客户端数量\"><a href=\"#3-1-5-增加客户端数量\" class=\"headerlink\" title=\"3.1.5 增加客户端数量\"></a>3.1.5 增加客户端数量</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">多创建几台客户端服务器，测试<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--05--SSH服务器搭建","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、SSH服务器介绍\n\n>SSH是一个安全协议，在进行数据传输时，会对数据包进行加密处理，加密后在进行数据传输。确保了数据传输安全。\n>\n\n![ssh免密登录](/img/ssh免密登录.png)\n\n### 1 ssh的功能\n\n1. 提供远程连接服务器的服务\n2. 对传输的数据进行加密\n\n### 2 常用服务的端口\n\n- ftp -- tcp/20  tcp/21\n- dns -- tcp/53  udp/53\n- ssh  --  tcp/22\n- telnet -- tcp/23 \n- mysql -- tcp/3306\n- http -- tcp/80\n- https -- tcp/443\n\n### 3 telnet服务搭建\n\n安装并启动telnet服务\n\n```shell\n[root@backup ~]# yum install telnet-server -y\n[root@backup ~]# systemctl start telnet.socket \n[root@backup ~]# useradd gs\n[root@backup ~]# echo \"1\" | passwd --stdin gs\n```\n\n使用终端软件通过telnet使用gs用户登录连接\n\n### 4 telnet与ssh的对比\n\n| 服务连接方式 | 服务数据传输 | 服务监听端口 | 服务登陆用户     |\n| ------------ | ------------ | ------------ | ---------------- |\n| ssh          | 加密         | tcp/22       | 默认支持root登录 |\n| telnet       | 明文         | tcp/23       | 不支持root登录   |\n\n## 二、ssh与scp的使用\n\n### 1 使用ssh \n\n```shell\nssh命令\n\tssh 172.16.1.31\t\t\t\t\t#取决当前执行此命令的用户\n\tssh root@172.16.1.31\t\t\t#标准的写法\n\tssh -p22 root@172.16.1.31\t\t#带端口\n```\n\n### 2 使用scp\n\n```shell\nscp \n# -P 指定端口，默认22端口可不写\n# -r 表示递归拷贝目录\n# -p 表示在拷贝文件前后保持文件或目录属性不变\n# -l 限制传输使用带宽(默认kb) /8 ->KB  /1024  ->MB \n```\n\n## 三、使用ssh密钥登录\n\n```shell\n1.生成密钥对    公钥  私钥\n[root@m01 ~]# ssh-keygen -C 7242xxxxx@qq.com\n\t\n2.将公钥推送到你需要连接的主机，第一次需要输入对端主机的密码\n[root@m01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.31\nroot@172.16.1.31's password:\n\t\n3.通过ssh命令测试连接是否需要密码\n[root@m01 ~]# ssh 172.16.1.31\nLast login: Wed Jan  9 10:39:16 2019 from 172.16.1.61\n```\n\n## 四、ssh安全\n\n```shell\n[root@jumpserver ~]# vim /etc/ssh/sshd_config\n[root@jumpserver ~]# systemctl restart sshd\n```\n\nSSH作为远程连接服务，通常我们需要考虑到该服务的安全，所以需要对该服务进行安全方面的配置。\n1.更改远程连接登陆的端口\t\t6666\n2.禁止ROOT管理员直接登录\t\t\n3.密码认证方式改为密钥认证\n4.重要服务不使用公网IP地址\n5.使用防火墙限制来源IP地址\n\t\nPort 6666                       # 变更SSH服务远程连接端口√\nPermitRootLogin         no      # 禁止root用户直接远程登录√\nPasswordAuthentication  no      # 禁止使用密码直接远程登录√\nUseDNS                  no      # 禁止ssh进行dns反向解析，影响ssh连接效率参数√\nGSSAPIAuthentication    no      # 禁止GSS认证，减少连接时产生的延迟√\n\n## 五、防ssh暴力破解工具fail2ban\n\n>fail2ban可以监控系统日志，并且根据一定规则匹配异常IP后使用Firewalld将其屏蔽，尤其是针对一些爆破/扫描等非常有效。\n\n部署流程\n\n```shell\n1.开启Firewalld防火墙\n[root@bgx ~]# systemctl start firewalld\n[root@bgx ~]# systemctl enable firewalld\n[root@bgx ~]# firewall-cmd --state\nrunning\n\n2.修改firewalld规则，启用Firewalld后会禁止一些服务的传输，但默认会放行常用的22端口, 如果想添加更多，以下是放行SSH端口（22）示例，供参考：\n#放行SSHD服务端口\n[root@bgx ~]# firewall-cmd --permanent --add-service=ssh --add-service=http \n#重载配\n[root@bgx ~]# firewall-cmd --reload\n#查看已放行端口\n[root@bgx ~]# firewall-cmd  --list-service\n\n3.安装fail2ban,需要有epel\n[root@bgx ~]# yum install fail2ban fail2ban-firewalld mailx -y\n\n4.配置fail2ban规则.local会覆盖.conf文件\n[root@bgx fail2ban]# cat /etc/fail2ban/jail.local\n[DEFAULT]\nignoreip = 127.0.0.1/8\nbantime  = 86400\nfindtime = 600\nmaxretry = 5\nbanaction = firewallcmd-ipset\naction = %(action_mwl)s\n\n[sshd]\nenabled = true\nfilter  = sshd\nport    = 22\naction = %(action_mwl)s\nlogpath = /var/log/secure\n\n5.启动服务，并检查状态\n[root@bgx ~]# systemctl start fail2ban.service\n[root@bgx ~]# fail2ban-client status sshd\n\n6.清除被封掉的IP地址\n[root@bgx ~]# fail2ban-client set sshd unbanip 10.0.0.1\n```\n\n","source":"_posts/01_运维/02-综合架构/05-ssh服务跳板机搭建.md","raw":"---\ntitle: 运维之综合架构--05--SSH服务器搭建\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、SSH服务器介绍\n\n>SSH是一个安全协议，在进行数据传输时，会对数据包进行加密处理，加密后在进行数据传输。确保了数据传输安全。\n>\n\n![ssh免密登录](/img/ssh免密登录.png)\n\n### 1 ssh的功能\n\n1. 提供远程连接服务器的服务\n2. 对传输的数据进行加密\n\n### 2 常用服务的端口\n\n- ftp -- tcp/20  tcp/21\n- dns -- tcp/53  udp/53\n- ssh  --  tcp/22\n- telnet -- tcp/23 \n- mysql -- tcp/3306\n- http -- tcp/80\n- https -- tcp/443\n\n### 3 telnet服务搭建\n\n安装并启动telnet服务\n\n```shell\n[root@backup ~]# yum install telnet-server -y\n[root@backup ~]# systemctl start telnet.socket \n[root@backup ~]# useradd gs\n[root@backup ~]# echo \"1\" | passwd --stdin gs\n```\n\n使用终端软件通过telnet使用gs用户登录连接\n\n### 4 telnet与ssh的对比\n\n| 服务连接方式 | 服务数据传输 | 服务监听端口 | 服务登陆用户     |\n| ------------ | ------------ | ------------ | ---------------- |\n| ssh          | 加密         | tcp/22       | 默认支持root登录 |\n| telnet       | 明文         | tcp/23       | 不支持root登录   |\n\n## 二、ssh与scp的使用\n\n### 1 使用ssh \n\n```shell\nssh命令\n\tssh 172.16.1.31\t\t\t\t\t#取决当前执行此命令的用户\n\tssh root@172.16.1.31\t\t\t#标准的写法\n\tssh -p22 root@172.16.1.31\t\t#带端口\n```\n\n### 2 使用scp\n\n```shell\nscp \n# -P 指定端口，默认22端口可不写\n# -r 表示递归拷贝目录\n# -p 表示在拷贝文件前后保持文件或目录属性不变\n# -l 限制传输使用带宽(默认kb) /8 ->KB  /1024  ->MB \n```\n\n## 三、使用ssh密钥登录\n\n```shell\n1.生成密钥对    公钥  私钥\n[root@m01 ~]# ssh-keygen -C 7242xxxxx@qq.com\n\t\n2.将公钥推送到你需要连接的主机，第一次需要输入对端主机的密码\n[root@m01 ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.16.1.31\nroot@172.16.1.31's password:\n\t\n3.通过ssh命令测试连接是否需要密码\n[root@m01 ~]# ssh 172.16.1.31\nLast login: Wed Jan  9 10:39:16 2019 from 172.16.1.61\n```\n\n## 四、ssh安全\n\n```shell\n[root@jumpserver ~]# vim /etc/ssh/sshd_config\n[root@jumpserver ~]# systemctl restart sshd\n```\n\nSSH作为远程连接服务，通常我们需要考虑到该服务的安全，所以需要对该服务进行安全方面的配置。\n1.更改远程连接登陆的端口\t\t6666\n2.禁止ROOT管理员直接登录\t\t\n3.密码认证方式改为密钥认证\n4.重要服务不使用公网IP地址\n5.使用防火墙限制来源IP地址\n\t\nPort 6666                       # 变更SSH服务远程连接端口√\nPermitRootLogin         no      # 禁止root用户直接远程登录√\nPasswordAuthentication  no      # 禁止使用密码直接远程登录√\nUseDNS                  no      # 禁止ssh进行dns反向解析，影响ssh连接效率参数√\nGSSAPIAuthentication    no      # 禁止GSS认证，减少连接时产生的延迟√\n\n## 五、防ssh暴力破解工具fail2ban\n\n>fail2ban可以监控系统日志，并且根据一定规则匹配异常IP后使用Firewalld将其屏蔽，尤其是针对一些爆破/扫描等非常有效。\n\n部署流程\n\n```shell\n1.开启Firewalld防火墙\n[root@bgx ~]# systemctl start firewalld\n[root@bgx ~]# systemctl enable firewalld\n[root@bgx ~]# firewall-cmd --state\nrunning\n\n2.修改firewalld规则，启用Firewalld后会禁止一些服务的传输，但默认会放行常用的22端口, 如果想添加更多，以下是放行SSH端口（22）示例，供参考：\n#放行SSHD服务端口\n[root@bgx ~]# firewall-cmd --permanent --add-service=ssh --add-service=http \n#重载配\n[root@bgx ~]# firewall-cmd --reload\n#查看已放行端口\n[root@bgx ~]# firewall-cmd  --list-service\n\n3.安装fail2ban,需要有epel\n[root@bgx ~]# yum install fail2ban fail2ban-firewalld mailx -y\n\n4.配置fail2ban规则.local会覆盖.conf文件\n[root@bgx fail2ban]# cat /etc/fail2ban/jail.local\n[DEFAULT]\nignoreip = 127.0.0.1/8\nbantime  = 86400\nfindtime = 600\nmaxretry = 5\nbanaction = firewallcmd-ipset\naction = %(action_mwl)s\n\n[sshd]\nenabled = true\nfilter  = sshd\nport    = 22\naction = %(action_mwl)s\nlogpath = /var/log/secure\n\n5.启动服务，并检查状态\n[root@bgx ~]# systemctl start fail2ban.service\n[root@bgx ~]# fail2ban-client status sshd\n\n6.清除被封掉的IP地址\n[root@bgx ~]# fail2ban-client set sshd unbanip 10.0.0.1\n```\n\n","slug":"01_运维/02-综合架构/05-ssh服务跳板机搭建","published":1,"updated":"2022-07-11T05:52:30.725Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0e000la8v7daipc95f","content":"<h2 id=\"一、SSH服务器介绍\"><a href=\"#一、SSH服务器介绍\" class=\"headerlink\" title=\"一、SSH服务器介绍\"></a>一、SSH服务器介绍</h2><blockquote>\n<p>SSH是一个安全协议，在进行数据传输时，会对数据包进行加密处理，加密后在进行数据传输。确保了数据传输安全。</p>\n</blockquote>\n<p><img src=\"/img/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95.png\" alt=\"ssh免密登录\"></p>\n<h3 id=\"1-ssh的功能\"><a href=\"#1-ssh的功能\" class=\"headerlink\" title=\"1 ssh的功能\"></a>1 ssh的功能</h3><ol>\n<li>提供远程连接服务器的服务</li>\n<li>对传输的数据进行加密</li>\n</ol>\n<h3 id=\"2-常用服务的端口\"><a href=\"#2-常用服务的端口\" class=\"headerlink\" title=\"2 常用服务的端口\"></a>2 常用服务的端口</h3><ul>\n<li>ftp – tcp&#x2F;20  tcp&#x2F;21</li>\n<li>dns – tcp&#x2F;53  udp&#x2F;53</li>\n<li>ssh  –  tcp&#x2F;22</li>\n<li>telnet – tcp&#x2F;23 </li>\n<li>mysql – tcp&#x2F;3306</li>\n<li>http – tcp&#x2F;80</li>\n<li>https – tcp&#x2F;443</li>\n</ul>\n<h3 id=\"3-telnet服务搭建\"><a href=\"#3-telnet服务搭建\" class=\"headerlink\" title=\"3 telnet服务搭建\"></a>3 telnet服务搭建</h3><p>安装并启动telnet服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# yum install telnet-server -y\n[root@backup ~]# systemctl start telnet.socket \n[root@backup ~]# useradd gs\n[root@backup ~]# echo &quot;1&quot; | passwd --stdin gs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用终端软件通过telnet使用gs用户登录连接</p>\n<h3 id=\"4-telnet与ssh的对比\"><a href=\"#4-telnet与ssh的对比\" class=\"headerlink\" title=\"4 telnet与ssh的对比\"></a>4 telnet与ssh的对比</h3><table>\n<thead>\n<tr>\n<th>服务连接方式</th>\n<th>服务数据传输</th>\n<th>服务监听端口</th>\n<th>服务登陆用户</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ssh</td>\n<td>加密</td>\n<td>tcp&#x2F;22</td>\n<td>默认支持root登录</td>\n</tr>\n<tr>\n<td>telnet</td>\n<td>明文</td>\n<td>tcp&#x2F;23</td>\n<td>不支持root登录</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、ssh与scp的使用\"><a href=\"#二、ssh与scp的使用\" class=\"headerlink\" title=\"二、ssh与scp的使用\"></a>二、ssh与scp的使用</h2><h3 id=\"1-使用ssh\"><a href=\"#1-使用ssh\" class=\"headerlink\" title=\"1 使用ssh\"></a>1 使用ssh</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ssh命令\n\tssh 172.16.1.31\t\t\t\t\t#取决当前执行此命令的用户\n\tssh root@172.16.1.31\t\t\t#标准的写法\n\tssh -p22 root@172.16.1.31\t\t#带端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-使用scp\"><a href=\"#2-使用scp\" class=\"headerlink\" title=\"2 使用scp\"></a>2 使用scp</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">scp \n# -P 指定端口，默认22端口可不写\n# -r 表示递归拷贝目录\n# -p 表示在拷贝文件前后保持文件或目录属性不变\n# -l 限制传输使用带宽(默认kb) &#x2F;8 -&gt;KB  &#x2F;1024  -&gt;MB <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、使用ssh密钥登录\"><a href=\"#三、使用ssh密钥登录\" class=\"headerlink\" title=\"三、使用ssh密钥登录\"></a>三、使用ssh密钥登录</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.生成密钥对    公钥  私钥\n[root@m01 ~]# ssh-keygen -C 7242xxxxx@qq.com\n\t\n2.将公钥推送到你需要连接的主机，第一次需要输入对端主机的密码\n[root@m01 ~]# ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub root@172.16.1.31\nroot@172.16.1.31&#39;s password:\n\t\n3.通过ssh命令测试连接是否需要密码\n[root@m01 ~]# ssh 172.16.1.31\nLast login: Wed Jan  9 10:39:16 2019 from 172.16.1.61<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、ssh安全\"><a href=\"#四、ssh安全\" class=\"headerlink\" title=\"四、ssh安全\"></a>四、ssh安全</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@jumpserver ~]# vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n[root@jumpserver ~]# systemctl restart sshd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>SSH作为远程连接服务，通常我们需要考虑到该服务的安全，所以需要对该服务进行安全方面的配置。<br>1.更改远程连接登陆的端口\t\t6666<br>2.禁止ROOT管理员直接登录\t\t<br>3.密码认证方式改为密钥认证<br>4.重要服务不使用公网IP地址<br>5.使用防火墙限制来源IP地址</p>\n<p>Port 6666                       # 变更SSH服务远程连接端口√<br>PermitRootLogin         no      # 禁止root用户直接远程登录√<br>PasswordAuthentication  no      # 禁止使用密码直接远程登录√<br>UseDNS                  no      # 禁止ssh进行dns反向解析，影响ssh连接效率参数√<br>GSSAPIAuthentication    no      # 禁止GSS认证，减少连接时产生的延迟√</p>\n<h2 id=\"五、防ssh暴力破解工具fail2ban\"><a href=\"#五、防ssh暴力破解工具fail2ban\" class=\"headerlink\" title=\"五、防ssh暴力破解工具fail2ban\"></a>五、防ssh暴力破解工具fail2ban</h2><blockquote>\n<p>fail2ban可以监控系统日志，并且根据一定规则匹配异常IP后使用Firewalld将其屏蔽，尤其是针对一些爆破&#x2F;扫描等非常有效。</p>\n</blockquote>\n<p>部署流程</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.开启Firewalld防火墙\n[root@bgx ~]# systemctl start firewalld\n[root@bgx ~]# systemctl enable firewalld\n[root@bgx ~]# firewall-cmd --state\nrunning\n\n2.修改firewalld规则，启用Firewalld后会禁止一些服务的传输，但默认会放行常用的22端口, 如果想添加更多，以下是放行SSH端口（22）示例，供参考：\n#放行SSHD服务端口\n[root@bgx ~]# firewall-cmd --permanent --add-service&#x3D;ssh --add-service&#x3D;http \n#重载配\n[root@bgx ~]# firewall-cmd --reload\n#查看已放行端口\n[root@bgx ~]# firewall-cmd  --list-service\n\n3.安装fail2ban,需要有epel\n[root@bgx ~]# yum install fail2ban fail2ban-firewalld mailx -y\n\n4.配置fail2ban规则.local会覆盖.conf文件\n[root@bgx fail2ban]# cat &#x2F;etc&#x2F;fail2ban&#x2F;jail.local\n[DEFAULT]\nignoreip &#x3D; 127.0.0.1&#x2F;8\nbantime  &#x3D; 86400\nfindtime &#x3D; 600\nmaxretry &#x3D; 5\nbanaction &#x3D; firewallcmd-ipset\naction &#x3D; %(action_mwl)s\n\n[sshd]\nenabled &#x3D; true\nfilter  &#x3D; sshd\nport    &#x3D; 22\naction &#x3D; %(action_mwl)s\nlogpath &#x3D; &#x2F;var&#x2F;log&#x2F;secure\n\n5.启动服务，并检查状态\n[root@bgx ~]# systemctl start fail2ban.service\n[root@bgx ~]# fail2ban-client status sshd\n\n6.清除被封掉的IP地址\n[root@bgx ~]# fail2ban-client set sshd unbanip 10.0.0.1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、SSH服务器介绍\"><a href=\"#一、SSH服务器介绍\" class=\"headerlink\" title=\"一、SSH服务器介绍\"></a>一、SSH服务器介绍</h2><blockquote>\n<p>SSH是一个安全协议，在进行数据传输时，会对数据包进行加密处理，加密后在进行数据传输。确保了数据传输安全。</p>\n</blockquote>\n<p><img src=\"/img/ssh%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95.png\" alt=\"ssh免密登录\"></p>\n<h3 id=\"1-ssh的功能\"><a href=\"#1-ssh的功能\" class=\"headerlink\" title=\"1 ssh的功能\"></a>1 ssh的功能</h3><ol>\n<li>提供远程连接服务器的服务</li>\n<li>对传输的数据进行加密</li>\n</ol>\n<h3 id=\"2-常用服务的端口\"><a href=\"#2-常用服务的端口\" class=\"headerlink\" title=\"2 常用服务的端口\"></a>2 常用服务的端口</h3><ul>\n<li>ftp – tcp&#x2F;20  tcp&#x2F;21</li>\n<li>dns – tcp&#x2F;53  udp&#x2F;53</li>\n<li>ssh  –  tcp&#x2F;22</li>\n<li>telnet – tcp&#x2F;23 </li>\n<li>mysql – tcp&#x2F;3306</li>\n<li>http – tcp&#x2F;80</li>\n<li>https – tcp&#x2F;443</li>\n</ul>\n<h3 id=\"3-telnet服务搭建\"><a href=\"#3-telnet服务搭建\" class=\"headerlink\" title=\"3 telnet服务搭建\"></a>3 telnet服务搭建</h3><p>安装并启动telnet服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@backup ~]# yum install telnet-server -y\n[root@backup ~]# systemctl start telnet.socket \n[root@backup ~]# useradd gs\n[root@backup ~]# echo &quot;1&quot; | passwd --stdin gs<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用终端软件通过telnet使用gs用户登录连接</p>\n<h3 id=\"4-telnet与ssh的对比\"><a href=\"#4-telnet与ssh的对比\" class=\"headerlink\" title=\"4 telnet与ssh的对比\"></a>4 telnet与ssh的对比</h3><table>\n<thead>\n<tr>\n<th>服务连接方式</th>\n<th>服务数据传输</th>\n<th>服务监听端口</th>\n<th>服务登陆用户</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ssh</td>\n<td>加密</td>\n<td>tcp&#x2F;22</td>\n<td>默认支持root登录</td>\n</tr>\n<tr>\n<td>telnet</td>\n<td>明文</td>\n<td>tcp&#x2F;23</td>\n<td>不支持root登录</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、ssh与scp的使用\"><a href=\"#二、ssh与scp的使用\" class=\"headerlink\" title=\"二、ssh与scp的使用\"></a>二、ssh与scp的使用</h2><h3 id=\"1-使用ssh\"><a href=\"#1-使用ssh\" class=\"headerlink\" title=\"1 使用ssh\"></a>1 使用ssh</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ssh命令\n\tssh 172.16.1.31\t\t\t\t\t#取决当前执行此命令的用户\n\tssh root@172.16.1.31\t\t\t#标准的写法\n\tssh -p22 root@172.16.1.31\t\t#带端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-使用scp\"><a href=\"#2-使用scp\" class=\"headerlink\" title=\"2 使用scp\"></a>2 使用scp</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">scp \n# -P 指定端口，默认22端口可不写\n# -r 表示递归拷贝目录\n# -p 表示在拷贝文件前后保持文件或目录属性不变\n# -l 限制传输使用带宽(默认kb) &#x2F;8 -&gt;KB  &#x2F;1024  -&gt;MB <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、使用ssh密钥登录\"><a href=\"#三、使用ssh密钥登录\" class=\"headerlink\" title=\"三、使用ssh密钥登录\"></a>三、使用ssh密钥登录</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.生成密钥对    公钥  私钥\n[root@m01 ~]# ssh-keygen -C 7242xxxxx@qq.com\n\t\n2.将公钥推送到你需要连接的主机，第一次需要输入对端主机的密码\n[root@m01 ~]# ssh-copy-id -i ~&#x2F;.ssh&#x2F;id_rsa.pub root@172.16.1.31\nroot@172.16.1.31&#39;s password:\n\t\n3.通过ssh命令测试连接是否需要密码\n[root@m01 ~]# ssh 172.16.1.31\nLast login: Wed Jan  9 10:39:16 2019 from 172.16.1.61<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、ssh安全\"><a href=\"#四、ssh安全\" class=\"headerlink\" title=\"四、ssh安全\"></a>四、ssh安全</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@jumpserver ~]# vim &#x2F;etc&#x2F;ssh&#x2F;sshd_config\n[root@jumpserver ~]# systemctl restart sshd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>SSH作为远程连接服务，通常我们需要考虑到该服务的安全，所以需要对该服务进行安全方面的配置。<br>1.更改远程连接登陆的端口\t\t6666<br>2.禁止ROOT管理员直接登录\t\t<br>3.密码认证方式改为密钥认证<br>4.重要服务不使用公网IP地址<br>5.使用防火墙限制来源IP地址</p>\n<p>Port 6666                       # 变更SSH服务远程连接端口√<br>PermitRootLogin         no      # 禁止root用户直接远程登录√<br>PasswordAuthentication  no      # 禁止使用密码直接远程登录√<br>UseDNS                  no      # 禁止ssh进行dns反向解析，影响ssh连接效率参数√<br>GSSAPIAuthentication    no      # 禁止GSS认证，减少连接时产生的延迟√</p>\n<h2 id=\"五、防ssh暴力破解工具fail2ban\"><a href=\"#五、防ssh暴力破解工具fail2ban\" class=\"headerlink\" title=\"五、防ssh暴力破解工具fail2ban\"></a>五、防ssh暴力破解工具fail2ban</h2><blockquote>\n<p>fail2ban可以监控系统日志，并且根据一定规则匹配异常IP后使用Firewalld将其屏蔽，尤其是针对一些爆破&#x2F;扫描等非常有效。</p>\n</blockquote>\n<p>部署流程</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.开启Firewalld防火墙\n[root@bgx ~]# systemctl start firewalld\n[root@bgx ~]# systemctl enable firewalld\n[root@bgx ~]# firewall-cmd --state\nrunning\n\n2.修改firewalld规则，启用Firewalld后会禁止一些服务的传输，但默认会放行常用的22端口, 如果想添加更多，以下是放行SSH端口（22）示例，供参考：\n#放行SSHD服务端口\n[root@bgx ~]# firewall-cmd --permanent --add-service&#x3D;ssh --add-service&#x3D;http \n#重载配\n[root@bgx ~]# firewall-cmd --reload\n#查看已放行端口\n[root@bgx ~]# firewall-cmd  --list-service\n\n3.安装fail2ban,需要有epel\n[root@bgx ~]# yum install fail2ban fail2ban-firewalld mailx -y\n\n4.配置fail2ban规则.local会覆盖.conf文件\n[root@bgx fail2ban]# cat &#x2F;etc&#x2F;fail2ban&#x2F;jail.local\n[DEFAULT]\nignoreip &#x3D; 127.0.0.1&#x2F;8\nbantime  &#x3D; 86400\nfindtime &#x3D; 600\nmaxretry &#x3D; 5\nbanaction &#x3D; firewallcmd-ipset\naction &#x3D; %(action_mwl)s\n\n[sshd]\nenabled &#x3D; true\nfilter  &#x3D; sshd\nport    &#x3D; 22\naction &#x3D; %(action_mwl)s\nlogpath &#x3D; &#x2F;var&#x2F;log&#x2F;secure\n\n5.启动服务，并检查状态\n[root@bgx ~]# systemctl start fail2ban.service\n[root@bgx ~]# fail2ban-client status sshd\n\n6.清除被封掉的IP地址\n[root@bgx ~]# fail2ban-client set sshd unbanip 10.0.0.1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--04--Sersync实时备份","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、Sersync服务介绍\n\n>\n\n### 1 为什么要用sersync\n\n- sersync是基于inotify开发的，类似于inotify-tools的工具\n- sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录\n- 因为服务异常导致的同步失败有记录，便于恢复，确保高可用！\n\n### 2 rsync+inotify-tools与rsync+sersync架构的区别？\n\n- rsync+inotify-tools\n\n  a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；\n\n  b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低\n\n- rsync+sersync\n\n  a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；\n\n  b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。\n\n## 二、同步过程和原理\n\n### 1 同步过程\n\n1. 在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化\n2. 调用rsync命令把更新的文件同步到目标服务器；\n3. 需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务\n\n### 2 同步原理\n\n1. 用户实时的往sersync服务器上写入更新文件数据；\n2. 此时需要在同步主服务器上配置sersync服务；\n3. 在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；\n\n>通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，再调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器。\n\n## 三、案例\n\n>案例: 实现web上传视频文件，实则是写入NFS至存储，当NFS存在新的数据则会实时的复制到备份服务器\n\n| 角色       | 内网IP(LAN)      | 外网IP(NAT)    | 安装工具                         |\n| ---------- | ---------------- | -------------- | -------------------------------- |\n| web01      | eth1:172.16.1.7  | eth0:10.0.0.7  | httpd php                        |\n| nfs-server | eth1:172.16.1.31 | eth0:10.0.0.31 | nfsServer、rsync+inotify+sersync |\n| backup     | eth1:172.16.1.41 | eth0:10.0.0.41 | rsync-server                     |\n\n![sersync流程](/img/sersync流程-1628145534424.png)\n\n### 1 web上传视频至nfs存储\n\n```shell\nnfs存储服务  172.16.1.31\n\t1.安装\n\t\t[root@nfs ~]# yum install nfs-utils -y\n\t2.配置\n\t\t[root@nfs ~]# cat /etc/exports\n\t\t/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\t\t\n\t\t[root@nfs ~]# groupadd -g666 www\n\t\t[root@nfs ~]# useradd -u666 -g666 www\n\t\t\n\t\t[root@nfs ~]# mkdir /data\n\t\t[root@nfs ~]# chown -R www.www /data\n\t\t\n\t3.启动\n\t\t[root@nfs ~]# systemctl restart nfs-server\n\t\t[root@nfs ~]# sysytemctl enable nfs-server\n\t\t\nweb服务器操作：172.16.1.7\n\t1.安装\n\t\t[root@web01 ~]# yum install httpd php -y\n\t2.配置\n\t\t进程运行的身份（最好是和nfs的匿名用户保持一致）\n\t\t\t# sed c 匹配到User开头的字段，替换为User www\n\t\t\t[root@web01 html]# sed -i '/^User/c User www' /etc/httpd/conf/httpd.conf \t\n\t\t\t[root@web01 html]# sed -i '/^Group/c Group www' /etc/httpd/conf/httpd.conf\n\t\t挂载\n\t\t\t[root@web01 ~]# mount -t nfs 172.16.1.31:/data /var/www/html\t\t#核心\n\t\t上传代码\n\t\t\t[root@web01 ~]# cd /var/www/html/\n\t\t\t[root@web01 html]# rz kaoshi.zip\n\t\t\t[root@web01 html]# unzip kaoshi.zip\n\t3.启动\n\t\t[root@web01 ~]# systemctl start httpd\n\n\t4.修改上传大小\n\t\t[root@web01 ~]# vim /etc/php.ini中设置：\n\t\tupload_max_filesize = 200M;\n\t\tpost_max_size = 200M;\n\t\n\t5.注意: 修改完配置记得重启服务\n\t[root@web01 ~]#  systemctl restart httpd\n```\n\n### 2 web和nfs的数据都备份在备份服务器的/backup\n\n```shell\n备份服务器操作如下：172.16.1.41\n\t1.安装\n\t\t[root@backup ~]# yum install rsync -y\n\t2.配置\n\t\t[root@backup ~]# cat /etc/rsyncd.conf\n\t\tuid = www\n\t\tgid = www\n\t\tport = 873\n\t\tfake super = yes\n\t\tuse chroot = no\n\t\tmax connections = 200\n\t\ttimeout = 600\n\t\tignore errors\n\t\tread only = false\n\t\tlist = true\n\t\tauth users = rsync_backup\n\t\tsecrets file = /etc/rsync.passwd\n\t\tlog file = /var/log/rsyncd.log\n\t\t#####################################\n\t\t[backup]\n\t\tpath = /backup\n\t\t\n\t\t[data]\n\t\tpath = /data\n\t\t\n\t\t创建用户\n\t\t\t[root@backup ~]# groupadd -g666 www\n\t\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t\n\t\t准备虚拟连接用户账号和密码\n\t\t[root@backup ~]# cat /etc/rsync.passwd \n\t\trsync_backup:123456\n\t\t[root@backup ~]# chmod 600 /etc/rsync.passwd\n\t\t\n\t\t创建数据存放的目录\n\t\t[root@backup ~]# mkdir -p /data /backup\n\t\t[root@backup ~]# chown -R www.www /data/ /backup/\n\n\t3.启动\n\t\t[root@backup ~]# systemctl restart rsyncd\n\n\t4.客户端执行脚本。测试rsync的备份是否ok   （客户端的数据都写入到/backup目录中） 172.16.1.7 172.16.1.31\n\t[root@web01 ~]# sh /server/scripts/client_push_data.sh \n\tsending incremental file list\n\tweb01_172.16.1.7_2019-01-08/\n\tweb01_172.16.1.7_2019-01-08/flag_2019-01-08\n\tweb01_172.16.1.7_2019-01-08/other.tar.gz\n\tweb01_172.16.1.7_2019-01-08/sys.tar.gz\n```\n\n### 3 如何将nfs的数据实时的同步到备份服务器的/data目录\n\n```shell\n\t监控nfs服务器上面的/data目录，如果发生变化则触发动作，动作可以是执行一次同步。\n\t1.安装\n\t\t[root@nfs ~]# yum install inotify-tools\t\t监控工具\n\t\t\n\t\t[root@nfs ~]# rz -E sersync2.5.4_64bit_binary_stable_final.tar.gz\t\n\t\t[root@nfs ~]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz\n\t\t[root@nfs ~]# mv GNU-Linux-x86/ /usr/local/sersync\n\t2.配置\n\t\t[root@nfs sersync]# diff confxml.xml confxml.xml.bak\n        5c5\n        <     <fileSystem xfs=\"true\"/>\n        ---\n        >     <fileSystem xfs=\"false\"/>\n        15c15\n        <       <createFile start=\"true\"/>\n        ---\n        >       <createFile start=\"false\"/>\n        19,20c19,20\n        <       <attrib start=\"true\"/>\n        <       <modify start=\"true\"/>\n        ---\n        >       <attrib start=\"false\"/>\n        >       <modify start=\"false\"/>\n        24,25c24,25\n        <       <localpath watch=\"/data\">\n        <           <remote ip=\"172.16.1.41\" name=\"data\"/>\n        ---\n        >       <localpath watch=\"/opt/tongbu\">\n        >           <remote ip=\"127.0.0.1\" name=\"tongbu1\"/>\n        30,31c30,31\n        <           <commonParams params=\"-az\"/>\n        <           <auth start=\"true\" users=\"rsync_backup\" passwordfile=\"/etc/rsync.pass\"/>\n        ---\n        >           <commonParams params=\"-artuz\"/>\n        >           <auth start=\"false\" users=\"root\" passwordfile=\"/etc/rsync.pas\"/>\n        33c33\n        <           <timeout start=\"true\" time=\"100\"/><!-- timeout=100 -->\n        ---\n        >           <timeout start=\"false\" time=\"100\"/><!-- timeout=100 -->\n\n\t\t创建客户端密码文件\n\t\t[root@nfs ~]# cat /etc/rsync.pass\n\t\t123456\n\t\t[root@nfs ~]# chmod 600 /etc/rsync.pass\n\t\n\t3.启动\n\t[root@nfs ~]# /usr/local/sersync/sersync2  -h\n\tset the system param\n\texecute：echo 50000000 > /proc/sys/fs/inotify/max_user_watches\n\texecute：echo 327679 > /proc/sys/fs/inotify/max_queued_events\n\tparse the command param\n\t_______________________________________________________\n\t参数-d:启用守护进程模式\n\t参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍\n\t参数-n: 指定开启守护线程的数量，默认为10个\n\t参数-o:指定配置文件，默认使用confxml.xml文件\n\t参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块\n\t参数-m:单独启用其他模块，使用 -m socket 开启socket模块\n\t参数-m:单独启用其他模块，使用 -m http 开启http模块\n\t不加-m参数，则默认执行同步程序\n\n\t启动\n\t[root@nfs ~]#  /usr/local/sersync/sersync2 -dro /usr/local/sersync/confxml.xml\n\n\t#启动sersync后一定要提取同步的命令，手动运行一次，检查是否存在错误\n\t[root@nfs ~]#  cd /data && rsync -az -R --delete ./  --timeout=100 rsync_backup@172.16.1.41::data --password-file=/etc/rsync.pass\n\t\n\t停止\n\t[root@nfs data]# pkill sersync\n```\n\n### 4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）\n\n```shell\n\t1.backup服务器上需要运行和nfs服务器上一样的业务环境 \n\t\t创建用户\n\t\t[root@backup ~]# groupadd -g 666 www\n\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t配置\n\t\t[root@backup ~]# yum install -y nfs-utils -y\n\t\t[root@backup ~]# cat /etc/exports\n\t\t/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\t\t启动\n\t\t[root@backup ~]# systemctl restart nfs-server\n\t\t\n\t2.先实现实时的同步 √\n\n\t3.在web上实现切换，卸载nfs的/data目录，重新挂载backup服务的/data目录\n\t\t[root@web01 ~]# umount -lf /var/www/html/ && mount -t nfs 172.16.1.41:/data /var/www/html/\n```\n\n\n\n\n\n\n\n","source":"_posts/01_运维/02-综合架构/04-sersync实时同步备份.md","raw":"---\ntitle: 运维之综合架构--04--Sersync实时备份\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、Sersync服务介绍\n\n>\n\n### 1 为什么要用sersync\n\n- sersync是基于inotify开发的，类似于inotify-tools的工具\n- sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录\n- 因为服务异常导致的同步失败有记录，便于恢复，确保高可用！\n\n### 2 rsync+inotify-tools与rsync+sersync架构的区别？\n\n- rsync+inotify-tools\n\n  a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；\n\n  b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低\n\n- rsync+sersync\n\n  a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；\n\n  b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。\n\n## 二、同步过程和原理\n\n### 1 同步过程\n\n1. 在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化\n2. 调用rsync命令把更新的文件同步到目标服务器；\n3. 需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务\n\n### 2 同步原理\n\n1. 用户实时的往sersync服务器上写入更新文件数据；\n2. 此时需要在同步主服务器上配置sersync服务；\n3. 在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；\n\n>通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，再调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器。\n\n## 三、案例\n\n>案例: 实现web上传视频文件，实则是写入NFS至存储，当NFS存在新的数据则会实时的复制到备份服务器\n\n| 角色       | 内网IP(LAN)      | 外网IP(NAT)    | 安装工具                         |\n| ---------- | ---------------- | -------------- | -------------------------------- |\n| web01      | eth1:172.16.1.7  | eth0:10.0.0.7  | httpd php                        |\n| nfs-server | eth1:172.16.1.31 | eth0:10.0.0.31 | nfsServer、rsync+inotify+sersync |\n| backup     | eth1:172.16.1.41 | eth0:10.0.0.41 | rsync-server                     |\n\n![sersync流程](/img/sersync流程-1628145534424.png)\n\n### 1 web上传视频至nfs存储\n\n```shell\nnfs存储服务  172.16.1.31\n\t1.安装\n\t\t[root@nfs ~]# yum install nfs-utils -y\n\t2.配置\n\t\t[root@nfs ~]# cat /etc/exports\n\t\t/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\t\t\n\t\t[root@nfs ~]# groupadd -g666 www\n\t\t[root@nfs ~]# useradd -u666 -g666 www\n\t\t\n\t\t[root@nfs ~]# mkdir /data\n\t\t[root@nfs ~]# chown -R www.www /data\n\t\t\n\t3.启动\n\t\t[root@nfs ~]# systemctl restart nfs-server\n\t\t[root@nfs ~]# sysytemctl enable nfs-server\n\t\t\nweb服务器操作：172.16.1.7\n\t1.安装\n\t\t[root@web01 ~]# yum install httpd php -y\n\t2.配置\n\t\t进程运行的身份（最好是和nfs的匿名用户保持一致）\n\t\t\t# sed c 匹配到User开头的字段，替换为User www\n\t\t\t[root@web01 html]# sed -i '/^User/c User www' /etc/httpd/conf/httpd.conf \t\n\t\t\t[root@web01 html]# sed -i '/^Group/c Group www' /etc/httpd/conf/httpd.conf\n\t\t挂载\n\t\t\t[root@web01 ~]# mount -t nfs 172.16.1.31:/data /var/www/html\t\t#核心\n\t\t上传代码\n\t\t\t[root@web01 ~]# cd /var/www/html/\n\t\t\t[root@web01 html]# rz kaoshi.zip\n\t\t\t[root@web01 html]# unzip kaoshi.zip\n\t3.启动\n\t\t[root@web01 ~]# systemctl start httpd\n\n\t4.修改上传大小\n\t\t[root@web01 ~]# vim /etc/php.ini中设置：\n\t\tupload_max_filesize = 200M;\n\t\tpost_max_size = 200M;\n\t\n\t5.注意: 修改完配置记得重启服务\n\t[root@web01 ~]#  systemctl restart httpd\n```\n\n### 2 web和nfs的数据都备份在备份服务器的/backup\n\n```shell\n备份服务器操作如下：172.16.1.41\n\t1.安装\n\t\t[root@backup ~]# yum install rsync -y\n\t2.配置\n\t\t[root@backup ~]# cat /etc/rsyncd.conf\n\t\tuid = www\n\t\tgid = www\n\t\tport = 873\n\t\tfake super = yes\n\t\tuse chroot = no\n\t\tmax connections = 200\n\t\ttimeout = 600\n\t\tignore errors\n\t\tread only = false\n\t\tlist = true\n\t\tauth users = rsync_backup\n\t\tsecrets file = /etc/rsync.passwd\n\t\tlog file = /var/log/rsyncd.log\n\t\t#####################################\n\t\t[backup]\n\t\tpath = /backup\n\t\t\n\t\t[data]\n\t\tpath = /data\n\t\t\n\t\t创建用户\n\t\t\t[root@backup ~]# groupadd -g666 www\n\t\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t\n\t\t准备虚拟连接用户账号和密码\n\t\t[root@backup ~]# cat /etc/rsync.passwd \n\t\trsync_backup:123456\n\t\t[root@backup ~]# chmod 600 /etc/rsync.passwd\n\t\t\n\t\t创建数据存放的目录\n\t\t[root@backup ~]# mkdir -p /data /backup\n\t\t[root@backup ~]# chown -R www.www /data/ /backup/\n\n\t3.启动\n\t\t[root@backup ~]# systemctl restart rsyncd\n\n\t4.客户端执行脚本。测试rsync的备份是否ok   （客户端的数据都写入到/backup目录中） 172.16.1.7 172.16.1.31\n\t[root@web01 ~]# sh /server/scripts/client_push_data.sh \n\tsending incremental file list\n\tweb01_172.16.1.7_2019-01-08/\n\tweb01_172.16.1.7_2019-01-08/flag_2019-01-08\n\tweb01_172.16.1.7_2019-01-08/other.tar.gz\n\tweb01_172.16.1.7_2019-01-08/sys.tar.gz\n```\n\n### 3 如何将nfs的数据实时的同步到备份服务器的/data目录\n\n```shell\n\t监控nfs服务器上面的/data目录，如果发生变化则触发动作，动作可以是执行一次同步。\n\t1.安装\n\t\t[root@nfs ~]# yum install inotify-tools\t\t监控工具\n\t\t\n\t\t[root@nfs ~]# rz -E sersync2.5.4_64bit_binary_stable_final.tar.gz\t\n\t\t[root@nfs ~]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz\n\t\t[root@nfs ~]# mv GNU-Linux-x86/ /usr/local/sersync\n\t2.配置\n\t\t[root@nfs sersync]# diff confxml.xml confxml.xml.bak\n        5c5\n        <     <fileSystem xfs=\"true\"/>\n        ---\n        >     <fileSystem xfs=\"false\"/>\n        15c15\n        <       <createFile start=\"true\"/>\n        ---\n        >       <createFile start=\"false\"/>\n        19,20c19,20\n        <       <attrib start=\"true\"/>\n        <       <modify start=\"true\"/>\n        ---\n        >       <attrib start=\"false\"/>\n        >       <modify start=\"false\"/>\n        24,25c24,25\n        <       <localpath watch=\"/data\">\n        <           <remote ip=\"172.16.1.41\" name=\"data\"/>\n        ---\n        >       <localpath watch=\"/opt/tongbu\">\n        >           <remote ip=\"127.0.0.1\" name=\"tongbu1\"/>\n        30,31c30,31\n        <           <commonParams params=\"-az\"/>\n        <           <auth start=\"true\" users=\"rsync_backup\" passwordfile=\"/etc/rsync.pass\"/>\n        ---\n        >           <commonParams params=\"-artuz\"/>\n        >           <auth start=\"false\" users=\"root\" passwordfile=\"/etc/rsync.pas\"/>\n        33c33\n        <           <timeout start=\"true\" time=\"100\"/><!-- timeout=100 -->\n        ---\n        >           <timeout start=\"false\" time=\"100\"/><!-- timeout=100 -->\n\n\t\t创建客户端密码文件\n\t\t[root@nfs ~]# cat /etc/rsync.pass\n\t\t123456\n\t\t[root@nfs ~]# chmod 600 /etc/rsync.pass\n\t\n\t3.启动\n\t[root@nfs ~]# /usr/local/sersync/sersync2  -h\n\tset the system param\n\texecute：echo 50000000 > /proc/sys/fs/inotify/max_user_watches\n\texecute：echo 327679 > /proc/sys/fs/inotify/max_queued_events\n\tparse the command param\n\t_______________________________________________________\n\t参数-d:启用守护进程模式\n\t参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍\n\t参数-n: 指定开启守护线程的数量，默认为10个\n\t参数-o:指定配置文件，默认使用confxml.xml文件\n\t参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块\n\t参数-m:单独启用其他模块，使用 -m socket 开启socket模块\n\t参数-m:单独启用其他模块，使用 -m http 开启http模块\n\t不加-m参数，则默认执行同步程序\n\n\t启动\n\t[root@nfs ~]#  /usr/local/sersync/sersync2 -dro /usr/local/sersync/confxml.xml\n\n\t#启动sersync后一定要提取同步的命令，手动运行一次，检查是否存在错误\n\t[root@nfs ~]#  cd /data && rsync -az -R --delete ./  --timeout=100 rsync_backup@172.16.1.41::data --password-file=/etc/rsync.pass\n\t\n\t停止\n\t[root@nfs data]# pkill sersync\n```\n\n### 4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）\n\n```shell\n\t1.backup服务器上需要运行和nfs服务器上一样的业务环境 \n\t\t创建用户\n\t\t[root@backup ~]# groupadd -g 666 www\n\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t配置\n\t\t[root@backup ~]# yum install -y nfs-utils -y\n\t\t[root@backup ~]# cat /etc/exports\n\t\t/data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\t\t启动\n\t\t[root@backup ~]# systemctl restart nfs-server\n\t\t\n\t2.先实现实时的同步 √\n\n\t3.在web上实现切换，卸载nfs的/data目录，重新挂载backup服务的/data目录\n\t\t[root@web01 ~]# umount -lf /var/www/html/ && mount -t nfs 172.16.1.41:/data /var/www/html/\n```\n\n\n\n\n\n\n\n","slug":"01_运维/02-综合架构/04-sersync实时同步备份","published":1,"updated":"2022-07-11T05:52:13.498Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0f000oa8v7hywvb4q9","content":"<h2 id=\"一、Sersync服务介绍\"><a href=\"#一、Sersync服务介绍\" class=\"headerlink\" title=\"一、Sersync服务介绍\"></a>一、Sersync服务介绍</h2><blockquote>\n</blockquote>\n<h3 id=\"1-为什么要用sersync\"><a href=\"#1-为什么要用sersync\" class=\"headerlink\" title=\"1 为什么要用sersync\"></a>1 为什么要用sersync</h3><ul>\n<li>sersync是基于inotify开发的，类似于inotify-tools的工具</li>\n<li>sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录</li>\n<li>因为服务异常导致的同步失败有记录，便于恢复，确保高可用！</li>\n</ul>\n<h3 id=\"2-rsync-inotify-tools与rsync-sersync架构的区别？\"><a href=\"#2-rsync-inotify-tools与rsync-sersync架构的区别？\" class=\"headerlink\" title=\"2 rsync+inotify-tools与rsync+sersync架构的区别？\"></a>2 rsync+inotify-tools与rsync+sersync架构的区别？</h3><ul>\n<li><p>rsync+inotify-tools</p>\n<p>a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；</p>\n<p>b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低</p>\n</li>\n<li><p>rsync+sersync</p>\n<p>a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；</p>\n<p>b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。</p>\n</li>\n</ul>\n<h2 id=\"二、同步过程和原理\"><a href=\"#二、同步过程和原理\" class=\"headerlink\" title=\"二、同步过程和原理\"></a>二、同步过程和原理</h2><h3 id=\"1-同步过程\"><a href=\"#1-同步过程\" class=\"headerlink\" title=\"1 同步过程\"></a>1 同步过程</h3><ol>\n<li>在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化</li>\n<li>调用rsync命令把更新的文件同步到目标服务器；</li>\n<li>需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务</li>\n</ol>\n<h3 id=\"2-同步原理\"><a href=\"#2-同步原理\" class=\"headerlink\" title=\"2 同步原理\"></a>2 同步原理</h3><ol>\n<li>用户实时的往sersync服务器上写入更新文件数据；</li>\n<li>此时需要在同步主服务器上配置sersync服务；</li>\n<li>在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；</li>\n</ol>\n<blockquote>\n<p>通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，再调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器。</p>\n</blockquote>\n<h2 id=\"三、案例\"><a href=\"#三、案例\" class=\"headerlink\" title=\"三、案例\"></a>三、案例</h2><blockquote>\n<p>案例: 实现web上传视频文件，实则是写入NFS至存储，当NFS存在新的数据则会实时的复制到备份服务器</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>角色</th>\n<th>内网IP(LAN)</th>\n<th>外网IP(NAT)</th>\n<th>安装工具</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>eth1:172.16.1.7</td>\n<td>eth0:10.0.0.7</td>\n<td>httpd php</td>\n</tr>\n<tr>\n<td>nfs-server</td>\n<td>eth1:172.16.1.31</td>\n<td>eth0:10.0.0.31</td>\n<td>nfsServer、rsync+inotify+sersync</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>eth1:172.16.1.41</td>\n<td>eth0:10.0.0.41</td>\n<td>rsync-server</td>\n</tr>\n</tbody></table>\n<p><img src=\"/img/sersync%E6%B5%81%E7%A8%8B-1628145534424.png\" alt=\"sersync流程\"></p>\n<h3 id=\"1-web上传视频至nfs存储\"><a href=\"#1-web上传视频至nfs存储\" class=\"headerlink\" title=\"1 web上传视频至nfs存储\"></a>1 web上传视频至nfs存储</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nfs存储服务  172.16.1.31\n\t1.安装\n\t\t[root@nfs ~]# yum install nfs-utils -y\n\t2.配置\n\t\t[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n\t\t&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\t\t\n\t\t[root@nfs ~]# groupadd -g666 www\n\t\t[root@nfs ~]# useradd -u666 -g666 www\n\t\t\n\t\t[root@nfs ~]# mkdir &#x2F;data\n\t\t[root@nfs ~]# chown -R www.www &#x2F;data\n\t\t\n\t3.启动\n\t\t[root@nfs ~]# systemctl restart nfs-server\n\t\t[root@nfs ~]# sysytemctl enable nfs-server\n\t\t\nweb服务器操作：172.16.1.7\n\t1.安装\n\t\t[root@web01 ~]# yum install httpd php -y\n\t2.配置\n\t\t进程运行的身份（最好是和nfs的匿名用户保持一致）\n\t\t\t# sed c 匹配到User开头的字段，替换为User www\n\t\t\t[root@web01 html]# sed -i &#39;&#x2F;^User&#x2F;c User www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf \t\n\t\t\t[root@web01 html]# sed -i &#39;&#x2F;^Group&#x2F;c Group www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf\n\t\t挂载\n\t\t\t[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;var&#x2F;www&#x2F;html\t\t#核心\n\t\t上传代码\n\t\t\t[root@web01 ~]# cd &#x2F;var&#x2F;www&#x2F;html&#x2F;\n\t\t\t[root@web01 html]# rz kaoshi.zip\n\t\t\t[root@web01 html]# unzip kaoshi.zip\n\t3.启动\n\t\t[root@web01 ~]# systemctl start httpd\n\n\t4.修改上传大小\n\t\t[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini中设置：\n\t\tupload_max_filesize &#x3D; 200M;\n\t\tpost_max_size &#x3D; 200M;\n\t\n\t5.注意: 修改完配置记得重启服务\n\t[root@web01 ~]#  systemctl restart httpd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-web和nfs的数据都备份在备份服务器的-x2F-backup\"><a href=\"#2-web和nfs的数据都备份在备份服务器的-x2F-backup\" class=\"headerlink\" title=\"2 web和nfs的数据都备份在备份服务器的&#x2F;backup\"></a>2 web和nfs的数据都备份在备份服务器的&#x2F;backup</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">备份服务器操作如下：172.16.1.41\n\t1.安装\n\t\t[root@backup ~]# yum install rsync -y\n\t2.配置\n\t\t[root@backup ~]# cat &#x2F;etc&#x2F;rsyncd.conf\n\t\tuid &#x3D; www\n\t\tgid &#x3D; www\n\t\tport &#x3D; 873\n\t\tfake super &#x3D; yes\n\t\tuse chroot &#x3D; no\n\t\tmax connections &#x3D; 200\n\t\ttimeout &#x3D; 600\n\t\tignore errors\n\t\tread only &#x3D; false\n\t\tlist &#x3D; true\n\t\tauth users &#x3D; rsync_backup\n\t\tsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd\n\t\tlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log\n\t\t#####################################\n\t\t[backup]\n\t\tpath &#x3D; &#x2F;backup\n\t\t\n\t\t[data]\n\t\tpath &#x3D; &#x2F;data\n\t\t\n\t\t创建用户\n\t\t\t[root@backup ~]# groupadd -g666 www\n\t\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t\n\t\t准备虚拟连接用户账号和密码\n\t\t[root@backup ~]# cat &#x2F;etc&#x2F;rsync.passwd \n\t\trsync_backup:123456\n\t\t[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd\n\t\t\n\t\t创建数据存放的目录\n\t\t[root@backup ~]# mkdir -p &#x2F;data &#x2F;backup\n\t\t[root@backup ~]# chown -R www.www &#x2F;data&#x2F; &#x2F;backup&#x2F;\n\n\t3.启动\n\t\t[root@backup ~]# systemctl restart rsyncd\n\n\t4.客户端执行脚本。测试rsync的备份是否ok   （客户端的数据都写入到&#x2F;backup目录中） 172.16.1.7 172.16.1.31\n\t[root@web01 ~]# sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh \n\tsending incremental file list\n\tweb01_172.16.1.7_2019-01-08&#x2F;\n\tweb01_172.16.1.7_2019-01-08&#x2F;flag_2019-01-08\n\tweb01_172.16.1.7_2019-01-08&#x2F;other.tar.gz\n\tweb01_172.16.1.7_2019-01-08&#x2F;sys.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录\"><a href=\"#3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录\" class=\"headerlink\" title=\"3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录\"></a>3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">监控nfs服务器上面的&#x2F;data目录，如果发生变化则触发动作，动作可以是执行一次同步。\n1.安装\n\t[root@nfs ~]# yum install inotify-tools\t\t监控工具\n\t\n\t[root@nfs ~]# rz -E sersync2.5.4_64bit_binary_stable_final.tar.gz\t\n\t[root@nfs ~]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz\n\t[root@nfs ~]# mv GNU-Linux-x86&#x2F; &#x2F;usr&#x2F;local&#x2F;sersync\n2.配置\n\t[root@nfs sersync]# diff confxml.xml confxml.xml.bak\n       5c5\n       &lt;     &lt;fileSystem xfs&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;     &lt;fileSystem xfs&#x3D;&quot;false&quot;&#x2F;&gt;\n       15c15\n       &lt;       &lt;createFile start&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;createFile start&#x3D;&quot;false&quot;&#x2F;&gt;\n       19,20c19,20\n       &lt;       &lt;attrib start&#x3D;&quot;true&quot;&#x2F;&gt;\n       &lt;       &lt;modify start&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;attrib start&#x3D;&quot;false&quot;&#x2F;&gt;\n       &gt;       &lt;modify start&#x3D;&quot;false&quot;&#x2F;&gt;\n       24,25c24,25\n       &lt;       &lt;localpath watch&#x3D;&quot;&#x2F;data&quot;&gt;\n       &lt;           &lt;remote ip&#x3D;&quot;172.16.1.41&quot; name&#x3D;&quot;data&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;localpath watch&#x3D;&quot;&#x2F;opt&#x2F;tongbu&quot;&gt;\n       &gt;           &lt;remote ip&#x3D;&quot;127.0.0.1&quot; name&#x3D;&quot;tongbu1&quot;&#x2F;&gt;\n       30,31c30,31\n       &lt;           &lt;commonParams params&#x3D;&quot;-az&quot;&#x2F;&gt;\n       &lt;           &lt;auth start&#x3D;&quot;true&quot; users&#x3D;&quot;rsync_backup&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pass&quot;&#x2F;&gt;\n       ---\n       &gt;           &lt;commonParams params&#x3D;&quot;-artuz&quot;&#x2F;&gt;\n       &gt;           &lt;auth start&#x3D;&quot;false&quot; users&#x3D;&quot;root&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pas&quot;&#x2F;&gt;\n       33c33\n       &lt;           &lt;timeout start&#x3D;&quot;true&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;\n       ---\n       &gt;           &lt;timeout start&#x3D;&quot;false&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;\n\n\t创建客户端密码文件\n\t[root@nfs ~]# cat &#x2F;etc&#x2F;rsync.pass\n\t123456\n\t[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass\n\n3.启动\n[root@nfs ~]# &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2  -h\nset the system param\nexecute：echo 50000000 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_user_watches\nexecute：echo 327679 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_queued_events\nparse the command param\n_______________________________________________________\n参数-d:启用守护进程模式\n参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍\n参数-n: 指定开启守护线程的数量，默认为10个\n参数-o:指定配置文件，默认使用confxml.xml文件\n参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块\n参数-m:单独启用其他模块，使用 -m socket 开启socket模块\n参数-m:单独启用其他模块，使用 -m http 开启http模块\n不加-m参数，则默认执行同步程序\n\n启动\n[root@nfs ~]#  &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2 -dro &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;confxml.xml\n\n#启动sersync后一定要提取同步的命令，手动运行一次，检查是否存在错误\n[root@nfs ~]#  cd &#x2F;data &amp;&amp; rsync -az -R --delete .&#x2F;  --timeout&#x3D;100 rsync_backup@172.16.1.41::data --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass\n\n停止\n[root@nfs data]# pkill sersync<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）\"><a href=\"#4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）\" class=\"headerlink\" title=\"4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）\"></a>4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.backup服务器上需要运行和nfs服务器上一样的业务环境 \n\t创建用户\n\t[root@backup ~]# groupadd -g 666 www\n\t[root@backup ~]# useradd -u666 -g666 www\n\t配置\n\t[root@backup ~]# yum install -y nfs-utils -y\n\t[root@backup ~]# cat &#x2F;etc&#x2F;exports\n\t&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\t启动\n\t[root@backup ~]# systemctl restart nfs-server\n\t\n2.先实现实时的同步 √\n\n3.在web上实现切换，卸载nfs的&#x2F;data目录，重新挂载backup服务的&#x2F;data目录\n\t[root@web01 ~]# umount -lf &#x2F;var&#x2F;www&#x2F;html&#x2F; &amp;&amp; mount -t nfs 172.16.1.41:&#x2F;data &#x2F;var&#x2F;www&#x2F;html&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Sersync服务介绍\"><a href=\"#一、Sersync服务介绍\" class=\"headerlink\" title=\"一、Sersync服务介绍\"></a>一、Sersync服务介绍</h2><blockquote>\n</blockquote>\n<h3 id=\"1-为什么要用sersync\"><a href=\"#1-为什么要用sersync\" class=\"headerlink\" title=\"1 为什么要用sersync\"></a>1 为什么要用sersync</h3><ul>\n<li>sersync是基于inotify开发的，类似于inotify-tools的工具</li>\n<li>sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或者某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的文件或者目录</li>\n<li>因为服务异常导致的同步失败有记录，便于恢复，确保高可用！</li>\n</ul>\n<h3 id=\"2-rsync-inotify-tools与rsync-sersync架构的区别？\"><a href=\"#2-rsync-inotify-tools与rsync-sersync架构的区别？\" class=\"headerlink\" title=\"2 rsync+inotify-tools与rsync+sersync架构的区别？\"></a>2 rsync+inotify-tools与rsync+sersync架构的区别？</h3><ul>\n<li><p>rsync+inotify-tools</p>\n<p>a、inotify只能记录下被监听的目录发生了变化（增，删，改）并没有把具体是哪个文件或者哪个目录发生了变化记录下来；</p>\n<p>b、rsync在同步的时候，并不知道具体是哪个文件或目录发生了变化，每次都是对整个目录进行同步，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此效率很低</p>\n</li>\n<li><p>rsync+sersync</p>\n<p>a、sersync可以记录被监听目录中发生变化的（增，删，改）具体某个文件或目录的名字；</p>\n<p>b、rsync在同步时，只同步发生变化的文件或目录（每次发生变化的数据相对整个同步目录数据来说很小，rsync在遍历查找对比文件时，速度很快），因此效率很高。</p>\n</li>\n</ul>\n<h2 id=\"二、同步过程和原理\"><a href=\"#二、同步过程和原理\" class=\"headerlink\" title=\"二、同步过程和原理\"></a>二、同步过程和原理</h2><h3 id=\"1-同步过程\"><a href=\"#1-同步过程\" class=\"headerlink\" title=\"1 同步过程\"></a>1 同步过程</h3><ol>\n<li>在同步服务器上开启sersync服务，sersync负责监控配置路径中的文件系统事件变化</li>\n<li>调用rsync命令把更新的文件同步到目标服务器；</li>\n<li>需要在主服务器配置sersync，在同步目标服务器配置rsync server（注意：是rsync服务</li>\n</ol>\n<h3 id=\"2-同步原理\"><a href=\"#2-同步原理\" class=\"headerlink\" title=\"2 同步原理\"></a>2 同步原理</h3><ol>\n<li>用户实时的往sersync服务器上写入更新文件数据；</li>\n<li>此时需要在同步主服务器上配置sersync服务；</li>\n<li>在另一台服务器开启rsync守护进程服务，以同步拉取来自sersync服务器上的数据；</li>\n</ol>\n<blockquote>\n<p>通过rsync的守护进程服务后可以发现，实际上sersync就是监控本地的数据写入或更新事件；然后，再调用rsync客户端的命令，将写入或更新事件对应的文件通过rsync推送到目标服务器。</p>\n</blockquote>\n<h2 id=\"三、案例\"><a href=\"#三、案例\" class=\"headerlink\" title=\"三、案例\"></a>三、案例</h2><blockquote>\n<p>案例: 实现web上传视频文件，实则是写入NFS至存储，当NFS存在新的数据则会实时的复制到备份服务器</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>角色</th>\n<th>内网IP(LAN)</th>\n<th>外网IP(NAT)</th>\n<th>安装工具</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>eth1:172.16.1.7</td>\n<td>eth0:10.0.0.7</td>\n<td>httpd php</td>\n</tr>\n<tr>\n<td>nfs-server</td>\n<td>eth1:172.16.1.31</td>\n<td>eth0:10.0.0.31</td>\n<td>nfsServer、rsync+inotify+sersync</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>eth1:172.16.1.41</td>\n<td>eth0:10.0.0.41</td>\n<td>rsync-server</td>\n</tr>\n</tbody></table>\n<p><img src=\"/img/sersync%E6%B5%81%E7%A8%8B-1628145534424.png\" alt=\"sersync流程\"></p>\n<h3 id=\"1-web上传视频至nfs存储\"><a href=\"#1-web上传视频至nfs存储\" class=\"headerlink\" title=\"1 web上传视频至nfs存储\"></a>1 web上传视频至nfs存储</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nfs存储服务  172.16.1.31\n\t1.安装\n\t\t[root@nfs ~]# yum install nfs-utils -y\n\t2.配置\n\t\t[root@nfs ~]# cat &#x2F;etc&#x2F;exports\n\t\t&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\t\t\n\t\t[root@nfs ~]# groupadd -g666 www\n\t\t[root@nfs ~]# useradd -u666 -g666 www\n\t\t\n\t\t[root@nfs ~]# mkdir &#x2F;data\n\t\t[root@nfs ~]# chown -R www.www &#x2F;data\n\t\t\n\t3.启动\n\t\t[root@nfs ~]# systemctl restart nfs-server\n\t\t[root@nfs ~]# sysytemctl enable nfs-server\n\t\t\nweb服务器操作：172.16.1.7\n\t1.安装\n\t\t[root@web01 ~]# yum install httpd php -y\n\t2.配置\n\t\t进程运行的身份（最好是和nfs的匿名用户保持一致）\n\t\t\t# sed c 匹配到User开头的字段，替换为User www\n\t\t\t[root@web01 html]# sed -i &#39;&#x2F;^User&#x2F;c User www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf \t\n\t\t\t[root@web01 html]# sed -i &#39;&#x2F;^Group&#x2F;c Group www&#39; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf\n\t\t挂载\n\t\t\t[root@web01 ~]# mount -t nfs 172.16.1.31:&#x2F;data &#x2F;var&#x2F;www&#x2F;html\t\t#核心\n\t\t上传代码\n\t\t\t[root@web01 ~]# cd &#x2F;var&#x2F;www&#x2F;html&#x2F;\n\t\t\t[root@web01 html]# rz kaoshi.zip\n\t\t\t[root@web01 html]# unzip kaoshi.zip\n\t3.启动\n\t\t[root@web01 ~]# systemctl start httpd\n\n\t4.修改上传大小\n\t\t[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini中设置：\n\t\tupload_max_filesize &#x3D; 200M;\n\t\tpost_max_size &#x3D; 200M;\n\t\n\t5.注意: 修改完配置记得重启服务\n\t[root@web01 ~]#  systemctl restart httpd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-web和nfs的数据都备份在备份服务器的-x2F-backup\"><a href=\"#2-web和nfs的数据都备份在备份服务器的-x2F-backup\" class=\"headerlink\" title=\"2 web和nfs的数据都备份在备份服务器的&#x2F;backup\"></a>2 web和nfs的数据都备份在备份服务器的&#x2F;backup</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">备份服务器操作如下：172.16.1.41\n\t1.安装\n\t\t[root@backup ~]# yum install rsync -y\n\t2.配置\n\t\t[root@backup ~]# cat &#x2F;etc&#x2F;rsyncd.conf\n\t\tuid &#x3D; www\n\t\tgid &#x3D; www\n\t\tport &#x3D; 873\n\t\tfake super &#x3D; yes\n\t\tuse chroot &#x3D; no\n\t\tmax connections &#x3D; 200\n\t\ttimeout &#x3D; 600\n\t\tignore errors\n\t\tread only &#x3D; false\n\t\tlist &#x3D; true\n\t\tauth users &#x3D; rsync_backup\n\t\tsecrets file &#x3D; &#x2F;etc&#x2F;rsync.passwd\n\t\tlog file &#x3D; &#x2F;var&#x2F;log&#x2F;rsyncd.log\n\t\t#####################################\n\t\t[backup]\n\t\tpath &#x3D; &#x2F;backup\n\t\t\n\t\t[data]\n\t\tpath &#x3D; &#x2F;data\n\t\t\n\t\t创建用户\n\t\t\t[root@backup ~]# groupadd -g666 www\n\t\t\t[root@backup ~]# useradd -u666 -g666 www\n\t\t\n\t\t准备虚拟连接用户账号和密码\n\t\t[root@backup ~]# cat &#x2F;etc&#x2F;rsync.passwd \n\t\trsync_backup:123456\n\t\t[root@backup ~]# chmod 600 &#x2F;etc&#x2F;rsync.passwd\n\t\t\n\t\t创建数据存放的目录\n\t\t[root@backup ~]# mkdir -p &#x2F;data &#x2F;backup\n\t\t[root@backup ~]# chown -R www.www &#x2F;data&#x2F; &#x2F;backup&#x2F;\n\n\t3.启动\n\t\t[root@backup ~]# systemctl restart rsyncd\n\n\t4.客户端执行脚本。测试rsync的备份是否ok   （客户端的数据都写入到&#x2F;backup目录中） 172.16.1.7 172.16.1.31\n\t[root@web01 ~]# sh &#x2F;server&#x2F;scripts&#x2F;client_push_data.sh \n\tsending incremental file list\n\tweb01_172.16.1.7_2019-01-08&#x2F;\n\tweb01_172.16.1.7_2019-01-08&#x2F;flag_2019-01-08\n\tweb01_172.16.1.7_2019-01-08&#x2F;other.tar.gz\n\tweb01_172.16.1.7_2019-01-08&#x2F;sys.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录\"><a href=\"#3-如何将nfs的数据实时的同步到备份服务器的-x2F-data目录\" class=\"headerlink\" title=\"3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录\"></a>3 如何将nfs的数据实时的同步到备份服务器的&#x2F;data目录</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">监控nfs服务器上面的&#x2F;data目录，如果发生变化则触发动作，动作可以是执行一次同步。\n1.安装\n\t[root@nfs ~]# yum install inotify-tools\t\t监控工具\n\t\n\t[root@nfs ~]# rz -E sersync2.5.4_64bit_binary_stable_final.tar.gz\t\n\t[root@nfs ~]# tar xf sersync2.5.4_64bit_binary_stable_final.tar.gz\n\t[root@nfs ~]# mv GNU-Linux-x86&#x2F; &#x2F;usr&#x2F;local&#x2F;sersync\n2.配置\n\t[root@nfs sersync]# diff confxml.xml confxml.xml.bak\n       5c5\n       &lt;     &lt;fileSystem xfs&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;     &lt;fileSystem xfs&#x3D;&quot;false&quot;&#x2F;&gt;\n       15c15\n       &lt;       &lt;createFile start&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;createFile start&#x3D;&quot;false&quot;&#x2F;&gt;\n       19,20c19,20\n       &lt;       &lt;attrib start&#x3D;&quot;true&quot;&#x2F;&gt;\n       &lt;       &lt;modify start&#x3D;&quot;true&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;attrib start&#x3D;&quot;false&quot;&#x2F;&gt;\n       &gt;       &lt;modify start&#x3D;&quot;false&quot;&#x2F;&gt;\n       24,25c24,25\n       &lt;       &lt;localpath watch&#x3D;&quot;&#x2F;data&quot;&gt;\n       &lt;           &lt;remote ip&#x3D;&quot;172.16.1.41&quot; name&#x3D;&quot;data&quot;&#x2F;&gt;\n       ---\n       &gt;       &lt;localpath watch&#x3D;&quot;&#x2F;opt&#x2F;tongbu&quot;&gt;\n       &gt;           &lt;remote ip&#x3D;&quot;127.0.0.1&quot; name&#x3D;&quot;tongbu1&quot;&#x2F;&gt;\n       30,31c30,31\n       &lt;           &lt;commonParams params&#x3D;&quot;-az&quot;&#x2F;&gt;\n       &lt;           &lt;auth start&#x3D;&quot;true&quot; users&#x3D;&quot;rsync_backup&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pass&quot;&#x2F;&gt;\n       ---\n       &gt;           &lt;commonParams params&#x3D;&quot;-artuz&quot;&#x2F;&gt;\n       &gt;           &lt;auth start&#x3D;&quot;false&quot; users&#x3D;&quot;root&quot; passwordfile&#x3D;&quot;&#x2F;etc&#x2F;rsync.pas&quot;&#x2F;&gt;\n       33c33\n       &lt;           &lt;timeout start&#x3D;&quot;true&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;\n       ---\n       &gt;           &lt;timeout start&#x3D;&quot;false&quot; time&#x3D;&quot;100&quot;&#x2F;&gt;&lt;!-- timeout&#x3D;100 --&gt;\n\n\t创建客户端密码文件\n\t[root@nfs ~]# cat &#x2F;etc&#x2F;rsync.pass\n\t123456\n\t[root@nfs ~]# chmod 600 &#x2F;etc&#x2F;rsync.pass\n\n3.启动\n[root@nfs ~]# &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2  -h\nset the system param\nexecute：echo 50000000 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_user_watches\nexecute：echo 327679 &gt; &#x2F;proc&#x2F;sys&#x2F;fs&#x2F;inotify&#x2F;max_queued_events\nparse the command param\n_______________________________________________________\n参数-d:启用守护进程模式\n参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍\n参数-n: 指定开启守护线程的数量，默认为10个\n参数-o:指定配置文件，默认使用confxml.xml文件\n参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块\n参数-m:单独启用其他模块，使用 -m socket 开启socket模块\n参数-m:单独启用其他模块，使用 -m http 开启http模块\n不加-m参数，则默认执行同步程序\n\n启动\n[root@nfs ~]#  &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;sersync2 -dro &#x2F;usr&#x2F;local&#x2F;sersync&#x2F;confxml.xml\n\n#启动sersync后一定要提取同步的命令，手动运行一次，检查是否存在错误\n[root@nfs ~]#  cd &#x2F;data &amp;&amp; rsync -az -R --delete .&#x2F;  --timeout&#x3D;100 rsync_backup@172.16.1.41::data --password-file&#x3D;&#x2F;etc&#x2F;rsync.pass\n\n停止\n[root@nfs data]# pkill sersync<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）\"><a href=\"#4-如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup-（不能出现业务中断）\" class=\"headerlink\" title=\"4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）\"></a>4 如何平滑的迁移nfs数据到backup服务器。并且让后续的上传都是上传至backup   （不能出现业务中断）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.backup服务器上需要运行和nfs服务器上一样的业务环境 \n\t创建用户\n\t[root@backup ~]# groupadd -g 666 www\n\t[root@backup ~]# useradd -u666 -g666 www\n\t配置\n\t[root@backup ~]# yum install -y nfs-utils -y\n\t[root@backup ~]# cat &#x2F;etc&#x2F;exports\n\t&#x2F;data 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\t启动\n\t[root@backup ~]# systemctl restart nfs-server\n\t\n2.先实现实时的同步 √\n\n3.在web上实现切换，卸载nfs的&#x2F;data目录，重新挂载backup服务的&#x2F;data目录\n\t[root@web01 ~]# umount -lf &#x2F;var&#x2F;www&#x2F;html&#x2F; &amp;&amp; mount -t nfs 172.16.1.41:&#x2F;data &#x2F;var&#x2F;www&#x2F;html&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n"},{"title":"运维之综合架构--06--HTTP协议介绍","date":"2022-07-06T03:19:52.000Z","_content":"\n\n## 一、HTTP的发展历程\n\nHTTP协议始于三十年前蒂姆·伯纳斯 - 李的一篇论文\n\nHTTP/0.9 (是个简单的文本协议，只能获取文本资源；)\n\nHTTP/1.0 - 1996年 （确立了大部分现在使用的技术，参考文档，不具备实际约束力）\n\nHTTP/1.1 - 1999年 （正式标准严格遵守，功能也非常完善，互联网爆发式增长，目前互联网上使用最广泛的协议） \n\nHTTP/2 - 2015年 （基于 Google 的 SPDY 协议，注重性能改善，但还未普及）\n\nHTTP/3 - 2018年 （基于 Google 的 QUIC 协议，是将来的发展方向）\n\n---\n\n课下作业\n\n1. 你认为推动 HTTP 发展的原动力是什么？\n2. 你是怎么理解 HTTP（超文本传输协议）的？\n\n## 二、HTTP简介\n\nHyperText transfer protocol （超文本传输协议）\n\n- HTTP 是一个用在计算机世界里的协议，它确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。\n- HTTP 专门用来在两点之间传输数据，不能用于广播、寻址或路由。\n- HTTP 传输的是文字、图片、音频、视频等超文本数据。\n- HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。\n\n----\n\n课下作业：\n\n1. 有一种流行的说法：“HTTP 是用于从互联网服务器传输超文本到本地浏览器的协议”，你认为这种说法对吗？对在哪里，又错在哪里？\n2. 你能再说出几个“HTTP 不是什么”吗？\n\n![http思维导图](/img/http思维导图.png)\n\n### 三、HTTP的应用领域\n\n1. 互联网上绝大部分资源都使用 HTTP 协议传输；\n2. 浏览器是 HTTP 协议里的请求方，即 User Agent；\n3. 服务器是 HTTP 协议里的应答方，常用的有 Apache 和 Nginx；\n4. CDN 位于浏览器和服务器之间，主要起到缓存加速的作用；\n5. 爬虫是另一类 User Agent，是自动访问网络资源的程序。\n\n---\n\n课后作业：\n\n1. 你觉得 CDN 在对待浏览器和爬虫时会有差异吗？为什么？\n2. 你怎么理解 WebService 与 Web Server 这两个非常相似的词？","source":"_posts/01_运维/02-综合架构/06-HTTP协议.md","raw":"---\ntitle: 运维之综合架构--06--HTTP协议介绍\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n\n## 一、HTTP的发展历程\n\nHTTP协议始于三十年前蒂姆·伯纳斯 - 李的一篇论文\n\nHTTP/0.9 (是个简单的文本协议，只能获取文本资源；)\n\nHTTP/1.0 - 1996年 （确立了大部分现在使用的技术，参考文档，不具备实际约束力）\n\nHTTP/1.1 - 1999年 （正式标准严格遵守，功能也非常完善，互联网爆发式增长，目前互联网上使用最广泛的协议） \n\nHTTP/2 - 2015年 （基于 Google 的 SPDY 协议，注重性能改善，但还未普及）\n\nHTTP/3 - 2018年 （基于 Google 的 QUIC 协议，是将来的发展方向）\n\n---\n\n课下作业\n\n1. 你认为推动 HTTP 发展的原动力是什么？\n2. 你是怎么理解 HTTP（超文本传输协议）的？\n\n## 二、HTTP简介\n\nHyperText transfer protocol （超文本传输协议）\n\n- HTTP 是一个用在计算机世界里的协议，它确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。\n- HTTP 专门用来在两点之间传输数据，不能用于广播、寻址或路由。\n- HTTP 传输的是文字、图片、音频、视频等超文本数据。\n- HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。\n\n----\n\n课下作业：\n\n1. 有一种流行的说法：“HTTP 是用于从互联网服务器传输超文本到本地浏览器的协议”，你认为这种说法对吗？对在哪里，又错在哪里？\n2. 你能再说出几个“HTTP 不是什么”吗？\n\n![http思维导图](/img/http思维导图.png)\n\n### 三、HTTP的应用领域\n\n1. 互联网上绝大部分资源都使用 HTTP 协议传输；\n2. 浏览器是 HTTP 协议里的请求方，即 User Agent；\n3. 服务器是 HTTP 协议里的应答方，常用的有 Apache 和 Nginx；\n4. CDN 位于浏览器和服务器之间，主要起到缓存加速的作用；\n5. 爬虫是另一类 User Agent，是自动访问网络资源的程序。\n\n---\n\n课后作业：\n\n1. 你觉得 CDN 在对待浏览器和爬虫时会有差异吗？为什么？\n2. 你怎么理解 WebService 与 Web Server 这两个非常相似的词？","slug":"01_运维/02-综合架构/06-HTTP协议","published":1,"updated":"2022-07-11T05:52:47.425Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0g000pa8v7afmka5tz","content":"<h2 id=\"一、HTTP的发展历程\"><a href=\"#一、HTTP的发展历程\" class=\"headerlink\" title=\"一、HTTP的发展历程\"></a>一、HTTP的发展历程</h2><p>HTTP协议始于三十年前蒂姆·伯纳斯 - 李的一篇论文</p>\n<p>HTTP&#x2F;0.9 (是个简单的文本协议，只能获取文本资源；)</p>\n<p>HTTP&#x2F;1.0 - 1996年 （确立了大部分现在使用的技术，参考文档，不具备实际约束力）</p>\n<p>HTTP&#x2F;1.1 - 1999年 （正式标准严格遵守，功能也非常完善，互联网爆发式增长，目前互联网上使用最广泛的协议） </p>\n<p>HTTP&#x2F;2 - 2015年 （基于 Google 的 SPDY 协议，注重性能改善，但还未普及）</p>\n<p>HTTP&#x2F;3 - 2018年 （基于 Google 的 QUIC 协议，是将来的发展方向）</p>\n<hr>\n<p>课下作业</p>\n<ol>\n<li>你认为推动 HTTP 发展的原动力是什么？</li>\n<li>你是怎么理解 HTTP（超文本传输协议）的？</li>\n</ol>\n<h2 id=\"二、HTTP简介\"><a href=\"#二、HTTP简介\" class=\"headerlink\" title=\"二、HTTP简介\"></a>二、HTTP简介</h2><p>HyperText transfer protocol （超文本传输协议）</p>\n<ul>\n<li>HTTP 是一个用在计算机世界里的协议，它确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。</li>\n<li>HTTP 专门用来在两点之间传输数据，不能用于广播、寻址或路由。</li>\n<li>HTTP 传输的是文字、图片、音频、视频等超文本数据。</li>\n<li>HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。</li>\n</ul>\n<hr>\n<p>课下作业：</p>\n<ol>\n<li>有一种流行的说法：“HTTP 是用于从互联网服务器传输超文本到本地浏览器的协议”，你认为这种说法对吗？对在哪里，又错在哪里？</li>\n<li>你能再说出几个“HTTP 不是什么”吗？</li>\n</ol>\n<p><img src=\"/img/http%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png\" alt=\"http思维导图\"></p>\n<h3 id=\"三、HTTP的应用领域\"><a href=\"#三、HTTP的应用领域\" class=\"headerlink\" title=\"三、HTTP的应用领域\"></a>三、HTTP的应用领域</h3><ol>\n<li>互联网上绝大部分资源都使用 HTTP 协议传输；</li>\n<li>浏览器是 HTTP 协议里的请求方，即 User Agent；</li>\n<li>服务器是 HTTP 协议里的应答方，常用的有 Apache 和 Nginx；</li>\n<li>CDN 位于浏览器和服务器之间，主要起到缓存加速的作用；</li>\n<li>爬虫是另一类 User Agent，是自动访问网络资源的程序。</li>\n</ol>\n<hr>\n<p>课后作业：</p>\n<ol>\n<li>你觉得 CDN 在对待浏览器和爬虫时会有差异吗？为什么？</li>\n<li>你怎么理解 WebService 与 Web Server 这两个非常相似的词？</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、HTTP的发展历程\"><a href=\"#一、HTTP的发展历程\" class=\"headerlink\" title=\"一、HTTP的发展历程\"></a>一、HTTP的发展历程</h2><p>HTTP协议始于三十年前蒂姆·伯纳斯 - 李的一篇论文</p>\n<p>HTTP&#x2F;0.9 (是个简单的文本协议，只能获取文本资源；)</p>\n<p>HTTP&#x2F;1.0 - 1996年 （确立了大部分现在使用的技术，参考文档，不具备实际约束力）</p>\n<p>HTTP&#x2F;1.1 - 1999年 （正式标准严格遵守，功能也非常完善，互联网爆发式增长，目前互联网上使用最广泛的协议） </p>\n<p>HTTP&#x2F;2 - 2015年 （基于 Google 的 SPDY 协议，注重性能改善，但还未普及）</p>\n<p>HTTP&#x2F;3 - 2018年 （基于 Google 的 QUIC 协议，是将来的发展方向）</p>\n<hr>\n<p>课下作业</p>\n<ol>\n<li>你认为推动 HTTP 发展的原动力是什么？</li>\n<li>你是怎么理解 HTTP（超文本传输协议）的？</li>\n</ol>\n<h2 id=\"二、HTTP简介\"><a href=\"#二、HTTP简介\" class=\"headerlink\" title=\"二、HTTP简介\"></a>二、HTTP简介</h2><p>HyperText transfer protocol （超文本传输协议）</p>\n<ul>\n<li>HTTP 是一个用在计算机世界里的协议，它确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。</li>\n<li>HTTP 专门用来在两点之间传输数据，不能用于广播、寻址或路由。</li>\n<li>HTTP 传输的是文字、图片、音频、视频等超文本数据。</li>\n<li>HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。</li>\n</ul>\n<hr>\n<p>课下作业：</p>\n<ol>\n<li>有一种流行的说法：“HTTP 是用于从互联网服务器传输超文本到本地浏览器的协议”，你认为这种说法对吗？对在哪里，又错在哪里？</li>\n<li>你能再说出几个“HTTP 不是什么”吗？</li>\n</ol>\n<p><img src=\"/img/http%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png\" alt=\"http思维导图\"></p>\n<h3 id=\"三、HTTP的应用领域\"><a href=\"#三、HTTP的应用领域\" class=\"headerlink\" title=\"三、HTTP的应用领域\"></a>三、HTTP的应用领域</h3><ol>\n<li>互联网上绝大部分资源都使用 HTTP 协议传输；</li>\n<li>浏览器是 HTTP 协议里的请求方，即 User Agent；</li>\n<li>服务器是 HTTP 协议里的应答方，常用的有 Apache 和 Nginx；</li>\n<li>CDN 位于浏览器和服务器之间，主要起到缓存加速的作用；</li>\n<li>爬虫是另一类 User Agent，是自动访问网络资源的程序。</li>\n</ol>\n<hr>\n<p>课后作业：</p>\n<ol>\n<li>你觉得 CDN 在对待浏览器和爬虫时会有差异吗？为什么？</li>\n<li>你怎么理解 WebService 与 Web Server 这两个非常相似的词？</li>\n</ol>\n"},{"title":"运维之综合架构--07--Nginx(一)安装与配置","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、Nginx简介\n\n参考网站：https://zhuanlan.zhihu.com/p/266153320\n\n## 二、Nginx安装\n\n​\tnginx有两种安装方式，yum安装和源码编译安装\n\n### 2.1 yum安装（epel源）\n\n```shell\nvim /etc/yum.repos.d/nginx.repo\n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n\nyum clean all\nyum makecache\n\nyum install nginx -y\n```\n\n### 2.2 编译安装\n\n查看yum安装的nginx的编译参数\n\n```shell\n[root@web01 ~]# nginx -V\nnginx version: nginx/1.20.1\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)\nbuilt with OpenSSL 1.1.1g FIPS  21 Apr 2020\nTLS SNI support enabled\nconfigure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'\n```\n\n源码获取\n\n```shell\n[root@web01 ~]# wget http://nginx.org/download/nginx-1.20.1.tar.gz\n```\n\n构建与编译\n\n```shell\n# 解压源码文件并进入文件夹内\ntar -vxf nginx-1.20.1.tar.gz && cd nginx-1.20.1\n\n# configure构建\n./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'\n\n# 编译并安装\nmake -j 4 && make install\n```\n\n错误解决\n\n```shell\n# 错误1：\n./configure: error: the invalid value in --with-ld-opt=\"-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E\"\n解决方法：\nyum -y install redhat-rpm-config.noarch\n\n# 错误2：\n./configure: error: the HTTP rewrite module requires the PCRE library.\nYou can either disable the module by using --without-http_rewrite_module\noption, or install the PCRE library into the system, or build the PCRE library\nstatically from the source with nginx by using --with-pcre=<path> option.\n解决方法：\nyum install pcre-devel -y\n\n# 错误3：\n./configure: error: SSL modules require the OpenSSL library.\nYou can either do not enable the modules, or install the OpenSSL library\ninto the system, or build the OpenSSL library statically from the source\nwith nginx by using --with-openssl=<path> option.\n解决方法：\nyum install openssl openssl-devel -y\n\n# 错误4：\n./configure: error: the HTTP XSLT module requires the libxml2/libxslt\nlibraries. You can either do not enable the module or install the libraries.\n解决方法：\nyum install libxml2 libxml2-devel libxslt  libxslt-devel -y\n\n# 错误5：\n./configure: error: the HTTP image filter module requires the GD library.\nYou can either do not enable the module or install the libraries.\n解决方法：\nyum -y install gd-devel\n\n# 错误6：\n./configure: error: perl module ExtUtils::Embed is required\n\n解决方法： \nyum -y install perl-devel perl-ExtUtils-Embed\n\n# 错误7：\n./configure: error: the Google perftools module requires the Google perftools library\n解决方法：\nyum install gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64 -y\n```\n\n### 2.3 启动和停止服务\n\n启动服务\n\n```shell\n# 先关闭httpd服务，防止冲突\n[root@web01 ~]# systemctl stop httpd\n[root@web01 ~]# systemctl disable httpd\n\n# 再启动nginx服务\n[root@web01 ~]# systemctl enable nginx\n[root@web01 html]# systemctl start nginx\n# 另一种启动方式\nnginx\n```\n\n停止服务\n\n```shell\nsystemctl stop nginx \n# 或者\nnginx -s stop \n```\n\n重启/重载服务\n\n```shell\nsystemctl restart/reload nginx\nnginx -s restart/reload \n```\n\n>PS：重载reload和重启restart的差别\n>\n>reload将会等服务进程执行完再重启，而restart则是强制重启\n\n## 三、Nginx目录结构说明\n\n查看nginx的目录结构\n\n```shell\n[root@web01 html]# rpm -ql nginx\n```\n\n参考链接：\n\nhttps://zhuanlan.zhihu.com/p/137262519\n\n## 四、Nginx配置文件说明\n\n>http server location扩展了解项\n>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location\n>http{} 标签主要用来解决用户的请求与响应。\n>server{} 标签主要用来响应具体的某一个网站。\n>location{} 标签主要用于匹配网站具体URL路径。\n\n主配置文件说明\n\n```shell\n[root@web01 html]# cat /etc/nginx/nginx.conf\n---核心模块---\nuser nginx;\t#nginx进程运行的用户\nworker_processes auto;\t#nginx工作的进程数量\nerror_log /var/log/nginx/error.log;\t#nginx的错误日志【警告及其警告以上的都记录】\npid /run/nginx.pid;\t#nginx进程运行后的进程id\n---核心模块---\n\n# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.\ninclude /usr/share/nginx/modules/*.conf;\n\n---事件模块---\nevents {\n    worker_connections 1024; # 一个work进程的最大连接数\n    use epool;\t\t\t\t #使用epool网络模型\n}\n---事件模块---\n\n---http核心层模块---\nhttp {\n\t# 日志格式定义\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\t# 访问日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\t# 长连接超时时间\n    types_hash_max_size 4096;\n    #gzip on;\t\t\t#是否开启压缩功能\t\t\t\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    include /etc/nginx/conf.d/*.conf;\t# 包含哪个目录下面的*.conf文件，用于写server\n\n    server {\n        listen       80;\t# 监听端口\n        listen       [::]:80;\n        server_name  _;\t\t# 域名\n        root         /usr/share/nginx/html;\n\n\t\t#charset koi8-r;\t\t\t#字符集\n\n\t\tlocation / {\t \t\t\t#位置\n\t\t\troot   /usr/share/nginx/html;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t}\n\t\tlocation /test {\t \t\t\t#位置\n\t\t\troot   /code/test/123/;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t}\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        error_page 404 /404.html;\n        location = /404.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n    }\n}\n---http核心层模块---\n```\n\n## 五、案例：搭建web网站\n\n准备配置文件ds\n\n```she\n[root@web01 code]# cat /etc/nginx/conf.d/game.conf\nserver {\n        listen 80;\n        server_name game.oldboy.com;\n\n        location / {\n                root /code;\n                index index.html;\n        }\n}\n```\n\n按照配置文件创建文件夹并放入html项目文件\n\n```shell\nmkdir /code\ncp html5.zip /code\ncd /code\nunzip html5.zip\n\n[root@web01 code]# ls\nceshi  game  html5.zip  img  index.html  __MACOSX  readme.txt\n```\n\n重启nginx服务\n\n```shell\nsystemctl restart nginx\nsystemctl reload nginx\n```\n\n通过物理机浏览器浏览\n\n```shell\n# 修改hosts文件\n10.0.0.7 game.oldboy.com\n# 网页访问\ngame.oldboy.com\n```\n\n## 六、Nginx虚拟主机\n\nNginx配置虚拟主机有如下三种方式：\n\n- 单主机多IP\n- 单主机多端口\n- 单主机多域名\n\n### 6.1 基于主机多IP方式(不常用)\n\n```shell\n[root@web01 conf.d]# cat ip.conf \nserver {\n\tlisten 10.0.0.7:80;\n\tserver_name _;\n\n\tlocation / {\n\t\troot /code_ip_eth0;\n\t\tindex index.html;\n\t}\n}\n\nserver {\n\tlisten 172.16.1.7:80;\n\tserver_name _;\n\n\tlocation / {\n\t\troot /code_ip_eth1;\n\t\tindex index.html;\n\t}\n}\n\n2.根据配置创建目录\n[root@web01 conf.d]# mkdir /code_ip_eth0\n[root@web01 conf.d]# echo \"Eth0\" > /code_ip_eth0/index.html\n\n[root@web01 conf.d]# mkdir /code_ip_eth1\n[root@web01 conf.d]# echo \"Eth1\" > /code_ip_eth1/index.html\n\n3.重启nginx服务\n[root@web01 conf.d]# systemctl restart nginx\n\n4.使用curl命令测试\n[root@web01 ~]# curl 172.16.1.7\nEth1\n[root@web01 ~]# curl 10.0.0.7\nEth0\n```\n\n### 6.2 基于主机多端口方式（多用于内部测试）\n\n```shell\n1.配置多端口的虚拟主机\n[root@web01 conf.d]# vim port.conf\nserver {\n        listen 81;\n        \n        location / { \n                root /code_81;\n                index index.html;\n        }\n}\nserver {\n        listen 82;\n        \n        location / { \n                root /code_82;\n                index index.html;\n        }\n}\t\t\n\n2.根据配置文件创建所需的目录\n[root@web01 conf.d]# mkdir /code_8{1..2}\n[root@web01 conf.d]# echo \"81\" > /code_81/index.html\n[root@web01 conf.d]# echo \"82\" > /code_82/index.html\n\n3.检查语法并重启服务\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n\n\n4.如何去访问\n\thttp://10.0.0.7:82/\n```\n\n### 6.3 基于主机多域名方式（常用）\n\n```shell\n1.准备多虚拟主机配置文件\n[root@web01 conf.d]# cat test1.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\n\tlocation / {\n\t\troot /code/test1;\n\t\tindex index.html;\n\t}\n}\n\n[root@web01 conf.d]# cat test2.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name test2.oldboy.com;\n\n\tlocation / {\n\t\troot /code/test2;\n\t\tindex index.html;\n\t}\n}\n\n2.根据配置文件创建对应的目录\n[root@web01 conf.d]# mkdir /code/test{1..2} -p\n[root@web01 conf.d]# echo \"test1_server\" > /code/test1/index.html\n[root@web01 conf.d]# echo \"test2_server\" > /code/test2/index.html\n[root@web01 conf.d]# nginx -t\n[root@web01 conf.d]# systemctl restart nginx\n\n3.配置域名解析\n10.0.0.7      test1.oldboy.com\n10.0.0.7      test2.oldboy.com\n\n4.通过浏览器访问该网站\n```\n\n## 七、日志与错误排查\n\n### 7.1 nginx配置文件自查\n\n1.修改完配置记得检查语法\n\n```\nnginx -t\n```\n\n2.如果没有检查语法，直接重载导致报错，可查看错误信息\n\n```shell\nsystemctl status nginx -l \n```\n\n### 7.2 访问日志\n\n可以为server和location单独设置访问日志（***涉及日志作用域***）\n\n```shell\nserver {\n    listen 80;\n    server_name code.oldboy.com;\n    \n    # 将当前的server网站的访问日志记录至对应的目录，使用main格式\n    access_log /var/log/nginx/code.oldboy.com.log main;\n    location / {\n        root /code;\n    }\n\t\n    # 当有人请求改favicon.ico时，不记录日志\n    location /favicon.ico {\n        access_log off;  # off 关闭\n        return 200;\n    }\n}\n```\n\n访问日志参数详解\n\n```shell\nlog_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n```\n\n| **变量名称**            | **变量描述**                                 | **举例说明**                                                 |\n| ----------------------- | -------------------------------------------- | ------------------------------------------------------------ |\n| $remote_addr            | 客户端地址                                   | 113.140.15.90                                                |\n| $remote_user            | 客户端用户名称                               | –                                                            |\n| $time_local             | 访问时间和时区                               | 18/Jul/2012:17:00:01 +0800                                   |\n| $request                | 请求的URI和HTTP协议                          | “GET /pa/img/home/logo-alipay-t.png HTTP/1.1″                |\n| $http_host              | 请求地址，即浏览器中你输入的地址（IP或域名） | img.alipay.com10.253.70.103                                  |\n| $status                 | HTTP请求状态                                 | 200                                                          |\n| $upstream_status        | upstream状态                                 | 200                                                          |\n| $body_bytes_sent        | 发送给客户端文件内容大小                     | 547                                                          |\n| $http_referer           | 跳转来源                                     | “[https://cashier.alip](https://cashier.alip/)ay.com…/”      |\n| $http_user_agent        | 用户终端代理                                 | “Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C; |\n| $ssl_protocol           | SSL协议版本                                  | TLSv1                                                        |\n| $ssl_cipher             | 交换数据中的算法                             | RC4-SHA                                                      |\n| $upstream_addr          | 后台upstream的地址，即真正提供服务的主机地址 | 10.228.35.247:80                                             |\n| $request_time           | 整个请求的总时间                             | 0.205                                                        |\n| $upstream_response_time | 请求过程中，upstream响应时间                 | 0.002                                                        |\n\n### 7.3 错误日志\n\n```shell\ntail -f /var/log/nginx/error.log\n```\n\n### 7.4 日志切割logrotate\n\n配置文件，一般不需要修改，默认就行\n\n```shell\n[root@web01 logrotate.d]# cat /etc/logrotate.d/nginx\n/var/log/nginx/*.log {\n    create 0640 nginx root\t \t\n    daily\t# 每天切割日志\n    rotate 10\n    missingok\t# 日志丢失忽略\n    notifempty\n    compress\t# 日志文件压缩\n    sharedscripts\n    postrotate\n        /bin/kill -USR1 `cat /run/nginx.pid 2>/dev/null` 2>/dev/null || true\n    endscript\n}\n```\n\n\n\n\n\n","source":"_posts/01_运维/02-综合架构/07-Nginx(一)安装与配置.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(一)安装与配置\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、Nginx简介\n\n参考网站：https://zhuanlan.zhihu.com/p/266153320\n\n## 二、Nginx安装\n\n​\tnginx有两种安装方式，yum安装和源码编译安装\n\n### 2.1 yum安装（epel源）\n\n```shell\nvim /etc/yum.repos.d/nginx.repo\n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n\nyum clean all\nyum makecache\n\nyum install nginx -y\n```\n\n### 2.2 编译安装\n\n查看yum安装的nginx的编译参数\n\n```shell\n[root@web01 ~]# nginx -V\nnginx version: nginx/1.20.1\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)\nbuilt with OpenSSL 1.1.1g FIPS  21 Apr 2020\nTLS SNI support enabled\nconfigure arguments: --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'\n```\n\n源码获取\n\n```shell\n[root@web01 ~]# wget http://nginx.org/download/nginx-1.20.1.tar.gz\n```\n\n构建与编译\n\n```shell\n# 解压源码文件并进入文件夹内\ntar -vxf nginx-1.20.1.tar.gz && cd nginx-1.20.1\n\n# configure构建\n./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic' --with-ld-opt='-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E'\n\n# 编译并安装\nmake -j 4 && make install\n```\n\n错误解决\n\n```shell\n# 错误1：\n./configure: error: the invalid value in --with-ld-opt=\"-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E\"\n解决方法：\nyum -y install redhat-rpm-config.noarch\n\n# 错误2：\n./configure: error: the HTTP rewrite module requires the PCRE library.\nYou can either disable the module by using --without-http_rewrite_module\noption, or install the PCRE library into the system, or build the PCRE library\nstatically from the source with nginx by using --with-pcre=<path> option.\n解决方法：\nyum install pcre-devel -y\n\n# 错误3：\n./configure: error: SSL modules require the OpenSSL library.\nYou can either do not enable the modules, or install the OpenSSL library\ninto the system, or build the OpenSSL library statically from the source\nwith nginx by using --with-openssl=<path> option.\n解决方法：\nyum install openssl openssl-devel -y\n\n# 错误4：\n./configure: error: the HTTP XSLT module requires the libxml2/libxslt\nlibraries. You can either do not enable the module or install the libraries.\n解决方法：\nyum install libxml2 libxml2-devel libxslt  libxslt-devel -y\n\n# 错误5：\n./configure: error: the HTTP image filter module requires the GD library.\nYou can either do not enable the module or install the libraries.\n解决方法：\nyum -y install gd-devel\n\n# 错误6：\n./configure: error: perl module ExtUtils::Embed is required\n\n解决方法： \nyum -y install perl-devel perl-ExtUtils-Embed\n\n# 错误7：\n./configure: error: the Google perftools module requires the Google perftools library\n解决方法：\nyum install gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64 -y\n```\n\n### 2.3 启动和停止服务\n\n启动服务\n\n```shell\n# 先关闭httpd服务，防止冲突\n[root@web01 ~]# systemctl stop httpd\n[root@web01 ~]# systemctl disable httpd\n\n# 再启动nginx服务\n[root@web01 ~]# systemctl enable nginx\n[root@web01 html]# systemctl start nginx\n# 另一种启动方式\nnginx\n```\n\n停止服务\n\n```shell\nsystemctl stop nginx \n# 或者\nnginx -s stop \n```\n\n重启/重载服务\n\n```shell\nsystemctl restart/reload nginx\nnginx -s restart/reload \n```\n\n>PS：重载reload和重启restart的差别\n>\n>reload将会等服务进程执行完再重启，而restart则是强制重启\n\n## 三、Nginx目录结构说明\n\n查看nginx的目录结构\n\n```shell\n[root@web01 html]# rpm -ql nginx\n```\n\n参考链接：\n\nhttps://zhuanlan.zhihu.com/p/137262519\n\n## 四、Nginx配置文件说明\n\n>http server location扩展了解项\n>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location\n>http{} 标签主要用来解决用户的请求与响应。\n>server{} 标签主要用来响应具体的某一个网站。\n>location{} 标签主要用于匹配网站具体URL路径。\n\n主配置文件说明\n\n```shell\n[root@web01 html]# cat /etc/nginx/nginx.conf\n---核心模块---\nuser nginx;\t#nginx进程运行的用户\nworker_processes auto;\t#nginx工作的进程数量\nerror_log /var/log/nginx/error.log;\t#nginx的错误日志【警告及其警告以上的都记录】\npid /run/nginx.pid;\t#nginx进程运行后的进程id\n---核心模块---\n\n# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.\ninclude /usr/share/nginx/modules/*.conf;\n\n---事件模块---\nevents {\n    worker_connections 1024; # 一个work进程的最大连接数\n    use epool;\t\t\t\t #使用epool网络模型\n}\n---事件模块---\n\n---http核心层模块---\nhttp {\n\t# 日志格式定义\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\t# 访问日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\t# 长连接超时时间\n    types_hash_max_size 4096;\n    #gzip on;\t\t\t#是否开启压缩功能\t\t\t\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    include /etc/nginx/conf.d/*.conf;\t# 包含哪个目录下面的*.conf文件，用于写server\n\n    server {\n        listen       80;\t# 监听端口\n        listen       [::]:80;\n        server_name  _;\t\t# 域名\n        root         /usr/share/nginx/html;\n\n\t\t#charset koi8-r;\t\t\t#字符集\n\n\t\tlocation / {\t \t\t\t#位置\n\t\t\troot   /usr/share/nginx/html;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t}\n\t\tlocation /test {\t \t\t\t#位置\n\t\t\troot   /code/test/123/;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t}\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        error_page 404 /404.html;\n        location = /404.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n    }\n}\n---http核心层模块---\n```\n\n## 五、案例：搭建web网站\n\n准备配置文件ds\n\n```she\n[root@web01 code]# cat /etc/nginx/conf.d/game.conf\nserver {\n        listen 80;\n        server_name game.oldboy.com;\n\n        location / {\n                root /code;\n                index index.html;\n        }\n}\n```\n\n按照配置文件创建文件夹并放入html项目文件\n\n```shell\nmkdir /code\ncp html5.zip /code\ncd /code\nunzip html5.zip\n\n[root@web01 code]# ls\nceshi  game  html5.zip  img  index.html  __MACOSX  readme.txt\n```\n\n重启nginx服务\n\n```shell\nsystemctl restart nginx\nsystemctl reload nginx\n```\n\n通过物理机浏览器浏览\n\n```shell\n# 修改hosts文件\n10.0.0.7 game.oldboy.com\n# 网页访问\ngame.oldboy.com\n```\n\n## 六、Nginx虚拟主机\n\nNginx配置虚拟主机有如下三种方式：\n\n- 单主机多IP\n- 单主机多端口\n- 单主机多域名\n\n### 6.1 基于主机多IP方式(不常用)\n\n```shell\n[root@web01 conf.d]# cat ip.conf \nserver {\n\tlisten 10.0.0.7:80;\n\tserver_name _;\n\n\tlocation / {\n\t\troot /code_ip_eth0;\n\t\tindex index.html;\n\t}\n}\n\nserver {\n\tlisten 172.16.1.7:80;\n\tserver_name _;\n\n\tlocation / {\n\t\troot /code_ip_eth1;\n\t\tindex index.html;\n\t}\n}\n\n2.根据配置创建目录\n[root@web01 conf.d]# mkdir /code_ip_eth0\n[root@web01 conf.d]# echo \"Eth0\" > /code_ip_eth0/index.html\n\n[root@web01 conf.d]# mkdir /code_ip_eth1\n[root@web01 conf.d]# echo \"Eth1\" > /code_ip_eth1/index.html\n\n3.重启nginx服务\n[root@web01 conf.d]# systemctl restart nginx\n\n4.使用curl命令测试\n[root@web01 ~]# curl 172.16.1.7\nEth1\n[root@web01 ~]# curl 10.0.0.7\nEth0\n```\n\n### 6.2 基于主机多端口方式（多用于内部测试）\n\n```shell\n1.配置多端口的虚拟主机\n[root@web01 conf.d]# vim port.conf\nserver {\n        listen 81;\n        \n        location / { \n                root /code_81;\n                index index.html;\n        }\n}\nserver {\n        listen 82;\n        \n        location / { \n                root /code_82;\n                index index.html;\n        }\n}\t\t\n\n2.根据配置文件创建所需的目录\n[root@web01 conf.d]# mkdir /code_8{1..2}\n[root@web01 conf.d]# echo \"81\" > /code_81/index.html\n[root@web01 conf.d]# echo \"82\" > /code_82/index.html\n\n3.检查语法并重启服务\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n\n\n4.如何去访问\n\thttp://10.0.0.7:82/\n```\n\n### 6.3 基于主机多域名方式（常用）\n\n```shell\n1.准备多虚拟主机配置文件\n[root@web01 conf.d]# cat test1.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\n\tlocation / {\n\t\troot /code/test1;\n\t\tindex index.html;\n\t}\n}\n\n[root@web01 conf.d]# cat test2.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name test2.oldboy.com;\n\n\tlocation / {\n\t\troot /code/test2;\n\t\tindex index.html;\n\t}\n}\n\n2.根据配置文件创建对应的目录\n[root@web01 conf.d]# mkdir /code/test{1..2} -p\n[root@web01 conf.d]# echo \"test1_server\" > /code/test1/index.html\n[root@web01 conf.d]# echo \"test2_server\" > /code/test2/index.html\n[root@web01 conf.d]# nginx -t\n[root@web01 conf.d]# systemctl restart nginx\n\n3.配置域名解析\n10.0.0.7      test1.oldboy.com\n10.0.0.7      test2.oldboy.com\n\n4.通过浏览器访问该网站\n```\n\n## 七、日志与错误排查\n\n### 7.1 nginx配置文件自查\n\n1.修改完配置记得检查语法\n\n```\nnginx -t\n```\n\n2.如果没有检查语法，直接重载导致报错，可查看错误信息\n\n```shell\nsystemctl status nginx -l \n```\n\n### 7.2 访问日志\n\n可以为server和location单独设置访问日志（***涉及日志作用域***）\n\n```shell\nserver {\n    listen 80;\n    server_name code.oldboy.com;\n    \n    # 将当前的server网站的访问日志记录至对应的目录，使用main格式\n    access_log /var/log/nginx/code.oldboy.com.log main;\n    location / {\n        root /code;\n    }\n\t\n    # 当有人请求改favicon.ico时，不记录日志\n    location /favicon.ico {\n        access_log off;  # off 关闭\n        return 200;\n    }\n}\n```\n\n访问日志参数详解\n\n```shell\nlog_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n```\n\n| **变量名称**            | **变量描述**                                 | **举例说明**                                                 |\n| ----------------------- | -------------------------------------------- | ------------------------------------------------------------ |\n| $remote_addr            | 客户端地址                                   | 113.140.15.90                                                |\n| $remote_user            | 客户端用户名称                               | –                                                            |\n| $time_local             | 访问时间和时区                               | 18/Jul/2012:17:00:01 +0800                                   |\n| $request                | 请求的URI和HTTP协议                          | “GET /pa/img/home/logo-alipay-t.png HTTP/1.1″                |\n| $http_host              | 请求地址，即浏览器中你输入的地址（IP或域名） | img.alipay.com10.253.70.103                                  |\n| $status                 | HTTP请求状态                                 | 200                                                          |\n| $upstream_status        | upstream状态                                 | 200                                                          |\n| $body_bytes_sent        | 发送给客户端文件内容大小                     | 547                                                          |\n| $http_referer           | 跳转来源                                     | “[https://cashier.alip](https://cashier.alip/)ay.com…/”      |\n| $http_user_agent        | 用户终端代理                                 | “Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; SV1; GTB7.0; .NET4.0C; |\n| $ssl_protocol           | SSL协议版本                                  | TLSv1                                                        |\n| $ssl_cipher             | 交换数据中的算法                             | RC4-SHA                                                      |\n| $upstream_addr          | 后台upstream的地址，即真正提供服务的主机地址 | 10.228.35.247:80                                             |\n| $request_time           | 整个请求的总时间                             | 0.205                                                        |\n| $upstream_response_time | 请求过程中，upstream响应时间                 | 0.002                                                        |\n\n### 7.3 错误日志\n\n```shell\ntail -f /var/log/nginx/error.log\n```\n\n### 7.4 日志切割logrotate\n\n配置文件，一般不需要修改，默认就行\n\n```shell\n[root@web01 logrotate.d]# cat /etc/logrotate.d/nginx\n/var/log/nginx/*.log {\n    create 0640 nginx root\t \t\n    daily\t# 每天切割日志\n    rotate 10\n    missingok\t# 日志丢失忽略\n    notifempty\n    compress\t# 日志文件压缩\n    sharedscripts\n    postrotate\n        /bin/kill -USR1 `cat /run/nginx.pid 2>/dev/null` 2>/dev/null || true\n    endscript\n}\n```\n\n\n\n\n\n","slug":"01_运维/02-综合架构/07-Nginx(一)安装与配置","published":1,"updated":"2022-07-06T07:16:03.655Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0h000sa8v75cqb3nwe","content":"<h2 id=\"一、Nginx简介\"><a href=\"#一、Nginx简介\" class=\"headerlink\" title=\"一、Nginx简介\"></a>一、Nginx简介</h2><p>参考网站：<a href=\"https://zhuanlan.zhihu.com/p/266153320\">https://zhuanlan.zhihu.com/p/266153320</a></p>\n<h2 id=\"二、Nginx安装\"><a href=\"#二、Nginx安装\" class=\"headerlink\" title=\"二、Nginx安装\"></a>二、Nginx安装</h2><p>​\tnginx有两种安装方式，yum安装和源码编译安装</p>\n<h3 id=\"2-1-yum安装（epel源）\"><a href=\"#2-1-yum安装（epel源）\" class=\"headerlink\" title=\"2.1 yum安装（epel源）\"></a>2.1 yum安装（epel源）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo\n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n\nyum clean all\nyum makecache\n\nyum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-编译安装\"><a href=\"#2-2-编译安装\" class=\"headerlink\" title=\"2.2 编译安装\"></a>2.2 编译安装</h3><p>查看yum安装的nginx的编译参数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# nginx -V\nnginx version: nginx&#x2F;1.20.1\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)\nbuilt with OpenSSL 1.1.1g FIPS  21 Apr 2020\nTLS SNI support enabled\nconfigure arguments: --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>源码获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.20.1.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>构建与编译</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 解压源码文件并进入文件夹内\ntar -vxf nginx-1.20.1.tar.gz &amp;&amp; cd nginx-1.20.1\n\n# configure构建\n.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;\n\n# 编译并安装\nmake -j 4 &amp;&amp; make install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>错误解决</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 错误1：\n.&#x2F;configure: error: the invalid value in --with-ld-opt&#x3D;&quot;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&quot;\n解决方法：\nyum -y install redhat-rpm-config.noarch\n\n# 错误2：\n.&#x2F;configure: error: the HTTP rewrite module requires the PCRE library.\nYou can either disable the module by using --without-http_rewrite_module\noption, or install the PCRE library into the system, or build the PCRE library\nstatically from the source with nginx by using --with-pcre&#x3D;&lt;path&gt; option.\n解决方法：\nyum install pcre-devel -y\n\n# 错误3：\n.&#x2F;configure: error: SSL modules require the OpenSSL library.\nYou can either do not enable the modules, or install the OpenSSL library\ninto the system, or build the OpenSSL library statically from the source\nwith nginx by using --with-openssl&#x3D;&lt;path&gt; option.\n解决方法：\nyum install openssl openssl-devel -y\n\n# 错误4：\n.&#x2F;configure: error: the HTTP XSLT module requires the libxml2&#x2F;libxslt\nlibraries. You can either do not enable the module or install the libraries.\n解决方法：\nyum install libxml2 libxml2-devel libxslt  libxslt-devel -y\n\n# 错误5：\n.&#x2F;configure: error: the HTTP image filter module requires the GD library.\nYou can either do not enable the module or install the libraries.\n解决方法：\nyum -y install gd-devel\n\n# 错误6：\n.&#x2F;configure: error: perl module ExtUtils::Embed is required\n\n解决方法： \nyum -y install perl-devel perl-ExtUtils-Embed\n\n# 错误7：\n.&#x2F;configure: error: the Google perftools module requires the Google perftools library\n解决方法：\nyum install gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64 -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-启动和停止服务\"><a href=\"#2-3-启动和停止服务\" class=\"headerlink\" title=\"2.3 启动和停止服务\"></a>2.3 启动和停止服务</h3><p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 先关闭httpd服务，防止冲突\n[root@web01 ~]# systemctl stop httpd\n[root@web01 ~]# systemctl disable httpd\n\n# 再启动nginx服务\n[root@web01 ~]# systemctl enable nginx\n[root@web01 html]# systemctl start nginx\n# 另一种启动方式\nnginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>停止服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop nginx \n# 或者\nnginx -s stop <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>重启&#x2F;重载服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart&#x2F;reload nginx\nnginx -s restart&#x2F;reload <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：重载reload和重启restart的差别</p>\n<p>reload将会等服务进程执行完再重启，而restart则是强制重启</p>\n</blockquote>\n<h2 id=\"三、Nginx目录结构说明\"><a href=\"#三、Nginx目录结构说明\" class=\"headerlink\" title=\"三、Nginx目录结构说明\"></a>三、Nginx目录结构说明</h2><p>查看nginx的目录结构</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 html]# rpm -ql nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>参考链接：</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/137262519\">https://zhuanlan.zhihu.com/p/137262519</a></p>\n<h2 id=\"四、Nginx配置文件说明\"><a href=\"#四、Nginx配置文件说明\" class=\"headerlink\" title=\"四、Nginx配置文件说明\"></a>四、Nginx配置文件说明</h2><blockquote>\n<p>http server location扩展了解项<br>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location<br>http{} 标签主要用来解决用户的请求与响应。<br>server{} 标签主要用来响应具体的某一个网站。<br>location{} 标签主要用于匹配网站具体URL路径。</p>\n</blockquote>\n<p>主配置文件说明</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 html]# cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\n---核心模块---\nuser nginx;\t#nginx进程运行的用户\nworker_processes auto;\t#nginx工作的进程数量\nerror_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;\t#nginx的错误日志【警告及其警告以上的都记录】\npid &#x2F;run&#x2F;nginx.pid;\t#nginx进程运行后的进程id\n---核心模块---\n\n# Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx&#x2F;README.dynamic.\ninclude &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;\n\n---事件模块---\nevents &#123;\n    worker_connections 1024; # 一个work进程的最大连接数\n    use epool;\t\t\t\t #使用epool网络模型\n&#125;\n---事件模块---\n\n---http核心层模块---\nhttp &#123;\n\t# 日志格式定义\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;\t# 访问日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\t# 长连接超时时间\n    types_hash_max_size 4096;\n    #gzip on;\t\t\t#是否开启压缩功能\t\t\t\n\n    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;\n    default_type        application&#x2F;octet-stream;\n\n    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;\t# 包含哪个目录下面的*.conf文件，用于写server\n\n    server &#123;\n        listen       80;\t# 监听端口\n        listen       [::]:80;\n        server_name  _;\t\t# 域名\n        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n\n\t\t#charset koi8-r;\t\t\t#字符集\n\n\t\tlocation &#x2F; &#123;\t \t\t\t#位置\n\t\t\troot   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t&#125;\n\t\tlocation &#x2F;test &#123;\t \t\t\t#位置\n\t\t\troot   &#x2F;code&#x2F;test&#x2F;123&#x2F;;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t&#125;\n\n        # Load configuration files for the default server block.\n        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n\n        error_page 404 &#x2F;404.html;\n        location &#x3D; &#x2F;404.html &#123;\n        &#125;\n\n        error_page 500 502 503 504 &#x2F;50x.html;\n        location &#x3D; &#x2F;50x.html &#123;\n        &#125;\n    &#125;\n&#125;\n---http核心层模块---<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、案例：搭建web网站\"><a href=\"#五、案例：搭建web网站\" class=\"headerlink\" title=\"五、案例：搭建web网站\"></a>五、案例：搭建web网站</h2><p>准备配置文件ds</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;game.conf\nserver &#123;\n        listen 80;\n        server_name game.oldboy.com;\n\n        location &#x2F; &#123;\n                root &#x2F;code;\n                index index.html;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照配置文件创建文件夹并放入html项目文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;code\ncp html5.zip &#x2F;code\ncd &#x2F;code\nunzip html5.zip\n\n[root@web01 code]# ls\nceshi  game  html5.zip  img  index.html  __MACOSX  readme.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart nginx\nsystemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>通过物理机浏览器浏览</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 修改hosts文件\n10.0.0.7 game.oldboy.com\n# 网页访问\ngame.oldboy.com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、Nginx虚拟主机\"><a href=\"#六、Nginx虚拟主机\" class=\"headerlink\" title=\"六、Nginx虚拟主机\"></a>六、Nginx虚拟主机</h2><p>Nginx配置虚拟主机有如下三种方式：</p>\n<ul>\n<li>单主机多IP</li>\n<li>单主机多端口</li>\n<li>单主机多域名</li>\n</ul>\n<h3 id=\"6-1-基于主机多IP方式-不常用\"><a href=\"#6-1-基于主机多IP方式-不常用\" class=\"headerlink\" title=\"6.1 基于主机多IP方式(不常用)\"></a>6.1 基于主机多IP方式(不常用)</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat ip.conf \nserver &#123;\n\tlisten 10.0.0.7:80;\n\tserver_name _;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code_ip_eth0;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\nserver &#123;\n\tlisten 172.16.1.7:80;\n\tserver_name _;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code_ip_eth1;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n2.根据配置创建目录\n[root@web01 conf.d]# mkdir &#x2F;code_ip_eth0\n[root@web01 conf.d]# echo &quot;Eth0&quot; &gt; &#x2F;code_ip_eth0&#x2F;index.html\n\n[root@web01 conf.d]# mkdir &#x2F;code_ip_eth1\n[root@web01 conf.d]# echo &quot;Eth1&quot; &gt; &#x2F;code_ip_eth1&#x2F;index.html\n\n3.重启nginx服务\n[root@web01 conf.d]# systemctl restart nginx\n\n4.使用curl命令测试\n[root@web01 ~]# curl 172.16.1.7\nEth1\n[root@web01 ~]# curl 10.0.0.7\nEth0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-2-基于主机多端口方式（多用于内部测试）\"><a href=\"#6-2-基于主机多端口方式（多用于内部测试）\" class=\"headerlink\" title=\"6.2 基于主机多端口方式（多用于内部测试）\"></a>6.2 基于主机多端口方式（多用于内部测试）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.配置多端口的虚拟主机\n[root@web01 conf.d]# vim port.conf\nserver &#123;\n        listen 81;\n        \n        location &#x2F; &#123; \n                root &#x2F;code_81;\n                index index.html;\n        &#125;\n&#125;\nserver &#123;\n        listen 82;\n        \n        location &#x2F; &#123; \n                root &#x2F;code_82;\n                index index.html;\n        &#125;\n&#125;\t\t\n\n2.根据配置文件创建所需的目录\n[root@web01 conf.d]# mkdir &#x2F;code_8&#123;1..2&#125;\n[root@web01 conf.d]# echo &quot;81&quot; &gt; &#x2F;code_81&#x2F;index.html\n[root@web01 conf.d]# echo &quot;82&quot; &gt; &#x2F;code_82&#x2F;index.html\n\n3.检查语法并重启服务\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n\n\n4.如何去访问\n\thttp:&#x2F;&#x2F;10.0.0.7:82&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-3-基于主机多域名方式（常用）\"><a href=\"#6-3-基于主机多域名方式（常用）\" class=\"headerlink\" title=\"6.3 基于主机多域名方式（常用）\"></a>6.3 基于主机多域名方式（常用）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.准备多虚拟主机配置文件\n[root@web01 conf.d]# cat test1.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test1;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n[root@web01 conf.d]# cat test2.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name test2.oldboy.com;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test2;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n2.根据配置文件创建对应的目录\n[root@web01 conf.d]# mkdir &#x2F;code&#x2F;test&#123;1..2&#125; -p\n[root@web01 conf.d]# echo &quot;test1_server&quot; &gt; &#x2F;code&#x2F;test1&#x2F;index.html\n[root@web01 conf.d]# echo &quot;test2_server&quot; &gt; &#x2F;code&#x2F;test2&#x2F;index.html\n[root@web01 conf.d]# nginx -t\n[root@web01 conf.d]# systemctl restart nginx\n\n3.配置域名解析\n10.0.0.7      test1.oldboy.com\n10.0.0.7      test2.oldboy.com\n\n4.通过浏览器访问该网站<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"七、日志与错误排查\"><a href=\"#七、日志与错误排查\" class=\"headerlink\" title=\"七、日志与错误排查\"></a>七、日志与错误排查</h2><h3 id=\"7-1-nginx配置文件自查\"><a href=\"#7-1-nginx配置文件自查\" class=\"headerlink\" title=\"7.1 nginx配置文件自查\"></a>7.1 nginx配置文件自查</h3><p>1.修改完配置记得检查语法</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">nginx -t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2.如果没有检查语法，直接重载导致报错，可查看错误信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl status nginx -l <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-2-访问日志\"><a href=\"#7-2-访问日志\" class=\"headerlink\" title=\"7.2 访问日志\"></a>7.2 访问日志</h3><p>可以为server和location单独设置访问日志（<em><strong>涉及日志作用域</strong></em>）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">server &#123;\n    listen 80;\n    server_name code.oldboy.com;\n    \n    # 将当前的server网站的访问日志记录至对应的目录，使用main格式\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;code.oldboy.com.log main;\n    location &#x2F; &#123;\n        root &#x2F;code;\n    &#125;\n\t\n    # 当有人请求改favicon.ico时，不记录日志\n    location &#x2F;favicon.ico &#123;\n        access_log off;  # off 关闭\n        return 200;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>访问日志参数详解</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<table>\n<thead>\n<tr>\n<th><strong>变量名称</strong></th>\n<th><strong>变量描述</strong></th>\n<th><strong>举例说明</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>$remote_addr</td>\n<td>客户端地址</td>\n<td>113.140.15.90</td>\n</tr>\n<tr>\n<td>$remote_user</td>\n<td>客户端用户名称</td>\n<td>–</td>\n</tr>\n<tr>\n<td>$time_local</td>\n<td>访问时间和时区</td>\n<td>18&#x2F;Jul&#x2F;2012:17:00:01 +0800</td>\n</tr>\n<tr>\n<td>$request</td>\n<td>请求的URI和HTTP协议</td>\n<td>“GET &#x2F;pa&#x2F;img&#x2F;home&#x2F;logo-alipay-t.png HTTP&#x2F;1.1″</td>\n</tr>\n<tr>\n<td>$http_host</td>\n<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>\n<td>img.alipay.com10.253.70.103</td>\n</tr>\n<tr>\n<td>$status</td>\n<td>HTTP请求状态</td>\n<td>200</td>\n</tr>\n<tr>\n<td>$upstream_status</td>\n<td>upstream状态</td>\n<td>200</td>\n</tr>\n<tr>\n<td>$body_bytes_sent</td>\n<td>发送给客户端文件内容大小</td>\n<td>547</td>\n</tr>\n<tr>\n<td>$http_referer</td>\n<td>跳转来源</td>\n<td>“<a href=\"https://cashier.alip/\">https://cashier.alip</a>ay.com…&#x2F;”</td>\n</tr>\n<tr>\n<td>$http_user_agent</td>\n<td>用户终端代理</td>\n<td>“Mozilla&#x2F;4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident&#x2F;4.0; SV1; GTB7.0; .NET4.0C;</td>\n</tr>\n<tr>\n<td>$ssl_protocol</td>\n<td>SSL协议版本</td>\n<td>TLSv1</td>\n</tr>\n<tr>\n<td>$ssl_cipher</td>\n<td>交换数据中的算法</td>\n<td>RC4-SHA</td>\n</tr>\n<tr>\n<td>$upstream_addr</td>\n<td>后台upstream的地址，即真正提供服务的主机地址</td>\n<td>10.228.35.247:80</td>\n</tr>\n<tr>\n<td>$request_time</td>\n<td>整个请求的总时间</td>\n<td>0.205</td>\n</tr>\n<tr>\n<td>$upstream_response_time</td>\n<td>请求过程中，upstream响应时间</td>\n<td>0.002</td>\n</tr>\n</tbody></table>\n<h3 id=\"7-3-错误日志\"><a href=\"#7-3-错误日志\" class=\"headerlink\" title=\"7.3 错误日志\"></a>7.3 错误日志</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-4-日志切割logrotate\"><a href=\"#7-4-日志切割logrotate\" class=\"headerlink\" title=\"7.4 日志切割logrotate\"></a>7.4 日志切割logrotate</h3><p>配置文件，一般不需要修改，默认就行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 logrotate.d]# cat &#x2F;etc&#x2F;logrotate.d&#x2F;nginx\n&#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log &#123;\n    create 0640 nginx root\t \t\n    daily\t# 每天切割日志\n    rotate 10\n    missingok\t# 日志丢失忽略\n    notifempty\n    compress\t# 日志文件压缩\n    sharedscripts\n    postrotate\n        &#x2F;bin&#x2F;kill -USR1 &#96;cat &#x2F;run&#x2F;nginx.pid 2&gt;&#x2F;dev&#x2F;null&#96; 2&gt;&#x2F;dev&#x2F;null || true\n    endscript\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Nginx简介\"><a href=\"#一、Nginx简介\" class=\"headerlink\" title=\"一、Nginx简介\"></a>一、Nginx简介</h2><p>参考网站：<a href=\"https://zhuanlan.zhihu.com/p/266153320\">https://zhuanlan.zhihu.com/p/266153320</a></p>\n<h2 id=\"二、Nginx安装\"><a href=\"#二、Nginx安装\" class=\"headerlink\" title=\"二、Nginx安装\"></a>二、Nginx安装</h2><p>​\tnginx有两种安装方式，yum安装和源码编译安装</p>\n<h3 id=\"2-1-yum安装（epel源）\"><a href=\"#2-1-yum安装（epel源）\" class=\"headerlink\" title=\"2.1 yum安装（epel源）\"></a>2.1 yum安装（epel源）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo\n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n\nyum clean all\nyum makecache\n\nyum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-编译安装\"><a href=\"#2-2-编译安装\" class=\"headerlink\" title=\"2.2 编译安装\"></a>2.2 编译安装</h3><p>查看yum安装的nginx的编译参数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# nginx -V\nnginx version: nginx&#x2F;1.20.1\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC)\nbuilt with OpenSSL 1.1.1g FIPS  21 Apr 2020\nTLS SNI support enabled\nconfigure arguments: --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>源码获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.20.1.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>构建与编译</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 解压源码文件并进入文件夹内\ntar -vxf nginx-1.20.1.tar.gz &amp;&amp; cd nginx-1.20.1\n\n# configure构建\n.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt&#x3D;&#39;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE&#x3D;2 -fexceptions -fstack-protector-strong --param&#x3D;ssp-buffer-size&#x3D;4 -grecord-gcc-switches -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-cc1 -m64 -mtune&#x3D;generic&#39; --with-ld-opt&#x3D;&#39;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&#39;\n\n# 编译并安装\nmake -j 4 &amp;&amp; make install<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>错误解决</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 错误1：\n.&#x2F;configure: error: the invalid value in --with-ld-opt&#x3D;&quot;-Wl,-z,relro -specs&#x3D;&#x2F;usr&#x2F;lib&#x2F;rpm&#x2F;redhat&#x2F;redhat-hardened-ld -Wl,-E&quot;\n解决方法：\nyum -y install redhat-rpm-config.noarch\n\n# 错误2：\n.&#x2F;configure: error: the HTTP rewrite module requires the PCRE library.\nYou can either disable the module by using --without-http_rewrite_module\noption, or install the PCRE library into the system, or build the PCRE library\nstatically from the source with nginx by using --with-pcre&#x3D;&lt;path&gt; option.\n解决方法：\nyum install pcre-devel -y\n\n# 错误3：\n.&#x2F;configure: error: SSL modules require the OpenSSL library.\nYou can either do not enable the modules, or install the OpenSSL library\ninto the system, or build the OpenSSL library statically from the source\nwith nginx by using --with-openssl&#x3D;&lt;path&gt; option.\n解决方法：\nyum install openssl openssl-devel -y\n\n# 错误4：\n.&#x2F;configure: error: the HTTP XSLT module requires the libxml2&#x2F;libxslt\nlibraries. You can either do not enable the module or install the libraries.\n解决方法：\nyum install libxml2 libxml2-devel libxslt  libxslt-devel -y\n\n# 错误5：\n.&#x2F;configure: error: the HTTP image filter module requires the GD library.\nYou can either do not enable the module or install the libraries.\n解决方法：\nyum -y install gd-devel\n\n# 错误6：\n.&#x2F;configure: error: perl module ExtUtils::Embed is required\n\n解决方法： \nyum -y install perl-devel perl-ExtUtils-Embed\n\n# 错误7：\n.&#x2F;configure: error: the Google perftools module requires the Google perftools library\n解决方法：\nyum install gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64 -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-启动和停止服务\"><a href=\"#2-3-启动和停止服务\" class=\"headerlink\" title=\"2.3 启动和停止服务\"></a>2.3 启动和停止服务</h3><p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 先关闭httpd服务，防止冲突\n[root@web01 ~]# systemctl stop httpd\n[root@web01 ~]# systemctl disable httpd\n\n# 再启动nginx服务\n[root@web01 ~]# systemctl enable nginx\n[root@web01 html]# systemctl start nginx\n# 另一种启动方式\nnginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>停止服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl stop nginx \n# 或者\nnginx -s stop <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>重启&#x2F;重载服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart&#x2F;reload nginx\nnginx -s restart&#x2F;reload <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：重载reload和重启restart的差别</p>\n<p>reload将会等服务进程执行完再重启，而restart则是强制重启</p>\n</blockquote>\n<h2 id=\"三、Nginx目录结构说明\"><a href=\"#三、Nginx目录结构说明\" class=\"headerlink\" title=\"三、Nginx目录结构说明\"></a>三、Nginx目录结构说明</h2><p>查看nginx的目录结构</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 html]# rpm -ql nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>参考链接：</p>\n<p><a href=\"https://zhuanlan.zhihu.com/p/137262519\">https://zhuanlan.zhihu.com/p/137262519</a></p>\n<h2 id=\"四、Nginx配置文件说明\"><a href=\"#四、Nginx配置文件说明\" class=\"headerlink\" title=\"四、Nginx配置文件说明\"></a>四、Nginx配置文件说明</h2><blockquote>\n<p>http server location扩展了解项<br>http{}层下允许有多个Server{}层，一个Server{}层下又允许有多个Location<br>http{} 标签主要用来解决用户的请求与响应。<br>server{} 标签主要用来响应具体的某一个网站。<br>location{} 标签主要用于匹配网站具体URL路径。</p>\n</blockquote>\n<p>主配置文件说明</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 html]# cat &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\n---核心模块---\nuser nginx;\t#nginx进程运行的用户\nworker_processes auto;\t#nginx工作的进程数量\nerror_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;\t#nginx的错误日志【警告及其警告以上的都记录】\npid &#x2F;run&#x2F;nginx.pid;\t#nginx进程运行后的进程id\n---核心模块---\n\n# Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx&#x2F;README.dynamic.\ninclude &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;\n\n---事件模块---\nevents &#123;\n    worker_connections 1024; # 一个work进程的最大连接数\n    use epool;\t\t\t\t #使用epool网络模型\n&#125;\n---事件模块---\n\n---http核心层模块---\nhttp &#123;\n\t# 日志格式定义\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;\t# 访问日志\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\t# 长连接超时时间\n    types_hash_max_size 4096;\n    #gzip on;\t\t\t#是否开启压缩功能\t\t\t\n\n    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;\n    default_type        application&#x2F;octet-stream;\n\n    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;\t# 包含哪个目录下面的*.conf文件，用于写server\n\n    server &#123;\n        listen       80;\t# 监听端口\n        listen       [::]:80;\n        server_name  _;\t\t# 域名\n        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n\n\t\t#charset koi8-r;\t\t\t#字符集\n\n\t\tlocation &#x2F; &#123;\t \t\t\t#位置\n\t\t\troot   &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t&#125;\n\t\tlocation &#x2F;test &#123;\t \t\t\t#位置\n\t\t\troot   &#x2F;code&#x2F;test&#x2F;123&#x2F;;\t#代码的主文件位置\n\t\t\tindex  index.html index.htm;\t#服务端默认返回给用户的文件\n\t\t&#125;\n\n        # Load configuration files for the default server block.\n        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n\n        error_page 404 &#x2F;404.html;\n        location &#x3D; &#x2F;404.html &#123;\n        &#125;\n\n        error_page 500 502 503 504 &#x2F;50x.html;\n        location &#x3D; &#x2F;50x.html &#123;\n        &#125;\n    &#125;\n&#125;\n---http核心层模块---<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、案例：搭建web网站\"><a href=\"#五、案例：搭建web网站\" class=\"headerlink\" title=\"五、案例：搭建web网站\"></a>五、案例：搭建web网站</h2><p>准备配置文件ds</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;game.conf\nserver &#123;\n        listen 80;\n        server_name game.oldboy.com;\n\n        location &#x2F; &#123;\n                root &#x2F;code;\n                index index.html;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照配置文件创建文件夹并放入html项目文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;code\ncp html5.zip &#x2F;code\ncd &#x2F;code\nunzip html5.zip\n\n[root@web01 code]# ls\nceshi  game  html5.zip  img  index.html  __MACOSX  readme.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart nginx\nsystemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>通过物理机浏览器浏览</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 修改hosts文件\n10.0.0.7 game.oldboy.com\n# 网页访问\ngame.oldboy.com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、Nginx虚拟主机\"><a href=\"#六、Nginx虚拟主机\" class=\"headerlink\" title=\"六、Nginx虚拟主机\"></a>六、Nginx虚拟主机</h2><p>Nginx配置虚拟主机有如下三种方式：</p>\n<ul>\n<li>单主机多IP</li>\n<li>单主机多端口</li>\n<li>单主机多域名</li>\n</ul>\n<h3 id=\"6-1-基于主机多IP方式-不常用\"><a href=\"#6-1-基于主机多IP方式-不常用\" class=\"headerlink\" title=\"6.1 基于主机多IP方式(不常用)\"></a>6.1 基于主机多IP方式(不常用)</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat ip.conf \nserver &#123;\n\tlisten 10.0.0.7:80;\n\tserver_name _;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code_ip_eth0;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\nserver &#123;\n\tlisten 172.16.1.7:80;\n\tserver_name _;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code_ip_eth1;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n2.根据配置创建目录\n[root@web01 conf.d]# mkdir &#x2F;code_ip_eth0\n[root@web01 conf.d]# echo &quot;Eth0&quot; &gt; &#x2F;code_ip_eth0&#x2F;index.html\n\n[root@web01 conf.d]# mkdir &#x2F;code_ip_eth1\n[root@web01 conf.d]# echo &quot;Eth1&quot; &gt; &#x2F;code_ip_eth1&#x2F;index.html\n\n3.重启nginx服务\n[root@web01 conf.d]# systemctl restart nginx\n\n4.使用curl命令测试\n[root@web01 ~]# curl 172.16.1.7\nEth1\n[root@web01 ~]# curl 10.0.0.7\nEth0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-2-基于主机多端口方式（多用于内部测试）\"><a href=\"#6-2-基于主机多端口方式（多用于内部测试）\" class=\"headerlink\" title=\"6.2 基于主机多端口方式（多用于内部测试）\"></a>6.2 基于主机多端口方式（多用于内部测试）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.配置多端口的虚拟主机\n[root@web01 conf.d]# vim port.conf\nserver &#123;\n        listen 81;\n        \n        location &#x2F; &#123; \n                root &#x2F;code_81;\n                index index.html;\n        &#125;\n&#125;\nserver &#123;\n        listen 82;\n        \n        location &#x2F; &#123; \n                root &#x2F;code_82;\n                index index.html;\n        &#125;\n&#125;\t\t\n\n2.根据配置文件创建所需的目录\n[root@web01 conf.d]# mkdir &#x2F;code_8&#123;1..2&#125;\n[root@web01 conf.d]# echo &quot;81&quot; &gt; &#x2F;code_81&#x2F;index.html\n[root@web01 conf.d]# echo &quot;82&quot; &gt; &#x2F;code_82&#x2F;index.html\n\n3.检查语法并重启服务\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n\n\n4.如何去访问\n\thttp:&#x2F;&#x2F;10.0.0.7:82&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-3-基于主机多域名方式（常用）\"><a href=\"#6-3-基于主机多域名方式（常用）\" class=\"headerlink\" title=\"6.3 基于主机多域名方式（常用）\"></a>6.3 基于主机多域名方式（常用）</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.准备多虚拟主机配置文件\n[root@web01 conf.d]# cat test1.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test1;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n[root@web01 conf.d]# cat test2.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name test2.oldboy.com;\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test2;\n\t\tindex index.html;\n\t&#125;\n&#125;\n\n2.根据配置文件创建对应的目录\n[root@web01 conf.d]# mkdir &#x2F;code&#x2F;test&#123;1..2&#125; -p\n[root@web01 conf.d]# echo &quot;test1_server&quot; &gt; &#x2F;code&#x2F;test1&#x2F;index.html\n[root@web01 conf.d]# echo &quot;test2_server&quot; &gt; &#x2F;code&#x2F;test2&#x2F;index.html\n[root@web01 conf.d]# nginx -t\n[root@web01 conf.d]# systemctl restart nginx\n\n3.配置域名解析\n10.0.0.7      test1.oldboy.com\n10.0.0.7      test2.oldboy.com\n\n4.通过浏览器访问该网站<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"七、日志与错误排查\"><a href=\"#七、日志与错误排查\" class=\"headerlink\" title=\"七、日志与错误排查\"></a>七、日志与错误排查</h2><h3 id=\"7-1-nginx配置文件自查\"><a href=\"#7-1-nginx配置文件自查\" class=\"headerlink\" title=\"7.1 nginx配置文件自查\"></a>7.1 nginx配置文件自查</h3><p>1.修改完配置记得检查语法</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">nginx -t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2.如果没有检查语法，直接重载导致报错，可查看错误信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl status nginx -l <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-2-访问日志\"><a href=\"#7-2-访问日志\" class=\"headerlink\" title=\"7.2 访问日志\"></a>7.2 访问日志</h3><p>可以为server和location单独设置访问日志（<em><strong>涉及日志作用域</strong></em>）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">server &#123;\n    listen 80;\n    server_name code.oldboy.com;\n    \n    # 将当前的server网站的访问日志记录至对应的目录，使用main格式\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;code.oldboy.com.log main;\n    location &#x2F; &#123;\n        root &#x2F;code;\n    &#125;\n\t\n    # 当有人请求改favicon.ico时，不记录日志\n    location &#x2F;favicon.ico &#123;\n        access_log off;  # off 关闭\n        return 200;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>访问日志参数详解</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<table>\n<thead>\n<tr>\n<th><strong>变量名称</strong></th>\n<th><strong>变量描述</strong></th>\n<th><strong>举例说明</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>$remote_addr</td>\n<td>客户端地址</td>\n<td>113.140.15.90</td>\n</tr>\n<tr>\n<td>$remote_user</td>\n<td>客户端用户名称</td>\n<td>–</td>\n</tr>\n<tr>\n<td>$time_local</td>\n<td>访问时间和时区</td>\n<td>18&#x2F;Jul&#x2F;2012:17:00:01 +0800</td>\n</tr>\n<tr>\n<td>$request</td>\n<td>请求的URI和HTTP协议</td>\n<td>“GET &#x2F;pa&#x2F;img&#x2F;home&#x2F;logo-alipay-t.png HTTP&#x2F;1.1″</td>\n</tr>\n<tr>\n<td>$http_host</td>\n<td>请求地址，即浏览器中你输入的地址（IP或域名）</td>\n<td>img.alipay.com10.253.70.103</td>\n</tr>\n<tr>\n<td>$status</td>\n<td>HTTP请求状态</td>\n<td>200</td>\n</tr>\n<tr>\n<td>$upstream_status</td>\n<td>upstream状态</td>\n<td>200</td>\n</tr>\n<tr>\n<td>$body_bytes_sent</td>\n<td>发送给客户端文件内容大小</td>\n<td>547</td>\n</tr>\n<tr>\n<td>$http_referer</td>\n<td>跳转来源</td>\n<td>“<a href=\"https://cashier.alip/\">https://cashier.alip</a>ay.com…&#x2F;”</td>\n</tr>\n<tr>\n<td>$http_user_agent</td>\n<td>用户终端代理</td>\n<td>“Mozilla&#x2F;4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident&#x2F;4.0; SV1; GTB7.0; .NET4.0C;</td>\n</tr>\n<tr>\n<td>$ssl_protocol</td>\n<td>SSL协议版本</td>\n<td>TLSv1</td>\n</tr>\n<tr>\n<td>$ssl_cipher</td>\n<td>交换数据中的算法</td>\n<td>RC4-SHA</td>\n</tr>\n<tr>\n<td>$upstream_addr</td>\n<td>后台upstream的地址，即真正提供服务的主机地址</td>\n<td>10.228.35.247:80</td>\n</tr>\n<tr>\n<td>$request_time</td>\n<td>整个请求的总时间</td>\n<td>0.205</td>\n</tr>\n<tr>\n<td>$upstream_response_time</td>\n<td>请求过程中，upstream响应时间</td>\n<td>0.002</td>\n</tr>\n</tbody></table>\n<h3 id=\"7-3-错误日志\"><a href=\"#7-3-错误日志\" class=\"headerlink\" title=\"7.3 错误日志\"></a>7.3 错误日志</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-4-日志切割logrotate\"><a href=\"#7-4-日志切割logrotate\" class=\"headerlink\" title=\"7.4 日志切割logrotate\"></a>7.4 日志切割logrotate</h3><p>配置文件，一般不需要修改，默认就行</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 logrotate.d]# cat &#x2F;etc&#x2F;logrotate.d&#x2F;nginx\n&#x2F;var&#x2F;log&#x2F;nginx&#x2F;*.log &#123;\n    create 0640 nginx root\t \t\n    daily\t# 每天切割日志\n    rotate 10\n    missingok\t# 日志丢失忽略\n    notifempty\n    compress\t# 日志文件压缩\n    sharedscripts\n    postrotate\n        &#x2F;bin&#x2F;kill -USR1 &#96;cat &#x2F;run&#x2F;nginx.pid 2&gt;&#x2F;dev&#x2F;null&#96; 2&gt;&#x2F;dev&#x2F;null || true\n    endscript\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n"},{"title":"运维之综合架构--07--Nginx(二)常用官方模块","date":"2022-07-06T03:19:52.000Z","_content":"\n>>>>本篇主要介绍Nginx的常用官方模块\n\n## 一、目录索引-autoindex\n\n### 1.1 使用方法1\n\n按此方法设置后，访问网页http://module.test.com将显示文件目录\n\n实际目录位于: /module\n\na.准备配置文件\n\n```shell\n[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf\nserver {\n\tlisten 80;\n\tserver_name module.test.com;\n\tcharset utf-8,gbk; # 解决中文乱码\n\n\tlocation / {\n\t\troot /module;\n\t\tautoindex on;\t# 开启目录索引\n\t\tautoindex_exact_size off;\t# 显示文件大小，默认为on显示字节，off显示大概单位\n\t\tautoindex_localtime on;\t# 默认off显示UTC时间，on显示本地时间\n\t}\n}\n```\n\nb.准备对应的目录，并往目录中添加文件\n\n```shell\nmkdir /module/{centos,ubuntu,redhat}/ -p\n```\n\nc.检查语法并重新加载nginx\n\n```shell\nnginx -t \nsystemctl restart nginx\n```\n\n### 1.2 使用方法2（推荐）\n\n按此方法设置后，访问网页http://www.module.test.com/download将显示文件目录,主页可正常访问\n\n实际目录位于：/module/download\n\n```shell\n[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf \nserver {\n\tlisten 80;\n\tserver_name module.oldboy.com;\n\tcharset utf-8,gbk;\n\n\tlocation / {\t# 主页可以正常访问\n\t\troot /code;\n\t\tindex index.html index.htm;\n\t}\n\n\tlocation /download {\t# 当访问http://xxxx/download则访问/module/download文件夹，显示目录索引\n\t\troot /module; # 此时，访问的文件夹是/module/download\n\t\tautoindex on;\n\t\tautoindex_exact_size off;\n\t\tautoindex_localtime on;\n\t}\n}\n```\n\n## 二、 状态监控页面-stub_status\n\n>需要nginx附带--with-http_stub_status_module模块才能使用\n\n### 2.1 使用方法\n\na.设置配置文件\n\n```shell\n在/etc/nginx/conf.d/autoindex.conf里面附加内容\nlocation /nginx_status {\n\tstub_status;\n}\n```\n\nb.重启Nginx服务\n\n```shell\n重启nginx服务\nsystemctl reload nginx\n```\n\nc.网页访问测试\n\n```shell\n访问:\nhttp://module.test.com/nginx_status\n网页显示：\nActive connections: 2 \nserver accepts handled requests\n\t\t3 \t\t\t3 \t33 \nReading: 0 Writing: 1 Waiting: 1 \n```\n\nd.通过选项关闭长连接\n\n```shell\n# 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证\nkeepalive_timeout  0;   # 类似于关闭长连接\nkeepalive_timeout  65;  # 65s没有活动则断开连接\n```\n\n```shell\n在/etc/nginx/conf.d/autoindex.conf里面的附加内容修改为\nlocation /nginx_status {\n\tstub_status;\n\tkeepalive_timeout  0; \n}\n```\n\ne.再次测试网页访问\n\n```shell\n关闭长连接后的显示：\nActive connections: 2 \nserver accepts handled requests\n 21 21 20 \nReading: 0 Writing: 1 Waiting: 1 \n# 可见每次HTTP请求都要重新发起TCP连接\n```\n\n### 2.2 监控页面内容解释\n\n| 参数项             | 作用                                        |\n| ------------------ | ------------------------------------------- |\n| Active connections | 当前活动客户端连接数，包括Waiting等待连接数 |\n| accepts            | 已接受总的TCP连接数                         |\n| handled            | 已处理总的TCP连接数                         |\n| requests           | 客户端总的http请求数                        |\n| Reading            | 当前nginx读取请求头的连接数                 |\n| Writing            | 当前nginx将响应写回客户端的连接数           |\n| Waiting            | 当前等待请求的空闲客户端连接数              |\n\n## 三、基于IP的访问控制\n\n>某网页内的数据比较重要，怎么控制那些人可以访问，那些人不能访问呢？\n\n可以来源的IP地址做限制，常用的三种控制方法：\n\n- 拒绝10.0.0.1来源IP访问，其他人允许\n\n  ```shell\n  location /nginx_status {\n      stub_status;\n      deny 10.0.0.1/32;\n      allow all;\n  }\n  ```\n\n- 允许10.0.0.1来源IP访问，其他人全部拒绝\n\n  ```shell\n  location /nginx_status {\n      stub_status;\n      allow 10.0.0.1/32;\n      deny all;\n  }\n  ```\n\n- 实际配置监控Nginx状态时，仅允许该服务器的回环地址访问127.0.0.1\n\n  ```shell\n  # 最安全\n  location /nginx_status {\n      stub_status;\n      allow 127.0.0.1;\n      deny all;\n  }\n  ```\n\n## 四、基于密码的身份验证\n\n>重要数据网站，要实现需要用户名密码认证，怎么做呢？\n\n1. 生成一个密码文件，密码文件的格式  name:password(加密)  （建议使用htpasswd）  openssl password\n\n   ```shell\n   [root@web01 conf.d]# yum install httpd-tools -y\n   [root@web01 conf.d]# htpasswd -c -b /etc/nginx/auth_conf oldboy oldboy\n   [root@web01 conf.d]# cat /etc/nginx/auth_conf\n   oldboy:$apr1$Kp87VSae$658Nt5bm4iiblQkUvP7u61\n   ```\n\n2. 配置Nginx，限制对应的资源\n\n   ```shell\n   \tlocation /download {\n   \t\troot /module;\n   \t\tautoindex on;\n   \t\tautoindex_exact_size off;\n   \t\tautoindex_localtime on;\n   \t\t\n   \t\tauth_basic \"Please Password!!!\";\n   \t\tauth_basic_user_file /etc/nginx/auth_conf; \n   \t\t# 注意认证文件路径，否则网页认证后会403，可是为什么放其他目录就不行？\n   \t}\n   ```\n\n## 五、Nginx连接限制\n\n>网站请求数太多，不堪重负了，怎么保障部分用户能够正常访问\n\n### 5.1 限制连接数\n\n`设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求`\n\n- 编辑配置文件\n\n  ```shell\n  # http标签段定义连接限制\n  http{\n      limit_conn_zone $binary_remote_addr zone=conn_zone:10m;\n  }\n  server {\n      # 同一时刻只允许一个客户端连接\n      limit_conn conn_zone 1; \n  \n      location / {\n          root /code;\n          index index.html;\n      }\n  ```\n\n- 使用ab工具进行压力测试\n\n  ````shell\n  # 使用ab工具进行压力测试\n  [root@xuliangwei ~]# yum install -y httpd-tools\n  [root@xuliangwei ~]# ab -n 500 -c 2  http://127.0.0.1/index.html\n  # 可见500次中有失败的请求\n  ````\n\n- 查看拦截日志\n\n  ```shell\n  tail -f /var/log/nginx/error.log\n  类似于\n  2019/01/14 11:11:22 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:23 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:25 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:25 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  ```\n\n\n### 5.2 限制请求数（更精准）\n\n`设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。`\n\n- 定义限制的Key\n\n  ```shell\n  [root@web01 conf.d]# cat test1.oldboy.com.conf \n  limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;\n  server {\n  \tlisten 80;\n  \tserver_name test1.oldboy.com;\n  \t\n  \tlimit_req zone=req_zone burst=5 nodelay;\n  \tlimit_req_status 412;\n  \terror_page 412 /err.html;    #这个文件必须存在/code/test1/err.html\n  \n  \tlocation / {\n  \t\troot /code/test1;\n  \t\tindex index.html;\n  \t}\n  }\n  ```\n\n- 填写hosts域名解析 （测试：域名访问才有效果，直接访问没效果）\n\n  ```shell\n  echo \"10.0.0.7 test1.oldboy.com\" >> /etc/hosts\n  ```\n\n- 压力测试\n\n  ```shell\n  ab -n 50 -c 20 http://test1.oldboy.com/index.html\n  ```\n\n- 查看错误日志\n\n  ```shell\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.737 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.611 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.450 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  ```\n\n## 六、Nginx匹配符和优先级\n\nLocation语法示例\n\n```shell\nlocation [=|^~|~|~*|!~|!~*|/] /uri/ { ...\n}\n```\n\n匹配优先级\n\n```shell\n匹配符\t匹配规则\t\t\t\t\t\t优先级\n=\t\t精确匹配\t\t\t\t\t\t1 \t用到\n^~\t\t以某个字符串开头\t\t\t\t2\n~\t\t区分大小写的正则匹配\t\t\t3\t常用\n~*\t\t不区分大小写的正则匹配\t\t\t4\n!~\t\t区分大小写不匹配的正则\t\t\t5\n!~*\t\t不区分大小写不匹配的正则\t\t6\n/\t\t通用匹配，任何请求都会匹配到\t7\t常用\n```\n\n### 6.1 匹配案例\n\n> 参考网站：https://blog.csdn.net/qq_41980405/article/details/111402208\n\n- 通用匹配，任何请求都会匹配到\n\n  ```nginx\n  location / {\n      ...\n  }\n  ```\n\n- 严格区分大小写，匹配以.php结尾的都走这个location    \n\n  ```nginx\n  location ~ \\.php$ {\n      ...\n  }\n  ```\n\n- 严格区分大小写，匹配以.jsp结尾的都走这个location \n\n  ```nginx\n  location ~ \\.jsp$ {\n      ...\n  }\n  ```\n\n- 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location\n\n  ```nginx\n  location ~* .*\\.(jpg|gif|png|js|css|mp4)$ {\n      ...\n  }\n  ```\n\n- 不区分大小写匹配\n\n  ```nginx\n  location ~* \"\\.(sql|bak|tgz|tar.gz|.git)$\" {\n      ...\n  }\n  ```\n\n  \n\n","source":"_posts/01_运维/02-综合架构/08-Nginx(二)常用官方模块.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(二)常用官方模块\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n>>>>本篇主要介绍Nginx的常用官方模块\n\n## 一、目录索引-autoindex\n\n### 1.1 使用方法1\n\n按此方法设置后，访问网页http://module.test.com将显示文件目录\n\n实际目录位于: /module\n\na.准备配置文件\n\n```shell\n[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf\nserver {\n\tlisten 80;\n\tserver_name module.test.com;\n\tcharset utf-8,gbk; # 解决中文乱码\n\n\tlocation / {\n\t\troot /module;\n\t\tautoindex on;\t# 开启目录索引\n\t\tautoindex_exact_size off;\t# 显示文件大小，默认为on显示字节，off显示大概单位\n\t\tautoindex_localtime on;\t# 默认off显示UTC时间，on显示本地时间\n\t}\n}\n```\n\nb.准备对应的目录，并往目录中添加文件\n\n```shell\nmkdir /module/{centos,ubuntu,redhat}/ -p\n```\n\nc.检查语法并重新加载nginx\n\n```shell\nnginx -t \nsystemctl restart nginx\n```\n\n### 1.2 使用方法2（推荐）\n\n按此方法设置后，访问网页http://www.module.test.com/download将显示文件目录,主页可正常访问\n\n实际目录位于：/module/download\n\n```shell\n[root@web01 module]# cat /etc/nginx/conf.d/autoindex.conf \nserver {\n\tlisten 80;\n\tserver_name module.oldboy.com;\n\tcharset utf-8,gbk;\n\n\tlocation / {\t# 主页可以正常访问\n\t\troot /code;\n\t\tindex index.html index.htm;\n\t}\n\n\tlocation /download {\t# 当访问http://xxxx/download则访问/module/download文件夹，显示目录索引\n\t\troot /module; # 此时，访问的文件夹是/module/download\n\t\tautoindex on;\n\t\tautoindex_exact_size off;\n\t\tautoindex_localtime on;\n\t}\n}\n```\n\n## 二、 状态监控页面-stub_status\n\n>需要nginx附带--with-http_stub_status_module模块才能使用\n\n### 2.1 使用方法\n\na.设置配置文件\n\n```shell\n在/etc/nginx/conf.d/autoindex.conf里面附加内容\nlocation /nginx_status {\n\tstub_status;\n}\n```\n\nb.重启Nginx服务\n\n```shell\n重启nginx服务\nsystemctl reload nginx\n```\n\nc.网页访问测试\n\n```shell\n访问:\nhttp://module.test.com/nginx_status\n网页显示：\nActive connections: 2 \nserver accepts handled requests\n\t\t3 \t\t\t3 \t33 \nReading: 0 Writing: 1 Waiting: 1 \n```\n\nd.通过选项关闭长连接\n\n```shell\n# 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证\nkeepalive_timeout  0;   # 类似于关闭长连接\nkeepalive_timeout  65;  # 65s没有活动则断开连接\n```\n\n```shell\n在/etc/nginx/conf.d/autoindex.conf里面的附加内容修改为\nlocation /nginx_status {\n\tstub_status;\n\tkeepalive_timeout  0; \n}\n```\n\ne.再次测试网页访问\n\n```shell\n关闭长连接后的显示：\nActive connections: 2 \nserver accepts handled requests\n 21 21 20 \nReading: 0 Writing: 1 Waiting: 1 \n# 可见每次HTTP请求都要重新发起TCP连接\n```\n\n### 2.2 监控页面内容解释\n\n| 参数项             | 作用                                        |\n| ------------------ | ------------------------------------------- |\n| Active connections | 当前活动客户端连接数，包括Waiting等待连接数 |\n| accepts            | 已接受总的TCP连接数                         |\n| handled            | 已处理总的TCP连接数                         |\n| requests           | 客户端总的http请求数                        |\n| Reading            | 当前nginx读取请求头的连接数                 |\n| Writing            | 当前nginx将响应写回客户端的连接数           |\n| Waiting            | 当前等待请求的空闲客户端连接数              |\n\n## 三、基于IP的访问控制\n\n>某网页内的数据比较重要，怎么控制那些人可以访问，那些人不能访问呢？\n\n可以来源的IP地址做限制，常用的三种控制方法：\n\n- 拒绝10.0.0.1来源IP访问，其他人允许\n\n  ```shell\n  location /nginx_status {\n      stub_status;\n      deny 10.0.0.1/32;\n      allow all;\n  }\n  ```\n\n- 允许10.0.0.1来源IP访问，其他人全部拒绝\n\n  ```shell\n  location /nginx_status {\n      stub_status;\n      allow 10.0.0.1/32;\n      deny all;\n  }\n  ```\n\n- 实际配置监控Nginx状态时，仅允许该服务器的回环地址访问127.0.0.1\n\n  ```shell\n  # 最安全\n  location /nginx_status {\n      stub_status;\n      allow 127.0.0.1;\n      deny all;\n  }\n  ```\n\n## 四、基于密码的身份验证\n\n>重要数据网站，要实现需要用户名密码认证，怎么做呢？\n\n1. 生成一个密码文件，密码文件的格式  name:password(加密)  （建议使用htpasswd）  openssl password\n\n   ```shell\n   [root@web01 conf.d]# yum install httpd-tools -y\n   [root@web01 conf.d]# htpasswd -c -b /etc/nginx/auth_conf oldboy oldboy\n   [root@web01 conf.d]# cat /etc/nginx/auth_conf\n   oldboy:$apr1$Kp87VSae$658Nt5bm4iiblQkUvP7u61\n   ```\n\n2. 配置Nginx，限制对应的资源\n\n   ```shell\n   \tlocation /download {\n   \t\troot /module;\n   \t\tautoindex on;\n   \t\tautoindex_exact_size off;\n   \t\tautoindex_localtime on;\n   \t\t\n   \t\tauth_basic \"Please Password!!!\";\n   \t\tauth_basic_user_file /etc/nginx/auth_conf; \n   \t\t# 注意认证文件路径，否则网页认证后会403，可是为什么放其他目录就不行？\n   \t}\n   ```\n\n## 五、Nginx连接限制\n\n>网站请求数太多，不堪重负了，怎么保障部分用户能够正常访问\n\n### 5.1 限制连接数\n\n`设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求`\n\n- 编辑配置文件\n\n  ```shell\n  # http标签段定义连接限制\n  http{\n      limit_conn_zone $binary_remote_addr zone=conn_zone:10m;\n  }\n  server {\n      # 同一时刻只允许一个客户端连接\n      limit_conn conn_zone 1; \n  \n      location / {\n          root /code;\n          index index.html;\n      }\n  ```\n\n- 使用ab工具进行压力测试\n\n  ````shell\n  # 使用ab工具进行压力测试\n  [root@xuliangwei ~]# yum install -y httpd-tools\n  [root@xuliangwei ~]# ab -n 500 -c 2  http://127.0.0.1/index.html\n  # 可见500次中有失败的请求\n  ````\n\n- 查看拦截日志\n\n  ```shell\n  tail -f /var/log/nginx/error.log\n  类似于\n  2019/01/14 11:11:22 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:23 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:25 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  2019/01/14 11:11:25 [error] 29962#29962: *19 limiting connections by zone \"conn_zone\", client: 47.110.176.164, server: www.xuliangwei.com, request: \"GET / HTTP/1.1\", host: \"www.xuliangwei.com\"\n  ```\n\n\n### 5.2 限制请求数（更精准）\n\n`设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。`\n\n- 定义限制的Key\n\n  ```shell\n  [root@web01 conf.d]# cat test1.oldboy.com.conf \n  limit_req_zone $binary_remote_addr zone=req_zone:10m rate=1r/s;\n  server {\n  \tlisten 80;\n  \tserver_name test1.oldboy.com;\n  \t\n  \tlimit_req zone=req_zone burst=5 nodelay;\n  \tlimit_req_status 412;\n  \terror_page 412 /err.html;    #这个文件必须存在/code/test1/err.html\n  \n  \tlocation / {\n  \t\troot /code/test1;\n  \t\tindex index.html;\n  \t}\n  }\n  ```\n\n- 填写hosts域名解析 （测试：域名访问才有效果，直接访问没效果）\n\n  ```shell\n  echo \"10.0.0.7 test1.oldboy.com\" >> /etc/hosts\n  ```\n\n- 压力测试\n\n  ```shell\n  ab -n 50 -c 20 http://test1.oldboy.com/index.html\n  ```\n\n- 查看错误日志\n\n  ```shell\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.737 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.611 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  2019/01/14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.450 by zone \"req_zone\", client: 10.0.0.1, server: test1.oldboy.com, request: \"GET / HTTP/1.1\", host: \"test1.oldboy.com\"\n  ```\n\n## 六、Nginx匹配符和优先级\n\nLocation语法示例\n\n```shell\nlocation [=|^~|~|~*|!~|!~*|/] /uri/ { ...\n}\n```\n\n匹配优先级\n\n```shell\n匹配符\t匹配规则\t\t\t\t\t\t优先级\n=\t\t精确匹配\t\t\t\t\t\t1 \t用到\n^~\t\t以某个字符串开头\t\t\t\t2\n~\t\t区分大小写的正则匹配\t\t\t3\t常用\n~*\t\t不区分大小写的正则匹配\t\t\t4\n!~\t\t区分大小写不匹配的正则\t\t\t5\n!~*\t\t不区分大小写不匹配的正则\t\t6\n/\t\t通用匹配，任何请求都会匹配到\t7\t常用\n```\n\n### 6.1 匹配案例\n\n> 参考网站：https://blog.csdn.net/qq_41980405/article/details/111402208\n\n- 通用匹配，任何请求都会匹配到\n\n  ```nginx\n  location / {\n      ...\n  }\n  ```\n\n- 严格区分大小写，匹配以.php结尾的都走这个location    \n\n  ```nginx\n  location ~ \\.php$ {\n      ...\n  }\n  ```\n\n- 严格区分大小写，匹配以.jsp结尾的都走这个location \n\n  ```nginx\n  location ~ \\.jsp$ {\n      ...\n  }\n  ```\n\n- 不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location\n\n  ```nginx\n  location ~* .*\\.(jpg|gif|png|js|css|mp4)$ {\n      ...\n  }\n  ```\n\n- 不区分大小写匹配\n\n  ```nginx\n  location ~* \"\\.(sql|bak|tgz|tar.gz|.git)$\" {\n      ...\n  }\n  ```\n\n  \n\n","slug":"01_运维/02-综合架构/08-Nginx(二)常用官方模块","published":1,"updated":"2022-07-06T07:16:20.254Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0h000ta8v7a7uc55p8","content":"<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>本篇主要介绍Nginx的常用官方模块</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<h2 id=\"一、目录索引-autoindex\"><a href=\"#一、目录索引-autoindex\" class=\"headerlink\" title=\"一、目录索引-autoindex\"></a>一、目录索引-autoindex</h2><h3 id=\"1-1-使用方法1\"><a href=\"#1-1-使用方法1\" class=\"headerlink\" title=\"1.1 使用方法1\"></a>1.1 使用方法1</h3><p>按此方法设置后，访问网页<a href=\"http://module.test.com将显示文件目录/\">http://module.test.com将显示文件目录</a></p>\n<p>实际目录位于: &#x2F;module</p>\n<p>a.准备配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf\nserver &#123;\n\tlisten 80;\n\tserver_name module.test.com;\n\tcharset utf-8,gbk; # 解决中文乱码\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;module;\n\t\tautoindex on;\t# 开启目录索引\n\t\tautoindex_exact_size off;\t# 显示文件大小，默认为on显示字节，off显示大概单位\n\t\tautoindex_localtime on;\t# 默认off显示UTC时间，on显示本地时间\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b.准备对应的目录，并往目录中添加文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;module&#x2F;&#123;centos,ubuntu,redhat&#125;&#x2F; -p<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>c.检查语法并重新加载nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nginx -t \nsystemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-使用方法2（推荐）\"><a href=\"#1-2-使用方法2（推荐）\" class=\"headerlink\" title=\"1.2 使用方法2（推荐）\"></a>1.2 使用方法2（推荐）</h3><p>按此方法设置后，访问网页<a href=\"http://www.module.test.com/download%E5%B0%86%E6%98%BE%E7%A4%BA%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95,%E4%B8%BB%E9%A1%B5%E5%8F%AF%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE\">http://www.module.test.com/download将显示文件目录,主页可正常访问</a></p>\n<p>实际目录位于：&#x2F;module&#x2F;download</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf \nserver &#123;\n\tlisten 80;\n\tserver_name module.oldboy.com;\n\tcharset utf-8,gbk;\n\n\tlocation &#x2F; &#123;\t# 主页可以正常访问\n\t\troot &#x2F;code;\n\t\tindex index.html index.htm;\n\t&#125;\n\n\tlocation &#x2F;download &#123;\t# 当访问http:&#x2F;&#x2F;xxxx&#x2F;download则访问&#x2F;module&#x2F;download文件夹，显示目录索引\n\t\troot &#x2F;module; # 此时，访问的文件夹是&#x2F;module&#x2F;download\n\t\tautoindex on;\n\t\tautoindex_exact_size off;\n\t\tautoindex_localtime on;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、-状态监控页面-stub-status\"><a href=\"#二、-状态监控页面-stub-status\" class=\"headerlink\" title=\"二、 状态监控页面-stub_status\"></a>二、 状态监控页面-stub_status</h2><blockquote>\n<p>需要nginx附带–with-http_stub_status_module模块才能使用</p>\n</blockquote>\n<h3 id=\"2-1-使用方法\"><a href=\"#2-1-使用方法\" class=\"headerlink\" title=\"2.1 使用方法\"></a>2.1 使用方法</h3><p>a.设置配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面附加内容\nlocation &#x2F;nginx_status &#123;\n\tstub_status;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b.重启Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">重启nginx服务\nsystemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>c.网页访问测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">访问:\nhttp:&#x2F;&#x2F;module.test.com&#x2F;nginx_status\n网页显示：\nActive connections: 2 \nserver accepts handled requests\n\t\t3 \t\t\t3 \t33 \nReading: 0 Writing: 1 Waiting: 1 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>d.通过选项关闭长连接</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证\nkeepalive_timeout  0;   # 类似于关闭长连接\nkeepalive_timeout  65;  # 65s没有活动则断开连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面的附加内容修改为\nlocation &#x2F;nginx_status &#123;\n\tstub_status;\n\tkeepalive_timeout  0; \n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>e.再次测试网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">关闭长连接后的显示：\nActive connections: 2 \nserver accepts handled requests\n 21 21 20 \nReading: 0 Writing: 1 Waiting: 1 \n# 可见每次HTTP请求都要重新发起TCP连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-监控页面内容解释\"><a href=\"#2-2-监控页面内容解释\" class=\"headerlink\" title=\"2.2 监控页面内容解释\"></a>2.2 监控页面内容解释</h3><table>\n<thead>\n<tr>\n<th>参数项</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Active connections</td>\n<td>当前活动客户端连接数，包括Waiting等待连接数</td>\n</tr>\n<tr>\n<td>accepts</td>\n<td>已接受总的TCP连接数</td>\n</tr>\n<tr>\n<td>handled</td>\n<td>已处理总的TCP连接数</td>\n</tr>\n<tr>\n<td>requests</td>\n<td>客户端总的http请求数</td>\n</tr>\n<tr>\n<td>Reading</td>\n<td>当前nginx读取请求头的连接数</td>\n</tr>\n<tr>\n<td>Writing</td>\n<td>当前nginx将响应写回客户端的连接数</td>\n</tr>\n<tr>\n<td>Waiting</td>\n<td>当前等待请求的空闲客户端连接数</td>\n</tr>\n</tbody></table>\n<h2 id=\"三、基于IP的访问控制\"><a href=\"#三、基于IP的访问控制\" class=\"headerlink\" title=\"三、基于IP的访问控制\"></a>三、基于IP的访问控制</h2><blockquote>\n<p>某网页内的数据比较重要，怎么控制那些人可以访问，那些人不能访问呢？</p>\n</blockquote>\n<p>可以来源的IP地址做限制，常用的三种控制方法：</p>\n<ul>\n<li><p>拒绝10.0.0.1来源IP访问，其他人允许</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;nginx_status &#123;\n    stub_status;\n    deny 10.0.0.1&#x2F;32;\n    allow all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>允许10.0.0.1来源IP访问，其他人全部拒绝</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;nginx_status &#123;\n    stub_status;\n    allow 10.0.0.1&#x2F;32;\n    deny all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>实际配置监控Nginx状态时，仅允许该服务器的回环地址访问127.0.0.1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 最安全\nlocation &#x2F;nginx_status &#123;\n    stub_status;\n    allow 127.0.0.1;\n    deny all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"四、基于密码的身份验证\"><a href=\"#四、基于密码的身份验证\" class=\"headerlink\" title=\"四、基于密码的身份验证\"></a>四、基于密码的身份验证</h2><blockquote>\n<p>重要数据网站，要实现需要用户名密码认证，怎么做呢？</p>\n</blockquote>\n<ol>\n<li><p>生成一个密码文件，密码文件的格式  name:password(加密)  （建议使用htpasswd）  openssl password</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# yum install httpd-tools -y\n[root@web01 conf.d]# htpasswd -c -b &#x2F;etc&#x2F;nginx&#x2F;auth_conf oldboy oldboy\n[root@web01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;auth_conf\noldboy:$apr1$Kp87VSae$658Nt5bm4iiblQkUvP7u61<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>配置Nginx，限制对应的资源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;download &#123;\n\troot &#x2F;module;\n\tautoindex on;\n\tautoindex_exact_size off;\n\tautoindex_localtime on;\n\t\n\tauth_basic &quot;Please Password!!!&quot;;\n\tauth_basic_user_file &#x2F;etc&#x2F;nginx&#x2F;auth_conf; \n\t# 注意认证文件路径，否则网页认证后会403，可是为什么放其他目录就不行？\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ol>\n<h2 id=\"五、Nginx连接限制\"><a href=\"#五、Nginx连接限制\" class=\"headerlink\" title=\"五、Nginx连接限制\"></a>五、Nginx连接限制</h2><blockquote>\n<p>网站请求数太多，不堪重负了，怎么保障部分用户能够正常访问</p>\n</blockquote>\n<h3 id=\"5-1-限制连接数\"><a href=\"#5-1-限制连接数\" class=\"headerlink\" title=\"5.1 限制连接数\"></a>5.1 限制连接数</h3><p><code>设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求</code></p>\n<ul>\n<li><p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># http标签段定义连接限制\nhttp&#123;\n    limit_conn_zone $binary_remote_addr zone&#x3D;conn_zone:10m;\n&#125;\nserver &#123;\n    # 同一时刻只允许一个客户端连接\n    limit_conn conn_zone 1; \n\n    location &#x2F; &#123;\n        root &#x2F;code;\n        index index.html;\n    &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>使用ab工具进行压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 使用ab工具进行压力测试\n[root@xuliangwei ~]# yum install -y httpd-tools\n[root@xuliangwei ~]# ab -n 500 -c 2  http:&#x2F;&#x2F;127.0.0.1&#x2F;index.html\n# 可见500次中有失败的请求<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>查看拦截日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log\n类似于\n2019&#x2F;01&#x2F;14 11:11:22 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:23 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-2-限制请求数（更精准）\"><a href=\"#5-2-限制请求数（更精准）\" class=\"headerlink\" title=\"5.2 限制请求数（更精准）\"></a>5.2 限制请求数（更精准）</h3><p><code>设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。</code></p>\n<ul>\n<li><p>定义限制的Key</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat test1.oldboy.com.conf \nlimit_req_zone $binary_remote_addr zone&#x3D;req_zone:10m rate&#x3D;1r&#x2F;s;\nserver &#123;\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\t\n\tlimit_req zone&#x3D;req_zone burst&#x3D;5 nodelay;\n\tlimit_req_status 412;\n\terror_page 412 &#x2F;err.html;    #这个文件必须存在&#x2F;code&#x2F;test1&#x2F;err.html\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test1;\n\t\tindex index.html;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>填写hosts域名解析 （测试：域名访问才有效果，直接访问没效果）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &quot;10.0.0.7 test1.oldboy.com&quot; &gt;&gt; &#x2F;etc&#x2F;hosts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ab -n 50 -c 20 http:&#x2F;&#x2F;test1.oldboy.com&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>查看错误日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.737 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;\n2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.611 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;\n2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.450 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"六、Nginx匹配符和优先级\"><a href=\"#六、Nginx匹配符和优先级\" class=\"headerlink\" title=\"六、Nginx匹配符和优先级\"></a>六、Nginx匹配符和优先级</h2><p>Location语法示例</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location [&#x3D;|^~|~|~*|!~|!~*|&#x2F;] &#x2F;uri&#x2F; &#123; ...\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>匹配优先级</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">匹配符\t匹配规则\t\t\t\t\t\t优先级\n&#x3D;\t\t精确匹配\t\t\t\t\t\t1 \t用到\n^~\t\t以某个字符串开头\t\t\t\t2\n~\t\t区分大小写的正则匹配\t\t\t3\t常用\n~*\t\t不区分大小写的正则匹配\t\t\t4\n!~\t\t区分大小写不匹配的正则\t\t\t5\n!~*\t\t不区分大小写不匹配的正则\t\t6\n&#x2F;\t\t通用匹配，任何请求都会匹配到\t7\t常用<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-1-匹配案例\"><a href=\"#6-1-匹配案例\" class=\"headerlink\" title=\"6.1 匹配案例\"></a>6.1 匹配案例</h3><blockquote>\n<p>参考网站：<a href=\"https://blog.csdn.net/qq_41980405/article/details/111402208\">https://blog.csdn.net/qq_41980405/article/details/111402208</a></p>\n</blockquote>\n<ul>\n<li><p>通用匹配，任何请求都会匹配到</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>严格区分大小写，匹配以.php结尾的都走这个location    </p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~ \\.php$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>严格区分大小写，匹配以.jsp结尾的都走这个location </p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~ \\.jsp$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~* .*\\.(jpg|gif|png|js|css|mp4)$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>不区分大小写匹配</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~* <span class=\"token string\">\"\\.(sql|bak|tgz|tar.gz|.git)$\"</span></span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>本篇主要介绍Nginx的常用官方模块</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<h2 id=\"一、目录索引-autoindex\"><a href=\"#一、目录索引-autoindex\" class=\"headerlink\" title=\"一、目录索引-autoindex\"></a>一、目录索引-autoindex</h2><h3 id=\"1-1-使用方法1\"><a href=\"#1-1-使用方法1\" class=\"headerlink\" title=\"1.1 使用方法1\"></a>1.1 使用方法1</h3><p>按此方法设置后，访问网页<a href=\"http://module.test.com将显示文件目录/\">http://module.test.com将显示文件目录</a></p>\n<p>实际目录位于: &#x2F;module</p>\n<p>a.准备配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf\nserver &#123;\n\tlisten 80;\n\tserver_name module.test.com;\n\tcharset utf-8,gbk; # 解决中文乱码\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;module;\n\t\tautoindex on;\t# 开启目录索引\n\t\tautoindex_exact_size off;\t# 显示文件大小，默认为on显示字节，off显示大概单位\n\t\tautoindex_localtime on;\t# 默认off显示UTC时间，on显示本地时间\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b.准备对应的目录，并往目录中添加文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;module&#x2F;&#123;centos,ubuntu,redhat&#125;&#x2F; -p<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>c.检查语法并重新加载nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nginx -t \nsystemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-使用方法2（推荐）\"><a href=\"#1-2-使用方法2（推荐）\" class=\"headerlink\" title=\"1.2 使用方法2（推荐）\"></a>1.2 使用方法2（推荐）</h3><p>按此方法设置后，访问网页<a href=\"http://www.module.test.com/download%E5%B0%86%E6%98%BE%E7%A4%BA%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95,%E4%B8%BB%E9%A1%B5%E5%8F%AF%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE\">http://www.module.test.com/download将显示文件目录,主页可正常访问</a></p>\n<p>实际目录位于：&#x2F;module&#x2F;download</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 module]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf \nserver &#123;\n\tlisten 80;\n\tserver_name module.oldboy.com;\n\tcharset utf-8,gbk;\n\n\tlocation &#x2F; &#123;\t# 主页可以正常访问\n\t\troot &#x2F;code;\n\t\tindex index.html index.htm;\n\t&#125;\n\n\tlocation &#x2F;download &#123;\t# 当访问http:&#x2F;&#x2F;xxxx&#x2F;download则访问&#x2F;module&#x2F;download文件夹，显示目录索引\n\t\troot &#x2F;module; # 此时，访问的文件夹是&#x2F;module&#x2F;download\n\t\tautoindex on;\n\t\tautoindex_exact_size off;\n\t\tautoindex_localtime on;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、-状态监控页面-stub-status\"><a href=\"#二、-状态监控页面-stub-status\" class=\"headerlink\" title=\"二、 状态监控页面-stub_status\"></a>二、 状态监控页面-stub_status</h2><blockquote>\n<p>需要nginx附带–with-http_stub_status_module模块才能使用</p>\n</blockquote>\n<h3 id=\"2-1-使用方法\"><a href=\"#2-1-使用方法\" class=\"headerlink\" title=\"2.1 使用方法\"></a>2.1 使用方法</h3><p>a.设置配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面附加内容\nlocation &#x2F;nginx_status &#123;\n\tstub_status;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b.重启Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">重启nginx服务\nsystemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>c.网页访问测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">访问:\nhttp:&#x2F;&#x2F;module.test.com&#x2F;nginx_status\n网页显示：\nActive connections: 2 \nserver accepts handled requests\n\t\t3 \t\t\t3 \t33 \nReading: 0 Writing: 1 Waiting: 1 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>d.通过选项关闭长连接</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 注意, 一次TCP的连接，可以发起多次http的请求, 如下参数可配置进行验证\nkeepalive_timeout  0;   # 类似于关闭长连接\nkeepalive_timeout  65;  # 65s没有活动则断开连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;autoindex.conf里面的附加内容修改为\nlocation &#x2F;nginx_status &#123;\n\tstub_status;\n\tkeepalive_timeout  0; \n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>e.再次测试网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">关闭长连接后的显示：\nActive connections: 2 \nserver accepts handled requests\n 21 21 20 \nReading: 0 Writing: 1 Waiting: 1 \n# 可见每次HTTP请求都要重新发起TCP连接<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-监控页面内容解释\"><a href=\"#2-2-监控页面内容解释\" class=\"headerlink\" title=\"2.2 监控页面内容解释\"></a>2.2 监控页面内容解释</h3><table>\n<thead>\n<tr>\n<th>参数项</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Active connections</td>\n<td>当前活动客户端连接数，包括Waiting等待连接数</td>\n</tr>\n<tr>\n<td>accepts</td>\n<td>已接受总的TCP连接数</td>\n</tr>\n<tr>\n<td>handled</td>\n<td>已处理总的TCP连接数</td>\n</tr>\n<tr>\n<td>requests</td>\n<td>客户端总的http请求数</td>\n</tr>\n<tr>\n<td>Reading</td>\n<td>当前nginx读取请求头的连接数</td>\n</tr>\n<tr>\n<td>Writing</td>\n<td>当前nginx将响应写回客户端的连接数</td>\n</tr>\n<tr>\n<td>Waiting</td>\n<td>当前等待请求的空闲客户端连接数</td>\n</tr>\n</tbody></table>\n<h2 id=\"三、基于IP的访问控制\"><a href=\"#三、基于IP的访问控制\" class=\"headerlink\" title=\"三、基于IP的访问控制\"></a>三、基于IP的访问控制</h2><blockquote>\n<p>某网页内的数据比较重要，怎么控制那些人可以访问，那些人不能访问呢？</p>\n</blockquote>\n<p>可以来源的IP地址做限制，常用的三种控制方法：</p>\n<ul>\n<li><p>拒绝10.0.0.1来源IP访问，其他人允许</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;nginx_status &#123;\n    stub_status;\n    deny 10.0.0.1&#x2F;32;\n    allow all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>允许10.0.0.1来源IP访问，其他人全部拒绝</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;nginx_status &#123;\n    stub_status;\n    allow 10.0.0.1&#x2F;32;\n    deny all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>实际配置监控Nginx状态时，仅允许该服务器的回环地址访问127.0.0.1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 最安全\nlocation &#x2F;nginx_status &#123;\n    stub_status;\n    allow 127.0.0.1;\n    deny all;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"四、基于密码的身份验证\"><a href=\"#四、基于密码的身份验证\" class=\"headerlink\" title=\"四、基于密码的身份验证\"></a>四、基于密码的身份验证</h2><blockquote>\n<p>重要数据网站，要实现需要用户名密码认证，怎么做呢？</p>\n</blockquote>\n<ol>\n<li><p>生成一个密码文件，密码文件的格式  name:password(加密)  （建议使用htpasswd）  openssl password</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# yum install httpd-tools -y\n[root@web01 conf.d]# htpasswd -c -b &#x2F;etc&#x2F;nginx&#x2F;auth_conf oldboy oldboy\n[root@web01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;auth_conf\noldboy:$apr1$Kp87VSae$658Nt5bm4iiblQkUvP7u61<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>配置Nginx，限制对应的资源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F;download &#123;\n\troot &#x2F;module;\n\tautoindex on;\n\tautoindex_exact_size off;\n\tautoindex_localtime on;\n\t\n\tauth_basic &quot;Please Password!!!&quot;;\n\tauth_basic_user_file &#x2F;etc&#x2F;nginx&#x2F;auth_conf; \n\t# 注意认证文件路径，否则网页认证后会403，可是为什么放其他目录就不行？\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ol>\n<h2 id=\"五、Nginx连接限制\"><a href=\"#五、Nginx连接限制\" class=\"headerlink\" title=\"五、Nginx连接限制\"></a>五、Nginx连接限制</h2><blockquote>\n<p>网站请求数太多，不堪重负了，怎么保障部分用户能够正常访问</p>\n</blockquote>\n<h3 id=\"5-1-限制连接数\"><a href=\"#5-1-限制连接数\" class=\"headerlink\" title=\"5.1 限制连接数\"></a>5.1 限制连接数</h3><p><code>设置共享内存区域和给定键值的最大允许连接数。超过此限制时，服务器将返回错误以回复请求</code></p>\n<ul>\n<li><p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># http标签段定义连接限制\nhttp&#123;\n    limit_conn_zone $binary_remote_addr zone&#x3D;conn_zone:10m;\n&#125;\nserver &#123;\n    # 同一时刻只允许一个客户端连接\n    limit_conn conn_zone 1; \n\n    location &#x2F; &#123;\n        root &#x2F;code;\n        index index.html;\n    &#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>使用ab工具进行压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 使用ab工具进行压力测试\n[root@xuliangwei ~]# yum install -y httpd-tools\n[root@xuliangwei ~]# ab -n 500 -c 2  http:&#x2F;&#x2F;127.0.0.1&#x2F;index.html\n# 可见500次中有失败的请求<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>查看拦截日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log\n类似于\n2019&#x2F;01&#x2F;14 11:11:22 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:23 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;\n2019&#x2F;01&#x2F;14 11:11:25 [error] 29962#29962: *19 limiting connections by zone &quot;conn_zone&quot;, client: 47.110.176.164, server: www.xuliangwei.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;www.xuliangwei.com&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h3 id=\"5-2-限制请求数（更精准）\"><a href=\"#5-2-限制请求数（更精准）\" class=\"headerlink\" title=\"5.2 限制请求数（更精准）\"></a>5.2 限制请求数（更精准）</h3><p><code>设置共享内存区域和请求的最大突发大小。过多的请求被延迟，直到它们的数量超过最大突发大小，在这种情况下请求以错误终止。默认情况下，最大突发大小等于零。</code></p>\n<ul>\n<li><p>定义限制的Key</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat test1.oldboy.com.conf \nlimit_req_zone $binary_remote_addr zone&#x3D;req_zone:10m rate&#x3D;1r&#x2F;s;\nserver &#123;\n\tlisten 80;\n\tserver_name test1.oldboy.com;\n\t\n\tlimit_req zone&#x3D;req_zone burst&#x3D;5 nodelay;\n\tlimit_req_status 412;\n\terror_page 412 &#x2F;err.html;    #这个文件必须存在&#x2F;code&#x2F;test1&#x2F;err.html\n\n\tlocation &#x2F; &#123;\n\t\troot &#x2F;code&#x2F;test1;\n\t\tindex index.html;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>填写hosts域名解析 （测试：域名访问才有效果，直接访问没效果）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &quot;10.0.0.7 test1.oldboy.com&quot; &gt;&gt; &#x2F;etc&#x2F;hosts<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>压力测试</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ab -n 50 -c 20 http:&#x2F;&#x2F;test1.oldboy.com&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n</li>\n<li><p>查看错误日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.737 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;\n2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.611 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;\n2019&#x2F;01&#x2F;14 11:28:22 [error] 2073#2073: *3 limiting requests, excess: 5.450 by zone &quot;req_zone&quot;, client: 10.0.0.1, server: test1.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, host: &quot;test1.oldboy.com&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"六、Nginx匹配符和优先级\"><a href=\"#六、Nginx匹配符和优先级\" class=\"headerlink\" title=\"六、Nginx匹配符和优先级\"></a>六、Nginx匹配符和优先级</h2><p>Location语法示例</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location [&#x3D;|^~|~|~*|!~|!~*|&#x2F;] &#x2F;uri&#x2F; &#123; ...\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>匹配优先级</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">匹配符\t匹配规则\t\t\t\t\t\t优先级\n&#x3D;\t\t精确匹配\t\t\t\t\t\t1 \t用到\n^~\t\t以某个字符串开头\t\t\t\t2\n~\t\t区分大小写的正则匹配\t\t\t3\t常用\n~*\t\t不区分大小写的正则匹配\t\t\t4\n!~\t\t区分大小写不匹配的正则\t\t\t5\n!~*\t\t不区分大小写不匹配的正则\t\t6\n&#x2F;\t\t通用匹配，任何请求都会匹配到\t7\t常用<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-1-匹配案例\"><a href=\"#6-1-匹配案例\" class=\"headerlink\" title=\"6.1 匹配案例\"></a>6.1 匹配案例</h3><blockquote>\n<p>参考网站：<a href=\"https://blog.csdn.net/qq_41980405/article/details/111402208\">https://blog.csdn.net/qq_41980405/article/details/111402208</a></p>\n</blockquote>\n<ul>\n<li><p>通用匹配，任何请求都会匹配到</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> /</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>严格区分大小写，匹配以.php结尾的都走这个location    </p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~ \\.php$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>严格区分大小写，匹配以.jsp结尾的都走这个location </p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~ \\.jsp$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>不区分大小写匹配，只要用户访问.jpg,gif,png,js,css 都走这条location</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~* .*\\.(jpg|gif|png|js|css|mp4)$</span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>不区分大小写匹配</p>\n<pre class=\"line-numbers language-nginx\" data-language=\"nginx\"><code class=\"language-nginx\"><span class=\"token directive\"><span class=\"token keyword\">location</span> ~* <span class=\"token string\">\"\\.(sql|bak|tgz|tar.gz|.git)$\"</span></span> <span class=\"token punctuation\">&#123;</span>\n    ...\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n"},{"title":"运维之综合架构--07--Nginx(三)LNMP介绍","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、LNMP简介(需补充)\n\n### 1.1 什么是LNMP\n\n### 1.2 LNMP架构是如何工作的\n\n浏览器 --http--> Nginx(fastcgi_pass) --fastcgi-->php(fastcgi_fpm调动wrapper再调动php解析再调用mysql)\n\n大致流程：\n\n用户在浏览器发起请求，如果请求的是静态资源，Nginx则直接返回，如果请求的是动态资源，Nginx会通过fastcgi协议，将请求交给PHP服务器，再返回动态资源。\n\n### 1.3 LNMP和LAMP的区别是什么\n\nnginx 是以fastcgi协议调用的php\napache是以模块的方式加载的php\n\n## 二、LNMP架构简单搭建\n\n1、准备一台名为nginx的服务器\n\n2、使用官方仓库安装nginx\n\n```shell\n# 添加安装源\n[root@nginx ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n\n#安装Nginx\n[root@nginx ~]# yum install nginx -y\n```\n\n3、安装php7.1\n\n```shell\n[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common # 卸载默认5.4版本的php\n[root@nginx ~]# cat /etc/yum.repos.d/php.repo\n[php]\nname = php Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0\n\n[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n```\n\n4、安装maria数据库\n\n```shell\n[root@nginx ~]# yum install mariadb-server mariadb -y\n```\n\n5、配置nginx和php集成\n\n```shell\n[root@web01 conf.d]# cd /etc/nginx/conf.d/\n[root@web01 conf.d]# cat php.conf \nserver {\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot /code;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n```\n\n6、重载nginx\n\n```shell\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n7、启动php-fpm，并加入开机自启\n\n```shell\n[root@web01 conf.d]# systemctl start php-fpm\n[root@web01 conf.d]# systemctl enable  php-fpm\n```\n\n8、准备一个php文件，测试nginx和php是否继承成功\n\n```shell\n[root@web01 conf.d]# cat /code/page.php\n<?php\n\tphpinfo();\n?>\n# 测试：网页访问:http://php.oldboy.com/page.php\n```\n\n9、启动数据库\n\n```shell\n[root@web01 conf.d]# systemctl start mariadb\n[root@web01 conf.d]# systemctl enable mariadb\n[root@web01 conf.d]# mysqladmin password 'Bgx123.com'\t\t#配置密码（默认mysql是空密码）\n[root@web01 conf.d]# mysql -uroot -pBgx123.com\t\t\t\t#使用账号和密码登录mysql\n```\n\n10、准备一个php文件，测试是否可以正常连接数据库\n\n```she\n  <?php\n    $servername = \"localhost\";\n    $username = \"root\";\n    $password = \"Bgx123.com\";\n\n    // 创建连接\n    $conn = mysqli_connect($servername, $username, $password);\n\n    // 检测连接\n    if (!$conn) {\n        die(\"Connection failed: \" . mysqli_connect_error()); // 注意格式\n    }\n    echo \"php连接MySQL数据库成功\";\n    ?>\n```\n\n## 三、案例-搭建wordpress博客\n\n### 3.1 环境准备\n\n| 用途        | 公网IP地址 | 内网IP地址 |\n| ----------- | ---------- | ---------- |\n| web服务器01 | 10.0.0.7   | 172.16.1.7 |\n\n### 3.2 部署安装\n\n1、添加nginx配置文件\n\n```shell\n[root@web01 conf.d]# cat blog.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name blog.oldboy.com;\n\troot /code/wordpress;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n```\n\n2、根据nginx中定义的内容，创建站点目录并进行授权\n\n```shell\n[root@web01 conf.d]# mkdir /code\n[root@web01 conf.d]# cd /code\n[root@web01 code]# wget https://cn.wordpress.org/wordpress-5.0.3-zh_CN.tar.gz\n[root@web01 code]# tar xf wordpress-5.0.3-zh_CN.tar.gz\n```\n\n3、修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www\n\n```shell\n#注意：如果没有该用户，启动一定会报错\n[root@web01 code]# groupadd -g 666 www\n[root@web01 code]# useradd -u666 -g666 www\n\n修改nginx与php-fpm管理进程，的运行身份为www\n[root@web01 code]# sed -i '/^user /c user  www;' /etc/nginx/nginx.conf\n[root@web01 code]# sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf \n[root@web01 code]# sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf \n\n一定要重启才生效\n[root@web01 code]# systemctl restart nginx\n[root@web01 code]# systemctl restart php-fpm\n\n最后授权代码为www\n[root@web01 code]# chown -R www.www /code/wordpress\t\n```\n\n4、创建数据库\n\n```shell\nMariaDB [(none)]> create database wordpress;\t\t\t#创建一个库，名称叫wordpress\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]> show databases;\t\t\t\t\t\t#查询该台数据库服务有多少个库\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n+--------------------+\n5 rows in set (0.00 sec)\n```\n\n5、解决nginx上传文件大小限制（默认1M，超过大小会报413）\n\n```shell\n在wordpress的nginx配置文件中添加：client_max_body_size 100m;\n[root@web01 code]# cat /etc/nginx/conf.d/blog.oldboy.com.conf \nserver {\n        listen 80;\n        server_name blog.oldboy.com;\n        root /code/wordpress;\n        client_max_body_size 100m;  # 默认1M，超过大小会报413\n\n        location / {\n                index index.php index.html;\n        }\n\n        location ~ \\.php$ {\n                fastcgi_pass 127.0.0.1:9000;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n        }\n}\n重启nginx：systemctl restart nginx\t\n```\n\n>测试在wordpress页面上传主题或者写文章上传图片，均出现500报错\n>查看日志文件/var/log/nginx/err.log\n>2021/08/16 18:59:31 [crit] 1228#1228: *2 open() \"/var/lib/nginx/tmp/client_body/0000000001\" failed (13: Permission denied), client: 10.0.0.1, server: php.gs.com, request: \"POST /wp-admin/update.php?action=upload-theme HTTP/1.1\", host: \"php.gs.com\", referrer: \"http://php.gs.com/wp-admin/theme-install.php?browse=popular\"\n>解决方法，参考https://blog.csdn.net/qq_15941409/article/details/114640122\n>chown www:www -R /var/lib/nginx/\n\n## 四、案例-搭建wecenter知乎\n\n### 4.1 部署安装\n\n1、添加nginx配置文件\n\n```shell\nserver {\n\tlisten 80;\n\tserver_name zh.oldboy.com;\n\troot /code/zh;\n\tclient_max_body_size 100m;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n[root@web01 code]# systemctl restart nginx\n```\n\n2、wencenter部署\n\n```shell\n[root@web01 code]# rz -E WeCenter_3-2-1.zip\n[root@web01 code]# unzip WeCenter_3-2-1.zip\n[root@web01 code]# mv WeCenter_3-2-1 zh\n[root@web01 code]# chown -R www.www zh/\n```\n\n3、配置数据库\n\n```shell\n[root@web01 code]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> create database zh;\nMariaDB [(none)]> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n6 rows in set (0.00 sec)\n```\n\n## 五、案例-搭建edusoho在线视频教育\n\n### 5.1 部署安装\n\n1、添加nginx配置文件\n\n```shell\n[root@web01 code]# cat /etc/nginx/conf.d/edu.oldboy.com.conf \nserver {\n    listen 80;\n    server_name edu.oldboy.com;\n    root /code/edusoho/web;\n    client_max_body_size 200m;\n\n    location / {\n        index app.php;\n        try_files $uri @rewriteapp;\n    }\n    location @rewriteapp {\n        rewrite ^(.*)$ /app.php/$1 last;\n    }\n\n    location ~ ^/udisk {\n        internal;\n        root /code/edusoho/app/data/;\n    }\n\n    location ~ ^/(app|app_dev)\\.php(/|$) {\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;\n        fastcgi_param HTTP_X-Accel-Mapping /udisk=/code/edusoho/app/data/udisk;\n        fastcgi_buffer_size 128k;\n        fastcgi_buffers 8 128k;\n    }\n\n    # 配置设置图片格式文件\n    location ~* \\.(jpg|jpeg|gif|png|ico|swf)$ {\n        # 过期时间为3年\n        expires 3y;\n        # 关闭日志记录\n        access_log off;\n        # 关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。\n        gzip off;\n    }\n    # 配置css/js文件\n    location ~* \\.(css|js)$ {\n        access_log off;\n        expires 3y;\n    }\n    # 禁止用户上传目录下所有.php文件的访问，提高安全性\n    location ~ ^/files/.*\\.(php|php5)$ {\n        deny all;\n    }\n\n    # 以下配置允许运行.php的程序，方便于其他第三方系统的集成。\n    location ~ \\.php$ {\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n    }\n}\n```\n\n2、下载edusoho,并授权文件夹\n\n```shell\nwget http://download.edusoho.com/edusoho-8.2.17.tar.gz\ntar xf edusoho-8.2.17.tar.gz\nchown -R www.www edusoho\n```\n\n3、调整php的上传大小(上传文件默认有限制大小)\n\n```shell\n[root@web01 ~]# vim /etc/php.ini\npost_max_size = 200M\nupload_max_filesize = 200M\n[root@web01 code]# systemctl restart php-fpm\n```\n\n## 六、各开源项目网站\n\nphpmyadmin\thttps://www.phpmyadmin.net/\nzblog\thttps://www.zblogcn.com/\nwordpress\thttps://cn.wordpress.org/\nwecenter\thttp://www.wecenter.com/downloads/\nedusohu\thttp://www.edusoho.com/open/show\n","source":"_posts/01_运维/02-综合架构/09-Nginx(三)LNMP架构安装.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(三)LNMP介绍\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、LNMP简介(需补充)\n\n### 1.1 什么是LNMP\n\n### 1.2 LNMP架构是如何工作的\n\n浏览器 --http--> Nginx(fastcgi_pass) --fastcgi-->php(fastcgi_fpm调动wrapper再调动php解析再调用mysql)\n\n大致流程：\n\n用户在浏览器发起请求，如果请求的是静态资源，Nginx则直接返回，如果请求的是动态资源，Nginx会通过fastcgi协议，将请求交给PHP服务器，再返回动态资源。\n\n### 1.3 LNMP和LAMP的区别是什么\n\nnginx 是以fastcgi协议调用的php\napache是以模块的方式加载的php\n\n## 二、LNMP架构简单搭建\n\n1、准备一台名为nginx的服务器\n\n2、使用官方仓库安装nginx\n\n```shell\n# 添加安装源\n[root@nginx ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n\n#安装Nginx\n[root@nginx ~]# yum install nginx -y\n```\n\n3、安装php7.1\n\n```shell\n[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common # 卸载默认5.4版本的php\n[root@nginx ~]# cat /etc/yum.repos.d/php.repo\n[php]\nname = php Repository\nbaseurl = http://us-east.repo.webtatic.com/yum/el7/x86_64/\ngpgcheck = 0\n\n[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n```\n\n4、安装maria数据库\n\n```shell\n[root@nginx ~]# yum install mariadb-server mariadb -y\n```\n\n5、配置nginx和php集成\n\n```shell\n[root@web01 conf.d]# cd /etc/nginx/conf.d/\n[root@web01 conf.d]# cat php.conf \nserver {\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot /code;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n```\n\n6、重载nginx\n\n```shell\n[root@web01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n7、启动php-fpm，并加入开机自启\n\n```shell\n[root@web01 conf.d]# systemctl start php-fpm\n[root@web01 conf.d]# systemctl enable  php-fpm\n```\n\n8、准备一个php文件，测试nginx和php是否继承成功\n\n```shell\n[root@web01 conf.d]# cat /code/page.php\n<?php\n\tphpinfo();\n?>\n# 测试：网页访问:http://php.oldboy.com/page.php\n```\n\n9、启动数据库\n\n```shell\n[root@web01 conf.d]# systemctl start mariadb\n[root@web01 conf.d]# systemctl enable mariadb\n[root@web01 conf.d]# mysqladmin password 'Bgx123.com'\t\t#配置密码（默认mysql是空密码）\n[root@web01 conf.d]# mysql -uroot -pBgx123.com\t\t\t\t#使用账号和密码登录mysql\n```\n\n10、准备一个php文件，测试是否可以正常连接数据库\n\n```she\n  <?php\n    $servername = \"localhost\";\n    $username = \"root\";\n    $password = \"Bgx123.com\";\n\n    // 创建连接\n    $conn = mysqli_connect($servername, $username, $password);\n\n    // 检测连接\n    if (!$conn) {\n        die(\"Connection failed: \" . mysqli_connect_error()); // 注意格式\n    }\n    echo \"php连接MySQL数据库成功\";\n    ?>\n```\n\n## 三、案例-搭建wordpress博客\n\n### 3.1 环境准备\n\n| 用途        | 公网IP地址 | 内网IP地址 |\n| ----------- | ---------- | ---------- |\n| web服务器01 | 10.0.0.7   | 172.16.1.7 |\n\n### 3.2 部署安装\n\n1、添加nginx配置文件\n\n```shell\n[root@web01 conf.d]# cat blog.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name blog.oldboy.com;\n\troot /code/wordpress;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n```\n\n2、根据nginx中定义的内容，创建站点目录并进行授权\n\n```shell\n[root@web01 conf.d]# mkdir /code\n[root@web01 conf.d]# cd /code\n[root@web01 code]# wget https://cn.wordpress.org/wordpress-5.0.3-zh_CN.tar.gz\n[root@web01 code]# tar xf wordpress-5.0.3-zh_CN.tar.gz\n```\n\n3、修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www\n\n```shell\n#注意：如果没有该用户，启动一定会报错\n[root@web01 code]# groupadd -g 666 www\n[root@web01 code]# useradd -u666 -g666 www\n\n修改nginx与php-fpm管理进程，的运行身份为www\n[root@web01 code]# sed -i '/^user /c user  www;' /etc/nginx/nginx.conf\n[root@web01 code]# sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf \n[root@web01 code]# sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf \n\n一定要重启才生效\n[root@web01 code]# systemctl restart nginx\n[root@web01 code]# systemctl restart php-fpm\n\n最后授权代码为www\n[root@web01 code]# chown -R www.www /code/wordpress\t\n```\n\n4、创建数据库\n\n```shell\nMariaDB [(none)]> create database wordpress;\t\t\t#创建一个库，名称叫wordpress\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]> show databases;\t\t\t\t\t\t#查询该台数据库服务有多少个库\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n+--------------------+\n5 rows in set (0.00 sec)\n```\n\n5、解决nginx上传文件大小限制（默认1M，超过大小会报413）\n\n```shell\n在wordpress的nginx配置文件中添加：client_max_body_size 100m;\n[root@web01 code]# cat /etc/nginx/conf.d/blog.oldboy.com.conf \nserver {\n        listen 80;\n        server_name blog.oldboy.com;\n        root /code/wordpress;\n        client_max_body_size 100m;  # 默认1M，超过大小会报413\n\n        location / {\n                index index.php index.html;\n        }\n\n        location ~ \\.php$ {\n                fastcgi_pass 127.0.0.1:9000;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n        }\n}\n重启nginx：systemctl restart nginx\t\n```\n\n>测试在wordpress页面上传主题或者写文章上传图片，均出现500报错\n>查看日志文件/var/log/nginx/err.log\n>2021/08/16 18:59:31 [crit] 1228#1228: *2 open() \"/var/lib/nginx/tmp/client_body/0000000001\" failed (13: Permission denied), client: 10.0.0.1, server: php.gs.com, request: \"POST /wp-admin/update.php?action=upload-theme HTTP/1.1\", host: \"php.gs.com\", referrer: \"http://php.gs.com/wp-admin/theme-install.php?browse=popular\"\n>解决方法，参考https://blog.csdn.net/qq_15941409/article/details/114640122\n>chown www:www -R /var/lib/nginx/\n\n## 四、案例-搭建wecenter知乎\n\n### 4.1 部署安装\n\n1、添加nginx配置文件\n\n```shell\nserver {\n\tlisten 80;\n\tserver_name zh.oldboy.com;\n\troot /code/zh;\n\tclient_max_body_size 100m;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n[root@web01 code]# systemctl restart nginx\n```\n\n2、wencenter部署\n\n```shell\n[root@web01 code]# rz -E WeCenter_3-2-1.zip\n[root@web01 code]# unzip WeCenter_3-2-1.zip\n[root@web01 code]# mv WeCenter_3-2-1 zh\n[root@web01 code]# chown -R www.www zh/\n```\n\n3、配置数据库\n\n```shell\n[root@web01 code]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> create database zh;\nMariaDB [(none)]> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n6 rows in set (0.00 sec)\n```\n\n## 五、案例-搭建edusoho在线视频教育\n\n### 5.1 部署安装\n\n1、添加nginx配置文件\n\n```shell\n[root@web01 code]# cat /etc/nginx/conf.d/edu.oldboy.com.conf \nserver {\n    listen 80;\n    server_name edu.oldboy.com;\n    root /code/edusoho/web;\n    client_max_body_size 200m;\n\n    location / {\n        index app.php;\n        try_files $uri @rewriteapp;\n    }\n    location @rewriteapp {\n        rewrite ^(.*)$ /app.php/$1 last;\n    }\n\n    location ~ ^/udisk {\n        internal;\n        root /code/edusoho/app/data/;\n    }\n\n    location ~ ^/(app|app_dev)\\.php(/|$) {\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;\n        fastcgi_param HTTP_X-Accel-Mapping /udisk=/code/edusoho/app/data/udisk;\n        fastcgi_buffer_size 128k;\n        fastcgi_buffers 8 128k;\n    }\n\n    # 配置设置图片格式文件\n    location ~* \\.(jpg|jpeg|gif|png|ico|swf)$ {\n        # 过期时间为3年\n        expires 3y;\n        # 关闭日志记录\n        access_log off;\n        # 关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。\n        gzip off;\n    }\n    # 配置css/js文件\n    location ~* \\.(css|js)$ {\n        access_log off;\n        expires 3y;\n    }\n    # 禁止用户上传目录下所有.php文件的访问，提高安全性\n    location ~ ^/files/.*\\.(php|php5)$ {\n        deny all;\n    }\n\n    # 以下配置允许运行.php的程序，方便于其他第三方系统的集成。\n    location ~ \\.php$ {\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n    }\n}\n```\n\n2、下载edusoho,并授权文件夹\n\n```shell\nwget http://download.edusoho.com/edusoho-8.2.17.tar.gz\ntar xf edusoho-8.2.17.tar.gz\nchown -R www.www edusoho\n```\n\n3、调整php的上传大小(上传文件默认有限制大小)\n\n```shell\n[root@web01 ~]# vim /etc/php.ini\npost_max_size = 200M\nupload_max_filesize = 200M\n[root@web01 code]# systemctl restart php-fpm\n```\n\n## 六、各开源项目网站\n\nphpmyadmin\thttps://www.phpmyadmin.net/\nzblog\thttps://www.zblogcn.com/\nwordpress\thttps://cn.wordpress.org/\nwecenter\thttp://www.wecenter.com/downloads/\nedusohu\thttp://www.edusoho.com/open/show\n","slug":"01_运维/02-综合架构/09-Nginx(三)LNMP架构安装","published":1,"updated":"2022-07-06T07:16:26.333Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0i000wa8v7bsodh9kl","content":"<h2 id=\"一、LNMP简介-需补充\"><a href=\"#一、LNMP简介-需补充\" class=\"headerlink\" title=\"一、LNMP简介(需补充)\"></a>一、LNMP简介(需补充)</h2><h3 id=\"1-1-什么是LNMP\"><a href=\"#1-1-什么是LNMP\" class=\"headerlink\" title=\"1.1 什么是LNMP\"></a>1.1 什么是LNMP</h3><h3 id=\"1-2-LNMP架构是如何工作的\"><a href=\"#1-2-LNMP架构是如何工作的\" class=\"headerlink\" title=\"1.2 LNMP架构是如何工作的\"></a>1.2 LNMP架构是如何工作的</h3><p>浏览器 –http–&gt; Nginx(fastcgi_pass) –fastcgi–&gt;php(fastcgi_fpm调动wrapper再调动php解析再调用mysql)</p>\n<p>大致流程：</p>\n<p>用户在浏览器发起请求，如果请求的是静态资源，Nginx则直接返回，如果请求的是动态资源，Nginx会通过fastcgi协议，将请求交给PHP服务器，再返回动态资源。</p>\n<h3 id=\"1-3-LNMP和LAMP的区别是什么\"><a href=\"#1-3-LNMP和LAMP的区别是什么\" class=\"headerlink\" title=\"1.3 LNMP和LAMP的区别是什么\"></a>1.3 LNMP和LAMP的区别是什么</h3><p>nginx 是以fastcgi协议调用的php<br>apache是以模块的方式加载的php</p>\n<h2 id=\"二、LNMP架构简单搭建\"><a href=\"#二、LNMP架构简单搭建\" class=\"headerlink\" title=\"二、LNMP架构简单搭建\"></a>二、LNMP架构简单搭建</h2><p>1、准备一台名为nginx的服务器</p>\n<p>2、使用官方仓库安装nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 添加安装源\n[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n\n#安装Nginx\n[root@nginx ~]# yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、安装php7.1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common # 卸载默认5.4版本的php\n[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;php.repo\n[php]\nname &#x3D; php Repository\nbaseurl &#x3D; http:&#x2F;&#x2F;us-east.repo.webtatic.com&#x2F;yum&#x2F;el7&#x2F;x86_64&#x2F;\ngpgcheck &#x3D; 0\n\n[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、安装maria数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nginx ~]# yum install mariadb-server mariadb -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>5、配置nginx和php集成</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@web01 conf.d]# cat php.conf \nserver &#123;\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot &#x2F;code;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>6、重载nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>7、启动php-fpm，并加入开机自启</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# systemctl start php-fpm\n[root@web01 conf.d]# systemctl enable  php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>8、准备一个php文件，测试nginx和php是否继承成功</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat &#x2F;code&#x2F;page.php\n&lt;?php\n\tphpinfo();\n?&gt;\n# 测试：网页访问:http:&#x2F;&#x2F;php.oldboy.com&#x2F;page.php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、启动数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# systemctl start mariadb\n[root@web01 conf.d]# systemctl enable mariadb\n[root@web01 conf.d]# mysqladmin password &#39;Bgx123.com&#39;\t\t#配置密码（默认mysql是空密码）\n[root@web01 conf.d]# mysql -uroot -pBgx123.com\t\t\t\t#使用账号和密码登录mysql<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>10、准备一个php文件，测试是否可以正常连接数据库</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">&lt;?php\n  $servername &#x3D; &quot;localhost&quot;;\n  $username &#x3D; &quot;root&quot;;\n  $password &#x3D; &quot;Bgx123.com&quot;;\n\n  &#x2F;&#x2F; 创建连接\n  $conn &#x3D; mysqli_connect($servername, $username, $password);\n\n  &#x2F;&#x2F; 检测连接\n  if (!$conn) &#123;\n      die(&quot;Connection failed: &quot; . mysqli_connect_error()); &#x2F;&#x2F; 注意格式\n  &#125;\n  echo &quot;php连接MySQL数据库成功&quot;;\n  ?&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、案例-搭建wordpress博客\"><a href=\"#三、案例-搭建wordpress博客\" class=\"headerlink\" title=\"三、案例-搭建wordpress博客\"></a>三、案例-搭建wordpress博客</h2><h3 id=\"3-1-环境准备\"><a href=\"#3-1-环境准备\" class=\"headerlink\" title=\"3.1 环境准备\"></a>3.1 环境准备</h3><table>\n<thead>\n<tr>\n<th>用途</th>\n<th>公网IP地址</th>\n<th>内网IP地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web服务器01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-2-部署安装\"><a href=\"#3-2-部署安装\" class=\"headerlink\" title=\"3.2 部署安装\"></a>3.2 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat blog.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name blog.oldboy.com;\n\troot &#x2F;code&#x2F;wordpress;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、根据nginx中定义的内容，创建站点目录并进行授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# mkdir &#x2F;code\n[root@web01 conf.d]# cd &#x2F;code\n[root@web01 code]# wget https:&#x2F;&#x2F;cn.wordpress.org&#x2F;wordpress-5.0.3-zh_CN.tar.gz\n[root@web01 code]# tar xf wordpress-5.0.3-zh_CN.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#注意：如果没有该用户，启动一定会报错\n[root@web01 code]# groupadd -g 666 www\n[root@web01 code]# useradd -u666 -g666 www\n\n修改nginx与php-fpm管理进程，的运行身份为www\n[root@web01 code]# sed -i &#39;&#x2F;^user &#x2F;c user  www;&#39; &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\n[root@web01 code]# sed -i &#39;&#x2F;^user&#x2F;c user &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf \n[root@web01 code]# sed -i &#39;&#x2F;^group&#x2F;c group &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf \n\n一定要重启才生效\n[root@web01 code]# systemctl restart nginx\n[root@web01 code]# systemctl restart php-fpm\n\n最后授权代码为www\n[root@web01 code]# chown -R www.www &#x2F;code&#x2F;wordpress\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、创建数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">MariaDB [(none)]&gt; create database wordpress;\t\t\t#创建一个库，名称叫wordpress\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]&gt; show databases;\t\t\t\t\t\t#查询该台数据库服务有多少个库\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n+--------------------+\n5 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、解决nginx上传文件大小限制（默认1M，超过大小会报413）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在wordpress的nginx配置文件中添加：client_max_body_size 100m;\n[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;blog.oldboy.com.conf \nserver &#123;\n        listen 80;\n        server_name blog.oldboy.com;\n        root &#x2F;code&#x2F;wordpress;\n        client_max_body_size 100m;  # 默认1M，超过大小会报413\n\n        location &#x2F; &#123;\n                index index.php index.html;\n        &#125;\n\n        location ~ \\.php$ &#123;\n                fastcgi_pass 127.0.0.1:9000;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n        &#125;\n&#125;\n重启nginx：systemctl restart nginx\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>测试在wordpress页面上传主题或者写文章上传图片，均出现500报错<br>查看日志文件&#x2F;var&#x2F;log&#x2F;nginx&#x2F;err.log<br>2021&#x2F;08&#x2F;16 18:59:31 [crit] 1228#1228: *2 open() “&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000001” failed (13: Permission denied), client: 10.0.0.1, server: php.gs.com, request: “POST &#x2F;wp-admin&#x2F;update.php?action&#x3D;upload-theme HTTP&#x2F;1.1”, host: “php.gs.com”, referrer: “<a href=\"http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;\">http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;</a><br>解决方法，参考<a href=\"https://blog.csdn.net/qq_15941409/article/details/114640122\">https://blog.csdn.net/qq_15941409/article/details/114640122</a><br>chown www:www -R &#x2F;var&#x2F;lib&#x2F;nginx&#x2F;</p>\n</blockquote>\n<h2 id=\"四、案例-搭建wecenter知乎\"><a href=\"#四、案例-搭建wecenter知乎\" class=\"headerlink\" title=\"四、案例-搭建wecenter知乎\"></a>四、案例-搭建wecenter知乎</h2><h3 id=\"4-1-部署安装\"><a href=\"#4-1-部署安装\" class=\"headerlink\" title=\"4.1 部署安装\"></a>4.1 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">server &#123;\n\tlisten 80;\n\tserver_name zh.oldboy.com;\n\troot &#x2F;code&#x2F;zh;\n\tclient_max_body_size 100m;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;\n[root@web01 code]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、wencenter部署</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# rz -E WeCenter_3-2-1.zip\n[root@web01 code]# unzip WeCenter_3-2-1.zip\n[root@web01 code]# mv WeCenter_3-2-1 zh\n[root@web01 code]# chown -R www.www zh&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、配置数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; create database zh;\nMariaDB [(none)]&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n6 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、案例-搭建edusoho在线视频教育\"><a href=\"#五、案例-搭建edusoho在线视频教育\" class=\"headerlink\" title=\"五、案例-搭建edusoho在线视频教育\"></a>五、案例-搭建edusoho在线视频教育</h2><h3 id=\"5-1-部署安装\"><a href=\"#5-1-部署安装\" class=\"headerlink\" title=\"5.1 部署安装\"></a>5.1 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;edu.oldboy.com.conf \nserver &#123;\n    listen 80;\n    server_name edu.oldboy.com;\n    root &#x2F;code&#x2F;edusoho&#x2F;web;\n    client_max_body_size 200m;\n\n    location &#x2F; &#123;\n        index app.php;\n        try_files $uri @rewriteapp;\n    &#125;\n    location @rewriteapp &#123;\n        rewrite ^(.*)$ &#x2F;app.php&#x2F;$1 last;\n    &#125;\n\n    location ~ ^&#x2F;udisk &#123;\n        internal;\n        root &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;;\n    &#125;\n\n    location ~ ^&#x2F;(app|app_dev)\\.php(&#x2F;|$) &#123;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(&#x2F;.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;\n        fastcgi_param HTTP_X-Accel-Mapping &#x2F;udisk&#x3D;&#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;udisk;\n        fastcgi_buffer_size 128k;\n        fastcgi_buffers 8 128k;\n    &#125;\n\n    # 配置设置图片格式文件\n    location ~* \\.(jpg|jpeg|gif|png|ico|swf)$ &#123;\n        # 过期时间为3年\n        expires 3y;\n        # 关闭日志记录\n        access_log off;\n        # 关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。\n        gzip off;\n    &#125;\n    # 配置css&#x2F;js文件\n    location ~* \\.(css|js)$ &#123;\n        access_log off;\n        expires 3y;\n    &#125;\n    # 禁止用户上传目录下所有.php文件的访问，提高安全性\n    location ~ ^&#x2F;files&#x2F;.*\\.(php|php5)$ &#123;\n        deny all;\n    &#125;\n\n    # 以下配置允许运行.php的程序，方便于其他第三方系统的集成。\n    location ~ \\.php$ &#123;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(&#x2F;.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、下载edusoho,并授权文件夹</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget http:&#x2F;&#x2F;download.edusoho.com&#x2F;edusoho-8.2.17.tar.gz\ntar xf edusoho-8.2.17.tar.gz\nchown -R www.www edusoho<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、调整php的上传大小(上传文件默认有限制大小)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini\npost_max_size &#x3D; 200M\nupload_max_filesize &#x3D; 200M\n[root@web01 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、各开源项目网站\"><a href=\"#六、各开源项目网站\" class=\"headerlink\" title=\"六、各开源项目网站\"></a>六、各开源项目网站</h2><p>phpmyadmin\t<a href=\"https://www.phpmyadmin.net/\">https://www.phpmyadmin.net/</a><br>zblog\t<a href=\"https://www.zblogcn.com/\">https://www.zblogcn.com/</a><br>wordpress\t<a href=\"https://cn.wordpress.org/\">https://cn.wordpress.org/</a><br>wecenter\t<a href=\"http://www.wecenter.com/downloads/\">http://www.wecenter.com/downloads/</a><br>edusohu\t<a href=\"http://www.edusoho.com/open/show\">http://www.edusoho.com/open/show</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、LNMP简介-需补充\"><a href=\"#一、LNMP简介-需补充\" class=\"headerlink\" title=\"一、LNMP简介(需补充)\"></a>一、LNMP简介(需补充)</h2><h3 id=\"1-1-什么是LNMP\"><a href=\"#1-1-什么是LNMP\" class=\"headerlink\" title=\"1.1 什么是LNMP\"></a>1.1 什么是LNMP</h3><h3 id=\"1-2-LNMP架构是如何工作的\"><a href=\"#1-2-LNMP架构是如何工作的\" class=\"headerlink\" title=\"1.2 LNMP架构是如何工作的\"></a>1.2 LNMP架构是如何工作的</h3><p>浏览器 –http–&gt; Nginx(fastcgi_pass) –fastcgi–&gt;php(fastcgi_fpm调动wrapper再调动php解析再调用mysql)</p>\n<p>大致流程：</p>\n<p>用户在浏览器发起请求，如果请求的是静态资源，Nginx则直接返回，如果请求的是动态资源，Nginx会通过fastcgi协议，将请求交给PHP服务器，再返回动态资源。</p>\n<h3 id=\"1-3-LNMP和LAMP的区别是什么\"><a href=\"#1-3-LNMP和LAMP的区别是什么\" class=\"headerlink\" title=\"1.3 LNMP和LAMP的区别是什么\"></a>1.3 LNMP和LAMP的区别是什么</h3><p>nginx 是以fastcgi协议调用的php<br>apache是以模块的方式加载的php</p>\n<h2 id=\"二、LNMP架构简单搭建\"><a href=\"#二、LNMP架构简单搭建\" class=\"headerlink\" title=\"二、LNMP架构简单搭建\"></a>二、LNMP架构简单搭建</h2><p>1、准备一台名为nginx的服务器</p>\n<p>2、使用官方仓库安装nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 添加安装源\n[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n\n#安装Nginx\n[root@nginx ~]# yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、安装php7.1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nginx ~]# yum remove php-mysql-5.4 php php-fpm php-common # 卸载默认5.4版本的php\n[root@nginx ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;php.repo\n[php]\nname &#x3D; php Repository\nbaseurl &#x3D; http:&#x2F;&#x2F;us-east.repo.webtatic.com&#x2F;yum&#x2F;el7&#x2F;x86_64&#x2F;\ngpgcheck &#x3D; 0\n\n[root@nginx ~]# yum -y install php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、安装maria数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@nginx ~]# yum install mariadb-server mariadb -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>5、配置nginx和php集成</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@web01 conf.d]# cat php.conf \nserver &#123;\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot &#x2F;code;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>6、重载nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>7、启动php-fpm，并加入开机自启</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# systemctl start php-fpm\n[root@web01 conf.d]# systemctl enable  php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>8、准备一个php文件，测试nginx和php是否继承成功</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat &#x2F;code&#x2F;page.php\n&lt;?php\n\tphpinfo();\n?&gt;\n# 测试：网页访问:http:&#x2F;&#x2F;php.oldboy.com&#x2F;page.php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、启动数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# systemctl start mariadb\n[root@web01 conf.d]# systemctl enable mariadb\n[root@web01 conf.d]# mysqladmin password &#39;Bgx123.com&#39;\t\t#配置密码（默认mysql是空密码）\n[root@web01 conf.d]# mysql -uroot -pBgx123.com\t\t\t\t#使用账号和密码登录mysql<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>10、准备一个php文件，测试是否可以正常连接数据库</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">&lt;?php\n  $servername &#x3D; &quot;localhost&quot;;\n  $username &#x3D; &quot;root&quot;;\n  $password &#x3D; &quot;Bgx123.com&quot;;\n\n  &#x2F;&#x2F; 创建连接\n  $conn &#x3D; mysqli_connect($servername, $username, $password);\n\n  &#x2F;&#x2F; 检测连接\n  if (!$conn) &#123;\n      die(&quot;Connection failed: &quot; . mysqli_connect_error()); &#x2F;&#x2F; 注意格式\n  &#125;\n  echo &quot;php连接MySQL数据库成功&quot;;\n  ?&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、案例-搭建wordpress博客\"><a href=\"#三、案例-搭建wordpress博客\" class=\"headerlink\" title=\"三、案例-搭建wordpress博客\"></a>三、案例-搭建wordpress博客</h2><h3 id=\"3-1-环境准备\"><a href=\"#3-1-环境准备\" class=\"headerlink\" title=\"3.1 环境准备\"></a>3.1 环境准备</h3><table>\n<thead>\n<tr>\n<th>用途</th>\n<th>公网IP地址</th>\n<th>内网IP地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web服务器01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-2-部署安装\"><a href=\"#3-2-部署安装\" class=\"headerlink\" title=\"3.2 部署安装\"></a>3.2 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat blog.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name blog.oldboy.com;\n\troot &#x2F;code&#x2F;wordpress;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、根据nginx中定义的内容，创建站点目录并进行授权</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# mkdir &#x2F;code\n[root@web01 conf.d]# cd &#x2F;code\n[root@web01 code]# wget https:&#x2F;&#x2F;cn.wordpress.org&#x2F;wordpress-5.0.3-zh_CN.tar.gz\n[root@web01 code]# tar xf wordpress-5.0.3-zh_CN.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、修改nginx与php-fpm的运行用户为www，并授权代码属主和属组都为www</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#注意：如果没有该用户，启动一定会报错\n[root@web01 code]# groupadd -g 666 www\n[root@web01 code]# useradd -u666 -g666 www\n\n修改nginx与php-fpm管理进程，的运行身份为www\n[root@web01 code]# sed -i &#39;&#x2F;^user &#x2F;c user  www;&#39; &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\n[root@web01 code]# sed -i &#39;&#x2F;^user&#x2F;c user &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf \n[root@web01 code]# sed -i &#39;&#x2F;^group&#x2F;c group &#x3D; www&#39; &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf \n\n一定要重启才生效\n[root@web01 code]# systemctl restart nginx\n[root@web01 code]# systemctl restart php-fpm\n\n最后授权代码为www\n[root@web01 code]# chown -R www.www &#x2F;code&#x2F;wordpress\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、创建数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">MariaDB [(none)]&gt; create database wordpress;\t\t\t#创建一个库，名称叫wordpress\nQuery OK, 1 row affected (0.00 sec)\n\nMariaDB [(none)]&gt; show databases;\t\t\t\t\t\t#查询该台数据库服务有多少个库\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n+--------------------+\n5 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、解决nginx上传文件大小限制（默认1M，超过大小会报413）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">在wordpress的nginx配置文件中添加：client_max_body_size 100m;\n[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;blog.oldboy.com.conf \nserver &#123;\n        listen 80;\n        server_name blog.oldboy.com;\n        root &#x2F;code&#x2F;wordpress;\n        client_max_body_size 100m;  # 默认1M，超过大小会报413\n\n        location &#x2F; &#123;\n                index index.php index.html;\n        &#125;\n\n        location ~ \\.php$ &#123;\n                fastcgi_pass 127.0.0.1:9000;\n                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n                include fastcgi_params;\n        &#125;\n&#125;\n重启nginx：systemctl restart nginx\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>测试在wordpress页面上传主题或者写文章上传图片，均出现500报错<br>查看日志文件&#x2F;var&#x2F;log&#x2F;nginx&#x2F;err.log<br>2021&#x2F;08&#x2F;16 18:59:31 [crit] 1228#1228: *2 open() “&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body&#x2F;0000000001” failed (13: Permission denied), client: 10.0.0.1, server: php.gs.com, request: “POST &#x2F;wp-admin&#x2F;update.php?action&#x3D;upload-theme HTTP&#x2F;1.1”, host: “php.gs.com”, referrer: “<a href=\"http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;\">http://php.gs.com/wp-admin/theme-install.php?browse=popular&quot;</a><br>解决方法，参考<a href=\"https://blog.csdn.net/qq_15941409/article/details/114640122\">https://blog.csdn.net/qq_15941409/article/details/114640122</a><br>chown www:www -R &#x2F;var&#x2F;lib&#x2F;nginx&#x2F;</p>\n</blockquote>\n<h2 id=\"四、案例-搭建wecenter知乎\"><a href=\"#四、案例-搭建wecenter知乎\" class=\"headerlink\" title=\"四、案例-搭建wecenter知乎\"></a>四、案例-搭建wecenter知乎</h2><h3 id=\"4-1-部署安装\"><a href=\"#4-1-部署安装\" class=\"headerlink\" title=\"4.1 部署安装\"></a>4.1 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">server &#123;\n\tlisten 80;\n\tserver_name zh.oldboy.com;\n\troot &#x2F;code&#x2F;zh;\n\tclient_max_body_size 100m;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;\n[root@web01 code]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、wencenter部署</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# rz -E WeCenter_3-2-1.zip\n[root@web01 code]# unzip WeCenter_3-2-1.zip\n[root@web01 code]# mv WeCenter_3-2-1 zh\n[root@web01 code]# chown -R www.www zh&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、配置数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; create database zh;\nMariaDB [(none)]&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n6 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五、案例-搭建edusoho在线视频教育\"><a href=\"#五、案例-搭建edusoho在线视频教育\" class=\"headerlink\" title=\"五、案例-搭建edusoho在线视频教育\"></a>五、案例-搭建edusoho在线视频教育</h2><h3 id=\"5-1-部署安装\"><a href=\"#5-1-部署安装\" class=\"headerlink\" title=\"5.1 部署安装\"></a>5.1 部署安装</h3><p>1、添加nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;edu.oldboy.com.conf \nserver &#123;\n    listen 80;\n    server_name edu.oldboy.com;\n    root &#x2F;code&#x2F;edusoho&#x2F;web;\n    client_max_body_size 200m;\n\n    location &#x2F; &#123;\n        index app.php;\n        try_files $uri @rewriteapp;\n    &#125;\n    location @rewriteapp &#123;\n        rewrite ^(.*)$ &#x2F;app.php&#x2F;$1 last;\n    &#125;\n\n    location ~ ^&#x2F;udisk &#123;\n        internal;\n        root &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;;\n    &#125;\n\n    location ~ ^&#x2F;(app|app_dev)\\.php(&#x2F;|$) &#123;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(&#x2F;.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n        fastcgi_param HTTP_X-Sendfile-Type X-Accel-Redirect;\n        fastcgi_param HTTP_X-Accel-Mapping &#x2F;udisk&#x3D;&#x2F;code&#x2F;edusoho&#x2F;app&#x2F;data&#x2F;udisk;\n        fastcgi_buffer_size 128k;\n        fastcgi_buffers 8 128k;\n    &#125;\n\n    # 配置设置图片格式文件\n    location ~* \\.(jpg|jpeg|gif|png|ico|swf)$ &#123;\n        # 过期时间为3年\n        expires 3y;\n        # 关闭日志记录\n        access_log off;\n        # 关闭gzip压缩，减少CPU消耗，因为图片的压缩率不高。\n        gzip off;\n    &#125;\n    # 配置css&#x2F;js文件\n    location ~* \\.(css|js)$ &#123;\n        access_log off;\n        expires 3y;\n    &#125;\n    # 禁止用户上传目录下所有.php文件的访问，提高安全性\n    location ~ ^&#x2F;files&#x2F;.*\\.(php|php5)$ &#123;\n        deny all;\n    &#125;\n\n    # 以下配置允许运行.php的程序，方便于其他第三方系统的集成。\n    location ~ \\.php$ &#123;\n        fastcgi_pass   127.0.0.1:9000;\n        fastcgi_split_path_info ^(.+\\.php)(&#x2F;.*)$;\n        include fastcgi_params;\n        fastcgi_param  SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n        fastcgi_param  HTTPS              off;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、下载edusoho,并授权文件夹</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget http:&#x2F;&#x2F;download.edusoho.com&#x2F;edusoho-8.2.17.tar.gz\ntar xf edusoho-8.2.17.tar.gz\nchown -R www.www edusoho<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、调整php的上传大小(上传文件默认有限制大小)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini\npost_max_size &#x3D; 200M\nupload_max_filesize &#x3D; 200M\n[root@web01 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六、各开源项目网站\"><a href=\"#六、各开源项目网站\" class=\"headerlink\" title=\"六、各开源项目网站\"></a>六、各开源项目网站</h2><p>phpmyadmin\t<a href=\"https://www.phpmyadmin.net/\">https://www.phpmyadmin.net/</a><br>zblog\t<a href=\"https://www.zblogcn.com/\">https://www.zblogcn.com/</a><br>wordpress\t<a href=\"https://cn.wordpress.org/\">https://cn.wordpress.org/</a><br>wecenter\t<a href=\"http://www.wecenter.com/downloads/\">http://www.wecenter.com/downloads/</a><br>edusohu\t<a href=\"http://www.edusoho.com/open/show\">http://www.edusoho.com/open/show</a></p>\n"},{"title":"运维之综合架构--07--Nginx(五)代理介绍","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、什么是代理\n\n### 1.1 正向代理和反向代理的区别\n\n区别在于形式上服务的\"对象\"不一样\n\t正向代理代理的对象是客户端，为客户端服务   PC电脑\n\t反向代理代理的对象是服务端，为服务端服务\t服务器\n\n### 1.2 Nginx反向代理模式配置模块\n\n反向代理模式\t\t\t\tNginx配置模块\nhttp、websocket、https\t\tngx_http_proxy_module\nfastcgi\t\t\t\t\t\tngx_http_fastcgi_module\nuwsgi\t\t\t\t\t\tngx_http_uwsgi_module\ngrpc\t\t\t\t\t\tngx_http_v2_module\n\n## 二、Nginx代理配置\n\n### 2.1 测试环境准备\n\n| 主机名称 | 应用环境                    | 外网地址  | 内网地址    |\n| -------- | --------------------------- | --------- | ----------- |\n| web01    | nginx + php（提供网页服务） | 10.0.0.7  | 172.16.1.7  |\n| lb01     | nginx（提供代理服务）       | 10.0.0.5  | 172.16.1.5  |\n| db01     | mysql                       | 10.0.0.51 | 172.16.1.51 |\n\n### 2.2 Nginx代理配置步骤\n\n1、`web01`-配置后端的web\n\n```shell\n[root@web01 conf.d]# cat web.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\troot /web;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n}\n```\n\n2、创建文件夹和网页文件\n\n```shell\n[root@web01 conf.d]# mkdir /web\n[root@web01 conf.d]# echo \"Web01.....\" > /web/index.html\n```\n\n3、重启nginx服务\n\n```shell\n[root@web01 conf.d]# nginx -t\nsysnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\nt[root@web01 conf.d]# systemctl restart nginx\n```\n\n4、`lb01`-nginx代理配置\n\n```shell\n[root@lb01 conf.d]# cat proxy_web.conf\nserver {\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\tlocation / {\n\t\tproxy_pass http://10.0.0.7:80;\n\t\t# 设置header将域名传过去\n\t\tproxy_set_header Host $http_host; \n\t}\n}\n```\n\n5、重启Nginx服务\n\n```shell\nsystemctl restart nginx\n```\n\n6、客户机设置hosts，并测试访问网页，可以正常显示web01页面\n\n```shell\n10.0.0.5 web.oldboy.com\n```\n\n![image-20210820101740471](/img/image-20210820101740471.png)\n\n## 三、代理流程分析\n\n1、走10网关，wireshark的抓包截图如下\n\n![image-20210820102735419](/img/image-20210820102735419.png)\n\n2、流程图\n\n![image-20210820103041679](/img/image-20210820103041679.png)\n\n3、测试，关掉web01的公网ip网口(10.0.0.7)，再尝试访问，也可以正常访问到web01的网页\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/conf.d/proxy_web.conf\nserver {\n        listen 80;\n        server_name  web.oldboy.com;\n        location / {\n                proxy_pass http://172.16.1.7:80;\n                include /etc/nginx/proxy_params;\n        }\n\n}\n```\n\n4、抓包分析\n\n因为172网段走的虚拟机内部网络，抓不到\n\n![image-20210820111454152](/img/image-20210820111454152.png)\n\n\n\n## 三、Nginx代理常用参数\n\n### 3.1 常用参数解释\n\n| 参数                                                         | 作用                                                         |\n| ------------------------------------------------------------ | ------------------------------------------------------------ |\n| proxy_pass http://10.0.0.7:80;                               |                                                              |\n| proxy_http_version 1.1;                                      | 代理向后端请求使用的版本                                     |\n| proxy_set_header Host $http_host;                            | 代理向后端请求携带的域名                                     |\n| proxy_set_header X-Real-IP $remote_addr;                     | <font color=\"blue\">用于获取客户端真实IP（不如x-forward）</font> |\n| proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; | <font color=\"blue\">获取客户端真实IP及全链路IP</font>         |\n| proxy_connect_timeout 30;                                    | 代理接连后端超时时间                                         |\n| proxy_send_timeout 60;                                       | 后端传递数据至代理的超时时间                                 |\n| proxy_read_timeout 60;                                       | 后端相应代理的超时时间                                       |\n| proxy_buffering on;                                          | 是否开启proxy的buffer功能                                    |\n| proxy_buffer_size 32k;                                       | 设置buffer大小                                               |\n| proxy_buffers 4 128k;                                        | 设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小 |\n\nX-Forwarded-For可以nginx的日志查看到\n\n```shell\ntail -f /var/log/nginx/access.log\n```\n\n### 3.2 参数多的时候如何配置\n\n>可将参数写到一个文件中，然后在nginx配置文件里include包含进去\n\n1、创建包含参数的文件\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n2、在配置文件中导入，方便后续多个location使用\n\n```shell\nlocation / {\n    proxy_pass http://127.0.0.1:8080;\n    include proxy_params;\n}\n```\n\n","source":"_posts/01_运维/02-综合架构/11-Nginx(五)Nginx代理.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(五)代理介绍\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、什么是代理\n\n### 1.1 正向代理和反向代理的区别\n\n区别在于形式上服务的\"对象\"不一样\n\t正向代理代理的对象是客户端，为客户端服务   PC电脑\n\t反向代理代理的对象是服务端，为服务端服务\t服务器\n\n### 1.2 Nginx反向代理模式配置模块\n\n反向代理模式\t\t\t\tNginx配置模块\nhttp、websocket、https\t\tngx_http_proxy_module\nfastcgi\t\t\t\t\t\tngx_http_fastcgi_module\nuwsgi\t\t\t\t\t\tngx_http_uwsgi_module\ngrpc\t\t\t\t\t\tngx_http_v2_module\n\n## 二、Nginx代理配置\n\n### 2.1 测试环境准备\n\n| 主机名称 | 应用环境                    | 外网地址  | 内网地址    |\n| -------- | --------------------------- | --------- | ----------- |\n| web01    | nginx + php（提供网页服务） | 10.0.0.7  | 172.16.1.7  |\n| lb01     | nginx（提供代理服务）       | 10.0.0.5  | 172.16.1.5  |\n| db01     | mysql                       | 10.0.0.51 | 172.16.1.51 |\n\n### 2.2 Nginx代理配置步骤\n\n1、`web01`-配置后端的web\n\n```shell\n[root@web01 conf.d]# cat web.oldboy.com.conf \nserver {\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\troot /web;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n}\n```\n\n2、创建文件夹和网页文件\n\n```shell\n[root@web01 conf.d]# mkdir /web\n[root@web01 conf.d]# echo \"Web01.....\" > /web/index.html\n```\n\n3、重启nginx服务\n\n```shell\n[root@web01 conf.d]# nginx -t\nsysnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\nt[root@web01 conf.d]# systemctl restart nginx\n```\n\n4、`lb01`-nginx代理配置\n\n```shell\n[root@lb01 conf.d]# cat proxy_web.conf\nserver {\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\tlocation / {\n\t\tproxy_pass http://10.0.0.7:80;\n\t\t# 设置header将域名传过去\n\t\tproxy_set_header Host $http_host; \n\t}\n}\n```\n\n5、重启Nginx服务\n\n```shell\nsystemctl restart nginx\n```\n\n6、客户机设置hosts，并测试访问网页，可以正常显示web01页面\n\n```shell\n10.0.0.5 web.oldboy.com\n```\n\n![image-20210820101740471](/img/image-20210820101740471.png)\n\n## 三、代理流程分析\n\n1、走10网关，wireshark的抓包截图如下\n\n![image-20210820102735419](/img/image-20210820102735419.png)\n\n2、流程图\n\n![image-20210820103041679](/img/image-20210820103041679.png)\n\n3、测试，关掉web01的公网ip网口(10.0.0.7)，再尝试访问，也可以正常访问到web01的网页\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/conf.d/proxy_web.conf\nserver {\n        listen 80;\n        server_name  web.oldboy.com;\n        location / {\n                proxy_pass http://172.16.1.7:80;\n                include /etc/nginx/proxy_params;\n        }\n\n}\n```\n\n4、抓包分析\n\n因为172网段走的虚拟机内部网络，抓不到\n\n![image-20210820111454152](/img/image-20210820111454152.png)\n\n\n\n## 三、Nginx代理常用参数\n\n### 3.1 常用参数解释\n\n| 参数                                                         | 作用                                                         |\n| ------------------------------------------------------------ | ------------------------------------------------------------ |\n| proxy_pass http://10.0.0.7:80;                               |                                                              |\n| proxy_http_version 1.1;                                      | 代理向后端请求使用的版本                                     |\n| proxy_set_header Host $http_host;                            | 代理向后端请求携带的域名                                     |\n| proxy_set_header X-Real-IP $remote_addr;                     | <font color=\"blue\">用于获取客户端真实IP（不如x-forward）</font> |\n| proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; | <font color=\"blue\">获取客户端真实IP及全链路IP</font>         |\n| proxy_connect_timeout 30;                                    | 代理接连后端超时时间                                         |\n| proxy_send_timeout 60;                                       | 后端传递数据至代理的超时时间                                 |\n| proxy_read_timeout 60;                                       | 后端相应代理的超时时间                                       |\n| proxy_buffering on;                                          | 是否开启proxy的buffer功能                                    |\n| proxy_buffer_size 32k;                                       | 设置buffer大小                                               |\n| proxy_buffers 4 128k;                                        | 设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小 |\n\nX-Forwarded-For可以nginx的日志查看到\n\n```shell\ntail -f /var/log/nginx/access.log\n```\n\n### 3.2 参数多的时候如何配置\n\n>可将参数写到一个文件中，然后在nginx配置文件里include包含进去\n\n1、创建包含参数的文件\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n2、在配置文件中导入，方便后续多个location使用\n\n```shell\nlocation / {\n    proxy_pass http://127.0.0.1:8080;\n    include proxy_params;\n}\n```\n\n","slug":"01_运维/02-综合架构/11-Nginx(五)Nginx代理","published":1,"updated":"2022-07-11T05:54:01.571Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0j000xa8v7bw3ueb13","content":"<h2 id=\"一、什么是代理\"><a href=\"#一、什么是代理\" class=\"headerlink\" title=\"一、什么是代理\"></a>一、什么是代理</h2><h3 id=\"1-1-正向代理和反向代理的区别\"><a href=\"#1-1-正向代理和反向代理的区别\" class=\"headerlink\" title=\"1.1 正向代理和反向代理的区别\"></a>1.1 正向代理和反向代理的区别</h3><p>区别在于形式上服务的”对象”不一样<br>    正向代理代理的对象是客户端，为客户端服务   PC电脑<br>    反向代理代理的对象是服务端，为服务端服务\t服务器</p>\n<h3 id=\"1-2-Nginx反向代理模式配置模块\"><a href=\"#1-2-Nginx反向代理模式配置模块\" class=\"headerlink\" title=\"1.2 Nginx反向代理模式配置模块\"></a>1.2 Nginx反向代理模式配置模块</h3><p>反向代理模式\t\t\t\tNginx配置模块<br>http、websocket、https\t\tngx_http_proxy_module<br>fastcgi\t\t\t\t\t\tngx_http_fastcgi_module<br>uwsgi\t\t\t\t\t\tngx_http_uwsgi_module<br>grpc\t\t\t\t\t\tngx_http_v2_module</p>\n<h2 id=\"二、Nginx代理配置\"><a href=\"#二、Nginx代理配置\" class=\"headerlink\" title=\"二、Nginx代理配置\"></a>二、Nginx代理配置</h2><h3 id=\"2-1-测试环境准备\"><a href=\"#2-1-测试环境准备\" class=\"headerlink\" title=\"2.1 测试环境准备\"></a>2.1 测试环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>nginx（提供代理服务）</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td>10.0.0.51</td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-Nginx代理配置步骤\"><a href=\"#2-2-Nginx代理配置步骤\" class=\"headerlink\" title=\"2.2 Nginx代理配置步骤\"></a>2.2 Nginx代理配置步骤</h3><p>1、<code>web01</code>-配置后端的web</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat web.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\troot &#x2F;web;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建文件夹和网页文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# mkdir &#x2F;web\n[root@web01 conf.d]# echo &quot;Web01.....&quot; &gt; &#x2F;web&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3、重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# nginx -t\nsysnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\nt[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、<code>lb01</code>-nginx代理配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat proxy_web.conf\nserver &#123;\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\tlocation &#x2F; &#123;\n\t\tproxy_pass http:&#x2F;&#x2F;10.0.0.7:80;\n\t\t# 设置header将域名传过去\n\t\tproxy_set_header Host $http_host; \n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、重启Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、客户机设置hosts，并测试访问网页，可以正常显示web01页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">10.0.0.5 web.oldboy.com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/img/image-20210820101740471.png\" alt=\"image-20210820101740471\"></p>\n<h2 id=\"三、代理流程分析\"><a href=\"#三、代理流程分析\" class=\"headerlink\" title=\"三、代理流程分析\"></a>三、代理流程分析</h2><p>1、走10网关，wireshark的抓包截图如下</p>\n<p><img src=\"/img/image-20210820102735419.png\" alt=\"image-20210820102735419\"></p>\n<p>2、流程图</p>\n<p><img src=\"/img/image-20210820103041679.png\" alt=\"image-20210820103041679\"></p>\n<p>3、测试，关掉web01的公网ip网口(10.0.0.7)，再尝试访问，也可以正常访问到web01的网页</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_web.conf\nserver &#123;\n        listen 80;\n        server_name  web.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;172.16.1.7:80;\n                include &#x2F;etc&#x2F;nginx&#x2F;proxy_params;\n        &#125;\n\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、抓包分析</p>\n<p>因为172网段走的虚拟机内部网络，抓不到</p>\n<p><img src=\"/img/image-20210820111454152.png\" alt=\"image-20210820111454152\"></p>\n<h2 id=\"三、Nginx代理常用参数\"><a href=\"#三、Nginx代理常用参数\" class=\"headerlink\" title=\"三、Nginx代理常用参数\"></a>三、Nginx代理常用参数</h2><h3 id=\"3-1-常用参数解释\"><a href=\"#3-1-常用参数解释\" class=\"headerlink\" title=\"3.1 常用参数解释\"></a>3.1 常用参数解释</h3><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>proxy_pass <a href=\"http://10.0.0.7/\">http://10.0.0.7:80</a>;</td>\n<td></td>\n</tr>\n<tr>\n<td>proxy_http_version 1.1;</td>\n<td>代理向后端请求使用的版本</td>\n</tr>\n<tr>\n<td>proxy_set_header Host $http_host;</td>\n<td>代理向后端请求携带的域名</td>\n</tr>\n<tr>\n<td>proxy_set_header X-Real-IP $remote_addr;</td>\n<td><font color=\"blue\">用于获取客户端真实IP（不如x-forward）</font></td>\n</tr>\n<tr>\n<td>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</td>\n<td><font color=\"blue\">获取客户端真实IP及全链路IP</font></td>\n</tr>\n<tr>\n<td>proxy_connect_timeout 30;</td>\n<td>代理接连后端超时时间</td>\n</tr>\n<tr>\n<td>proxy_send_timeout 60;</td>\n<td>后端传递数据至代理的超时时间</td>\n</tr>\n<tr>\n<td>proxy_read_timeout 60;</td>\n<td>后端相应代理的超时时间</td>\n</tr>\n<tr>\n<td>proxy_buffering on;</td>\n<td>是否开启proxy的buffer功能</td>\n</tr>\n<tr>\n<td>proxy_buffer_size 32k;</td>\n<td>设置buffer大小</td>\n</tr>\n<tr>\n<td>proxy_buffers 4 128k;</td>\n<td>设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小</td>\n</tr>\n</tbody></table>\n<p>X-Forwarded-For可以nginx的日志查看到</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"3-2-参数多的时候如何配置\"><a href=\"#3-2-参数多的时候如何配置\" class=\"headerlink\" title=\"3.2 参数多的时候如何配置\"></a>3.2 参数多的时候如何配置</h3><blockquote>\n<p>可将参数写到一个文件中，然后在nginx配置文件里include包含进去</p>\n</blockquote>\n<p>1、创建包含参数的文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、在配置文件中导入，方便后续多个location使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F; &#123;\n    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;\n    include proxy_params;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、什么是代理\"><a href=\"#一、什么是代理\" class=\"headerlink\" title=\"一、什么是代理\"></a>一、什么是代理</h2><h3 id=\"1-1-正向代理和反向代理的区别\"><a href=\"#1-1-正向代理和反向代理的区别\" class=\"headerlink\" title=\"1.1 正向代理和反向代理的区别\"></a>1.1 正向代理和反向代理的区别</h3><p>区别在于形式上服务的”对象”不一样<br>    正向代理代理的对象是客户端，为客户端服务   PC电脑<br>    反向代理代理的对象是服务端，为服务端服务\t服务器</p>\n<h3 id=\"1-2-Nginx反向代理模式配置模块\"><a href=\"#1-2-Nginx反向代理模式配置模块\" class=\"headerlink\" title=\"1.2 Nginx反向代理模式配置模块\"></a>1.2 Nginx反向代理模式配置模块</h3><p>反向代理模式\t\t\t\tNginx配置模块<br>http、websocket、https\t\tngx_http_proxy_module<br>fastcgi\t\t\t\t\t\tngx_http_fastcgi_module<br>uwsgi\t\t\t\t\t\tngx_http_uwsgi_module<br>grpc\t\t\t\t\t\tngx_http_v2_module</p>\n<h2 id=\"二、Nginx代理配置\"><a href=\"#二、Nginx代理配置\" class=\"headerlink\" title=\"二、Nginx代理配置\"></a>二、Nginx代理配置</h2><h3 id=\"2-1-测试环境准备\"><a href=\"#2-1-测试环境准备\" class=\"headerlink\" title=\"2.1 测试环境准备\"></a>2.1 测试环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>nginx（提供代理服务）</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td>10.0.0.51</td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-Nginx代理配置步骤\"><a href=\"#2-2-Nginx代理配置步骤\" class=\"headerlink\" title=\"2.2 Nginx代理配置步骤\"></a>2.2 Nginx代理配置步骤</h3><p>1、<code>web01</code>-配置后端的web</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat web.oldboy.com.conf \nserver &#123;\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\troot &#x2F;web;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建文件夹和网页文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# mkdir &#x2F;web\n[root@web01 conf.d]# echo &quot;Web01.....&quot; &gt; &#x2F;web&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3、重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# nginx -t\nsysnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\nt[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、<code>lb01</code>-nginx代理配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat proxy_web.conf\nserver &#123;\n\tlisten 80;\n\tserver_name web.oldboy.com;\n\tlocation &#x2F; &#123;\n\t\tproxy_pass http:&#x2F;&#x2F;10.0.0.7:80;\n\t\t# 设置header将域名传过去\n\t\tproxy_set_header Host $http_host; \n\t&#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、重启Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、客户机设置hosts，并测试访问网页，可以正常显示web01页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">10.0.0.5 web.oldboy.com<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/img/image-20210820101740471.png\" alt=\"image-20210820101740471\"></p>\n<h2 id=\"三、代理流程分析\"><a href=\"#三、代理流程分析\" class=\"headerlink\" title=\"三、代理流程分析\"></a>三、代理流程分析</h2><p>1、走10网关，wireshark的抓包截图如下</p>\n<p><img src=\"/img/image-20210820102735419.png\" alt=\"image-20210820102735419\"></p>\n<p>2、流程图</p>\n<p><img src=\"/img/image-20210820103041679.png\" alt=\"image-20210820103041679\"></p>\n<p>3、测试，关掉web01的公网ip网口(10.0.0.7)，再尝试访问，也可以正常访问到web01的网页</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_web.conf\nserver &#123;\n        listen 80;\n        server_name  web.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;172.16.1.7:80;\n                include &#x2F;etc&#x2F;nginx&#x2F;proxy_params;\n        &#125;\n\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、抓包分析</p>\n<p>因为172网段走的虚拟机内部网络，抓不到</p>\n<p><img src=\"/img/image-20210820111454152.png\" alt=\"image-20210820111454152\"></p>\n<h2 id=\"三、Nginx代理常用参数\"><a href=\"#三、Nginx代理常用参数\" class=\"headerlink\" title=\"三、Nginx代理常用参数\"></a>三、Nginx代理常用参数</h2><h3 id=\"3-1-常用参数解释\"><a href=\"#3-1-常用参数解释\" class=\"headerlink\" title=\"3.1 常用参数解释\"></a>3.1 常用参数解释</h3><table>\n<thead>\n<tr>\n<th>参数</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>proxy_pass <a href=\"http://10.0.0.7/\">http://10.0.0.7:80</a>;</td>\n<td></td>\n</tr>\n<tr>\n<td>proxy_http_version 1.1;</td>\n<td>代理向后端请求使用的版本</td>\n</tr>\n<tr>\n<td>proxy_set_header Host $http_host;</td>\n<td>代理向后端请求携带的域名</td>\n</tr>\n<tr>\n<td>proxy_set_header X-Real-IP $remote_addr;</td>\n<td><font color=\"blue\">用于获取客户端真实IP（不如x-forward）</font></td>\n</tr>\n<tr>\n<td>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</td>\n<td><font color=\"blue\">获取客户端真实IP及全链路IP</font></td>\n</tr>\n<tr>\n<td>proxy_connect_timeout 30;</td>\n<td>代理接连后端超时时间</td>\n</tr>\n<tr>\n<td>proxy_send_timeout 60;</td>\n<td>后端传递数据至代理的超时时间</td>\n</tr>\n<tr>\n<td>proxy_read_timeout 60;</td>\n<td>后端相应代理的超时时间</td>\n</tr>\n<tr>\n<td>proxy_buffering on;</td>\n<td>是否开启proxy的buffer功能</td>\n</tr>\n<tr>\n<td>proxy_buffer_size 32k;</td>\n<td>设置buffer大小</td>\n</tr>\n<tr>\n<td>proxy_buffers 4 128k;</td>\n<td>设置存储被代理服务器上的数据所占用的buffer的个数和每个buffer的大小</td>\n</tr>\n</tbody></table>\n<p>X-Forwarded-For可以nginx的日志查看到</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"3-2-参数多的时候如何配置\"><a href=\"#3-2-参数多的时候如何配置\" class=\"headerlink\" title=\"3.2 参数多的时候如何配置\"></a>3.2 参数多的时候如何配置</h3><blockquote>\n<p>可将参数写到一个文件中，然后在nginx配置文件里include包含进去</p>\n</blockquote>\n<p>1、创建包含参数的文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、在配置文件中导入，方便后续多个location使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">location &#x2F; &#123;\n    proxy_pass http:&#x2F;&#x2F;127.0.0.1:8080;\n    include proxy_params;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--07--Nginx(四)LNMP架构拆分","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、拆分数据库\t\n\n> 为什么要拆分数据库?\n>\n> mysql内存占用大，容易引起网页访问速度变慢，甚至oom(out of memory)被系统自动kill掉，不安全\n\n### 1.2 环境准备\n\n| 主机名称 | 应用环境  | 外网地址 | 内网地址    |\n| -------- | --------- | -------- | ----------- |\n| web01    | nginx+php | 10.0.0.7 | 172.16.1.7  |\n| db01     | mysql     |          | 172.16.1.51 |\n\n### 1.2 拆分过程\n\n1、备份172.16.1.7服务器上mysql的数据\n\n```shell\n[root@web01 ~]# mysqldump -uroot -p'Bgx123.com' --all-databases --single-transaction > mysql-all.sql\n```\n\n2、传输172.16.1.7的备份数据至172.16.1.51的服务器上\n\n```shell\n[root@web01 ~]# scp mysql-all.sql root@172.16.1.51:/tmp\n```\n\n3、需要先在172.16.1.51服务器上安装mysql服务，然后使用mysql命令进行还原。\n\n```shell\n[root@db01 ~]# yum install mariadb-server mariadb -y\n[root@db01 ~]# systemctl enable mariadb\n[root@db01 ~]# systemctl start mariadb\n[root@db01 ~]# mysql </tmp/mysql-all.sql\n[root@db01 ~]# systemctl restart mariadb\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| edusoho            |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n7 rows in set (0.00 sec)\n```\n\n4、将web程序连接的本地数据库修改到远程数据库上。\n\n```shell\n1）先在本地172.16.1.7服务器上停止本地的数据库\n[root@web01 ~]# systemctl disable mariadb\n[root@web01 ~]# systemctl stop mariadb\n\n2）在172.16.1.51的服务器上授权远程主机能够能连接mysql数据库\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> grant all privileges on *.* to oldboy@'%' identified by 'Bgx123.com';\n解释：\n*.*: 所有数据库下的所有表\noldboy@'%': 允许所有网段的oldboy用户访问\nidentify: 设置密码\n\n3）在172.16.1.7服务器上测试远程账户能否连接172.16.1.51的数据库\n[root@web01 wordpress]# yum install mariadb -y\n[root@web01 wordpress]# mysql -h 172.16.1.51 -uoldboy -pBgx123.com\nMariaDB [(none)]> \n\n4）在172.16.1.7服务器上修改web程序连接数据库的配置文件\n[root@web01 wordpress]# vim /code/wordpress/wp-config.php\n// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //\n/** WordPress数据库的名称 */\ndefine('DB_NAME', 'wordpress');\n\n/** MySQL数据库用户名 */\ndefine('DB_USER', 'oldboy');\n\n/** MySQL数据库密码 */\ndefine('DB_PASSWORD', 'Bgx123.com');\n\n/** MySQL主机 */\ndefine('DB_HOST', '172.16.1.51');\n```\n\n5、拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息\n\n```shell\n\t[root@web01 zh]# grep -R \"Bgx123.com\" *\n\t\tsystem/config/database.php:  'password' => 'Bgx123.com',\n\t[root@web01 zh]# vim /code/zh/system/config/database.php \n\t\t$config['driver'] = 'MySQLi';^M\n\t\t$config['master'] = array (\n\t\t  'charset' => 'utf8',\n\t\t  'host' => '172.16.1.51',\n\t\t  'username' => 'oldboy',\n\t\t  'password' => 'Bgx123.com',\n\t\t  'dbname' => 'zh',\n\t\t);^M\n```\n\n6、拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息\n\n```shell\n[root@web01 edusoho]# vim /code/edusoho/app/config/parameters.yml\ndatabase_driver: pdo_mysql\ndatabase_host: 172.16.1.51\ndatabase_port: 3306\ndatabase_name: edusoho\ndatabase_user: oldboy\ndatabase_password: 'Bgx123.com'\n\n必须清理缓存\n[root@web01 edusoho]# rm -rf /code/edusoho/app/cache/*\n```\n\n## 二、扩展多台web服务器\n\n```shell\n1.统一环境\n    0）准备对应的www用户\n    [root@web02 ~]# groupadd -g666 www\n    [root@web02 ~]# useradd -u666 -g666 www\n\n    1）拷贝web01上面的yum仓库\n    [root@web02 ~]# scp root@172.16.1.7:/etc/yum.repos.d/*.repo /etc/yum.repos.d/\n\n    2）安装nginx和php\n    [root@web02 ~]# yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n\n2.统一配置（同步web01上面的配置到web02）\n    1）同步nginx\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:/etc/nginx/ /etc/nginx/\n    [root@web02 ~]# nginx -t\n    [root@web02 ~]# systemctl enable nginx\n    [root@web02 ~]# systemctl start nginx\n\n    2）同步php（/etc/php-fpm.conf /etc/php-fpm.d  /etc/php.ini）\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:/etc/php* /etc/\n    [root@web02 ~]# systemctl enable php-fpm\n    [root@web02 ~]# systemctl start php-fpm\n\n3.统一代码\n    [root@web01 ~]# tar czf code.tar.gz /code\t\t\t\t#在web01上打包站点\n    [root@web01 ~]# scp code.tar.gz root@172.16.1.8:/tmp\t#在web01上将打包好的代码发送给web02\n    [root@web02 ~]# tar xf /tmp/code.tar.gz -C /\t\t\t#在web02上进行解压，并解压到/目录下\n\n4.配置解析，进行访问\n```\n\n## 三、NFS共享多台web的静态资源\n\n```shell\n1.准备172.16.1.31共享存储服务器，规划目录，配置好权限\n    0）创建用户\n    [root@nfs ~]# groupadd -g666 www\n    [root@nfs ~]# useradd -u666 -g666 www\t\n\n    1）安装\n    [root@nfs ~]# yum install nfs-utils -y\n\n    2）配置\n    [root@nfs ~]# cat /etc/exports\n    /data/blog 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n    /data/zh 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n    /data/edu 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\n    3）根据配置，创建目录，准备用户，授权等等\n    [root@nfs ~]# rm -rf /data/\n    [root@nfs ~]# mkdir /data/{blog,zh,edu} -p\n    [root@nfs ~]# chown -R www.www /data/\n\n    4）启动\n    [root@nfs ~]# systemctl enable nfs-utils \n    [root@nfs ~]# systemctl restart nfs-utils\n\n2.将图片较多的web02服务器，推送到nfs共享存储上\n    http://blog.oldboy.com/wp-content/uploads/2019/01/timg.jpg\n\n    [root@web02 ~]# cd /code/wordpress/wp-content\n    [root@web02 wp-content]# scp -r uploads/* root@172.16.1.31:/data/blog/\n\n    注意：需要上nfs服务器上进行重新的递归授权，否则会出现无法上传文件的错误\n    [root@nfs ~]# chown -R www.www /data/\n\n3.web01和web02分别都进行挂载，此时图片进行实现了共享\n    mount -t nfs 172.16.1.31:/data/blog  /code/wordpress/wp-content/uploads/\n```\n\n","source":"_posts/01_运维/02-综合架构/10-Nginx(四)LNMP架构拆分.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(四)LNMP架构拆分\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、拆分数据库\t\n\n> 为什么要拆分数据库?\n>\n> mysql内存占用大，容易引起网页访问速度变慢，甚至oom(out of memory)被系统自动kill掉，不安全\n\n### 1.2 环境准备\n\n| 主机名称 | 应用环境  | 外网地址 | 内网地址    |\n| -------- | --------- | -------- | ----------- |\n| web01    | nginx+php | 10.0.0.7 | 172.16.1.7  |\n| db01     | mysql     |          | 172.16.1.51 |\n\n### 1.2 拆分过程\n\n1、备份172.16.1.7服务器上mysql的数据\n\n```shell\n[root@web01 ~]# mysqldump -uroot -p'Bgx123.com' --all-databases --single-transaction > mysql-all.sql\n```\n\n2、传输172.16.1.7的备份数据至172.16.1.51的服务器上\n\n```shell\n[root@web01 ~]# scp mysql-all.sql root@172.16.1.51:/tmp\n```\n\n3、需要先在172.16.1.51服务器上安装mysql服务，然后使用mysql命令进行还原。\n\n```shell\n[root@db01 ~]# yum install mariadb-server mariadb -y\n[root@db01 ~]# systemctl enable mariadb\n[root@db01 ~]# systemctl start mariadb\n[root@db01 ~]# mysql </tmp/mysql-all.sql\n[root@db01 ~]# systemctl restart mariadb\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| edusoho            |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n7 rows in set (0.00 sec)\n```\n\n4、将web程序连接的本地数据库修改到远程数据库上。\n\n```shell\n1）先在本地172.16.1.7服务器上停止本地的数据库\n[root@web01 ~]# systemctl disable mariadb\n[root@web01 ~]# systemctl stop mariadb\n\n2）在172.16.1.51的服务器上授权远程主机能够能连接mysql数据库\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]> grant all privileges on *.* to oldboy@'%' identified by 'Bgx123.com';\n解释：\n*.*: 所有数据库下的所有表\noldboy@'%': 允许所有网段的oldboy用户访问\nidentify: 设置密码\n\n3）在172.16.1.7服务器上测试远程账户能否连接172.16.1.51的数据库\n[root@web01 wordpress]# yum install mariadb -y\n[root@web01 wordpress]# mysql -h 172.16.1.51 -uoldboy -pBgx123.com\nMariaDB [(none)]> \n\n4）在172.16.1.7服务器上修改web程序连接数据库的配置文件\n[root@web01 wordpress]# vim /code/wordpress/wp-config.php\n// ** MySQL 设置 - 具体信息来自您正在使用的主机 ** //\n/** WordPress数据库的名称 */\ndefine('DB_NAME', 'wordpress');\n\n/** MySQL数据库用户名 */\ndefine('DB_USER', 'oldboy');\n\n/** MySQL数据库密码 */\ndefine('DB_PASSWORD', 'Bgx123.com');\n\n/** MySQL主机 */\ndefine('DB_HOST', '172.16.1.51');\n```\n\n5、拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息\n\n```shell\n\t[root@web01 zh]# grep -R \"Bgx123.com\" *\n\t\tsystem/config/database.php:  'password' => 'Bgx123.com',\n\t[root@web01 zh]# vim /code/zh/system/config/database.php \n\t\t$config['driver'] = 'MySQLi';^M\n\t\t$config['master'] = array (\n\t\t  'charset' => 'utf8',\n\t\t  'host' => '172.16.1.51',\n\t\t  'username' => 'oldboy',\n\t\t  'password' => 'Bgx123.com',\n\t\t  'dbname' => 'zh',\n\t\t);^M\n```\n\n6、拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息\n\n```shell\n[root@web01 edusoho]# vim /code/edusoho/app/config/parameters.yml\ndatabase_driver: pdo_mysql\ndatabase_host: 172.16.1.51\ndatabase_port: 3306\ndatabase_name: edusoho\ndatabase_user: oldboy\ndatabase_password: 'Bgx123.com'\n\n必须清理缓存\n[root@web01 edusoho]# rm -rf /code/edusoho/app/cache/*\n```\n\n## 二、扩展多台web服务器\n\n```shell\n1.统一环境\n    0）准备对应的www用户\n    [root@web02 ~]# groupadd -g666 www\n    [root@web02 ~]# useradd -u666 -g666 www\n\n    1）拷贝web01上面的yum仓库\n    [root@web02 ~]# scp root@172.16.1.7:/etc/yum.repos.d/*.repo /etc/yum.repos.d/\n\n    2）安装nginx和php\n    [root@web02 ~]# yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n\n2.统一配置（同步web01上面的配置到web02）\n    1）同步nginx\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:/etc/nginx/ /etc/nginx/\n    [root@web02 ~]# nginx -t\n    [root@web02 ~]# systemctl enable nginx\n    [root@web02 ~]# systemctl start nginx\n\n    2）同步php（/etc/php-fpm.conf /etc/php-fpm.d  /etc/php.ini）\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:/etc/php* /etc/\n    [root@web02 ~]# systemctl enable php-fpm\n    [root@web02 ~]# systemctl start php-fpm\n\n3.统一代码\n    [root@web01 ~]# tar czf code.tar.gz /code\t\t\t\t#在web01上打包站点\n    [root@web01 ~]# scp code.tar.gz root@172.16.1.8:/tmp\t#在web01上将打包好的代码发送给web02\n    [root@web02 ~]# tar xf /tmp/code.tar.gz -C /\t\t\t#在web02上进行解压，并解压到/目录下\n\n4.配置解析，进行访问\n```\n\n## 三、NFS共享多台web的静态资源\n\n```shell\n1.准备172.16.1.31共享存储服务器，规划目录，配置好权限\n    0）创建用户\n    [root@nfs ~]# groupadd -g666 www\n    [root@nfs ~]# useradd -u666 -g666 www\t\n\n    1）安装\n    [root@nfs ~]# yum install nfs-utils -y\n\n    2）配置\n    [root@nfs ~]# cat /etc/exports\n    /data/blog 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n    /data/zh 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n    /data/edu 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)\n\n    3）根据配置，创建目录，准备用户，授权等等\n    [root@nfs ~]# rm -rf /data/\n    [root@nfs ~]# mkdir /data/{blog,zh,edu} -p\n    [root@nfs ~]# chown -R www.www /data/\n\n    4）启动\n    [root@nfs ~]# systemctl enable nfs-utils \n    [root@nfs ~]# systemctl restart nfs-utils\n\n2.将图片较多的web02服务器，推送到nfs共享存储上\n    http://blog.oldboy.com/wp-content/uploads/2019/01/timg.jpg\n\n    [root@web02 ~]# cd /code/wordpress/wp-content\n    [root@web02 wp-content]# scp -r uploads/* root@172.16.1.31:/data/blog/\n\n    注意：需要上nfs服务器上进行重新的递归授权，否则会出现无法上传文件的错误\n    [root@nfs ~]# chown -R www.www /data/\n\n3.web01和web02分别都进行挂载，此时图片进行实现了共享\n    mount -t nfs 172.16.1.31:/data/blog  /code/wordpress/wp-content/uploads/\n```\n\n","slug":"01_运维/02-综合架构/10-Nginx(四)LNMP架构拆分","published":1,"updated":"2022-07-06T07:16:31.962Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0j0010a8v79uo0bcrt","content":"<h2 id=\"一、拆分数据库\"><a href=\"#一、拆分数据库\" class=\"headerlink\" title=\"一、拆分数据库\"></a>一、拆分数据库</h2><blockquote>\n<p>为什么要拆分数据库?</p>\n<p>mysql内存占用大，容易引起网页访问速度变慢，甚至oom(out of memory)被系统自动kill掉，不安全</p>\n</blockquote>\n<h3 id=\"1-2-环境准备\"><a href=\"#1-2-环境准备\" class=\"headerlink\" title=\"1.2 环境准备\"></a>1.2 环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx+php</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td></td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-2-拆分过程\"><a href=\"#1-2-拆分过程\" class=\"headerlink\" title=\"1.2 拆分过程\"></a>1.2 拆分过程</h3><p>1、备份172.16.1.7服务器上mysql的数据</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# mysqldump -uroot -p&#39;Bgx123.com&#39; --all-databases --single-transaction &gt; mysql-all.sql<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、传输172.16.1.7的备份数据至172.16.1.51的服务器上</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# scp mysql-all.sql root@172.16.1.51:&#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、需要先在172.16.1.51服务器上安装mysql服务，然后使用mysql命令进行还原。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# yum install mariadb-server mariadb -y\n[root@db01 ~]# systemctl enable mariadb\n[root@db01 ~]# systemctl start mariadb\n[root@db01 ~]# mysql &lt;&#x2F;tmp&#x2F;mysql-all.sql\n[root@db01 ~]# systemctl restart mariadb\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| edusoho            |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n7 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、将web程序连接的本地数据库修改到远程数据库上。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1）先在本地172.16.1.7服务器上停止本地的数据库\n[root@web01 ~]# systemctl disable mariadb\n[root@web01 ~]# systemctl stop mariadb\n\n2）在172.16.1.51的服务器上授权远程主机能够能连接mysql数据库\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; grant all privileges on *.* to oldboy@&#39;%&#39; identified by &#39;Bgx123.com&#39;;\n解释：\n*.*: 所有数据库下的所有表\noldboy@&#39;%&#39;: 允许所有网段的oldboy用户访问\nidentify: 设置密码\n\n3）在172.16.1.7服务器上测试远程账户能否连接172.16.1.51的数据库\n[root@web01 wordpress]# yum install mariadb -y\n[root@web01 wordpress]# mysql -h 172.16.1.51 -uoldboy -pBgx123.com\nMariaDB [(none)]&gt; \n\n4）在172.16.1.7服务器上修改web程序连接数据库的配置文件\n[root@web01 wordpress]# vim &#x2F;code&#x2F;wordpress&#x2F;wp-config.php\n&#x2F;&#x2F; ** MySQL 设置 - 具体信息来自您正在使用的主机 ** &#x2F;&#x2F;\n&#x2F;** WordPress数据库的名称 *&#x2F;\ndefine(&#39;DB_NAME&#39;, &#39;wordpress&#39;);\n\n&#x2F;** MySQL数据库用户名 *&#x2F;\ndefine(&#39;DB_USER&#39;, &#39;oldboy&#39;);\n\n&#x2F;** MySQL数据库密码 *&#x2F;\ndefine(&#39;DB_PASSWORD&#39;, &#39;Bgx123.com&#39;);\n\n&#x2F;** MySQL主机 *&#x2F;\ndefine(&#39;DB_HOST&#39;, &#39;172.16.1.51&#39;);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 zh]# grep -R &quot;Bgx123.com&quot; *\n\tsystem&#x2F;config&#x2F;database.php:  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,\n[root@web01 zh]# vim &#x2F;code&#x2F;zh&#x2F;system&#x2F;config&#x2F;database.php \n\t$config[&#39;driver&#39;] &#x3D; &#39;MySQLi&#39;;^M\n\t$config[&#39;master&#39;] &#x3D; array (\n\t  &#39;charset&#39; &#x3D;&gt; &#39;utf8&#39;,\n\t  &#39;host&#39; &#x3D;&gt; &#39;172.16.1.51&#39;,\n\t  &#39;username&#39; &#x3D;&gt; &#39;oldboy&#39;,\n\t  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,\n\t  &#39;dbname&#39; &#x3D;&gt; &#39;zh&#39;,\n\t);^M<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>6、拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 edusoho]# vim &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;config&#x2F;parameters.yml\ndatabase_driver: pdo_mysql\ndatabase_host: 172.16.1.51\ndatabase_port: 3306\ndatabase_name: edusoho\ndatabase_user: oldboy\ndatabase_password: &#39;Bgx123.com&#39;\n\n必须清理缓存\n[root@web01 edusoho]# rm -rf &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;cache&#x2F;*<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、扩展多台web服务器\"><a href=\"#二、扩展多台web服务器\" class=\"headerlink\" title=\"二、扩展多台web服务器\"></a>二、扩展多台web服务器</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.统一环境\n    0）准备对应的www用户\n    [root@web02 ~]# groupadd -g666 www\n    [root@web02 ~]# useradd -u666 -g666 www\n\n    1）拷贝web01上面的yum仓库\n    [root@web02 ~]# scp root@172.16.1.7:&#x2F;etc&#x2F;yum.repos.d&#x2F;*.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;\n\n    2）安装nginx和php\n    [root@web02 ~]# yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n\n2.统一配置（同步web01上面的配置到web02）\n    1）同步nginx\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;nginx&#x2F; &#x2F;etc&#x2F;nginx&#x2F;\n    [root@web02 ~]# nginx -t\n    [root@web02 ~]# systemctl enable nginx\n    [root@web02 ~]# systemctl start nginx\n\n    2）同步php（&#x2F;etc&#x2F;php-fpm.conf &#x2F;etc&#x2F;php-fpm.d  &#x2F;etc&#x2F;php.ini）\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;php* &#x2F;etc&#x2F;\n    [root@web02 ~]# systemctl enable php-fpm\n    [root@web02 ~]# systemctl start php-fpm\n\n3.统一代码\n    [root@web01 ~]# tar czf code.tar.gz &#x2F;code\t\t\t\t#在web01上打包站点\n    [root@web01 ~]# scp code.tar.gz root@172.16.1.8:&#x2F;tmp\t#在web01上将打包好的代码发送给web02\n    [root@web02 ~]# tar xf &#x2F;tmp&#x2F;code.tar.gz -C &#x2F;\t\t\t#在web02上进行解压，并解压到&#x2F;目录下\n\n4.配置解析，进行访问<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、NFS共享多台web的静态资源\"><a href=\"#三、NFS共享多台web的静态资源\" class=\"headerlink\" title=\"三、NFS共享多台web的静态资源\"></a>三、NFS共享多台web的静态资源</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.准备172.16.1.31共享存储服务器，规划目录，配置好权限\n    0）创建用户\n    [root@nfs ~]# groupadd -g666 www\n    [root@nfs ~]# useradd -u666 -g666 www\t\n\n    1）安装\n    [root@nfs ~]# yum install nfs-utils -y\n\n    2）配置\n    [root@nfs ~]# cat &#x2F;etc&#x2F;exports\n    &#x2F;data&#x2F;blog 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n    &#x2F;data&#x2F;zh 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n    &#x2F;data&#x2F;edu 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\n    3）根据配置，创建目录，准备用户，授权等等\n    [root@nfs ~]# rm -rf &#x2F;data&#x2F;\n    [root@nfs ~]# mkdir &#x2F;data&#x2F;&#123;blog,zh,edu&#125; -p\n    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n\n    4）启动\n    [root@nfs ~]# systemctl enable nfs-utils \n    [root@nfs ~]# systemctl restart nfs-utils\n\n2.将图片较多的web02服务器，推送到nfs共享存储上\n    http:&#x2F;&#x2F;blog.oldboy.com&#x2F;wp-content&#x2F;uploads&#x2F;2019&#x2F;01&#x2F;timg.jpg\n\n    [root@web02 ~]# cd &#x2F;code&#x2F;wordpress&#x2F;wp-content\n    [root@web02 wp-content]# scp -r uploads&#x2F;* root@172.16.1.31:&#x2F;data&#x2F;blog&#x2F;\n\n    注意：需要上nfs服务器上进行重新的递归授权，否则会出现无法上传文件的错误\n    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n\n3.web01和web02分别都进行挂载，此时图片进行实现了共享\n    mount -t nfs 172.16.1.31:&#x2F;data&#x2F;blog  &#x2F;code&#x2F;wordpress&#x2F;wp-content&#x2F;uploads&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、拆分数据库\"><a href=\"#一、拆分数据库\" class=\"headerlink\" title=\"一、拆分数据库\"></a>一、拆分数据库</h2><blockquote>\n<p>为什么要拆分数据库?</p>\n<p>mysql内存占用大，容易引起网页访问速度变慢，甚至oom(out of memory)被系统自动kill掉，不安全</p>\n</blockquote>\n<h3 id=\"1-2-环境准备\"><a href=\"#1-2-环境准备\" class=\"headerlink\" title=\"1.2 环境准备\"></a>1.2 环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx+php</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td></td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-2-拆分过程\"><a href=\"#1-2-拆分过程\" class=\"headerlink\" title=\"1.2 拆分过程\"></a>1.2 拆分过程</h3><p>1、备份172.16.1.7服务器上mysql的数据</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# mysqldump -uroot -p&#39;Bgx123.com&#39; --all-databases --single-transaction &gt; mysql-all.sql<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、传输172.16.1.7的备份数据至172.16.1.51的服务器上</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# scp mysql-all.sql root@172.16.1.51:&#x2F;tmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、需要先在172.16.1.51服务器上安装mysql服务，然后使用mysql命令进行还原。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# yum install mariadb-server mariadb -y\n[root@db01 ~]# systemctl enable mariadb\n[root@db01 ~]# systemctl start mariadb\n[root@db01 ~]# mysql &lt;&#x2F;tmp&#x2F;mysql-all.sql\n[root@db01 ~]# systemctl restart mariadb\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; show databases;\n+--------------------+\n| Database           |\n+--------------------+\n| information_schema |\n| edusoho            |\n| mysql              |\n| performance_schema |\n| test               |\n| wordpress          |\n| zh                 |\n+--------------------+\n7 rows in set (0.00 sec)<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、将web程序连接的本地数据库修改到远程数据库上。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1）先在本地172.16.1.7服务器上停止本地的数据库\n[root@web01 ~]# systemctl disable mariadb\n[root@web01 ~]# systemctl stop mariadb\n\n2）在172.16.1.51的服务器上授权远程主机能够能连接mysql数据库\n[root@db01 ~]# mysql -uroot -pBgx123.com\nMariaDB [(none)]&gt; grant all privileges on *.* to oldboy@&#39;%&#39; identified by &#39;Bgx123.com&#39;;\n解释：\n*.*: 所有数据库下的所有表\noldboy@&#39;%&#39;: 允许所有网段的oldboy用户访问\nidentify: 设置密码\n\n3）在172.16.1.7服务器上测试远程账户能否连接172.16.1.51的数据库\n[root@web01 wordpress]# yum install mariadb -y\n[root@web01 wordpress]# mysql -h 172.16.1.51 -uoldboy -pBgx123.com\nMariaDB [(none)]&gt; \n\n4）在172.16.1.7服务器上修改web程序连接数据库的配置文件\n[root@web01 wordpress]# vim &#x2F;code&#x2F;wordpress&#x2F;wp-config.php\n&#x2F;&#x2F; ** MySQL 设置 - 具体信息来自您正在使用的主机 ** &#x2F;&#x2F;\n&#x2F;** WordPress数据库的名称 *&#x2F;\ndefine(&#39;DB_NAME&#39;, &#39;wordpress&#39;);\n\n&#x2F;** MySQL数据库用户名 *&#x2F;\ndefine(&#39;DB_USER&#39;, &#39;oldboy&#39;);\n\n&#x2F;** MySQL数据库密码 *&#x2F;\ndefine(&#39;DB_PASSWORD&#39;, &#39;Bgx123.com&#39;);\n\n&#x2F;** MySQL主机 *&#x2F;\ndefine(&#39;DB_HOST&#39;, &#39;172.16.1.51&#39;);<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>5、拆分172.16.1.7wecenter连接远程172.16.1.51数据库信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 zh]# grep -R &quot;Bgx123.com&quot; *\n\tsystem&#x2F;config&#x2F;database.php:  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,\n[root@web01 zh]# vim &#x2F;code&#x2F;zh&#x2F;system&#x2F;config&#x2F;database.php \n\t$config[&#39;driver&#39;] &#x3D; &#39;MySQLi&#39;;^M\n\t$config[&#39;master&#39;] &#x3D; array (\n\t  &#39;charset&#39; &#x3D;&gt; &#39;utf8&#39;,\n\t  &#39;host&#39; &#x3D;&gt; &#39;172.16.1.51&#39;,\n\t  &#39;username&#39; &#x3D;&gt; &#39;oldboy&#39;,\n\t  &#39;password&#39; &#x3D;&gt; &#39;Bgx123.com&#39;,\n\t  &#39;dbname&#39; &#x3D;&gt; &#39;zh&#39;,\n\t);^M<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>6、拆分172.16.1.7 edusoho连接远程172.16.1.51数据库信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 edusoho]# vim &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;config&#x2F;parameters.yml\ndatabase_driver: pdo_mysql\ndatabase_host: 172.16.1.51\ndatabase_port: 3306\ndatabase_name: edusoho\ndatabase_user: oldboy\ndatabase_password: &#39;Bgx123.com&#39;\n\n必须清理缓存\n[root@web01 edusoho]# rm -rf &#x2F;code&#x2F;edusoho&#x2F;app&#x2F;cache&#x2F;*<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、扩展多台web服务器\"><a href=\"#二、扩展多台web服务器\" class=\"headerlink\" title=\"二、扩展多台web服务器\"></a>二、扩展多台web服务器</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.统一环境\n    0）准备对应的www用户\n    [root@web02 ~]# groupadd -g666 www\n    [root@web02 ~]# useradd -u666 -g666 www\n\n    1）拷贝web01上面的yum仓库\n    [root@web02 ~]# scp root@172.16.1.7:&#x2F;etc&#x2F;yum.repos.d&#x2F;*.repo &#x2F;etc&#x2F;yum.repos.d&#x2F;\n\n    2）安装nginx和php\n    [root@web02 ~]# yum -y install nginx php71w php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb\n\n2.统一配置（同步web01上面的配置到web02）\n    1）同步nginx\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;nginx&#x2F; &#x2F;etc&#x2F;nginx&#x2F;\n    [root@web02 ~]# nginx -t\n    [root@web02 ~]# systemctl enable nginx\n    [root@web02 ~]# systemctl start nginx\n\n    2）同步php（&#x2F;etc&#x2F;php-fpm.conf &#x2F;etc&#x2F;php-fpm.d  &#x2F;etc&#x2F;php.ini）\n    [root@web02 ~]# rsync  -avz --delete root@172.16.1.7:&#x2F;etc&#x2F;php* &#x2F;etc&#x2F;\n    [root@web02 ~]# systemctl enable php-fpm\n    [root@web02 ~]# systemctl start php-fpm\n\n3.统一代码\n    [root@web01 ~]# tar czf code.tar.gz &#x2F;code\t\t\t\t#在web01上打包站点\n    [root@web01 ~]# scp code.tar.gz root@172.16.1.8:&#x2F;tmp\t#在web01上将打包好的代码发送给web02\n    [root@web02 ~]# tar xf &#x2F;tmp&#x2F;code.tar.gz -C &#x2F;\t\t\t#在web02上进行解压，并解压到&#x2F;目录下\n\n4.配置解析，进行访问<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、NFS共享多台web的静态资源\"><a href=\"#三、NFS共享多台web的静态资源\" class=\"headerlink\" title=\"三、NFS共享多台web的静态资源\"></a>三、NFS共享多台web的静态资源</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1.准备172.16.1.31共享存储服务器，规划目录，配置好权限\n    0）创建用户\n    [root@nfs ~]# groupadd -g666 www\n    [root@nfs ~]# useradd -u666 -g666 www\t\n\n    1）安装\n    [root@nfs ~]# yum install nfs-utils -y\n\n    2）配置\n    [root@nfs ~]# cat &#x2F;etc&#x2F;exports\n    &#x2F;data&#x2F;blog 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n    &#x2F;data&#x2F;zh 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n    &#x2F;data&#x2F;edu 172.16.1.0&#x2F;24(rw,sync,all_squash,anonuid&#x3D;666,anongid&#x3D;666)\n\n    3）根据配置，创建目录，准备用户，授权等等\n    [root@nfs ~]# rm -rf &#x2F;data&#x2F;\n    [root@nfs ~]# mkdir &#x2F;data&#x2F;&#123;blog,zh,edu&#125; -p\n    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n\n    4）启动\n    [root@nfs ~]# systemctl enable nfs-utils \n    [root@nfs ~]# systemctl restart nfs-utils\n\n2.将图片较多的web02服务器，推送到nfs共享存储上\n    http:&#x2F;&#x2F;blog.oldboy.com&#x2F;wp-content&#x2F;uploads&#x2F;2019&#x2F;01&#x2F;timg.jpg\n\n    [root@web02 ~]# cd &#x2F;code&#x2F;wordpress&#x2F;wp-content\n    [root@web02 wp-content]# scp -r uploads&#x2F;* root@172.16.1.31:&#x2F;data&#x2F;blog&#x2F;\n\n    注意：需要上nfs服务器上进行重新的递归授权，否则会出现无法上传文件的错误\n    [root@nfs ~]# chown -R www.www &#x2F;data&#x2F;\n\n3.web01和web02分别都进行挂载，此时图片进行实现了共享\n    mount -t nfs 172.16.1.31:&#x2F;data&#x2F;blog  &#x2F;code&#x2F;wordpress&#x2F;wp-content&#x2F;uploads&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之综合架构--07--Nginx(七)均衡调度","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、Nginx均衡调度算法\n\nNginx七层负载均衡分为5种调度算法\n\n| 调度算法          | 概述                                                         |\n| ----------------- | ------------------------------------------------------------ |\n| 轮询（常用）      | 按时间顺序逐一分配到不同的后端服务器(默认)                   |\n| weight（面试点）  | 加权轮询,weight值越大,分配到的访问几率越高                   |\n| ip_hash（面试点） | 每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器 |\n| url_hash          | 按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器 |\n| least_hash        | 最少链接数,那个机器链接数少就分发                            |\n\n### 1.1 加权轮询\n\n比如实现访问5次web01，1次web02\n\n当web服务器配置不相同，有差距时，可以用此方法\n\n在`lb01`配置\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 weight=5;\n        server 172.16.1.8:80 weight=1;\n}\n\nserver {\n...\n```\n\n### 1.2 ip_hash\n\n>PS：不能与weight一起使用\n\n根据请求的IP地址，固定访问到某一后端，除非已选择的后端down了，有点浪费资源\n\n在`lb01`配置\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        ip_hash;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\n\nserver { \n...\n```\n\n## 二、Nginx负载均衡后端状态\n\n| 状态                     | 概述                                                       |\n| ------------------------ | ---------------------------------------------------------- |\n| down                     | 当前的server暂时不参与负载均衡                             |\n| backup                   | 预留的备份服务器                                           |\n| max_conns                | 限制最大的接收连接数                                       |\n| max_fails（健康检查）    | 允许请求失败的次数（不够精准，作用不大，得知道，面试会问） |\n| fail_timeout（健康检查） | 经过max_fails失败后, 服务暂停时间                          |\n\n### 2.1 down状态\n\n>一般用于停机维护\n\n在`lb01`配置，可见当两台web的Nginx服务都正常时，只能访问web02，当web02的Nginx服务挂了，返回502\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 down;\n        server 172.16.1.8:80;\n}\n\nserver {\n...\n```\n\n### 2.2 backup状态 \n\n在`lb01`配置，可见当两台web都正常时，只能访问web02，如果web02的服务挂了，会访问web01，当web02恢复后，再次访问到的是web02\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 backup;\n        server 172.16.1.8:80;\n}\n\nserver {\n...\n```\n\n### 2.3 健康检查\n\n>自带的健康检查不够精准，且看不到信息，面试会问\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 max_fails=2 fail_timeout=10s;\n        server 172.16.1.8:80 max_fails=2 fail_timeout=10s;\n}\n\nserver {\n...\n```\n\n## 三、第三方健康检查模块check_upstream\n\n>检测更精准，且有页面可以展示服务端的状态，需要编译安装\n\n### 3.1 编译安装Nginx\n\n1、安装依赖包\n\n```shell\n[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel  patch libxml2 -libxml2-devel libxslt libxslt-devel gd-devel perl-ExtUtils-Embed gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64\n```\n\n2、下载Nginx源码及第三方模块源码\n\n>PS：为保持一致，先通过yum源安装nginx，这是当前实验环境的Nginx版本\n>\n>[root@lb01 nginx]# nginx -version\n>nginx version: nginx/1.20.1\n\n```shell\n[root@lb02 ~]# wget http://nginx.org/download/nginx-1.20.1.tar.gz\n[root@lb02 ~]# wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip\n```\n\n3、解压nginx源码包以及第三方模块\n\n```shell\n[root@lb01 ~]# unzip master.zip\n[root@lb01 ~]# tar -vxf nginx-1.20.1.tar.gz\n```\n\n4、打补丁\n\n>打补丁(nginx的版本是1.20.1补丁就选择1.20.1的,p1代表在nginx目录，p0是不在nginx目录)\n\n```shell\n[root@lb01 nginx-1.20.1]# cd nginx-1.20.1/\n[root@lb01 nginx-1.20.1]# patch -p1 < ../nginx_upstream_check_module-master/check_1.20.1+.patch\n```\n\n5、编译Nginx，附带模块参数\n\n>通过nginx -V获取configure参数，尽量保持一致\n\n--add-module=/root/nginx_upstream_check_module-master\n\n```shell\n[root@lb01 nginx-1.20.1]# ./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --add-module=/root/nginx_upstream_check_module-master\n```\n\n6、在已有的负载均衡上增加健康检查的功能\n\n```shell\n[root@lb01 nginx-1.20.1]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n        check interval=3000 rise=2 fall=3 timeout=1000 type=tcp;\n}\n```\n\n### 3.2 功能测试\n\n1、正常情况下的检测数据\n\n![image-20210821113447825](/img/image-20210821113447825.png)\n\n2、测试将web01的nginx服务关掉\n\n![image-20210821114011230](/img/image-20210821114011230.png)\n\n3、日志分析\n\n```shell\n[root@lb01 nginx-1.20.1]# tail -f /var/log/nginx/error.log\n# 两web服务正常，能获取peer\n2021/08/21 02:42:11 [error] 50522#50522: enable check peer: 172.16.1.8:80\n2021/08/21 02:42:12 [error] 50522#50522: enable check peer: 172.16.1.7:80\n2021/08/21 02:46:17 [error] 50522#50522: *13 connect() failed (111: Connection refused) while connecting to upstream, client: 10.0.0.1, server: node.oldboy.com, request: \"GET / HTTP/1.1\", upstream: \"http://172.16.1.7:80/\", host: \"node.oldboy.com\"\n# 停止web01的nginx服务\n2021/08/21 02:46:20 [error] 50522#50522: disable check peer: 172.16.1.7:80\n# 重新启动web01的nginx服务\n2021/08/21 02:47:59 [error] 50522#50522: enable check peer: 172.16.1.7:80\n```\n\n## 四、如何解决网站重复登录的问题\n\n有三种方法解决：\n\n1. ip_hash -- 会造成某一台主机的压力过大\n2. session复制\n3. session共享\n   1. 本地文件 --> nfs共享\n   2. 通过程序，写入redis数据库（常用）\n   3. 通过程序，写入mysql数据库\n\n本案例，选用3.2配置，session共享，写入redis数据库\n\n### 4.1 安装phpmyadmin重现问题\n\n`web01`和`web02`都需要安装\n\n1、配置Nginx\n\n```shell\n[root@web01 conf.d]# cat php.conf\nserver {\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot /code/phpMyAdmin-4.8.4-all-languages;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n2、安装phpmyadmin\n\n```shell\n[root@web01 conf.d]# cd /code\n[root@web01 code]# wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip\n[root@web01 code]# unzip phpMyAdmin-4.8.4-all-languages.zip\n```\n\n3、配置phpmyadmin连接远程数据库\n\n```shell\n[root@web01 code]# cd phpMyAdmin-4.8.4-all-languages/\n[root@web01 phpMyAdmin-4.8.4-all-languages]# cp config.sample.inc.php config.inc.php\n[root@web01 phpMyAdmin-4.8.4-all-languages]# vim config.inc.php\n/* Server parameters */\n$cfg['Servers'][$i]['host'] = '172.16.1.51';\n```\n\n4、配置授权\n\n>这个文件夹中会记录session，需要权限\n>\n>session_start(): Failed to read session data: files (path: /var/lib/php/session)\n\n```shell\n[root@web01 conf.d]# chown -R www.www /var/lib/php/\n```\n\n5、将web01上配置好的phpmyadmin以及nginx的配置文件推送到web02主机上\n\n```shell\n[root@web01 code]# scp -rp  phpMyAdmin-4.8.4-all-languages root@172.16.1.8:/code/\n[root@web01 code]# scp /etc/nginx/conf.d/php.conf  root@172.16.1.8:/etc/nginx/conf.d/\n```\n\n6、重载Nginx服务，授权访问权限\n\n```shell\n[root@web02 code]# systemctl restart nginx\n[root@web02 code]# chown -R www.www /var/lib/php/\n```\n\n7、接入负载均衡，并重启nginx服务，`lb01`操作\n\n```shell\n[root@lb01 conf.d]# vim proxy_php.com.conf \nupstream php {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\nserver {\n        listen 80;\n        server_name php.oldboy.com;\n        location / {\n                proxy_pass http://php;\n                include proxy_params;\n        }\n}\n\n[root@lb01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lb01 conf.d]# systemctl restart nginx\n```\n\n9、测试访问\n\n```shell\n网页访问：\n\thttp://php.oldboy.com\n登录账户:\n\t采用db01（172.16.1.51）的mysql远程账户oldboy/Bgx123.com\n此时访问phpmyadmin登录将一直失败，因为轮询访问，session一直变：\n报错：\nFailed to set session cookie. Maybe you are using HTTP instead of HTTPS to access phpMyAdmin.\n```\n\n### 4.2 解决问题\n\n1、在`db01`安装redis数据库\n\n```shell\n[root@db01 ~]# yum install redis -y\n```\n\n2、配置并启动redis\n\n```shell\n[root@db01 ~]# sed  -i '/^bind/c bind 127.0.0.1 172.16.1.51' /etc/redis.conf\n[root@db01 ~]# systemctl start redis\n[root@db01 ~]# systemctl enable redis\n```\n\n3、`web01`的php配置session连接redis\n\n```shell\n#1.修改/etc/php.ini文件\n[root@web01 ~]# vim /etc/php.ini\nsession.save_handler = redis\nsession.save_path = \"tcp://172.16.1.51:6379\"\n;session.save_path = \"tcp://172.16.1.51:6379?auth=123\" #如果redis存在密码，则使用该方式\nsession.auto_start = 1\n```\n\n4、注释php-fpm.d/www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中\n\n```she\n;php_value[session.save_handler] = files\n;php_value[session.save_path]    = /var/lib/php/session\n```\n\n5、重启php-fpm\n\n```shell\n[root@web02 code]# systemctl restart php-fpm\n```\n\n6、将`web01`的配置文件推送到`web02`上\n\n```she\n[root@web01 code]# scp /etc/php.ini root@172.16.1.8:/etc/php.ini  \n[root@web01 code]# scp /etc/php-fpm.d/www.conf root@172.16.1.8:/etc/php-fpm.d/www.conf \n```\n\n7、重启服务\n\n```she\n[root@web02 code]# systemctl restart php-fpm\n```\n\n8、再次测试访问网站\n\n可以登录，并且session的值将记录到redis数据库\n\n```shell\n[root@db01 ~]# redis-cli -h 172.16.1.51\n172.16.1.51:6379> KEYS *\n1) \"PHPREDIS_SESSION:716e61cabeb40f974fcbcdcac65f8607\"\n2) \"PHPREDIS_SESSION:42ca5a8ea9375a93a7974427b77b3dd7\"\n172.16.1.51:6379>\n```\n\n9、刷新页面的负载均衡效果展示\n\n![image-20210823225246243](/img/image-20210823225246243.png)\n\n![image-20210823225305632](/img/image-20210823225305632.png)\n\n10、cookie保存到redis展示\n\n![image-20210823225412626](/img/image-20210823225412626.png)\n","source":"_posts/01_运维/02-综合架构/13-Nginx(七)Nginx七层负载均衡调度与健康检查.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(七)均衡调度\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、Nginx均衡调度算法\n\nNginx七层负载均衡分为5种调度算法\n\n| 调度算法          | 概述                                                         |\n| ----------------- | ------------------------------------------------------------ |\n| 轮询（常用）      | 按时间顺序逐一分配到不同的后端服务器(默认)                   |\n| weight（面试点）  | 加权轮询,weight值越大,分配到的访问几率越高                   |\n| ip_hash（面试点） | 每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器 |\n| url_hash          | 按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器 |\n| least_hash        | 最少链接数,那个机器链接数少就分发                            |\n\n### 1.1 加权轮询\n\n比如实现访问5次web01，1次web02\n\n当web服务器配置不相同，有差距时，可以用此方法\n\n在`lb01`配置\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 weight=5;\n        server 172.16.1.8:80 weight=1;\n}\n\nserver {\n...\n```\n\n### 1.2 ip_hash\n\n>PS：不能与weight一起使用\n\n根据请求的IP地址，固定访问到某一后端，除非已选择的后端down了，有点浪费资源\n\n在`lb01`配置\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        ip_hash;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\n\nserver { \n...\n```\n\n## 二、Nginx负载均衡后端状态\n\n| 状态                     | 概述                                                       |\n| ------------------------ | ---------------------------------------------------------- |\n| down                     | 当前的server暂时不参与负载均衡                             |\n| backup                   | 预留的备份服务器                                           |\n| max_conns                | 限制最大的接收连接数                                       |\n| max_fails（健康检查）    | 允许请求失败的次数（不够精准，作用不大，得知道，面试会问） |\n| fail_timeout（健康检查） | 经过max_fails失败后, 服务暂停时间                          |\n\n### 2.1 down状态\n\n>一般用于停机维护\n\n在`lb01`配置，可见当两台web的Nginx服务都正常时，只能访问web02，当web02的Nginx服务挂了，返回502\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 down;\n        server 172.16.1.8:80;\n}\n\nserver {\n...\n```\n\n### 2.2 backup状态 \n\n在`lb01`配置，可见当两台web都正常时，只能访问web02，如果web02的服务挂了，会访问web01，当web02恢复后，再次访问到的是web02\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 backup;\n        server 172.16.1.8:80;\n}\n\nserver {\n...\n```\n\n### 2.3 健康检查\n\n>自带的健康检查不够精准，且看不到信息，面试会问\n\n```shell\n[root@lb01 nginx]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80 max_fails=2 fail_timeout=10s;\n        server 172.16.1.8:80 max_fails=2 fail_timeout=10s;\n}\n\nserver {\n...\n```\n\n## 三、第三方健康检查模块check_upstream\n\n>检测更精准，且有页面可以展示服务端的状态，需要编译安装\n\n### 3.1 编译安装Nginx\n\n1、安装依赖包\n\n```shell\n[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel  patch libxml2 -libxml2-devel libxslt libxslt-devel gd-devel perl-ExtUtils-Embed gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64\n```\n\n2、下载Nginx源码及第三方模块源码\n\n>PS：为保持一致，先通过yum源安装nginx，这是当前实验环境的Nginx版本\n>\n>[root@lb01 nginx]# nginx -version\n>nginx version: nginx/1.20.1\n\n```shell\n[root@lb02 ~]# wget http://nginx.org/download/nginx-1.20.1.tar.gz\n[root@lb02 ~]# wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/master.zip\n```\n\n3、解压nginx源码包以及第三方模块\n\n```shell\n[root@lb01 ~]# unzip master.zip\n[root@lb01 ~]# tar -vxf nginx-1.20.1.tar.gz\n```\n\n4、打补丁\n\n>打补丁(nginx的版本是1.20.1补丁就选择1.20.1的,p1代表在nginx目录，p0是不在nginx目录)\n\n```shell\n[root@lb01 nginx-1.20.1]# cd nginx-1.20.1/\n[root@lb01 nginx-1.20.1]# patch -p1 < ../nginx_upstream_check_module-master/check_1.20.1+.patch\n```\n\n5、编译Nginx，附带模块参数\n\n>通过nginx -V获取configure参数，尽量保持一致\n\n--add-module=/root/nginx_upstream_check_module-master\n\n```shell\n[root@lb01 nginx-1.20.1]# ./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --add-module=/root/nginx_upstream_check_module-master\n```\n\n6、在已有的负载均衡上增加健康检查的功能\n\n```shell\n[root@lb01 nginx-1.20.1]# cat /etc/nginx/conf.d/proxy_node.conf\nupstream node {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n        check interval=3000 rise=2 fall=3 timeout=1000 type=tcp;\n}\n```\n\n### 3.2 功能测试\n\n1、正常情况下的检测数据\n\n![image-20210821113447825](/img/image-20210821113447825.png)\n\n2、测试将web01的nginx服务关掉\n\n![image-20210821114011230](/img/image-20210821114011230.png)\n\n3、日志分析\n\n```shell\n[root@lb01 nginx-1.20.1]# tail -f /var/log/nginx/error.log\n# 两web服务正常，能获取peer\n2021/08/21 02:42:11 [error] 50522#50522: enable check peer: 172.16.1.8:80\n2021/08/21 02:42:12 [error] 50522#50522: enable check peer: 172.16.1.7:80\n2021/08/21 02:46:17 [error] 50522#50522: *13 connect() failed (111: Connection refused) while connecting to upstream, client: 10.0.0.1, server: node.oldboy.com, request: \"GET / HTTP/1.1\", upstream: \"http://172.16.1.7:80/\", host: \"node.oldboy.com\"\n# 停止web01的nginx服务\n2021/08/21 02:46:20 [error] 50522#50522: disable check peer: 172.16.1.7:80\n# 重新启动web01的nginx服务\n2021/08/21 02:47:59 [error] 50522#50522: enable check peer: 172.16.1.7:80\n```\n\n## 四、如何解决网站重复登录的问题\n\n有三种方法解决：\n\n1. ip_hash -- 会造成某一台主机的压力过大\n2. session复制\n3. session共享\n   1. 本地文件 --> nfs共享\n   2. 通过程序，写入redis数据库（常用）\n   3. 通过程序，写入mysql数据库\n\n本案例，选用3.2配置，session共享，写入redis数据库\n\n### 4.1 安装phpmyadmin重现问题\n\n`web01`和`web02`都需要安装\n\n1、配置Nginx\n\n```shell\n[root@web01 conf.d]# cat php.conf\nserver {\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot /code/phpMyAdmin-4.8.4-all-languages;\n\n\tlocation / {\n\t\tindex index.php index.html;\n\t}\n\n\tlocation ~ \\.php$ {\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t}\n}\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n2、安装phpmyadmin\n\n```shell\n[root@web01 conf.d]# cd /code\n[root@web01 code]# wget https://files.phpmyadmin.net/phpMyAdmin/4.8.4/phpMyAdmin-4.8.4-all-languages.zip\n[root@web01 code]# unzip phpMyAdmin-4.8.4-all-languages.zip\n```\n\n3、配置phpmyadmin连接远程数据库\n\n```shell\n[root@web01 code]# cd phpMyAdmin-4.8.4-all-languages/\n[root@web01 phpMyAdmin-4.8.4-all-languages]# cp config.sample.inc.php config.inc.php\n[root@web01 phpMyAdmin-4.8.4-all-languages]# vim config.inc.php\n/* Server parameters */\n$cfg['Servers'][$i]['host'] = '172.16.1.51';\n```\n\n4、配置授权\n\n>这个文件夹中会记录session，需要权限\n>\n>session_start(): Failed to read session data: files (path: /var/lib/php/session)\n\n```shell\n[root@web01 conf.d]# chown -R www.www /var/lib/php/\n```\n\n5、将web01上配置好的phpmyadmin以及nginx的配置文件推送到web02主机上\n\n```shell\n[root@web01 code]# scp -rp  phpMyAdmin-4.8.4-all-languages root@172.16.1.8:/code/\n[root@web01 code]# scp /etc/nginx/conf.d/php.conf  root@172.16.1.8:/etc/nginx/conf.d/\n```\n\n6、重载Nginx服务，授权访问权限\n\n```shell\n[root@web02 code]# systemctl restart nginx\n[root@web02 code]# chown -R www.www /var/lib/php/\n```\n\n7、接入负载均衡，并重启nginx服务，`lb01`操作\n\n```shell\n[root@lb01 conf.d]# vim proxy_php.com.conf \nupstream php {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\nserver {\n        listen 80;\n        server_name php.oldboy.com;\n        location / {\n                proxy_pass http://php;\n                include proxy_params;\n        }\n}\n\n[root@lb01 conf.d]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lb01 conf.d]# systemctl restart nginx\n```\n\n9、测试访问\n\n```shell\n网页访问：\n\thttp://php.oldboy.com\n登录账户:\n\t采用db01（172.16.1.51）的mysql远程账户oldboy/Bgx123.com\n此时访问phpmyadmin登录将一直失败，因为轮询访问，session一直变：\n报错：\nFailed to set session cookie. Maybe you are using HTTP instead of HTTPS to access phpMyAdmin.\n```\n\n### 4.2 解决问题\n\n1、在`db01`安装redis数据库\n\n```shell\n[root@db01 ~]# yum install redis -y\n```\n\n2、配置并启动redis\n\n```shell\n[root@db01 ~]# sed  -i '/^bind/c bind 127.0.0.1 172.16.1.51' /etc/redis.conf\n[root@db01 ~]# systemctl start redis\n[root@db01 ~]# systemctl enable redis\n```\n\n3、`web01`的php配置session连接redis\n\n```shell\n#1.修改/etc/php.ini文件\n[root@web01 ~]# vim /etc/php.ini\nsession.save_handler = redis\nsession.save_path = \"tcp://172.16.1.51:6379\"\n;session.save_path = \"tcp://172.16.1.51:6379?auth=123\" #如果redis存在密码，则使用该方式\nsession.auto_start = 1\n```\n\n4、注释php-fpm.d/www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中\n\n```she\n;php_value[session.save_handler] = files\n;php_value[session.save_path]    = /var/lib/php/session\n```\n\n5、重启php-fpm\n\n```shell\n[root@web02 code]# systemctl restart php-fpm\n```\n\n6、将`web01`的配置文件推送到`web02`上\n\n```she\n[root@web01 code]# scp /etc/php.ini root@172.16.1.8:/etc/php.ini  \n[root@web01 code]# scp /etc/php-fpm.d/www.conf root@172.16.1.8:/etc/php-fpm.d/www.conf \n```\n\n7、重启服务\n\n```she\n[root@web02 code]# systemctl restart php-fpm\n```\n\n8、再次测试访问网站\n\n可以登录，并且session的值将记录到redis数据库\n\n```shell\n[root@db01 ~]# redis-cli -h 172.16.1.51\n172.16.1.51:6379> KEYS *\n1) \"PHPREDIS_SESSION:716e61cabeb40f974fcbcdcac65f8607\"\n2) \"PHPREDIS_SESSION:42ca5a8ea9375a93a7974427b77b3dd7\"\n172.16.1.51:6379>\n```\n\n9、刷新页面的负载均衡效果展示\n\n![image-20210823225246243](/img/image-20210823225246243.png)\n\n![image-20210823225305632](/img/image-20210823225305632.png)\n\n10、cookie保存到redis展示\n\n![image-20210823225412626](/img/image-20210823225412626.png)\n","slug":"01_运维/02-综合架构/13-Nginx(七)Nginx七层负载均衡调度与健康检查","published":1,"updated":"2022-07-11T05:55:06.515Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0k0012a8v71cnehh41","content":"<h2 id=\"一、Nginx均衡调度算法\"><a href=\"#一、Nginx均衡调度算法\" class=\"headerlink\" title=\"一、Nginx均衡调度算法\"></a>一、Nginx均衡调度算法</h2><p>Nginx七层负载均衡分为5种调度算法</p>\n<table>\n<thead>\n<tr>\n<th>调度算法</th>\n<th>概述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>轮询（常用）</td>\n<td>按时间顺序逐一分配到不同的后端服务器(默认)</td>\n</tr>\n<tr>\n<td>weight（面试点）</td>\n<td>加权轮询,weight值越大,分配到的访问几率越高</td>\n</tr>\n<tr>\n<td>ip_hash（面试点）</td>\n<td>每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器</td>\n</tr>\n<tr>\n<td>url_hash</td>\n<td>按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器</td>\n</tr>\n<tr>\n<td>least_hash</td>\n<td>最少链接数,那个机器链接数少就分发</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-1-加权轮询\"><a href=\"#1-1-加权轮询\" class=\"headerlink\" title=\"1.1 加权轮询\"></a>1.1 加权轮询</h3><p>比如实现访问5次web01，1次web02</p>\n<p>当web服务器配置不相同，有差距时，可以用此方法</p>\n<p>在<code>lb01</code>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 weight&#x3D;5;\n        server 172.16.1.8:80 weight&#x3D;1;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-ip-hash\"><a href=\"#1-2-ip-hash\" class=\"headerlink\" title=\"1.2 ip_hash\"></a>1.2 ip_hash</h3><blockquote>\n<p>PS：不能与weight一起使用</p>\n</blockquote>\n<p>根据请求的IP地址，固定访问到某一后端，除非已选择的后端down了，有点浪费资源</p>\n<p>在<code>lb01</code>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        ip_hash;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123; \n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、Nginx负载均衡后端状态\"><a href=\"#二、Nginx负载均衡后端状态\" class=\"headerlink\" title=\"二、Nginx负载均衡后端状态\"></a>二、Nginx负载均衡后端状态</h2><table>\n<thead>\n<tr>\n<th>状态</th>\n<th>概述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>down</td>\n<td>当前的server暂时不参与负载均衡</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>预留的备份服务器</td>\n</tr>\n<tr>\n<td>max_conns</td>\n<td>限制最大的接收连接数</td>\n</tr>\n<tr>\n<td>max_fails（健康检查）</td>\n<td>允许请求失败的次数（不够精准，作用不大，得知道，面试会问）</td>\n</tr>\n<tr>\n<td>fail_timeout（健康检查）</td>\n<td>经过max_fails失败后, 服务暂停时间</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-1-down状态\"><a href=\"#2-1-down状态\" class=\"headerlink\" title=\"2.1 down状态\"></a>2.1 down状态</h3><blockquote>\n<p>一般用于停机维护</p>\n</blockquote>\n<p>在<code>lb01</code>配置，可见当两台web的Nginx服务都正常时，只能访问web02，当web02的Nginx服务挂了，返回502</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 down;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-backup状态\"><a href=\"#2-2-backup状态\" class=\"headerlink\" title=\"2.2 backup状态\"></a>2.2 backup状态</h3><p>在<code>lb01</code>配置，可见当两台web都正常时，只能访问web02，如果web02的服务挂了，会访问web01，当web02恢复后，再次访问到的是web02</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 backup;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-健康检查\"><a href=\"#2-3-健康检查\" class=\"headerlink\" title=\"2.3 健康检查\"></a>2.3 健康检查</h3><blockquote>\n<p>自带的健康检查不够精准，且看不到信息，面试会问</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 max_fails&#x3D;2 fail_timeout&#x3D;10s;\n        server 172.16.1.8:80 max_fails&#x3D;2 fail_timeout&#x3D;10s;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、第三方健康检查模块check-upstream\"><a href=\"#三、第三方健康检查模块check-upstream\" class=\"headerlink\" title=\"三、第三方健康检查模块check_upstream\"></a>三、第三方健康检查模块check_upstream</h2><blockquote>\n<p>检测更精准，且有页面可以展示服务端的状态，需要编译安装</p>\n</blockquote>\n<h3 id=\"3-1-编译安装Nginx\"><a href=\"#3-1-编译安装Nginx\" class=\"headerlink\" title=\"3.1 编译安装Nginx\"></a>3.1 编译安装Nginx</h3><p>1、安装依赖包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel  patch libxml2 -libxml2-devel libxslt libxslt-devel gd-devel perl-ExtUtils-Embed gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、下载Nginx源码及第三方模块源码</p>\n<blockquote>\n<p>PS：为保持一致，先通过yum源安装nginx，这是当前实验环境的Nginx版本</p>\n<p>[root@lb01 nginx]# nginx -version<br>nginx version: nginx&#x2F;1.20.1</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.20.1.tar.gz\n[root@lb02 ~]# wget https:&#x2F;&#x2F;github.com&#x2F;yaoweibin&#x2F;nginx_upstream_check_module&#x2F;archive&#x2F;master.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3、解压nginx源码包以及第三方模块</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 ~]# unzip master.zip\n[root@lb01 ~]# tar -vxf nginx-1.20.1.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>4、打补丁</p>\n<blockquote>\n<p>打补丁(nginx的版本是1.20.1补丁就选择1.20.1的,p1代表在nginx目录，p0是不在nginx目录)</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# cd nginx-1.20.1&#x2F;\n[root@lb01 nginx-1.20.1]# patch -p1 &lt; ..&#x2F;nginx_upstream_check_module-master&#x2F;check_1.20.1+.patch<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、编译Nginx，附带模块参数</p>\n<blockquote>\n<p>通过nginx -V获取configure参数，尽量保持一致</p>\n</blockquote>\n<p>–add-module&#x3D;&#x2F;root&#x2F;nginx_upstream_check_module-master</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --add-module&#x3D;&#x2F;root&#x2F;nginx_upstream_check_module-master<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、在已有的负载均衡上增加健康检查的功能</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n        check interval&#x3D;3000 rise&#x3D;2 fall&#x3D;3 timeout&#x3D;1000 type&#x3D;tcp;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-功能测试\"><a href=\"#3-2-功能测试\" class=\"headerlink\" title=\"3.2 功能测试\"></a>3.2 功能测试</h3><p>1、正常情况下的检测数据</p>\n<p><img src=\"/img/image-20210821113447825.png\" alt=\"image-20210821113447825\"></p>\n<p>2、测试将web01的nginx服务关掉</p>\n<p><img src=\"/img/image-20210821114011230.png\" alt=\"image-20210821114011230\"></p>\n<p>3、日志分析</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log\n# 两web服务正常，能获取peer\n2021&#x2F;08&#x2F;21 02:42:11 [error] 50522#50522: enable check peer: 172.16.1.8:80\n2021&#x2F;08&#x2F;21 02:42:12 [error] 50522#50522: enable check peer: 172.16.1.7:80\n2021&#x2F;08&#x2F;21 02:46:17 [error] 50522#50522: *13 connect() failed (111: Connection refused) while connecting to upstream, client: 10.0.0.1, server: node.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, upstream: &quot;http:&#x2F;&#x2F;172.16.1.7:80&#x2F;&quot;, host: &quot;node.oldboy.com&quot;\n# 停止web01的nginx服务\n2021&#x2F;08&#x2F;21 02:46:20 [error] 50522#50522: disable check peer: 172.16.1.7:80\n# 重新启动web01的nginx服务\n2021&#x2F;08&#x2F;21 02:47:59 [error] 50522#50522: enable check peer: 172.16.1.7:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、如何解决网站重复登录的问题\"><a href=\"#四、如何解决网站重复登录的问题\" class=\"headerlink\" title=\"四、如何解决网站重复登录的问题\"></a>四、如何解决网站重复登录的问题</h2><p>有三种方法解决：</p>\n<ol>\n<li>ip_hash – 会造成某一台主机的压力过大</li>\n<li>session复制</li>\n<li>session共享<ol>\n<li>本地文件 –&gt; nfs共享</li>\n<li>通过程序，写入redis数据库（常用）</li>\n<li>通过程序，写入mysql数据库</li>\n</ol>\n</li>\n</ol>\n<p>本案例，选用3.2配置，session共享，写入redis数据库</p>\n<h3 id=\"4-1-安装phpmyadmin重现问题\"><a href=\"#4-1-安装phpmyadmin重现问题\" class=\"headerlink\" title=\"4.1 安装phpmyadmin重现问题\"></a>4.1 安装phpmyadmin重现问题</h3><p><code>web01</code>和<code>web02</code>都需要安装</p>\n<p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat php.conf\nserver &#123;\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot &#x2F;code&#x2F;phpMyAdmin-4.8.4-all-languages;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、安装phpmyadmin</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cd &#x2F;code\n[root@web01 code]# wget https:&#x2F;&#x2F;files.phpmyadmin.net&#x2F;phpMyAdmin&#x2F;4.8.4&#x2F;phpMyAdmin-4.8.4-all-languages.zip\n[root@web01 code]# unzip phpMyAdmin-4.8.4-all-languages.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、配置phpmyadmin连接远程数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# cd phpMyAdmin-4.8.4-all-languages&#x2F;\n[root@web01 phpMyAdmin-4.8.4-all-languages]# cp config.sample.inc.php config.inc.php\n[root@web01 phpMyAdmin-4.8.4-all-languages]# vim config.inc.php\n&#x2F;* Server parameters *&#x2F;\n$cfg[&#39;Servers&#39;][$i][&#39;host&#39;] &#x3D; &#39;172.16.1.51&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、配置授权</p>\n<blockquote>\n<p>这个文件夹中会记录session，需要权限</p>\n<p>session_start(): Failed to read session data: files (path: &#x2F;var&#x2F;lib&#x2F;php&#x2F;session)</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# chown -R www.www &#x2F;var&#x2F;lib&#x2F;php&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>5、将web01上配置好的phpmyadmin以及nginx的配置文件推送到web02主机上</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# scp -rp  phpMyAdmin-4.8.4-all-languages root@172.16.1.8:&#x2F;code&#x2F;\n[root@web01 code]# scp &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;php.conf  root@172.16.1.8:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>6、重载Nginx服务，授权访问权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 code]# systemctl restart nginx\n[root@web02 code]# chown -R www.www &#x2F;var&#x2F;lib&#x2F;php&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>7、接入负载均衡，并重启nginx服务，<code>lb01</code>操作</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# vim proxy_php.com.conf \nupstream php &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\nserver &#123;\n        listen 80;\n        server_name php.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;php;\n                include proxy_params;\n        &#125;\n&#125;\n\n[root@lb01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@lb01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、测试访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">网页访问：\n\thttp:&#x2F;&#x2F;php.oldboy.com\n登录账户:\n\t采用db01（172.16.1.51）的mysql远程账户oldboy&#x2F;Bgx123.com\n此时访问phpmyadmin登录将一直失败，因为轮询访问，session一直变：\n报错：\nFailed to set session cookie. Maybe you are using HTTP instead of HTTPS to access phpMyAdmin.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-解决问题\"><a href=\"#4-2-解决问题\" class=\"headerlink\" title=\"4.2 解决问题\"></a>4.2 解决问题</h3><p>1、在<code>db01</code>安装redis数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# yum install redis -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、配置并启动redis</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# sed  -i &#39;&#x2F;^bind&#x2F;c bind 127.0.0.1 172.16.1.51&#39; &#x2F;etc&#x2F;redis.conf\n[root@db01 ~]# systemctl start redis\n[root@db01 ~]# systemctl enable redis<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、<code>web01</code>的php配置session连接redis</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#1.修改&#x2F;etc&#x2F;php.ini文件\n[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini\nsession.save_handler &#x3D; redis\nsession.save_path &#x3D; &quot;tcp:&#x2F;&#x2F;172.16.1.51:6379&quot;\n;session.save_path &#x3D; &quot;tcp:&#x2F;&#x2F;172.16.1.51:6379?auth&#x3D;123&quot; #如果redis存在密码，则使用该方式\nsession.auto_start &#x3D; 1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、注释php-fpm.d&#x2F;<a href=\"http://www.conf里面的两条内容,否则session内容会一直写入/var/lib/php/session%E7%9B%AE%E5%BD%95%E4%B8%AD\">www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中</a></p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">;php_value[session.save_handler] &#x3D; files\n;php_value[session.save_path]    &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;session<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、重启php-fpm</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、将<code>web01</code>的配置文件推送到<code>web02</code>上</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web01 code]# scp &#x2F;etc&#x2F;php.ini root@172.16.1.8:&#x2F;etc&#x2F;php.ini  \n[root@web01 code]# scp &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf root@172.16.1.8:&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>7、重启服务</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web02 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>8、再次测试访问网站</p>\n<p>可以登录，并且session的值将记录到redis数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# redis-cli -h 172.16.1.51\n172.16.1.51:6379&gt; KEYS *\n1) &quot;PHPREDIS_SESSION:716e61cabeb40f974fcbcdcac65f8607&quot;\n2) &quot;PHPREDIS_SESSION:42ca5a8ea9375a93a7974427b77b3dd7&quot;\n172.16.1.51:6379&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、刷新页面的负载均衡效果展示</p>\n<p><img src=\"/img/image-20210823225246243.png\" alt=\"image-20210823225246243\"></p>\n<p><img src=\"/img/image-20210823225305632.png\" alt=\"image-20210823225305632\"></p>\n<p>10、cookie保存到redis展示</p>\n<p><img src=\"/img/image-20210823225412626.png\" alt=\"image-20210823225412626\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Nginx均衡调度算法\"><a href=\"#一、Nginx均衡调度算法\" class=\"headerlink\" title=\"一、Nginx均衡调度算法\"></a>一、Nginx均衡调度算法</h2><p>Nginx七层负载均衡分为5种调度算法</p>\n<table>\n<thead>\n<tr>\n<th>调度算法</th>\n<th>概述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>轮询（常用）</td>\n<td>按时间顺序逐一分配到不同的后端服务器(默认)</td>\n</tr>\n<tr>\n<td>weight（面试点）</td>\n<td>加权轮询,weight值越大,分配到的访问几率越高</td>\n</tr>\n<tr>\n<td>ip_hash（面试点）</td>\n<td>每个请求按访问IP的hash结果分配,这样来自同一IP的固定访问一个后端服务器</td>\n</tr>\n<tr>\n<td>url_hash</td>\n<td>按照访问URL的hash结果来分配请求,是每个URL定向到同一个后端服务器</td>\n</tr>\n<tr>\n<td>least_hash</td>\n<td>最少链接数,那个机器链接数少就分发</td>\n</tr>\n</tbody></table>\n<h3 id=\"1-1-加权轮询\"><a href=\"#1-1-加权轮询\" class=\"headerlink\" title=\"1.1 加权轮询\"></a>1.1 加权轮询</h3><p>比如实现访问5次web01，1次web02</p>\n<p>当web服务器配置不相同，有差距时，可以用此方法</p>\n<p>在<code>lb01</code>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 weight&#x3D;5;\n        server 172.16.1.8:80 weight&#x3D;1;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-ip-hash\"><a href=\"#1-2-ip-hash\" class=\"headerlink\" title=\"1.2 ip_hash\"></a>1.2 ip_hash</h3><blockquote>\n<p>PS：不能与weight一起使用</p>\n</blockquote>\n<p>根据请求的IP地址，固定访问到某一后端，除非已选择的后端down了，有点浪费资源</p>\n<p>在<code>lb01</code>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        ip_hash;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123; \n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、Nginx负载均衡后端状态\"><a href=\"#二、Nginx负载均衡后端状态\" class=\"headerlink\" title=\"二、Nginx负载均衡后端状态\"></a>二、Nginx负载均衡后端状态</h2><table>\n<thead>\n<tr>\n<th>状态</th>\n<th>概述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>down</td>\n<td>当前的server暂时不参与负载均衡</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>预留的备份服务器</td>\n</tr>\n<tr>\n<td>max_conns</td>\n<td>限制最大的接收连接数</td>\n</tr>\n<tr>\n<td>max_fails（健康检查）</td>\n<td>允许请求失败的次数（不够精准，作用不大，得知道，面试会问）</td>\n</tr>\n<tr>\n<td>fail_timeout（健康检查）</td>\n<td>经过max_fails失败后, 服务暂停时间</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-1-down状态\"><a href=\"#2-1-down状态\" class=\"headerlink\" title=\"2.1 down状态\"></a>2.1 down状态</h3><blockquote>\n<p>一般用于停机维护</p>\n</blockquote>\n<p>在<code>lb01</code>配置，可见当两台web的Nginx服务都正常时，只能访问web02，当web02的Nginx服务挂了，返回502</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 down;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-backup状态\"><a href=\"#2-2-backup状态\" class=\"headerlink\" title=\"2.2 backup状态\"></a>2.2 backup状态</h3><p>在<code>lb01</code>配置，可见当两台web都正常时，只能访问web02，如果web02的服务挂了，会访问web01，当web02恢复后，再次访问到的是web02</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 backup;\n        server 172.16.1.8:80;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-健康检查\"><a href=\"#2-3-健康检查\" class=\"headerlink\" title=\"2.3 健康检查\"></a>2.3 健康检查</h3><blockquote>\n<p>自带的健康检查不够精准，且看不到信息，面试会问</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80 max_fails&#x3D;2 fail_timeout&#x3D;10s;\n        server 172.16.1.8:80 max_fails&#x3D;2 fail_timeout&#x3D;10s;\n&#125;\n\nserver &#123;\n...<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、第三方健康检查模块check-upstream\"><a href=\"#三、第三方健康检查模块check-upstream\" class=\"headerlink\" title=\"三、第三方健康检查模块check_upstream\"></a>三、第三方健康检查模块check_upstream</h2><blockquote>\n<p>检测更精准，且有页面可以展示服务端的状态，需要编译安装</p>\n</blockquote>\n<h3 id=\"3-1-编译安装Nginx\"><a href=\"#3-1-编译安装Nginx\" class=\"headerlink\" title=\"3.1 编译安装Nginx\"></a>3.1 编译安装Nginx</h3><p>1、安装依赖包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# yum install -y gcc glibc gcc-c++ pcre-devel openssl-devel  patch libxml2 -libxml2-devel libxslt libxslt-devel gd-devel perl-ExtUtils-Embed gperftools-devel.x86_64 gperftools-libs.x86_64 gperftools.x86_64<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、下载Nginx源码及第三方模块源码</p>\n<blockquote>\n<p>PS：为保持一致，先通过yum源安装nginx，这是当前实验环境的Nginx版本</p>\n<p>[root@lb01 nginx]# nginx -version<br>nginx version: nginx&#x2F;1.20.1</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# wget http:&#x2F;&#x2F;nginx.org&#x2F;download&#x2F;nginx-1.20.1.tar.gz\n[root@lb02 ~]# wget https:&#x2F;&#x2F;github.com&#x2F;yaoweibin&#x2F;nginx_upstream_check_module&#x2F;archive&#x2F;master.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>3、解压nginx源码包以及第三方模块</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 ~]# unzip master.zip\n[root@lb01 ~]# tar -vxf nginx-1.20.1.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>4、打补丁</p>\n<blockquote>\n<p>打补丁(nginx的版本是1.20.1补丁就选择1.20.1的,p1代表在nginx目录，p0是不在nginx目录)</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# cd nginx-1.20.1&#x2F;\n[root@lb01 nginx-1.20.1]# patch -p1 &lt; ..&#x2F;nginx_upstream_check_module-master&#x2F;check_1.20.1+.patch<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、编译Nginx，附带模块参数</p>\n<blockquote>\n<p>通过nginx -V获取configure参数，尽量保持一致</p>\n</blockquote>\n<p>–add-module&#x3D;&#x2F;root&#x2F;nginx_upstream_check_module-master</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# .&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F;share&#x2F;nginx --sbin-path&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx --modules-path&#x3D;&#x2F;usr&#x2F;lib64&#x2F;nginx&#x2F;modules --conf-path&#x3D;&#x2F;etc&#x2F;nginx&#x2F;nginx.conf --error-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log --http-log-path&#x3D;&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log --http-client-body-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;client_body --http-proxy-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;proxy --http-fastcgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;fastcgi --http-uwsgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;uwsgi --http-scgi-temp-path&#x3D;&#x2F;var&#x2F;lib&#x2F;nginx&#x2F;tmp&#x2F;scgi --pid-path&#x3D;&#x2F;run&#x2F;nginx.pid --lock-path&#x3D;&#x2F;run&#x2F;lock&#x2F;subsys&#x2F;nginx --user&#x3D;nginx --group&#x3D;nginx --with-compat --with-debug --with-google_perftools_module --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module&#x3D;dynamic --with-http_mp4_module --with-http_perl_module&#x3D;dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module&#x3D;dynamic --with-mail&#x3D;dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream&#x3D;dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --add-module&#x3D;&#x2F;root&#x2F;nginx_upstream_check_module-master<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、在已有的负载均衡上增加健康检查的功能</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf\nupstream node &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n        check interval&#x3D;3000 rise&#x3D;2 fall&#x3D;3 timeout&#x3D;1000 type&#x3D;tcp;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-功能测试\"><a href=\"#3-2-功能测试\" class=\"headerlink\" title=\"3.2 功能测试\"></a>3.2 功能测试</h3><p>1、正常情况下的检测数据</p>\n<p><img src=\"/img/image-20210821113447825.png\" alt=\"image-20210821113447825\"></p>\n<p>2、测试将web01的nginx服务关掉</p>\n<p><img src=\"/img/image-20210821114011230.png\" alt=\"image-20210821114011230\"></p>\n<p>3、日志分析</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 nginx-1.20.1]# tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log\n# 两web服务正常，能获取peer\n2021&#x2F;08&#x2F;21 02:42:11 [error] 50522#50522: enable check peer: 172.16.1.8:80\n2021&#x2F;08&#x2F;21 02:42:12 [error] 50522#50522: enable check peer: 172.16.1.7:80\n2021&#x2F;08&#x2F;21 02:46:17 [error] 50522#50522: *13 connect() failed (111: Connection refused) while connecting to upstream, client: 10.0.0.1, server: node.oldboy.com, request: &quot;GET &#x2F; HTTP&#x2F;1.1&quot;, upstream: &quot;http:&#x2F;&#x2F;172.16.1.7:80&#x2F;&quot;, host: &quot;node.oldboy.com&quot;\n# 停止web01的nginx服务\n2021&#x2F;08&#x2F;21 02:46:20 [error] 50522#50522: disable check peer: 172.16.1.7:80\n# 重新启动web01的nginx服务\n2021&#x2F;08&#x2F;21 02:47:59 [error] 50522#50522: enable check peer: 172.16.1.7:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、如何解决网站重复登录的问题\"><a href=\"#四、如何解决网站重复登录的问题\" class=\"headerlink\" title=\"四、如何解决网站重复登录的问题\"></a>四、如何解决网站重复登录的问题</h2><p>有三种方法解决：</p>\n<ol>\n<li>ip_hash – 会造成某一台主机的压力过大</li>\n<li>session复制</li>\n<li>session共享<ol>\n<li>本地文件 –&gt; nfs共享</li>\n<li>通过程序，写入redis数据库（常用）</li>\n<li>通过程序，写入mysql数据库</li>\n</ol>\n</li>\n</ol>\n<p>本案例，选用3.2配置，session共享，写入redis数据库</p>\n<h3 id=\"4-1-安装phpmyadmin重现问题\"><a href=\"#4-1-安装phpmyadmin重现问题\" class=\"headerlink\" title=\"4.1 安装phpmyadmin重现问题\"></a>4.1 安装phpmyadmin重现问题</h3><p><code>web01</code>和<code>web02</code>都需要安装</p>\n<p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cat php.conf\nserver &#123;\n\tlisten 80;\n\tserver_name php.oldboy.com;\n\troot &#x2F;code&#x2F;phpMyAdmin-4.8.4-all-languages;\n\n\tlocation &#x2F; &#123;\n\t\tindex index.php index.html;\n\t&#125;\n\n\tlocation ~ \\.php$ &#123;\n\t\tfastcgi_pass 127.0.0.1:9000;\n\t\tfastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n\t\tinclude fastcgi_params;\n\t&#125;\n&#125;\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、安装phpmyadmin</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# cd &#x2F;code\n[root@web01 code]# wget https:&#x2F;&#x2F;files.phpmyadmin.net&#x2F;phpMyAdmin&#x2F;4.8.4&#x2F;phpMyAdmin-4.8.4-all-languages.zip\n[root@web01 code]# unzip phpMyAdmin-4.8.4-all-languages.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、配置phpmyadmin连接远程数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# cd phpMyAdmin-4.8.4-all-languages&#x2F;\n[root@web01 phpMyAdmin-4.8.4-all-languages]# cp config.sample.inc.php config.inc.php\n[root@web01 phpMyAdmin-4.8.4-all-languages]# vim config.inc.php\n&#x2F;* Server parameters *&#x2F;\n$cfg[&#39;Servers&#39;][$i][&#39;host&#39;] &#x3D; &#39;172.16.1.51&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、配置授权</p>\n<blockquote>\n<p>这个文件夹中会记录session，需要权限</p>\n<p>session_start(): Failed to read session data: files (path: &#x2F;var&#x2F;lib&#x2F;php&#x2F;session)</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]# chown -R www.www &#x2F;var&#x2F;lib&#x2F;php&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>5、将web01上配置好的phpmyadmin以及nginx的配置文件推送到web02主机上</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 code]# scp -rp  phpMyAdmin-4.8.4-all-languages root@172.16.1.8:&#x2F;code&#x2F;\n[root@web01 code]# scp &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;php.conf  root@172.16.1.8:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>6、重载Nginx服务，授权访问权限</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 code]# systemctl restart nginx\n[root@web02 code]# chown -R www.www &#x2F;var&#x2F;lib&#x2F;php&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>7、接入负载均衡，并重启nginx服务，<code>lb01</code>操作</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# vim proxy_php.com.conf \nupstream php &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\nserver &#123;\n        listen 80;\n        server_name php.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;php;\n                include proxy_params;\n        &#125;\n&#125;\n\n[root@lb01 conf.d]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@lb01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、测试访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">网页访问：\n\thttp:&#x2F;&#x2F;php.oldboy.com\n登录账户:\n\t采用db01（172.16.1.51）的mysql远程账户oldboy&#x2F;Bgx123.com\n此时访问phpmyadmin登录将一直失败，因为轮询访问，session一直变：\n报错：\nFailed to set session cookie. Maybe you are using HTTP instead of HTTPS to access phpMyAdmin.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-解决问题\"><a href=\"#4-2-解决问题\" class=\"headerlink\" title=\"4.2 解决问题\"></a>4.2 解决问题</h3><p>1、在<code>db01</code>安装redis数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# yum install redis -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2、配置并启动redis</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# sed  -i &#39;&#x2F;^bind&#x2F;c bind 127.0.0.1 172.16.1.51&#39; &#x2F;etc&#x2F;redis.conf\n[root@db01 ~]# systemctl start redis\n[root@db01 ~]# systemctl enable redis<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>3、<code>web01</code>的php配置session连接redis</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#1.修改&#x2F;etc&#x2F;php.ini文件\n[root@web01 ~]# vim &#x2F;etc&#x2F;php.ini\nsession.save_handler &#x3D; redis\nsession.save_path &#x3D; &quot;tcp:&#x2F;&#x2F;172.16.1.51:6379&quot;\n;session.save_path &#x3D; &quot;tcp:&#x2F;&#x2F;172.16.1.51:6379?auth&#x3D;123&quot; #如果redis存在密码，则使用该方式\nsession.auto_start &#x3D; 1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、注释php-fpm.d&#x2F;<a href=\"http://www.conf里面的两条内容,否则session内容会一直写入/var/lib/php/session%E7%9B%AE%E5%BD%95%E4%B8%AD\">www.conf里面的两条内容，否则session内容会一直写入/var/lib/php/session目录中</a></p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">;php_value[session.save_handler] &#x3D; files\n;php_value[session.save_path]    &#x3D; &#x2F;var&#x2F;lib&#x2F;php&#x2F;session<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>5、重启php-fpm</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>6、将<code>web01</code>的配置文件推送到<code>web02</code>上</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web01 code]# scp &#x2F;etc&#x2F;php.ini root@172.16.1.8:&#x2F;etc&#x2F;php.ini  \n[root@web01 code]# scp &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf root@172.16.1.8:&#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>7、重启服务</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@web02 code]# systemctl restart php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>8、再次测试访问网站</p>\n<p>可以登录，并且session的值将记录到redis数据库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@db01 ~]# redis-cli -h 172.16.1.51\n172.16.1.51:6379&gt; KEYS *\n1) &quot;PHPREDIS_SESSION:716e61cabeb40f974fcbcdcac65f8607&quot;\n2) &quot;PHPREDIS_SESSION:42ca5a8ea9375a93a7974427b77b3dd7&quot;\n172.16.1.51:6379&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>9、刷新页面的负载均衡效果展示</p>\n<p><img src=\"/img/image-20210823225246243.png\" alt=\"image-20210823225246243\"></p>\n<p><img src=\"/img/image-20210823225305632.png\" alt=\"image-20210823225305632\"></p>\n<p>10、cookie保存到redis展示</p>\n<p><img src=\"/img/image-20210823225412626.png\" alt=\"image-20210823225412626\"></p>\n"},{"title":"运维之综合架构--07--Nginx(六)七层负载均衡","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、七层负载均衡简介(需补充)\n\n### 1.1 nginx代理的局限性\n\n​\t一个location仅能代理后端一台主机\n\n### 1.2 七层负载均衡\n\nNginx负载均衡\n\t负载\n\t负载均衡\n\t调度\n\tload balance\n\tLB\n公有云\n\tSLB\t\t阿里云负载均衡\n\tQLB\t\t青云负载均衡\n\tCLB\t\t腾讯负载均衡\n\tULB\t\tucloud的负载均衡\n\n### 1.3 四层负载均衡和七层负载均衡的区别\n\n四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。\n但七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。\n\n## 二、配置实例\n\n### 2.1 测试环境准备\n\n| 主机名称 | 应用环境                    | 外网地址  | 内网地址    |\n| -------- | --------------------------- | --------- | ----------- |\n| web01    | nginx + php（提供网页服务） | 10.0.0.7  | 172.16.1.7  |\n| web01    | nginx + php（提供网页服务） | 10.0.0.8  | 172.16.1.8  |\n| lb01     | nginx（提供代理服务）       | 10.0.0.5  | 172.16.1.5  |\n| db01     | mysql                       | 10.0.0.51 | 172.16.1.51 |\n\n### 2.2 配置步骤\n\n1、web01/02的网页服务搭建\n\n```shell\n[root@web01 ~]# cd /etc/nginx/conf.d/\n[root@web01 conf.d]# cat node.conf \nserver {\n    listen 80;\n    server_name node.oldboy.com;\n    location / {\n        root /node;\n        index index.html;\n    }\n}\n[root@web01 conf.d]# mkdir /node\n[root@web01 conf.d]# echo \"Web01...\" > /node/index.html\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n2、配置nginx负载均衡\n\n```shell\n[root@lb01 ~]# cd /etc/nginx/conf.d/\n[root@lb01 conf.d]# cat node_proxy.conf \nupstream node {\n    server 172.16.1.7:80;\n    server 172.16.1.8:80;\n}\nserver {\n    listen 80;\n    server_name node.oldboy.com;\n\n    location / {\n        proxy_pass http://node;\n        include proxy_params;\n    }\n}\n[root@lb01 conf.d]# systemctl restart nginx\n```\n\n3、客户端网页测试访问，F5刷新，可见web01/web02在循环\n\n![image-20210820132420586](/img/image-20210820132420586.png)\n\n![image-20210820132431971](/img/image-20210820132431971.png)\n\n### 2.3 负载均衡也可以使用代理参数\n\n>与之前部署的知乎wencenter、博客mywordpress结合\n\n1、准备Nginx负载均衡调度使用的proxy_params\n\n```shell\n[root@Nginx ~]# vim /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n2、负载均衡配置：\n\n```shell\n[root@lb01 conf.d]# vim proxy_oldboy.com.conf\nupstream node {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\nserver {\n        listen 80;\n        server_name blog.oldboy.com;\n        location / {\n                proxy_pass http://node;\n                include proxy_params;\n        }\n}\n\nserver {\n        listen 80;\n        server_name zh.oldboy.com;\n        location / {\n                proxy_pass http://node;\n                include proxy_params;\n        }\n}\n```\n\n### 2.4 负载均衡测试\n\n正常情况下：\n\n```shell\n1、两台web服务器的nginx服务均打开（模拟流量分摊）\n\t可以负载均衡，轮流访问\n2、关掉一台web服务器的nginx服务（模拟容灾）\n\t网页仍可以正常打开\n3、两台web服务器的Nginx服务均关闭\n\t网页无法打开，502\n```\n\n存在一种情况，两个web的nginx服务都没挂，但是其中一台的php-fpm服务挂了，模拟这种场景\n\n```shell\n[root@web02 ~]# systemctl stop php-fpm\n```\n\n此时F5刷新wordpress的页面，将一会502，一会正常，体验不好，可通过添加nginx代理参数解决\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_next_upstream error timeout http_500 http_502 http_503 http_504; # 解决问题\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n>PS：问题原因\n>\n>使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。\n>Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有down掉，并且返回错误异常码了如：504、502、500，Nginx就会直接返回从后端获取的异常代码。\n","source":"_posts/01_运维/02-综合架构/12-Nginx(六)Nginx七层负载均衡.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(六)七层负载均衡\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、七层负载均衡简介(需补充)\n\n### 1.1 nginx代理的局限性\n\n​\t一个location仅能代理后端一台主机\n\n### 1.2 七层负载均衡\n\nNginx负载均衡\n\t负载\n\t负载均衡\n\t调度\n\tload balance\n\tLB\n公有云\n\tSLB\t\t阿里云负载均衡\n\tQLB\t\t青云负载均衡\n\tCLB\t\t腾讯负载均衡\n\tULB\t\tucloud的负载均衡\n\n### 1.3 四层负载均衡和七层负载均衡的区别\n\n四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。\n但七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。\n\n## 二、配置实例\n\n### 2.1 测试环境准备\n\n| 主机名称 | 应用环境                    | 外网地址  | 内网地址    |\n| -------- | --------------------------- | --------- | ----------- |\n| web01    | nginx + php（提供网页服务） | 10.0.0.7  | 172.16.1.7  |\n| web01    | nginx + php（提供网页服务） | 10.0.0.8  | 172.16.1.8  |\n| lb01     | nginx（提供代理服务）       | 10.0.0.5  | 172.16.1.5  |\n| db01     | mysql                       | 10.0.0.51 | 172.16.1.51 |\n\n### 2.2 配置步骤\n\n1、web01/02的网页服务搭建\n\n```shell\n[root@web01 ~]# cd /etc/nginx/conf.d/\n[root@web01 conf.d]# cat node.conf \nserver {\n    listen 80;\n    server_name node.oldboy.com;\n    location / {\n        root /node;\n        index index.html;\n    }\n}\n[root@web01 conf.d]# mkdir /node\n[root@web01 conf.d]# echo \"Web01...\" > /node/index.html\n[root@web01 conf.d]# systemctl restart nginx\n```\n\n2、配置nginx负载均衡\n\n```shell\n[root@lb01 ~]# cd /etc/nginx/conf.d/\n[root@lb01 conf.d]# cat node_proxy.conf \nupstream node {\n    server 172.16.1.7:80;\n    server 172.16.1.8:80;\n}\nserver {\n    listen 80;\n    server_name node.oldboy.com;\n\n    location / {\n        proxy_pass http://node;\n        include proxy_params;\n    }\n}\n[root@lb01 conf.d]# systemctl restart nginx\n```\n\n3、客户端网页测试访问，F5刷新，可见web01/web02在循环\n\n![image-20210820132420586](/img/image-20210820132420586.png)\n\n![image-20210820132431971](/img/image-20210820132431971.png)\n\n### 2.3 负载均衡也可以使用代理参数\n\n>与之前部署的知乎wencenter、博客mywordpress结合\n\n1、准备Nginx负载均衡调度使用的proxy_params\n\n```shell\n[root@Nginx ~]# vim /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n2、负载均衡配置：\n\n```shell\n[root@lb01 conf.d]# vim proxy_oldboy.com.conf\nupstream node {\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n}\nserver {\n        listen 80;\n        server_name blog.oldboy.com;\n        location / {\n                proxy_pass http://node;\n                include proxy_params;\n        }\n}\n\nserver {\n        listen 80;\n        server_name zh.oldboy.com;\n        location / {\n                proxy_pass http://node;\n                include proxy_params;\n        }\n}\n```\n\n### 2.4 负载均衡测试\n\n正常情况下：\n\n```shell\n1、两台web服务器的nginx服务均打开（模拟流量分摊）\n\t可以负载均衡，轮流访问\n2、关掉一台web服务器的nginx服务（模拟容灾）\n\t网页仍可以正常打开\n3、两台web服务器的Nginx服务均关闭\n\t网页无法打开，502\n```\n\n存在一种情况，两个web的nginx服务都没挂，但是其中一台的php-fpm服务挂了，模拟这种场景\n\n```shell\n[root@web02 ~]# systemctl stop php-fpm\n```\n\n此时F5刷新wordpress的页面，将一会502，一会正常，体验不好，可通过添加nginx代理参数解决\n\n```shell\n[root@lb01 conf.d]# cat /etc/nginx/proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_next_upstream error timeout http_500 http_502 http_503 http_504; # 解决问题\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;\n```\n\n>PS：问题原因\n>\n>使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。\n>Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有down掉，并且返回错误异常码了如：504、502、500，Nginx就会直接返回从后端获取的异常代码。\n","slug":"01_运维/02-综合架构/12-Nginx(六)Nginx七层负载均衡","published":1,"updated":"2022-07-11T05:54:22.015Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0k0014a8v704b003dh","content":"<h2 id=\"一、七层负载均衡简介-需补充\"><a href=\"#一、七层负载均衡简介-需补充\" class=\"headerlink\" title=\"一、七层负载均衡简介(需补充)\"></a>一、七层负载均衡简介(需补充)</h2><h3 id=\"1-1-nginx代理的局限性\"><a href=\"#1-1-nginx代理的局限性\" class=\"headerlink\" title=\"1.1 nginx代理的局限性\"></a>1.1 nginx代理的局限性</h3><p>​\t一个location仅能代理后端一台主机</p>\n<h3 id=\"1-2-七层负载均衡\"><a href=\"#1-2-七层负载均衡\" class=\"headerlink\" title=\"1.2 七层负载均衡\"></a>1.2 七层负载均衡</h3><p>Nginx负载均衡<br>    负载<br>    负载均衡<br>    调度<br>    load balance<br>    LB<br>公有云<br>    SLB\t\t阿里云负载均衡<br>    QLB\t\t青云负载均衡<br>    CLB\t\t腾讯负载均衡<br>    ULB\t\tucloud的负载均衡</p>\n<h3 id=\"1-3-四层负载均衡和七层负载均衡的区别\"><a href=\"#1-3-四层负载均衡和七层负载均衡的区别\" class=\"headerlink\" title=\"1.3 四层负载均衡和七层负载均衡的区别\"></a>1.3 四层负载均衡和七层负载均衡的区别</h3><p>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。<br>但七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。</p>\n<h2 id=\"二、配置实例\"><a href=\"#二、配置实例\" class=\"headerlink\" title=\"二、配置实例\"></a>二、配置实例</h2><h3 id=\"2-1-测试环境准备\"><a href=\"#2-1-测试环境准备\" class=\"headerlink\" title=\"2.1 测试环境准备\"></a>2.1 测试环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>nginx（提供代理服务）</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td>10.0.0.51</td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-配置步骤\"><a href=\"#2-2-配置步骤\" class=\"headerlink\" title=\"2.2 配置步骤\"></a>2.2 配置步骤</h3><p>1、web01&#x2F;02的网页服务搭建</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@web01 conf.d]# cat node.conf \nserver &#123;\n    listen 80;\n    server_name node.oldboy.com;\n    location &#x2F; &#123;\n        root &#x2F;node;\n        index index.html;\n    &#125;\n&#125;\n[root@web01 conf.d]# mkdir &#x2F;node\n[root@web01 conf.d]# echo &quot;Web01...&quot; &gt; &#x2F;node&#x2F;index.html\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、配置nginx负载均衡</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@lb01 conf.d]# cat node_proxy.conf \nupstream node &#123;\n    server 172.16.1.7:80;\n    server 172.16.1.8:80;\n&#125;\nserver &#123;\n    listen 80;\n    server_name node.oldboy.com;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;node;\n        include proxy_params;\n    &#125;\n&#125;\n[root@lb01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、客户端网页测试访问，F5刷新，可见web01&#x2F;web02在循环</p>\n<p><img src=\"/img/image-20210820132420586.png\" alt=\"image-20210820132420586\"></p>\n<p><img src=\"/img/image-20210820132431971.png\" alt=\"image-20210820132431971\"></p>\n<h3 id=\"2-3-负载均衡也可以使用代理参数\"><a href=\"#2-3-负载均衡也可以使用代理参数\" class=\"headerlink\" title=\"2.3 负载均衡也可以使用代理参数\"></a>2.3 负载均衡也可以使用代理参数</h3><blockquote>\n<p>与之前部署的知乎wencenter、博客mywordpress结合</p>\n</blockquote>\n<p>1、准备Nginx负载均衡调度使用的proxy_params</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@Nginx ~]# vim &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、负载均衡配置：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# vim proxy_oldboy.com.conf\nupstream node &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\nserver &#123;\n        listen 80;\n        server_name blog.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;node;\n                include proxy_params;\n        &#125;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name zh.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;node;\n                include proxy_params;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-负载均衡测试\"><a href=\"#2-4-负载均衡测试\" class=\"headerlink\" title=\"2.4 负载均衡测试\"></a>2.4 负载均衡测试</h3><p>正常情况下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、两台web服务器的nginx服务均打开（模拟流量分摊）\n\t可以负载均衡，轮流访问\n2、关掉一台web服务器的nginx服务（模拟容灾）\n\t网页仍可以正常打开\n3、两台web服务器的Nginx服务均关闭\n\t网页无法打开，502<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>存在一种情况，两个web的nginx服务都没挂，但是其中一台的php-fpm服务挂了，模拟这种场景</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 ~]# systemctl stop php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>此时F5刷新wordpress的页面，将一会502，一会正常，体验不好，可通过添加nginx代理参数解决</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_next_upstream error timeout http_500 http_502 http_503 http_504; # 解决问题\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：问题原因</p>\n<p>使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。<br>Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有down掉，并且返回错误异常码了如：504、502、500，Nginx就会直接返回从后端获取的异常代码。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、七层负载均衡简介-需补充\"><a href=\"#一、七层负载均衡简介-需补充\" class=\"headerlink\" title=\"一、七层负载均衡简介(需补充)\"></a>一、七层负载均衡简介(需补充)</h2><h3 id=\"1-1-nginx代理的局限性\"><a href=\"#1-1-nginx代理的局限性\" class=\"headerlink\" title=\"1.1 nginx代理的局限性\"></a>1.1 nginx代理的局限性</h3><p>​\t一个location仅能代理后端一台主机</p>\n<h3 id=\"1-2-七层负载均衡\"><a href=\"#1-2-七层负载均衡\" class=\"headerlink\" title=\"1.2 七层负载均衡\"></a>1.2 七层负载均衡</h3><p>Nginx负载均衡<br>    负载<br>    负载均衡<br>    调度<br>    load balance<br>    LB<br>公有云<br>    SLB\t\t阿里云负载均衡<br>    QLB\t\t青云负载均衡<br>    CLB\t\t腾讯负载均衡<br>    ULB\t\tucloud的负载均衡</p>\n<h3 id=\"1-3-四层负载均衡和七层负载均衡的区别\"><a href=\"#1-3-四层负载均衡和七层负载均衡的区别\" class=\"headerlink\" title=\"1.3 四层负载均衡和七层负载均衡的区别\"></a>1.3 四层负载均衡和七层负载均衡的区别</h3><p>四层负载均衡数据包在底层就进行了分发，而七层负载均衡数据包则是在最顶层进行分发、由此可以看出，七层负载均衡效率没有四负载均衡高。<br>但七层负载均衡更贴近于服务，如:http协议就是七层协议，我们可以用Nginx可以作会话保持，URL路径规则匹配、head头改写等等，这些是四层负载均衡无法实现的。</p>\n<h2 id=\"二、配置实例\"><a href=\"#二、配置实例\" class=\"headerlink\" title=\"二、配置实例\"></a>二、配置实例</h2><h3 id=\"2-1-测试环境准备\"><a href=\"#2-1-测试环境准备\" class=\"headerlink\" title=\"2.1 测试环境准备\"></a>2.1 测试环境准备</h3><table>\n<thead>\n<tr>\n<th>主机名称</th>\n<th>应用环境</th>\n<th>外网地址</th>\n<th>内网地址</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>nginx + php（提供网页服务）</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>nginx（提供代理服务）</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>db01</td>\n<td>mysql</td>\n<td>10.0.0.51</td>\n<td>172.16.1.51</td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-配置步骤\"><a href=\"#2-2-配置步骤\" class=\"headerlink\" title=\"2.2 配置步骤\"></a>2.2 配置步骤</h3><p>1、web01&#x2F;02的网页服务搭建</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@web01 conf.d]# cat node.conf \nserver &#123;\n    listen 80;\n    server_name node.oldboy.com;\n    location &#x2F; &#123;\n        root &#x2F;node;\n        index index.html;\n    &#125;\n&#125;\n[root@web01 conf.d]# mkdir &#x2F;node\n[root@web01 conf.d]# echo &quot;Web01...&quot; &gt; &#x2F;node&#x2F;index.html\n[root@web01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、配置nginx负载均衡</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;\n[root@lb01 conf.d]# cat node_proxy.conf \nupstream node &#123;\n    server 172.16.1.7:80;\n    server 172.16.1.8:80;\n&#125;\nserver &#123;\n    listen 80;\n    server_name node.oldboy.com;\n\n    location &#x2F; &#123;\n        proxy_pass http:&#x2F;&#x2F;node;\n        include proxy_params;\n    &#125;\n&#125;\n[root@lb01 conf.d]# systemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、客户端网页测试访问，F5刷新，可见web01&#x2F;web02在循环</p>\n<p><img src=\"/img/image-20210820132420586.png\" alt=\"image-20210820132420586\"></p>\n<p><img src=\"/img/image-20210820132431971.png\" alt=\"image-20210820132431971\"></p>\n<h3 id=\"2-3-负载均衡也可以使用代理参数\"><a href=\"#2-3-负载均衡也可以使用代理参数\" class=\"headerlink\" title=\"2.3 负载均衡也可以使用代理参数\"></a>2.3 负载均衡也可以使用代理参数</h3><blockquote>\n<p>与之前部署的知乎wencenter、博客mywordpress结合</p>\n</blockquote>\n<p>1、准备Nginx负载均衡调度使用的proxy_params</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@Nginx ~]# vim &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、负载均衡配置：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# vim proxy_oldboy.com.conf\nupstream node &#123;\n        server 172.16.1.7:80;\n        server 172.16.1.8:80;\n&#125;\nserver &#123;\n        listen 80;\n        server_name blog.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;node;\n                include proxy_params;\n        &#125;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name zh.oldboy.com;\n        location &#x2F; &#123;\n                proxy_pass http:&#x2F;&#x2F;node;\n                include proxy_params;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-负载均衡测试\"><a href=\"#2-4-负载均衡测试\" class=\"headerlink\" title=\"2.4 负载均衡测试\"></a>2.4 负载均衡测试</h3><p>正常情况下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、两台web服务器的nginx服务均打开（模拟流量分摊）\n\t可以负载均衡，轮流访问\n2、关掉一台web服务器的nginx服务（模拟容灾）\n\t网页仍可以正常打开\n3、两台web服务器的Nginx服务均关闭\n\t网页无法打开，502<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>存在一种情况，两个web的nginx服务都没挂，但是其中一台的php-fpm服务挂了，模拟这种场景</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 ~]# systemctl stop php-fpm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>此时F5刷新wordpress的页面，将一会502，一会正常，体验不好，可通过添加nginx代理参数解决</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 conf.d]# cat &#x2F;etc&#x2F;nginx&#x2F;proxy_params\nproxy_set_header Host $http_host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_next_upstream error timeout http_500 http_502 http_503 http_504; # 解决问题\n\nproxy_connect_timeout 30;\nproxy_send_timeout 60;\nproxy_read_timeout 60;\n\nproxy_buffering on;\nproxy_buffer_size 32k;\nproxy_buffers 4 128k;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：问题原因</p>\n<p>使用nginx负载均衡时，如何将后端请求超时的服务器流量平滑的切换到另一台上。<br>Nginx是本身是有机制的，如果出现一个节点down掉的时候，Nginx会更据你具体负载均衡的设置，将请求转移到其他的节点上，但是，如果后台服务连接没有down掉，并且返回错误异常码了如：504、502、500，Nginx就会直接返回从后端获取的异常代码。</p>\n</blockquote>\n"},{"title":"运维之综合架构--07--Nginx(八)四层负载均衡","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、Nginx四层负载均衡介绍\n\n四层负载均衡：（OSI传输层   ip:port）\n\tnginx1.9 版本加入\n硬件：F5\n软件：LVS、Haproxy、Nginx\n\n1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如:nginx就无法保证自己的服务高可用，需要依赖lvs或者keepalive来作。\n\n2.如:tcp协议的负载均衡，有些请求是TCP协议的(mysql、ssh)，或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。\n\t比如做：mysql读的负载均衡（轮询）\n\t比如做：端口映射、端口转发         tcp/udp\n\n四层负载均衡总结\n1.四层负载均衡仅能转发TCP/IP协议、UDP协议，通常用来转发端口，如: tcp/3306，tcp/22，udp/53。\n2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）\n3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）\n4.四层的转发效率比七层的高的多，但仅支持tcp/ip协议，不支持http或者https协议\n\n![image-20210823230415237](/img/image-20210823230415237.png)\n\n## 二、四层负载均衡配置\n\n### 2.1 环境准备\n\n| 服务器名                  | 公网IP   | 内网IP     |\n| ------------------------- | -------- | ---------- |\n| lb4-01                    | 10.0.0.3 |            |\n| lb01                      | 10.0.0.5 | 172.16.1.5 |\n| lb02                      | 10.0.0.6 | 172.16.1.6 |\n| web、nfs、mysql服务器若干 |          |            |\n\n### 2.2 新增lb02负载均衡服务器\n\n1、准备`lb02`，安装Nginx服务\n\n```shell\n[root@lb02 ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n[root@lb02 ~]#  yum install nginx -y\n```\n\n2、拷贝`lb01`的 Nginx配置到`lb02`\n\n```shell\n[root@lb02 ~]# scp -rp root@172.16.1.5:/etc/nginx /etc/\n```\n\n3、启动Nginx\n\n```shell\n[root@lb02 conf.d]# nginx -t\n[root@lb02 conf.d]# systemctl start nginx\n[root@lb02 conf.d]# systemctl enable nginx\n```\n\n>报错：\n>\n>[root@lb02 ~]# nginx -t\n>nginx: [emerg] unknown directive \"check\" in /etc/nginx/conf.d/proxy_node.conf:4\n>nginx: configuration file /etc/nginx/nginx.conf test failed\n>[root@lb02 ~]# vim /etc/nginx/conf.d/proxy_node.conf\n>[root@lb02 ~]# nginx -t\n>nginx: [emerg] unknown directive \"check_status\" in /etc/nginx/conf.d/proxy_node.conf:17\n>nginx: configuration file /etc/nginx/nginx.conf test failed\n>\n>解决方法：\n>\n>因为lb01安装过第三方健康检查工具，而lb02上没有，先将这些报错点注释掉\n\n4、测试lb02是否正常\n\n将hosts中的10.0.0.5换成10.0.0.6，phpadmin、wordpress网页可以正常访问,\n但是wecenter异常502 Bad Gateway\n解决方法: 将web01、02上的的php.ini中的session.auto_start改为0,不然会502\n\n```shell\n[root@web01 php]# vim /etc/php.ini\nsession.auto_start = 0\n[root@web01 php]# systemctl restart php-fpm.service\n```\n\n>网上搜索的解释：\n>日常开发中，php.ini配置session.auto_start=0默认关闭会话时如果想开启会话需要调用session_start：\n>session.auto_start 开启就自动完成了session_start()\n>区别就在于在用SESSION前是否需要session_start();\n>当session.auto_start = on时，执行 session_start() 将产生新的 session_id\n>session.auto_start = on 的优点在于，任何时候都不会因忘记执行 session_start() 或 session_start() 在程序里的位置不对，而导致错误\n>缺点在于，如果你使用的是第三方代码，则必须删去其中的全部 session_start() 。否则将不能得到正确的结果\n\n### 2.3 配置四层负载均衡\n\n1、新增`lb4-01`服务器，安装nginx\n\n>nginx需要带--with-stream模块\n\n```she\n[root@lb4-01 ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n[root@lb4-01 ~]#  yum install nginx -y\t\n[root@lb4-01 ~]# vim /etc/nginx/nginx.conf\nevents {\n    ....\n}\n\ninclude /etc/nginx/conf.c/*.conf;\n\nhttp {\n\t.....\n}\n```\n\n2、创建四层负载均衡配置的目录\n\n```shell\n[root@lb4-01 conf.c]# rm -f /etc/nginx/conf.d/default.conf   #删除http的80端口\n[root@lb4-01 ~]# mkdir /etc/nginx/conf.c\n[root@lb4-01 ~]# cd /etc/nginx/conf.c\n[root@lb4-01 conf.c]# cat lb_domain.conf \nstream {\n    upstream lb {\n        server 172.16.1.5:80 weight=5 max_fails=3 fail_timeout=30s;\n        server 172.16.1.6:80 weight=5 max_fails=3 fail_timeout=30s;\n    }\n\n    server {\n        listen 80;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass lb;\n    }\n}\n```\n\n3、重载服务\n\n```shell\n[root@lb4-01 conf.c]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lb4-01 conf.c]# systemctl restart nginx\n[root@lb4-01 conf.c]# systemctl enable nginx\n```\n\n>报错：\n>\t[root@lb4-01 nginx]# nginx  -t\n>\tnginx: [emerg] unknown directive \"stream\" in /etc/nginx/conf.c/lb_domain.conf:1\n>\tnginx: configuration file /etc/nginx/nginx.conf test failed\n>解决方法：\n>\tyum install nginx-mod-stream.x86_64 -y\n\n>报错：\n>[root@lb4-01 nginx]# systemctl status nginx\n>nginx.service - The nginx HTTP and reverse proxy server\n>Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)\n>Active: failed (Result: exit-code) since Tue 2021-08-24 07:48:42 CST; 13s ago\n>Process: 2969 ExecStart=/usr/sbin/nginx (code=exited, status=1/FAILURE)\n>Process: 2967 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)\n>Process: 2965 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)\n>Main PID: 1959 (code=exited, status=0/SUCCESS)\n>\n>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] still could not bind()\n>解决方法：\n>\t需要将[root@lb4-01 nginx]# vim /etc/nginx/nginx.conf\n>\t中默认的80端口改掉，比如改成81,这样才不冲突（奇怪。。）\n\n4、访问测试\n\n将Hosts中的对应网站地址的IP改成10.0.0.3，尝试访问，可以正常通过四层负载均衡来调度10.0.0.5和10.0.0.6七层负载均衡\n\n![image-20210824001613717](/img/image-20210824001613717.png)\n\n![image-20210824001638506](/img/image-20210824001638506.png)\n\n## 三、四层负载均衡日志\n\n### 3.1 配置过程\n\n在四层负载均衡中配置Nginx\n\n```shell\n[root@lb4-01 ~]# cat /etc/nginx/conf.c/lb_domain.conf\nstream {\n    log_format  proxy '$remote_addr $remote_port - [$time_local] $status $protocol '\n                  '\"$upstream_addr\" \"$upstream_bytes_sent\" \"$upstream_connect_time\"' ;\n    access_log /var/log/nginx/proxy.log proxy;\n\n    upstream lb {\n....\n```\n\n### 3.2 查看日志\n\n网页访问后，可见产生的日志\n\n```shell\n[root@lb4-01 ~]# tail -f /var/log/nginx/proxy.log\n10.0.0.1 56396 - [25/Aug/2021:19:25:33 +0800] 200 TCP \"172.16.1.5:80\" \"15150\" \"0.000\"\n10.0.0.1 59800 - [25/Aug/2021:19:25:34 +0800] 200 TCP \"172.16.1.6:80\" \"8327\" \"0.000\"\n10.0.0.1 63468 - [25/Aug/2021:19:25:34 +0800] 200 TCP \"172.16.1.5:80\" \"17882\" \"0.000\"\n10.0.0.1 50394 - [25/Aug/2021:19:25:35 +0800] 200 TCP \"172.16.1.5:80\" \"24490\" \"0.000\"\n10.0.0.1 55549 - [25/Aug/2021:19:25:35 +0800] 200 TCP \"172.16.1.5:80\" \"13201\" \"0.000\"\n10.0.0.1 64324 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"70995\" \"0.000\"\n10.0.0.1 64566 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"72650\" \"0.000\"\n10.0.0.1 65216 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"68171\" \"0.000\"\n10.0.0.1 49668 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.5:80\" \"82071\" \"0.004\"\n10.0.0.1 49745 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.5:80\" \"63941\" \"0.001\"\n10.0.0.1 50574 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"103581\" \"0.000\"\n```\n\n## 三、使用nginx四层负载均衡实现tcp的转发（跳板）\n\n实现跳板机的功能，比如：\n\n\t请求负载均衡 5555    --->     172.16.1.7:22;\n\t请求负载均衡 6666    --->     172.16.1.51:3306;\n\n### 3.1 配置过程\n\n配置Nginx\n\n```shell\n[root@lb4-01 ~]# cat /etc/nginx/conf.c/lb_domain.conf \nstream {\nlog_format  proxy '$remote_addr $remote_port - [$time_local] $status $protocol '\n                  '\"$upstream_addr\" \"$upstream_bytes_sent\" \"$upstream_connect_time\"' ;\n    access_log /var/log/nginx/proxy.log proxy;\n\n#定义转发ssh的22端口\n\tupstream ssh_7 {\n\t\tserver 10.0.0.7:22;\n\t}\n#定义转发mysql的3306端口\n\tupstream mysql_51 {\n\t\tserver 10.0.0.51:3306;\n\t}\n    server {\n        listen 5555;\n        proxy_connect_timeout 3s;\n        proxy_timeout 300s;\n        proxy_pass ssh_7;\n    }\n\n    server {\n        listen 6666;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass mysql_51;\n    }\n}\n```\n\n测试访问\n\n```shell\n# 连接web01\nssh root@10.0.0.3 -p 5555\n\n# 连接db01\nssh root@10.0.0.3 -p 6666\n```\n\n\n\n\n\n\n\n\n\n","source":"_posts/01_运维/02-综合架构/14-Nginx(八)Nginx四层负载均衡.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(八)四层负载均衡\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、Nginx四层负载均衡介绍\n\n四层负载均衡：（OSI传输层   ip:port）\n\tnginx1.9 版本加入\n硬件：F5\n软件：LVS、Haproxy、Nginx\n\n1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如:nginx就无法保证自己的服务高可用，需要依赖lvs或者keepalive来作。\n\n2.如:tcp协议的负载均衡，有些请求是TCP协议的(mysql、ssh)，或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。\n\t比如做：mysql读的负载均衡（轮询）\n\t比如做：端口映射、端口转发         tcp/udp\n\n四层负载均衡总结\n1.四层负载均衡仅能转发TCP/IP协议、UDP协议，通常用来转发端口，如: tcp/3306，tcp/22，udp/53。\n2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）\n3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）\n4.四层的转发效率比七层的高的多，但仅支持tcp/ip协议，不支持http或者https协议\n\n![image-20210823230415237](/img/image-20210823230415237.png)\n\n## 二、四层负载均衡配置\n\n### 2.1 环境准备\n\n| 服务器名                  | 公网IP   | 内网IP     |\n| ------------------------- | -------- | ---------- |\n| lb4-01                    | 10.0.0.3 |            |\n| lb01                      | 10.0.0.5 | 172.16.1.5 |\n| lb02                      | 10.0.0.6 | 172.16.1.6 |\n| web、nfs、mysql服务器若干 |          |            |\n\n### 2.2 新增lb02负载均衡服务器\n\n1、准备`lb02`，安装Nginx服务\n\n```shell\n[root@lb02 ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n[root@lb02 ~]#  yum install nginx -y\n```\n\n2、拷贝`lb01`的 Nginx配置到`lb02`\n\n```shell\n[root@lb02 ~]# scp -rp root@172.16.1.5:/etc/nginx /etc/\n```\n\n3、启动Nginx\n\n```shell\n[root@lb02 conf.d]# nginx -t\n[root@lb02 conf.d]# systemctl start nginx\n[root@lb02 conf.d]# systemctl enable nginx\n```\n\n>报错：\n>\n>[root@lb02 ~]# nginx -t\n>nginx: [emerg] unknown directive \"check\" in /etc/nginx/conf.d/proxy_node.conf:4\n>nginx: configuration file /etc/nginx/nginx.conf test failed\n>[root@lb02 ~]# vim /etc/nginx/conf.d/proxy_node.conf\n>[root@lb02 ~]# nginx -t\n>nginx: [emerg] unknown directive \"check_status\" in /etc/nginx/conf.d/proxy_node.conf:17\n>nginx: configuration file /etc/nginx/nginx.conf test failed\n>\n>解决方法：\n>\n>因为lb01安装过第三方健康检查工具，而lb02上没有，先将这些报错点注释掉\n\n4、测试lb02是否正常\n\n将hosts中的10.0.0.5换成10.0.0.6，phpadmin、wordpress网页可以正常访问,\n但是wecenter异常502 Bad Gateway\n解决方法: 将web01、02上的的php.ini中的session.auto_start改为0,不然会502\n\n```shell\n[root@web01 php]# vim /etc/php.ini\nsession.auto_start = 0\n[root@web01 php]# systemctl restart php-fpm.service\n```\n\n>网上搜索的解释：\n>日常开发中，php.ini配置session.auto_start=0默认关闭会话时如果想开启会话需要调用session_start：\n>session.auto_start 开启就自动完成了session_start()\n>区别就在于在用SESSION前是否需要session_start();\n>当session.auto_start = on时，执行 session_start() 将产生新的 session_id\n>session.auto_start = on 的优点在于，任何时候都不会因忘记执行 session_start() 或 session_start() 在程序里的位置不对，而导致错误\n>缺点在于，如果你使用的是第三方代码，则必须删去其中的全部 session_start() 。否则将不能得到正确的结果\n\n### 2.3 配置四层负载均衡\n\n1、新增`lb4-01`服务器，安装nginx\n\n>nginx需要带--with-stream模块\n\n```she\n[root@lb4-01 ~]# cat /etc/yum.repos.d/nginx.repo \n[nginx]\nname=nginx repo\nbaseurl=http://nginx.org/packages/centos/7/$basearch/\ngpgcheck=0\nenabled=1\n[root@lb4-01 ~]#  yum install nginx -y\t\n[root@lb4-01 ~]# vim /etc/nginx/nginx.conf\nevents {\n    ....\n}\n\ninclude /etc/nginx/conf.c/*.conf;\n\nhttp {\n\t.....\n}\n```\n\n2、创建四层负载均衡配置的目录\n\n```shell\n[root@lb4-01 conf.c]# rm -f /etc/nginx/conf.d/default.conf   #删除http的80端口\n[root@lb4-01 ~]# mkdir /etc/nginx/conf.c\n[root@lb4-01 ~]# cd /etc/nginx/conf.c\n[root@lb4-01 conf.c]# cat lb_domain.conf \nstream {\n    upstream lb {\n        server 172.16.1.5:80 weight=5 max_fails=3 fail_timeout=30s;\n        server 172.16.1.6:80 weight=5 max_fails=3 fail_timeout=30s;\n    }\n\n    server {\n        listen 80;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass lb;\n    }\n}\n```\n\n3、重载服务\n\n```shell\n[root@lb4-01 conf.c]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@lb4-01 conf.c]# systemctl restart nginx\n[root@lb4-01 conf.c]# systemctl enable nginx\n```\n\n>报错：\n>\t[root@lb4-01 nginx]# nginx  -t\n>\tnginx: [emerg] unknown directive \"stream\" in /etc/nginx/conf.c/lb_domain.conf:1\n>\tnginx: configuration file /etc/nginx/nginx.conf test failed\n>解决方法：\n>\tyum install nginx-mod-stream.x86_64 -y\n\n>报错：\n>[root@lb4-01 nginx]# systemctl status nginx\n>nginx.service - The nginx HTTP and reverse proxy server\n>Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)\n>Active: failed (Result: exit-code) since Tue 2021-08-24 07:48:42 CST; 13s ago\n>Process: 2969 ExecStart=/usr/sbin/nginx (code=exited, status=1/FAILURE)\n>Process: 2967 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)\n>Process: 2965 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)\n>Main PID: 1959 (code=exited, status=0/SUCCESS)\n>\n>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)\n>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] still could not bind()\n>解决方法：\n>\t需要将[root@lb4-01 nginx]# vim /etc/nginx/nginx.conf\n>\t中默认的80端口改掉，比如改成81,这样才不冲突（奇怪。。）\n\n4、访问测试\n\n将Hosts中的对应网站地址的IP改成10.0.0.3，尝试访问，可以正常通过四层负载均衡来调度10.0.0.5和10.0.0.6七层负载均衡\n\n![image-20210824001613717](/img/image-20210824001613717.png)\n\n![image-20210824001638506](/img/image-20210824001638506.png)\n\n## 三、四层负载均衡日志\n\n### 3.1 配置过程\n\n在四层负载均衡中配置Nginx\n\n```shell\n[root@lb4-01 ~]# cat /etc/nginx/conf.c/lb_domain.conf\nstream {\n    log_format  proxy '$remote_addr $remote_port - [$time_local] $status $protocol '\n                  '\"$upstream_addr\" \"$upstream_bytes_sent\" \"$upstream_connect_time\"' ;\n    access_log /var/log/nginx/proxy.log proxy;\n\n    upstream lb {\n....\n```\n\n### 3.2 查看日志\n\n网页访问后，可见产生的日志\n\n```shell\n[root@lb4-01 ~]# tail -f /var/log/nginx/proxy.log\n10.0.0.1 56396 - [25/Aug/2021:19:25:33 +0800] 200 TCP \"172.16.1.5:80\" \"15150\" \"0.000\"\n10.0.0.1 59800 - [25/Aug/2021:19:25:34 +0800] 200 TCP \"172.16.1.6:80\" \"8327\" \"0.000\"\n10.0.0.1 63468 - [25/Aug/2021:19:25:34 +0800] 200 TCP \"172.16.1.5:80\" \"17882\" \"0.000\"\n10.0.0.1 50394 - [25/Aug/2021:19:25:35 +0800] 200 TCP \"172.16.1.5:80\" \"24490\" \"0.000\"\n10.0.0.1 55549 - [25/Aug/2021:19:25:35 +0800] 200 TCP \"172.16.1.5:80\" \"13201\" \"0.000\"\n10.0.0.1 64324 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"70995\" \"0.000\"\n10.0.0.1 64566 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"72650\" \"0.000\"\n10.0.0.1 65216 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"68171\" \"0.000\"\n10.0.0.1 49668 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.5:80\" \"82071\" \"0.004\"\n10.0.0.1 49745 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.5:80\" \"63941\" \"0.001\"\n10.0.0.1 50574 - [25/Aug/2021:19:25:42 +0800] 200 TCP \"172.16.1.6:80\" \"103581\" \"0.000\"\n```\n\n## 三、使用nginx四层负载均衡实现tcp的转发（跳板）\n\n实现跳板机的功能，比如：\n\n\t请求负载均衡 5555    --->     172.16.1.7:22;\n\t请求负载均衡 6666    --->     172.16.1.51:3306;\n\n### 3.1 配置过程\n\n配置Nginx\n\n```shell\n[root@lb4-01 ~]# cat /etc/nginx/conf.c/lb_domain.conf \nstream {\nlog_format  proxy '$remote_addr $remote_port - [$time_local] $status $protocol '\n                  '\"$upstream_addr\" \"$upstream_bytes_sent\" \"$upstream_connect_time\"' ;\n    access_log /var/log/nginx/proxy.log proxy;\n\n#定义转发ssh的22端口\n\tupstream ssh_7 {\n\t\tserver 10.0.0.7:22;\n\t}\n#定义转发mysql的3306端口\n\tupstream mysql_51 {\n\t\tserver 10.0.0.51:3306;\n\t}\n    server {\n        listen 5555;\n        proxy_connect_timeout 3s;\n        proxy_timeout 300s;\n        proxy_pass ssh_7;\n    }\n\n    server {\n        listen 6666;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass mysql_51;\n    }\n}\n```\n\n测试访问\n\n```shell\n# 连接web01\nssh root@10.0.0.3 -p 5555\n\n# 连接db01\nssh root@10.0.0.3 -p 6666\n```\n\n\n\n\n\n\n\n\n\n","slug":"01_运维/02-综合架构/14-Nginx(八)Nginx四层负载均衡","published":1,"updated":"2022-07-11T05:55:26.726Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0l0017a8v7a1g0cwr0","content":"<h2 id=\"一、Nginx四层负载均衡介绍\"><a href=\"#一、Nginx四层负载均衡介绍\" class=\"headerlink\" title=\"一、Nginx四层负载均衡介绍\"></a>一、Nginx四层负载均衡介绍</h2><p>四层负载均衡：（OSI传输层   ip:port）<br>    nginx1.9 版本加入<br>硬件：F5<br>软件：LVS、Haproxy、Nginx</p>\n<p>1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如:nginx就无法保证自己的服务高可用，需要依赖lvs或者keepalive来作。</p>\n<p>2.如:tcp协议的负载均衡，有些请求是TCP协议的(mysql、ssh)，或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。<br>    比如做：mysql读的负载均衡（轮询）<br>    比如做：端口映射、端口转发         tcp&#x2F;udp</p>\n<p>四层负载均衡总结<br>1.四层负载均衡仅能转发TCP&#x2F;IP协议、UDP协议，通常用来转发端口，如: tcp&#x2F;3306，tcp&#x2F;22，udp&#x2F;53。<br>2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）<br>3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）<br>4.四层的转发效率比七层的高的多，但仅支持tcp&#x2F;ip协议，不支持http或者https协议</p>\n<p><img src=\"/img/image-20210823230415237.png\" alt=\"image-20210823230415237\"></p>\n<h2 id=\"二、四层负载均衡配置\"><a href=\"#二、四层负载均衡配置\" class=\"headerlink\" title=\"二、四层负载均衡配置\"></a>二、四层负载均衡配置</h2><h3 id=\"2-1-环境准备\"><a href=\"#2-1-环境准备\" class=\"headerlink\" title=\"2.1 环境准备\"></a>2.1 环境准备</h3><table>\n<thead>\n<tr>\n<th>服务器名</th>\n<th>公网IP</th>\n<th>内网IP</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb4-01</td>\n<td>10.0.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>lb02</td>\n<td>10.0.0.6</td>\n<td>172.16.1.6</td>\n</tr>\n<tr>\n<td>web、nfs、mysql服务器若干</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-新增lb02负载均衡服务器\"><a href=\"#2-2-新增lb02负载均衡服务器\" class=\"headerlink\" title=\"2.2 新增lb02负载均衡服务器\"></a>2.2 新增lb02负载均衡服务器</h3><p>1、准备<code>lb02</code>，安装Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n[root@lb02 ~]#  yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、拷贝<code>lb01</code>的 Nginx配置到<code>lb02</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# scp -rp root@172.16.1.5:&#x2F;etc&#x2F;nginx &#x2F;etc&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、启动Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 conf.d]# nginx -t\n[root@lb02 conf.d]# systemctl start nginx\n[root@lb02 conf.d]# systemctl enable nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>报错：</p>\n<p>[root@lb02 ~]# nginx -t<br>nginx: [emerg] unknown directive “check” in &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf:4<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed<br>[root@lb02 ~]# vim &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf<br>[root@lb02 ~]# nginx -t<br>nginx: [emerg] unknown directive “check_status” in &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf:17<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed</p>\n<p>解决方法：</p>\n<p>因为lb01安装过第三方健康检查工具，而lb02上没有，先将这些报错点注释掉</p>\n</blockquote>\n<p>4、测试lb02是否正常</p>\n<p>将hosts中的10.0.0.5换成10.0.0.6，phpadmin、wordpress网页可以正常访问,<br>但是wecenter异常502 Bad Gateway<br>解决方法: 将web01、02上的的php.ini中的session.auto_start改为0,不然会502</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 php]# vim &#x2F;etc&#x2F;php.ini\nsession.auto_start &#x3D; 0\n[root@web01 php]# systemctl restart php-fpm.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>网上搜索的解释：<br>日常开发中，php.ini配置session.auto_start&#x3D;0默认关闭会话时如果想开启会话需要调用session_start：<br>session.auto_start 开启就自动完成了session_start()<br>区别就在于在用SESSION前是否需要session_start();<br>当session.auto_start &#x3D; on时，执行 session_start() 将产生新的 session_id<br>session.auto_start &#x3D; on 的优点在于，任何时候都不会因忘记执行 session_start() 或 session_start() 在程序里的位置不对，而导致错误<br>缺点在于，如果你使用的是第三方代码，则必须删去其中的全部 session_start() 。否则将不能得到正确的结果</p>\n</blockquote>\n<h3 id=\"2-3-配置四层负载均衡\"><a href=\"#2-3-配置四层负载均衡\" class=\"headerlink\" title=\"2.3 配置四层负载均衡\"></a>2.3 配置四层负载均衡</h3><p>1、新增<code>lb4-01</code>服务器，安装nginx</p>\n<blockquote>\n<p>nginx需要带–with-stream模块</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n[root@lb4-01 ~]#  yum install nginx -y\t\n[root@lb4-01 ~]# vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\nevents &#123;\n    ....\n&#125;\n\ninclude &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;*.conf;\n\nhttp &#123;\n\t.....\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建四层负载均衡配置的目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 conf.c]# rm -f &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf   #删除http的80端口\n[root@lb4-01 ~]# mkdir &#x2F;etc&#x2F;nginx&#x2F;conf.c\n[root@lb4-01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.c\n[root@lb4-01 conf.c]# cat lb_domain.conf \nstream &#123;\n    upstream lb &#123;\n        server 172.16.1.5:80 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n        server 172.16.1.6:80 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n    &#125;\n\n    server &#123;\n        listen 80;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass lb;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、重载服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 conf.c]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@lb4-01 conf.c]# systemctl restart nginx\n[root@lb4-01 conf.c]# systemctl enable nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>报错：<br>[root@lb4-01 nginx]# nginx  -t<br>nginx: [emerg] unknown directive “stream” in &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf:1<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed<br>解决方法：<br>yum install nginx-mod-stream.x86_64 -y</p>\n</blockquote>\n<blockquote>\n<p>报错：<br>[root@lb4-01 nginx]# systemctl status nginx<br>nginx.service - The nginx HTTP and reverse proxy server<br>Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service; enabled; vendor preset: disabled)<br>Active: failed (Result: exit-code) since Tue 2021-08-24 07:48:42 CST; 13s ago<br>Process: 2969 ExecStart&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx (code&#x3D;exited, status&#x3D;1&#x2F;FAILURE)<br>Process: 2967 ExecStartPre&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx -t (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)<br>Process: 2965 ExecStartPre&#x3D;&#x2F;usr&#x2F;bin&#x2F;rm -f &#x2F;run&#x2F;nginx.pid (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)<br>Main PID: 1959 (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</p>\n<p>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] still could not bind()<br>解决方法：<br>需要将[root@lb4-01 nginx]# vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf<br>中默认的80端口改掉，比如改成81,这样才不冲突（奇怪。。）</p>\n</blockquote>\n<p>4、访问测试</p>\n<p>将Hosts中的对应网站地址的IP改成10.0.0.3，尝试访问，可以正常通过四层负载均衡来调度10.0.0.5和10.0.0.6七层负载均衡</p>\n<p><img src=\"/img/image-20210824001613717.png\" alt=\"image-20210824001613717\"></p>\n<p><img src=\"/img/image-20210824001638506.png\" alt=\"image-20210824001638506\"></p>\n<h2 id=\"三、四层负载均衡日志\"><a href=\"#三、四层负载均衡日志\" class=\"headerlink\" title=\"三、四层负载均衡日志\"></a>三、四层负载均衡日志</h2><h3 id=\"3-1-配置过程\"><a href=\"#3-1-配置过程\" class=\"headerlink\" title=\"3.1 配置过程\"></a>3.1 配置过程</h3><p>在四层负载均衡中配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf\nstream &#123;\n    log_format  proxy &#39;$remote_addr $remote_port - [$time_local] $status $protocol &#39;\n                  &#39;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#39; ;\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log proxy;\n\n    upstream lb &#123;\n....<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-查看日志\"><a href=\"#3-2-查看日志\" class=\"headerlink\" title=\"3.2 查看日志\"></a>3.2 查看日志</h3><p>网页访问后，可见产生的日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log\n10.0.0.1 56396 - [25&#x2F;Aug&#x2F;2021:19:25:33 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;15150&quot; &quot;0.000&quot;\n10.0.0.1 59800 - [25&#x2F;Aug&#x2F;2021:19:25:34 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;8327&quot; &quot;0.000&quot;\n10.0.0.1 63468 - [25&#x2F;Aug&#x2F;2021:19:25:34 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;17882&quot; &quot;0.000&quot;\n10.0.0.1 50394 - [25&#x2F;Aug&#x2F;2021:19:25:35 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;24490&quot; &quot;0.000&quot;\n10.0.0.1 55549 - [25&#x2F;Aug&#x2F;2021:19:25:35 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;13201&quot; &quot;0.000&quot;\n10.0.0.1 64324 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;70995&quot; &quot;0.000&quot;\n10.0.0.1 64566 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;72650&quot; &quot;0.000&quot;\n10.0.0.1 65216 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;68171&quot; &quot;0.000&quot;\n10.0.0.1 49668 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;82071&quot; &quot;0.004&quot;\n10.0.0.1 49745 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;63941&quot; &quot;0.001&quot;\n10.0.0.1 50574 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;103581&quot; &quot;0.000&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、使用nginx四层负载均衡实现tcp的转发（跳板）\"><a href=\"#三、使用nginx四层负载均衡实现tcp的转发（跳板）\" class=\"headerlink\" title=\"三、使用nginx四层负载均衡实现tcp的转发（跳板）\"></a>三、使用nginx四层负载均衡实现tcp的转发（跳板）</h2><p>实现跳板机的功能，比如：</p>\n<pre><code>请求负载均衡 5555    ---&gt;     172.16.1.7:22;\n请求负载均衡 6666    ---&gt;     172.16.1.51:3306;\n</code></pre>\n<h3 id=\"3-1-配置过程-1\"><a href=\"#3-1-配置过程-1\" class=\"headerlink\" title=\"3.1 配置过程\"></a>3.1 配置过程</h3><p>配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf \nstream &#123;\nlog_format  proxy &#39;$remote_addr $remote_port - [$time_local] $status $protocol &#39;\n                  &#39;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#39; ;\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log proxy;\n\n#定义转发ssh的22端口\n\tupstream ssh_7 &#123;\n\t\tserver 10.0.0.7:22;\n\t&#125;\n#定义转发mysql的3306端口\n\tupstream mysql_51 &#123;\n\t\tserver 10.0.0.51:3306;\n\t&#125;\n    server &#123;\n        listen 5555;\n        proxy_connect_timeout 3s;\n        proxy_timeout 300s;\n        proxy_pass ssh_7;\n    &#125;\n\n    server &#123;\n        listen 6666;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass mysql_51;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 连接web01\nssh root@10.0.0.3 -p 5555\n\n# 连接db01\nssh root@10.0.0.3 -p 6666<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Nginx四层负载均衡介绍\"><a href=\"#一、Nginx四层负载均衡介绍\" class=\"headerlink\" title=\"一、Nginx四层负载均衡介绍\"></a>一、Nginx四层负载均衡介绍</h2><p>四层负载均衡：（OSI传输层   ip:port）<br>    nginx1.9 版本加入<br>硬件：F5<br>软件：LVS、Haproxy、Nginx</p>\n<p>1.四层+七层来作负载均衡，4层可以保证7层的负载均衡的高可用性。如:nginx就无法保证自己的服务高可用，需要依赖lvs或者keepalive来作。</p>\n<p>2.如:tcp协议的负载均衡，有些请求是TCP协议的(mysql、ssh)，或者说这些请求只需要使用4层进行端口的转发就可以了，所以使用4层负载均衡。<br>    比如做：mysql读的负载均衡（轮询）<br>    比如做：端口映射、端口转发         tcp&#x2F;udp</p>\n<p>四层负载均衡总结<br>1.四层负载均衡仅能转发TCP&#x2F;IP协议、UDP协议，通常用来转发端口，如: tcp&#x2F;3306，tcp&#x2F;22，udp&#x2F;53。<br>2.四层负载均衡可以用来解决七层负载均衡的端口限制问题。（七层负载均衡最大使用65535个端口号）<br>3.可以用来解决七层负载均衡的高可用问题。（多台后端七层负载均衡能同时的使用）<br>4.四层的转发效率比七层的高的多，但仅支持tcp&#x2F;ip协议，不支持http或者https协议</p>\n<p><img src=\"/img/image-20210823230415237.png\" alt=\"image-20210823230415237\"></p>\n<h2 id=\"二、四层负载均衡配置\"><a href=\"#二、四层负载均衡配置\" class=\"headerlink\" title=\"二、四层负载均衡配置\"></a>二、四层负载均衡配置</h2><h3 id=\"2-1-环境准备\"><a href=\"#2-1-环境准备\" class=\"headerlink\" title=\"2.1 环境准备\"></a>2.1 环境准备</h3><table>\n<thead>\n<tr>\n<th>服务器名</th>\n<th>公网IP</th>\n<th>内网IP</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb4-01</td>\n<td>10.0.0.3</td>\n<td></td>\n</tr>\n<tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n</tr>\n<tr>\n<td>lb02</td>\n<td>10.0.0.6</td>\n<td>172.16.1.6</td>\n</tr>\n<tr>\n<td>web、nfs、mysql服务器若干</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<h3 id=\"2-2-新增lb02负载均衡服务器\"><a href=\"#2-2-新增lb02负载均衡服务器\" class=\"headerlink\" title=\"2.2 新增lb02负载均衡服务器\"></a>2.2 新增lb02负载均衡服务器</h3><p>1、准备<code>lb02</code>，安装Nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n[root@lb02 ~]#  yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、拷贝<code>lb01</code>的 Nginx配置到<code>lb02</code></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 ~]# scp -rp root@172.16.1.5:&#x2F;etc&#x2F;nginx &#x2F;etc&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、启动Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb02 conf.d]# nginx -t\n[root@lb02 conf.d]# systemctl start nginx\n[root@lb02 conf.d]# systemctl enable nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>报错：</p>\n<p>[root@lb02 ~]# nginx -t<br>nginx: [emerg] unknown directive “check” in &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf:4<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed<br>[root@lb02 ~]# vim &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf<br>[root@lb02 ~]# nginx -t<br>nginx: [emerg] unknown directive “check_status” in &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_node.conf:17<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed</p>\n<p>解决方法：</p>\n<p>因为lb01安装过第三方健康检查工具，而lb02上没有，先将这些报错点注释掉</p>\n</blockquote>\n<p>4、测试lb02是否正常</p>\n<p>将hosts中的10.0.0.5换成10.0.0.6，phpadmin、wordpress网页可以正常访问,<br>但是wecenter异常502 Bad Gateway<br>解决方法: 将web01、02上的的php.ini中的session.auto_start改为0,不然会502</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 php]# vim &#x2F;etc&#x2F;php.ini\nsession.auto_start &#x3D; 0\n[root@web01 php]# systemctl restart php-fpm.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>网上搜索的解释：<br>日常开发中，php.ini配置session.auto_start&#x3D;0默认关闭会话时如果想开启会话需要调用session_start：<br>session.auto_start 开启就自动完成了session_start()<br>区别就在于在用SESSION前是否需要session_start();<br>当session.auto_start &#x3D; on时，执行 session_start() 将产生新的 session_id<br>session.auto_start &#x3D; on 的优点在于，任何时候都不会因忘记执行 session_start() 或 session_start() 在程序里的位置不对，而导致错误<br>缺点在于，如果你使用的是第三方代码，则必须删去其中的全部 session_start() 。否则将不能得到正确的结果</p>\n</blockquote>\n<h3 id=\"2-3-配置四层负载均衡\"><a href=\"#2-3-配置四层负载均衡\" class=\"headerlink\" title=\"2.3 配置四层负载均衡\"></a>2.3 配置四层负载均衡</h3><p>1、新增<code>lb4-01</code>服务器，安装nginx</p>\n<blockquote>\n<p>nginx需要带–with-stream模块</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;yum.repos.d&#x2F;nginx.repo \n[nginx]\nname&#x3D;nginx repo\nbaseurl&#x3D;http:&#x2F;&#x2F;nginx.org&#x2F;packages&#x2F;centos&#x2F;7&#x2F;$basearch&#x2F;\ngpgcheck&#x3D;0\nenabled&#x3D;1\n[root@lb4-01 ~]#  yum install nginx -y\t\n[root@lb4-01 ~]# vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\nevents &#123;\n    ....\n&#125;\n\ninclude &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;*.conf;\n\nhttp &#123;\n\t.....\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建四层负载均衡配置的目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 conf.c]# rm -f &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf   #删除http的80端口\n[root@lb4-01 ~]# mkdir &#x2F;etc&#x2F;nginx&#x2F;conf.c\n[root@lb4-01 ~]# cd &#x2F;etc&#x2F;nginx&#x2F;conf.c\n[root@lb4-01 conf.c]# cat lb_domain.conf \nstream &#123;\n    upstream lb &#123;\n        server 172.16.1.5:80 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n        server 172.16.1.6:80 weight&#x3D;5 max_fails&#x3D;3 fail_timeout&#x3D;30s;\n    &#125;\n\n    server &#123;\n        listen 80;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass lb;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、重载服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 conf.c]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@lb4-01 conf.c]# systemctl restart nginx\n[root@lb4-01 conf.c]# systemctl enable nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>报错：<br>[root@lb4-01 nginx]# nginx  -t<br>nginx: [emerg] unknown directive “stream” in &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf:1<br>nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed<br>解决方法：<br>yum install nginx-mod-stream.x86_64 -y</p>\n</blockquote>\n<blockquote>\n<p>报错：<br>[root@lb4-01 nginx]# systemctl status nginx<br>nginx.service - The nginx HTTP and reverse proxy server<br>Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;nginx.service; enabled; vendor preset: disabled)<br>Active: failed (Result: exit-code) since Tue 2021-08-24 07:48:42 CST; 13s ago<br>Process: 2969 ExecStart&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx (code&#x3D;exited, status&#x3D;1&#x2F;FAILURE)<br>Process: 2967 ExecStartPre&#x3D;&#x2F;usr&#x2F;sbin&#x2F;nginx -t (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)<br>Process: 2965 ExecStartPre&#x3D;&#x2F;usr&#x2F;bin&#x2F;rm -f &#x2F;run&#x2F;nginx.pid (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)<br>Main PID: 1959 (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)</p>\n<p>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:40 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:41 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)<br>Aug 24 07:48:42 lb4-01 nginx[2969]: nginx: [emerg] still could not bind()<br>解决方法：<br>需要将[root@lb4-01 nginx]# vim &#x2F;etc&#x2F;nginx&#x2F;nginx.conf<br>中默认的80端口改掉，比如改成81,这样才不冲突（奇怪。。）</p>\n</blockquote>\n<p>4、访问测试</p>\n<p>将Hosts中的对应网站地址的IP改成10.0.0.3，尝试访问，可以正常通过四层负载均衡来调度10.0.0.5和10.0.0.6七层负载均衡</p>\n<p><img src=\"/img/image-20210824001613717.png\" alt=\"image-20210824001613717\"></p>\n<p><img src=\"/img/image-20210824001638506.png\" alt=\"image-20210824001638506\"></p>\n<h2 id=\"三、四层负载均衡日志\"><a href=\"#三、四层负载均衡日志\" class=\"headerlink\" title=\"三、四层负载均衡日志\"></a>三、四层负载均衡日志</h2><h3 id=\"3-1-配置过程\"><a href=\"#3-1-配置过程\" class=\"headerlink\" title=\"3.1 配置过程\"></a>3.1 配置过程</h3><p>在四层负载均衡中配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf\nstream &#123;\n    log_format  proxy &#39;$remote_addr $remote_port - [$time_local] $status $protocol &#39;\n                  &#39;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#39; ;\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log proxy;\n\n    upstream lb &#123;\n....<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-查看日志\"><a href=\"#3-2-查看日志\" class=\"headerlink\" title=\"3.2 查看日志\"></a>3.2 查看日志</h3><p>网页访问后，可见产生的日志</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# tail -f &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log\n10.0.0.1 56396 - [25&#x2F;Aug&#x2F;2021:19:25:33 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;15150&quot; &quot;0.000&quot;\n10.0.0.1 59800 - [25&#x2F;Aug&#x2F;2021:19:25:34 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;8327&quot; &quot;0.000&quot;\n10.0.0.1 63468 - [25&#x2F;Aug&#x2F;2021:19:25:34 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;17882&quot; &quot;0.000&quot;\n10.0.0.1 50394 - [25&#x2F;Aug&#x2F;2021:19:25:35 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;24490&quot; &quot;0.000&quot;\n10.0.0.1 55549 - [25&#x2F;Aug&#x2F;2021:19:25:35 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;13201&quot; &quot;0.000&quot;\n10.0.0.1 64324 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;70995&quot; &quot;0.000&quot;\n10.0.0.1 64566 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;72650&quot; &quot;0.000&quot;\n10.0.0.1 65216 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;68171&quot; &quot;0.000&quot;\n10.0.0.1 49668 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;82071&quot; &quot;0.004&quot;\n10.0.0.1 49745 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.5:80&quot; &quot;63941&quot; &quot;0.001&quot;\n10.0.0.1 50574 - [25&#x2F;Aug&#x2F;2021:19:25:42 +0800] 200 TCP &quot;172.16.1.6:80&quot; &quot;103581&quot; &quot;0.000&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、使用nginx四层负载均衡实现tcp的转发（跳板）\"><a href=\"#三、使用nginx四层负载均衡实现tcp的转发（跳板）\" class=\"headerlink\" title=\"三、使用nginx四层负载均衡实现tcp的转发（跳板）\"></a>三、使用nginx四层负载均衡实现tcp的转发（跳板）</h2><p>实现跳板机的功能，比如：</p>\n<pre><code>请求负载均衡 5555    ---&gt;     172.16.1.7:22;\n请求负载均衡 6666    ---&gt;     172.16.1.51:3306;\n</code></pre>\n<h3 id=\"3-1-配置过程-1\"><a href=\"#3-1-配置过程-1\" class=\"headerlink\" title=\"3.1 配置过程\"></a>3.1 配置过程</h3><p>配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb4-01 ~]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.c&#x2F;lb_domain.conf \nstream &#123;\nlog_format  proxy &#39;$remote_addr $remote_port - [$time_local] $status $protocol &#39;\n                  &#39;&quot;$upstream_addr&quot; &quot;$upstream_bytes_sent&quot; &quot;$upstream_connect_time&quot;&#39; ;\n    access_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;proxy.log proxy;\n\n#定义转发ssh的22端口\n\tupstream ssh_7 &#123;\n\t\tserver 10.0.0.7:22;\n\t&#125;\n#定义转发mysql的3306端口\n\tupstream mysql_51 &#123;\n\t\tserver 10.0.0.51:3306;\n\t&#125;\n    server &#123;\n        listen 5555;\n        proxy_connect_timeout 3s;\n        proxy_timeout 300s;\n        proxy_pass ssh_7;\n    &#125;\n\n    server &#123;\n        listen 6666;\n        proxy_connect_timeout 3s;\n        proxy_timeout 3s;\n        proxy_pass mysql_51;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 连接web01\nssh root@10.0.0.3 -p 5555\n\n# 连接db01\nssh root@10.0.0.3 -p 6666<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n\n\n"},{"title":"运维之综合架构--07--Nginx(九)动静分离","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、动静分离介绍\n\n动静分离，通过中间件将动静分离和静态请求进⾏分离；\n通过中间件将动态请求和静态请求分离，可以建上不必要的请求消耗，同时能减少请求的延时。\n通过中间件将动态请求和静态请求分离，逻辑图如下:  \n\n## 二、单台服务器动静分离配置\n\n逻辑图如下：\n\n![单台服务器动静分离](/img/单台服务器动静分离.png)\n\n编辑Nginx配置文件\n\n```shell\n[root@web01 conf.d]vim blog.conf\nserver {\n    listen 80;\n    server_name blog.linux.com;\n    location / {\n    root /code/wordpress;\n    index index.php;\n}\n\n# 如果请求的是以.jpg结尾的静态⽂件 就去/code/images⽬录下访问\nlocation ~* \\.jpg$ {\n    root /code/images;\n    }\n    location ~* \\.php$ {\n    root /code/wordpress;\n    fastcgi_pass 127.0.0.1:9000;\n    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    include fastcgi_params;\n    }\n} \n\n# 创建⽬录\n[root@web01 conf.d]# mkdir /code/images/\n\n# 实现动静分离\n⽅式⼀：把⽂件挪到/code/images/\ncp -r /code/wordpress/wp-content /code/images/\n\n⽅式⼆：做软连接\ncd /code\nln -s wordpress images\n```\n\n## 三、多台服务器动静分离配置\n\n参考：https://www.cnblogs.com/backups/p/nginx10.html\n\n### 3.1 原理图\n\n![多台服务器动静分离](/img/多台服务器动静分离.png)\n\n### 3.2 实验环境准备\n\n| 主机  | 外网     | 内网       | 作用服务               |\n| ----- | -------- | ---------- | ---------------------- |\n| lb01  | 10.0.0.5 | 172.16.1.5 | 负载均衡 nginx proxy   |\n| web01 | 10.0.0.7 | 172.16.1.7 | 静态资源 nginx static  |\n| web02 | 10.0.0.8 | 172.16.1.8 | 动态资源 tomcat server |\n\n### 3.3 配置web01提供静态资源\n\n1、配置Nginx\n\n```shell\n[root@web01 images]# cat /etc/nginx/conf.d/jt.conf\n# 动静分离，web01提供静态文件服务\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n        \n        # 提供临时测试的域名\n        root /code/dongjing;\n        index index.html;\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                root /code/dongjing/images;\n        }\n}\n```\n\n2、上传静态资源，测试访问静态页面\n\n```shell\n[root@web01 ~]# echo \"web01...jingtai\" > /code/index.html\n[root@web01 ~]# mkdir /code/dongjing/images/ && cd /code/dongjing/images/\n[root@web01 images]# rz 1.jpg\n[root@web01 images]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 images]# systemctl reload nginx\n```\n\n`在客户端配置hosts，10.0.0.7 dongjing.gs.com`\n\n打开浏览器访问http://dongjing.gs.com\n\n![image-20210825141423629](/img/image-20210825141423629.png)\n\n打开浏览器访问http://dongjing.gs.com/1.png\n\n![image-20210825142256349](/img/image-20210825142256349.png)\n\n### 3.4 配置web02提供动态资源（tomcat + java模拟)\n\n1、安装Tomcat并添加jsp文件\n\n```shell\n[root@web02 ~]# yum install -y tomcat\n[root@web02 ~]# mkdir /usr/share/tomcat/webapps/ROOT\n[root@web02 ~]# cat >/usr/share/tomcat/webapps/ROOT/java_test.jsp <<EOF\n<%@ page language=\"java\" import=\"java.util.*\" pageEncoding=\"utf-8\"%>\n<HTML>\n    <HEAD>\n        <TITLE>oldboy JSP Page</TITLE>\n    </HEAD>\n    <BODY>\n        <%\n            Random rand = new Random();\n            out.println(\"<h1>随机数:<h1>\");\n            out.println(rand.nextInt(99)+100);\n        %>\n    </BODY>\n</HTML>\nEOF\n[root@web02 ~]# systemctl start tomcat\n```\n\n2、测试访问\n\n访问http://10.0.0.8:8080/java_test.jsp\n\n![image-20210825162829977](/img/image-20210825162829977.png)\n\n### 3.4 增加负载均衡，实现动静分离\n\n1、配置Nginx\n\n```shell\n[root@lb01 dongtai]# cat /etc/nginx/conf.d/proxy_dj.conf\nupstream jt {\n        server 172.16.1.7:80;\n}\n\nupstream dt {\n        server 172.16.1.8:8080;\n}\n\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                proxy_pass http://jt;\n                proxy_set_header HOST $http_host;\n        }\n\n        location ~ \\.jsp$ {\n                proxy_pass http://dt;\n                proxy_set_header HOST $http_host;\n        }\n}\n```\n\n2、测试访问\n\n`客户端配置hosts，10.0.0.3 dongjing.gs.com`\n\n在浏览器访问\n\nhttp://dongjing.gs.com/1.png\n\nhttp://10.0.0.8:8080/java_test.jsp\n\n的效果是一样的，但是访问http://dongjing.gs.com显示的是Nginx默认的主页，因为lb01中暂时没有对应文件夹的index.html\n\n### 3.5 在负载均衡上创建同时调用动态和静态资源的index.html\n\n1、修改Nginx配置\n\n```shell\n[root@lb01 dongtai]# cat /etc/nginx/conf.d/proxy_dj.conf\nupstream jt {\n        server 172.16.1.7:80;\n}\n\nupstream dt {\n        server 172.16.1.8:8080;\n}\n\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n\t\t\n\t\t# 新增\n        location / {\n                root /code/dongjing;\n                index index.html;\n        }\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                proxy_pass http://jt;\n                proxy_set_header HOST $http_host;\n        }\n\n        location ~ \\.jsp$ {\n                proxy_pass http://dt;\n                proxy_set_header HOST $http_host;\n        }\n}\n```\n\n2、创建对应的目录和页面\n\n```shell\n[root@lb01 /]# mkdir /code/dongjing\n[root@lb01 /]# cat /code/dongjing/index.html\n<html lang=\"en\">\n<head>\n        <meta charset=\"UTF-8\" />\n        <title>测试ajax和跨域访问</title>\n        <script src=\"http://libs.baidu.com/jquery/2.1.4/jquery.min.js\"></script>\n</head>\n<script type=\"text/javascript\">\n$(document).ready(function(){\n        $.ajax({\n        type: \"GET\",\n        url: \"http://dongjing.gs.com/java_test.jsp\",\n        success: function(data){\n                $(\"#get_data\").html(data)\n        },\n        error: function() {\n                alert(\"哎呦喂,失败了,回去检查你服务去~\");\n        }\n        });\n});\n</script>\n<body>\n        <h1>测试动静分离</h1>\n        <div id=\"get_data\"></div>\n        <img src=\"http://dongjing.gs.com/1.png\">\n</body>\n</html>\n```\n\n3、测试访问\n\n浏览器访问：http://dongjing.gs.com\n\n![image-20210825143746986](/img/image-20210825143746986.png)\n\n正常负载均衡的现象：\n\n```shell\n关掉web02的Tomcat服务，web01服务正常\n\n​\thttp://dongjing.gs.com可以正常打开，图片正常显示，随机数将显示异常\n\nweb02的Tomcat服务正常，关掉web01的nginx服务\n\n​\thttp://dongjing.gs.com可以正常打开，图片显示异常，随机正常显示\n```\n\n## 四、综合案例-Nginx资源分离\n\n### 4.1 什么是资源分离？\n\n```shell\n根据浏览器Agent标识可以访问到不同的页面资源：\n比如：\n    Android访问到的是Android的页面\n    PC访问到的是PC的页面\n    iphone访问放到的是iphone的页面\n```\n\n### 4.2 实验环境准备\n\n| 主机  | 外网     | 内网       | 作用服务             |\n| ----- | -------- | ---------- | -------------------- |\n| lb01  | 10.0.0.5 | 172.16.1.5 | 负载均衡 nginx proxy |\n| web01 | 10.0.0.7 | 172.16.1.7 | 提供Android手机页面  |\n| web02 | 10.0.0.8 | 172.16.1.8 | 提供PC访问页面       |\n\n","source":"_posts/01_运维/02-综合架构/15-Nginx(九)动静分离和rewrite.md","raw":"---\ntitle: 运维之综合架构--07--Nginx(九)动静分离\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （二）综合架构\ntags:\n---\n\n## 一、动静分离介绍\n\n动静分离，通过中间件将动静分离和静态请求进⾏分离；\n通过中间件将动态请求和静态请求分离，可以建上不必要的请求消耗，同时能减少请求的延时。\n通过中间件将动态请求和静态请求分离，逻辑图如下:  \n\n## 二、单台服务器动静分离配置\n\n逻辑图如下：\n\n![单台服务器动静分离](/img/单台服务器动静分离.png)\n\n编辑Nginx配置文件\n\n```shell\n[root@web01 conf.d]vim blog.conf\nserver {\n    listen 80;\n    server_name blog.linux.com;\n    location / {\n    root /code/wordpress;\n    index index.php;\n}\n\n# 如果请求的是以.jpg结尾的静态⽂件 就去/code/images⽬录下访问\nlocation ~* \\.jpg$ {\n    root /code/images;\n    }\n    location ~* \\.php$ {\n    root /code/wordpress;\n    fastcgi_pass 127.0.0.1:9000;\n    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    include fastcgi_params;\n    }\n} \n\n# 创建⽬录\n[root@web01 conf.d]# mkdir /code/images/\n\n# 实现动静分离\n⽅式⼀：把⽂件挪到/code/images/\ncp -r /code/wordpress/wp-content /code/images/\n\n⽅式⼆：做软连接\ncd /code\nln -s wordpress images\n```\n\n## 三、多台服务器动静分离配置\n\n参考：https://www.cnblogs.com/backups/p/nginx10.html\n\n### 3.1 原理图\n\n![多台服务器动静分离](/img/多台服务器动静分离.png)\n\n### 3.2 实验环境准备\n\n| 主机  | 外网     | 内网       | 作用服务               |\n| ----- | -------- | ---------- | ---------------------- |\n| lb01  | 10.0.0.5 | 172.16.1.5 | 负载均衡 nginx proxy   |\n| web01 | 10.0.0.7 | 172.16.1.7 | 静态资源 nginx static  |\n| web02 | 10.0.0.8 | 172.16.1.8 | 动态资源 tomcat server |\n\n### 3.3 配置web01提供静态资源\n\n1、配置Nginx\n\n```shell\n[root@web01 images]# cat /etc/nginx/conf.d/jt.conf\n# 动静分离，web01提供静态文件服务\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n        \n        # 提供临时测试的域名\n        root /code/dongjing;\n        index index.html;\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                root /code/dongjing/images;\n        }\n}\n```\n\n2、上传静态资源，测试访问静态页面\n\n```shell\n[root@web01 ~]# echo \"web01...jingtai\" > /code/index.html\n[root@web01 ~]# mkdir /code/dongjing/images/ && cd /code/dongjing/images/\n[root@web01 images]# rz 1.jpg\n[root@web01 images]# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n[root@web01 images]# systemctl reload nginx\n```\n\n`在客户端配置hosts，10.0.0.7 dongjing.gs.com`\n\n打开浏览器访问http://dongjing.gs.com\n\n![image-20210825141423629](/img/image-20210825141423629.png)\n\n打开浏览器访问http://dongjing.gs.com/1.png\n\n![image-20210825142256349](/img/image-20210825142256349.png)\n\n### 3.4 配置web02提供动态资源（tomcat + java模拟)\n\n1、安装Tomcat并添加jsp文件\n\n```shell\n[root@web02 ~]# yum install -y tomcat\n[root@web02 ~]# mkdir /usr/share/tomcat/webapps/ROOT\n[root@web02 ~]# cat >/usr/share/tomcat/webapps/ROOT/java_test.jsp <<EOF\n<%@ page language=\"java\" import=\"java.util.*\" pageEncoding=\"utf-8\"%>\n<HTML>\n    <HEAD>\n        <TITLE>oldboy JSP Page</TITLE>\n    </HEAD>\n    <BODY>\n        <%\n            Random rand = new Random();\n            out.println(\"<h1>随机数:<h1>\");\n            out.println(rand.nextInt(99)+100);\n        %>\n    </BODY>\n</HTML>\nEOF\n[root@web02 ~]# systemctl start tomcat\n```\n\n2、测试访问\n\n访问http://10.0.0.8:8080/java_test.jsp\n\n![image-20210825162829977](/img/image-20210825162829977.png)\n\n### 3.4 增加负载均衡，实现动静分离\n\n1、配置Nginx\n\n```shell\n[root@lb01 dongtai]# cat /etc/nginx/conf.d/proxy_dj.conf\nupstream jt {\n        server 172.16.1.7:80;\n}\n\nupstream dt {\n        server 172.16.1.8:8080;\n}\n\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                proxy_pass http://jt;\n                proxy_set_header HOST $http_host;\n        }\n\n        location ~ \\.jsp$ {\n                proxy_pass http://dt;\n                proxy_set_header HOST $http_host;\n        }\n}\n```\n\n2、测试访问\n\n`客户端配置hosts，10.0.0.3 dongjing.gs.com`\n\n在浏览器访问\n\nhttp://dongjing.gs.com/1.png\n\nhttp://10.0.0.8:8080/java_test.jsp\n\n的效果是一样的，但是访问http://dongjing.gs.com显示的是Nginx默认的主页，因为lb01中暂时没有对应文件夹的index.html\n\n### 3.5 在负载均衡上创建同时调用动态和静态资源的index.html\n\n1、修改Nginx配置\n\n```shell\n[root@lb01 dongtai]# cat /etc/nginx/conf.d/proxy_dj.conf\nupstream jt {\n        server 172.16.1.7:80;\n}\n\nupstream dt {\n        server 172.16.1.8:8080;\n}\n\nserver {\n        listen 80;\n        server_name dongjing.gs.com;\n\t\t\n\t\t# 新增\n        location / {\n                root /code/dongjing;\n                index index.html;\n        }\n\n        location ~* ^.*\\.(jpg|png|gif)$ {\n                proxy_pass http://jt;\n                proxy_set_header HOST $http_host;\n        }\n\n        location ~ \\.jsp$ {\n                proxy_pass http://dt;\n                proxy_set_header HOST $http_host;\n        }\n}\n```\n\n2、创建对应的目录和页面\n\n```shell\n[root@lb01 /]# mkdir /code/dongjing\n[root@lb01 /]# cat /code/dongjing/index.html\n<html lang=\"en\">\n<head>\n        <meta charset=\"UTF-8\" />\n        <title>测试ajax和跨域访问</title>\n        <script src=\"http://libs.baidu.com/jquery/2.1.4/jquery.min.js\"></script>\n</head>\n<script type=\"text/javascript\">\n$(document).ready(function(){\n        $.ajax({\n        type: \"GET\",\n        url: \"http://dongjing.gs.com/java_test.jsp\",\n        success: function(data){\n                $(\"#get_data\").html(data)\n        },\n        error: function() {\n                alert(\"哎呦喂,失败了,回去检查你服务去~\");\n        }\n        });\n});\n</script>\n<body>\n        <h1>测试动静分离</h1>\n        <div id=\"get_data\"></div>\n        <img src=\"http://dongjing.gs.com/1.png\">\n</body>\n</html>\n```\n\n3、测试访问\n\n浏览器访问：http://dongjing.gs.com\n\n![image-20210825143746986](/img/image-20210825143746986.png)\n\n正常负载均衡的现象：\n\n```shell\n关掉web02的Tomcat服务，web01服务正常\n\n​\thttp://dongjing.gs.com可以正常打开，图片正常显示，随机数将显示异常\n\nweb02的Tomcat服务正常，关掉web01的nginx服务\n\n​\thttp://dongjing.gs.com可以正常打开，图片显示异常，随机正常显示\n```\n\n## 四、综合案例-Nginx资源分离\n\n### 4.1 什么是资源分离？\n\n```shell\n根据浏览器Agent标识可以访问到不同的页面资源：\n比如：\n    Android访问到的是Android的页面\n    PC访问到的是PC的页面\n    iphone访问放到的是iphone的页面\n```\n\n### 4.2 实验环境准备\n\n| 主机  | 外网     | 内网       | 作用服务             |\n| ----- | -------- | ---------- | -------------------- |\n| lb01  | 10.0.0.5 | 172.16.1.5 | 负载均衡 nginx proxy |\n| web01 | 10.0.0.7 | 172.16.1.7 | 提供Android手机页面  |\n| web02 | 10.0.0.8 | 172.16.1.8 | 提供PC访问页面       |\n\n","slug":"01_运维/02-综合架构/15-Nginx(九)动静分离和rewrite","published":1,"updated":"2022-07-11T05:55:46.377Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0m0018a8v7f6d43f5t","content":"<h2 id=\"一、动静分离介绍\"><a href=\"#一、动静分离介绍\" class=\"headerlink\" title=\"一、动静分离介绍\"></a>一、动静分离介绍</h2><p>动静分离，通过中间件将动静分离和静态请求进⾏分离；<br>通过中间件将动态请求和静态请求分离，可以建上不必要的请求消耗，同时能减少请求的延时。<br>通过中间件将动态请求和静态请求分离，逻辑图如下:  </p>\n<h2 id=\"二、单台服务器动静分离配置\"><a href=\"#二、单台服务器动静分离配置\" class=\"headerlink\" title=\"二、单台服务器动静分离配置\"></a>二、单台服务器动静分离配置</h2><p>逻辑图如下：</p>\n<p><img src=\"/img/%E5%8D%95%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png\" alt=\"单台服务器动静分离\"></p>\n<p>编辑Nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]vim blog.conf\nserver &#123;\n    listen 80;\n    server_name blog.linux.com;\n    location &#x2F; &#123;\n    root &#x2F;code&#x2F;wordpress;\n    index index.php;\n&#125;\n\n# 如果请求的是以.jpg结尾的静态⽂件 就去&#x2F;code&#x2F;images⽬录下访问\nlocation ~* \\.jpg$ &#123;\n    root &#x2F;code&#x2F;images;\n    &#125;\n    location ~* \\.php$ &#123;\n    root &#x2F;code&#x2F;wordpress;\n    fastcgi_pass 127.0.0.1:9000;\n    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    include fastcgi_params;\n    &#125;\n&#125; \n\n# 创建⽬录\n[root@web01 conf.d]# mkdir &#x2F;code&#x2F;images&#x2F;\n\n# 实现动静分离\n⽅式⼀：把⽂件挪到&#x2F;code&#x2F;images&#x2F;\ncp -r &#x2F;code&#x2F;wordpress&#x2F;wp-content &#x2F;code&#x2F;images&#x2F;\n\n⽅式⼆：做软连接\ncd &#x2F;code\nln -s wordpress images<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、多台服务器动静分离配置\"><a href=\"#三、多台服务器动静分离配置\" class=\"headerlink\" title=\"三、多台服务器动静分离配置\"></a>三、多台服务器动静分离配置</h2><p>参考：<a href=\"https://www.cnblogs.com/backups/p/nginx10.html\">https://www.cnblogs.com/backups/p/nginx10.html</a></p>\n<h3 id=\"3-1-原理图\"><a href=\"#3-1-原理图\" class=\"headerlink\" title=\"3.1 原理图\"></a>3.1 原理图</h3><p><img src=\"/img/%E5%A4%9A%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png\" alt=\"多台服务器动静分离\"></p>\n<h3 id=\"3-2-实验环境准备\"><a href=\"#3-2-实验环境准备\" class=\"headerlink\" title=\"3.2 实验环境准备\"></a>3.2 实验环境准备</h3><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>外网</th>\n<th>内网</th>\n<th>作用服务</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n<td>负载均衡 nginx proxy</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n<td>静态资源 nginx static</td>\n</tr>\n<tr>\n<td>web02</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n<td>动态资源 tomcat server</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-3-配置web01提供静态资源\"><a href=\"#3-3-配置web01提供静态资源\" class=\"headerlink\" title=\"3.3 配置web01提供静态资源\"></a>3.3 配置web01提供静态资源</h3><p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 images]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;jt.conf\n# 动静分离，web01提供静态文件服务\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n        \n        # 提供临时测试的域名\n        root &#x2F;code&#x2F;dongjing;\n        index index.html;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                root &#x2F;code&#x2F;dongjing&#x2F;images;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、上传静态资源，测试访问静态页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# echo &quot;web01...jingtai&quot; &gt; &#x2F;code&#x2F;index.html\n[root@web01 ~]# mkdir &#x2F;code&#x2F;dongjing&#x2F;images&#x2F; &amp;&amp; cd &#x2F;code&#x2F;dongjing&#x2F;images&#x2F;\n[root@web01 images]# rz 1.jpg\n[root@web01 images]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 images]# systemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><code>在客户端配置hosts，10.0.0.7 dongjing.gs.com</code></p>\n<p>打开浏览器访问<a href=\"http://dongjing.gs.com/\">http://dongjing.gs.com</a></p>\n<p><img src=\"/img/image-20210825141423629.png\" alt=\"image-20210825141423629\"></p>\n<p>打开浏览器访问<a href=\"http://dongjing.gs.com/1.png\">http://dongjing.gs.com/1.png</a></p>\n<p><img src=\"/img/image-20210825142256349.png\" alt=\"image-20210825142256349\"></p>\n<h3 id=\"3-4-配置web02提供动态资源（tomcat-java模拟\"><a href=\"#3-4-配置web02提供动态资源（tomcat-java模拟\" class=\"headerlink\" title=\"3.4 配置web02提供动态资源（tomcat + java模拟)\"></a>3.4 配置web02提供动态资源（tomcat + java模拟)</h3><p>1、安装Tomcat并添加jsp文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 ~]# yum install -y tomcat\n[root@web02 ~]# mkdir &#x2F;usr&#x2F;share&#x2F;tomcat&#x2F;webapps&#x2F;ROOT\n[root@web02 ~]# cat &gt;&#x2F;usr&#x2F;share&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;java_test.jsp &lt;&lt;EOF\n&lt;%@ page language&#x3D;&quot;java&quot; import&#x3D;&quot;java.util.*&quot; pageEncoding&#x3D;&quot;utf-8&quot;%&gt;\n&lt;HTML&gt;\n    &lt;HEAD&gt;\n        &lt;TITLE&gt;oldboy JSP Page&lt;&#x2F;TITLE&gt;\n    &lt;&#x2F;HEAD&gt;\n    &lt;BODY&gt;\n        &lt;%\n            Random rand &#x3D; new Random();\n            out.println(&quot;&lt;h1&gt;随机数:&lt;h1&gt;&quot;);\n            out.println(rand.nextInt(99)+100);\n        %&gt;\n    &lt;&#x2F;BODY&gt;\n&lt;&#x2F;HTML&gt;\nEOF\n[root@web02 ~]# systemctl start tomcat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、测试访问</p>\n<p>访问<a href=\"http://10.0.0.8:8080/java_test.jsp\">http://10.0.0.8:8080/java_test.jsp</a></p>\n<p><img src=\"/img/image-20210825162829977.png\" alt=\"image-20210825162829977\"></p>\n<h3 id=\"3-4-增加负载均衡，实现动静分离\"><a href=\"#3-4-增加负载均衡，实现动静分离\" class=\"headerlink\" title=\"3.4 增加负载均衡，实现动静分离\"></a>3.4 增加负载均衡，实现动静分离</h3><p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 dongtai]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_dj.conf\nupstream jt &#123;\n        server 172.16.1.7:80;\n&#125;\n\nupstream dt &#123;\n        server 172.16.1.8:8080;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                proxy_pass http:&#x2F;&#x2F;jt;\n                proxy_set_header HOST $http_host;\n        &#125;\n\n        location ~ \\.jsp$ &#123;\n                proxy_pass http:&#x2F;&#x2F;dt;\n                proxy_set_header HOST $http_host;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、测试访问</p>\n<p><code>客户端配置hosts，10.0.0.3 dongjing.gs.com</code></p>\n<p>在浏览器访问</p>\n<p><a href=\"http://dongjing.gs.com/1.png\">http://dongjing.gs.com/1.png</a></p>\n<p><a href=\"http://10.0.0.8:8080/java_test.jsp\">http://10.0.0.8:8080/java_test.jsp</a></p>\n<p>的效果是一样的，但是访问<a href=\"http://dongjing.gs.com显示的是nginx默认的主页,因为lb01中暂时没有对应文件夹的index.html/\">http://dongjing.gs.com显示的是Nginx默认的主页，因为lb01中暂时没有对应文件夹的index.html</a></p>\n<h3 id=\"3-5-在负载均衡上创建同时调用动态和静态资源的index-html\"><a href=\"#3-5-在负载均衡上创建同时调用动态和静态资源的index-html\" class=\"headerlink\" title=\"3.5 在负载均衡上创建同时调用动态和静态资源的index.html\"></a>3.5 在负载均衡上创建同时调用动态和静态资源的index.html</h3><p>1、修改Nginx配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 dongtai]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_dj.conf\nupstream jt &#123;\n        server 172.16.1.7:80;\n&#125;\n\nupstream dt &#123;\n        server 172.16.1.8:8080;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n\t\t\n\t\t# 新增\n        location &#x2F; &#123;\n                root &#x2F;code&#x2F;dongjing;\n                index index.html;\n        &#125;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                proxy_pass http:&#x2F;&#x2F;jt;\n                proxy_set_header HOST $http_host;\n        &#125;\n\n        location ~ \\.jsp$ &#123;\n                proxy_pass http:&#x2F;&#x2F;dt;\n                proxy_set_header HOST $http_host;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建对应的目录和页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 &#x2F;]# mkdir &#x2F;code&#x2F;dongjing\n[root@lb01 &#x2F;]# cat &#x2F;code&#x2F;dongjing&#x2F;index.html\n&lt;html lang&#x3D;&quot;en&quot;&gt;\n&lt;head&gt;\n        &lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;\n        &lt;title&gt;测试ajax和跨域访问&lt;&#x2F;title&gt;\n        &lt;script src&#x3D;&quot;http:&#x2F;&#x2F;libs.baidu.com&#x2F;jquery&#x2F;2.1.4&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;\n&lt;&#x2F;head&gt;\n&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;\n$(document).ready(function()&#123;\n        $.ajax(&#123;\n        type: &quot;GET&quot;,\n        url: &quot;http:&#x2F;&#x2F;dongjing.gs.com&#x2F;java_test.jsp&quot;,\n        success: function(data)&#123;\n                $(&quot;#get_data&quot;).html(data)\n        &#125;,\n        error: function() &#123;\n                alert(&quot;哎呦喂,失败了,回去检查你服务去~&quot;);\n        &#125;\n        &#125;);\n&#125;);\n&lt;&#x2F;script&gt;\n&lt;body&gt;\n        &lt;h1&gt;测试动静分离&lt;&#x2F;h1&gt;\n        &lt;div id&#x3D;&quot;get_data&quot;&gt;&lt;&#x2F;div&gt;\n        &lt;img src&#x3D;&quot;http:&#x2F;&#x2F;dongjing.gs.com&#x2F;1.png&quot;&gt;\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、测试访问</p>\n<p>浏览器访问：<a href=\"http://dongjing.gs.com/\">http://dongjing.gs.com</a></p>\n<p><img src=\"/img/image-20210825143746986.png\" alt=\"image-20210825143746986\"></p>\n<p>正常负载均衡的现象：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">关掉web02的Tomcat服务，web01服务正常\n\n​\thttp:&#x2F;&#x2F;dongjing.gs.com可以正常打开，图片正常显示，随机数将显示异常\n\nweb02的Tomcat服务正常，关掉web01的nginx服务\n\n​\thttp:&#x2F;&#x2F;dongjing.gs.com可以正常打开，图片显示异常，随机正常显示<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、综合案例-Nginx资源分离\"><a href=\"#四、综合案例-Nginx资源分离\" class=\"headerlink\" title=\"四、综合案例-Nginx资源分离\"></a>四、综合案例-Nginx资源分离</h2><h3 id=\"4-1-什么是资源分离？\"><a href=\"#4-1-什么是资源分离？\" class=\"headerlink\" title=\"4.1 什么是资源分离？\"></a>4.1 什么是资源分离？</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">根据浏览器Agent标识可以访问到不同的页面资源：\n比如：\n    Android访问到的是Android的页面\n    PC访问到的是PC的页面\n    iphone访问放到的是iphone的页面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-实验环境准备\"><a href=\"#4-2-实验环境准备\" class=\"headerlink\" title=\"4.2 实验环境准备\"></a>4.2 实验环境准备</h3><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>外网</th>\n<th>内网</th>\n<th>作用服务</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n<td>负载均衡 nginx proxy</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n<td>提供Android手机页面</td>\n</tr>\n<tr>\n<td>web02</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n<td>提供PC访问页面</td>\n</tr>\n</tbody></table>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、动静分离介绍\"><a href=\"#一、动静分离介绍\" class=\"headerlink\" title=\"一、动静分离介绍\"></a>一、动静分离介绍</h2><p>动静分离，通过中间件将动静分离和静态请求进⾏分离；<br>通过中间件将动态请求和静态请求分离，可以建上不必要的请求消耗，同时能减少请求的延时。<br>通过中间件将动态请求和静态请求分离，逻辑图如下:  </p>\n<h2 id=\"二、单台服务器动静分离配置\"><a href=\"#二、单台服务器动静分离配置\" class=\"headerlink\" title=\"二、单台服务器动静分离配置\"></a>二、单台服务器动静分离配置</h2><p>逻辑图如下：</p>\n<p><img src=\"/img/%E5%8D%95%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png\" alt=\"单台服务器动静分离\"></p>\n<p>编辑Nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 conf.d]vim blog.conf\nserver &#123;\n    listen 80;\n    server_name blog.linux.com;\n    location &#x2F; &#123;\n    root &#x2F;code&#x2F;wordpress;\n    index index.php;\n&#125;\n\n# 如果请求的是以.jpg结尾的静态⽂件 就去&#x2F;code&#x2F;images⽬录下访问\nlocation ~* \\.jpg$ &#123;\n    root &#x2F;code&#x2F;images;\n    &#125;\n    location ~* \\.php$ &#123;\n    root &#x2F;code&#x2F;wordpress;\n    fastcgi_pass 127.0.0.1:9000;\n    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n    include fastcgi_params;\n    &#125;\n&#125; \n\n# 创建⽬录\n[root@web01 conf.d]# mkdir &#x2F;code&#x2F;images&#x2F;\n\n# 实现动静分离\n⽅式⼀：把⽂件挪到&#x2F;code&#x2F;images&#x2F;\ncp -r &#x2F;code&#x2F;wordpress&#x2F;wp-content &#x2F;code&#x2F;images&#x2F;\n\n⽅式⼆：做软连接\ncd &#x2F;code\nln -s wordpress images<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、多台服务器动静分离配置\"><a href=\"#三、多台服务器动静分离配置\" class=\"headerlink\" title=\"三、多台服务器动静分离配置\"></a>三、多台服务器动静分离配置</h2><p>参考：<a href=\"https://www.cnblogs.com/backups/p/nginx10.html\">https://www.cnblogs.com/backups/p/nginx10.html</a></p>\n<h3 id=\"3-1-原理图\"><a href=\"#3-1-原理图\" class=\"headerlink\" title=\"3.1 原理图\"></a>3.1 原理图</h3><p><img src=\"/img/%E5%A4%9A%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.png\" alt=\"多台服务器动静分离\"></p>\n<h3 id=\"3-2-实验环境准备\"><a href=\"#3-2-实验环境准备\" class=\"headerlink\" title=\"3.2 实验环境准备\"></a>3.2 实验环境准备</h3><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>外网</th>\n<th>内网</th>\n<th>作用服务</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n<td>负载均衡 nginx proxy</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n<td>静态资源 nginx static</td>\n</tr>\n<tr>\n<td>web02</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n<td>动态资源 tomcat server</td>\n</tr>\n</tbody></table>\n<h3 id=\"3-3-配置web01提供静态资源\"><a href=\"#3-3-配置web01提供静态资源\" class=\"headerlink\" title=\"3.3 配置web01提供静态资源\"></a>3.3 配置web01提供静态资源</h3><p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 images]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;jt.conf\n# 动静分离，web01提供静态文件服务\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n        \n        # 提供临时测试的域名\n        root &#x2F;code&#x2F;dongjing;\n        index index.html;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                root &#x2F;code&#x2F;dongjing&#x2F;images;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、上传静态资源，测试访问静态页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web01 ~]# echo &quot;web01...jingtai&quot; &gt; &#x2F;code&#x2F;index.html\n[root@web01 ~]# mkdir &#x2F;code&#x2F;dongjing&#x2F;images&#x2F; &amp;&amp; cd &#x2F;code&#x2F;dongjing&#x2F;images&#x2F;\n[root@web01 images]# rz 1.jpg\n[root@web01 images]# nginx -t\nnginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok\nnginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test is successful\n[root@web01 images]# systemctl reload nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><code>在客户端配置hosts，10.0.0.7 dongjing.gs.com</code></p>\n<p>打开浏览器访问<a href=\"http://dongjing.gs.com/\">http://dongjing.gs.com</a></p>\n<p><img src=\"/img/image-20210825141423629.png\" alt=\"image-20210825141423629\"></p>\n<p>打开浏览器访问<a href=\"http://dongjing.gs.com/1.png\">http://dongjing.gs.com/1.png</a></p>\n<p><img src=\"/img/image-20210825142256349.png\" alt=\"image-20210825142256349\"></p>\n<h3 id=\"3-4-配置web02提供动态资源（tomcat-java模拟\"><a href=\"#3-4-配置web02提供动态资源（tomcat-java模拟\" class=\"headerlink\" title=\"3.4 配置web02提供动态资源（tomcat + java模拟)\"></a>3.4 配置web02提供动态资源（tomcat + java模拟)</h3><p>1、安装Tomcat并添加jsp文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@web02 ~]# yum install -y tomcat\n[root@web02 ~]# mkdir &#x2F;usr&#x2F;share&#x2F;tomcat&#x2F;webapps&#x2F;ROOT\n[root@web02 ~]# cat &gt;&#x2F;usr&#x2F;share&#x2F;tomcat&#x2F;webapps&#x2F;ROOT&#x2F;java_test.jsp &lt;&lt;EOF\n&lt;%@ page language&#x3D;&quot;java&quot; import&#x3D;&quot;java.util.*&quot; pageEncoding&#x3D;&quot;utf-8&quot;%&gt;\n&lt;HTML&gt;\n    &lt;HEAD&gt;\n        &lt;TITLE&gt;oldboy JSP Page&lt;&#x2F;TITLE&gt;\n    &lt;&#x2F;HEAD&gt;\n    &lt;BODY&gt;\n        &lt;%\n            Random rand &#x3D; new Random();\n            out.println(&quot;&lt;h1&gt;随机数:&lt;h1&gt;&quot;);\n            out.println(rand.nextInt(99)+100);\n        %&gt;\n    &lt;&#x2F;BODY&gt;\n&lt;&#x2F;HTML&gt;\nEOF\n[root@web02 ~]# systemctl start tomcat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、测试访问</p>\n<p>访问<a href=\"http://10.0.0.8:8080/java_test.jsp\">http://10.0.0.8:8080/java_test.jsp</a></p>\n<p><img src=\"/img/image-20210825162829977.png\" alt=\"image-20210825162829977\"></p>\n<h3 id=\"3-4-增加负载均衡，实现动静分离\"><a href=\"#3-4-增加负载均衡，实现动静分离\" class=\"headerlink\" title=\"3.4 增加负载均衡，实现动静分离\"></a>3.4 增加负载均衡，实现动静分离</h3><p>1、配置Nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 dongtai]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_dj.conf\nupstream jt &#123;\n        server 172.16.1.7:80;\n&#125;\n\nupstream dt &#123;\n        server 172.16.1.8:8080;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                proxy_pass http:&#x2F;&#x2F;jt;\n                proxy_set_header HOST $http_host;\n        &#125;\n\n        location ~ \\.jsp$ &#123;\n                proxy_pass http:&#x2F;&#x2F;dt;\n                proxy_set_header HOST $http_host;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、测试访问</p>\n<p><code>客户端配置hosts，10.0.0.3 dongjing.gs.com</code></p>\n<p>在浏览器访问</p>\n<p><a href=\"http://dongjing.gs.com/1.png\">http://dongjing.gs.com/1.png</a></p>\n<p><a href=\"http://10.0.0.8:8080/java_test.jsp\">http://10.0.0.8:8080/java_test.jsp</a></p>\n<p>的效果是一样的，但是访问<a href=\"http://dongjing.gs.com显示的是nginx默认的主页,因为lb01中暂时没有对应文件夹的index.html/\">http://dongjing.gs.com显示的是Nginx默认的主页，因为lb01中暂时没有对应文件夹的index.html</a></p>\n<h3 id=\"3-5-在负载均衡上创建同时调用动态和静态资源的index-html\"><a href=\"#3-5-在负载均衡上创建同时调用动态和静态资源的index-html\" class=\"headerlink\" title=\"3.5 在负载均衡上创建同时调用动态和静态资源的index.html\"></a>3.5 在负载均衡上创建同时调用动态和静态资源的index.html</h3><p>1、修改Nginx配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 dongtai]# cat &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;proxy_dj.conf\nupstream jt &#123;\n        server 172.16.1.7:80;\n&#125;\n\nupstream dt &#123;\n        server 172.16.1.8:8080;\n&#125;\n\nserver &#123;\n        listen 80;\n        server_name dongjing.gs.com;\n\t\t\n\t\t# 新增\n        location &#x2F; &#123;\n                root &#x2F;code&#x2F;dongjing;\n                index index.html;\n        &#125;\n\n        location ~* ^.*\\.(jpg|png|gif)$ &#123;\n                proxy_pass http:&#x2F;&#x2F;jt;\n                proxy_set_header HOST $http_host;\n        &#125;\n\n        location ~ \\.jsp$ &#123;\n                proxy_pass http:&#x2F;&#x2F;dt;\n                proxy_set_header HOST $http_host;\n        &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、创建对应的目录和页面</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@lb01 &#x2F;]# mkdir &#x2F;code&#x2F;dongjing\n[root@lb01 &#x2F;]# cat &#x2F;code&#x2F;dongjing&#x2F;index.html\n&lt;html lang&#x3D;&quot;en&quot;&gt;\n&lt;head&gt;\n        &lt;meta charset&#x3D;&quot;UTF-8&quot; &#x2F;&gt;\n        &lt;title&gt;测试ajax和跨域访问&lt;&#x2F;title&gt;\n        &lt;script src&#x3D;&quot;http:&#x2F;&#x2F;libs.baidu.com&#x2F;jquery&#x2F;2.1.4&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;\n&lt;&#x2F;head&gt;\n&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;\n$(document).ready(function()&#123;\n        $.ajax(&#123;\n        type: &quot;GET&quot;,\n        url: &quot;http:&#x2F;&#x2F;dongjing.gs.com&#x2F;java_test.jsp&quot;,\n        success: function(data)&#123;\n                $(&quot;#get_data&quot;).html(data)\n        &#125;,\n        error: function() &#123;\n                alert(&quot;哎呦喂,失败了,回去检查你服务去~&quot;);\n        &#125;\n        &#125;);\n&#125;);\n&lt;&#x2F;script&gt;\n&lt;body&gt;\n        &lt;h1&gt;测试动静分离&lt;&#x2F;h1&gt;\n        &lt;div id&#x3D;&quot;get_data&quot;&gt;&lt;&#x2F;div&gt;\n        &lt;img src&#x3D;&quot;http:&#x2F;&#x2F;dongjing.gs.com&#x2F;1.png&quot;&gt;\n&lt;&#x2F;body&gt;\n&lt;&#x2F;html&gt;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、测试访问</p>\n<p>浏览器访问：<a href=\"http://dongjing.gs.com/\">http://dongjing.gs.com</a></p>\n<p><img src=\"/img/image-20210825143746986.png\" alt=\"image-20210825143746986\"></p>\n<p>正常负载均衡的现象：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">关掉web02的Tomcat服务，web01服务正常\n\n​\thttp:&#x2F;&#x2F;dongjing.gs.com可以正常打开，图片正常显示，随机数将显示异常\n\nweb02的Tomcat服务正常，关掉web01的nginx服务\n\n​\thttp:&#x2F;&#x2F;dongjing.gs.com可以正常打开，图片显示异常，随机正常显示<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、综合案例-Nginx资源分离\"><a href=\"#四、综合案例-Nginx资源分离\" class=\"headerlink\" title=\"四、综合案例-Nginx资源分离\"></a>四、综合案例-Nginx资源分离</h2><h3 id=\"4-1-什么是资源分离？\"><a href=\"#4-1-什么是资源分离？\" class=\"headerlink\" title=\"4.1 什么是资源分离？\"></a>4.1 什么是资源分离？</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">根据浏览器Agent标识可以访问到不同的页面资源：\n比如：\n    Android访问到的是Android的页面\n    PC访问到的是PC的页面\n    iphone访问放到的是iphone的页面<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-2-实验环境准备\"><a href=\"#4-2-实验环境准备\" class=\"headerlink\" title=\"4.2 实验环境准备\"></a>4.2 实验环境准备</h3><table>\n<thead>\n<tr>\n<th>主机</th>\n<th>外网</th>\n<th>内网</th>\n<th>作用服务</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>lb01</td>\n<td>10.0.0.5</td>\n<td>172.16.1.5</td>\n<td>负载均衡 nginx proxy</td>\n</tr>\n<tr>\n<td>web01</td>\n<td>10.0.0.7</td>\n<td>172.16.1.7</td>\n<td>提供Android手机页面</td>\n</tr>\n<tr>\n<td>web02</td>\n<td>10.0.0.8</td>\n<td>172.16.1.8</td>\n<td>提供PC访问页面</td>\n</tr>\n</tbody></table>\n"},{"title":"K8S系列(一)-安装K8S","date":"2021-07-08T15:05:17.000Z","tag":null,"_content":"\n课程目录：\n\n>第一部分：K8S概念和架构\n>\n>第二部分：K8S安装\n>\n>​\tkubeadm\n>\n>​\t二进制\n>\n>第三部分：K8S核心概念\n>\n>POD \n>\n>CONTROLLER\n>\n>SERVICE\n>\n>INGRESS\n>\n>RABC\n>\n>HELM\n>\n>持久化存储\n>\n>第四部分：集群监控平台\n>\n>第五部分：从零开始搭建高可用K8S集群\n>\n>第六部分：在集群环境中部署项目\n>\n>\n\n## 一、K8S概念和架构\n\n### 1 K8S概述和特性\n\n#### 1.1 基本介绍\n\n- K8S是谷歌在2014年开发的容器化集群管理系统\n- 使用K8S可以进行容器化应用部署\n- 使用K8S利于应用扩展\n- K8S目标是让部署容器化应用更加简洁和高效\n\n容器化部署的好处：\n\n#### 1.2 K8S的特性和优势\n\n自动装箱：自动部署应用容器\n\n自我修复（自愈能力）： \n\n水平扩展：副本数量增加\n\n服务发现（负载均衡）：通过Service实现，为多个副本对外提供统一的入口，节点调度负载均衡\n\n滚动更新：\n\n版本回退：\n\n密钥配置管理：不需要重新构建镜像，可以部署和更新密钥和应用配置\n\n存储编排：\n\n批处理：\t\n\n### 2 K8S架构组件\n\n### 3 K8S核心概念\n\n3.1 Pod\n\n3.2 Controller\n\n3.3 Service\n\n\n\n## 二、K8S安装\n\n>master  192.168.44.146\n>\n>node1\t192.168.44.145\n>\n>node2\t192.168.44.144\n\n### 1 kubeadm安装\n\n\n\n### 2 二进制安装\n\n\n\n-----------------------------------------------------------------------\n\n生产环境通用需求：\n\n​\t服务的自动发现和负载均衡\n\n​\t自愈\n\n​\t一键升级和回滚\n\n​\t水平扩展（弹性伸缩） \n\n### 1 容器管理平台\n\ndocker swarm\n\nmessos\n\nmarathon\n\nkubernetes  (90%市场)\n\n## 2 K8S发展\n\n发布频繁，一年4个版本\t\n\n### 3 核心组件\n\n\n\n## 二、K8S安装\n\n>K8S安装方式很多：\n>\n>- 源码编译安装 ：golang编译环境\n>- 二进制安装 ：文档，全程手动，ansible等\n>- kubeadm安装：网络要求\n>- minikube ：开发者学习\n>- yum安装 \n>\n>这里使用yum安装的方法\n\n### 1 虚拟机准备\n\n> centos7, 1CPU 1G\n>\n> 设置主机名，**添加hosts解析**\n\n```shell\nk8s-master  --  10.0.0.21\nk8s-node1   --  10.0.0.22\nk8s-node2   --  10.0.0.23\n```\n\n配置Centos7源和epel7源\n\n```he\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\n```\n\n### 2 Master节点安装\n\n#### 2.1 安装docker\n\n```shell\nyum install docker -y\n```\n\n#### 2.2 安装etcd\n\n>etcd是一个nosql数据库\n\n```shell\nyum install etcd -y\n```\n\n修改etcd配置文件\n\n```shell\nvim /etc/etcd/etcd.conf\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://10.0.0.21:2379\"\n```\n\n启动etcd服务\n\n```shell\nsystemctl enable etcd\nsystemctl restart etcd\n```\n\n测试etcd\n\n```shell\netcdctl set testdir/testkey0 0\netcdctl get testdir/testkey0\n```\n\netcdctl相关设置\n\n```shell\netcdctl -C http://10.0.0.21:2379 cluster-health\n```\n\n#### 2.3 安装k8s服务\n\n```shell\nyum install kubernetes-master -y\n```\n\n配置文件修改\n\n```shell\nvim /etc/kubernetes/apiserver\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://10.0.0.21:2379\"\n# 23行删除ServiceAccount，如下\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\" # \n```\n\n```shell\nvim /etc/kubernetes/config\nKUBE_MASTER=\"--master=http://10.0.0.21:8080\"\n```\n\n开放防火墙端口【重要】\n\n```shell\nfirewall-cmd --zone=public --add-port=2379/tcp --permanent\nfirewall-cmd --zone=public --add-port=8080/tcp --permanent\nfirewall-cmd --reload\n```\n\n启动服务\n\n```shell\nsystemctl enable kube-apiserver\nsystemctl restart kube-apiserver\nsystemctl enable kube-controller-manager\nsystemctl restart kube-controller-manager\nsystemctl enable kube-scheduler\nsystemctl restart kube-scheduler\n```\n\n### 3 Node节点安装\n\n#### 3.1 安装k8s-node服务 \n\n```shell\nyum install kubernetes-node\n```\n\n编辑配置文件\n\n```shell\nvim /etc/kubernetes/config\nKUBE_MASTER=\"--master=http://10.0.0.21:8080\"\n```\n\n```shell\nvim /etc/kubernetes/kubelet\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_PORT=\"--port=10250\"\nKUBELET_HOSTNAME=\"--hostname-override=10.0.0.22\"\nKUBELET_API_SERVER=\"--api-servers=http://10.0.0.21:8080\"\n```\n\n启动服务\n\n```shell\nsystemctl enable kubelet\nsystemctl restart kubelet\nsystemctl enable kube-proxy\nsystemctl restart kube-proxy\n```\n\n#### 3.2 fannel网络服务安装\n\n>用于节点之间通信\n\n所有节点安装并配置fannel\n\n```shell\nyum install flannel -y\n```\n\n```shell\nvim /etc/sysconfig/flanneld\nFLANNEL_ETCD_ENDPOINTS=\"http://10.0.0.21:2379\"\n```\n\n```shell\netcdctl mk /atomic.io/network/config '{\"Network\":\"172.16.0.0/16\"}'\n```\n\n重新启动服务---Master节点\n\n```shell\nsystemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kube-apiserver\nsystemctl restart kube-controller-manager\nsystemctl restart kube-scheduler\t\n```\n\n重新启动服务---Node节点\n\n```shell\nsystemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kubelet\nsystemctl restart kube-proxy\n```\n\n### 4 配置Master为镜像服务器\n\n## 三、K8S使用\n\n1 查看节点\n\n```shell\nkubectl get nodes\n```\n\n2 查看服务状态\n\n```shell\nkubectl get componentstatus\n```\n\n### 1 Pod使用\n\n创建pod\n\n```shell\nkubectl create -f k8s_pod.yml\n```\n\n删除pod\n\n```she\nkubectl delete pod oldboy\nkubectl delete pod --all 删除所有\n```\n\n查看pod\n\n```shell\nkubectl get pods\nkubectl get pods -o wides\n```\n\n查看pod详细信息\n\n```shell\nkubectl descripe pod nginx\n```\n\n 更新\n\n```shell\nkubectl replace xxxx.yml\n```\n\n\n\n#### 1.1 创建一个pod,为什么要启动两个容器？\n\n>一个pod中可以挂多个容器\n\n比如创建一个niginx pod，将启动一个pod容器，一个nginx容器\n\nPod容器172.16.18.2\n\nNginx容器，共用pod容器ip\n\n主要通过用POD来实现K8S的高级功能\n\n\n\n#### 1.2 rc副本控制器的使用\n\n通过rc保证容器高可用\n\n调整rc副本数\n\n```shell\nkubectl scale rc myweb --replicates=1\n```\n\n#### 1.3 利用rc实现滚动升级和一键回滚\n\n案例：nginx 1.13升级1.15\n\n```shell\n# 每5s升级一个\nkubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period=5s\n```\n\n案例：nginx1.15回滚到1.13\n\n```shell\nkubectl rolling-update mywebv2 -f nginx-rc1.13.yaml\n```\n\n\n\n### service的创建和访问\n\n> 外部访问容器，端口映射\n\n#### K8S小结\n\n1 端口30000开始？\n\n2 查看yml字段编写帮助\n\n```shell\nkubectl explain svc.spec\n```\n\n","source":"_posts/01_运维/05-K8S/K8S系列-一-安装K8S.md","raw":"---\ntitle: K8S系列(一)-安装K8S\ndate: 2021-07-08 23:05:17\ncategories:\n- 运维\n- （五）K8S\ntag:\n---\n\n课程目录：\n\n>第一部分：K8S概念和架构\n>\n>第二部分：K8S安装\n>\n>​\tkubeadm\n>\n>​\t二进制\n>\n>第三部分：K8S核心概念\n>\n>POD \n>\n>CONTROLLER\n>\n>SERVICE\n>\n>INGRESS\n>\n>RABC\n>\n>HELM\n>\n>持久化存储\n>\n>第四部分：集群监控平台\n>\n>第五部分：从零开始搭建高可用K8S集群\n>\n>第六部分：在集群环境中部署项目\n>\n>\n\n## 一、K8S概念和架构\n\n### 1 K8S概述和特性\n\n#### 1.1 基本介绍\n\n- K8S是谷歌在2014年开发的容器化集群管理系统\n- 使用K8S可以进行容器化应用部署\n- 使用K8S利于应用扩展\n- K8S目标是让部署容器化应用更加简洁和高效\n\n容器化部署的好处：\n\n#### 1.2 K8S的特性和优势\n\n自动装箱：自动部署应用容器\n\n自我修复（自愈能力）： \n\n水平扩展：副本数量增加\n\n服务发现（负载均衡）：通过Service实现，为多个副本对外提供统一的入口，节点调度负载均衡\n\n滚动更新：\n\n版本回退：\n\n密钥配置管理：不需要重新构建镜像，可以部署和更新密钥和应用配置\n\n存储编排：\n\n批处理：\t\n\n### 2 K8S架构组件\n\n### 3 K8S核心概念\n\n3.1 Pod\n\n3.2 Controller\n\n3.3 Service\n\n\n\n## 二、K8S安装\n\n>master  192.168.44.146\n>\n>node1\t192.168.44.145\n>\n>node2\t192.168.44.144\n\n### 1 kubeadm安装\n\n\n\n### 2 二进制安装\n\n\n\n-----------------------------------------------------------------------\n\n生产环境通用需求：\n\n​\t服务的自动发现和负载均衡\n\n​\t自愈\n\n​\t一键升级和回滚\n\n​\t水平扩展（弹性伸缩） \n\n### 1 容器管理平台\n\ndocker swarm\n\nmessos\n\nmarathon\n\nkubernetes  (90%市场)\n\n## 2 K8S发展\n\n发布频繁，一年4个版本\t\n\n### 3 核心组件\n\n\n\n## 二、K8S安装\n\n>K8S安装方式很多：\n>\n>- 源码编译安装 ：golang编译环境\n>- 二进制安装 ：文档，全程手动，ansible等\n>- kubeadm安装：网络要求\n>- minikube ：开发者学习\n>- yum安装 \n>\n>这里使用yum安装的方法\n\n### 1 虚拟机准备\n\n> centos7, 1CPU 1G\n>\n> 设置主机名，**添加hosts解析**\n\n```shell\nk8s-master  --  10.0.0.21\nk8s-node1   --  10.0.0.22\nk8s-node2   --  10.0.0.23\n```\n\n配置Centos7源和epel7源\n\n```he\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\ncurl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\n```\n\n### 2 Master节点安装\n\n#### 2.1 安装docker\n\n```shell\nyum install docker -y\n```\n\n#### 2.2 安装etcd\n\n>etcd是一个nosql数据库\n\n```shell\nyum install etcd -y\n```\n\n修改etcd配置文件\n\n```shell\nvim /etc/etcd/etcd.conf\nETCD_LISTEN_CLIENT_URLS=\"http://0.0.0.0:2379\"\nETCD_ADVERTISE_CLIENT_URLS=\"http://10.0.0.21:2379\"\n```\n\n启动etcd服务\n\n```shell\nsystemctl enable etcd\nsystemctl restart etcd\n```\n\n测试etcd\n\n```shell\netcdctl set testdir/testkey0 0\netcdctl get testdir/testkey0\n```\n\netcdctl相关设置\n\n```shell\netcdctl -C http://10.0.0.21:2379 cluster-health\n```\n\n#### 2.3 安装k8s服务\n\n```shell\nyum install kubernetes-master -y\n```\n\n配置文件修改\n\n```shell\nvim /etc/kubernetes/apiserver\nKUBE_API_ADDRESS=\"--insecure-bind-address=0.0.0.0\"\nKUBE_API_PORT=\"--port=8080\"\nKUBE_ETCD_SERVERS=\"--etcd-servers=http://10.0.0.21:2379\"\n# 23行删除ServiceAccount，如下\nKUBE_ADMISSION_CONTROL=\"--admission-control=NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota\" # \n```\n\n```shell\nvim /etc/kubernetes/config\nKUBE_MASTER=\"--master=http://10.0.0.21:8080\"\n```\n\n开放防火墙端口【重要】\n\n```shell\nfirewall-cmd --zone=public --add-port=2379/tcp --permanent\nfirewall-cmd --zone=public --add-port=8080/tcp --permanent\nfirewall-cmd --reload\n```\n\n启动服务\n\n```shell\nsystemctl enable kube-apiserver\nsystemctl restart kube-apiserver\nsystemctl enable kube-controller-manager\nsystemctl restart kube-controller-manager\nsystemctl enable kube-scheduler\nsystemctl restart kube-scheduler\n```\n\n### 3 Node节点安装\n\n#### 3.1 安装k8s-node服务 \n\n```shell\nyum install kubernetes-node\n```\n\n编辑配置文件\n\n```shell\nvim /etc/kubernetes/config\nKUBE_MASTER=\"--master=http://10.0.0.21:8080\"\n```\n\n```shell\nvim /etc/kubernetes/kubelet\nKUBELET_ADDRESS=\"--address=0.0.0.0\"\nKUBELET_PORT=\"--port=10250\"\nKUBELET_HOSTNAME=\"--hostname-override=10.0.0.22\"\nKUBELET_API_SERVER=\"--api-servers=http://10.0.0.21:8080\"\n```\n\n启动服务\n\n```shell\nsystemctl enable kubelet\nsystemctl restart kubelet\nsystemctl enable kube-proxy\nsystemctl restart kube-proxy\n```\n\n#### 3.2 fannel网络服务安装\n\n>用于节点之间通信\n\n所有节点安装并配置fannel\n\n```shell\nyum install flannel -y\n```\n\n```shell\nvim /etc/sysconfig/flanneld\nFLANNEL_ETCD_ENDPOINTS=\"http://10.0.0.21:2379\"\n```\n\n```shell\netcdctl mk /atomic.io/network/config '{\"Network\":\"172.16.0.0/16\"}'\n```\n\n重新启动服务---Master节点\n\n```shell\nsystemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kube-apiserver\nsystemctl restart kube-controller-manager\nsystemctl restart kube-scheduler\t\n```\n\n重新启动服务---Node节点\n\n```shell\nsystemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kubelet\nsystemctl restart kube-proxy\n```\n\n### 4 配置Master为镜像服务器\n\n## 三、K8S使用\n\n1 查看节点\n\n```shell\nkubectl get nodes\n```\n\n2 查看服务状态\n\n```shell\nkubectl get componentstatus\n```\n\n### 1 Pod使用\n\n创建pod\n\n```shell\nkubectl create -f k8s_pod.yml\n```\n\n删除pod\n\n```she\nkubectl delete pod oldboy\nkubectl delete pod --all 删除所有\n```\n\n查看pod\n\n```shell\nkubectl get pods\nkubectl get pods -o wides\n```\n\n查看pod详细信息\n\n```shell\nkubectl descripe pod nginx\n```\n\n 更新\n\n```shell\nkubectl replace xxxx.yml\n```\n\n\n\n#### 1.1 创建一个pod,为什么要启动两个容器？\n\n>一个pod中可以挂多个容器\n\n比如创建一个niginx pod，将启动一个pod容器，一个nginx容器\n\nPod容器172.16.18.2\n\nNginx容器，共用pod容器ip\n\n主要通过用POD来实现K8S的高级功能\n\n\n\n#### 1.2 rc副本控制器的使用\n\n通过rc保证容器高可用\n\n调整rc副本数\n\n```shell\nkubectl scale rc myweb --replicates=1\n```\n\n#### 1.3 利用rc实现滚动升级和一键回滚\n\n案例：nginx 1.13升级1.15\n\n```shell\n# 每5s升级一个\nkubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period=5s\n```\n\n案例：nginx1.15回滚到1.13\n\n```shell\nkubectl rolling-update mywebv2 -f nginx-rc1.13.yaml\n```\n\n\n\n### service的创建和访问\n\n> 外部访问容器，端口映射\n\n#### K8S小结\n\n1 端口30000开始？\n\n2 查看yml字段编写帮助\n\n```shell\nkubectl explain svc.spec\n```\n\n","slug":"01_运维/05-K8S/K8S系列-一-安装K8S","published":1,"updated":"2022-07-06T07:21:00.122Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0n001aa8v73ti9db7y","content":"<p>课程目录：</p>\n<blockquote>\n<p>第一部分：K8S概念和架构</p>\n<p>第二部分：K8S安装</p>\n<p>​\tkubeadm</p>\n<p>​\t二进制</p>\n<p>第三部分：K8S核心概念</p>\n<p>POD </p>\n<p>CONTROLLER</p>\n<p>SERVICE</p>\n<p>INGRESS</p>\n<p>RABC</p>\n<p>HELM</p>\n<p>持久化存储</p>\n<p>第四部分：集群监控平台</p>\n<p>第五部分：从零开始搭建高可用K8S集群</p>\n<p>第六部分：在集群环境中部署项目</p>\n</blockquote>\n<h2 id=\"一、K8S概念和架构\"><a href=\"#一、K8S概念和架构\" class=\"headerlink\" title=\"一、K8S概念和架构\"></a>一、K8S概念和架构</h2><h3 id=\"1-K8S概述和特性\"><a href=\"#1-K8S概述和特性\" class=\"headerlink\" title=\"1 K8S概述和特性\"></a>1 K8S概述和特性</h3><h4 id=\"1-1-基本介绍\"><a href=\"#1-1-基本介绍\" class=\"headerlink\" title=\"1.1 基本介绍\"></a>1.1 基本介绍</h4><ul>\n<li>K8S是谷歌在2014年开发的容器化集群管理系统</li>\n<li>使用K8S可以进行容器化应用部署</li>\n<li>使用K8S利于应用扩展</li>\n<li>K8S目标是让部署容器化应用更加简洁和高效</li>\n</ul>\n<p>容器化部署的好处：</p>\n<h4 id=\"1-2-K8S的特性和优势\"><a href=\"#1-2-K8S的特性和优势\" class=\"headerlink\" title=\"1.2 K8S的特性和优势\"></a>1.2 K8S的特性和优势</h4><p>自动装箱：自动部署应用容器</p>\n<p>自我修复（自愈能力）： </p>\n<p>水平扩展：副本数量增加</p>\n<p>服务发现（负载均衡）：通过Service实现，为多个副本对外提供统一的入口，节点调度负载均衡</p>\n<p>滚动更新：</p>\n<p>版本回退：</p>\n<p>密钥配置管理：不需要重新构建镜像，可以部署和更新密钥和应用配置</p>\n<p>存储编排：</p>\n<p>批处理：\t</p>\n<h3 id=\"2-K8S架构组件\"><a href=\"#2-K8S架构组件\" class=\"headerlink\" title=\"2 K8S架构组件\"></a>2 K8S架构组件</h3><h3 id=\"3-K8S核心概念\"><a href=\"#3-K8S核心概念\" class=\"headerlink\" title=\"3 K8S核心概念\"></a>3 K8S核心概念</h3><p>3.1 Pod</p>\n<p>3.2 Controller</p>\n<p>3.3 Service</p>\n<h2 id=\"二、K8S安装\"><a href=\"#二、K8S安装\" class=\"headerlink\" title=\"二、K8S安装\"></a>二、K8S安装</h2><blockquote>\n<p>master  192.168.44.146</p>\n<p>node1\t192.168.44.145</p>\n<p>node2\t192.168.44.144</p>\n</blockquote>\n<h3 id=\"1-kubeadm安装\"><a href=\"#1-kubeadm安装\" class=\"headerlink\" title=\"1 kubeadm安装\"></a>1 kubeadm安装</h3><h3 id=\"2-二进制安装\"><a href=\"#2-二进制安装\" class=\"headerlink\" title=\"2 二进制安装\"></a>2 二进制安装</h3><hr>\n<p>生产环境通用需求：</p>\n<p>​\t服务的自动发现和负载均衡</p>\n<p>​\t自愈</p>\n<p>​\t一键升级和回滚</p>\n<p>​\t水平扩展（弹性伸缩） </p>\n<h3 id=\"1-容器管理平台\"><a href=\"#1-容器管理平台\" class=\"headerlink\" title=\"1 容器管理平台\"></a>1 容器管理平台</h3><p>docker swarm</p>\n<p>messos</p>\n<p>marathon</p>\n<p>kubernetes  (90%市场)</p>\n<h2 id=\"2-K8S发展\"><a href=\"#2-K8S发展\" class=\"headerlink\" title=\"2 K8S发展\"></a>2 K8S发展</h2><p>发布频繁，一年4个版本\t</p>\n<h3 id=\"3-核心组件\"><a href=\"#3-核心组件\" class=\"headerlink\" title=\"3 核心组件\"></a>3 核心组件</h3><h2 id=\"二、K8S安装-1\"><a href=\"#二、K8S安装-1\" class=\"headerlink\" title=\"二、K8S安装\"></a>二、K8S安装</h2><blockquote>\n<p>K8S安装方式很多：</p>\n<ul>\n<li>源码编译安装 ：golang编译环境</li>\n<li>二进制安装 ：文档，全程手动，ansible等</li>\n<li>kubeadm安装：网络要求</li>\n<li>minikube ：开发者学习</li>\n<li>yum安装</li>\n</ul>\n<p>这里使用yum安装的方法</p>\n</blockquote>\n<h3 id=\"1-虚拟机准备\"><a href=\"#1-虚拟机准备\" class=\"headerlink\" title=\"1 虚拟机准备\"></a>1 虚拟机准备</h3><blockquote>\n<p>centos7, 1CPU 1G</p>\n<p>设置主机名，<strong>添加hosts解析</strong></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">k8s-master  --  10.0.0.21\nk8s-node1   --  10.0.0.22\nk8s-node2   --  10.0.0.23<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>配置Centos7源和epel7源</p>\n<pre class=\"line-numbers language-he\" data-language=\"he\"><code class=\"language-he\">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-Master节点安装\"><a href=\"#2-Master节点安装\" class=\"headerlink\" title=\"2 Master节点安装\"></a>2 Master节点安装</h3><h4 id=\"2-1-安装docker\"><a href=\"#2-1-安装docker\" class=\"headerlink\" title=\"2.1 安装docker\"></a>2.1 安装docker</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install docker -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-2-安装etcd\"><a href=\"#2-2-安装etcd\" class=\"headerlink\" title=\"2.2 安装etcd\"></a>2.2 安装etcd</h4><blockquote>\n<p>etcd是一个nosql数据库</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install etcd -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改etcd配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;etcd&#x2F;etcd.conf\nETCD_LISTEN_CLIENT_URLS&#x3D;&quot;http:&#x2F;&#x2F;0.0.0.0:2379&quot;\nETCD_ADVERTISE_CLIENT_URLS&#x3D;&quot;http:&#x2F;&#x2F;10.0.0.21:2379&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>启动etcd服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable etcd\nsystemctl restart etcd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试etcd</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl set testdir&#x2F;testkey0 0\netcdctl get testdir&#x2F;testkey0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>etcdctl相关设置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl -C http:&#x2F;&#x2F;10.0.0.21:2379 cluster-health<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-3-安装k8s服务\"><a href=\"#2-3-安装k8s服务\" class=\"headerlink\" title=\"2.3 安装k8s服务\"></a>2.3 安装k8s服务</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install kubernetes-master -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置文件修改</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;apiserver\nKUBE_API_ADDRESS&#x3D;&quot;--insecure-bind-address&#x3D;0.0.0.0&quot;\nKUBE_API_PORT&#x3D;&quot;--port&#x3D;8080&quot;\nKUBE_ETCD_SERVERS&#x3D;&quot;--etcd-servers&#x3D;http:&#x2F;&#x2F;10.0.0.21:2379&quot;\n# 23行删除ServiceAccount，如下\nKUBE_ADMISSION_CONTROL&#x3D;&quot;--admission-control&#x3D;NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&quot; # <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;config\nKUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>开放防火墙端口【重要】</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">firewall-cmd --zone&#x3D;public --add-port&#x3D;2379&#x2F;tcp --permanent\nfirewall-cmd --zone&#x3D;public --add-port&#x3D;8080&#x2F;tcp --permanent\nfirewall-cmd --reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable kube-apiserver\nsystemctl restart kube-apiserver\nsystemctl enable kube-controller-manager\nsystemctl restart kube-controller-manager\nsystemctl enable kube-scheduler\nsystemctl restart kube-scheduler<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-Node节点安装\"><a href=\"#3-Node节点安装\" class=\"headerlink\" title=\"3 Node节点安装\"></a>3 Node节点安装</h3><h4 id=\"3-1-安装k8s-node服务\"><a href=\"#3-1-安装k8s-node服务\" class=\"headerlink\" title=\"3.1 安装k8s-node服务\"></a>3.1 安装k8s-node服务</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install kubernetes-node<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;config\nKUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;kubelet\nKUBELET_ADDRESS&#x3D;&quot;--address&#x3D;0.0.0.0&quot;\nKUBELET_PORT&#x3D;&quot;--port&#x3D;10250&quot;\nKUBELET_HOSTNAME&#x3D;&quot;--hostname-override&#x3D;10.0.0.22&quot;\nKUBELET_API_SERVER&#x3D;&quot;--api-servers&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable kubelet\nsystemctl restart kubelet\nsystemctl enable kube-proxy\nsystemctl restart kube-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-2-fannel网络服务安装\"><a href=\"#3-2-fannel网络服务安装\" class=\"headerlink\" title=\"3.2 fannel网络服务安装\"></a>3.2 fannel网络服务安装</h4><blockquote>\n<p>用于节点之间通信</p>\n</blockquote>\n<p>所有节点安装并配置fannel</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install flannel -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;sysconfig&#x2F;flanneld\nFLANNEL_ETCD_ENDPOINTS&#x3D;&quot;http:&#x2F;&#x2F;10.0.0.21:2379&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl mk &#x2F;atomic.io&#x2F;network&#x2F;config &#39;&#123;&quot;Network&quot;:&quot;172.16.0.0&#x2F;16&quot;&#125;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>重新启动服务—Master节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kube-apiserver\nsystemctl restart kube-controller-manager\nsystemctl restart kube-scheduler\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重新启动服务—Node节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kubelet\nsystemctl restart kube-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-配置Master为镜像服务器\"><a href=\"#4-配置Master为镜像服务器\" class=\"headerlink\" title=\"4 配置Master为镜像服务器\"></a>4 配置Master为镜像服务器</h3><h2 id=\"三、K8S使用\"><a href=\"#三、K8S使用\" class=\"headerlink\" title=\"三、K8S使用\"></a>三、K8S使用</h2><p>1 查看节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get nodes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2 查看服务状态</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get componentstatus<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-Pod使用\"><a href=\"#1-Pod使用\" class=\"headerlink\" title=\"1 Pod使用\"></a>1 Pod使用</h3><p>创建pod</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl create -f k8s_pod.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>删除pod</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">kubectl delete pod oldboy\nkubectl delete pod --all 删除所有<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看pod</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get pods\nkubectl get pods -o wides<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看pod详细信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl descripe pod nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p> 更新</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl replace xxxx.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h4 id=\"1-1-创建一个pod-为什么要启动两个容器？\"><a href=\"#1-1-创建一个pod-为什么要启动两个容器？\" class=\"headerlink\" title=\"1.1 创建一个pod,为什么要启动两个容器？\"></a>1.1 创建一个pod,为什么要启动两个容器？</h4><blockquote>\n<p>一个pod中可以挂多个容器</p>\n</blockquote>\n<p>比如创建一个niginx pod，将启动一个pod容器，一个nginx容器</p>\n<p>Pod容器172.16.18.2</p>\n<p>Nginx容器，共用pod容器ip</p>\n<p>主要通过用POD来实现K8S的高级功能</p>\n<h4 id=\"1-2-rc副本控制器的使用\"><a href=\"#1-2-rc副本控制器的使用\" class=\"headerlink\" title=\"1.2 rc副本控制器的使用\"></a>1.2 rc副本控制器的使用</h4><p>通过rc保证容器高可用</p>\n<p>调整rc副本数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl scale rc myweb --replicates&#x3D;1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"1-3-利用rc实现滚动升级和一键回滚\"><a href=\"#1-3-利用rc实现滚动升级和一键回滚\" class=\"headerlink\" title=\"1.3 利用rc实现滚动升级和一键回滚\"></a>1.3 利用rc实现滚动升级和一键回滚</h4><p>案例：nginx 1.13升级1.15</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 每5s升级一个\nkubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period&#x3D;5s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>案例：nginx1.15回滚到1.13</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl rolling-update mywebv2 -f nginx-rc1.13.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h3 id=\"service的创建和访问\"><a href=\"#service的创建和访问\" class=\"headerlink\" title=\"service的创建和访问\"></a>service的创建和访问</h3><blockquote>\n<p>外部访问容器，端口映射</p>\n</blockquote>\n<h4 id=\"K8S小结\"><a href=\"#K8S小结\" class=\"headerlink\" title=\"K8S小结\"></a>K8S小结</h4><p>1 端口30000开始？</p>\n<p>2 查看yml字段编写帮助</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl explain svc.spec<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<p>课程目录：</p>\n<blockquote>\n<p>第一部分：K8S概念和架构</p>\n<p>第二部分：K8S安装</p>\n<p>​\tkubeadm</p>\n<p>​\t二进制</p>\n<p>第三部分：K8S核心概念</p>\n<p>POD </p>\n<p>CONTROLLER</p>\n<p>SERVICE</p>\n<p>INGRESS</p>\n<p>RABC</p>\n<p>HELM</p>\n<p>持久化存储</p>\n<p>第四部分：集群监控平台</p>\n<p>第五部分：从零开始搭建高可用K8S集群</p>\n<p>第六部分：在集群环境中部署项目</p>\n</blockquote>\n<h2 id=\"一、K8S概念和架构\"><a href=\"#一、K8S概念和架构\" class=\"headerlink\" title=\"一、K8S概念和架构\"></a>一、K8S概念和架构</h2><h3 id=\"1-K8S概述和特性\"><a href=\"#1-K8S概述和特性\" class=\"headerlink\" title=\"1 K8S概述和特性\"></a>1 K8S概述和特性</h3><h4 id=\"1-1-基本介绍\"><a href=\"#1-1-基本介绍\" class=\"headerlink\" title=\"1.1 基本介绍\"></a>1.1 基本介绍</h4><ul>\n<li>K8S是谷歌在2014年开发的容器化集群管理系统</li>\n<li>使用K8S可以进行容器化应用部署</li>\n<li>使用K8S利于应用扩展</li>\n<li>K8S目标是让部署容器化应用更加简洁和高效</li>\n</ul>\n<p>容器化部署的好处：</p>\n<h4 id=\"1-2-K8S的特性和优势\"><a href=\"#1-2-K8S的特性和优势\" class=\"headerlink\" title=\"1.2 K8S的特性和优势\"></a>1.2 K8S的特性和优势</h4><p>自动装箱：自动部署应用容器</p>\n<p>自我修复（自愈能力）： </p>\n<p>水平扩展：副本数量增加</p>\n<p>服务发现（负载均衡）：通过Service实现，为多个副本对外提供统一的入口，节点调度负载均衡</p>\n<p>滚动更新：</p>\n<p>版本回退：</p>\n<p>密钥配置管理：不需要重新构建镜像，可以部署和更新密钥和应用配置</p>\n<p>存储编排：</p>\n<p>批处理：\t</p>\n<h3 id=\"2-K8S架构组件\"><a href=\"#2-K8S架构组件\" class=\"headerlink\" title=\"2 K8S架构组件\"></a>2 K8S架构组件</h3><h3 id=\"3-K8S核心概念\"><a href=\"#3-K8S核心概念\" class=\"headerlink\" title=\"3 K8S核心概念\"></a>3 K8S核心概念</h3><p>3.1 Pod</p>\n<p>3.2 Controller</p>\n<p>3.3 Service</p>\n<h2 id=\"二、K8S安装\"><a href=\"#二、K8S安装\" class=\"headerlink\" title=\"二、K8S安装\"></a>二、K8S安装</h2><blockquote>\n<p>master  192.168.44.146</p>\n<p>node1\t192.168.44.145</p>\n<p>node2\t192.168.44.144</p>\n</blockquote>\n<h3 id=\"1-kubeadm安装\"><a href=\"#1-kubeadm安装\" class=\"headerlink\" title=\"1 kubeadm安装\"></a>1 kubeadm安装</h3><h3 id=\"2-二进制安装\"><a href=\"#2-二进制安装\" class=\"headerlink\" title=\"2 二进制安装\"></a>2 二进制安装</h3><hr>\n<p>生产环境通用需求：</p>\n<p>​\t服务的自动发现和负载均衡</p>\n<p>​\t自愈</p>\n<p>​\t一键升级和回滚</p>\n<p>​\t水平扩展（弹性伸缩） </p>\n<h3 id=\"1-容器管理平台\"><a href=\"#1-容器管理平台\" class=\"headerlink\" title=\"1 容器管理平台\"></a>1 容器管理平台</h3><p>docker swarm</p>\n<p>messos</p>\n<p>marathon</p>\n<p>kubernetes  (90%市场)</p>\n<h2 id=\"2-K8S发展\"><a href=\"#2-K8S发展\" class=\"headerlink\" title=\"2 K8S发展\"></a>2 K8S发展</h2><p>发布频繁，一年4个版本\t</p>\n<h3 id=\"3-核心组件\"><a href=\"#3-核心组件\" class=\"headerlink\" title=\"3 核心组件\"></a>3 核心组件</h3><h2 id=\"二、K8S安装-1\"><a href=\"#二、K8S安装-1\" class=\"headerlink\" title=\"二、K8S安装\"></a>二、K8S安装</h2><blockquote>\n<p>K8S安装方式很多：</p>\n<ul>\n<li>源码编译安装 ：golang编译环境</li>\n<li>二进制安装 ：文档，全程手动，ansible等</li>\n<li>kubeadm安装：网络要求</li>\n<li>minikube ：开发者学习</li>\n<li>yum安装</li>\n</ul>\n<p>这里使用yum安装的方法</p>\n</blockquote>\n<h3 id=\"1-虚拟机准备\"><a href=\"#1-虚拟机准备\" class=\"headerlink\" title=\"1 虚拟机准备\"></a>1 虚拟机准备</h3><blockquote>\n<p>centos7, 1CPU 1G</p>\n<p>设置主机名，<strong>添加hosts解析</strong></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">k8s-master  --  10.0.0.21\nk8s-node1   --  10.0.0.22\nk8s-node2   --  10.0.0.23<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>配置Centos7源和epel7源</p>\n<pre class=\"line-numbers language-he\" data-language=\"he\"><code class=\"language-he\">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-Master节点安装\"><a href=\"#2-Master节点安装\" class=\"headerlink\" title=\"2 Master节点安装\"></a>2 Master节点安装</h3><h4 id=\"2-1-安装docker\"><a href=\"#2-1-安装docker\" class=\"headerlink\" title=\"2.1 安装docker\"></a>2.1 安装docker</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install docker -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-2-安装etcd\"><a href=\"#2-2-安装etcd\" class=\"headerlink\" title=\"2.2 安装etcd\"></a>2.2 安装etcd</h4><blockquote>\n<p>etcd是一个nosql数据库</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install etcd -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改etcd配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;etcd&#x2F;etcd.conf\nETCD_LISTEN_CLIENT_URLS&#x3D;&quot;http:&#x2F;&#x2F;0.0.0.0:2379&quot;\nETCD_ADVERTISE_CLIENT_URLS&#x3D;&quot;http:&#x2F;&#x2F;10.0.0.21:2379&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>启动etcd服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable etcd\nsystemctl restart etcd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试etcd</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl set testdir&#x2F;testkey0 0\netcdctl get testdir&#x2F;testkey0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>etcdctl相关设置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl -C http:&#x2F;&#x2F;10.0.0.21:2379 cluster-health<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-3-安装k8s服务\"><a href=\"#2-3-安装k8s服务\" class=\"headerlink\" title=\"2.3 安装k8s服务\"></a>2.3 安装k8s服务</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install kubernetes-master -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置文件修改</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;apiserver\nKUBE_API_ADDRESS&#x3D;&quot;--insecure-bind-address&#x3D;0.0.0.0&quot;\nKUBE_API_PORT&#x3D;&quot;--port&#x3D;8080&quot;\nKUBE_ETCD_SERVERS&#x3D;&quot;--etcd-servers&#x3D;http:&#x2F;&#x2F;10.0.0.21:2379&quot;\n# 23行删除ServiceAccount，如下\nKUBE_ADMISSION_CONTROL&#x3D;&quot;--admission-control&#x3D;NamespaceLifecycle,NamespaceExists,LimitRanger,SecurityContextDeny,ResourceQuota&quot; # <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;config\nKUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>开放防火墙端口【重要】</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">firewall-cmd --zone&#x3D;public --add-port&#x3D;2379&#x2F;tcp --permanent\nfirewall-cmd --zone&#x3D;public --add-port&#x3D;8080&#x2F;tcp --permanent\nfirewall-cmd --reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable kube-apiserver\nsystemctl restart kube-apiserver\nsystemctl enable kube-controller-manager\nsystemctl restart kube-controller-manager\nsystemctl enable kube-scheduler\nsystemctl restart kube-scheduler<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-Node节点安装\"><a href=\"#3-Node节点安装\" class=\"headerlink\" title=\"3 Node节点安装\"></a>3 Node节点安装</h3><h4 id=\"3-1-安装k8s-node服务\"><a href=\"#3-1-安装k8s-node服务\" class=\"headerlink\" title=\"3.1 安装k8s-node服务\"></a>3.1 安装k8s-node服务</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install kubernetes-node<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>编辑配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;config\nKUBE_MASTER&#x3D;&quot;--master&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;kubernetes&#x2F;kubelet\nKUBELET_ADDRESS&#x3D;&quot;--address&#x3D;0.0.0.0&quot;\nKUBELET_PORT&#x3D;&quot;--port&#x3D;10250&quot;\nKUBELET_HOSTNAME&#x3D;&quot;--hostname-override&#x3D;10.0.0.22&quot;\nKUBELET_API_SERVER&#x3D;&quot;--api-servers&#x3D;http:&#x2F;&#x2F;10.0.0.21:8080&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable kubelet\nsystemctl restart kubelet\nsystemctl enable kube-proxy\nsystemctl restart kube-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"3-2-fannel网络服务安装\"><a href=\"#3-2-fannel网络服务安装\" class=\"headerlink\" title=\"3.2 fannel网络服务安装\"></a>3.2 fannel网络服务安装</h4><blockquote>\n<p>用于节点之间通信</p>\n</blockquote>\n<p>所有节点安装并配置fannel</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install flannel -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;sysconfig&#x2F;flanneld\nFLANNEL_ETCD_ENDPOINTS&#x3D;&quot;http:&#x2F;&#x2F;10.0.0.21:2379&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">etcdctl mk &#x2F;atomic.io&#x2F;network&#x2F;config &#39;&#123;&quot;Network&quot;:&quot;172.16.0.0&#x2F;16&quot;&#125;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>重新启动服务—Master节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kube-apiserver\nsystemctl restart kube-controller-manager\nsystemctl restart kube-scheduler\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重新启动服务—Node节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl enable fanneld\nsystemctl restart fanneld\nsystemctl restart kubelet\nsystemctl restart kube-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-配置Master为镜像服务器\"><a href=\"#4-配置Master为镜像服务器\" class=\"headerlink\" title=\"4 配置Master为镜像服务器\"></a>4 配置Master为镜像服务器</h3><h2 id=\"三、K8S使用\"><a href=\"#三、K8S使用\" class=\"headerlink\" title=\"三、K8S使用\"></a>三、K8S使用</h2><p>1 查看节点</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get nodes<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>2 查看服务状态</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get componentstatus<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"1-Pod使用\"><a href=\"#1-Pod使用\" class=\"headerlink\" title=\"1 Pod使用\"></a>1 Pod使用</h3><p>创建pod</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl create -f k8s_pod.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>删除pod</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">kubectl delete pod oldboy\nkubectl delete pod --all 删除所有<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看pod</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl get pods\nkubectl get pods -o wides<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看pod详细信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl descripe pod nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p> 更新</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl replace xxxx.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h4 id=\"1-1-创建一个pod-为什么要启动两个容器？\"><a href=\"#1-1-创建一个pod-为什么要启动两个容器？\" class=\"headerlink\" title=\"1.1 创建一个pod,为什么要启动两个容器？\"></a>1.1 创建一个pod,为什么要启动两个容器？</h4><blockquote>\n<p>一个pod中可以挂多个容器</p>\n</blockquote>\n<p>比如创建一个niginx pod，将启动一个pod容器，一个nginx容器</p>\n<p>Pod容器172.16.18.2</p>\n<p>Nginx容器，共用pod容器ip</p>\n<p>主要通过用POD来实现K8S的高级功能</p>\n<h4 id=\"1-2-rc副本控制器的使用\"><a href=\"#1-2-rc副本控制器的使用\" class=\"headerlink\" title=\"1.2 rc副本控制器的使用\"></a>1.2 rc副本控制器的使用</h4><p>通过rc保证容器高可用</p>\n<p>调整rc副本数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl scale rc myweb --replicates&#x3D;1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"1-3-利用rc实现滚动升级和一键回滚\"><a href=\"#1-3-利用rc实现滚动升级和一键回滚\" class=\"headerlink\" title=\"1.3 利用rc实现滚动升级和一键回滚\"></a>1.3 利用rc实现滚动升级和一键回滚</h4><p>案例：nginx 1.13升级1.15</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 每5s升级一个\nkubectl rolling-update myweb -f nginx-rc1.15.yaml --update-period&#x3D;5s<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>案例：nginx1.15回滚到1.13</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl rolling-update mywebv2 -f nginx-rc1.13.yaml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h3 id=\"service的创建和访问\"><a href=\"#service的创建和访问\" class=\"headerlink\" title=\"service的创建和访问\"></a>service的创建和访问</h3><blockquote>\n<p>外部访问容器，端口映射</p>\n</blockquote>\n<h4 id=\"K8S小结\"><a href=\"#K8S小结\" class=\"headerlink\" title=\"K8S小结\"></a>K8S小结</h4><p>1 端口30000开始？</p>\n<p>2 查看yml字段编写帮助</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">kubectl explain svc.spec<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"OpenStack学习笔记","_content":"\n# **<font color=green>OpenStack笔记</font>**\n\n​\tOpenStack实现的是云计算IAAS\n\n## <font color=blue>一、服务架构发展</font>\n\n### 1.1 MVC架构\n\n​\t业务不拆分，一个服务挂，则所有的全挂\n\n```shell\n首页 www.jd.com/index.html\n秒杀 www.jd.com/miaosha/index.html\n优惠券 www.jd.com/juan/index.html\n```\n\n### 1.2 SOA架构（千万级）\n\n​\t业务拆分，每一个功能都拆分成一个独立的web服务，每个独立的web服务，都至少拥有一个集群\n\n```she\n首页 www.jd.com/index.html\n秒杀 miaosha.jd.com/index.html\n优惠券 juan.jd.com/index.html\n```\n\n### 1.3 微服务架构（亿级）\n\n阿里开源dubbo\n\nSpring Boot\n\n自动化代码上线：Jekins + gilab ci\n\n自动化代码质量检查：sonarqube\n\n\n\n## <font color=blue>二、搭建OpenStack</font>\n\n​\t本流程为手动安装M版，脚本安装可以参考\n\n```shell\nhttps://my.oschina.net/u/4367225/blog/4255750\n```\n\nOpenStack的结构介绍：\n\n>Nova -- 提供VM虚拟化支持 8774\n>\n>Glance -- 提供镜像 9292\n>\n>Clinder -- 存储支持 8776\n>\n>Neutron -- 网络支持 9696\n>\n>Cellometer --  监控计费 \n>\n>KeyStone -- 登录认证\n>\n>Horizon -- 网页UI，dashboard\n>\n>Heat -- 部署编排，批量建虚拟机\n>\n>Switft -- 对象存储（不是传统的文件夹存放，而是用数据库记录已上传的文件信息，当有文件上传，先查询数据库中是否有该文件的md5值，如果有，则不用重新上传，给个链接就是 --- 百度云盘）\n\n![image-20210615135957367](C:\\Users\\fr724\\AppData\\Roaming\\Typora\\typora-user-images\\image-20210615135957367.png)\n\n### 2.1 虚拟机准备\n\n虚拟机规划\n\n```shell\n# 系统：CentOS7.4\ncontroller: 内存3G, CPU开启虚拟化\t10.0.0.11\ncompute1: 内存1G，CPU开启虚拟化\t    10.0.0.31\n# 修改主机名，IP地址，host解析，测试ping百度\n```\n\n配置本地M版yum源\n\n```shell\n# 1、资源准备\nmount /dev/cdrom /mnt # 追加到/etc/rc.local,自动挂载\n解压openstack_rpm.tar.gz到/opt/repo\n\n# 2、编辑repo文件\nvim /etc/yum.repo.d/local/repo\n\n#### 内容\n[local]\nname=local\nbaseurl=file:///mnt\ngpgcheck=0\n\n[openstack]\nname=openstack\nbaseurl=file:///opt/repo\ngpgcheck=0\n####\n\n# 3、更新yum源\nyum makecache\nyum repolist\n```\n\n\n\n### 2.2 基础服务安装\n\n#### 2.2.1 NTP时间同步\n\ncontroller与阿里NTP服务器同步\n\n```shell\n vim /etc/chrony.conf\n server ntp6.aliyun.com # 3行\n allow 10.0.0.0/24 # 24行\n systemctl restart chronyd\n```\n\ncomputer与controller同步\n\n```shell\nvim /etc/chrony.conf\nserver 10.0.0.11 iburst # 3行\nsystemctl restart chronyd\n```\n\n#### 2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\n\n```shell\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nyum makecache\nyum list | grep openstack\nyum install centos-release-openstack-ocata.noarch -y # 安装O版\n```\n\n#### 2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）\n\n```shell\nyum install python-openstackclient openstack-selinux -y\n```\n\n#### 2.2.4 安装和配置mariadb (仅控制节点执行)\n\n安装\n\n```shell\nyum install mariadb mariadb-server python2-PyMySQL -y\n```\n\n配置\n\n```shell\nvim /etc/my.cnf.d/openstack.cnf\n\n#----------------\n[mysqld]\t\nbind-address = 10.0.0.11\t# 监听地址\ndefault-storage-engine = innodb # 默认存储引擎\ninnodb_file_per_table  # 独立表空间文件\nmax_connections = 4096\t# 最大连接数\ncollation-server = utf8_general_ci\t# 默认字符集utf8\ncharacter-set-server = utf8\n#-----------------\n\n# 启动服务\nsystemctl start mariadb\nsystemctl enable mariadb\n\n# 数据库安全初始化,保障数据库安全性，如果不执行，同步数据库表会报错\nmysql_secure_installation\n回车 n y y y y\n```\n\n#### 2.2.5 消息队列配置(仅控制节点执行)\n\n```shell\n# 安装rabbitmq\nyum install rabbitmq-server -y\n# 启动服务\nsystemctl start rabbitmq-server\nsystemctl enable rabbitmq-server\n# 添加用户\nrabbitmqctl add_user openstack RABBIT_PASS\n# 设置用户权限（读、写、执行）\nrabbitmqctl set_permissions openstack \".*\" \".*\" \".*\"\nrabbitmq-plugins enable rabbitmq_management\n# 查看是否开启15672端口\nnetstat -lntup\n# 浏览器登录rabbitmq\nhttp://10.0.0.11:15672\n默认用户名和密码：guest\n```\n\n#### 2.2.6 缓存系统配置memcache（仅控制节点执行）\n\n```shell\n# 安装\nyum install memcached python-memched -y\n# 配置\nsed -i 's#127.0.0.1#10.0.0.11#g' /etc/sysconfig/memcached\n# 启动服务\nsystemctl restart memcached\nsystemctl enable memcached\n# 查询端口11211是否已监听，默认使用该端口\n```\n\n### 2.3 安装keystone认证服务(仅控制节点执行)\n\n#### 2.3.1 Keystone功能介绍\n\n```shell\n1、认证管理：\n\t账户密码\n2、授权管理\n3、服务目录：\n\t跟电话本一样，keystone上可以查询到glance、nova等服务的地址端口等信息，每一个新加的服务都需要在keystone上注册\n```\n\n#### 2.3.2 OpenStack服务器安装的通用步骤\n\n```shell\n1、创库授权\n2、在Keystone创建用户，关联角色\n3、在keystone创建服务，注册api\n4、安装服务相关的软件包\n5、修改配置\n\t数据库的连接\n\tkeystone认证授权信息\n\trabbitmq连接信息\n\t其他配置\n6、同步数据库，创建表\n7、启动服务\n```\n\n#### 2.3.3 安装步骤\n\n1、创库授权\n\n```mysql\n# 登录mysql\n$ mysql -u root -p\n# 创建keystone数据库\nCREATE DATABASE keystone;\n# 对``keystone``数据库授予恰当的权限\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \\\n  IDENTIFIED BY 'KEYSTONE_DBPASS';\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \\\n  IDENTIFIED BY 'KEYSTONE_DBPASS';\n```\n\n2、安装keystone相关软件包\n\n```shell\nyum install openstack-keystone httpd mod_wsgi -y\n```\n\n3、修改配置文件\n\n```shell\n# 备份原配置文件\n\\cp /etc/keystone/keystone.conf{,.bak}\n# 去除配置文件中的空格行和注释行\ngrep -Ev '^$|#' /etc/keystone/keystone.conf.bak > /etc/keystone/keystone.conf\n\n# 安装自动配置工具\nyum install openstack-utils -y\n# 使用工具设置（也可以直接修改文件）修改项 参数 = 值\nopenstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN\nopenstack-config --set /etc/keystone/keystone.conf database connection  mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone # 注意hostname--controller\nopenstack-config --set /etc/keystone/keystone.conf token provider fernet\n# 校验\nmd5sum /etc/keystone/keystone.conf\nd5acb3db852fe3f247f4f872b051b7a9 \n\n# 同步数据库\nsu -s /bin/sh -c \"keystone-manage db_sync\" keystone\n# 查询是否生成表\nmysql keystone -e \"show tables;\"\n\n# 初始化fernet\nkeystone-manage fernet_setup --keystone-user keystone --keystone-group keystone\n# 验证\n/etc/keystone/fernet-keys已创建\n\n# 配置httpd\necho \"ServerName controller\" >> /etc/httpd/conf/httpd.conf\n\n# 创建wsgi配置文件\nvim /etc/httpd/conf.d/wsgi-keystone.conf\n###内容\nListen 5000\nListen 35357\n\n<VirtualHost *:5000>\n    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\n    WSGIProcessGroup keystone-public\n    WSGIScriptAlias / /usr/bin/keystone-wsgi-public\n    WSGIApplicationGroup %{GLOBAL}\n    WSGIPassAuthorization On\n    ErrorLogFormat \"%{cu}t %M\"\n    ErrorLog /var/log/httpd/keystone-error.log\n    CustomLog /var/log/httpd/keystone-access.log combined\n\n    <Directory /usr/bin>\n        Require all granted\n    </Directory>\n</VirtualHost>\n\n<VirtualHost *:35357>\n    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\n    WSGIProcessGroup keystone-admin\n    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin\n    WSGIApplicationGroup %{GLOBAL}\n    WSGIPassAuthorization On\n    ErrorLogFormat \"%{cu}t %M\"\n    ErrorLog /var/log/httpd/keystone-error.log\n    CustomLog /var/log/httpd/keystone-access.log combined\n\n    <Directory /usr/bin>\n        Require all granted\n    </Directory>\n</VirtualHost>\n# 校验\nmd5sum /etc/httpd/conf.d/wsgi-keystone.conf\n8f051eb53577f67356ed03e4550315c2 \n\n# 启动httpd\nsystemctl enable httpd\nsystemctl start httpd\n\n# 创建服务和注册api\nexport OS_TOKEN=ADMIN_TOKEN\nexport OS_URL=http://controller:35357/v3\nexport OS_IDENTITY_API_VERSION=3\nopenstack service create --name keystone --description \"OpenStack Identity\" identity\nopenstack endpoint create --region RegionOne identity public http://controller:5000/v3\nopenstack endpoint create --region RegionOne identity internal http://controller:5000/v3\nopenstack endpoint create --region RegionOne identity admin http://controller:35357/v3\n\n# 创建域、项目（租户）、用户和角色\nopenstack domain create --description \"Default Domain\" default\nopenstack project create --domain default --description \"Admin Project\" admin\nopenstack user create --domain default --password ADMIN_PASS admin\nopenstack role create admin\n\n# 关联项目，用户，角色\nopenstack role add --project admin --user admin admin\n# 在admin项目上，给admin用户赋予admin角色\nopenstack project create --domain default --description \"Service Project\" service\n\n# 创建环境变量脚本\nexport OS_PROJECT_DOMAIN_NAME=default\nexport OS_USER_DOMAIN_NAME=default\nexport OS_PROJECT_NAME=admin\nexport OS_USERNAME=admin\nexport OS_PASSWORD=ADMIN_PASS\nexport OS_IMAGE_API_VERSION=2\nexport OS_IDENTITY_API_VERSION=3\nexport OS_AUTH_URL=http://controller:35357/v3\n\n# 作为admin用户请求认证令牌\nopenstack token issue  \n\n# 如果不设置环境变量可以通过传入参数的方式申请\nopenstack --os-auth-url http://controller:35357/v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name admin --os-username admin --os-password ADMIN_PASS token issue\n\n# 查看用户列表\nopenstack user list\n\n# 查看endpoint列表\nopenstack endpoint list\n```\n\n### 2.4 安装glance镜像服务\n\n​\t镜像服务 (glance) 允许用户发现、注册和获取虚拟机镜像。\n\n#### 2.4.1 安装步骤\n\n```shell\n# 数据库创库授权\nmysql >>\nCREATE DATABASE glance\nGRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \\\n  IDENTIFIED BY 'GLANCE_DBPASS';\nGRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \\\n  IDENTIFIED BY 'GLANCE_DBPASS';\n  \n # 在keystone创建glance用户关联角色\n openstack user create --domain default --password GLANCE_PASS glance\n openstack role add --project service --user glance admin\n \n # 在keystone上创建服务和注册api\nopenstack service create --name glance   --description \"OpenStack Image\" image\nopenstack endpoint create --region RegionOne \\\n  image public http://controller:9292\nopenstack endpoint create --region RegionOne \\\n  image internal http://controller:9292\nopenstack endpoint create --region RegionOne \\\n  image admin http://controller:9292\n  \n# 查看已创建的信息\nopenstack role assignment list\nopenstack role list\nopenstack project list\nopenstack user list （要有glance用户）\n\n# mysql中验证表是否已创建\n[root@controller ~]# mysql keystone -e \"show tables;\" | grep user\nfederated_user\nlocal_user\nuser\nuser_group_membership\n[root@controller ~]# mysql keystone -e \"show tables;\" | grep project\nproject\nproject_endpoint\nproject_endpoint_group\n\n# 安装服务相应软件包\nyum install openstack-glance -y\n\n# 修改相应的配置文件--api\ncp /etc/glance/glance-api.conf{,.bak}\ngrep '^[a-Z\\[]' /etc/glance/glance-api.conf.bak > /etc/glance/glance-api.conf\nopenstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone\nopenstack-config --set /etc/glance/glance-api.conf glance_store stores file,http\nopenstack-config --set /etc/glance/glance-api.conf glance_store default_store file\nopenstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/\n\n# 修改相应的配置文件--registry\ncp /etc/glance/glance-registry.conf{,.bak}\ngrep '^[a-Z\\[]' /etc/glance/glance-registry.conf.bak > /etc/glance/glance-registry.conf\nopenstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone\n\n# md5值验证\nmd5sum /etc/glance/glance-api.conf\n3e1a4234c133eda11b413788e001cba3  /etc/glance/glance-api.conf\nmd5sum /etc/glance/glance-registry.conf\n46acabd81a65b924256f56fe34d90b8f  /etc/glance/glance-registry.conf\n\n# 写入镜像服务数据库\nsu -s /bin/sh -c \"glance-manage db_sync\" glance # 会有Warning不用在意\n# 验证\nmysql glance -e \"show tables;\"\n\n# 启动服务\nsystemctl enable openstack-glance-api.service   openstack-glance-registry.service\nsystemctl start openstack-glance-api.service   openstack-glance-registry.service\n```\n\n#### 2.4.2 上传镜像测试\n\n```shell\n# 错误日志查看\n/var/log/glance\n\n# 确保已获取token令牌\nopenstack token issue\n\n# 下载测试镜像\nwget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img\n\n# 上传测试镜像\nopenstack image create \"cirros\" \\\n--file cirros-0.3.4-x86_64-disk.img \\\n--disk-format qcow2 --container-format bare \\\n--public\n\n# 上传文件确认\nls /var/lib/glance/images/ (在/etc/glance/glance-api.conf中设置)\nmysql glance -e \"show tables;\" | grep image\n```\n\n### 2.5 安装nova计算服务\n\n```shell\nnova-api -- 接受并相应所有的计算服务请求，管理云主机生命周期\nnova-compute（多个）-- 真正管理虚拟机(nova-compute调用libvirt)\nnova-scheduler -- nova 调度器（挑选最合适的nova-compute）\nnova-conductor -- 帮助nova-compute连接数据库\nnova-network --  早期版本管理虚拟机的网络（已弃用，改用neutron，留着为了方便兼容早期版本）\nnova-consoleauth和nova-novncproxy -- web版的vnc来直接操作云主机\nnovnproxy -- web版vnc客户端\nnova-api-metadata -- 接受来自虚拟机发送的元数据请求（配合neutron-metadata-agent实现虚拟机定制化）\n```\n\n#### 2.5.1 控制节点--安装步骤\n\n```shell\n# 创库授权\nmysql >>\nCREATE DATABASE nova_api;\nCREATE DATABASE nova;\nGRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\n  \n# 在keystone创建用户nova\nopenstack user create --domain default   --password NOVA_PASS nova\n# 给Nova用户添加admin角色\nopenstack role add --project service --user nova admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name nova   --description \"OpenStack Compute\" compute\nopenstack endpoint create --region RegionOne   compute public http://controller:8774/v2.1/%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute internal http://controller:8774/v2.1/%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute admin http://controller:8774/v2.1/%\\(tenant_id\\)s\n\n# 安装相应软件包\nyum install -y openstack-nova-api openstack-nova-conductor \\\n  openstack-nova-console openstack-nova-novncproxy \\\n  openstack-nova-scheduler\n  \n# 修改配置文件\ncp /etc/nova/nova.conf{,.bak}\ngrep -Ev '^$|#' /etc/nova/nova.conf.bak > /etc/nova/nova.conf\n\nopenstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.11\nopenstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True\nopenstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api\nopenstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova\nopenstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken username nova\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_listen '$my_ip'\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip'\n\n# 校验\nmd5sum /etc/nova/nova.conf\n47ded61fdd1a79ab91bdb37ce59ef192  /etc/nova/nova.conf\n\n# 同步数据库\nsu -s /bin/sh -c \"nova-manage api_db sync\" nova\nsu -s /bin/sh -c \"nova-manage db sync\" nova\n\n# 验证\nmysql nova_api -e \"show tables;\"\nmysql nova -e \"show tables;\"\n\n# 启动服务\nsystemctl enable openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\nsystemctl restart openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\n\n# 验证\n[root@controller ~]# nova service-list\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| Id | Binary           | Host       | Zone     | Status  | State | Updated_at | Disabled Reason |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| 1  | nova-conductor   | controller | internal | enabled | down  | -          | -               |\n| 4  | nova-scheduler   | controller | internal | enabled | down  | -          | -               |\n| 5  | nova-consoleauth | controller | internal | enabled | down  | -          | -               |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n\n# novncproxy 怎么检测起来没有？\n[root@controller ~]# netstat -lntup | grep 6080\ntcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      8719/python2\n[root@controller ~]# ps -ef | grep 8719\nnova       8719      1  0 21:53 ?        00:00:01 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/\n```\n\n#### 2.5.1 计算节点--安装步骤\n\n```shell\n# 安装软件包\nyum install -y openstack-nova-compute openstack-utils\n\n# 修改配置文件\ncp /etc/nova/nova.conf{,.bak}\ngrep -Ev '^$|#' /etc/nova/nova.conf.bak > /etc/nova/nova.conf\n\nopenstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.31 # 注意ip\nopenstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True\nopenstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken username nova\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/nova/nova.conf vnc enabled  True\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip'\nopenstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html\n\n# 校验\nmd5sum /etc/nova/nova.conf\n45cab6030a9ab82761e9f697d6d79e14  /etc/nova/nova.conf\n\n# 启动服务\nsystemctl enable libvirtd.service openstack-nova-compute.service\nsystemctl restart libvirtd.service openstack-nova-compute.service\n\n# 服务启动错误排查\n参考博客：https://www.codeleading.com/article/89785382846/\ncat /etc/nova/nova.conf # compute1日志查看\n报错 nova AccessRefused: (0, 0): (403) ACCESS_REFUSED\n处理步骤：\n在controller\ncat /var/log/rabbitmq/rabbit@controller.log # 发现报错AMQPLAIN login refused: user 'openstack' - invalid credentials 无效凭证\nrabbitmqctl list_users # 确认是否还有openstack用户\nrabbitmqctl add_user openstack RABBIT_PASS\nrabbitmqctl set_permissions openstack \".*\" \".*\" \".*\"\nsystemctl restart rabbitmq-server.service # 重新创用户，并重启服务\n```\n\n### 2.6 安装neutron网络服务\n\nneutron-server -- 端口9696，api接受和响应外部的网络管理请求\n\nneutron-linuxbridge-agent --  负责创建桥接网卡\n\nneutron-dhcp-agent -- 负责分配ip\n\nneutron-metadata-agent --  配合nova-metadata-api实现虚拟机的定制化操作\n\nL3-agent -- 实现三层网络vxlan（网络层）\n\n#### 2.6.1 控制节点--安装步骤\n\n```shell\n# 创库授权\nMysql >>\nCREATE DATABASE neutron;\nGRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \\\n  IDENTIFIED BY 'NEUTRON_DBPASS';\nGRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \\\n  IDENTIFIED BY 'NEUTRON_DBPASS';\n  \n# 在keystone创建用户neutron\nopenstack user create --domain default   --password NEUTRON_PASS neutron\n# 给neutron用户添加admin角色\nopenstack role add --project service --user neutron admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name neutron   --description \"OpenStack Networking\" network\nopenstack endpoint create --region RegionOne   network public http://controller:9696\nopenstack endpoint create --region RegionOne   network internal http://controller:9696\nopenstack endpoint create --region RegionOne   network admin http://controller:9696\n\n# 网络配置--公共网络\ncp /etc/neutron/neutron.conf{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/neutron.conf.bak  > /etc/neutron/neutron.conf\n>>>>>\nopenstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf nova auth_type password\nopenstack-config --set /etc/neutron/neutron.conf nova project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf nova user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne\nopenstack-config --set /etc/neutron/neutron.conf nova project_name service\nopenstack-config --set /etc/neutron/neutron.conf nova username nova\nopenstack-config --set /etc/neutron/neutron.conf nova password NOVA_PASS\nopenstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp\n>>>>>\n\ncp /etc/neutron/plugins/ml2/ml2_conf.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/ml2_conf.ini.bak > /etc/neutron/plugins/ml2/ml2_conf.ini\n>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True\n>>>>>\n\ncp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak > /etc/neutron/plugins/ml2/linuxbridge_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n>>>>>\n\ncp /etc/neutron/dhcp_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/dhcp_agent.ini.bak > /etc/neutron/dhcp_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT  dhcp_driver neutron.agent.linux.dhcp.Dnsmasq\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT  enable_isolated_metadata True\n>>>>>\n\ncp /etc/neutron/metadata_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/metadata_agent.ini.bak > /etc/neutron/metadata_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller\nopenstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET\n>>>>>\n\n# 再次修改nova配置文件，添加neutron服务\nopenstack-config --set /etc/nova/nova.conf neutron url http://controller:9696\nopenstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf neutron auth_type password\nopenstack-config --set /etc/nova/nova.conf neutron project_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron user_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron region_name RegionOne\nopenstack-config --set /etc/nova/nova.conf neutron project_name service\nopenstack-config --set /etc/nova/nova.conf neutron username neutron\nopenstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS\nopenstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy True\nopenstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET\n# 校验文件\n[root@controller ~]# md5sum /etc/nova/nova.conf\n6334f359655efdbcf083b812ab94efc1  /etc/nova/nova.conf\n\n# 网络服务初始化脚本需要一个超链接\nln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini\n\n# 同步数据库\nsu -s /bin/sh -c \"neutron-db-manage --config-file /etc/neutron/neutron.conf \\\n  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head\" neutron\n  \n# 检查数据库\nmysql neutron -e \"show tables;\"\n\n# 重启Nova服务\nsystemctl restart openstack-nova-api.service\n\n# 启动Neutron服务\nsystemctl enable neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\nsystemctl start neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\n\n# 查看服务有没有起来\nneutron agent-list\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| 0d68dc27-f2b8-4cae-9c30-cddd126076b4 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |\n| 688cc47d-424d-4243-ae2b-b1c4b298a2a8 | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |\n| c4c5e360-ee02-4b9b-a1a5-59a0d0d088b0 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n```\n\n#### 2.6.2 计算节点--安装步骤\n\n```shell\n# 安装组件\nyum install -y openstack-neutron-linuxbridge ebtables ipset\n\n# 网络配置--公共网络\ncp /etc/neutron/neutron.conf{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/neutron.conf.bak  > /etc/neutron/neutron.conf\n>>>>>>\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp\n>>>>>>\n# md5校验\nmd5sum /etc/nova/nova.conf\n328cd5f0745e26a420e828b0dfc2934e  /etc/nova/nova.conf\n\ncp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak > /etc/neutron/plugins/ml2/linuxbridge_agent.ini\n>>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n>>>>>>\n\n# 再次修改nova配置文件，添加neutron配置\nopenstack-config --set /etc/nova/nova.conf neutron url http://controller:9696\nopenstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf neutron auth_type password\nopenstack-config --set /etc/nova/nova.conf neutron project_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron user_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron region_name RegionOne\nopenstack-config --set /etc/nova/nova.conf neutron project_name service\nopenstack-config --set /etc/nova/nova.conf neutron username neutron\nopenstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS\n\n# 重启nova服务\nsystemctl restart openstack-nova-compute.service\n\n# 启动linuxbridge代理服务\nsystemctl enable neutron-linuxbridge-agent.service\nsystemctl restart neutron-linuxbridge-agent.service\n\n# 查看是否配置成功\ncontroller执行 >> neutron agent-list\n配置正确会多出来一个\nLinux bridge agent | compute1   |                   | :-)   | True \n\n# 查看计算资源\nopenstack compute service list\n```\n\n### 2.7 安装horizon （Dashboard）web界面\n\n#### 2.7.1 安装步骤（控制节点)\n\n```shell\n# 安装组件包\nyum install -y openstack-dashboard\n\n# 修改配置文件\nvim /etc/openstack-dashboard/local_settings\n>>>>\nOPENSTACK_HOST = \"controller\"\nALLOWED_HOSTS = ['*', ]\nSESSION_ENGINE = 'django.contrib.sessions.backends.cache'\nCACHES = {\n    'default': {\n         'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',\n         'LOCATION': 'controller:11211',\n    }\n}\nOPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST\nOPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True\nOPENSTACK_API_VERSIONS = {\n    \"identity\": 3,\n    \"image\": 2,\n    \"volume\": 2,\n}\nOPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \"default\"\nOPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\"\nOPENSTACK_NEUTRON_NETWORK = {\n    ...\n    'enable_router': False,\n    'enable_quotas': False,\n    'enable_distributed_router': False,\n    'enable_ha_router': False,\n    'enable_lb': False,\n    'enable_firewall': False,\n    'enable_vpn': False,\n    'enable_fip_topology_check': False,\n}\nTIME_ZONE = \"Asia/Shanghai\"\n>>>>\n\n# 解决不能进入页面的BUG\nvim /etc/httpd/conf.d/openstack-dashboard.conf\n添加一行 >> WSGIAppicationGroup %{GLOBAL}\n\n# 重启服务\nsystemctl restart httpd.service memcached.service\n\n# 登录界面\nhttps://10.0.0.11/dashboard\n域:default\n用户名:admin\n密码:ADMIN_PASS\n\n# 扩展：查看文件输入那个rpm包\nrpm -qf /etc/openstack-dashboard/local_settings\n```\n\n#### 2.7.2 Dashboard报错解决\n\n```shell\n# 问题1--Invalid service catalog service: image\n发生原因：\n\topenstack service list 存在两个 glance\n解决方法：\n    openstack service delete c12c125edc2041e3aaf2f250442162c6\n    openstack service delete 6a11431b95bc44d1bd1e9371c0faa16b # 两个glance都删掉\n    重复2.4.1在keystone上创建glance服务和注册api\n    再重启服务systemctl restart httpd.service memcached.service\n```\n\n### 2.8 启动一个云主机\n\n### 2.8.1 创建步骤\n\n```shell\n# 创建网络\nneutron net-create --shared --provider:physical_network provider \\\n  --provider:network_type flat gs\n  \n# 在网络中创建一个子网\nneutron subnet-create --name gs2 \\\n  --allocation-pool start=10.0.0.101,end=10.0.0.250 \\\n  --dns-nameserver 223.5.5.5 --gateway 10.0.0.2 \\\n  gs 10.0.0.0/24\n  \n# 创建云主机硬件配置方案（规格）\nopenstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano\n\n# 创建密钥键值对\nssh-keygen -q -N \"\" -f ~/.ssh/id_rsa\nopenstack keypair create --public-key ~/.ssh/id_rsa.pub mykey\n# 验证公钥的添加\nopenstack keypair list\n\n# 添加安全组规则\nopenstack security group rule create --proto icmp default\nopenstack security group rule create --proto tcp --dst-port 22 default\n\n# 在公有网络启动一个实例\nopenstack flavor list # 查看可用的配置规格\nopenstack image list # 查看可用镜像\nopenstack network list # 查看可用网络\nopenstack security group list # 查看已设置的安全组\n\nopenstack server create --flavor 规格名/ID --image 镜像名/ID \\\n  --nic net-id=网络ID --security-group default \\\n  --key-name mykey 实例名称\n示例：\nopenstack server create --flavor m1.tiny --image cirros \\\n--nic net-id=cb032582-893b-414d-b78d-c89c6548612d --security-group default \\\n--key-name mykey my-instance\n```\n\n### 2.8.2 创建云主机问题解决\n\n```shell\n# 1、启动云主机时，No valid host was found\n【计算节点中】\n查看云主机创建日志：/var/log/nova/nova-compute.log，里面有记录问题原因是CPU feature spec-ctrl not found\n修改/usr/share/libvirt/cpu_map.xml，将和spec-ctrl相关的特性删除\n然后重启服务\nsystemctl restart libvirtd openstack-nova-compute\n参考博客：https://www.cnblogs.com/laolieren/p/solve_openstack_create_instance_error.html\n\n# 2、云主机控制台seabios -- Booting from Hard Disk错误\n【计算节点中】\nvim /etc/nova/nova.conf\n>>>>\n[libvirt]\nvirt_type = qemu\ncpu_mode = none\n>>>>\nsystemctl restart libvirtd openstack-nova-compute\n重启云主机\n```\n\n\n\n\n\n\n\n","source":"_posts/01_运维/04-虚拟化/OpenStack学习笔记.md","raw":"---\ntitle: OpenStack学习笔记\ncategories:\n- 运维\n- （四）虚拟化之OpenStack\ntags:\n---\n\n# **<font color=green>OpenStack笔记</font>**\n\n​\tOpenStack实现的是云计算IAAS\n\n## <font color=blue>一、服务架构发展</font>\n\n### 1.1 MVC架构\n\n​\t业务不拆分，一个服务挂，则所有的全挂\n\n```shell\n首页 www.jd.com/index.html\n秒杀 www.jd.com/miaosha/index.html\n优惠券 www.jd.com/juan/index.html\n```\n\n### 1.2 SOA架构（千万级）\n\n​\t业务拆分，每一个功能都拆分成一个独立的web服务，每个独立的web服务，都至少拥有一个集群\n\n```she\n首页 www.jd.com/index.html\n秒杀 miaosha.jd.com/index.html\n优惠券 juan.jd.com/index.html\n```\n\n### 1.3 微服务架构（亿级）\n\n阿里开源dubbo\n\nSpring Boot\n\n自动化代码上线：Jekins + gilab ci\n\n自动化代码质量检查：sonarqube\n\n\n\n## <font color=blue>二、搭建OpenStack</font>\n\n​\t本流程为手动安装M版，脚本安装可以参考\n\n```shell\nhttps://my.oschina.net/u/4367225/blog/4255750\n```\n\nOpenStack的结构介绍：\n\n>Nova -- 提供VM虚拟化支持 8774\n>\n>Glance -- 提供镜像 9292\n>\n>Clinder -- 存储支持 8776\n>\n>Neutron -- 网络支持 9696\n>\n>Cellometer --  监控计费 \n>\n>KeyStone -- 登录认证\n>\n>Horizon -- 网页UI，dashboard\n>\n>Heat -- 部署编排，批量建虚拟机\n>\n>Switft -- 对象存储（不是传统的文件夹存放，而是用数据库记录已上传的文件信息，当有文件上传，先查询数据库中是否有该文件的md5值，如果有，则不用重新上传，给个链接就是 --- 百度云盘）\n\n![image-20210615135957367](C:\\Users\\fr724\\AppData\\Roaming\\Typora\\typora-user-images\\image-20210615135957367.png)\n\n### 2.1 虚拟机准备\n\n虚拟机规划\n\n```shell\n# 系统：CentOS7.4\ncontroller: 内存3G, CPU开启虚拟化\t10.0.0.11\ncompute1: 内存1G，CPU开启虚拟化\t    10.0.0.31\n# 修改主机名，IP地址，host解析，测试ping百度\n```\n\n配置本地M版yum源\n\n```shell\n# 1、资源准备\nmount /dev/cdrom /mnt # 追加到/etc/rc.local,自动挂载\n解压openstack_rpm.tar.gz到/opt/repo\n\n# 2、编辑repo文件\nvim /etc/yum.repo.d/local/repo\n\n#### 内容\n[local]\nname=local\nbaseurl=file:///mnt\ngpgcheck=0\n\n[openstack]\nname=openstack\nbaseurl=file:///opt/repo\ngpgcheck=0\n####\n\n# 3、更新yum源\nyum makecache\nyum repolist\n```\n\n\n\n### 2.2 基础服务安装\n\n#### 2.2.1 NTP时间同步\n\ncontroller与阿里NTP服务器同步\n\n```shell\n vim /etc/chrony.conf\n server ntp6.aliyun.com # 3行\n allow 10.0.0.0/24 # 24行\n systemctl restart chronyd\n```\n\ncomputer与controller同步\n\n```shell\nvim /etc/chrony.conf\nserver 10.0.0.11 iburst # 3行\nsystemctl restart chronyd\n```\n\n#### 2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\n\n```shell\ncurl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo\nyum makecache\nyum list | grep openstack\nyum install centos-release-openstack-ocata.noarch -y # 安装O版\n```\n\n#### 2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）\n\n```shell\nyum install python-openstackclient openstack-selinux -y\n```\n\n#### 2.2.4 安装和配置mariadb (仅控制节点执行)\n\n安装\n\n```shell\nyum install mariadb mariadb-server python2-PyMySQL -y\n```\n\n配置\n\n```shell\nvim /etc/my.cnf.d/openstack.cnf\n\n#----------------\n[mysqld]\t\nbind-address = 10.0.0.11\t# 监听地址\ndefault-storage-engine = innodb # 默认存储引擎\ninnodb_file_per_table  # 独立表空间文件\nmax_connections = 4096\t# 最大连接数\ncollation-server = utf8_general_ci\t# 默认字符集utf8\ncharacter-set-server = utf8\n#-----------------\n\n# 启动服务\nsystemctl start mariadb\nsystemctl enable mariadb\n\n# 数据库安全初始化,保障数据库安全性，如果不执行，同步数据库表会报错\nmysql_secure_installation\n回车 n y y y y\n```\n\n#### 2.2.5 消息队列配置(仅控制节点执行)\n\n```shell\n# 安装rabbitmq\nyum install rabbitmq-server -y\n# 启动服务\nsystemctl start rabbitmq-server\nsystemctl enable rabbitmq-server\n# 添加用户\nrabbitmqctl add_user openstack RABBIT_PASS\n# 设置用户权限（读、写、执行）\nrabbitmqctl set_permissions openstack \".*\" \".*\" \".*\"\nrabbitmq-plugins enable rabbitmq_management\n# 查看是否开启15672端口\nnetstat -lntup\n# 浏览器登录rabbitmq\nhttp://10.0.0.11:15672\n默认用户名和密码：guest\n```\n\n#### 2.2.6 缓存系统配置memcache（仅控制节点执行）\n\n```shell\n# 安装\nyum install memcached python-memched -y\n# 配置\nsed -i 's#127.0.0.1#10.0.0.11#g' /etc/sysconfig/memcached\n# 启动服务\nsystemctl restart memcached\nsystemctl enable memcached\n# 查询端口11211是否已监听，默认使用该端口\n```\n\n### 2.3 安装keystone认证服务(仅控制节点执行)\n\n#### 2.3.1 Keystone功能介绍\n\n```shell\n1、认证管理：\n\t账户密码\n2、授权管理\n3、服务目录：\n\t跟电话本一样，keystone上可以查询到glance、nova等服务的地址端口等信息，每一个新加的服务都需要在keystone上注册\n```\n\n#### 2.3.2 OpenStack服务器安装的通用步骤\n\n```shell\n1、创库授权\n2、在Keystone创建用户，关联角色\n3、在keystone创建服务，注册api\n4、安装服务相关的软件包\n5、修改配置\n\t数据库的连接\n\tkeystone认证授权信息\n\trabbitmq连接信息\n\t其他配置\n6、同步数据库，创建表\n7、启动服务\n```\n\n#### 2.3.3 安装步骤\n\n1、创库授权\n\n```mysql\n# 登录mysql\n$ mysql -u root -p\n# 创建keystone数据库\nCREATE DATABASE keystone;\n# 对``keystone``数据库授予恰当的权限\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' \\\n  IDENTIFIED BY 'KEYSTONE_DBPASS';\nGRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' \\\n  IDENTIFIED BY 'KEYSTONE_DBPASS';\n```\n\n2、安装keystone相关软件包\n\n```shell\nyum install openstack-keystone httpd mod_wsgi -y\n```\n\n3、修改配置文件\n\n```shell\n# 备份原配置文件\n\\cp /etc/keystone/keystone.conf{,.bak}\n# 去除配置文件中的空格行和注释行\ngrep -Ev '^$|#' /etc/keystone/keystone.conf.bak > /etc/keystone/keystone.conf\n\n# 安装自动配置工具\nyum install openstack-utils -y\n# 使用工具设置（也可以直接修改文件）修改项 参数 = 值\nopenstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token ADMIN_TOKEN\nopenstack-config --set /etc/keystone/keystone.conf database connection  mysql+pymysql://keystone:KEYSTONE_DBPASS@controller/keystone # 注意hostname--controller\nopenstack-config --set /etc/keystone/keystone.conf token provider fernet\n# 校验\nmd5sum /etc/keystone/keystone.conf\nd5acb3db852fe3f247f4f872b051b7a9 \n\n# 同步数据库\nsu -s /bin/sh -c \"keystone-manage db_sync\" keystone\n# 查询是否生成表\nmysql keystone -e \"show tables;\"\n\n# 初始化fernet\nkeystone-manage fernet_setup --keystone-user keystone --keystone-group keystone\n# 验证\n/etc/keystone/fernet-keys已创建\n\n# 配置httpd\necho \"ServerName controller\" >> /etc/httpd/conf/httpd.conf\n\n# 创建wsgi配置文件\nvim /etc/httpd/conf.d/wsgi-keystone.conf\n###内容\nListen 5000\nListen 35357\n\n<VirtualHost *:5000>\n    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\n    WSGIProcessGroup keystone-public\n    WSGIScriptAlias / /usr/bin/keystone-wsgi-public\n    WSGIApplicationGroup %{GLOBAL}\n    WSGIPassAuthorization On\n    ErrorLogFormat \"%{cu}t %M\"\n    ErrorLog /var/log/httpd/keystone-error.log\n    CustomLog /var/log/httpd/keystone-access.log combined\n\n    <Directory /usr/bin>\n        Require all granted\n    </Directory>\n</VirtualHost>\n\n<VirtualHost *:35357>\n    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone display-name=%{GROUP}\n    WSGIProcessGroup keystone-admin\n    WSGIScriptAlias / /usr/bin/keystone-wsgi-admin\n    WSGIApplicationGroup %{GLOBAL}\n    WSGIPassAuthorization On\n    ErrorLogFormat \"%{cu}t %M\"\n    ErrorLog /var/log/httpd/keystone-error.log\n    CustomLog /var/log/httpd/keystone-access.log combined\n\n    <Directory /usr/bin>\n        Require all granted\n    </Directory>\n</VirtualHost>\n# 校验\nmd5sum /etc/httpd/conf.d/wsgi-keystone.conf\n8f051eb53577f67356ed03e4550315c2 \n\n# 启动httpd\nsystemctl enable httpd\nsystemctl start httpd\n\n# 创建服务和注册api\nexport OS_TOKEN=ADMIN_TOKEN\nexport OS_URL=http://controller:35357/v3\nexport OS_IDENTITY_API_VERSION=3\nopenstack service create --name keystone --description \"OpenStack Identity\" identity\nopenstack endpoint create --region RegionOne identity public http://controller:5000/v3\nopenstack endpoint create --region RegionOne identity internal http://controller:5000/v3\nopenstack endpoint create --region RegionOne identity admin http://controller:35357/v3\n\n# 创建域、项目（租户）、用户和角色\nopenstack domain create --description \"Default Domain\" default\nopenstack project create --domain default --description \"Admin Project\" admin\nopenstack user create --domain default --password ADMIN_PASS admin\nopenstack role create admin\n\n# 关联项目，用户，角色\nopenstack role add --project admin --user admin admin\n# 在admin项目上，给admin用户赋予admin角色\nopenstack project create --domain default --description \"Service Project\" service\n\n# 创建环境变量脚本\nexport OS_PROJECT_DOMAIN_NAME=default\nexport OS_USER_DOMAIN_NAME=default\nexport OS_PROJECT_NAME=admin\nexport OS_USERNAME=admin\nexport OS_PASSWORD=ADMIN_PASS\nexport OS_IMAGE_API_VERSION=2\nexport OS_IDENTITY_API_VERSION=3\nexport OS_AUTH_URL=http://controller:35357/v3\n\n# 作为admin用户请求认证令牌\nopenstack token issue  \n\n# 如果不设置环境变量可以通过传入参数的方式申请\nopenstack --os-auth-url http://controller:35357/v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name admin --os-username admin --os-password ADMIN_PASS token issue\n\n# 查看用户列表\nopenstack user list\n\n# 查看endpoint列表\nopenstack endpoint list\n```\n\n### 2.4 安装glance镜像服务\n\n​\t镜像服务 (glance) 允许用户发现、注册和获取虚拟机镜像。\n\n#### 2.4.1 安装步骤\n\n```shell\n# 数据库创库授权\nmysql >>\nCREATE DATABASE glance\nGRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' \\\n  IDENTIFIED BY 'GLANCE_DBPASS';\nGRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' \\\n  IDENTIFIED BY 'GLANCE_DBPASS';\n  \n # 在keystone创建glance用户关联角色\n openstack user create --domain default --password GLANCE_PASS glance\n openstack role add --project service --user glance admin\n \n # 在keystone上创建服务和注册api\nopenstack service create --name glance   --description \"OpenStack Image\" image\nopenstack endpoint create --region RegionOne \\\n  image public http://controller:9292\nopenstack endpoint create --region RegionOne \\\n  image internal http://controller:9292\nopenstack endpoint create --region RegionOne \\\n  image admin http://controller:9292\n  \n# 查看已创建的信息\nopenstack role assignment list\nopenstack role list\nopenstack project list\nopenstack user list （要有glance用户）\n\n# mysql中验证表是否已创建\n[root@controller ~]# mysql keystone -e \"show tables;\" | grep user\nfederated_user\nlocal_user\nuser\nuser_group_membership\n[root@controller ~]# mysql keystone -e \"show tables;\" | grep project\nproject\nproject_endpoint\nproject_endpoint_group\n\n# 安装服务相应软件包\nyum install openstack-glance -y\n\n# 修改相应的配置文件--api\ncp /etc/glance/glance-api.conf{,.bak}\ngrep '^[a-Z\\[]' /etc/glance/glance-api.conf.bak > /etc/glance/glance-api.conf\nopenstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance\nopenstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone\nopenstack-config --set /etc/glance/glance-api.conf glance_store stores file,http\nopenstack-config --set /etc/glance/glance-api.conf glance_store default_store file\nopenstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/\n\n# 修改相应的配置文件--registry\ncp /etc/glance/glance-registry.conf{,.bak}\ngrep '^[a-Z\\[]' /etc/glance/glance-registry.conf.bak > /etc/glance/glance-registry.conf\nopenstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@controller/glance\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance\nopenstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone\n\n# md5值验证\nmd5sum /etc/glance/glance-api.conf\n3e1a4234c133eda11b413788e001cba3  /etc/glance/glance-api.conf\nmd5sum /etc/glance/glance-registry.conf\n46acabd81a65b924256f56fe34d90b8f  /etc/glance/glance-registry.conf\n\n# 写入镜像服务数据库\nsu -s /bin/sh -c \"glance-manage db_sync\" glance # 会有Warning不用在意\n# 验证\nmysql glance -e \"show tables;\"\n\n# 启动服务\nsystemctl enable openstack-glance-api.service   openstack-glance-registry.service\nsystemctl start openstack-glance-api.service   openstack-glance-registry.service\n```\n\n#### 2.4.2 上传镜像测试\n\n```shell\n# 错误日志查看\n/var/log/glance\n\n# 确保已获取token令牌\nopenstack token issue\n\n# 下载测试镜像\nwget http://download.cirros-cloud.net/0.3.4/cirros-0.3.4-x86_64-disk.img\n\n# 上传测试镜像\nopenstack image create \"cirros\" \\\n--file cirros-0.3.4-x86_64-disk.img \\\n--disk-format qcow2 --container-format bare \\\n--public\n\n# 上传文件确认\nls /var/lib/glance/images/ (在/etc/glance/glance-api.conf中设置)\nmysql glance -e \"show tables;\" | grep image\n```\n\n### 2.5 安装nova计算服务\n\n```shell\nnova-api -- 接受并相应所有的计算服务请求，管理云主机生命周期\nnova-compute（多个）-- 真正管理虚拟机(nova-compute调用libvirt)\nnova-scheduler -- nova 调度器（挑选最合适的nova-compute）\nnova-conductor -- 帮助nova-compute连接数据库\nnova-network --  早期版本管理虚拟机的网络（已弃用，改用neutron，留着为了方便兼容早期版本）\nnova-consoleauth和nova-novncproxy -- web版的vnc来直接操作云主机\nnovnproxy -- web版vnc客户端\nnova-api-metadata -- 接受来自虚拟机发送的元数据请求（配合neutron-metadata-agent实现虚拟机定制化）\n```\n\n#### 2.5.1 控制节点--安装步骤\n\n```shell\n# 创库授权\nmysql >>\nCREATE DATABASE nova_api;\nCREATE DATABASE nova;\nGRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'localhost' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova_api.* TO 'nova'@'%' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova.* TO 'nova'@'localhost' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\nGRANT ALL PRIVILEGES ON nova.* TO 'nova'@'%' \\\n  IDENTIFIED BY 'NOVA_DBPASS';\n  \n# 在keystone创建用户nova\nopenstack user create --domain default   --password NOVA_PASS nova\n# 给Nova用户添加admin角色\nopenstack role add --project service --user nova admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name nova   --description \"OpenStack Compute\" compute\nopenstack endpoint create --region RegionOne   compute public http://controller:8774/v2.1/%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute internal http://controller:8774/v2.1/%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute admin http://controller:8774/v2.1/%\\(tenant_id\\)s\n\n# 安装相应软件包\nyum install -y openstack-nova-api openstack-nova-conductor \\\n  openstack-nova-console openstack-nova-novncproxy \\\n  openstack-nova-scheduler\n  \n# 修改配置文件\ncp /etc/nova/nova.conf{,.bak}\ngrep -Ev '^$|#' /etc/nova/nova.conf.bak > /etc/nova/nova.conf\n\nopenstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.11\nopenstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True\nopenstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set /etc/nova/nova.conf api_database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api\nopenstack-config --set /etc/nova/nova.conf database connection mysql+pymysql://nova:NOVA_DBPASS@controller/nova\nopenstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken username nova\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_listen '$my_ip'\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip'\n\n# 校验\nmd5sum /etc/nova/nova.conf\n47ded61fdd1a79ab91bdb37ce59ef192  /etc/nova/nova.conf\n\n# 同步数据库\nsu -s /bin/sh -c \"nova-manage api_db sync\" nova\nsu -s /bin/sh -c \"nova-manage db sync\" nova\n\n# 验证\nmysql nova_api -e \"show tables;\"\nmysql nova -e \"show tables;\"\n\n# 启动服务\nsystemctl enable openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\nsystemctl restart openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\n\n# 验证\n[root@controller ~]# nova service-list\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| Id | Binary           | Host       | Zone     | Status  | State | Updated_at | Disabled Reason |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| 1  | nova-conductor   | controller | internal | enabled | down  | -          | -               |\n| 4  | nova-scheduler   | controller | internal | enabled | down  | -          | -               |\n| 5  | nova-consoleauth | controller | internal | enabled | down  | -          | -               |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n\n# novncproxy 怎么检测起来没有？\n[root@controller ~]# netstat -lntup | grep 6080\ntcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      8719/python2\n[root@controller ~]# ps -ef | grep 8719\nnova       8719      1  0 21:53 ?        00:00:01 /usr/bin/python2 /usr/bin/nova-novncproxy --web /usr/share/novnc/\n```\n\n#### 2.5.1 计算节点--安装步骤\n\n```shell\n# 安装软件包\nyum install -y openstack-nova-compute openstack-utils\n\n# 修改配置文件\ncp /etc/nova/nova.conf{,.bak}\ngrep -Ev '^$|#' /etc/nova/nova.conf.bak > /etc/nova/nova.conf\n\nopenstack-config --set /etc/nova/nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/nova/nova.conf DEFAULT my_ip 10.0.0.31 # 注意ip\nopenstack-config --set /etc/nova/nova.conf DEFAULT use_neutron True\nopenstack-config --set /etc/nova/nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set /etc/nova/nova.conf glance api_servers http://controller:9292\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken project_name service\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken username nova\nopenstack-config --set /etc/nova/nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set /etc/nova/nova.conf oslo_concurrency lock_path /var/lib/nova/tmp\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/nova/nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/nova/nova.conf vnc enabled  True\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_listen 0.0.0.0\nopenstack-config --set /etc/nova/nova.conf vnc vncserver_proxyclient_address '$my_ip'\nopenstack-config --set /etc/nova/nova.conf vnc novncproxy_base_url http://controller:6080/vnc_auto.html\n\n# 校验\nmd5sum /etc/nova/nova.conf\n45cab6030a9ab82761e9f697d6d79e14  /etc/nova/nova.conf\n\n# 启动服务\nsystemctl enable libvirtd.service openstack-nova-compute.service\nsystemctl restart libvirtd.service openstack-nova-compute.service\n\n# 服务启动错误排查\n参考博客：https://www.codeleading.com/article/89785382846/\ncat /etc/nova/nova.conf # compute1日志查看\n报错 nova AccessRefused: (0, 0): (403) ACCESS_REFUSED\n处理步骤：\n在controller\ncat /var/log/rabbitmq/rabbit@controller.log # 发现报错AMQPLAIN login refused: user 'openstack' - invalid credentials 无效凭证\nrabbitmqctl list_users # 确认是否还有openstack用户\nrabbitmqctl add_user openstack RABBIT_PASS\nrabbitmqctl set_permissions openstack \".*\" \".*\" \".*\"\nsystemctl restart rabbitmq-server.service # 重新创用户，并重启服务\n```\n\n### 2.6 安装neutron网络服务\n\nneutron-server -- 端口9696，api接受和响应外部的网络管理请求\n\nneutron-linuxbridge-agent --  负责创建桥接网卡\n\nneutron-dhcp-agent -- 负责分配ip\n\nneutron-metadata-agent --  配合nova-metadata-api实现虚拟机的定制化操作\n\nL3-agent -- 实现三层网络vxlan（网络层）\n\n#### 2.6.1 控制节点--安装步骤\n\n```shell\n# 创库授权\nMysql >>\nCREATE DATABASE neutron;\nGRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' \\\n  IDENTIFIED BY 'NEUTRON_DBPASS';\nGRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' \\\n  IDENTIFIED BY 'NEUTRON_DBPASS';\n  \n# 在keystone创建用户neutron\nopenstack user create --domain default   --password NEUTRON_PASS neutron\n# 给neutron用户添加admin角色\nopenstack role add --project service --user neutron admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name neutron   --description \"OpenStack Networking\" network\nopenstack endpoint create --region RegionOne   network public http://controller:9696\nopenstack endpoint create --region RegionOne   network internal http://controller:9696\nopenstack endpoint create --region RegionOne   network admin http://controller:9696\n\n# 网络配置--公共网络\ncp /etc/neutron/neutron.conf{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/neutron.conf.bak  > /etc/neutron/neutron.conf\n>>>>>\nopenstack-config --set /etc/neutron/neutron.conf database connection mysql+pymysql://neutron:NEUTRON_DBPASS@controller/neutron\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT core_plugin ml2\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT service_plugins\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_status_changes True\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT notify_nova_on_port_data_changes True\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set /etc/neutron/neutron.conf nova auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf nova auth_type password\nopenstack-config --set /etc/neutron/neutron.conf nova project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf nova user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf nova region_name RegionOne\nopenstack-config --set /etc/neutron/neutron.conf nova project_name service\nopenstack-config --set /etc/neutron/neutron.conf nova username nova\nopenstack-config --set /etc/neutron/neutron.conf nova password NOVA_PASS\nopenstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp\n>>>>>\n\ncp /etc/neutron/plugins/ml2/ml2_conf.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/ml2_conf.ini.bak > /etc/neutron/plugins/ml2/ml2_conf.ini\n>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 type_drivers flat,vlan\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 tenant_network_types\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 mechanism_drivers linuxbridge\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 extension_drivers port_security\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_type_flat flat_networks provider\nopenstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup enable_ipset True\n>>>>>\n\ncp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak > /etc/neutron/plugins/ml2/linuxbridge_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n>>>>>\n\ncp /etc/neutron/dhcp_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/dhcp_agent.ini.bak > /etc/neutron/dhcp_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT  dhcp_driver neutron.agent.linux.dhcp.Dnsmasq\nopenstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT  enable_isolated_metadata True\n>>>>>\n\ncp /etc/neutron/metadata_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/metadata_agent.ini.bak > /etc/neutron/metadata_agent.ini\n>>>>>\nopenstack-config --set /etc/neutron/metadata_agent.ini DEFAULT nova_metadata_ip controller\nopenstack-config --set /etc/neutron/metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET\n>>>>>\n\n# 再次修改nova配置文件，添加neutron服务\nopenstack-config --set /etc/nova/nova.conf neutron url http://controller:9696\nopenstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf neutron auth_type password\nopenstack-config --set /etc/nova/nova.conf neutron project_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron user_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron region_name RegionOne\nopenstack-config --set /etc/nova/nova.conf neutron project_name service\nopenstack-config --set /etc/nova/nova.conf neutron username neutron\nopenstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS\nopenstack-config --set /etc/nova/nova.conf neutron service_metadata_proxy True\nopenstack-config --set /etc/nova/nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET\n# 校验文件\n[root@controller ~]# md5sum /etc/nova/nova.conf\n6334f359655efdbcf083b812ab94efc1  /etc/nova/nova.conf\n\n# 网络服务初始化脚本需要一个超链接\nln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini\n\n# 同步数据库\nsu -s /bin/sh -c \"neutron-db-manage --config-file /etc/neutron/neutron.conf \\\n  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head\" neutron\n  \n# 检查数据库\nmysql neutron -e \"show tables;\"\n\n# 重启Nova服务\nsystemctl restart openstack-nova-api.service\n\n# 启动Neutron服务\nsystemctl enable neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\nsystemctl start neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\n\n# 查看服务有没有起来\nneutron agent-list\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| 0d68dc27-f2b8-4cae-9c30-cddd126076b4 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |\n| 688cc47d-424d-4243-ae2b-b1c4b298a2a8 | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |\n| c4c5e360-ee02-4b9b-a1a5-59a0d0d088b0 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n```\n\n#### 2.6.2 计算节点--安装步骤\n\n```shell\n# 安装组件\nyum install -y openstack-neutron-linuxbridge ebtables ipset\n\n# 网络配置--公共网络\ncp /etc/neutron/neutron.conf{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/neutron.conf.bak  > /etc/neutron/neutron.conf\n>>>>>>\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set /etc/neutron/neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set /etc/neutron/neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_uri http://controller:5000\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_url http://controller:35357\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken auth_type password\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken project_name service\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken username neutron\nopenstack-config --set /etc/neutron/neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set /etc/neutron/neutron.conf oslo_concurrency lock_path /var/lib/neutron/tmp\n>>>>>>\n# md5校验\nmd5sum /etc/nova/nova.conf\n328cd5f0745e26a420e828b0dfc2934e  /etc/nova/nova.conf\n\ncp /etc/neutron/plugins/ml2/linuxbridge_agent.ini{,.bak}\ngrep -Ev \"^$|#\" /etc/neutron/plugins/ml2/linuxbridge_agent.ini.bak > /etc/neutron/plugins/ml2/linuxbridge_agent.ini\n>>>>>>\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set /etc/neutron/plugins/ml2/linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n>>>>>>\n\n# 再次修改nova配置文件，添加neutron配置\nopenstack-config --set /etc/nova/nova.conf neutron url http://controller:9696\nopenstack-config --set /etc/nova/nova.conf neutron auth_url http://controller:35357\nopenstack-config --set /etc/nova/nova.conf neutron auth_type password\nopenstack-config --set /etc/nova/nova.conf neutron project_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron user_domain_name default\nopenstack-config --set /etc/nova/nova.conf neutron region_name RegionOne\nopenstack-config --set /etc/nova/nova.conf neutron project_name service\nopenstack-config --set /etc/nova/nova.conf neutron username neutron\nopenstack-config --set /etc/nova/nova.conf neutron password NEUTRON_PASS\n\n# 重启nova服务\nsystemctl restart openstack-nova-compute.service\n\n# 启动linuxbridge代理服务\nsystemctl enable neutron-linuxbridge-agent.service\nsystemctl restart neutron-linuxbridge-agent.service\n\n# 查看是否配置成功\ncontroller执行 >> neutron agent-list\n配置正确会多出来一个\nLinux bridge agent | compute1   |                   | :-)   | True \n\n# 查看计算资源\nopenstack compute service list\n```\n\n### 2.7 安装horizon （Dashboard）web界面\n\n#### 2.7.1 安装步骤（控制节点)\n\n```shell\n# 安装组件包\nyum install -y openstack-dashboard\n\n# 修改配置文件\nvim /etc/openstack-dashboard/local_settings\n>>>>\nOPENSTACK_HOST = \"controller\"\nALLOWED_HOSTS = ['*', ]\nSESSION_ENGINE = 'django.contrib.sessions.backends.cache'\nCACHES = {\n    'default': {\n         'BACKEND': 'django.core.cache.backends.memcached.MemcachedCache',\n         'LOCATION': 'controller:11211',\n    }\n}\nOPENSTACK_KEYSTONE_URL = \"http://%s:5000/v3\" % OPENSTACK_HOST\nOPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT = True\nOPENSTACK_API_VERSIONS = {\n    \"identity\": 3,\n    \"image\": 2,\n    \"volume\": 2,\n}\nOPENSTACK_KEYSTONE_DEFAULT_DOMAIN = \"default\"\nOPENSTACK_KEYSTONE_DEFAULT_ROLE = \"user\"\nOPENSTACK_NEUTRON_NETWORK = {\n    ...\n    'enable_router': False,\n    'enable_quotas': False,\n    'enable_distributed_router': False,\n    'enable_ha_router': False,\n    'enable_lb': False,\n    'enable_firewall': False,\n    'enable_vpn': False,\n    'enable_fip_topology_check': False,\n}\nTIME_ZONE = \"Asia/Shanghai\"\n>>>>\n\n# 解决不能进入页面的BUG\nvim /etc/httpd/conf.d/openstack-dashboard.conf\n添加一行 >> WSGIAppicationGroup %{GLOBAL}\n\n# 重启服务\nsystemctl restart httpd.service memcached.service\n\n# 登录界面\nhttps://10.0.0.11/dashboard\n域:default\n用户名:admin\n密码:ADMIN_PASS\n\n# 扩展：查看文件输入那个rpm包\nrpm -qf /etc/openstack-dashboard/local_settings\n```\n\n#### 2.7.2 Dashboard报错解决\n\n```shell\n# 问题1--Invalid service catalog service: image\n发生原因：\n\topenstack service list 存在两个 glance\n解决方法：\n    openstack service delete c12c125edc2041e3aaf2f250442162c6\n    openstack service delete 6a11431b95bc44d1bd1e9371c0faa16b # 两个glance都删掉\n    重复2.4.1在keystone上创建glance服务和注册api\n    再重启服务systemctl restart httpd.service memcached.service\n```\n\n### 2.8 启动一个云主机\n\n### 2.8.1 创建步骤\n\n```shell\n# 创建网络\nneutron net-create --shared --provider:physical_network provider \\\n  --provider:network_type flat gs\n  \n# 在网络中创建一个子网\nneutron subnet-create --name gs2 \\\n  --allocation-pool start=10.0.0.101,end=10.0.0.250 \\\n  --dns-nameserver 223.5.5.5 --gateway 10.0.0.2 \\\n  gs 10.0.0.0/24\n  \n# 创建云主机硬件配置方案（规格）\nopenstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano\n\n# 创建密钥键值对\nssh-keygen -q -N \"\" -f ~/.ssh/id_rsa\nopenstack keypair create --public-key ~/.ssh/id_rsa.pub mykey\n# 验证公钥的添加\nopenstack keypair list\n\n# 添加安全组规则\nopenstack security group rule create --proto icmp default\nopenstack security group rule create --proto tcp --dst-port 22 default\n\n# 在公有网络启动一个实例\nopenstack flavor list # 查看可用的配置规格\nopenstack image list # 查看可用镜像\nopenstack network list # 查看可用网络\nopenstack security group list # 查看已设置的安全组\n\nopenstack server create --flavor 规格名/ID --image 镜像名/ID \\\n  --nic net-id=网络ID --security-group default \\\n  --key-name mykey 实例名称\n示例：\nopenstack server create --flavor m1.tiny --image cirros \\\n--nic net-id=cb032582-893b-414d-b78d-c89c6548612d --security-group default \\\n--key-name mykey my-instance\n```\n\n### 2.8.2 创建云主机问题解决\n\n```shell\n# 1、启动云主机时，No valid host was found\n【计算节点中】\n查看云主机创建日志：/var/log/nova/nova-compute.log，里面有记录问题原因是CPU feature spec-ctrl not found\n修改/usr/share/libvirt/cpu_map.xml，将和spec-ctrl相关的特性删除\n然后重启服务\nsystemctl restart libvirtd openstack-nova-compute\n参考博客：https://www.cnblogs.com/laolieren/p/solve_openstack_create_instance_error.html\n\n# 2、云主机控制台seabios -- Booting from Hard Disk错误\n【计算节点中】\nvim /etc/nova/nova.conf\n>>>>\n[libvirt]\nvirt_type = qemu\ncpu_mode = none\n>>>>\nsystemctl restart libvirtd openstack-nova-compute\n重启云主机\n```\n\n\n\n\n\n\n\n","slug":"01_运维/04-虚拟化/OpenStack学习笔记","published":1,"date":"2022-07-06T03:07:13.601Z","updated":"2022-07-06T07:20:29.878Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0n001ba8v795gu10ha","content":"<h1 id=\"OpenStack笔记\"><a href=\"#OpenStack笔记\" class=\"headerlink\" title=\"OpenStack笔记\"></a><strong><font color=green>OpenStack笔记</font></strong></h1><p>​\tOpenStack实现的是云计算IAAS</p>\n<h2 id=\"一、服务架构发展\"><a href=\"#一、服务架构发展\" class=\"headerlink\" title=\"一、服务架构发展\"></a><font color=blue>一、服务架构发展</font></h2><h3 id=\"1-1-MVC架构\"><a href=\"#1-1-MVC架构\" class=\"headerlink\" title=\"1.1 MVC架构\"></a>1.1 MVC架构</h3><p>​\t业务不拆分，一个服务挂，则所有的全挂</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">首页 www.jd.com&#x2F;index.html\n秒杀 www.jd.com&#x2F;miaosha&#x2F;index.html\n优惠券 www.jd.com&#x2F;juan&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-SOA架构（千万级）\"><a href=\"#1-2-SOA架构（千万级）\" class=\"headerlink\" title=\"1.2 SOA架构（千万级）\"></a>1.2 SOA架构（千万级）</h3><p>​\t业务拆分，每一个功能都拆分成一个独立的web服务，每个独立的web服务，都至少拥有一个集群</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">首页 www.jd.com&#x2F;index.html\n秒杀 miaosha.jd.com&#x2F;index.html\n优惠券 juan.jd.com&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-微服务架构（亿级）\"><a href=\"#1-3-微服务架构（亿级）\" class=\"headerlink\" title=\"1.3 微服务架构（亿级）\"></a>1.3 微服务架构（亿级）</h3><p>阿里开源dubbo</p>\n<p>Spring Boot</p>\n<p>自动化代码上线：Jekins + gilab ci</p>\n<p>自动化代码质量检查：sonarqube</p>\n<h2 id=\"二、搭建OpenStack\"><a href=\"#二、搭建OpenStack\" class=\"headerlink\" title=\"二、搭建OpenStack\"></a><font color=blue>二、搭建OpenStack</font></h2><p>​\t本流程为手动安装M版，脚本安装可以参考</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;my.oschina.net&#x2F;u&#x2F;4367225&#x2F;blog&#x2F;4255750<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>OpenStack的结构介绍：</p>\n<blockquote>\n<p>Nova – 提供VM虚拟化支持 8774</p>\n<p>Glance – 提供镜像 9292</p>\n<p>Clinder – 存储支持 8776</p>\n<p>Neutron – 网络支持 9696</p>\n<p>Cellometer –  监控计费 </p>\n<p>KeyStone – 登录认证</p>\n<p>Horizon – 网页UI，dashboard</p>\n<p>Heat – 部署编排，批量建虚拟机</p>\n<p>Switft – 对象存储（不是传统的文件夹存放，而是用数据库记录已上传的文件信息，当有文件上传，先查询数据库中是否有该文件的md5值，如果有，则不用重新上传，给个链接就是 — 百度云盘）</p>\n</blockquote>\n<p><img src=\"C:\\Users\\fr724\\AppData\\Roaming\\Typora\\typora-user-images\\image-20210615135957367.png\" alt=\"image-20210615135957367\"></p>\n<h3 id=\"2-1-虚拟机准备\"><a href=\"#2-1-虚拟机准备\" class=\"headerlink\" title=\"2.1 虚拟机准备\"></a>2.1 虚拟机准备</h3><p>虚拟机规划</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 系统：CentOS7.4\ncontroller: 内存3G, CPU开启虚拟化\t10.0.0.11\ncompute1: 内存1G，CPU开启虚拟化\t    10.0.0.31\n# 修改主机名，IP地址，host解析，测试ping百度<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置本地M版yum源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1、资源准备\nmount &#x2F;dev&#x2F;cdrom &#x2F;mnt # 追加到&#x2F;etc&#x2F;rc.local,自动挂载\n解压openstack_rpm.tar.gz到&#x2F;opt&#x2F;repo\n\n# 2、编辑repo文件\nvim &#x2F;etc&#x2F;yum.repo.d&#x2F;local&#x2F;repo\n\n#### 内容\n[local]\nname&#x3D;local\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;mnt\ngpgcheck&#x3D;0\n\n[openstack]\nname&#x3D;openstack\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;opt&#x2F;repo\ngpgcheck&#x3D;0\n####\n\n# 3、更新yum源\nyum makecache\nyum repolist<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"2-2-基础服务安装\"><a href=\"#2-2-基础服务安装\" class=\"headerlink\" title=\"2.2 基础服务安装\"></a>2.2 基础服务安装</h3><h4 id=\"2-2-1-NTP时间同步\"><a href=\"#2-2-1-NTP时间同步\" class=\"headerlink\" title=\"2.2.1 NTP时间同步\"></a>2.2.1 NTP时间同步</h4><p>controller与阿里NTP服务器同步</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;chrony.conf\nserver ntp6.aliyun.com # 3行\nallow 10.0.0.0&#x2F;24 # 24行\nsystemctl restart chronyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>computer与controller同步</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;chrony.conf\nserver 10.0.0.11 iburst # 3行\nsystemctl restart chronyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-2-扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\"><a href=\"#2-2-2-扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\" class=\"headerlink\" title=\"2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\"></a>2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\nyum makecache\nyum list | grep openstack\nyum install centos-release-openstack-ocata.noarch -y # 安装O版<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-3-安装OpenStack客户端openstack-selinux-（所有节点执行）\"><a href=\"#2-2-3-安装OpenStack客户端openstack-selinux-（所有节点执行）\" class=\"headerlink\" title=\"2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）\"></a>2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install python-openstackclient openstack-selinux -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-2-4-安装和配置mariadb-仅控制节点执行\"><a href=\"#2-2-4-安装和配置mariadb-仅控制节点执行\" class=\"headerlink\" title=\"2.2.4 安装和配置mariadb (仅控制节点执行)\"></a>2.2.4 安装和配置mariadb (仅控制节点执行)</h4><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install mariadb mariadb-server python2-PyMySQL -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;my.cnf.d&#x2F;openstack.cnf\n\n#----------------\n[mysqld]\t\nbind-address &#x3D; 10.0.0.11\t# 监听地址\ndefault-storage-engine &#x3D; innodb # 默认存储引擎\ninnodb_file_per_table  # 独立表空间文件\nmax_connections &#x3D; 4096\t# 最大连接数\ncollation-server &#x3D; utf8_general_ci\t# 默认字符集utf8\ncharacter-set-server &#x3D; utf8\n#-----------------\n\n# 启动服务\nsystemctl start mariadb\nsystemctl enable mariadb\n\n# 数据库安全初始化,保障数据库安全性，如果不执行，同步数据库表会报错\nmysql_secure_installation\n回车 n y y y y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-5-消息队列配置-仅控制节点执行\"><a href=\"#2-2-5-消息队列配置-仅控制节点执行\" class=\"headerlink\" title=\"2.2.5 消息队列配置(仅控制节点执行)\"></a>2.2.5 消息队列配置(仅控制节点执行)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装rabbitmq\nyum install rabbitmq-server -y\n# 启动服务\nsystemctl start rabbitmq-server\nsystemctl enable rabbitmq-server\n# 添加用户\nrabbitmqctl add_user openstack RABBIT_PASS\n# 设置用户权限（读、写、执行）\nrabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;\nrabbitmq-plugins enable rabbitmq_management\n# 查看是否开启15672端口\nnetstat -lntup\n# 浏览器登录rabbitmq\nhttp:&#x2F;&#x2F;10.0.0.11:15672\n默认用户名和密码：guest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-6-缓存系统配置memcache（仅控制节点执行）\"><a href=\"#2-2-6-缓存系统配置memcache（仅控制节点执行）\" class=\"headerlink\" title=\"2.2.6 缓存系统配置memcache（仅控制节点执行）\"></a>2.2.6 缓存系统配置memcache（仅控制节点执行）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装\nyum install memcached python-memched -y\n# 配置\nsed -i &#39;s#127.0.0.1#10.0.0.11#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;memcached\n# 启动服务\nsystemctl restart memcached\nsystemctl enable memcached\n# 查询端口11211是否已监听，默认使用该端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-安装keystone认证服务-仅控制节点执行\"><a href=\"#2-3-安装keystone认证服务-仅控制节点执行\" class=\"headerlink\" title=\"2.3 安装keystone认证服务(仅控制节点执行)\"></a>2.3 安装keystone认证服务(仅控制节点执行)</h3><h4 id=\"2-3-1-Keystone功能介绍\"><a href=\"#2-3-1-Keystone功能介绍\" class=\"headerlink\" title=\"2.3.1 Keystone功能介绍\"></a>2.3.1 Keystone功能介绍</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、认证管理：\n\t账户密码\n2、授权管理\n3、服务目录：\n\t跟电话本一样，keystone上可以查询到glance、nova等服务的地址端口等信息，每一个新加的服务都需要在keystone上注册<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-2-OpenStack服务器安装的通用步骤\"><a href=\"#2-3-2-OpenStack服务器安装的通用步骤\" class=\"headerlink\" title=\"2.3.2 OpenStack服务器安装的通用步骤\"></a>2.3.2 OpenStack服务器安装的通用步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、创库授权\n2、在Keystone创建用户，关联角色\n3、在keystone创建服务，注册api\n4、安装服务相关的软件包\n5、修改配置\n\t数据库的连接\n\tkeystone认证授权信息\n\trabbitmq连接信息\n\t其他配置\n6、同步数据库，创建表\n7、启动服务<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-3-安装步骤\"><a href=\"#2-3-3-安装步骤\" class=\"headerlink\" title=\"2.3.3 安装步骤\"></a>2.3.3 安装步骤</h4><p>1、创库授权</p>\n<pre class=\"line-numbers language-mysql\" data-language=\"mysql\"><code class=\"language-mysql\"># 登录mysql\n$ mysql -u root -p\n# 创建keystone数据库\nCREATE DATABASE keystone;\n# 对&#96;&#96;keystone&#96;&#96;数据库授予恰当的权限\nGRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、安装keystone相关软件包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install openstack-keystone httpd mod_wsgi -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、修改配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 备份原配置文件\n\\cp &#x2F;etc&#x2F;keystone&#x2F;keystone.conf&#123;,.bak&#125;\n# 去除配置文件中的空格行和注释行\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;keystone&#x2F;keystone.conf.bak &gt; &#x2F;etc&#x2F;keystone&#x2F;keystone.conf\n\n# 安装自动配置工具\nyum install openstack-utils -y\n# 使用工具设置（也可以直接修改文件）修改项 参数 &#x3D; 值\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf DEFAULT admin_token ADMIN_TOKEN\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf database connection  mysql+pymysql:&#x2F;&#x2F;keystone:KEYSTONE_DBPASS@controller&#x2F;keystone # 注意hostname--controller\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf token provider fernet\n# 校验\nmd5sum &#x2F;etc&#x2F;keystone&#x2F;keystone.conf\nd5acb3db852fe3f247f4f872b051b7a9 \n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;keystone-manage db_sync&quot; keystone\n# 查询是否生成表\nmysql keystone -e &quot;show tables;&quot;\n\n# 初始化fernet\nkeystone-manage fernet_setup --keystone-user keystone --keystone-group keystone\n# 验证\n&#x2F;etc&#x2F;keystone&#x2F;fernet-keys已创建\n\n# 配置httpd\necho &quot;ServerName controller&quot; &gt;&gt; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf\n\n# 创建wsgi配置文件\nvim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;wsgi-keystone.conf\n###内容\nListen 5000\nListen 35357\n\n&lt;VirtualHost *:5000&gt;\n    WSGIDaemonProcess keystone-public processes&#x3D;5 threads&#x3D;1 user&#x3D;keystone group&#x3D;keystone display-name&#x3D;%&#123;GROUP&#125;\n    WSGIProcessGroup keystone-public\n    WSGIScriptAlias &#x2F; &#x2F;usr&#x2F;bin&#x2F;keystone-wsgi-public\n    WSGIApplicationGroup %&#123;GLOBAL&#125;\n    WSGIPassAuthorization On\n    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;\n    ErrorLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-error.log\n    CustomLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-access.log combined\n\n    &lt;Directory &#x2F;usr&#x2F;bin&gt;\n        Require all granted\n    &lt;&#x2F;Directory&gt;\n&lt;&#x2F;VirtualHost&gt;\n\n&lt;VirtualHost *:35357&gt;\n    WSGIDaemonProcess keystone-admin processes&#x3D;5 threads&#x3D;1 user&#x3D;keystone group&#x3D;keystone display-name&#x3D;%&#123;GROUP&#125;\n    WSGIProcessGroup keystone-admin\n    WSGIScriptAlias &#x2F; &#x2F;usr&#x2F;bin&#x2F;keystone-wsgi-admin\n    WSGIApplicationGroup %&#123;GLOBAL&#125;\n    WSGIPassAuthorization On\n    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;\n    ErrorLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-error.log\n    CustomLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-access.log combined\n\n    &lt;Directory &#x2F;usr&#x2F;bin&gt;\n        Require all granted\n    &lt;&#x2F;Directory&gt;\n&lt;&#x2F;VirtualHost&gt;\n# 校验\nmd5sum &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;wsgi-keystone.conf\n8f051eb53577f67356ed03e4550315c2 \n\n# 启动httpd\nsystemctl enable httpd\nsystemctl start httpd\n\n# 创建服务和注册api\nexport OS_TOKEN&#x3D;ADMIN_TOKEN\nexport OS_URL&#x3D;http:&#x2F;&#x2F;controller:35357&#x2F;v3\nexport OS_IDENTITY_API_VERSION&#x3D;3\nopenstack service create --name keystone --description &quot;OpenStack Identity&quot; identity\nopenstack endpoint create --region RegionOne identity public http:&#x2F;&#x2F;controller:5000&#x2F;v3\nopenstack endpoint create --region RegionOne identity internal http:&#x2F;&#x2F;controller:5000&#x2F;v3\nopenstack endpoint create --region RegionOne identity admin http:&#x2F;&#x2F;controller:35357&#x2F;v3\n\n# 创建域、项目（租户）、用户和角色\nopenstack domain create --description &quot;Default Domain&quot; default\nopenstack project create --domain default --description &quot;Admin Project&quot; admin\nopenstack user create --domain default --password ADMIN_PASS admin\nopenstack role create admin\n\n# 关联项目，用户，角色\nopenstack role add --project admin --user admin admin\n# 在admin项目上，给admin用户赋予admin角色\nopenstack project create --domain default --description &quot;Service Project&quot; service\n\n# 创建环境变量脚本\nexport OS_PROJECT_DOMAIN_NAME&#x3D;default\nexport OS_USER_DOMAIN_NAME&#x3D;default\nexport OS_PROJECT_NAME&#x3D;admin\nexport OS_USERNAME&#x3D;admin\nexport OS_PASSWORD&#x3D;ADMIN_PASS\nexport OS_IMAGE_API_VERSION&#x3D;2\nexport OS_IDENTITY_API_VERSION&#x3D;3\nexport OS_AUTH_URL&#x3D;http:&#x2F;&#x2F;controller:35357&#x2F;v3\n\n# 作为admin用户请求认证令牌\nopenstack token issue  \n\n# 如果不设置环境变量可以通过传入参数的方式申请\nopenstack --os-auth-url http:&#x2F;&#x2F;controller:35357&#x2F;v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name admin --os-username admin --os-password ADMIN_PASS token issue\n\n# 查看用户列表\nopenstack user list\n\n# 查看endpoint列表\nopenstack endpoint list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-安装glance镜像服务\"><a href=\"#2-4-安装glance镜像服务\" class=\"headerlink\" title=\"2.4 安装glance镜像服务\"></a>2.4 安装glance镜像服务</h3><p>​\t镜像服务 (glance) 允许用户发现、注册和获取虚拟机镜像。</p>\n<h4 id=\"2-4-1-安装步骤\"><a href=\"#2-4-1-安装步骤\" class=\"headerlink\" title=\"2.4.1 安装步骤\"></a>2.4.1 安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 数据库创库授权\nmysql &gt;&gt;\nCREATE DATABASE glance\nGRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;\n  \n # 在keystone创建glance用户关联角色\n openstack user create --domain default --password GLANCE_PASS glance\n openstack role add --project service --user glance admin\n \n # 在keystone上创建服务和注册api\nopenstack service create --name glance   --description &quot;OpenStack Image&quot; image\nopenstack endpoint create --region RegionOne \\\n  image public http:&#x2F;&#x2F;controller:9292\nopenstack endpoint create --region RegionOne \\\n  image internal http:&#x2F;&#x2F;controller:9292\nopenstack endpoint create --region RegionOne \\\n  image admin http:&#x2F;&#x2F;controller:9292\n  \n# 查看已创建的信息\nopenstack role assignment list\nopenstack role list\nopenstack project list\nopenstack user list （要有glance用户）\n\n# mysql中验证表是否已创建\n[root@controller ~]# mysql keystone -e &quot;show tables;&quot; | grep user\nfederated_user\nlocal_user\nuser\nuser_group_membership\n[root@controller ~]# mysql keystone -e &quot;show tables;&quot; | grep project\nproject\nproject_endpoint\nproject_endpoint_group\n\n# 安装服务相应软件包\nyum install openstack-glance -y\n\n# 修改相应的配置文件--api\ncp &#x2F;etc&#x2F;glance&#x2F;glance-api.conf&#123;,.bak&#125;\ngrep &#39;^[a-Z\\[]&#39; &#x2F;etc&#x2F;glance&#x2F;glance-api.conf.bak &gt; &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf database connection mysql+pymysql:&#x2F;&#x2F;glance:GLANCE_DBPASS@controller&#x2F;glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken username glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf paste_deploy flavor keystone\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store stores file,http\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store default_store file\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store filesystem_store_datadir &#x2F;var&#x2F;lib&#x2F;glance&#x2F;images&#x2F;\n\n# 修改相应的配置文件--registry\ncp &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf&#123;,.bak&#125;\ngrep &#39;^[a-Z\\[]&#39; &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf.bak &gt; &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf database connection mysql+pymysql:&#x2F;&#x2F;glance:GLANCE_DBPASS@controller&#x2F;glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken username glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf paste_deploy flavor keystone\n\n# md5值验证\nmd5sum &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\n3e1a4234c133eda11b413788e001cba3  &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\nmd5sum &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\n46acabd81a65b924256f56fe34d90b8f  &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\n\n# 写入镜像服务数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;glance-manage db_sync&quot; glance # 会有Warning不用在意\n# 验证\nmysql glance -e &quot;show tables;&quot;\n\n# 启动服务\nsystemctl enable openstack-glance-api.service   openstack-glance-registry.service\nsystemctl start openstack-glance-api.service   openstack-glance-registry.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-4-2-上传镜像测试\"><a href=\"#2-4-2-上传镜像测试\" class=\"headerlink\" title=\"2.4.2 上传镜像测试\"></a>2.4.2 上传镜像测试</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 错误日志查看\n&#x2F;var&#x2F;log&#x2F;glance\n\n# 确保已获取token令牌\nopenstack token issue\n\n# 下载测试镜像\nwget http:&#x2F;&#x2F;download.cirros-cloud.net&#x2F;0.3.4&#x2F;cirros-0.3.4-x86_64-disk.img\n\n# 上传测试镜像\nopenstack image create &quot;cirros&quot; \\\n--file cirros-0.3.4-x86_64-disk.img \\\n--disk-format qcow2 --container-format bare \\\n--public\n\n# 上传文件确认\nls &#x2F;var&#x2F;lib&#x2F;glance&#x2F;images&#x2F; (在&#x2F;etc&#x2F;glance&#x2F;glance-api.conf中设置)\nmysql glance -e &quot;show tables;&quot; | grep image<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-安装nova计算服务\"><a href=\"#2-5-安装nova计算服务\" class=\"headerlink\" title=\"2.5 安装nova计算服务\"></a>2.5 安装nova计算服务</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nova-api -- 接受并相应所有的计算服务请求，管理云主机生命周期\nnova-compute（多个）-- 真正管理虚拟机(nova-compute调用libvirt)\nnova-scheduler -- nova 调度器（挑选最合适的nova-compute）\nnova-conductor -- 帮助nova-compute连接数据库\nnova-network --  早期版本管理虚拟机的网络（已弃用，改用neutron，留着为了方便兼容早期版本）\nnova-consoleauth和nova-novncproxy -- web版的vnc来直接操作云主机\nnovnproxy -- web版vnc客户端\nnova-api-metadata -- 接受来自虚拟机发送的元数据请求（配合neutron-metadata-agent实现虚拟机定制化）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-1-控制节点–安装步骤\"><a href=\"#2-5-1-控制节点–安装步骤\" class=\"headerlink\" title=\"2.5.1 控制节点–安装步骤\"></a>2.5.1 控制节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创库授权\nmysql &gt;&gt;\nCREATE DATABASE nova_api;\nCREATE DATABASE nova;\nGRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\n  \n# 在keystone创建用户nova\nopenstack user create --domain default   --password NOVA_PASS nova\n# 给Nova用户添加admin角色\nopenstack role add --project service --user nova admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name nova   --description &quot;OpenStack Compute&quot; compute\nopenstack endpoint create --region RegionOne   compute public http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute internal http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute admin http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\n\n# 安装相应软件包\nyum install -y openstack-nova-api openstack-nova-conductor \\\n  openstack-nova-console openstack-nova-novncproxy \\\n  openstack-nova-scheduler\n  \n# 修改配置文件\ncp &#x2F;etc&#x2F;nova&#x2F;nova.conf&#123;,.bak&#125;\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;nova&#x2F;nova.conf.bak &gt; &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT my_ip 10.0.0.11\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT use_neutron True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf api_database connection mysql+pymysql:&#x2F;&#x2F;nova:NOVA_DBPASS@controller&#x2F;nova_api\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf database connection mysql+pymysql:&#x2F;&#x2F;nova:NOVA_DBPASS@controller&#x2F;nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf glance api_servers http:&#x2F;&#x2F;controller:9292\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken username nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;nova&#x2F;tmp\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_listen &#39;$my_ip&#39;\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_proxyclient_address &#39;$my_ip&#39;\n\n# 校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n47ded61fdd1a79ab91bdb37ce59ef192  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;nova-manage api_db sync&quot; nova\nsu -s &#x2F;bin&#x2F;sh -c &quot;nova-manage db sync&quot; nova\n\n# 验证\nmysql nova_api -e &quot;show tables;&quot;\nmysql nova -e &quot;show tables;&quot;\n\n# 启动服务\nsystemctl enable openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\nsystemctl restart openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\n\n# 验证\n[root@controller ~]# nova service-list\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| Id | Binary           | Host       | Zone     | Status  | State | Updated_at | Disabled Reason |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| 1  | nova-conductor   | controller | internal | enabled | down  | -          | -               |\n| 4  | nova-scheduler   | controller | internal | enabled | down  | -          | -               |\n| 5  | nova-consoleauth | controller | internal | enabled | down  | -          | -               |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n\n# novncproxy 怎么检测起来没有？\n[root@controller ~]# netstat -lntup | grep 6080\ntcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      8719&#x2F;python2\n[root@controller ~]# ps -ef | grep 8719\nnova       8719      1  0 21:53 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;python2 &#x2F;usr&#x2F;bin&#x2F;nova-novncproxy --web &#x2F;usr&#x2F;share&#x2F;novnc&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-1-计算节点–安装步骤\"><a href=\"#2-5-1-计算节点–安装步骤\" class=\"headerlink\" title=\"2.5.1 计算节点–安装步骤\"></a>2.5.1 计算节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装软件包\nyum install -y openstack-nova-compute openstack-utils\n\n# 修改配置文件\ncp &#x2F;etc&#x2F;nova&#x2F;nova.conf&#123;,.bak&#125;\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;nova&#x2F;nova.conf.bak &gt; &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT my_ip 10.0.0.31 # 注意ip\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT use_neutron True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf glance api_servers http:&#x2F;&#x2F;controller:9292\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken username nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;nova&#x2F;tmp\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc enabled  True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_listen 0.0.0.0\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_proxyclient_address &#39;$my_ip&#39;\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc novncproxy_base_url http:&#x2F;&#x2F;controller:6080&#x2F;vnc_auto.html\n\n# 校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n45cab6030a9ab82761e9f697d6d79e14  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 启动服务\nsystemctl enable libvirtd.service openstack-nova-compute.service\nsystemctl restart libvirtd.service openstack-nova-compute.service\n\n# 服务启动错误排查\n参考博客：https:&#x2F;&#x2F;www.codeleading.com&#x2F;article&#x2F;89785382846&#x2F;\ncat &#x2F;etc&#x2F;nova&#x2F;nova.conf # compute1日志查看\n报错 nova AccessRefused: (0, 0): (403) ACCESS_REFUSED\n处理步骤：\n在controller\ncat &#x2F;var&#x2F;log&#x2F;rabbitmq&#x2F;rabbit@controller.log # 发现报错AMQPLAIN login refused: user &#39;openstack&#39; - invalid credentials 无效凭证\nrabbitmqctl list_users # 确认是否还有openstack用户\nrabbitmqctl add_user openstack RABBIT_PASS\nrabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;\nsystemctl restart rabbitmq-server.service # 重新创用户，并重启服务<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-安装neutron网络服务\"><a href=\"#2-6-安装neutron网络服务\" class=\"headerlink\" title=\"2.6 安装neutron网络服务\"></a>2.6 安装neutron网络服务</h3><p>neutron-server – 端口9696，api接受和响应外部的网络管理请求</p>\n<p>neutron-linuxbridge-agent –  负责创建桥接网卡</p>\n<p>neutron-dhcp-agent – 负责分配ip</p>\n<p>neutron-metadata-agent –  配合nova-metadata-api实现虚拟机的定制化操作</p>\n<p>L3-agent – 实现三层网络vxlan（网络层）</p>\n<h4 id=\"2-6-1-控制节点–安装步骤\"><a href=\"#2-6-1-控制节点–安装步骤\" class=\"headerlink\" title=\"2.6.1 控制节点–安装步骤\"></a>2.6.1 控制节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创库授权\nMysql &gt;&gt;\nCREATE DATABASE neutron;\nGRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;\n  \n# 在keystone创建用户neutron\nopenstack user create --domain default   --password NEUTRON_PASS neutron\n# 给neutron用户添加admin角色\nopenstack role add --project service --user neutron admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name neutron   --description &quot;OpenStack Networking&quot; network\nopenstack endpoint create --region RegionOne   network public http:&#x2F;&#x2F;controller:9696\nopenstack endpoint create --region RegionOne   network internal http:&#x2F;&#x2F;controller:9696\nopenstack endpoint create --region RegionOne   network admin http:&#x2F;&#x2F;controller:9696\n\n# 网络配置--公共网络\ncp &#x2F;etc&#x2F;neutron&#x2F;neutron.conf&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf.bak  &gt; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf database connection mysql+pymysql:&#x2F;&#x2F;neutron:NEUTRON_DBPASS@controller&#x2F;neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT core_plugin ml2\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT service_plugins\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT notify_nova_on_port_status_changes True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT notify_nova_on_port_data_changes True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken username neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova username nova\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;neutron&#x2F;tmp\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 type_drivers flat,vlan\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 tenant_network_types\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 mechanism_drivers linuxbridge\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 extension_drivers port_security\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2_type_flat flat_networks provider\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini securitygroup enable_ipset True\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT  dhcp_driver neutron.agent.linux.dhcp.Dnsmasq\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT  enable_isolated_metadata True\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini DEFAULT nova_metadata_ip controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET\n&gt;&gt;&gt;&gt;&gt;\n\n# 再次修改nova配置文件，添加neutron服务\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron url http:&#x2F;&#x2F;controller:9696\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron username neutron\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron service_metadata_proxy True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET\n# 校验文件\n[root@controller ~]# md5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n6334f359655efdbcf083b812ab94efc1  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 网络服务初始化脚本需要一个超链接\nln -s &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini &#x2F;etc&#x2F;neutron&#x2F;plugin.ini\n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;neutron-db-manage --config-file &#x2F;etc&#x2F;neutron&#x2F;neutron.conf \\\n  --config-file &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini upgrade head&quot; neutron\n  \n# 检查数据库\nmysql neutron -e &quot;show tables;&quot;\n\n# 重启Nova服务\nsystemctl restart openstack-nova-api.service\n\n# 启动Neutron服务\nsystemctl enable neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\nsystemctl start neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\n\n# 查看服务有没有起来\nneutron agent-list\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| 0d68dc27-f2b8-4cae-9c30-cddd126076b4 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |\n| 688cc47d-424d-4243-ae2b-b1c4b298a2a8 | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |\n| c4c5e360-ee02-4b9b-a1a5-59a0d0d088b0 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-6-2-计算节点–安装步骤\"><a href=\"#2-6-2-计算节点–安装步骤\" class=\"headerlink\" title=\"2.6.2 计算节点–安装步骤\"></a>2.6.2 计算节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装组件\nyum install -y openstack-neutron-linuxbridge ebtables ipset\n\n# 网络配置--公共网络\ncp &#x2F;etc&#x2F;neutron&#x2F;neutron.conf&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf.bak  &gt; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf\n&gt;&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken username neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;neutron&#x2F;tmp\n&gt;&gt;&gt;&gt;&gt;&gt;\n# md5校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n328cd5f0745e26a420e828b0dfc2934e  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini\n&gt;&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n&gt;&gt;&gt;&gt;&gt;&gt;\n\n# 再次修改nova配置文件，添加neutron配置\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron url http:&#x2F;&#x2F;controller:9696\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron username neutron\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron password NEUTRON_PASS\n\n# 重启nova服务\nsystemctl restart openstack-nova-compute.service\n\n# 启动linuxbridge代理服务\nsystemctl enable neutron-linuxbridge-agent.service\nsystemctl restart neutron-linuxbridge-agent.service\n\n# 查看是否配置成功\ncontroller执行 &gt;&gt; neutron agent-list\n配置正确会多出来一个\nLinux bridge agent | compute1   |                   | :-)   | True \n\n# 查看计算资源\nopenstack compute service list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-7-安装horizon-（Dashboard）web界面\"><a href=\"#2-7-安装horizon-（Dashboard）web界面\" class=\"headerlink\" title=\"2.7 安装horizon （Dashboard）web界面\"></a>2.7 安装horizon （Dashboard）web界面</h3><h4 id=\"2-7-1-安装步骤（控制节点\"><a href=\"#2-7-1-安装步骤（控制节点\" class=\"headerlink\" title=\"2.7.1 安装步骤（控制节点)\"></a>2.7.1 安装步骤（控制节点)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装组件包\nyum install -y openstack-dashboard\n\n# 修改配置文件\nvim &#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings\n&gt;&gt;&gt;&gt;\nOPENSTACK_HOST &#x3D; &quot;controller&quot;\nALLOWED_HOSTS &#x3D; [&#39;*&#39;, ]\nSESSION_ENGINE &#x3D; &#39;django.contrib.sessions.backends.cache&#39;\nCACHES &#x3D; &#123;\n    &#39;default&#39;: &#123;\n         &#39;BACKEND&#39;: &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,\n         &#39;LOCATION&#39;: &#39;controller:11211&#39;,\n    &#125;\n&#125;\nOPENSTACK_KEYSTONE_URL &#x3D; &quot;http:&#x2F;&#x2F;%s:5000&#x2F;v3&quot; % OPENSTACK_HOST\nOPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT &#x3D; True\nOPENSTACK_API_VERSIONS &#x3D; &#123;\n    &quot;identity&quot;: 3,\n    &quot;image&quot;: 2,\n    &quot;volume&quot;: 2,\n&#125;\nOPENSTACK_KEYSTONE_DEFAULT_DOMAIN &#x3D; &quot;default&quot;\nOPENSTACK_KEYSTONE_DEFAULT_ROLE &#x3D; &quot;user&quot;\nOPENSTACK_NEUTRON_NETWORK &#x3D; &#123;\n    ...\n    &#39;enable_router&#39;: False,\n    &#39;enable_quotas&#39;: False,\n    &#39;enable_distributed_router&#39;: False,\n    &#39;enable_ha_router&#39;: False,\n    &#39;enable_lb&#39;: False,\n    &#39;enable_firewall&#39;: False,\n    &#39;enable_vpn&#39;: False,\n    &#39;enable_fip_topology_check&#39;: False,\n&#125;\nTIME_ZONE &#x3D; &quot;Asia&#x2F;Shanghai&quot;\n&gt;&gt;&gt;&gt;\n\n# 解决不能进入页面的BUG\nvim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-dashboard.conf\n添加一行 &gt;&gt; WSGIAppicationGroup %&#123;GLOBAL&#125;\n\n# 重启服务\nsystemctl restart httpd.service memcached.service\n\n# 登录界面\nhttps:&#x2F;&#x2F;10.0.0.11&#x2F;dashboard\n域:default\n用户名:admin\n密码:ADMIN_PASS\n\n# 扩展：查看文件输入那个rpm包\nrpm -qf &#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-7-2-Dashboard报错解决\"><a href=\"#2-7-2-Dashboard报错解决\" class=\"headerlink\" title=\"2.7.2 Dashboard报错解决\"></a>2.7.2 Dashboard报错解决</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 问题1--Invalid service catalog service: image\n发生原因：\n\topenstack service list 存在两个 glance\n解决方法：\n    openstack service delete c12c125edc2041e3aaf2f250442162c6\n    openstack service delete 6a11431b95bc44d1bd1e9371c0faa16b # 两个glance都删掉\n    重复2.4.1在keystone上创建glance服务和注册api\n    再重启服务systemctl restart httpd.service memcached.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-启动一个云主机\"><a href=\"#2-8-启动一个云主机\" class=\"headerlink\" title=\"2.8 启动一个云主机\"></a>2.8 启动一个云主机</h3><h3 id=\"2-8-1-创建步骤\"><a href=\"#2-8-1-创建步骤\" class=\"headerlink\" title=\"2.8.1 创建步骤\"></a>2.8.1 创建步骤</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建网络\nneutron net-create --shared --provider:physical_network provider \\\n  --provider:network_type flat gs\n  \n# 在网络中创建一个子网\nneutron subnet-create --name gs2 \\\n  --allocation-pool start&#x3D;10.0.0.101,end&#x3D;10.0.0.250 \\\n  --dns-nameserver 223.5.5.5 --gateway 10.0.0.2 \\\n  gs 10.0.0.0&#x2F;24\n  \n# 创建云主机硬件配置方案（规格）\nopenstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano\n\n# 创建密钥键值对\nssh-keygen -q -N &quot;&quot; -f ~&#x2F;.ssh&#x2F;id_rsa\nopenstack keypair create --public-key ~&#x2F;.ssh&#x2F;id_rsa.pub mykey\n# 验证公钥的添加\nopenstack keypair list\n\n# 添加安全组规则\nopenstack security group rule create --proto icmp default\nopenstack security group rule create --proto tcp --dst-port 22 default\n\n# 在公有网络启动一个实例\nopenstack flavor list # 查看可用的配置规格\nopenstack image list # 查看可用镜像\nopenstack network list # 查看可用网络\nopenstack security group list # 查看已设置的安全组\n\nopenstack server create --flavor 规格名&#x2F;ID --image 镜像名&#x2F;ID \\\n  --nic net-id&#x3D;网络ID --security-group default \\\n  --key-name mykey 实例名称\n示例：\nopenstack server create --flavor m1.tiny --image cirros \\\n--nic net-id&#x3D;cb032582-893b-414d-b78d-c89c6548612d --security-group default \\\n--key-name mykey my-instance<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-2-创建云主机问题解决\"><a href=\"#2-8-2-创建云主机问题解决\" class=\"headerlink\" title=\"2.8.2 创建云主机问题解决\"></a>2.8.2 创建云主机问题解决</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1、启动云主机时，No valid host was found\n【计算节点中】\n查看云主机创建日志：&#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-compute.log，里面有记录问题原因是CPU feature spec-ctrl not found\n修改&#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;cpu_map.xml，将和spec-ctrl相关的特性删除\n然后重启服务\nsystemctl restart libvirtd openstack-nova-compute\n参考博客：https:&#x2F;&#x2F;www.cnblogs.com&#x2F;laolieren&#x2F;p&#x2F;solve_openstack_create_instance_error.html\n\n# 2、云主机控制台seabios -- Booting from Hard Disk错误\n【计算节点中】\nvim &#x2F;etc&#x2F;nova&#x2F;nova.conf\n&gt;&gt;&gt;&gt;\n[libvirt]\nvirt_type &#x3D; qemu\ncpu_mode &#x3D; none\n&gt;&gt;&gt;&gt;\nsystemctl restart libvirtd openstack-nova-compute\n重启云主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"OpenStack笔记\"><a href=\"#OpenStack笔记\" class=\"headerlink\" title=\"OpenStack笔记\"></a><strong><font color=green>OpenStack笔记</font></strong></h1><p>​\tOpenStack实现的是云计算IAAS</p>\n<h2 id=\"一、服务架构发展\"><a href=\"#一、服务架构发展\" class=\"headerlink\" title=\"一、服务架构发展\"></a><font color=blue>一、服务架构发展</font></h2><h3 id=\"1-1-MVC架构\"><a href=\"#1-1-MVC架构\" class=\"headerlink\" title=\"1.1 MVC架构\"></a>1.1 MVC架构</h3><p>​\t业务不拆分，一个服务挂，则所有的全挂</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">首页 www.jd.com&#x2F;index.html\n秒杀 www.jd.com&#x2F;miaosha&#x2F;index.html\n优惠券 www.jd.com&#x2F;juan&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-SOA架构（千万级）\"><a href=\"#1-2-SOA架构（千万级）\" class=\"headerlink\" title=\"1.2 SOA架构（千万级）\"></a>1.2 SOA架构（千万级）</h3><p>​\t业务拆分，每一个功能都拆分成一个独立的web服务，每个独立的web服务，都至少拥有一个集群</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">首页 www.jd.com&#x2F;index.html\n秒杀 miaosha.jd.com&#x2F;index.html\n优惠券 juan.jd.com&#x2F;index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-微服务架构（亿级）\"><a href=\"#1-3-微服务架构（亿级）\" class=\"headerlink\" title=\"1.3 微服务架构（亿级）\"></a>1.3 微服务架构（亿级）</h3><p>阿里开源dubbo</p>\n<p>Spring Boot</p>\n<p>自动化代码上线：Jekins + gilab ci</p>\n<p>自动化代码质量检查：sonarqube</p>\n<h2 id=\"二、搭建OpenStack\"><a href=\"#二、搭建OpenStack\" class=\"headerlink\" title=\"二、搭建OpenStack\"></a><font color=blue>二、搭建OpenStack</font></h2><p>​\t本流程为手动安装M版，脚本安装可以参考</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;my.oschina.net&#x2F;u&#x2F;4367225&#x2F;blog&#x2F;4255750<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>OpenStack的结构介绍：</p>\n<blockquote>\n<p>Nova – 提供VM虚拟化支持 8774</p>\n<p>Glance – 提供镜像 9292</p>\n<p>Clinder – 存储支持 8776</p>\n<p>Neutron – 网络支持 9696</p>\n<p>Cellometer –  监控计费 </p>\n<p>KeyStone – 登录认证</p>\n<p>Horizon – 网页UI，dashboard</p>\n<p>Heat – 部署编排，批量建虚拟机</p>\n<p>Switft – 对象存储（不是传统的文件夹存放，而是用数据库记录已上传的文件信息，当有文件上传，先查询数据库中是否有该文件的md5值，如果有，则不用重新上传，给个链接就是 — 百度云盘）</p>\n</blockquote>\n<p><img src=\"C:\\Users\\fr724\\AppData\\Roaming\\Typora\\typora-user-images\\image-20210615135957367.png\" alt=\"image-20210615135957367\"></p>\n<h3 id=\"2-1-虚拟机准备\"><a href=\"#2-1-虚拟机准备\" class=\"headerlink\" title=\"2.1 虚拟机准备\"></a>2.1 虚拟机准备</h3><p>虚拟机规划</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 系统：CentOS7.4\ncontroller: 内存3G, CPU开启虚拟化\t10.0.0.11\ncompute1: 内存1G，CPU开启虚拟化\t    10.0.0.31\n# 修改主机名，IP地址，host解析，测试ping百度<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置本地M版yum源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1、资源准备\nmount &#x2F;dev&#x2F;cdrom &#x2F;mnt # 追加到&#x2F;etc&#x2F;rc.local,自动挂载\n解压openstack_rpm.tar.gz到&#x2F;opt&#x2F;repo\n\n# 2、编辑repo文件\nvim &#x2F;etc&#x2F;yum.repo.d&#x2F;local&#x2F;repo\n\n#### 内容\n[local]\nname&#x3D;local\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;mnt\ngpgcheck&#x3D;0\n\n[openstack]\nname&#x3D;openstack\nbaseurl&#x3D;file:&#x2F;&#x2F;&#x2F;opt&#x2F;repo\ngpgcheck&#x3D;0\n####\n\n# 3、更新yum源\nyum makecache\nyum repolist<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h3 id=\"2-2-基础服务安装\"><a href=\"#2-2-基础服务安装\" class=\"headerlink\" title=\"2.2 基础服务安装\"></a>2.2 基础服务安装</h3><h4 id=\"2-2-1-NTP时间同步\"><a href=\"#2-2-1-NTP时间同步\" class=\"headerlink\" title=\"2.2.1 NTP时间同步\"></a>2.2.1 NTP时间同步</h4><p>controller与阿里NTP服务器同步</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;chrony.conf\nserver ntp6.aliyun.com # 3行\nallow 10.0.0.0&#x2F;24 # 24行\nsystemctl restart chronyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>computer与controller同步</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;chrony.conf\nserver 10.0.0.11 iburst # 3行\nsystemctl restart chronyd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-2-扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\"><a href=\"#2-2-2-扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\" class=\"headerlink\" title=\"2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）\"></a>2.2.2 扩展-公网安装O版OpenStack的方法介绍（跳过该步骤）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo\nyum makecache\nyum list | grep openstack\nyum install centos-release-openstack-ocata.noarch -y # 安装O版<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-3-安装OpenStack客户端openstack-selinux-（所有节点执行）\"><a href=\"#2-2-3-安装OpenStack客户端openstack-selinux-（所有节点执行）\" class=\"headerlink\" title=\"2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）\"></a>2.2.3 安装OpenStack客户端openstack-selinux （所有节点执行）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install python-openstackclient openstack-selinux -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"2-2-4-安装和配置mariadb-仅控制节点执行\"><a href=\"#2-2-4-安装和配置mariadb-仅控制节点执行\" class=\"headerlink\" title=\"2.2.4 安装和配置mariadb (仅控制节点执行)\"></a>2.2.4 安装和配置mariadb (仅控制节点执行)</h4><p>安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install mariadb mariadb-server python2-PyMySQL -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>配置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;my.cnf.d&#x2F;openstack.cnf\n\n#----------------\n[mysqld]\t\nbind-address &#x3D; 10.0.0.11\t# 监听地址\ndefault-storage-engine &#x3D; innodb # 默认存储引擎\ninnodb_file_per_table  # 独立表空间文件\nmax_connections &#x3D; 4096\t# 最大连接数\ncollation-server &#x3D; utf8_general_ci\t# 默认字符集utf8\ncharacter-set-server &#x3D; utf8\n#-----------------\n\n# 启动服务\nsystemctl start mariadb\nsystemctl enable mariadb\n\n# 数据库安全初始化,保障数据库安全性，如果不执行，同步数据库表会报错\nmysql_secure_installation\n回车 n y y y y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-5-消息队列配置-仅控制节点执行\"><a href=\"#2-2-5-消息队列配置-仅控制节点执行\" class=\"headerlink\" title=\"2.2.5 消息队列配置(仅控制节点执行)\"></a>2.2.5 消息队列配置(仅控制节点执行)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装rabbitmq\nyum install rabbitmq-server -y\n# 启动服务\nsystemctl start rabbitmq-server\nsystemctl enable rabbitmq-server\n# 添加用户\nrabbitmqctl add_user openstack RABBIT_PASS\n# 设置用户权限（读、写、执行）\nrabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;\nrabbitmq-plugins enable rabbitmq_management\n# 查看是否开启15672端口\nnetstat -lntup\n# 浏览器登录rabbitmq\nhttp:&#x2F;&#x2F;10.0.0.11:15672\n默认用户名和密码：guest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-2-6-缓存系统配置memcache（仅控制节点执行）\"><a href=\"#2-2-6-缓存系统配置memcache（仅控制节点执行）\" class=\"headerlink\" title=\"2.2.6 缓存系统配置memcache（仅控制节点执行）\"></a>2.2.6 缓存系统配置memcache（仅控制节点执行）</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装\nyum install memcached python-memched -y\n# 配置\nsed -i &#39;s#127.0.0.1#10.0.0.11#g&#39; &#x2F;etc&#x2F;sysconfig&#x2F;memcached\n# 启动服务\nsystemctl restart memcached\nsystemctl enable memcached\n# 查询端口11211是否已监听，默认使用该端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-安装keystone认证服务-仅控制节点执行\"><a href=\"#2-3-安装keystone认证服务-仅控制节点执行\" class=\"headerlink\" title=\"2.3 安装keystone认证服务(仅控制节点执行)\"></a>2.3 安装keystone认证服务(仅控制节点执行)</h3><h4 id=\"2-3-1-Keystone功能介绍\"><a href=\"#2-3-1-Keystone功能介绍\" class=\"headerlink\" title=\"2.3.1 Keystone功能介绍\"></a>2.3.1 Keystone功能介绍</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、认证管理：\n\t账户密码\n2、授权管理\n3、服务目录：\n\t跟电话本一样，keystone上可以查询到glance、nova等服务的地址端口等信息，每一个新加的服务都需要在keystone上注册<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-2-OpenStack服务器安装的通用步骤\"><a href=\"#2-3-2-OpenStack服务器安装的通用步骤\" class=\"headerlink\" title=\"2.3.2 OpenStack服务器安装的通用步骤\"></a>2.3.2 OpenStack服务器安装的通用步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">1、创库授权\n2、在Keystone创建用户，关联角色\n3、在keystone创建服务，注册api\n4、安装服务相关的软件包\n5、修改配置\n\t数据库的连接\n\tkeystone认证授权信息\n\trabbitmq连接信息\n\t其他配置\n6、同步数据库，创建表\n7、启动服务<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-3-安装步骤\"><a href=\"#2-3-3-安装步骤\" class=\"headerlink\" title=\"2.3.3 安装步骤\"></a>2.3.3 安装步骤</h4><p>1、创库授权</p>\n<pre class=\"line-numbers language-mysql\" data-language=\"mysql\"><code class=\"language-mysql\"># 登录mysql\n$ mysql -u root -p\n# 创建keystone数据库\nCREATE DATABASE keystone;\n# 对&#96;&#96;keystone&#96;&#96;数据库授予恰当的权限\nGRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON keystone.* TO &#39;keystone&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;KEYSTONE_DBPASS&#39;;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、安装keystone相关软件包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install openstack-keystone httpd mod_wsgi -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>3、修改配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 备份原配置文件\n\\cp &#x2F;etc&#x2F;keystone&#x2F;keystone.conf&#123;,.bak&#125;\n# 去除配置文件中的空格行和注释行\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;keystone&#x2F;keystone.conf.bak &gt; &#x2F;etc&#x2F;keystone&#x2F;keystone.conf\n\n# 安装自动配置工具\nyum install openstack-utils -y\n# 使用工具设置（也可以直接修改文件）修改项 参数 &#x3D; 值\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf DEFAULT admin_token ADMIN_TOKEN\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf database connection  mysql+pymysql:&#x2F;&#x2F;keystone:KEYSTONE_DBPASS@controller&#x2F;keystone # 注意hostname--controller\nopenstack-config --set &#x2F;etc&#x2F;keystone&#x2F;keystone.conf token provider fernet\n# 校验\nmd5sum &#x2F;etc&#x2F;keystone&#x2F;keystone.conf\nd5acb3db852fe3f247f4f872b051b7a9 \n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;keystone-manage db_sync&quot; keystone\n# 查询是否生成表\nmysql keystone -e &quot;show tables;&quot;\n\n# 初始化fernet\nkeystone-manage fernet_setup --keystone-user keystone --keystone-group keystone\n# 验证\n&#x2F;etc&#x2F;keystone&#x2F;fernet-keys已创建\n\n# 配置httpd\necho &quot;ServerName controller&quot; &gt;&gt; &#x2F;etc&#x2F;httpd&#x2F;conf&#x2F;httpd.conf\n\n# 创建wsgi配置文件\nvim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;wsgi-keystone.conf\n###内容\nListen 5000\nListen 35357\n\n&lt;VirtualHost *:5000&gt;\n    WSGIDaemonProcess keystone-public processes&#x3D;5 threads&#x3D;1 user&#x3D;keystone group&#x3D;keystone display-name&#x3D;%&#123;GROUP&#125;\n    WSGIProcessGroup keystone-public\n    WSGIScriptAlias &#x2F; &#x2F;usr&#x2F;bin&#x2F;keystone-wsgi-public\n    WSGIApplicationGroup %&#123;GLOBAL&#125;\n    WSGIPassAuthorization On\n    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;\n    ErrorLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-error.log\n    CustomLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-access.log combined\n\n    &lt;Directory &#x2F;usr&#x2F;bin&gt;\n        Require all granted\n    &lt;&#x2F;Directory&gt;\n&lt;&#x2F;VirtualHost&gt;\n\n&lt;VirtualHost *:35357&gt;\n    WSGIDaemonProcess keystone-admin processes&#x3D;5 threads&#x3D;1 user&#x3D;keystone group&#x3D;keystone display-name&#x3D;%&#123;GROUP&#125;\n    WSGIProcessGroup keystone-admin\n    WSGIScriptAlias &#x2F; &#x2F;usr&#x2F;bin&#x2F;keystone-wsgi-admin\n    WSGIApplicationGroup %&#123;GLOBAL&#125;\n    WSGIPassAuthorization On\n    ErrorLogFormat &quot;%&#123;cu&#125;t %M&quot;\n    ErrorLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-error.log\n    CustomLog &#x2F;var&#x2F;log&#x2F;httpd&#x2F;keystone-access.log combined\n\n    &lt;Directory &#x2F;usr&#x2F;bin&gt;\n        Require all granted\n    &lt;&#x2F;Directory&gt;\n&lt;&#x2F;VirtualHost&gt;\n# 校验\nmd5sum &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;wsgi-keystone.conf\n8f051eb53577f67356ed03e4550315c2 \n\n# 启动httpd\nsystemctl enable httpd\nsystemctl start httpd\n\n# 创建服务和注册api\nexport OS_TOKEN&#x3D;ADMIN_TOKEN\nexport OS_URL&#x3D;http:&#x2F;&#x2F;controller:35357&#x2F;v3\nexport OS_IDENTITY_API_VERSION&#x3D;3\nopenstack service create --name keystone --description &quot;OpenStack Identity&quot; identity\nopenstack endpoint create --region RegionOne identity public http:&#x2F;&#x2F;controller:5000&#x2F;v3\nopenstack endpoint create --region RegionOne identity internal http:&#x2F;&#x2F;controller:5000&#x2F;v3\nopenstack endpoint create --region RegionOne identity admin http:&#x2F;&#x2F;controller:35357&#x2F;v3\n\n# 创建域、项目（租户）、用户和角色\nopenstack domain create --description &quot;Default Domain&quot; default\nopenstack project create --domain default --description &quot;Admin Project&quot; admin\nopenstack user create --domain default --password ADMIN_PASS admin\nopenstack role create admin\n\n# 关联项目，用户，角色\nopenstack role add --project admin --user admin admin\n# 在admin项目上，给admin用户赋予admin角色\nopenstack project create --domain default --description &quot;Service Project&quot; service\n\n# 创建环境变量脚本\nexport OS_PROJECT_DOMAIN_NAME&#x3D;default\nexport OS_USER_DOMAIN_NAME&#x3D;default\nexport OS_PROJECT_NAME&#x3D;admin\nexport OS_USERNAME&#x3D;admin\nexport OS_PASSWORD&#x3D;ADMIN_PASS\nexport OS_IMAGE_API_VERSION&#x3D;2\nexport OS_IDENTITY_API_VERSION&#x3D;3\nexport OS_AUTH_URL&#x3D;http:&#x2F;&#x2F;controller:35357&#x2F;v3\n\n# 作为admin用户请求认证令牌\nopenstack token issue  \n\n# 如果不设置环境变量可以通过传入参数的方式申请\nopenstack --os-auth-url http:&#x2F;&#x2F;controller:35357&#x2F;v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name admin --os-username admin --os-password ADMIN_PASS token issue\n\n# 查看用户列表\nopenstack user list\n\n# 查看endpoint列表\nopenstack endpoint list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-安装glance镜像服务\"><a href=\"#2-4-安装glance镜像服务\" class=\"headerlink\" title=\"2.4 安装glance镜像服务\"></a>2.4 安装glance镜像服务</h3><p>​\t镜像服务 (glance) 允许用户发现、注册和获取虚拟机镜像。</p>\n<h4 id=\"2-4-1-安装步骤\"><a href=\"#2-4-1-安装步骤\" class=\"headerlink\" title=\"2.4.1 安装步骤\"></a>2.4.1 安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 数据库创库授权\nmysql &gt;&gt;\nCREATE DATABASE glance\nGRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;GLANCE_DBPASS&#39;;\n  \n # 在keystone创建glance用户关联角色\n openstack user create --domain default --password GLANCE_PASS glance\n openstack role add --project service --user glance admin\n \n # 在keystone上创建服务和注册api\nopenstack service create --name glance   --description &quot;OpenStack Image&quot; image\nopenstack endpoint create --region RegionOne \\\n  image public http:&#x2F;&#x2F;controller:9292\nopenstack endpoint create --region RegionOne \\\n  image internal http:&#x2F;&#x2F;controller:9292\nopenstack endpoint create --region RegionOne \\\n  image admin http:&#x2F;&#x2F;controller:9292\n  \n# 查看已创建的信息\nopenstack role assignment list\nopenstack role list\nopenstack project list\nopenstack user list （要有glance用户）\n\n# mysql中验证表是否已创建\n[root@controller ~]# mysql keystone -e &quot;show tables;&quot; | grep user\nfederated_user\nlocal_user\nuser\nuser_group_membership\n[root@controller ~]# mysql keystone -e &quot;show tables;&quot; | grep project\nproject\nproject_endpoint\nproject_endpoint_group\n\n# 安装服务相应软件包\nyum install openstack-glance -y\n\n# 修改相应的配置文件--api\ncp &#x2F;etc&#x2F;glance&#x2F;glance-api.conf&#123;,.bak&#125;\ngrep &#39;^[a-Z\\[]&#39; &#x2F;etc&#x2F;glance&#x2F;glance-api.conf.bak &gt; &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf database connection mysql+pymysql:&#x2F;&#x2F;glance:GLANCE_DBPASS@controller&#x2F;glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken username glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf paste_deploy flavor keystone\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store stores file,http\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store default_store file\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-api.conf glance_store filesystem_store_datadir &#x2F;var&#x2F;lib&#x2F;glance&#x2F;images&#x2F;\n\n# 修改相应的配置文件--registry\ncp &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf&#123;,.bak&#125;\ngrep &#39;^[a-Z\\[]&#39; &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf.bak &gt; &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf database connection mysql+pymysql:&#x2F;&#x2F;glance:GLANCE_DBPASS@controller&#x2F;glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken username glance\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf keystone_authtoken password GLANCE_PASS\nopenstack-config --set &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf paste_deploy flavor keystone\n\n# md5值验证\nmd5sum &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\n3e1a4234c133eda11b413788e001cba3  &#x2F;etc&#x2F;glance&#x2F;glance-api.conf\nmd5sum &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\n46acabd81a65b924256f56fe34d90b8f  &#x2F;etc&#x2F;glance&#x2F;glance-registry.conf\n\n# 写入镜像服务数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;glance-manage db_sync&quot; glance # 会有Warning不用在意\n# 验证\nmysql glance -e &quot;show tables;&quot;\n\n# 启动服务\nsystemctl enable openstack-glance-api.service   openstack-glance-registry.service\nsystemctl start openstack-glance-api.service   openstack-glance-registry.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-4-2-上传镜像测试\"><a href=\"#2-4-2-上传镜像测试\" class=\"headerlink\" title=\"2.4.2 上传镜像测试\"></a>2.4.2 上传镜像测试</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 错误日志查看\n&#x2F;var&#x2F;log&#x2F;glance\n\n# 确保已获取token令牌\nopenstack token issue\n\n# 下载测试镜像\nwget http:&#x2F;&#x2F;download.cirros-cloud.net&#x2F;0.3.4&#x2F;cirros-0.3.4-x86_64-disk.img\n\n# 上传测试镜像\nopenstack image create &quot;cirros&quot; \\\n--file cirros-0.3.4-x86_64-disk.img \\\n--disk-format qcow2 --container-format bare \\\n--public\n\n# 上传文件确认\nls &#x2F;var&#x2F;lib&#x2F;glance&#x2F;images&#x2F; (在&#x2F;etc&#x2F;glance&#x2F;glance-api.conf中设置)\nmysql glance -e &quot;show tables;&quot; | grep image<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-安装nova计算服务\"><a href=\"#2-5-安装nova计算服务\" class=\"headerlink\" title=\"2.5 安装nova计算服务\"></a>2.5 安装nova计算服务</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nova-api -- 接受并相应所有的计算服务请求，管理云主机生命周期\nnova-compute（多个）-- 真正管理虚拟机(nova-compute调用libvirt)\nnova-scheduler -- nova 调度器（挑选最合适的nova-compute）\nnova-conductor -- 帮助nova-compute连接数据库\nnova-network --  早期版本管理虚拟机的网络（已弃用，改用neutron，留着为了方便兼容早期版本）\nnova-consoleauth和nova-novncproxy -- web版的vnc来直接操作云主机\nnovnproxy -- web版vnc客户端\nnova-api-metadata -- 接受来自虚拟机发送的元数据请求（配合neutron-metadata-agent实现虚拟机定制化）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-1-控制节点–安装步骤\"><a href=\"#2-5-1-控制节点–安装步骤\" class=\"headerlink\" title=\"2.5.1 控制节点–安装步骤\"></a>2.5.1 控制节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创库授权\nmysql &gt;&gt;\nCREATE DATABASE nova_api;\nCREATE DATABASE nova;\nGRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova_api.* TO &#39;nova&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON nova.* TO &#39;nova&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NOVA_DBPASS&#39;;\n  \n# 在keystone创建用户nova\nopenstack user create --domain default   --password NOVA_PASS nova\n# 给Nova用户添加admin角色\nopenstack role add --project service --user nova admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name nova   --description &quot;OpenStack Compute&quot; compute\nopenstack endpoint create --region RegionOne   compute public http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute internal http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\nopenstack endpoint create --region RegionOne   compute admin http:&#x2F;&#x2F;controller:8774&#x2F;v2.1&#x2F;%\\(tenant_id\\)s\n\n# 安装相应软件包\nyum install -y openstack-nova-api openstack-nova-conductor \\\n  openstack-nova-console openstack-nova-novncproxy \\\n  openstack-nova-scheduler\n  \n# 修改配置文件\ncp &#x2F;etc&#x2F;nova&#x2F;nova.conf&#123;,.bak&#125;\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;nova&#x2F;nova.conf.bak &gt; &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT my_ip 10.0.0.11\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT use_neutron True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf api_database connection mysql+pymysql:&#x2F;&#x2F;nova:NOVA_DBPASS@controller&#x2F;nova_api\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf database connection mysql+pymysql:&#x2F;&#x2F;nova:NOVA_DBPASS@controller&#x2F;nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf glance api_servers http:&#x2F;&#x2F;controller:9292\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken username nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;nova&#x2F;tmp\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_listen &#39;$my_ip&#39;\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_proxyclient_address &#39;$my_ip&#39;\n\n# 校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n47ded61fdd1a79ab91bdb37ce59ef192  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;nova-manage api_db sync&quot; nova\nsu -s &#x2F;bin&#x2F;sh -c &quot;nova-manage db sync&quot; nova\n\n# 验证\nmysql nova_api -e &quot;show tables;&quot;\nmysql nova -e &quot;show tables;&quot;\n\n# 启动服务\nsystemctl enable openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\nsystemctl restart openstack-nova-api.service \\\nopenstack-nova-consoleauth.service openstack-nova-scheduler.service \\\nopenstack-nova-conductor.service openstack-nova-novncproxy.service\n\n# 验证\n[root@controller ~]# nova service-list\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| Id | Binary           | Host       | Zone     | Status  | State | Updated_at | Disabled Reason |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n| 1  | nova-conductor   | controller | internal | enabled | down  | -          | -               |\n| 4  | nova-scheduler   | controller | internal | enabled | down  | -          | -               |\n| 5  | nova-consoleauth | controller | internal | enabled | down  | -          | -               |\n+----+------------------+------------+----------+---------+-------+------------+-----------------+\n\n# novncproxy 怎么检测起来没有？\n[root@controller ~]# netstat -lntup | grep 6080\ntcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      8719&#x2F;python2\n[root@controller ~]# ps -ef | grep 8719\nnova       8719      1  0 21:53 ?        00:00:01 &#x2F;usr&#x2F;bin&#x2F;python2 &#x2F;usr&#x2F;bin&#x2F;nova-novncproxy --web &#x2F;usr&#x2F;share&#x2F;novnc&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-5-1-计算节点–安装步骤\"><a href=\"#2-5-1-计算节点–安装步骤\" class=\"headerlink\" title=\"2.5.1 计算节点–安装步骤\"></a>2.5.1 计算节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装软件包\nyum install -y openstack-nova-compute openstack-utils\n\n# 修改配置文件\ncp &#x2F;etc&#x2F;nova&#x2F;nova.conf&#123;,.bak&#125;\ngrep -Ev &#39;^$|#&#39; &#x2F;etc&#x2F;nova&#x2F;nova.conf.bak &gt; &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT enabled_apis osapi_compute,metadata\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT my_ip 10.0.0.31 # 注意ip\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT use_neutron True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf DEFAULT firewall_driver nova.virt.firewall.NoopFirewallDriver\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf glance api_servers http:&#x2F;&#x2F;controller:9292\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken username nova\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf keystone_authtoken password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;nova&#x2F;tmp\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc enabled  True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_listen 0.0.0.0\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc vncserver_proxyclient_address &#39;$my_ip&#39;\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf vnc novncproxy_base_url http:&#x2F;&#x2F;controller:6080&#x2F;vnc_auto.html\n\n# 校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n45cab6030a9ab82761e9f697d6d79e14  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 启动服务\nsystemctl enable libvirtd.service openstack-nova-compute.service\nsystemctl restart libvirtd.service openstack-nova-compute.service\n\n# 服务启动错误排查\n参考博客：https:&#x2F;&#x2F;www.codeleading.com&#x2F;article&#x2F;89785382846&#x2F;\ncat &#x2F;etc&#x2F;nova&#x2F;nova.conf # compute1日志查看\n报错 nova AccessRefused: (0, 0): (403) ACCESS_REFUSED\n处理步骤：\n在controller\ncat &#x2F;var&#x2F;log&#x2F;rabbitmq&#x2F;rabbit@controller.log # 发现报错AMQPLAIN login refused: user &#39;openstack&#39; - invalid credentials 无效凭证\nrabbitmqctl list_users # 确认是否还有openstack用户\nrabbitmqctl add_user openstack RABBIT_PASS\nrabbitmqctl set_permissions openstack &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;\nsystemctl restart rabbitmq-server.service # 重新创用户，并重启服务<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-安装neutron网络服务\"><a href=\"#2-6-安装neutron网络服务\" class=\"headerlink\" title=\"2.6 安装neutron网络服务\"></a>2.6 安装neutron网络服务</h3><p>neutron-server – 端口9696，api接受和响应外部的网络管理请求</p>\n<p>neutron-linuxbridge-agent –  负责创建桥接网卡</p>\n<p>neutron-dhcp-agent – 负责分配ip</p>\n<p>neutron-metadata-agent –  配合nova-metadata-api实现虚拟机的定制化操作</p>\n<p>L3-agent – 实现三层网络vxlan（网络层）</p>\n<h4 id=\"2-6-1-控制节点–安装步骤\"><a href=\"#2-6-1-控制节点–安装步骤\" class=\"headerlink\" title=\"2.6.1 控制节点–安装步骤\"></a>2.6.1 控制节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创库授权\nMysql &gt;&gt;\nCREATE DATABASE neutron;\nGRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;localhost&#39; \\\n  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;\nGRANT ALL PRIVILEGES ON neutron.* TO &#39;neutron&#39;@&#39;%&#39; \\\n  IDENTIFIED BY &#39;NEUTRON_DBPASS&#39;;\n  \n# 在keystone创建用户neutron\nopenstack user create --domain default   --password NEUTRON_PASS neutron\n# 给neutron用户添加admin角色\nopenstack role add --project service --user neutron admin\n\n# 在keystone上创建服务和注册api\nopenstack service create --name neutron   --description &quot;OpenStack Networking&quot; network\nopenstack endpoint create --region RegionOne   network public http:&#x2F;&#x2F;controller:9696\nopenstack endpoint create --region RegionOne   network internal http:&#x2F;&#x2F;controller:9696\nopenstack endpoint create --region RegionOne   network admin http:&#x2F;&#x2F;controller:9696\n\n# 网络配置--公共网络\ncp &#x2F;etc&#x2F;neutron&#x2F;neutron.conf&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf.bak  &gt; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf database connection mysql+pymysql:&#x2F;&#x2F;neutron:NEUTRON_DBPASS@controller&#x2F;neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT core_plugin ml2\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT service_plugins\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT notify_nova_on_port_status_changes True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT notify_nova_on_port_data_changes True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken username neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova username nova\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf nova password NOVA_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;neutron&#x2F;tmp\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 type_drivers flat,vlan\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 tenant_network_types\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 mechanism_drivers linuxbridge\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2 extension_drivers port_security\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini ml2_type_flat flat_networks provider\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini securitygroup enable_ipset True\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT interface_driver neutron.agent.linux.interface.BridgeInterfaceDriver\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT  dhcp_driver neutron.agent.linux.dhcp.Dnsmasq\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;dhcp_agent.ini DEFAULT  enable_isolated_metadata True\n&gt;&gt;&gt;&gt;&gt;\n\ncp &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini\n&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini DEFAULT nova_metadata_ip controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;metadata_agent.ini DEFAULT metadata_proxy_shared_secret METADATA_SECRET\n&gt;&gt;&gt;&gt;&gt;\n\n# 再次修改nova配置文件，添加neutron服务\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron url http:&#x2F;&#x2F;controller:9696\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron username neutron\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron service_metadata_proxy True\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron metadata_proxy_shared_secret METADATA_SECRET\n# 校验文件\n[root@controller ~]# md5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n6334f359655efdbcf083b812ab94efc1  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\n# 网络服务初始化脚本需要一个超链接\nln -s &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini &#x2F;etc&#x2F;neutron&#x2F;plugin.ini\n\n# 同步数据库\nsu -s &#x2F;bin&#x2F;sh -c &quot;neutron-db-manage --config-file &#x2F;etc&#x2F;neutron&#x2F;neutron.conf \\\n  --config-file &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;ml2_conf.ini upgrade head&quot; neutron\n  \n# 检查数据库\nmysql neutron -e &quot;show tables;&quot;\n\n# 重启Nova服务\nsystemctl restart openstack-nova-api.service\n\n# 启动Neutron服务\nsystemctl enable neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\nsystemctl start neutron-server.service   neutron-linuxbridge-agent.service neutron-dhcp-agent.service   neutron-metadata-agent.service\n\n# 查看服务有没有起来\nneutron agent-list\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| id                                   | agent_type         | host       | availability_zone | alive | admin_state_up | binary                    |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+\n| 0d68dc27-f2b8-4cae-9c30-cddd126076b4 | Linux bridge agent | controller |                   | :-)   | True           | neutron-linuxbridge-agent |\n| 688cc47d-424d-4243-ae2b-b1c4b298a2a8 | Metadata agent     | controller |                   | :-)   | True           | neutron-metadata-agent    |\n| c4c5e360-ee02-4b9b-a1a5-59a0d0d088b0 | DHCP agent         | controller | nova              | :-)   | True           | neutron-dhcp-agent        |\n+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-6-2-计算节点–安装步骤\"><a href=\"#2-6-2-计算节点–安装步骤\" class=\"headerlink\" title=\"2.6.2 计算节点–安装步骤\"></a>2.6.2 计算节点–安装步骤</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装组件\nyum install -y openstack-neutron-linuxbridge ebtables ipset\n\n# 网络配置--公共网络\ncp &#x2F;etc&#x2F;neutron&#x2F;neutron.conf&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf.bak  &gt; &#x2F;etc&#x2F;neutron&#x2F;neutron.conf\n&gt;&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT rpc_backend rabbit\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf DEFAULT auth_strategy keystone\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_host controller\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_userid openstack\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_messaging_rabbit rabbit_password RABBIT_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_uri http:&#x2F;&#x2F;controller:5000\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken memcached_servers controller:11211\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken auth_type password\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken project_name service\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken username neutron\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf keystone_authtoken password NEUTRON_PASS\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;neutron.conf oslo_concurrency lock_path &#x2F;var&#x2F;lib&#x2F;neutron&#x2F;tmp\n&gt;&gt;&gt;&gt;&gt;&gt;\n# md5校验\nmd5sum &#x2F;etc&#x2F;nova&#x2F;nova.conf\n328cd5f0745e26a420e828b0dfc2934e  &#x2F;etc&#x2F;nova&#x2F;nova.conf\n\ncp &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini&#123;,.bak&#125;\ngrep -Ev &quot;^$|#&quot; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini.bak &gt; &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini\n&gt;&gt;&gt;&gt;&gt;&gt;\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini linux_bridge physical_interface_mappings provider:ens33  # 要修改网络接口名\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini vxlan enable_vxlan False\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup enable_security_group True\nopenstack-config --set &#x2F;etc&#x2F;neutron&#x2F;plugins&#x2F;ml2&#x2F;linuxbridge_agent.ini securitygroup firewall_driver neutron.agent.linux.iptables_firewall.IptablesFirewallDriver\n&gt;&gt;&gt;&gt;&gt;&gt;\n\n# 再次修改nova配置文件，添加neutron配置\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron url http:&#x2F;&#x2F;controller:9696\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_url http:&#x2F;&#x2F;controller:35357\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron auth_type password\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron user_domain_name default\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron region_name RegionOne\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron project_name service\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron username neutron\nopenstack-config --set &#x2F;etc&#x2F;nova&#x2F;nova.conf neutron password NEUTRON_PASS\n\n# 重启nova服务\nsystemctl restart openstack-nova-compute.service\n\n# 启动linuxbridge代理服务\nsystemctl enable neutron-linuxbridge-agent.service\nsystemctl restart neutron-linuxbridge-agent.service\n\n# 查看是否配置成功\ncontroller执行 &gt;&gt; neutron agent-list\n配置正确会多出来一个\nLinux bridge agent | compute1   |                   | :-)   | True \n\n# 查看计算资源\nopenstack compute service list<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-7-安装horizon-（Dashboard）web界面\"><a href=\"#2-7-安装horizon-（Dashboard）web界面\" class=\"headerlink\" title=\"2.7 安装horizon （Dashboard）web界面\"></a>2.7 安装horizon （Dashboard）web界面</h3><h4 id=\"2-7-1-安装步骤（控制节点\"><a href=\"#2-7-1-安装步骤（控制节点\" class=\"headerlink\" title=\"2.7.1 安装步骤（控制节点)\"></a>2.7.1 安装步骤（控制节点)</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 安装组件包\nyum install -y openstack-dashboard\n\n# 修改配置文件\nvim &#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings\n&gt;&gt;&gt;&gt;\nOPENSTACK_HOST &#x3D; &quot;controller&quot;\nALLOWED_HOSTS &#x3D; [&#39;*&#39;, ]\nSESSION_ENGINE &#x3D; &#39;django.contrib.sessions.backends.cache&#39;\nCACHES &#x3D; &#123;\n    &#39;default&#39;: &#123;\n         &#39;BACKEND&#39;: &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,\n         &#39;LOCATION&#39;: &#39;controller:11211&#39;,\n    &#125;\n&#125;\nOPENSTACK_KEYSTONE_URL &#x3D; &quot;http:&#x2F;&#x2F;%s:5000&#x2F;v3&quot; % OPENSTACK_HOST\nOPENSTACK_KEYSTONE_MULTIDOMAIN_SUPPORT &#x3D; True\nOPENSTACK_API_VERSIONS &#x3D; &#123;\n    &quot;identity&quot;: 3,\n    &quot;image&quot;: 2,\n    &quot;volume&quot;: 2,\n&#125;\nOPENSTACK_KEYSTONE_DEFAULT_DOMAIN &#x3D; &quot;default&quot;\nOPENSTACK_KEYSTONE_DEFAULT_ROLE &#x3D; &quot;user&quot;\nOPENSTACK_NEUTRON_NETWORK &#x3D; &#123;\n    ...\n    &#39;enable_router&#39;: False,\n    &#39;enable_quotas&#39;: False,\n    &#39;enable_distributed_router&#39;: False,\n    &#39;enable_ha_router&#39;: False,\n    &#39;enable_lb&#39;: False,\n    &#39;enable_firewall&#39;: False,\n    &#39;enable_vpn&#39;: False,\n    &#39;enable_fip_topology_check&#39;: False,\n&#125;\nTIME_ZONE &#x3D; &quot;Asia&#x2F;Shanghai&quot;\n&gt;&gt;&gt;&gt;\n\n# 解决不能进入页面的BUG\nvim &#x2F;etc&#x2F;httpd&#x2F;conf.d&#x2F;openstack-dashboard.conf\n添加一行 &gt;&gt; WSGIAppicationGroup %&#123;GLOBAL&#125;\n\n# 重启服务\nsystemctl restart httpd.service memcached.service\n\n# 登录界面\nhttps:&#x2F;&#x2F;10.0.0.11&#x2F;dashboard\n域:default\n用户名:admin\n密码:ADMIN_PASS\n\n# 扩展：查看文件输入那个rpm包\nrpm -qf &#x2F;etc&#x2F;openstack-dashboard&#x2F;local_settings<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-7-2-Dashboard报错解决\"><a href=\"#2-7-2-Dashboard报错解决\" class=\"headerlink\" title=\"2.7.2 Dashboard报错解决\"></a>2.7.2 Dashboard报错解决</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 问题1--Invalid service catalog service: image\n发生原因：\n\topenstack service list 存在两个 glance\n解决方法：\n    openstack service delete c12c125edc2041e3aaf2f250442162c6\n    openstack service delete 6a11431b95bc44d1bd1e9371c0faa16b # 两个glance都删掉\n    重复2.4.1在keystone上创建glance服务和注册api\n    再重启服务systemctl restart httpd.service memcached.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-启动一个云主机\"><a href=\"#2-8-启动一个云主机\" class=\"headerlink\" title=\"2.8 启动一个云主机\"></a>2.8 启动一个云主机</h3><h3 id=\"2-8-1-创建步骤\"><a href=\"#2-8-1-创建步骤\" class=\"headerlink\" title=\"2.8.1 创建步骤\"></a>2.8.1 创建步骤</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建网络\nneutron net-create --shared --provider:physical_network provider \\\n  --provider:network_type flat gs\n  \n# 在网络中创建一个子网\nneutron subnet-create --name gs2 \\\n  --allocation-pool start&#x3D;10.0.0.101,end&#x3D;10.0.0.250 \\\n  --dns-nameserver 223.5.5.5 --gateway 10.0.0.2 \\\n  gs 10.0.0.0&#x2F;24\n  \n# 创建云主机硬件配置方案（规格）\nopenstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano\n\n# 创建密钥键值对\nssh-keygen -q -N &quot;&quot; -f ~&#x2F;.ssh&#x2F;id_rsa\nopenstack keypair create --public-key ~&#x2F;.ssh&#x2F;id_rsa.pub mykey\n# 验证公钥的添加\nopenstack keypair list\n\n# 添加安全组规则\nopenstack security group rule create --proto icmp default\nopenstack security group rule create --proto tcp --dst-port 22 default\n\n# 在公有网络启动一个实例\nopenstack flavor list # 查看可用的配置规格\nopenstack image list # 查看可用镜像\nopenstack network list # 查看可用网络\nopenstack security group list # 查看已设置的安全组\n\nopenstack server create --flavor 规格名&#x2F;ID --image 镜像名&#x2F;ID \\\n  --nic net-id&#x3D;网络ID --security-group default \\\n  --key-name mykey 实例名称\n示例：\nopenstack server create --flavor m1.tiny --image cirros \\\n--nic net-id&#x3D;cb032582-893b-414d-b78d-c89c6548612d --security-group default \\\n--key-name mykey my-instance<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-2-创建云主机问题解决\"><a href=\"#2-8-2-创建云主机问题解决\" class=\"headerlink\" title=\"2.8.2 创建云主机问题解决\"></a>2.8.2 创建云主机问题解决</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 1、启动云主机时，No valid host was found\n【计算节点中】\n查看云主机创建日志：&#x2F;var&#x2F;log&#x2F;nova&#x2F;nova-compute.log，里面有记录问题原因是CPU feature spec-ctrl not found\n修改&#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;cpu_map.xml，将和spec-ctrl相关的特性删除\n然后重启服务\nsystemctl restart libvirtd openstack-nova-compute\n参考博客：https:&#x2F;&#x2F;www.cnblogs.com&#x2F;laolieren&#x2F;p&#x2F;solve_openstack_create_instance_error.html\n\n# 2、云主机控制台seabios -- Booting from Hard Disk错误\n【计算节点中】\nvim &#x2F;etc&#x2F;nova&#x2F;nova.conf\n&gt;&gt;&gt;&gt;\n[libvirt]\nvirt_type &#x3D; qemu\ncpu_mode &#x3D; none\n&gt;&gt;&gt;&gt;\nsystemctl restart libvirtd openstack-nova-compute\n重启云主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n"},{"title":"Docker系列(一)-安装Docker","date":"2021-06-28T08:06:37.000Z","_content":"\n## 一、容器简介\n\n>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁，隔离环境拥有自己的系统文件，ip地址，主机名等。\n\n### 1 容器和虚拟化的区别\n\n- KVM虚拟化：\n\n  - 需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）\n\n    开机启动流程\n\n    bios开机硬件自检\n\n    根据bios设置的优先启动项boot\n\n    读取mbr/gpt引导，读取mbr硬盘分区信息，内核加载路径\n\n    加载内核\n\n    启动第一个进程（C6：/sbin/init，C7：systemd）\n\n    系统初始化完成\n\n    运行服务\n\n- 容器：\n\n  - 不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）\n\n    容器的第一个进程直接运行服务，损耗少，启动快，性能高\n\n### 2 容器的优缺点\n\n- 优点\n\n  - 与宿主机使用同一个内核，性能损耗小\n\n    不需要指令级模拟\n\n    容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制\n\n    避免了准虚拟化和系统调用替换中的复杂性\n\n    轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享\n\n- 缺点\n\n  - 使用同一内核，存在安全性问题\n\n### 3 容器技术的发展过程\n\n> chroot --- lxc ---- docker\n\n### 4 Docker组成\n\n​\tDocker基于Go语言开发，C/S模式\n\n- 主要组件\n  - 镜像\n  - 容器\n  - 仓库：最大的dockerhub\n  - 网络\n  - 存储\n\n## 二、Docker安装\n\n>参考网站：https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/\n\n### 1 联网在线安装\n\n开启rpm包缓存，方便制作离线安装包\n\n```shell\nvim /etc/yum.conf\nkeepcache=1 \n```\n\n如果你之前安装过 docker，请先删掉\n\n```shell\nsudo yum remove docker docker-common docker-selinux docker-engine\n```\n\n安装一些依赖\n\n```shell\nsudo yum install -y yum-utils device-mapper-persistent-data lvm2\n```\n\n根据你的发行版下载repo文件（Centos）\n\n```shell\nwget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n把软件仓库替换为TUNA：\n\n```shell\nsudo sed -i 's+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo\n```\n\n最后安装:\n\n```shell\nsudo yum makecache fast\n    sudo yum install docker-ce\n```\n\n### 2 无网环境下离线安装\n\n搜集联网环境下下载的rpm包\n\n```shell\nfind /var/cache/yum/x86_64/7/ -name \"*.rpm\" | xargs -i mv {} docker_rpm/\ntar -zvcf docker_rpm.tgz docker_rpm/\n```\n\n拷贝到无网环境的服务器中安装\n\n```shell\ntar -vxf docker_rpm.tgz # 解压\ncd docker_rpm\t\nrpm -Uvh ./*.rpm # 安装\n```\n\n### 3 启动服务并验证安装是否成功\n\n```shell\n# 启动服务\nsystemctl enable docker\nsystemctl start docker\n\n# 验证是否安装成功\ndocker version\ndocker info\n```\n\n### 4 Docker镜像下载加速\n\n- 阿里云docker镜像加速器服务\n- 配置docker镜像加速(推荐)\n\n```shell\n# 创建文件\nvi /etc/docker/daemon.json\n{    \n\t\"registry-mirrors\":[\"https://registry.docker-cn.com\"]\n} \n# 重新加载\nsystemctl daemon-reload\nsystemctl restart docker\n```\n\n### 5 创建并运行一个nginx容器\n\n```shell\ndocker run -d -p 80:80 nginx\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-一-安装Docker.md","raw":"---\ntitle: Docker系列(一)-安装Docker\ndate: 2021-06-28 16:06:37\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、容器简介\n\n>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁，隔离环境拥有自己的系统文件，ip地址，主机名等。\n\n### 1 容器和虚拟化的区别\n\n- KVM虚拟化：\n\n  - 需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）\n\n    开机启动流程\n\n    bios开机硬件自检\n\n    根据bios设置的优先启动项boot\n\n    读取mbr/gpt引导，读取mbr硬盘分区信息，内核加载路径\n\n    加载内核\n\n    启动第一个进程（C6：/sbin/init，C7：systemd）\n\n    系统初始化完成\n\n    运行服务\n\n- 容器：\n\n  - 不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）\n\n    容器的第一个进程直接运行服务，损耗少，启动快，性能高\n\n### 2 容器的优缺点\n\n- 优点\n\n  - 与宿主机使用同一个内核，性能损耗小\n\n    不需要指令级模拟\n\n    容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制\n\n    避免了准虚拟化和系统调用替换中的复杂性\n\n    轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享\n\n- 缺点\n\n  - 使用同一内核，存在安全性问题\n\n### 3 容器技术的发展过程\n\n> chroot --- lxc ---- docker\n\n### 4 Docker组成\n\n​\tDocker基于Go语言开发，C/S模式\n\n- 主要组件\n  - 镜像\n  - 容器\n  - 仓库：最大的dockerhub\n  - 网络\n  - 存储\n\n## 二、Docker安装\n\n>参考网站：https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/\n\n### 1 联网在线安装\n\n开启rpm包缓存，方便制作离线安装包\n\n```shell\nvim /etc/yum.conf\nkeepcache=1 \n```\n\n如果你之前安装过 docker，请先删掉\n\n```shell\nsudo yum remove docker docker-common docker-selinux docker-engine\n```\n\n安装一些依赖\n\n```shell\nsudo yum install -y yum-utils device-mapper-persistent-data lvm2\n```\n\n根据你的发行版下载repo文件（Centos）\n\n```shell\nwget -O /etc/yum.repos.d/docker-ce.repo https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n把软件仓库替换为TUNA：\n\n```shell\nsudo sed -i 's+download.docker.com+mirrors.tuna.tsinghua.edu.cn/docker-ce+' /etc/yum.repos.d/docker-ce.repo\n```\n\n最后安装:\n\n```shell\nsudo yum makecache fast\n    sudo yum install docker-ce\n```\n\n### 2 无网环境下离线安装\n\n搜集联网环境下下载的rpm包\n\n```shell\nfind /var/cache/yum/x86_64/7/ -name \"*.rpm\" | xargs -i mv {} docker_rpm/\ntar -zvcf docker_rpm.tgz docker_rpm/\n```\n\n拷贝到无网环境的服务器中安装\n\n```shell\ntar -vxf docker_rpm.tgz # 解压\ncd docker_rpm\t\nrpm -Uvh ./*.rpm # 安装\n```\n\n### 3 启动服务并验证安装是否成功\n\n```shell\n# 启动服务\nsystemctl enable docker\nsystemctl start docker\n\n# 验证是否安装成功\ndocker version\ndocker info\n```\n\n### 4 Docker镜像下载加速\n\n- 阿里云docker镜像加速器服务\n- 配置docker镜像加速(推荐)\n\n```shell\n# 创建文件\nvi /etc/docker/daemon.json\n{    \n\t\"registry-mirrors\":[\"https://registry.docker-cn.com\"]\n} \n# 重新加载\nsystemctl daemon-reload\nsystemctl restart docker\n```\n\n### 5 创建并运行一个nginx容器\n\n```shell\ndocker run -d -p 80:80 nginx\n```\n\n","slug":"01_运维/03-Docker/Docker系列-一-安装Docker","published":1,"updated":"2022-07-06T07:20:02.090Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0p001da8v7akfi4plm","content":"<h2 id=\"一、容器简介\"><a href=\"#一、容器简介\" class=\"headerlink\" title=\"一、容器简介\"></a>一、容器简介</h2><blockquote>\n<p>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁，隔离环境拥有自己的系统文件，ip地址，主机名等。</p>\n</blockquote>\n<h3 id=\"1-容器和虚拟化的区别\"><a href=\"#1-容器和虚拟化的区别\" class=\"headerlink\" title=\"1 容器和虚拟化的区别\"></a>1 容器和虚拟化的区别</h3><ul>\n<li><p>KVM虚拟化：</p>\n<ul>\n<li><p>需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）</p>\n<p>开机启动流程</p>\n<p>bios开机硬件自检</p>\n<p>根据bios设置的优先启动项boot</p>\n<p>读取mbr&#x2F;gpt引导，读取mbr硬盘分区信息，内核加载路径</p>\n<p>加载内核</p>\n<p>启动第一个进程（C6：&#x2F;sbin&#x2F;init，C7：systemd）</p>\n<p>系统初始化完成</p>\n<p>运行服务</p>\n</li>\n</ul>\n</li>\n<li><p>容器：</p>\n<ul>\n<li><p>不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）</p>\n<p>容器的第一个进程直接运行服务，损耗少，启动快，性能高</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"2-容器的优缺点\"><a href=\"#2-容器的优缺点\" class=\"headerlink\" title=\"2 容器的优缺点\"></a>2 容器的优缺点</h3><ul>\n<li><p>优点</p>\n<ul>\n<li><p>与宿主机使用同一个内核，性能损耗小</p>\n<p>不需要指令级模拟</p>\n<p>容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制</p>\n<p>避免了准虚拟化和系统调用替换中的复杂性</p>\n<p>轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享</p>\n</li>\n</ul>\n</li>\n<li><p>缺点</p>\n<ul>\n<li>使用同一内核，存在安全性问题</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3-容器技术的发展过程\"><a href=\"#3-容器技术的发展过程\" class=\"headerlink\" title=\"3 容器技术的发展过程\"></a>3 容器技术的发展过程</h3><blockquote>\n<p>chroot — lxc —- docker</p>\n</blockquote>\n<h3 id=\"4-Docker组成\"><a href=\"#4-Docker组成\" class=\"headerlink\" title=\"4 Docker组成\"></a>4 Docker组成</h3><p>​\tDocker基于Go语言开发，C&#x2F;S模式</p>\n<ul>\n<li>主要组件<ul>\n<li>镜像</li>\n<li>容器</li>\n<li>仓库：最大的dockerhub</li>\n<li>网络</li>\n<li>存储</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"二、Docker安装\"><a href=\"#二、Docker安装\" class=\"headerlink\" title=\"二、Docker安装\"></a>二、Docker安装</h2><blockquote>\n<p>参考网站：<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/\">https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/</a></p>\n</blockquote>\n<h3 id=\"1-联网在线安装\"><a href=\"#1-联网在线安装\" class=\"headerlink\" title=\"1 联网在线安装\"></a>1 联网在线安装</h3><p>开启rpm包缓存，方便制作离线安装包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.conf\nkeepcache&#x3D;1 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>如果你之前安装过 docker，请先删掉</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum remove docker docker-common docker-selinux docker-engine<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>安装一些依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum install -y yum-utils device-mapper-persistent-data lvm2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>根据你的发行版下载repo文件（Centos）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>把软件仓库替换为TUNA：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo sed -i &#39;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn&#x2F;docker-ce+&#39; &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>最后安装:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum makecache fast\n    sudo yum install docker-ce<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-无网环境下离线安装\"><a href=\"#2-无网环境下离线安装\" class=\"headerlink\" title=\"2 无网环境下离线安装\"></a>2 无网环境下离线安装</h3><p>搜集联网环境下下载的rpm包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">find &#x2F;var&#x2F;cache&#x2F;yum&#x2F;x86_64&#x2F;7&#x2F; -name &quot;*.rpm&quot; | xargs -i mv &#123;&#125; docker_rpm&#x2F;\ntar -zvcf docker_rpm.tgz docker_rpm&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>拷贝到无网环境的服务器中安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar -vxf docker_rpm.tgz # 解压\ncd docker_rpm\t\nrpm -Uvh .&#x2F;*.rpm # 安装<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-启动服务并验证安装是否成功\"><a href=\"#3-启动服务并验证安装是否成功\" class=\"headerlink\" title=\"3 启动服务并验证安装是否成功\"></a>3 启动服务并验证安装是否成功</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 启动服务\nsystemctl enable docker\nsystemctl start docker\n\n# 验证是否安装成功\ndocker version\ndocker info<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-Docker镜像下载加速\"><a href=\"#4-Docker镜像下载加速\" class=\"headerlink\" title=\"4 Docker镜像下载加速\"></a>4 Docker镜像下载加速</h3><ul>\n<li>阿里云docker镜像加速器服务</li>\n<li>配置docker镜像加速(推荐)</li>\n</ul>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建文件\nvi &#x2F;etc&#x2F;docker&#x2F;daemon.json\n&#123;    \n\t&quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;]\n&#125; \n# 重新加载\nsystemctl daemon-reload\nsystemctl restart docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"5-创建并运行一个nginx容器\"><a href=\"#5-创建并运行一个nginx容器\" class=\"headerlink\" title=\"5 创建并运行一个nginx容器\"></a>5 创建并运行一个nginx容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、容器简介\"><a href=\"#一、容器简介\" class=\"headerlink\" title=\"一、容器简介\"></a>一、容器简介</h2><blockquote>\n<p>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁，隔离环境拥有自己的系统文件，ip地址，主机名等。</p>\n</blockquote>\n<h3 id=\"1-容器和虚拟化的区别\"><a href=\"#1-容器和虚拟化的区别\" class=\"headerlink\" title=\"1 容器和虚拟化的区别\"></a>1 容器和虚拟化的区别</h3><ul>\n<li><p>KVM虚拟化：</p>\n<ul>\n<li><p>需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）</p>\n<p>开机启动流程</p>\n<p>bios开机硬件自检</p>\n<p>根据bios设置的优先启动项boot</p>\n<p>读取mbr&#x2F;gpt引导，读取mbr硬盘分区信息，内核加载路径</p>\n<p>加载内核</p>\n<p>启动第一个进程（C6：&#x2F;sbin&#x2F;init，C7：systemd）</p>\n<p>系统初始化完成</p>\n<p>运行服务</p>\n</li>\n</ul>\n</li>\n<li><p>容器：</p>\n<ul>\n<li><p>不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）</p>\n<p>容器的第一个进程直接运行服务，损耗少，启动快，性能高</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"2-容器的优缺点\"><a href=\"#2-容器的优缺点\" class=\"headerlink\" title=\"2 容器的优缺点\"></a>2 容器的优缺点</h3><ul>\n<li><p>优点</p>\n<ul>\n<li><p>与宿主机使用同一个内核，性能损耗小</p>\n<p>不需要指令级模拟</p>\n<p>容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制</p>\n<p>避免了准虚拟化和系统调用替换中的复杂性</p>\n<p>轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享</p>\n</li>\n</ul>\n</li>\n<li><p>缺点</p>\n<ul>\n<li>使用同一内核，存在安全性问题</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"3-容器技术的发展过程\"><a href=\"#3-容器技术的发展过程\" class=\"headerlink\" title=\"3 容器技术的发展过程\"></a>3 容器技术的发展过程</h3><blockquote>\n<p>chroot — lxc —- docker</p>\n</blockquote>\n<h3 id=\"4-Docker组成\"><a href=\"#4-Docker组成\" class=\"headerlink\" title=\"4 Docker组成\"></a>4 Docker组成</h3><p>​\tDocker基于Go语言开发，C&#x2F;S模式</p>\n<ul>\n<li>主要组件<ul>\n<li>镜像</li>\n<li>容器</li>\n<li>仓库：最大的dockerhub</li>\n<li>网络</li>\n<li>存储</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"二、Docker安装\"><a href=\"#二、Docker安装\" class=\"headerlink\" title=\"二、Docker安装\"></a>二、Docker安装</h2><blockquote>\n<p>参考网站：<a href=\"https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/\">https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/</a></p>\n</blockquote>\n<h3 id=\"1-联网在线安装\"><a href=\"#1-联网在线安装\" class=\"headerlink\" title=\"1 联网在线安装\"></a>1 联网在线安装</h3><p>开启rpm包缓存，方便制作离线安装包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;yum.conf\nkeepcache&#x3D;1 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>如果你之前安装过 docker，请先删掉</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum remove docker docker-common docker-selinux docker-engine<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>安装一些依赖</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum install -y yum-utils device-mapper-persistent-data lvm2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>根据你的发行版下载repo文件（Centos）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo https:&#x2F;&#x2F;download.docker.com&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>把软件仓库替换为TUNA：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo sed -i &#39;s+download.docker.com+mirrors.tuna.tsinghua.edu.cn&#x2F;docker-ce+&#39; &#x2F;etc&#x2F;yum.repos.d&#x2F;docker-ce.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>最后安装:</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sudo yum makecache fast\n    sudo yum install docker-ce<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-无网环境下离线安装\"><a href=\"#2-无网环境下离线安装\" class=\"headerlink\" title=\"2 无网环境下离线安装\"></a>2 无网环境下离线安装</h3><p>搜集联网环境下下载的rpm包</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">find &#x2F;var&#x2F;cache&#x2F;yum&#x2F;x86_64&#x2F;7&#x2F; -name &quot;*.rpm&quot; | xargs -i mv &#123;&#125; docker_rpm&#x2F;\ntar -zvcf docker_rpm.tgz docker_rpm&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>拷贝到无网环境的服务器中安装</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar -vxf docker_rpm.tgz # 解压\ncd docker_rpm\t\nrpm -Uvh .&#x2F;*.rpm # 安装<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-启动服务并验证安装是否成功\"><a href=\"#3-启动服务并验证安装是否成功\" class=\"headerlink\" title=\"3 启动服务并验证安装是否成功\"></a>3 启动服务并验证安装是否成功</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 启动服务\nsystemctl enable docker\nsystemctl start docker\n\n# 验证是否安装成功\ndocker version\ndocker info<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-Docker镜像下载加速\"><a href=\"#4-Docker镜像下载加速\" class=\"headerlink\" title=\"4 Docker镜像下载加速\"></a>4 Docker镜像下载加速</h3><ul>\n<li>阿里云docker镜像加速器服务</li>\n<li>配置docker镜像加速(推荐)</li>\n</ul>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建文件\nvi &#x2F;etc&#x2F;docker&#x2F;daemon.json\n&#123;    \n\t&quot;registry-mirrors&quot;:[&quot;https:&#x2F;&#x2F;registry.docker-cn.com&quot;]\n&#125; \n# 重新加载\nsystemctl daemon-reload\nsystemctl restart docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"5-创建并运行一个nginx容器\"><a href=\"#5-创建并运行一个nginx容器\" class=\"headerlink\" title=\"5 创建并运行一个nginx容器\"></a>5 创建并运行一个nginx容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"Docker系列(七)-Docker镜像分层与同主机中容器互连","date":"2021-07-05T07:28:40.000Z","_content":"\n## 一、Docker镜像分层\n\n>镜像分层的好处：\n>\n>​\t复用、节省磁盘空间，相同的内容只需加载一份到内存\n>\n>​\t修改dockerfile后，重新构建时可以用缓存，速度快\n\n### 1 查看docker镜像分层\n\n通过导入镜像可以查看到镜像分层\n\n```shell\ndocker load -i [镜像文件]\n```\n\n通过查看镜像历史可以查看到分层\n\n```shell\n[root@docker01 ~]# docker image history centos6.9_ssh:v2\nIMAGE          CREATED       CREATED BY                                      SIZE      COMMENT\n57761235f898   2 days ago    /bin/sh -c #(nop)  CMD [\"/usr/sbin/sshd\" \"-D…   0B\nc0a2c21457c4   2 days ago    /bin/sh -c echo '123456' | passwd --stdin ro…   537B\n29d10ff8b8e0   2 days ago    /bin/sh -c service sshd restart                 4.91kB\n666b9ddfff15   2 days ago    /bin/sh -c yum install openssh-server -y        154MB\n5b00553af9fc   2 days ago    /bin/sh -c #(nop) ADD file:65a30e1b327fec80b…   1.18kB\n2199b8eb8390   2 years ago   /bin/sh -c #(nop)  CMD [\"/bin/bash\"]            0B\n<missing>      2 years ago   /bin/sh -c #(nop)  LABEL name=CentOS Base Im…   0B\n<missing>      2 years ago   /bin/sh -c #(nop) ADD file:0e6d175401c5b4260…   195MB\n```\n\n所有的这些层都会在`Docker`主机本地存储区域内存储，可以通过以下指令来列出：\n\n```shell\nls /var/lib/docker/overlay2/\n```\n\n### 2  通过Dockerfile优化分层信息\n\n- 尽量合并RUN和ADD来减少镜像分层数\n- 新加的Dockerfile语句加到最后，不要加到前面\n\n## 二、同主机中容器互连（--link是单向的）\n\n>docker官方已不推荐使用docker run --link来链接2个容器互相通信，随后的版本中会删除--link\n\n### 1 功能介绍\n\ndocker run --link可以用来链接2个容器，使得源容器（被链接的容器）和接受容器（主动去链接的容器）之间可以互相通信，并且接收容器可以获取源容器的一些数据，如源容器的环境变量。使用案例如下：\n\n源容器启动：\n\n```shell\ndocker run -d --name src_docker nginx \n容器ID:xxxx01, IP:172.16.0.2\n```\n\n接受容器连接：\n\n```shell\ndocker run -d --name dest_docker --link src_docker:web centos7.9:v2\n容器ID:xxxx02, IP:172.16.0.3\n```\n\n进入接受容器测试，不需要ping IP，直接ping别名就可以，web和src_docker都指向172.16.0.2<font color=red>（单向）</font>\n\n```shell\ndocker exec -it xxxx01 /bin/bash\nping web\nping src_docker\n```\n\n> 接受容器的/etc/hosts将更新\n\n### 2 案例：构建zabbix-server\n\n启动一个mysql的容器\n\n```shell\ndocker run --name mysql-server -t \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      -d mysql:5.7 \\\n      --character-set-server=utf8 --collation-server=utf8_bin \n```\n\n启动java-gateway容器监控java服务\n\n```shell\ndocker run --name zabbix-java-gateway -t \\\n      -d zabbix/zabbix-java-gateway:latest\n```\n\n启动zabbix-mysql容器使用link连接mysql与java-gateway\n\n```shell\ndocker run --name zabbix-server-mysql -t \\\n      -e DB_SERVER_HOST=\"mysql-server\" \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      -e ZBX_JAVAGATEWAY=\"zabbix-java-gateway\" \\\n      --link mysql-server:mysql \\\n      --link zabbix-java-gateway:zabbix-java-gateway \\\n      -p 10051:10051 \\\n      -d zabbix/zabbix-server-mysql:latest\n```\n\n启动zabbix web显示，使用link连接zabbix-mysql与mysql\n\n>zabbix的默认端口已有80改为8080，可见配置文件/etc/zabbix/nginx.conf\n\n```she\ndocker run --name zabbix-web-nginx-mysql -t \\\n      -e DB_SERVER_HOST=\"mysql-server\" \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      --link mysql-server:mysql \\\n      --link zabbix-server-mysql:zabbix-server \\\n      -p 8082:8080 \\     \n      -d zabbix/zabbix-web-nginx-mysql:latest\n```\n\n登录Zabbix\n\n```she\n浏览器访问：10.0.0.11:8082\nAdmin\nzabbix\n```\n\n添加被监控节点-安装zabbix-agent\n\n>获取zabbix-agent：\n>\n>uname -a 查看内核版本\n>\n>web页面查看zabbix版本\n>\n>https://www.zabbix.com/download 获取对应agent的安装方法\n\n```shell\n rpm -Uvh https://repo.zabbix.com/zabbix/5.4/rhel/7/x86_64/zabbix-release-5.4-1.el7.noarch.rpm\n yum clean all\n yum install zabbix-agent\n```\n\n添加被监控节点-agent配置文件修改\n\n>117行：Server=10.0.0.11, 注意防火墙和selinux的阻挡\n\n```shell\nvim /etc/zabbix/zabbix_agentd.conf\nsystemctl restart zabbix-agent\n```\n\n## 三、docker重启后容器不退出\n\n> 默认情况下，systemctl restart docker之后，容器将处于Exited状态\n\n### 1 添加容器启动参数\n\n>docker重启后，容器先停止，再立即重新启动\n\n```shell\ndocker run --restart=always\n```\n\n### 2 daemon配置文件修改（不推荐）\n\n>docker重启后，容器不会停止，一直在运行，不推荐使用，不好控制\n\n```shell\nvim /etc/docker/daemon.json\n# 添加一行，上行后面加逗号\n\"live-restore\":true\n```\n\n\n\n\n\n​\t\n\n\n\n","source":"_posts/01_运维/03-Docker/Docker系列-七-Docker镜像分层与同主机中容器互连.md","raw":"---\ntitle: Docker系列(七)-Docker镜像分层与同主机中容器互连\ndate: 2021-07-05 15:28:40\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、Docker镜像分层\n\n>镜像分层的好处：\n>\n>​\t复用、节省磁盘空间，相同的内容只需加载一份到内存\n>\n>​\t修改dockerfile后，重新构建时可以用缓存，速度快\n\n### 1 查看docker镜像分层\n\n通过导入镜像可以查看到镜像分层\n\n```shell\ndocker load -i [镜像文件]\n```\n\n通过查看镜像历史可以查看到分层\n\n```shell\n[root@docker01 ~]# docker image history centos6.9_ssh:v2\nIMAGE          CREATED       CREATED BY                                      SIZE      COMMENT\n57761235f898   2 days ago    /bin/sh -c #(nop)  CMD [\"/usr/sbin/sshd\" \"-D…   0B\nc0a2c21457c4   2 days ago    /bin/sh -c echo '123456' | passwd --stdin ro…   537B\n29d10ff8b8e0   2 days ago    /bin/sh -c service sshd restart                 4.91kB\n666b9ddfff15   2 days ago    /bin/sh -c yum install openssh-server -y        154MB\n5b00553af9fc   2 days ago    /bin/sh -c #(nop) ADD file:65a30e1b327fec80b…   1.18kB\n2199b8eb8390   2 years ago   /bin/sh -c #(nop)  CMD [\"/bin/bash\"]            0B\n<missing>      2 years ago   /bin/sh -c #(nop)  LABEL name=CentOS Base Im…   0B\n<missing>      2 years ago   /bin/sh -c #(nop) ADD file:0e6d175401c5b4260…   195MB\n```\n\n所有的这些层都会在`Docker`主机本地存储区域内存储，可以通过以下指令来列出：\n\n```shell\nls /var/lib/docker/overlay2/\n```\n\n### 2  通过Dockerfile优化分层信息\n\n- 尽量合并RUN和ADD来减少镜像分层数\n- 新加的Dockerfile语句加到最后，不要加到前面\n\n## 二、同主机中容器互连（--link是单向的）\n\n>docker官方已不推荐使用docker run --link来链接2个容器互相通信，随后的版本中会删除--link\n\n### 1 功能介绍\n\ndocker run --link可以用来链接2个容器，使得源容器（被链接的容器）和接受容器（主动去链接的容器）之间可以互相通信，并且接收容器可以获取源容器的一些数据，如源容器的环境变量。使用案例如下：\n\n源容器启动：\n\n```shell\ndocker run -d --name src_docker nginx \n容器ID:xxxx01, IP:172.16.0.2\n```\n\n接受容器连接：\n\n```shell\ndocker run -d --name dest_docker --link src_docker:web centos7.9:v2\n容器ID:xxxx02, IP:172.16.0.3\n```\n\n进入接受容器测试，不需要ping IP，直接ping别名就可以，web和src_docker都指向172.16.0.2<font color=red>（单向）</font>\n\n```shell\ndocker exec -it xxxx01 /bin/bash\nping web\nping src_docker\n```\n\n> 接受容器的/etc/hosts将更新\n\n### 2 案例：构建zabbix-server\n\n启动一个mysql的容器\n\n```shell\ndocker run --name mysql-server -t \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      -d mysql:5.7 \\\n      --character-set-server=utf8 --collation-server=utf8_bin \n```\n\n启动java-gateway容器监控java服务\n\n```shell\ndocker run --name zabbix-java-gateway -t \\\n      -d zabbix/zabbix-java-gateway:latest\n```\n\n启动zabbix-mysql容器使用link连接mysql与java-gateway\n\n```shell\ndocker run --name zabbix-server-mysql -t \\\n      -e DB_SERVER_HOST=\"mysql-server\" \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      -e ZBX_JAVAGATEWAY=\"zabbix-java-gateway\" \\\n      --link mysql-server:mysql \\\n      --link zabbix-java-gateway:zabbix-java-gateway \\\n      -p 10051:10051 \\\n      -d zabbix/zabbix-server-mysql:latest\n```\n\n启动zabbix web显示，使用link连接zabbix-mysql与mysql\n\n>zabbix的默认端口已有80改为8080，可见配置文件/etc/zabbix/nginx.conf\n\n```she\ndocker run --name zabbix-web-nginx-mysql -t \\\n      -e DB_SERVER_HOST=\"mysql-server\" \\\n      -e MYSQL_DATABASE=\"zabbix\" \\\n      -e MYSQL_USER=\"zabbix\" \\\n      -e MYSQL_PASSWORD=\"zabbix_pwd\" \\\n      -e MYSQL_ROOT_PASSWORD=\"root_pwd\" \\\n      --link mysql-server:mysql \\\n      --link zabbix-server-mysql:zabbix-server \\\n      -p 8082:8080 \\     \n      -d zabbix/zabbix-web-nginx-mysql:latest\n```\n\n登录Zabbix\n\n```she\n浏览器访问：10.0.0.11:8082\nAdmin\nzabbix\n```\n\n添加被监控节点-安装zabbix-agent\n\n>获取zabbix-agent：\n>\n>uname -a 查看内核版本\n>\n>web页面查看zabbix版本\n>\n>https://www.zabbix.com/download 获取对应agent的安装方法\n\n```shell\n rpm -Uvh https://repo.zabbix.com/zabbix/5.4/rhel/7/x86_64/zabbix-release-5.4-1.el7.noarch.rpm\n yum clean all\n yum install zabbix-agent\n```\n\n添加被监控节点-agent配置文件修改\n\n>117行：Server=10.0.0.11, 注意防火墙和selinux的阻挡\n\n```shell\nvim /etc/zabbix/zabbix_agentd.conf\nsystemctl restart zabbix-agent\n```\n\n## 三、docker重启后容器不退出\n\n> 默认情况下，systemctl restart docker之后，容器将处于Exited状态\n\n### 1 添加容器启动参数\n\n>docker重启后，容器先停止，再立即重新启动\n\n```shell\ndocker run --restart=always\n```\n\n### 2 daemon配置文件修改（不推荐）\n\n>docker重启后，容器不会停止，一直在运行，不推荐使用，不好控制\n\n```shell\nvim /etc/docker/daemon.json\n# 添加一行，上行后面加逗号\n\"live-restore\":true\n```\n\n\n\n\n\n​\t\n\n\n\n","slug":"01_运维/03-Docker/Docker系列-七-Docker镜像分层与同主机中容器互连","published":1,"updated":"2022-07-06T07:19:35.581Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0q001ea8v7e52se6od","content":"<h2 id=\"一、Docker镜像分层\"><a href=\"#一、Docker镜像分层\" class=\"headerlink\" title=\"一、Docker镜像分层\"></a>一、Docker镜像分层</h2><blockquote>\n<p>镜像分层的好处：</p>\n<p>​\t复用、节省磁盘空间，相同的内容只需加载一份到内存</p>\n<p>​\t修改dockerfile后，重新构建时可以用缓存，速度快</p>\n</blockquote>\n<h3 id=\"1-查看docker镜像分层\"><a href=\"#1-查看docker镜像分层\" class=\"headerlink\" title=\"1 查看docker镜像分层\"></a>1 查看docker镜像分层</h3><p>通过导入镜像可以查看到镜像分层</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker load -i [镜像文件]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>通过查看镜像历史可以查看到分层</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 ~]# docker image history centos6.9_ssh:v2\nIMAGE          CREATED       CREATED BY                                      SIZE      COMMENT\n57761235f898   2 days ago    &#x2F;bin&#x2F;sh -c #(nop)  CMD [&quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot; &quot;-D…   0B\nc0a2c21457c4   2 days ago    &#x2F;bin&#x2F;sh -c echo &#39;123456&#39; | passwd --stdin ro…   537B\n29d10ff8b8e0   2 days ago    &#x2F;bin&#x2F;sh -c service sshd restart                 4.91kB\n666b9ddfff15   2 days ago    &#x2F;bin&#x2F;sh -c yum install openssh-server -y        154MB\n5b00553af9fc   2 days ago    &#x2F;bin&#x2F;sh -c #(nop) ADD file:65a30e1b327fec80b…   1.18kB\n2199b8eb8390   2 years ago   &#x2F;bin&#x2F;sh -c #(nop)  CMD [&quot;&#x2F;bin&#x2F;bash&quot;]            0B\n&lt;missing&gt;      2 years ago   &#x2F;bin&#x2F;sh -c #(nop)  LABEL name&#x3D;CentOS Base Im…   0B\n&lt;missing&gt;      2 years ago   &#x2F;bin&#x2F;sh -c #(nop) ADD file:0e6d175401c5b4260…   195MB<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>所有的这些层都会在<code>Docker</code>主机本地存储区域内存储，可以通过以下指令来列出：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ls &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-通过Dockerfile优化分层信息\"><a href=\"#2-通过Dockerfile优化分层信息\" class=\"headerlink\" title=\"2  通过Dockerfile优化分层信息\"></a>2  通过Dockerfile优化分层信息</h3><ul>\n<li>尽量合并RUN和ADD来减少镜像分层数</li>\n<li>新加的Dockerfile语句加到最后，不要加到前面</li>\n</ul>\n<h2 id=\"二、同主机中容器互连（–link是单向的）\"><a href=\"#二、同主机中容器互连（–link是单向的）\" class=\"headerlink\" title=\"二、同主机中容器互连（–link是单向的）\"></a>二、同主机中容器互连（–link是单向的）</h2><blockquote>\n<p>docker官方已不推荐使用docker run –link来链接2个容器互相通信，随后的版本中会删除–link</p>\n</blockquote>\n<h3 id=\"1-功能介绍\"><a href=\"#1-功能介绍\" class=\"headerlink\" title=\"1 功能介绍\"></a>1 功能介绍</h3><p>docker run –link可以用来链接2个容器，使得源容器（被链接的容器）和接受容器（主动去链接的容器）之间可以互相通信，并且接收容器可以获取源容器的一些数据，如源容器的环境变量。使用案例如下：</p>\n<p>源容器启动：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d --name src_docker nginx \n容器ID:xxxx01, IP:172.16.0.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>接受容器连接：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d --name dest_docker --link src_docker:web centos7.9:v2\n容器ID:xxxx02, IP:172.16.0.3<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>进入接受容器测试，不需要ping IP，直接ping别名就可以，web和src_docker都指向172.16.0.2<font color=red>（单向）</font></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it xxxx01 &#x2F;bin&#x2F;bash\nping web\nping src_docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>接受容器的&#x2F;etc&#x2F;hosts将更新</p>\n</blockquote>\n<h3 id=\"2-案例：构建zabbix-server\"><a href=\"#2-案例：构建zabbix-server\" class=\"headerlink\" title=\"2 案例：构建zabbix-server\"></a>2 案例：构建zabbix-server</h3><p>启动一个mysql的容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name mysql-server -t \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      -d mysql:5.7 \\\n      --character-set-server&#x3D;utf8 --collation-server&#x3D;utf8_bin <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动java-gateway容器监控java服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name zabbix-java-gateway -t \\\n      -d zabbix&#x2F;zabbix-java-gateway:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动zabbix-mysql容器使用link连接mysql与java-gateway</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name zabbix-server-mysql -t \\\n      -e DB_SERVER_HOST&#x3D;&quot;mysql-server&quot; \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      -e ZBX_JAVAGATEWAY&#x3D;&quot;zabbix-java-gateway&quot; \\\n      --link mysql-server:mysql \\\n      --link zabbix-java-gateway:zabbix-java-gateway \\\n      -p 10051:10051 \\\n      -d zabbix&#x2F;zabbix-server-mysql:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动zabbix web显示，使用link连接zabbix-mysql与mysql</p>\n<blockquote>\n<p>zabbix的默认端口已有80改为8080，可见配置文件&#x2F;etc&#x2F;zabbix&#x2F;nginx.conf</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker run --name zabbix-web-nginx-mysql -t \\\n      -e DB_SERVER_HOST&#x3D;&quot;mysql-server&quot; \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      --link mysql-server:mysql \\\n      --link zabbix-server-mysql:zabbix-server \\\n      -p 8082:8080 \\     \n      -d zabbix&#x2F;zabbix-web-nginx-mysql:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>登录Zabbix</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">浏览器访问：10.0.0.11:8082\nAdmin\nzabbix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>添加被监控节点-安装zabbix-agent</p>\n<blockquote>\n<p>获取zabbix-agent：</p>\n<p>uname -a 查看内核版本</p>\n<p>web页面查看zabbix版本</p>\n<p><a href=\"https://www.zabbix.com/download\">https://www.zabbix.com/download</a> 获取对应agent的安装方法</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rpm -Uvh https:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;5.4&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-release-5.4-1.el7.noarch.rpm\nyum clean all\nyum install zabbix-agent<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>添加被监控节点-agent配置文件修改</p>\n<blockquote>\n<p>117行：Server&#x3D;10.0.0.11, 注意防火墙和selinux的阻挡</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf\nsystemctl restart zabbix-agent<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、docker重启后容器不退出\"><a href=\"#三、docker重启后容器不退出\" class=\"headerlink\" title=\"三、docker重启后容器不退出\"></a>三、docker重启后容器不退出</h2><blockquote>\n<p>默认情况下，systemctl restart docker之后，容器将处于Exited状态</p>\n</blockquote>\n<h3 id=\"1-添加容器启动参数\"><a href=\"#1-添加容器启动参数\" class=\"headerlink\" title=\"1 添加容器启动参数\"></a>1 添加容器启动参数</h3><blockquote>\n<p>docker重启后，容器先停止，再立即重新启动</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --restart&#x3D;always<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-daemon配置文件修改（不推荐）\"><a href=\"#2-daemon配置文件修改（不推荐）\" class=\"headerlink\" title=\"2 daemon配置文件修改（不推荐）\"></a>2 daemon配置文件修改（不推荐）</h3><blockquote>\n<p>docker重启后，容器不会停止，一直在运行，不推荐使用，不好控制</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json\n# 添加一行，上行后面加逗号\n&quot;live-restore&quot;:true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<p>​\t</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Docker镜像分层\"><a href=\"#一、Docker镜像分层\" class=\"headerlink\" title=\"一、Docker镜像分层\"></a>一、Docker镜像分层</h2><blockquote>\n<p>镜像分层的好处：</p>\n<p>​\t复用、节省磁盘空间，相同的内容只需加载一份到内存</p>\n<p>​\t修改dockerfile后，重新构建时可以用缓存，速度快</p>\n</blockquote>\n<h3 id=\"1-查看docker镜像分层\"><a href=\"#1-查看docker镜像分层\" class=\"headerlink\" title=\"1 查看docker镜像分层\"></a>1 查看docker镜像分层</h3><p>通过导入镜像可以查看到镜像分层</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker load -i [镜像文件]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>通过查看镜像历史可以查看到分层</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 ~]# docker image history centos6.9_ssh:v2\nIMAGE          CREATED       CREATED BY                                      SIZE      COMMENT\n57761235f898   2 days ago    &#x2F;bin&#x2F;sh -c #(nop)  CMD [&quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot; &quot;-D…   0B\nc0a2c21457c4   2 days ago    &#x2F;bin&#x2F;sh -c echo &#39;123456&#39; | passwd --stdin ro…   537B\n29d10ff8b8e0   2 days ago    &#x2F;bin&#x2F;sh -c service sshd restart                 4.91kB\n666b9ddfff15   2 days ago    &#x2F;bin&#x2F;sh -c yum install openssh-server -y        154MB\n5b00553af9fc   2 days ago    &#x2F;bin&#x2F;sh -c #(nop) ADD file:65a30e1b327fec80b…   1.18kB\n2199b8eb8390   2 years ago   &#x2F;bin&#x2F;sh -c #(nop)  CMD [&quot;&#x2F;bin&#x2F;bash&quot;]            0B\n&lt;missing&gt;      2 years ago   &#x2F;bin&#x2F;sh -c #(nop)  LABEL name&#x3D;CentOS Base Im…   0B\n&lt;missing&gt;      2 years ago   &#x2F;bin&#x2F;sh -c #(nop) ADD file:0e6d175401c5b4260…   195MB<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>所有的这些层都会在<code>Docker</code>主机本地存储区域内存储，可以通过以下指令来列出：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ls &#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-通过Dockerfile优化分层信息\"><a href=\"#2-通过Dockerfile优化分层信息\" class=\"headerlink\" title=\"2  通过Dockerfile优化分层信息\"></a>2  通过Dockerfile优化分层信息</h3><ul>\n<li>尽量合并RUN和ADD来减少镜像分层数</li>\n<li>新加的Dockerfile语句加到最后，不要加到前面</li>\n</ul>\n<h2 id=\"二、同主机中容器互连（–link是单向的）\"><a href=\"#二、同主机中容器互连（–link是单向的）\" class=\"headerlink\" title=\"二、同主机中容器互连（–link是单向的）\"></a>二、同主机中容器互连（–link是单向的）</h2><blockquote>\n<p>docker官方已不推荐使用docker run –link来链接2个容器互相通信，随后的版本中会删除–link</p>\n</blockquote>\n<h3 id=\"1-功能介绍\"><a href=\"#1-功能介绍\" class=\"headerlink\" title=\"1 功能介绍\"></a>1 功能介绍</h3><p>docker run –link可以用来链接2个容器，使得源容器（被链接的容器）和接受容器（主动去链接的容器）之间可以互相通信，并且接收容器可以获取源容器的一些数据，如源容器的环境变量。使用案例如下：</p>\n<p>源容器启动：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d --name src_docker nginx \n容器ID:xxxx01, IP:172.16.0.2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>接受容器连接：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d --name dest_docker --link src_docker:web centos7.9:v2\n容器ID:xxxx02, IP:172.16.0.3<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>进入接受容器测试，不需要ping IP，直接ping别名就可以，web和src_docker都指向172.16.0.2<font color=red>（单向）</font></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it xxxx01 &#x2F;bin&#x2F;bash\nping web\nping src_docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>接受容器的&#x2F;etc&#x2F;hosts将更新</p>\n</blockquote>\n<h3 id=\"2-案例：构建zabbix-server\"><a href=\"#2-案例：构建zabbix-server\" class=\"headerlink\" title=\"2 案例：构建zabbix-server\"></a>2 案例：构建zabbix-server</h3><p>启动一个mysql的容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name mysql-server -t \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      -d mysql:5.7 \\\n      --character-set-server&#x3D;utf8 --collation-server&#x3D;utf8_bin <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动java-gateway容器监控java服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name zabbix-java-gateway -t \\\n      -d zabbix&#x2F;zabbix-java-gateway:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>启动zabbix-mysql容器使用link连接mysql与java-gateway</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --name zabbix-server-mysql -t \\\n      -e DB_SERVER_HOST&#x3D;&quot;mysql-server&quot; \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      -e ZBX_JAVAGATEWAY&#x3D;&quot;zabbix-java-gateway&quot; \\\n      --link mysql-server:mysql \\\n      --link zabbix-java-gateway:zabbix-java-gateway \\\n      -p 10051:10051 \\\n      -d zabbix&#x2F;zabbix-server-mysql:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>启动zabbix web显示，使用link连接zabbix-mysql与mysql</p>\n<blockquote>\n<p>zabbix的默认端口已有80改为8080，可见配置文件&#x2F;etc&#x2F;zabbix&#x2F;nginx.conf</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker run --name zabbix-web-nginx-mysql -t \\\n      -e DB_SERVER_HOST&#x3D;&quot;mysql-server&quot; \\\n      -e MYSQL_DATABASE&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_USER&#x3D;&quot;zabbix&quot; \\\n      -e MYSQL_PASSWORD&#x3D;&quot;zabbix_pwd&quot; \\\n      -e MYSQL_ROOT_PASSWORD&#x3D;&quot;root_pwd&quot; \\\n      --link mysql-server:mysql \\\n      --link zabbix-server-mysql:zabbix-server \\\n      -p 8082:8080 \\     \n      -d zabbix&#x2F;zabbix-web-nginx-mysql:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>登录Zabbix</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">浏览器访问：10.0.0.11:8082\nAdmin\nzabbix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>添加被监控节点-安装zabbix-agent</p>\n<blockquote>\n<p>获取zabbix-agent：</p>\n<p>uname -a 查看内核版本</p>\n<p>web页面查看zabbix版本</p>\n<p><a href=\"https://www.zabbix.com/download\">https://www.zabbix.com/download</a> 获取对应agent的安装方法</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">rpm -Uvh https:&#x2F;&#x2F;repo.zabbix.com&#x2F;zabbix&#x2F;5.4&#x2F;rhel&#x2F;7&#x2F;x86_64&#x2F;zabbix-release-5.4-1.el7.noarch.rpm\nyum clean all\nyum install zabbix-agent<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>添加被监控节点-agent配置文件修改</p>\n<blockquote>\n<p>117行：Server&#x3D;10.0.0.11, 注意防火墙和selinux的阻挡</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;zabbix&#x2F;zabbix_agentd.conf\nsystemctl restart zabbix-agent<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、docker重启后容器不退出\"><a href=\"#三、docker重启后容器不退出\" class=\"headerlink\" title=\"三、docker重启后容器不退出\"></a>三、docker重启后容器不退出</h2><blockquote>\n<p>默认情况下，systemctl restart docker之后，容器将处于Exited状态</p>\n</blockquote>\n<h3 id=\"1-添加容器启动参数\"><a href=\"#1-添加容器启动参数\" class=\"headerlink\" title=\"1 添加容器启动参数\"></a>1 添加容器启动参数</h3><blockquote>\n<p>docker重启后，容器先停止，再立即重新启动</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --restart&#x3D;always<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-daemon配置文件修改（不推荐）\"><a href=\"#2-daemon配置文件修改（不推荐）\" class=\"headerlink\" title=\"2 daemon配置文件修改（不推荐）\"></a>2 daemon配置文件修改（不推荐）</h3><blockquote>\n<p>docker重启后，容器不会停止，一直在运行，不推荐使用，不好控制</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json\n# 添加一行，上行后面加逗号\n&quot;live-restore&quot;:true<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<p>​\t</p>\n"},{"title":"Docker系列(三)-容器的网络访问","date":"2021-06-29T01:34:01.000Z","_content":"\n## 一、容器的网络访问流程\n\n>参考：https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02\n\n### 1 虚拟机注意事项 \n\n查看net.ipv4.ip_forward值是否为1\n\n```shell\nsysctl -a | grep ipv4 | grep forward \n```\n\n只有值为1时docker容器才能上网，而vmware虚拟机挂起将使他变成0，解决方法：\n\n- sysctl net.ipv4.ip_forward = 1 设置为1\n- 不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1\n\n## 二、容器端口映射\n\n### 1 docker run -p端口映射参数\n\n指定端口访问\n\n```shell\n# 将容器80端口，映射到主机180端口\ndocker run -p 180:80\n```\n\n指定IP+端口访问\n\n```shell\n# 多网卡环境下，将容器80端口映射到10.0.0.1的180端口\ndocker run -p 10.0.0.1:180:80\n```\n\n指定随机端口\n\n```she\n# 将容器80端口，映射到主机随机端口\ndocker run -p 10.0.0.1::80\n```\n\n指定随机端口+UDP (默认映射TCP)\n\n```shell\n# 将容器80端口映射到主机随机端口，并使用UDP协议\n-p 10.0.0.100:80:udp # 指定随机端口 + udp\n```\n\n可以指定多个端口\n\n```shell\n-p 180:80 -p 1443:443 # 指定多个端口\n```\n\n随机映射\n\n```shell\ndocker run -P\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-三-容器的网络访问.md","raw":"---\ntitle: Docker系列(三)-容器的网络访问\ndate: 2021-06-29 09:34:01\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、容器的网络访问流程\n\n>参考：https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02\n\n### 1 虚拟机注意事项 \n\n查看net.ipv4.ip_forward值是否为1\n\n```shell\nsysctl -a | grep ipv4 | grep forward \n```\n\n只有值为1时docker容器才能上网，而vmware虚拟机挂起将使他变成0，解决方法：\n\n- sysctl net.ipv4.ip_forward = 1 设置为1\n- 不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1\n\n## 二、容器端口映射\n\n### 1 docker run -p端口映射参数\n\n指定端口访问\n\n```shell\n# 将容器80端口，映射到主机180端口\ndocker run -p 180:80\n```\n\n指定IP+端口访问\n\n```shell\n# 多网卡环境下，将容器80端口映射到10.0.0.1的180端口\ndocker run -p 10.0.0.1:180:80\n```\n\n指定随机端口\n\n```she\n# 将容器80端口，映射到主机随机端口\ndocker run -p 10.0.0.1::80\n```\n\n指定随机端口+UDP (默认映射TCP)\n\n```shell\n# 将容器80端口映射到主机随机端口，并使用UDP协议\n-p 10.0.0.100:80:udp # 指定随机端口 + udp\n```\n\n可以指定多个端口\n\n```shell\n-p 180:80 -p 1443:443 # 指定多个端口\n```\n\n随机映射\n\n```shell\ndocker run -P\n```\n\n","slug":"01_运维/03-Docker/Docker系列-三-容器的网络访问","published":1,"updated":"2022-07-06T07:19:40.271Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0r001ga8v7dmlc8220","content":"<h2 id=\"一、容器的网络访问流程\"><a href=\"#一、容器的网络访问流程\" class=\"headerlink\" title=\"一、容器的网络访问流程\"></a>一、容器的网络访问流程</h2><blockquote>\n<p>参考：<a href=\"https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02\">https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02</a></p>\n</blockquote>\n<h3 id=\"1-虚拟机注意事项\"><a href=\"#1-虚拟机注意事项\" class=\"headerlink\" title=\"1 虚拟机注意事项\"></a>1 虚拟机注意事项</h3><p>查看net.ipv4.ip_forward值是否为1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sysctl -a | grep ipv4 | grep forward <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>只有值为1时docker容器才能上网，而vmware虚拟机挂起将使他变成0，解决方法：</p>\n<ul>\n<li>sysctl net.ipv4.ip_forward &#x3D; 1 设置为1</li>\n<li>不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1</li>\n</ul>\n<h2 id=\"二、容器端口映射\"><a href=\"#二、容器端口映射\" class=\"headerlink\" title=\"二、容器端口映射\"></a>二、容器端口映射</h2><h3 id=\"1-docker-run-p端口映射参数\"><a href=\"#1-docker-run-p端口映射参数\" class=\"headerlink\" title=\"1 docker run -p端口映射参数\"></a>1 docker run -p端口映射参数</h3><p>指定端口访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将容器80端口，映射到主机180端口\ndocker run -p 180:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定IP+端口访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 多网卡环境下，将容器80端口映射到10.0.0.1的180端口\ndocker run -p 10.0.0.1:180:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定随机端口</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\"># 将容器80端口，映射到主机随机端口\ndocker run -p 10.0.0.1::80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定随机端口+UDP (默认映射TCP)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将容器80端口映射到主机随机端口，并使用UDP协议\n-p 10.0.0.100:80:udp # 指定随机端口 + udp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>可以指定多个端口</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-p 180:80 -p 1443:443 # 指定多个端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>随机映射</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -P<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、容器的网络访问流程\"><a href=\"#一、容器的网络访问流程\" class=\"headerlink\" title=\"一、容器的网络访问流程\"></a>一、容器的网络访问流程</h2><blockquote>\n<p>参考：<a href=\"https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02\">https://z.itpub.net/article/detail/FE8EBAC62D5881E3A432291F8C8E4F02</a></p>\n</blockquote>\n<h3 id=\"1-虚拟机注意事项\"><a href=\"#1-虚拟机注意事项\" class=\"headerlink\" title=\"1 虚拟机注意事项\"></a>1 虚拟机注意事项</h3><p>查看net.ipv4.ip_forward值是否为1</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">sysctl -a | grep ipv4 | grep forward <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>只有值为1时docker容器才能上网，而vmware虚拟机挂起将使他变成0，解决方法：</p>\n<ul>\n<li>sysctl net.ipv4.ip_forward &#x3D; 1 设置为1</li>\n<li>不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1</li>\n</ul>\n<h2 id=\"二、容器端口映射\"><a href=\"#二、容器端口映射\" class=\"headerlink\" title=\"二、容器端口映射\"></a>二、容器端口映射</h2><h3 id=\"1-docker-run-p端口映射参数\"><a href=\"#1-docker-run-p端口映射参数\" class=\"headerlink\" title=\"1 docker run -p端口映射参数\"></a>1 docker run -p端口映射参数</h3><p>指定端口访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将容器80端口，映射到主机180端口\ndocker run -p 180:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定IP+端口访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 多网卡环境下，将容器80端口映射到10.0.0.1的180端口\ndocker run -p 10.0.0.1:180:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定随机端口</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\"># 将容器80端口，映射到主机随机端口\ndocker run -p 10.0.0.1::80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>指定随机端口+UDP (默认映射TCP)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将容器80端口映射到主机随机端口，并使用UDP协议\n-p 10.0.0.100:80:udp # 指定随机端口 + udp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>可以指定多个端口</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">-p 180:80 -p 1443:443 # 指定多个端口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>随机映射</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -P<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"Docker系列(九)-Dokcer跨主机容器互连","date":"2021-07-06T13:21:33.000Z","_content":"\n## 一、Docker容器的四种网络类型\n\n>哪四种？\n>\n>- bridge（默认）：NAT桥接模式\n>- none：不分配网络，什么服务都访问不了\n>- host：与宿主机共享网络，共享主机名，端口共用(宿主机用了的端口，容器也不能用)，【网络性能最高】\n>- container:容器id：与容器xx共享网络，共享主机名、hosts、hostname、端口等....【K8S常用】\n\n### 1 指定与查看容器网络类型的方法\n\n指定容器网络类型\n\n```shell\ndocker run --network none # 指定网络类型\n```\n\n查看容器网络类型\n\n```shell\ndocker instpect 容器id # 可以查看当前的容器网络类型\n# 查看字段\n\"NetworkSettings\": {\n\t\"Bridge\": \"\",\n```\n\n查看有哪些网络类型\n\n```shell\ndocker network ls # 查看有哪些网络类型\n```\n\n\n\n## 二、使用macvlan实现\n\n>优势：\n>\n>​\t性能比overlay高\n>\n>​\t不用做端口映射，外界可直接访问\n>\n>劣势：\n>\n>​\tIP需要手动指定\n\n### 1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信\n\n>宿主机信息（虚拟机）：\n>\n>​\tdocker01: 10.0.0.11 网关: 10.0.0.2\n>\n>​\tdocker02: 10.0.0.12 网关: 10.0.0.2\n\n宿主机1,2分别创建macvlan\n\n```shell\ndocker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.2 -o parent=ens33 macvlan_1\n```\n\n设置网卡为混杂模式【Ubuntu需要设置】\n\n>混杂模式是计算机网络中的术语。 是指一台机器的网卡能够接收所有经过它的数据流，而不论其目的地址是否是它。\n\n```shell\nip link set ens33 promisc on\n```\n\n宿主机1,2分别使用centos7.9_ssh:v2镜像创建容器，并指定为macvlan_1网络\n\n```shell\n# docker01\ndocker run -d --network macvlan_1 --ip=10.0.0.100 centos6.9_ssh:v2\n# docker02\ndocker run -d --network macvlan_1 --ip=10.0.0.200 centos6.9_ssh:v2\n```\n\n测试，docker exec进入docker01中运行容器，开启抓包，并使用docker02中的容器ping它\n\n```shell\ntcpdump icmp\n```\n\n通过xshell或者mobaxterm可以直接ssh到容器中 (PS:并没有 -p 22端口)\n\n> 实际测试宿主机并不能ssh到容器，显示No route to host，但是物理机可以连接\n\n```shell\nssh root@10.0.0.100\n```\n\n\n\n## 三、使用overlay实现\n\n>优势：\n>\n>​\t可以自动分配ip地址\n>\n>劣势：\n>\n>​\t需要做端口映射才能访问容器服务\n>\n>overlay参考：https://www.cnblogs.com/CloudMan6/p/7270551.html\n\n### 1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信\n\ndocker01启动consul\n\n>consul是一个key:value类型的存储数据库\n\n```shell\ndocker run -d -p 8500:8500 --restart=always -h consul --name consul progrium/consul -server -bootstrap\n```\n\ndocker01,02上设置daemon.json文件\n\n```shell\nvim /etc/docker/daemon.json\n```\n\n```json\n\"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"],\n\"cluster-store\":\"consul://10.0.0.11:8500\",\n\"cluster-advertise\":\"10.0.0.11:2376\" # 此处不同，docker01为10.0.0.11，docker02为12\n```\n\n修改docker.service文件\n\n>因为daemon.json中的hosts项与docker.service中的-H参数冲突，需要去掉\n\n```shell\nvim /usr/lib/systemd/system/docker.service\nExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n# 删除-H fd://\nExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock\n```\n\n重启docker服务\n\n```shell\nsystemctl daemon-reload\nsystemctl restart docker\n```\n\n测试consul是否搭建成功\n\n```shell\n浏览器访问：http://10.0.0.11:8500/\n在KEY/VALUE标签页正常显示10.0.0.11和12两台宿主机\n```\n\ndocker01,02创建overlay网络\n\n```shell\ndocker network create -d overlay --subnet 172.16.1.0/24 --gateway 172.16.1.254 ol1\n```\n\n启动容器\n\n```shell\n# docker01\ndocker run -d --network ol1 --name centos6.9_01 centos6.9_ssh:v2\n# docker02\ndocker run -d --network ol1 --name centos6.9_02 centos6.9_ssh:v2\n```\n\n测试容器间网络\n\n```shell\n# docker01中的容器ping另一容器的hostname\n[root@e1e8cc01792d /]# ping centos6.9_02\nPING centos6.9_02 (172.16.1.2) 56(84) bytes of data.\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=1 ttl=64 time=0.197 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=2 ttl=64 time=0.269 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=3 ttl=64 time=1.04 ms\n```\n\n### 2 Overlay的网络访问流程图\n{% asset_img overlay网络访问.png overlay网络访问 %}\n\n","source":"_posts/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连.md","raw":"---\ntitle: Docker系列(九)-Dokcer跨主机容器互连\ndate: 2021-07-06 21:21:33\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、Docker容器的四种网络类型\n\n>哪四种？\n>\n>- bridge（默认）：NAT桥接模式\n>- none：不分配网络，什么服务都访问不了\n>- host：与宿主机共享网络，共享主机名，端口共用(宿主机用了的端口，容器也不能用)，【网络性能最高】\n>- container:容器id：与容器xx共享网络，共享主机名、hosts、hostname、端口等....【K8S常用】\n\n### 1 指定与查看容器网络类型的方法\n\n指定容器网络类型\n\n```shell\ndocker run --network none # 指定网络类型\n```\n\n查看容器网络类型\n\n```shell\ndocker instpect 容器id # 可以查看当前的容器网络类型\n# 查看字段\n\"NetworkSettings\": {\n\t\"Bridge\": \"\",\n```\n\n查看有哪些网络类型\n\n```shell\ndocker network ls # 查看有哪些网络类型\n```\n\n\n\n## 二、使用macvlan实现\n\n>优势：\n>\n>​\t性能比overlay高\n>\n>​\t不用做端口映射，外界可直接访问\n>\n>劣势：\n>\n>​\tIP需要手动指定\n\n### 1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信\n\n>宿主机信息（虚拟机）：\n>\n>​\tdocker01: 10.0.0.11 网关: 10.0.0.2\n>\n>​\tdocker02: 10.0.0.12 网关: 10.0.0.2\n\n宿主机1,2分别创建macvlan\n\n```shell\ndocker network create --driver macvlan --subnet 10.0.0.0/24 --gateway 10.0.0.2 -o parent=ens33 macvlan_1\n```\n\n设置网卡为混杂模式【Ubuntu需要设置】\n\n>混杂模式是计算机网络中的术语。 是指一台机器的网卡能够接收所有经过它的数据流，而不论其目的地址是否是它。\n\n```shell\nip link set ens33 promisc on\n```\n\n宿主机1,2分别使用centos7.9_ssh:v2镜像创建容器，并指定为macvlan_1网络\n\n```shell\n# docker01\ndocker run -d --network macvlan_1 --ip=10.0.0.100 centos6.9_ssh:v2\n# docker02\ndocker run -d --network macvlan_1 --ip=10.0.0.200 centos6.9_ssh:v2\n```\n\n测试，docker exec进入docker01中运行容器，开启抓包，并使用docker02中的容器ping它\n\n```shell\ntcpdump icmp\n```\n\n通过xshell或者mobaxterm可以直接ssh到容器中 (PS:并没有 -p 22端口)\n\n> 实际测试宿主机并不能ssh到容器，显示No route to host，但是物理机可以连接\n\n```shell\nssh root@10.0.0.100\n```\n\n\n\n## 三、使用overlay实现\n\n>优势：\n>\n>​\t可以自动分配ip地址\n>\n>劣势：\n>\n>​\t需要做端口映射才能访问容器服务\n>\n>overlay参考：https://www.cnblogs.com/CloudMan6/p/7270551.html\n\n### 1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信\n\ndocker01启动consul\n\n>consul是一个key:value类型的存储数据库\n\n```shell\ndocker run -d -p 8500:8500 --restart=always -h consul --name consul progrium/consul -server -bootstrap\n```\n\ndocker01,02上设置daemon.json文件\n\n```shell\nvim /etc/docker/daemon.json\n```\n\n```json\n\"hosts\":[\"tcp://0.0.0.0:2376\",\"unix:///var/run/docker.sock\"],\n\"cluster-store\":\"consul://10.0.0.11:8500\",\n\"cluster-advertise\":\"10.0.0.11:2376\" # 此处不同，docker01为10.0.0.11，docker02为12\n```\n\n修改docker.service文件\n\n>因为daemon.json中的hosts项与docker.service中的-H参数冲突，需要去掉\n\n```shell\nvim /usr/lib/systemd/system/docker.service\nExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock\n# 删除-H fd://\nExecStart=/usr/bin/dockerd --containerd=/run/containerd/containerd.sock\n```\n\n重启docker服务\n\n```shell\nsystemctl daemon-reload\nsystemctl restart docker\n```\n\n测试consul是否搭建成功\n\n```shell\n浏览器访问：http://10.0.0.11:8500/\n在KEY/VALUE标签页正常显示10.0.0.11和12两台宿主机\n```\n\ndocker01,02创建overlay网络\n\n```shell\ndocker network create -d overlay --subnet 172.16.1.0/24 --gateway 172.16.1.254 ol1\n```\n\n启动容器\n\n```shell\n# docker01\ndocker run -d --network ol1 --name centos6.9_01 centos6.9_ssh:v2\n# docker02\ndocker run -d --network ol1 --name centos6.9_02 centos6.9_ssh:v2\n```\n\n测试容器间网络\n\n```shell\n# docker01中的容器ping另一容器的hostname\n[root@e1e8cc01792d /]# ping centos6.9_02\nPING centos6.9_02 (172.16.1.2) 56(84) bytes of data.\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=1 ttl=64 time=0.197 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=2 ttl=64 time=0.269 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq=3 ttl=64 time=1.04 ms\n```\n\n### 2 Overlay的网络访问流程图\n{% asset_img overlay网络访问.png overlay网络访问 %}\n\n","slug":"01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连","published":1,"updated":"2022-07-06T07:19:18.592Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0r001ha8v7ee6o98da","content":"<h2 id=\"一、Docker容器的四种网络类型\"><a href=\"#一、Docker容器的四种网络类型\" class=\"headerlink\" title=\"一、Docker容器的四种网络类型\"></a>一、Docker容器的四种网络类型</h2><blockquote>\n<p>哪四种？</p>\n<ul>\n<li>bridge（默认）：NAT桥接模式</li>\n<li>none：不分配网络，什么服务都访问不了</li>\n<li>host：与宿主机共享网络，共享主机名，端口共用(宿主机用了的端口，容器也不能用)，【网络性能最高】</li>\n<li>container:容器id：与容器xx共享网络，共享主机名、hosts、hostname、端口等….【K8S常用】</li>\n</ul>\n</blockquote>\n<h3 id=\"1-指定与查看容器网络类型的方法\"><a href=\"#1-指定与查看容器网络类型的方法\" class=\"headerlink\" title=\"1 指定与查看容器网络类型的方法\"></a>1 指定与查看容器网络类型的方法</h3><p>指定容器网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --network none # 指定网络类型<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看容器网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker instpect 容器id # 可以查看当前的容器网络类型\n# 查看字段\n&quot;NetworkSettings&quot;: &#123;\n\t&quot;Bridge&quot;: &quot;&quot;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看有哪些网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network ls # 查看有哪些网络类型<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h2 id=\"二、使用macvlan实现\"><a href=\"#二、使用macvlan实现\" class=\"headerlink\" title=\"二、使用macvlan实现\"></a>二、使用macvlan实现</h2><blockquote>\n<p>优势：</p>\n<p>​\t性能比overlay高</p>\n<p>​\t不用做端口映射，外界可直接访问</p>\n<p>劣势：</p>\n<p>​\tIP需要手动指定</p>\n</blockquote>\n<h3 id=\"1-案例：使用macvlan实现两个centos6-9-ssh容器跨主机网络通信\"><a href=\"#1-案例：使用macvlan实现两个centos6-9-ssh容器跨主机网络通信\" class=\"headerlink\" title=\"1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信\"></a>1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信</h3><blockquote>\n<p>宿主机信息（虚拟机）：</p>\n<p>​\tdocker01: 10.0.0.11 网关: 10.0.0.2</p>\n<p>​\tdocker02: 10.0.0.12 网关: 10.0.0.2</p>\n</blockquote>\n<p>宿主机1,2分别创建macvlan</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network create --driver macvlan --subnet 10.0.0.0&#x2F;24 --gateway 10.0.0.2 -o parent&#x3D;ens33 macvlan_1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>设置网卡为混杂模式【Ubuntu需要设置】</p>\n<blockquote>\n<p>混杂模式是计算机网络中的术语。 是指一台机器的网卡能够接收所有经过它的数据流，而不论其目的地址是否是它。</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ip link set ens33 promisc on<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>宿主机1,2分别使用centos7.9_ssh:v2镜像创建容器，并指定为macvlan_1网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01\ndocker run -d --network macvlan_1 --ip&#x3D;10.0.0.100 centos6.9_ssh:v2\n# docker02\ndocker run -d --network macvlan_1 --ip&#x3D;10.0.0.200 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试，docker exec进入docker01中运行容器，开启抓包，并使用docker02中的容器ping它</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tcpdump icmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>通过xshell或者mobaxterm可以直接ssh到容器中 (PS:并没有 -p 22端口)</p>\n<blockquote>\n<p>实际测试宿主机并不能ssh到容器，显示No route to host，但是物理机可以连接</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ssh root@10.0.0.100<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h2 id=\"三、使用overlay实现\"><a href=\"#三、使用overlay实现\" class=\"headerlink\" title=\"三、使用overlay实现\"></a>三、使用overlay实现</h2><blockquote>\n<p>优势：</p>\n<p>​\t可以自动分配ip地址</p>\n<p>劣势：</p>\n<p>​\t需要做端口映射才能访问容器服务</p>\n<p>overlay参考：<a href=\"https://www.cnblogs.com/CloudMan6/p/7270551.html\">https://www.cnblogs.com/CloudMan6/p/7270551.html</a></p>\n</blockquote>\n<h3 id=\"1-案例：使用overlay实现两个centos6-9-ssh容器跨主机网络通信\"><a href=\"#1-案例：使用overlay实现两个centos6-9-ssh容器跨主机网络通信\" class=\"headerlink\" title=\"1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信\"></a>1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信</h3><p>docker01启动consul</p>\n<blockquote>\n<p>consul是一个key:value类型的存储数据库</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 8500:8500 --restart&#x3D;always -h consul --name consul progrium&#x2F;consul -server -bootstrap<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>docker01,02上设置daemon.json文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\"><span class=\"token property\">\"hosts\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"tcp://0.0.0.0:2376\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"unix:///var/run/docker.sock\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"cluster-store\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"consul://10.0.0.11:8500\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"cluster-advertise\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"10.0.0.11:2376\"</span> # 此处不同，docker01为<span class=\"token number\">10.0</span>.<span class=\"token number\">0.11</span>，docker02为<span class=\"token number\">12</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>修改docker.service文件</p>\n<blockquote>\n<p>因为daemon.json中的hosts项与docker.service中的-H参数冲突，需要去掉</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service\nExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock\n# 删除-H fd:&#x2F;&#x2F;\nExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启docker服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl daemon-reload\nsystemctl restart docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试consul是否搭建成功</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">浏览器访问：http:&#x2F;&#x2F;10.0.0.11:8500&#x2F;\n在KEY&#x2F;VALUE标签页正常显示10.0.0.11和12两台宿主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>docker01,02创建overlay网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network create -d overlay --subnet 172.16.1.0&#x2F;24 --gateway 172.16.1.254 ol1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01\ndocker run -d --network ol1 --name centos6.9_01 centos6.9_ssh:v2\n# docker02\ndocker run -d --network ol1 --name centos6.9_02 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试容器间网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01中的容器ping另一容器的hostname\n[root@e1e8cc01792d &#x2F;]# ping centos6.9_02\nPING centos6.9_02 (172.16.1.2) 56(84) bytes of data.\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.197 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.269 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;1.04 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-Overlay的网络访问流程图\"><a href=\"#2-Overlay的网络访问流程图\" class=\"headerlink\" title=\"2 Overlay的网络访问流程图\"></a>2 Overlay的网络访问流程图</h3><img src=\"/2021/07/06/01_%E8%BF%90%E7%BB%B4/03-Docker/Docker%E7%B3%BB%E5%88%97-%E4%B9%9D-Dokcer%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%AE%B9%E5%99%A8%E4%BA%92%E8%BF%9E/overlay%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE.png\" class=\"\" title=\"overlay网络访问\">\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Docker容器的四种网络类型\"><a href=\"#一、Docker容器的四种网络类型\" class=\"headerlink\" title=\"一、Docker容器的四种网络类型\"></a>一、Docker容器的四种网络类型</h2><blockquote>\n<p>哪四种？</p>\n<ul>\n<li>bridge（默认）：NAT桥接模式</li>\n<li>none：不分配网络，什么服务都访问不了</li>\n<li>host：与宿主机共享网络，共享主机名，端口共用(宿主机用了的端口，容器也不能用)，【网络性能最高】</li>\n<li>container:容器id：与容器xx共享网络，共享主机名、hosts、hostname、端口等….【K8S常用】</li>\n</ul>\n</blockquote>\n<h3 id=\"1-指定与查看容器网络类型的方法\"><a href=\"#1-指定与查看容器网络类型的方法\" class=\"headerlink\" title=\"1 指定与查看容器网络类型的方法\"></a>1 指定与查看容器网络类型的方法</h3><p>指定容器网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run --network none # 指定网络类型<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看容器网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker instpect 容器id # 可以查看当前的容器网络类型\n# 查看字段\n&quot;NetworkSettings&quot;: &#123;\n\t&quot;Bridge&quot;: &quot;&quot;,<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看有哪些网络类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network ls # 查看有哪些网络类型<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h2 id=\"二、使用macvlan实现\"><a href=\"#二、使用macvlan实现\" class=\"headerlink\" title=\"二、使用macvlan实现\"></a>二、使用macvlan实现</h2><blockquote>\n<p>优势：</p>\n<p>​\t性能比overlay高</p>\n<p>​\t不用做端口映射，外界可直接访问</p>\n<p>劣势：</p>\n<p>​\tIP需要手动指定</p>\n</blockquote>\n<h3 id=\"1-案例：使用macvlan实现两个centos6-9-ssh容器跨主机网络通信\"><a href=\"#1-案例：使用macvlan实现两个centos6-9-ssh容器跨主机网络通信\" class=\"headerlink\" title=\"1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信\"></a>1 案例：使用macvlan实现两个centos6.9_ssh容器跨主机网络通信</h3><blockquote>\n<p>宿主机信息（虚拟机）：</p>\n<p>​\tdocker01: 10.0.0.11 网关: 10.0.0.2</p>\n<p>​\tdocker02: 10.0.0.12 网关: 10.0.0.2</p>\n</blockquote>\n<p>宿主机1,2分别创建macvlan</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network create --driver macvlan --subnet 10.0.0.0&#x2F;24 --gateway 10.0.0.2 -o parent&#x3D;ens33 macvlan_1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>设置网卡为混杂模式【Ubuntu需要设置】</p>\n<blockquote>\n<p>混杂模式是计算机网络中的术语。 是指一台机器的网卡能够接收所有经过它的数据流，而不论其目的地址是否是它。</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ip link set ens33 promisc on<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>宿主机1,2分别使用centos7.9_ssh:v2镜像创建容器，并指定为macvlan_1网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01\ndocker run -d --network macvlan_1 --ip&#x3D;10.0.0.100 centos6.9_ssh:v2\n# docker02\ndocker run -d --network macvlan_1 --ip&#x3D;10.0.0.200 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试，docker exec进入docker01中运行容器，开启抓包，并使用docker02中的容器ping它</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tcpdump icmp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>通过xshell或者mobaxterm可以直接ssh到容器中 (PS:并没有 -p 22端口)</p>\n<blockquote>\n<p>实际测试宿主机并不能ssh到容器，显示No route to host，但是物理机可以连接</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">ssh root@10.0.0.100<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n\n\n<h2 id=\"三、使用overlay实现\"><a href=\"#三、使用overlay实现\" class=\"headerlink\" title=\"三、使用overlay实现\"></a>三、使用overlay实现</h2><blockquote>\n<p>优势：</p>\n<p>​\t可以自动分配ip地址</p>\n<p>劣势：</p>\n<p>​\t需要做端口映射才能访问容器服务</p>\n<p>overlay参考：<a href=\"https://www.cnblogs.com/CloudMan6/p/7270551.html\">https://www.cnblogs.com/CloudMan6/p/7270551.html</a></p>\n</blockquote>\n<h3 id=\"1-案例：使用overlay实现两个centos6-9-ssh容器跨主机网络通信\"><a href=\"#1-案例：使用overlay实现两个centos6-9-ssh容器跨主机网络通信\" class=\"headerlink\" title=\"1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信\"></a>1 案例：使用overlay实现两个centos6.9_ssh容器跨主机网络通信</h3><p>docker01启动consul</p>\n<blockquote>\n<p>consul是一个key:value类型的存储数据库</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 8500:8500 --restart&#x3D;always -h consul --name consul progrium&#x2F;consul -server -bootstrap<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>docker01,02上设置daemon.json文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-json\" data-language=\"json\"><code class=\"language-json\"><span class=\"token property\">\"hosts\"</span><span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"tcp://0.0.0.0:2376\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"unix:///var/run/docker.sock\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"cluster-store\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"consul://10.0.0.11:8500\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token property\">\"cluster-advertise\"</span><span class=\"token operator\">:</span><span class=\"token string\">\"10.0.0.11:2376\"</span> # 此处不同，docker01为<span class=\"token number\">10.0</span>.<span class=\"token number\">0.11</span>，docker02为<span class=\"token number\">12</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>修改docker.service文件</p>\n<blockquote>\n<p>因为daemon.json中的hosts项与docker.service中的-H参数冲突，需要去掉</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;docker.service\nExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd -H fd:&#x2F;&#x2F; --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock\n# 删除-H fd:&#x2F;&#x2F;\nExecStart&#x3D;&#x2F;usr&#x2F;bin&#x2F;dockerd --containerd&#x3D;&#x2F;run&#x2F;containerd&#x2F;containerd.sock<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启docker服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl daemon-reload\nsystemctl restart docker<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试consul是否搭建成功</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">浏览器访问：http:&#x2F;&#x2F;10.0.0.11:8500&#x2F;\n在KEY&#x2F;VALUE标签页正常显示10.0.0.11和12两台宿主机<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>docker01,02创建overlay网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker network create -d overlay --subnet 172.16.1.0&#x2F;24 --gateway 172.16.1.254 ol1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01\ndocker run -d --network ol1 --name centos6.9_01 centos6.9_ssh:v2\n# docker02\ndocker run -d --network ol1 --name centos6.9_02 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试容器间网络</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># docker01中的容器ping另一容器的hostname\n[root@e1e8cc01792d &#x2F;]# ping centos6.9_02\nPING centos6.9_02 (172.16.1.2) 56(84) bytes of data.\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.197 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;2 ttl&#x3D;64 time&#x3D;0.269 ms\n64 bytes from centos6.9_02.ol1 (172.16.1.2): icmp_seq&#x3D;3 ttl&#x3D;64 time&#x3D;1.04 ms<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-Overlay的网络访问流程图\"><a href=\"#2-Overlay的网络访问流程图\" class=\"headerlink\" title=\"2 Overlay的网络访问流程图\"></a>2 Overlay的网络访问流程图</h3><img src=\"/2021/07/06/01_%E8%BF%90%E7%BB%B4/03-Docker/Docker%E7%B3%BB%E5%88%97-%E4%B9%9D-Dokcer%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%AE%B9%E5%99%A8%E4%BA%92%E8%BF%9E/overlay%E7%BD%91%E7%BB%9C%E8%AE%BF%E9%97%AE.png\" class=\"\" title=\"overlay网络访问\">\n\n"},{"title":"Docker系列(二)-Docker常用管理命令","date":"2021-06-28T14:59:33.000Z","_content":"\n## 一、常用镜像管理命令\n\n>​\tDocker镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据，其内容在构建之后也不会被改变。\n\n### 1 在镜像仓库查找镜像\n\n```shell\ndocker search tomcat\n```\n\n### 2 在镜像仓库拉取镜像\n\n>不指定版本号时默认下载最新版（latest），版本可在dockerhub(官方仓库)、DaoCloud(私有仓库)等仓库查到\n\n```shell\n# dockerhub拉取\ndocker pull alpine:3.6\n# daocloud拉取\ndocker pull daocloud.io/jermine/alpine:latest\n```\n\n### 3 查看已有镜像\n\n```shell\ndocker image ls\n# 别名\ndocker images\n```\n\n### 4 导出镜像\n\n>弃用export，导出的镜像不带版本TAG信息\n\n```shell\ndocker image save alpine -o alpine.tar.gz\n```\n\n### 5 删除镜像\n\n```shell\n# 删除alpine镜像\ndocker image rm d4ff818577bc\n```\n\n### 6 导入镜像\n\n>弃用import，导入的镜像不带版本TAG信息\n\n```shell\ndocker image load -i alpine.tar.gz\n```\n\n### 7 查看镜像属性\n\n```shell\ndocker image inspect 4f380adfc10f\n```\n\n### 8 镜像批量删除\n\n```shell\ndocker image prune\n```\n\n### 9 指定TAG信息\n\n>docker images查看docker image import的镜像，没有镜像名和TAG，可以使用此方法来修改\n\n```sh\ndocker image tag d4ff818577bc oldbly\n```\n\n## 二、常用容器管理命令\n\n>​\t镜像(image)和容器(container)的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。\n>​\t容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间，甚至自己的用户ID空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立宿主的系统下操作一样。这种特性使容器封装的应用比直接在宿主运行更加安全。\n\n### 1 运行容器\n\n>1、docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。\n>\n>2、业务在容器中运行：前台运行夯住，启动服务\n>\n>3、如果不指定执行命令，会运行默认的执行命令\n\n```shell\n# 放后台运行\ndocker run -d -p 80:80 nginx:latest\nrun 创建并运行一个容器\n-d\t放在后台运行\n-p \t端口映射\n-v \t源地址(宿主机)：目标地址(容器)\n\n# 交互式方式进入容器执行\ndocker run -it --name centos6 centos:6.9 /bin/bash\n-it \t分配交互式的终端\n--name \t制定容器的名称\n/bin/sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖\n```\n\n### 2 查看已有容器\n\n>-a 显示所有容器（默认只显示running的容器）\n>\n>-l 显示最新的容器\n>\n>--no-trunc 显示完整id\n>\n>-q 静默输出（只显示容器id）\n\n```shell\ndocker container ls -a\n# 别名\ndocker ps -a\n```\n\n### 3 停止容器\n\n```shell\ndocker container stop 55e9c7c\n```\n\n### 4 杀死容器\n\n```shell\ndocker container kill 55e9c7c\n```\n\n>kill与stop的区别：\n>\n>- kill：不管容器同不同意，发送SIGKILL信号，强行终止。\n>\n>- stop：首先给容器发送一个SIGTERM信号，让容器做一些退出前必须的保护性、安全性操作，然后让容器自动停止运行，如果在一段时间内，容器还是没有停止，再发送SIGKILL信号，强行终止。\n\n### 5 启动容器\n\n```shell\ndocker container start 55e9c7c\n```\n\n### 6 进入容器（重要！调试、排错）\n\n使用同一终端：\n\n```shell\n# 交互式方式运行容器（开启新终端）\ndocker run -it --name centos6.9 centos:6.9 /bin/bash\n# 暂时退出当前终端\nctrl + p 再 ctrl + q\n# 重新进入该终端\ndocker attach d4ff818577bc\n```\n\n使用不同终端（常用）\n\n```shell\ndocker exec -it d4ff818577bc /bin/bash\n```\n\n### 7 删除容器\n\n```shell\ndocker container rm 55e9c7cb59a6 55e9c7cb59a5\n# 别名\ndocker rm 55e9c7cb59a6\n# 批量删除容器\ndocker rm `docker ps -a -q`\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-二-Docker常用管理命令.md","raw":"---\ntitle: Docker系列(二)-Docker常用管理命令\ndate: 2021-06-28 22:59:33\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、常用镜像管理命令\n\n>​\tDocker镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据，其内容在构建之后也不会被改变。\n\n### 1 在镜像仓库查找镜像\n\n```shell\ndocker search tomcat\n```\n\n### 2 在镜像仓库拉取镜像\n\n>不指定版本号时默认下载最新版（latest），版本可在dockerhub(官方仓库)、DaoCloud(私有仓库)等仓库查到\n\n```shell\n# dockerhub拉取\ndocker pull alpine:3.6\n# daocloud拉取\ndocker pull daocloud.io/jermine/alpine:latest\n```\n\n### 3 查看已有镜像\n\n```shell\ndocker image ls\n# 别名\ndocker images\n```\n\n### 4 导出镜像\n\n>弃用export，导出的镜像不带版本TAG信息\n\n```shell\ndocker image save alpine -o alpine.tar.gz\n```\n\n### 5 删除镜像\n\n```shell\n# 删除alpine镜像\ndocker image rm d4ff818577bc\n```\n\n### 6 导入镜像\n\n>弃用import，导入的镜像不带版本TAG信息\n\n```shell\ndocker image load -i alpine.tar.gz\n```\n\n### 7 查看镜像属性\n\n```shell\ndocker image inspect 4f380adfc10f\n```\n\n### 8 镜像批量删除\n\n```shell\ndocker image prune\n```\n\n### 9 指定TAG信息\n\n>docker images查看docker image import的镜像，没有镜像名和TAG，可以使用此方法来修改\n\n```sh\ndocker image tag d4ff818577bc oldbly\n```\n\n## 二、常用容器管理命令\n\n>​\t镜像(image)和容器(container)的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。\n>​\t容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间，甚至自己的用户ID空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立宿主的系统下操作一样。这种特性使容器封装的应用比直接在宿主运行更加安全。\n\n### 1 运行容器\n\n>1、docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。\n>\n>2、业务在容器中运行：前台运行夯住，启动服务\n>\n>3、如果不指定执行命令，会运行默认的执行命令\n\n```shell\n# 放后台运行\ndocker run -d -p 80:80 nginx:latest\nrun 创建并运行一个容器\n-d\t放在后台运行\n-p \t端口映射\n-v \t源地址(宿主机)：目标地址(容器)\n\n# 交互式方式进入容器执行\ndocker run -it --name centos6 centos:6.9 /bin/bash\n-it \t分配交互式的终端\n--name \t制定容器的名称\n/bin/sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖\n```\n\n### 2 查看已有容器\n\n>-a 显示所有容器（默认只显示running的容器）\n>\n>-l 显示最新的容器\n>\n>--no-trunc 显示完整id\n>\n>-q 静默输出（只显示容器id）\n\n```shell\ndocker container ls -a\n# 别名\ndocker ps -a\n```\n\n### 3 停止容器\n\n```shell\ndocker container stop 55e9c7c\n```\n\n### 4 杀死容器\n\n```shell\ndocker container kill 55e9c7c\n```\n\n>kill与stop的区别：\n>\n>- kill：不管容器同不同意，发送SIGKILL信号，强行终止。\n>\n>- stop：首先给容器发送一个SIGTERM信号，让容器做一些退出前必须的保护性、安全性操作，然后让容器自动停止运行，如果在一段时间内，容器还是没有停止，再发送SIGKILL信号，强行终止。\n\n### 5 启动容器\n\n```shell\ndocker container start 55e9c7c\n```\n\n### 6 进入容器（重要！调试、排错）\n\n使用同一终端：\n\n```shell\n# 交互式方式运行容器（开启新终端）\ndocker run -it --name centos6.9 centos:6.9 /bin/bash\n# 暂时退出当前终端\nctrl + p 再 ctrl + q\n# 重新进入该终端\ndocker attach d4ff818577bc\n```\n\n使用不同终端（常用）\n\n```shell\ndocker exec -it d4ff818577bc /bin/bash\n```\n\n### 7 删除容器\n\n```shell\ndocker container rm 55e9c7cb59a6 55e9c7cb59a5\n# 别名\ndocker rm 55e9c7cb59a6\n# 批量删除容器\ndocker rm `docker ps -a -q`\n```\n\n","slug":"01_运维/03-Docker/Docker系列-二-Docker常用管理命令","published":1,"updated":"2022-07-06T07:19:14.156Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0s001ja8v7hxma6lyk","content":"<h2 id=\"一、常用镜像管理命令\"><a href=\"#一、常用镜像管理命令\" class=\"headerlink\" title=\"一、常用镜像管理命令\"></a>一、常用镜像管理命令</h2><blockquote>\n<p>​\tDocker镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p>\n</blockquote>\n<h3 id=\"1-在镜像仓库查找镜像\"><a href=\"#1-在镜像仓库查找镜像\" class=\"headerlink\" title=\"1 在镜像仓库查找镜像\"></a>1 在镜像仓库查找镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker search tomcat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-在镜像仓库拉取镜像\"><a href=\"#2-在镜像仓库拉取镜像\" class=\"headerlink\" title=\"2 在镜像仓库拉取镜像\"></a>2 在镜像仓库拉取镜像</h3><blockquote>\n<p>不指定版本号时默认下载最新版（latest），版本可在dockerhub(官方仓库)、DaoCloud(私有仓库)等仓库查到</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># dockerhub拉取\ndocker pull alpine:3.6\n# daocloud拉取\ndocker pull daocloud.io&#x2F;jermine&#x2F;alpine:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-查看已有镜像\"><a href=\"#3-查看已有镜像\" class=\"headerlink\" title=\"3 查看已有镜像\"></a>3 查看已有镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image ls\n# 别名\ndocker images<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-导出镜像\"><a href=\"#4-导出镜像\" class=\"headerlink\" title=\"4 导出镜像\"></a>4 导出镜像</h3><blockquote>\n<p>弃用export，导出的镜像不带版本TAG信息</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image save alpine -o alpine.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"5-删除镜像\"><a href=\"#5-删除镜像\" class=\"headerlink\" title=\"5 删除镜像\"></a>5 删除镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 删除alpine镜像\ndocker image rm d4ff818577bc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-导入镜像\"><a href=\"#6-导入镜像\" class=\"headerlink\" title=\"6 导入镜像\"></a>6 导入镜像</h3><blockquote>\n<p>弃用import，导入的镜像不带版本TAG信息</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image load -i alpine.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-查看镜像属性\"><a href=\"#7-查看镜像属性\" class=\"headerlink\" title=\"7 查看镜像属性\"></a>7 查看镜像属性</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image inspect 4f380adfc10f<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"8-镜像批量删除\"><a href=\"#8-镜像批量删除\" class=\"headerlink\" title=\"8 镜像批量删除\"></a>8 镜像批量删除</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image prune<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"9-指定TAG信息\"><a href=\"#9-指定TAG信息\" class=\"headerlink\" title=\"9 指定TAG信息\"></a>9 指定TAG信息</h3><blockquote>\n<p>docker images查看docker image import的镜像，没有镜像名和TAG，可以使用此方法来修改</p>\n</blockquote>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">docker image tag d4ff818577bc oldbly<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、常用容器管理命令\"><a href=\"#二、常用容器管理命令\" class=\"headerlink\" title=\"二、常用容器管理命令\"></a>二、常用容器管理命令</h2><blockquote>\n<p>​\t镜像(image)和容器(container)的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。<br>​\t容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间，甚至自己的用户ID空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立宿主的系统下操作一样。这种特性使容器封装的应用比直接在宿主运行更加安全。</p>\n</blockquote>\n<h3 id=\"1-运行容器\"><a href=\"#1-运行容器\" class=\"headerlink\" title=\"1 运行容器\"></a>1 运行容器</h3><blockquote>\n<p>1、docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。</p>\n<p>2、业务在容器中运行：前台运行夯住，启动服务</p>\n<p>3、如果不指定执行命令，会运行默认的执行命令</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 放后台运行\ndocker run -d -p 80:80 nginx:latest\nrun 创建并运行一个容器\n-d\t放在后台运行\n-p \t端口映射\n-v \t源地址(宿主机)：目标地址(容器)\n\n# 交互式方式进入容器执行\ndocker run -it --name centos6 centos:6.9 &#x2F;bin&#x2F;bash\n-it \t分配交互式的终端\n--name \t制定容器的名称\n&#x2F;bin&#x2F;sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-查看已有容器\"><a href=\"#2-查看已有容器\" class=\"headerlink\" title=\"2 查看已有容器\"></a>2 查看已有容器</h3><blockquote>\n<p>-a 显示所有容器（默认只显示running的容器）</p>\n<p>-l 显示最新的容器</p>\n<p>–no-trunc 显示完整id</p>\n<p>-q 静默输出（只显示容器id）</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container ls -a\n# 别名\ndocker ps -a<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-停止容器\"><a href=\"#3-停止容器\" class=\"headerlink\" title=\"3 停止容器\"></a>3 停止容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container stop 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"4-杀死容器\"><a href=\"#4-杀死容器\" class=\"headerlink\" title=\"4 杀死容器\"></a>4 杀死容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container kill 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>kill与stop的区别：</p>\n<ul>\n<li><p>kill：不管容器同不同意，发送SIGKILL信号，强行终止。</p>\n</li>\n<li><p>stop：首先给容器发送一个SIGTERM信号，让容器做一些退出前必须的保护性、安全性操作，然后让容器自动停止运行，如果在一段时间内，容器还是没有停止，再发送SIGKILL信号，强行终止。</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"5-启动容器\"><a href=\"#5-启动容器\" class=\"headerlink\" title=\"5 启动容器\"></a>5 启动容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container start 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"6-进入容器（重要！调试、排错）\"><a href=\"#6-进入容器（重要！调试、排错）\" class=\"headerlink\" title=\"6 进入容器（重要！调试、排错）\"></a>6 进入容器（重要！调试、排错）</h3><p>使用同一终端：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 交互式方式运行容器（开启新终端）\ndocker run -it --name centos6.9 centos:6.9 &#x2F;bin&#x2F;bash\n# 暂时退出当前终端\nctrl + p 再 ctrl + q\n# 重新进入该终端\ndocker attach d4ff818577bc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用不同终端（常用）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it d4ff818577bc &#x2F;bin&#x2F;bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-删除容器\"><a href=\"#7-删除容器\" class=\"headerlink\" title=\"7 删除容器\"></a>7 删除容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container rm 55e9c7cb59a6 55e9c7cb59a5\n# 别名\ndocker rm 55e9c7cb59a6\n# 批量删除容器\ndocker rm &#96;docker ps -a -q&#96;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、常用镜像管理命令\"><a href=\"#一、常用镜像管理命令\" class=\"headerlink\" title=\"一、常用镜像管理命令\"></a>一、常用镜像管理命令</h2><blockquote>\n<p>​\tDocker镜像是一个特殊的文件系统，除了提供容器运行时所需的程序、库、资源、配置等文件外，还包含了一些为运行时准备的一些配置参数(如匿名卷、环境变量、用户等)。镜像不包含任何动态数据，其内容在构建之后也不会被改变。</p>\n</blockquote>\n<h3 id=\"1-在镜像仓库查找镜像\"><a href=\"#1-在镜像仓库查找镜像\" class=\"headerlink\" title=\"1 在镜像仓库查找镜像\"></a>1 在镜像仓库查找镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker search tomcat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-在镜像仓库拉取镜像\"><a href=\"#2-在镜像仓库拉取镜像\" class=\"headerlink\" title=\"2 在镜像仓库拉取镜像\"></a>2 在镜像仓库拉取镜像</h3><blockquote>\n<p>不指定版本号时默认下载最新版（latest），版本可在dockerhub(官方仓库)、DaoCloud(私有仓库)等仓库查到</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># dockerhub拉取\ndocker pull alpine:3.6\n# daocloud拉取\ndocker pull daocloud.io&#x2F;jermine&#x2F;alpine:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-查看已有镜像\"><a href=\"#3-查看已有镜像\" class=\"headerlink\" title=\"3 查看已有镜像\"></a>3 查看已有镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image ls\n# 别名\ndocker images<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"4-导出镜像\"><a href=\"#4-导出镜像\" class=\"headerlink\" title=\"4 导出镜像\"></a>4 导出镜像</h3><blockquote>\n<p>弃用export，导出的镜像不带版本TAG信息</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image save alpine -o alpine.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"5-删除镜像\"><a href=\"#5-删除镜像\" class=\"headerlink\" title=\"5 删除镜像\"></a>5 删除镜像</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 删除alpine镜像\ndocker image rm d4ff818577bc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"6-导入镜像\"><a href=\"#6-导入镜像\" class=\"headerlink\" title=\"6 导入镜像\"></a>6 导入镜像</h3><blockquote>\n<p>弃用import，导入的镜像不带版本TAG信息</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image load -i alpine.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-查看镜像属性\"><a href=\"#7-查看镜像属性\" class=\"headerlink\" title=\"7 查看镜像属性\"></a>7 查看镜像属性</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image inspect 4f380adfc10f<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"8-镜像批量删除\"><a href=\"#8-镜像批量删除\" class=\"headerlink\" title=\"8 镜像批量删除\"></a>8 镜像批量删除</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker image prune<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"9-指定TAG信息\"><a href=\"#9-指定TAG信息\" class=\"headerlink\" title=\"9 指定TAG信息\"></a>9 指定TAG信息</h3><blockquote>\n<p>docker images查看docker image import的镜像，没有镜像名和TAG，可以使用此方法来修改</p>\n</blockquote>\n<pre class=\"line-numbers language-sh\" data-language=\"sh\"><code class=\"language-sh\">docker image tag d4ff818577bc oldbly<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、常用容器管理命令\"><a href=\"#二、常用容器管理命令\" class=\"headerlink\" title=\"二、常用容器管理命令\"></a>二、常用容器管理命令</h2><blockquote>\n<p>​\t镜像(image)和容器(container)的关系，就像是面向对象程序设计中的类和实例一样，镜像是静态的定义，容器是镜像运行时的实体。容器可以被创建、启动、停止、删除、暂停等。<br>​\t容器的实质是进程，但与直接在宿主执行的进程不同，容器进程运行于属于自己的独立的命名空间。因此容器可以拥有自己的root文件系统、自己的网络配置、自己的进程空间，甚至自己的用户ID空间。容器内的进程是运行在一个隔离的环境里，使用起来，就好像是在一个独立宿主的系统下操作一样。这种特性使容器封装的应用比直接在宿主运行更加安全。</p>\n</blockquote>\n<h3 id=\"1-运行容器\"><a href=\"#1-运行容器\" class=\"headerlink\" title=\"1 运行容器\"></a>1 运行容器</h3><blockquote>\n<p>1、docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。</p>\n<p>2、业务在容器中运行：前台运行夯住，启动服务</p>\n<p>3、如果不指定执行命令，会运行默认的执行命令</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 放后台运行\ndocker run -d -p 80:80 nginx:latest\nrun 创建并运行一个容器\n-d\t放在后台运行\n-p \t端口映射\n-v \t源地址(宿主机)：目标地址(容器)\n\n# 交互式方式进入容器执行\ndocker run -it --name centos6 centos:6.9 &#x2F;bin&#x2F;bash\n-it \t分配交互式的终端\n--name \t制定容器的名称\n&#x2F;bin&#x2F;sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-查看已有容器\"><a href=\"#2-查看已有容器\" class=\"headerlink\" title=\"2 查看已有容器\"></a>2 查看已有容器</h3><blockquote>\n<p>-a 显示所有容器（默认只显示running的容器）</p>\n<p>-l 显示最新的容器</p>\n<p>–no-trunc 显示完整id</p>\n<p>-q 静默输出（只显示容器id）</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container ls -a\n# 别名\ndocker ps -a<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-停止容器\"><a href=\"#3-停止容器\" class=\"headerlink\" title=\"3 停止容器\"></a>3 停止容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container stop 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"4-杀死容器\"><a href=\"#4-杀死容器\" class=\"headerlink\" title=\"4 杀死容器\"></a>4 杀死容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container kill 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>kill与stop的区别：</p>\n<ul>\n<li><p>kill：不管容器同不同意，发送SIGKILL信号，强行终止。</p>\n</li>\n<li><p>stop：首先给容器发送一个SIGTERM信号，让容器做一些退出前必须的保护性、安全性操作，然后让容器自动停止运行，如果在一段时间内，容器还是没有停止，再发送SIGKILL信号，强行终止。</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"5-启动容器\"><a href=\"#5-启动容器\" class=\"headerlink\" title=\"5 启动容器\"></a>5 启动容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container start 55e9c7c<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"6-进入容器（重要！调试、排错）\"><a href=\"#6-进入容器（重要！调试、排错）\" class=\"headerlink\" title=\"6 进入容器（重要！调试、排错）\"></a>6 进入容器（重要！调试、排错）</h3><p>使用同一终端：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 交互式方式运行容器（开启新终端）\ndocker run -it --name centos6.9 centos:6.9 &#x2F;bin&#x2F;bash\n# 暂时退出当前终端\nctrl + p 再 ctrl + q\n# 重新进入该终端\ndocker attach d4ff818577bc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>使用不同终端（常用）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it d4ff818577bc &#x2F;bin&#x2F;bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"7-删除容器\"><a href=\"#7-删除容器\" class=\"headerlink\" title=\"7 删除容器\"></a>7 删除容器</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container rm 55e9c7cb59a6 55e9c7cb59a5\n# 别名\ndocker rm 55e9c7cb59a6\n# 批量删除容器\ndocker rm &#96;docker ps -a -q&#96;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"Docker系列(六)-Dockfile的使用","date":"2021-06-30T00:43:52.000Z","_content":"\n## 一、Dokerfile简介\n\n>Dockerfile 是一个用来自动构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。\n>\n>建议存放在/opt/dockerfile中，如创建centosXX的镜像，则创建/opt/dockerfile/centosXX/Dockerfile\n\n### 1 Dockerfile的简单使用\n\n>创建一个开启sshd服务的centos6.9镜像\n\n创建yum源文件，用于拷贝到centos6.9镜像中\n\n```shell\ncd /opt/dockfile/centos6.9_ssh\nvim CentOS-Base.repo\n...内容省略\n```\n\n创建Dockerfile文件/opt/dockfile/centos6.9_ssh/Dockerfile，内容如下：\n\n```dockerfile\nFROM centos:6.9\nADD CentOS-Base.repo /etc/yum.repos.d\nRUN yum install openssh-server -y\nRUN service sshd restart\nRUN echo '123456' | passwd --stdin root\nCMD [\"/usr/sbin/sshd\",\"-D\"]\n```\n\n>PS：RUN的执行过程：创建临时容器，执行命令，提交成临时镜像，删除临时容器，重复此步骤。\n\n构建镜像\n\n```shell\ndocker build -t centos6.9_ssh:v2 /opt/dockfile/centos6.9_ssh\n```\n\n>PS：最后传入的是包含Dockerfile的文件夹，区分大小写，可以用\".\"代替 \n\n验证镜像是否正常\n\n```shell\ndocker run -d -p 1022:22 centos6.9_ssh:v2\n```\n\n>PS：最后不用接命令，将自动执行CMD指定的命令\n\n### 2 小案例\n\n>创建centos6.9 + ssh + nginx的Dockerfile\n\n```shell\n[root@docker01 centos6.9_ssh_nginx]# pwd\n/opt/dockfile/centos6.9_ssh_nginx\n[root@docker01 centos6.9_ssh_nginx]# ls\nCentOS-Base.repo  Dockerfile  epel.repo  init.sh\n```\n\n```shell\n# init.sh\n#!/bin/bash\nservice sshd restart\nnginx -g \"daemon off;\"\n```\n\n编写Dockerfile\n\n```shell\nFROM centos:6.9\nADD CentOS-Base.repo /etc/yum.repos.d\nADD epel.repo /etc/yum.repos.d\nADD init.sh /root\nRUN yum install openssh-server nginx -y\nRUN echo '123456' | passwd --stdin root\nCMD [\"/bin/bash\",\"/root/init.sh\"]\n```\n\n构建镜像\n\n```she\ndocker build -t centos6.9_ssh_nginx:v3 .\n```\n\n测试使用\n\n```shell\ndocker run -d -p 1022:22 -p 81:80 centos6.9_ssh_nginx:v3\n```\n\n## 二、Docker指令\n\n| 命令       | 说明                                                         |\n| :--------- | :----------------------------------------------------------- |\n| FROM       | 基于那个镜像来构建                                           |\n| MAINTAINER | 镜像的创建者                                                 |\n| ENV        | 设置环境变量                                                 |\n| ADD        | 添加宿主机文件到容器里，有需要解压的文件会自动解压           |\n| COPY       | 添加宿主机文件到容器里                                       |\n| WORKDIR    | 切换工作目录                                                 |\n| EXPOSE     | 开放可用端口                                                 |\n| CMD        | 容器启动后执行的命令，可被docker run指定的命令覆盖           |\n| ENTRYPOINT | 容器启动后执行的命令，但不回被docker run指定的命令覆盖，如需覆盖，需要加--entrypoint参数 |\n| VOLUME     | 创建挂载卷，将宿主机的目录挂载到容器里                       |\n\n## 三、案例：Dockerfile构建可道云容器\n\n>项目：\n>\n>​\t可道云网盘kodexplorer\n>\n>环境：\n>\n>​\thttpd+php或者nginx+php\n>​\tphp所需模块：php5.5以上\n>​\t基础镜像：centos:7.9\n>​\t项目下载地址: http://static.kodcloud.com/update/download/kodexplorer4.37.zip\n>​\t项目官网：https://kodcloud.com/download/\n\n### 1 手工部署一遍\n\n>写Dockerfile前自己手动部署一遍，主要是nginx + php的搭建，参考博客\n>\n>https://cloud.tencent.com/developer/article/1015237\n\n修改nginx.conf\n\n```shell\n# For more information on configuration, see:\n#   * Official English Documentation: http://nginx.org/en/docs/\n#   * Official Russian Documentation: http://nginx.org/ru/docs/\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\n# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 4096;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80;\n        listen       [::]:80;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        error_page 404 /404.html;\n        location = /404.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n    \tlocation ~ \\.php$ {\n        try_files $uri =404;\n        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n    \t}\n\t\n    \tlocation / {\n        index  index.php index.html index.htm;\n        try_files $uri $uri/ /index.php?$args;\n    \t}\n    }\n\n# Settings for a TLS enabled server.\n#\n#    server {\n#        listen       443 ssl http2;\n#        listen       [::]:443 ssl http2;\n#        server_name  _;\n#        root         /usr/share/nginx/html;\n#\n#        ssl_certificate \"/etc/pki/nginx/server.crt\";\n#        ssl_certificate_key \"/etc/pki/nginx/private/server.key\";\n#        ssl_session_cache shared:SSL:1m;\n#        ssl_session_timeout  10m;\n#        ssl_ciphers HIGH:!aNULL:!MD5;\n#        ssl_prefer_server_ciphers on;\n#\n#        # Load configuration files for the default server block.\n#        include /etc/nginx/default.d/*.conf;\n#\n#        error_page 404 /404.html;\n#            location = /40x.html {\n#        }\n#\n#        error_page 500 502 503 504 /50x.html;\n#            location = /50x.html {\n#        }\n#    }\n\n}\n```\n\n修改php-fpm.conf\n\n```shell\n;;;;;;;;;;;;;;;;;;;;;\n; FPM Configuration ;\n;;;;;;;;;;;;;;;;;;;;;\n\n; All relative paths in this configuration file are relative to PHP's install\n; prefix.\n\n; Include one or more files. If glob(3) exists, it is used to include a bunch of\n; files from a glob(3) pattern. This directive can be used everywhere in the\n; file.\ninclude=/etc/php-fpm.d/*.conf\n\n;;;;;;;;;;;;;;;;;;\n; Global Options ;\n;;;;;;;;;;;;;;;;;;\n\n[global]\n; Pid file\n; Default Value: none\npid = /run/php-fpm/php-fpm.pid\n\n; Error log file\n; Default Value: /var/log/php-fpm.log\nerror_log = /var/log/php-fpm/error.log\n\n; Log level\n; Possible Values: alert, error, warning, notice, debug\n; Default Value: notice\n;log_level = notice\n\n; If this number of child processes exit with SIGSEGV or SIGBUS within the time\n; interval set by emergency_restart_interval then FPM will restart. A value\n; of '0' means 'Off'.\n; Default Value: 0\n;emergency_restart_threshold = 0\n\n; Interval of time used by emergency_restart_interval to determine when \n; a graceful restart will be initiated.  This can be useful to work around\n; accidental corruptions in an accelerator's shared memory.\n; Available Units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;emergency_restart_interval = 0\n\n; Time limit for child processes to wait for a reaction on signals from master.\n; Available units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;process_control_timeout = 0\n\n; Send FPM to background. Set to 'no' to keep FPM in foreground for debugging.\n; Default Value: yes\ndaemonize = no\n\n;;;;;;;;;;;;;;;;;;;;\n; Pool Definitions ; \n;;;;;;;;;;;;;;;;;;;;\n\n; See /etc/php-fpm.d/*.conf\n```\n\n修改www.conf\n\n```shell\n# 12行\nlisten = /var/run/php-fpm/php-fpm.sock\n# 31-32行\nlisten.owner = nobody\nlisten.group = nobody\n# 39-41行\nuser = nginx\n; RPM: Keep a group allowed to write in log dir.\ngroup = nginx\n```\n\n修改php.ini\n\n```shell\ncgi.fix_pathinfo 把它的值设置为 0\n```\n\n### 2 Dockerfile部署\n\n文件存放\n\n```shell\n[root@docker01 centos7.9_kod]# ll\ntotal 92\n-rw-r--r--. 1 root root   661 Jul  2 11:21 Dockerfile\n-rw-r--r--. 1 root root   171 Jul  1 14:28 init.sh\n-rw-r--r--. 1 root root  2715 Jul  1 13:50 nginx.conf\n-rw-r--r--. 1 root root  1691 Jul  1 13:50 php-fpm.conf\n-rw-r--r--. 1 root root 64945 Jul  1 14:48 php.ini\n-rw-r--r--. 1 root root 10029 Jul  1 13:50 www.conf\n[root@docker01 centos7.9_kod]# pwd\n/opt/dockfile/centos7.9_kod\n```\n\n编写Dockerfile\n\n```dockerfile\nFROM centos:7.9.2009\nRUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo && \\\ncurl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo && \\\nyum install openssh-server nginx net-tools php-cli php-fpm unzip php-gd php-mbstring  -y\nADD nginx.conf /etc/nginx/nginx.conf\nADD php-fpm.conf /etc/php-fpm.conf\nADD www.conf /etc/php-fpm.d/www.conf\nADD php.ini /etc\nADD init.sh /root/\nEXPOSE 80 22\nWORKDIR /usr/share/nginx/html\nRUN curl -o kod.zip https://static.kodcloud.com/update/download/kodexplorer4.45.zip && \\\nunzip kod.zip && \\\nchmod -R 777 /usr/share/nginx/html/\nCMD [\"/bin/bash\",\"/root/init.sh\"]\n```\n\n构建镜像\n\n```shell\ndocker build -t centos7.9_kod:v1 .\n```\n\n运行容器\n\n```shell\ndocker run -d -p 80:80 -p 1022:22 -e \"SSH_PWD=redhat123\" --privileged centos7.9_kod:v1 /usr/sbin/init\n```\n\n进入容器，并运行初始化命令\n\n```shell\ndocker exec -it 865 /bin/bash\n# 容器启动服务，设置root密码\n[root@88179198e672 html]#systemctl restart sshd php-fpm nginx\n[root@88179198e672 html]#echo \"redhat123\" | passwd --stdin root\n```\n\n测试访问：\n\n```shell\n网页访问：http://10.0.0.11可进去可道云界面\nssh 10.0.0.11 -p1022 可以登录镜像\n```\n\n\n\n\n\n","source":"_posts/01_运维/03-Docker/Docker系列-六-Dockfile的使用.md","raw":"---\ntitle: Docker系列(六)-Dockfile的使用\ndate: 2021-06-30 08:43:52\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、Dokerfile简介\n\n>Dockerfile 是一个用来自动构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。\n>\n>建议存放在/opt/dockerfile中，如创建centosXX的镜像，则创建/opt/dockerfile/centosXX/Dockerfile\n\n### 1 Dockerfile的简单使用\n\n>创建一个开启sshd服务的centos6.9镜像\n\n创建yum源文件，用于拷贝到centos6.9镜像中\n\n```shell\ncd /opt/dockfile/centos6.9_ssh\nvim CentOS-Base.repo\n...内容省略\n```\n\n创建Dockerfile文件/opt/dockfile/centos6.9_ssh/Dockerfile，内容如下：\n\n```dockerfile\nFROM centos:6.9\nADD CentOS-Base.repo /etc/yum.repos.d\nRUN yum install openssh-server -y\nRUN service sshd restart\nRUN echo '123456' | passwd --stdin root\nCMD [\"/usr/sbin/sshd\",\"-D\"]\n```\n\n>PS：RUN的执行过程：创建临时容器，执行命令，提交成临时镜像，删除临时容器，重复此步骤。\n\n构建镜像\n\n```shell\ndocker build -t centos6.9_ssh:v2 /opt/dockfile/centos6.9_ssh\n```\n\n>PS：最后传入的是包含Dockerfile的文件夹，区分大小写，可以用\".\"代替 \n\n验证镜像是否正常\n\n```shell\ndocker run -d -p 1022:22 centos6.9_ssh:v2\n```\n\n>PS：最后不用接命令，将自动执行CMD指定的命令\n\n### 2 小案例\n\n>创建centos6.9 + ssh + nginx的Dockerfile\n\n```shell\n[root@docker01 centos6.9_ssh_nginx]# pwd\n/opt/dockfile/centos6.9_ssh_nginx\n[root@docker01 centos6.9_ssh_nginx]# ls\nCentOS-Base.repo  Dockerfile  epel.repo  init.sh\n```\n\n```shell\n# init.sh\n#!/bin/bash\nservice sshd restart\nnginx -g \"daemon off;\"\n```\n\n编写Dockerfile\n\n```shell\nFROM centos:6.9\nADD CentOS-Base.repo /etc/yum.repos.d\nADD epel.repo /etc/yum.repos.d\nADD init.sh /root\nRUN yum install openssh-server nginx -y\nRUN echo '123456' | passwd --stdin root\nCMD [\"/bin/bash\",\"/root/init.sh\"]\n```\n\n构建镜像\n\n```she\ndocker build -t centos6.9_ssh_nginx:v3 .\n```\n\n测试使用\n\n```shell\ndocker run -d -p 1022:22 -p 81:80 centos6.9_ssh_nginx:v3\n```\n\n## 二、Docker指令\n\n| 命令       | 说明                                                         |\n| :--------- | :----------------------------------------------------------- |\n| FROM       | 基于那个镜像来构建                                           |\n| MAINTAINER | 镜像的创建者                                                 |\n| ENV        | 设置环境变量                                                 |\n| ADD        | 添加宿主机文件到容器里，有需要解压的文件会自动解压           |\n| COPY       | 添加宿主机文件到容器里                                       |\n| WORKDIR    | 切换工作目录                                                 |\n| EXPOSE     | 开放可用端口                                                 |\n| CMD        | 容器启动后执行的命令，可被docker run指定的命令覆盖           |\n| ENTRYPOINT | 容器启动后执行的命令，但不回被docker run指定的命令覆盖，如需覆盖，需要加--entrypoint参数 |\n| VOLUME     | 创建挂载卷，将宿主机的目录挂载到容器里                       |\n\n## 三、案例：Dockerfile构建可道云容器\n\n>项目：\n>\n>​\t可道云网盘kodexplorer\n>\n>环境：\n>\n>​\thttpd+php或者nginx+php\n>​\tphp所需模块：php5.5以上\n>​\t基础镜像：centos:7.9\n>​\t项目下载地址: http://static.kodcloud.com/update/download/kodexplorer4.37.zip\n>​\t项目官网：https://kodcloud.com/download/\n\n### 1 手工部署一遍\n\n>写Dockerfile前自己手动部署一遍，主要是nginx + php的搭建，参考博客\n>\n>https://cloud.tencent.com/developer/article/1015237\n\n修改nginx.conf\n\n```shell\n# For more information on configuration, see:\n#   * Official English Documentation: http://nginx.org/en/docs/\n#   * Official Russian Documentation: http://nginx.org/ru/docs/\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\n# Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.\ninclude /usr/share/nginx/modules/*.conf;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 4096;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80;\n        listen       [::]:80;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        error_page 404 /404.html;\n        location = /404.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n        }\n\n    \tlocation ~ \\.php$ {\n        try_files $uri =404;\n        fastcgi_pass unix:/var/run/php-fpm/php-fpm.sock;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n    \t}\n\t\n    \tlocation / {\n        index  index.php index.html index.htm;\n        try_files $uri $uri/ /index.php?$args;\n    \t}\n    }\n\n# Settings for a TLS enabled server.\n#\n#    server {\n#        listen       443 ssl http2;\n#        listen       [::]:443 ssl http2;\n#        server_name  _;\n#        root         /usr/share/nginx/html;\n#\n#        ssl_certificate \"/etc/pki/nginx/server.crt\";\n#        ssl_certificate_key \"/etc/pki/nginx/private/server.key\";\n#        ssl_session_cache shared:SSL:1m;\n#        ssl_session_timeout  10m;\n#        ssl_ciphers HIGH:!aNULL:!MD5;\n#        ssl_prefer_server_ciphers on;\n#\n#        # Load configuration files for the default server block.\n#        include /etc/nginx/default.d/*.conf;\n#\n#        error_page 404 /404.html;\n#            location = /40x.html {\n#        }\n#\n#        error_page 500 502 503 504 /50x.html;\n#            location = /50x.html {\n#        }\n#    }\n\n}\n```\n\n修改php-fpm.conf\n\n```shell\n;;;;;;;;;;;;;;;;;;;;;\n; FPM Configuration ;\n;;;;;;;;;;;;;;;;;;;;;\n\n; All relative paths in this configuration file are relative to PHP's install\n; prefix.\n\n; Include one or more files. If glob(3) exists, it is used to include a bunch of\n; files from a glob(3) pattern. This directive can be used everywhere in the\n; file.\ninclude=/etc/php-fpm.d/*.conf\n\n;;;;;;;;;;;;;;;;;;\n; Global Options ;\n;;;;;;;;;;;;;;;;;;\n\n[global]\n; Pid file\n; Default Value: none\npid = /run/php-fpm/php-fpm.pid\n\n; Error log file\n; Default Value: /var/log/php-fpm.log\nerror_log = /var/log/php-fpm/error.log\n\n; Log level\n; Possible Values: alert, error, warning, notice, debug\n; Default Value: notice\n;log_level = notice\n\n; If this number of child processes exit with SIGSEGV or SIGBUS within the time\n; interval set by emergency_restart_interval then FPM will restart. A value\n; of '0' means 'Off'.\n; Default Value: 0\n;emergency_restart_threshold = 0\n\n; Interval of time used by emergency_restart_interval to determine when \n; a graceful restart will be initiated.  This can be useful to work around\n; accidental corruptions in an accelerator's shared memory.\n; Available Units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;emergency_restart_interval = 0\n\n; Time limit for child processes to wait for a reaction on signals from master.\n; Available units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;process_control_timeout = 0\n\n; Send FPM to background. Set to 'no' to keep FPM in foreground for debugging.\n; Default Value: yes\ndaemonize = no\n\n;;;;;;;;;;;;;;;;;;;;\n; Pool Definitions ; \n;;;;;;;;;;;;;;;;;;;;\n\n; See /etc/php-fpm.d/*.conf\n```\n\n修改www.conf\n\n```shell\n# 12行\nlisten = /var/run/php-fpm/php-fpm.sock\n# 31-32行\nlisten.owner = nobody\nlisten.group = nobody\n# 39-41行\nuser = nginx\n; RPM: Keep a group allowed to write in log dir.\ngroup = nginx\n```\n\n修改php.ini\n\n```shell\ncgi.fix_pathinfo 把它的值设置为 0\n```\n\n### 2 Dockerfile部署\n\n文件存放\n\n```shell\n[root@docker01 centos7.9_kod]# ll\ntotal 92\n-rw-r--r--. 1 root root   661 Jul  2 11:21 Dockerfile\n-rw-r--r--. 1 root root   171 Jul  1 14:28 init.sh\n-rw-r--r--. 1 root root  2715 Jul  1 13:50 nginx.conf\n-rw-r--r--. 1 root root  1691 Jul  1 13:50 php-fpm.conf\n-rw-r--r--. 1 root root 64945 Jul  1 14:48 php.ini\n-rw-r--r--. 1 root root 10029 Jul  1 13:50 www.conf\n[root@docker01 centos7.9_kod]# pwd\n/opt/dockfile/centos7.9_kod\n```\n\n编写Dockerfile\n\n```dockerfile\nFROM centos:7.9.2009\nRUN curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo && \\\ncurl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo && \\\nyum install openssh-server nginx net-tools php-cli php-fpm unzip php-gd php-mbstring  -y\nADD nginx.conf /etc/nginx/nginx.conf\nADD php-fpm.conf /etc/php-fpm.conf\nADD www.conf /etc/php-fpm.d/www.conf\nADD php.ini /etc\nADD init.sh /root/\nEXPOSE 80 22\nWORKDIR /usr/share/nginx/html\nRUN curl -o kod.zip https://static.kodcloud.com/update/download/kodexplorer4.45.zip && \\\nunzip kod.zip && \\\nchmod -R 777 /usr/share/nginx/html/\nCMD [\"/bin/bash\",\"/root/init.sh\"]\n```\n\n构建镜像\n\n```shell\ndocker build -t centos7.9_kod:v1 .\n```\n\n运行容器\n\n```shell\ndocker run -d -p 80:80 -p 1022:22 -e \"SSH_PWD=redhat123\" --privileged centos7.9_kod:v1 /usr/sbin/init\n```\n\n进入容器，并运行初始化命令\n\n```shell\ndocker exec -it 865 /bin/bash\n# 容器启动服务，设置root密码\n[root@88179198e672 html]#systemctl restart sshd php-fpm nginx\n[root@88179198e672 html]#echo \"redhat123\" | passwd --stdin root\n```\n\n测试访问：\n\n```shell\n网页访问：http://10.0.0.11可进去可道云界面\nssh 10.0.0.11 -p1022 可以登录镜像\n```\n\n\n\n\n\n","slug":"01_运维/03-Docker/Docker系列-六-Dockfile的使用","published":1,"updated":"2022-07-06T07:19:30.843Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0t001ka8v71iuvbxd1","content":"<h2 id=\"一、Dokerfile简介\"><a href=\"#一、Dokerfile简介\" class=\"headerlink\" title=\"一、Dokerfile简介\"></a>一、Dokerfile简介</h2><blockquote>\n<p>Dockerfile 是一个用来自动构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p>\n<p>建议存放在&#x2F;opt&#x2F;dockerfile中，如创建centosXX的镜像，则创建&#x2F;opt&#x2F;dockerfile&#x2F;centosXX&#x2F;Dockerfile</p>\n</blockquote>\n<h3 id=\"1-Dockerfile的简单使用\"><a href=\"#1-Dockerfile的简单使用\" class=\"headerlink\" title=\"1 Dockerfile的简单使用\"></a>1 Dockerfile的简单使用</h3><blockquote>\n<p>创建一个开启sshd服务的centos6.9镜像</p>\n</blockquote>\n<p>创建yum源文件，用于拷贝到centos6.9镜像中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd &#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh\nvim CentOS-Base.repo\n...内容省略<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建Dockerfile文件&#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh&#x2F;Dockerfile，内容如下：</p>\n<pre class=\"line-numbers language-dockerfile\" data-language=\"dockerfile\"><code class=\"language-dockerfile\">FROM centos:6.9\nADD CentOS-Base.repo &#x2F;etc&#x2F;yum.repos.d\nRUN yum install openssh-server -y\nRUN service sshd restart\nRUN echo &#39;123456&#39; | passwd --stdin root\nCMD [&quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,&quot;-D&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：RUN的执行过程：创建临时容器，执行命令，提交成临时镜像，删除临时容器，重复此步骤。</p>\n</blockquote>\n<p>构建镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker build -t centos6.9_ssh:v2 &#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：最后传入的是包含Dockerfile的文件夹，区分大小写，可以用”.”代替 </p>\n</blockquote>\n<p>验证镜像是否正常</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：最后不用接命令，将自动执行CMD指定的命令</p>\n</blockquote>\n<h3 id=\"2-小案例\"><a href=\"#2-小案例\" class=\"headerlink\" title=\"2 小案例\"></a>2 小案例</h3><blockquote>\n<p>创建centos6.9 + ssh + nginx的Dockerfile</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 centos6.9_ssh_nginx]# pwd\n&#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh_nginx\n[root@docker01 centos6.9_ssh_nginx]# ls\nCentOS-Base.repo  Dockerfile  epel.repo  init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># init.sh\n#!&#x2F;bin&#x2F;bash\nservice sshd restart\nnginx -g &quot;daemon off;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编写Dockerfile</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">FROM centos:6.9\nADD CentOS-Base.repo &#x2F;etc&#x2F;yum.repos.d\nADD epel.repo &#x2F;etc&#x2F;yum.repos.d\nADD init.sh &#x2F;root\nRUN yum install openssh-server nginx -y\nRUN echo &#39;123456&#39; | passwd --stdin root\nCMD [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;root&#x2F;init.sh&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建镜像</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker build -t centos6.9_ssh_nginx:v3 .<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 -p 81:80 centos6.9_ssh_nginx:v3<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、Docker指令\"><a href=\"#二、Docker指令\" class=\"headerlink\" title=\"二、Docker指令\"></a>二、Docker指令</h2><table>\n<thead>\n<tr>\n<th align=\"left\">命令</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">FROM</td>\n<td align=\"left\">基于那个镜像来构建</td>\n</tr>\n<tr>\n<td align=\"left\">MAINTAINER</td>\n<td align=\"left\">镜像的创建者</td>\n</tr>\n<tr>\n<td align=\"left\">ENV</td>\n<td align=\"left\">设置环境变量</td>\n</tr>\n<tr>\n<td align=\"left\">ADD</td>\n<td align=\"left\">添加宿主机文件到容器里，有需要解压的文件会自动解压</td>\n</tr>\n<tr>\n<td align=\"left\">COPY</td>\n<td align=\"left\">添加宿主机文件到容器里</td>\n</tr>\n<tr>\n<td align=\"left\">WORKDIR</td>\n<td align=\"left\">切换工作目录</td>\n</tr>\n<tr>\n<td align=\"left\">EXPOSE</td>\n<td align=\"left\">开放可用端口</td>\n</tr>\n<tr>\n<td align=\"left\">CMD</td>\n<td align=\"left\">容器启动后执行的命令，可被docker run指定的命令覆盖</td>\n</tr>\n<tr>\n<td align=\"left\">ENTRYPOINT</td>\n<td align=\"left\">容器启动后执行的命令，但不回被docker run指定的命令覆盖，如需覆盖，需要加–entrypoint参数</td>\n</tr>\n<tr>\n<td align=\"left\">VOLUME</td>\n<td align=\"left\">创建挂载卷，将宿主机的目录挂载到容器里</td>\n</tr>\n</tbody></table>\n<h2 id=\"三、案例：Dockerfile构建可道云容器\"><a href=\"#三、案例：Dockerfile构建可道云容器\" class=\"headerlink\" title=\"三、案例：Dockerfile构建可道云容器\"></a>三、案例：Dockerfile构建可道云容器</h2><blockquote>\n<p>项目：</p>\n<p>​\t可道云网盘kodexplorer</p>\n<p>环境：</p>\n<p>​\thttpd+php或者nginx+php<br>​\tphp所需模块：php5.5以上<br>​\t基础镜像：centos:7.9<br>​\t项目下载地址: <a href=\"http://static.kodcloud.com/update/download/kodexplorer4.37.zip\">http://static.kodcloud.com/update/download/kodexplorer4.37.zip</a><br>​\t项目官网：<a href=\"https://kodcloud.com/download/\">https://kodcloud.com/download/</a></p>\n</blockquote>\n<h3 id=\"1-手工部署一遍\"><a href=\"#1-手工部署一遍\" class=\"headerlink\" title=\"1 手工部署一遍\"></a>1 手工部署一遍</h3><blockquote>\n<p>写Dockerfile前自己手动部署一遍，主要是nginx + php的搭建，参考博客</p>\n<p><a href=\"https://cloud.tencent.com/developer/article/1015237\">https://cloud.tencent.com/developer/article/1015237</a></p>\n</blockquote>\n<p>修改nginx.conf</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># For more information on configuration, see:\n#   * Official English Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;\n#   * Official Russian Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;ru&#x2F;docs&#x2F;\n\nuser nginx;\nworker_processes auto;\nerror_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;\npid &#x2F;run&#x2F;nginx.pid;\n\n# Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx&#x2F;README.dynamic.\ninclude &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;\n\nevents &#123;\n    worker_connections 1024;\n&#125;\n\nhttp &#123;\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 4096;\n\n    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;\n    default_type        application&#x2F;octet-stream;\n\n    # Load modular configuration files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory.\n    # See http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;ngx_core_module.html#include\n    # for more information.\n    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;\n\n    server &#123;\n        listen       80;\n        listen       [::]:80;\n        server_name  _;\n        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n\n        # Load configuration files for the default server block.\n        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n\n        error_page 404 &#x2F;404.html;\n        location &#x3D; &#x2F;404.html &#123;\n        &#125;\n\n        error_page 500 502 503 504 &#x2F;50x.html;\n        location &#x3D; &#x2F;50x.html &#123;\n        &#125;\n\n    \tlocation ~ \\.php$ &#123;\n        try_files $uri &#x3D;404;\n        fastcgi_pass unix:&#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n    \t&#125;\n\t\n    \tlocation &#x2F; &#123;\n        index  index.php index.html index.htm;\n        try_files $uri $uri&#x2F; &#x2F;index.php?$args;\n    \t&#125;\n    &#125;\n\n# Settings for a TLS enabled server.\n#\n#    server &#123;\n#        listen       443 ssl http2;\n#        listen       [::]:443 ssl http2;\n#        server_name  _;\n#        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n#\n#        ssl_certificate &quot;&#x2F;etc&#x2F;pki&#x2F;nginx&#x2F;server.crt&quot;;\n#        ssl_certificate_key &quot;&#x2F;etc&#x2F;pki&#x2F;nginx&#x2F;private&#x2F;server.key&quot;;\n#        ssl_session_cache shared:SSL:1m;\n#        ssl_session_timeout  10m;\n#        ssl_ciphers HIGH:!aNULL:!MD5;\n#        ssl_prefer_server_ciphers on;\n#\n#        # Load configuration files for the default server block.\n#        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n#\n#        error_page 404 &#x2F;404.html;\n#            location &#x3D; &#x2F;40x.html &#123;\n#        &#125;\n#\n#        error_page 500 502 503 504 &#x2F;50x.html;\n#            location &#x3D; &#x2F;50x.html &#123;\n#        &#125;\n#    &#125;\n\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改php-fpm.conf</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">;;;;;;;;;;;;;;;;;;;;;\n; FPM Configuration ;\n;;;;;;;;;;;;;;;;;;;;;\n\n; All relative paths in this configuration file are relative to PHP&#39;s install\n; prefix.\n\n; Include one or more files. If glob(3) exists, it is used to include a bunch of\n; files from a glob(3) pattern. This directive can be used everywhere in the\n; file.\ninclude&#x3D;&#x2F;etc&#x2F;php-fpm.d&#x2F;*.conf\n\n;;;;;;;;;;;;;;;;;;\n; Global Options ;\n;;;;;;;;;;;;;;;;;;\n\n[global]\n; Pid file\n; Default Value: none\npid &#x3D; &#x2F;run&#x2F;php-fpm&#x2F;php-fpm.pid\n\n; Error log file\n; Default Value: &#x2F;var&#x2F;log&#x2F;php-fpm.log\nerror_log &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;error.log\n\n; Log level\n; Possible Values: alert, error, warning, notice, debug\n; Default Value: notice\n;log_level &#x3D; notice\n\n; If this number of child processes exit with SIGSEGV or SIGBUS within the time\n; interval set by emergency_restart_interval then FPM will restart. A value\n; of &#39;0&#39; means &#39;Off&#39;.\n; Default Value: 0\n;emergency_restart_threshold &#x3D; 0\n\n; Interval of time used by emergency_restart_interval to determine when \n; a graceful restart will be initiated.  This can be useful to work around\n; accidental corruptions in an accelerator&#39;s shared memory.\n; Available Units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;emergency_restart_interval &#x3D; 0\n\n; Time limit for child processes to wait for a reaction on signals from master.\n; Available units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;process_control_timeout &#x3D; 0\n\n; Send FPM to background. Set to &#39;no&#39; to keep FPM in foreground for debugging.\n; Default Value: yes\ndaemonize &#x3D; no\n\n;;;;;;;;;;;;;;;;;;;;\n; Pool Definitions ; \n;;;;;;;;;;;;;;;;;;;;\n\n; See &#x2F;etc&#x2F;php-fpm.d&#x2F;*.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改<a href=\"http://www.conf/\">www.conf</a></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 12行\nlisten &#x3D; &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock\n# 31-32行\nlisten.owner &#x3D; nobody\nlisten.group &#x3D; nobody\n# 39-41行\nuser &#x3D; nginx\n; RPM: Keep a group allowed to write in log dir.\ngroup &#x3D; nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改php.ini</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cgi.fix_pathinfo 把它的值设置为 0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-Dockerfile部署\"><a href=\"#2-Dockerfile部署\" class=\"headerlink\" title=\"2 Dockerfile部署\"></a>2 Dockerfile部署</h3><p>文件存放</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 centos7.9_kod]# ll\ntotal 92\n-rw-r--r--. 1 root root   661 Jul  2 11:21 Dockerfile\n-rw-r--r--. 1 root root   171 Jul  1 14:28 init.sh\n-rw-r--r--. 1 root root  2715 Jul  1 13:50 nginx.conf\n-rw-r--r--. 1 root root  1691 Jul  1 13:50 php-fpm.conf\n-rw-r--r--. 1 root root 64945 Jul  1 14:48 php.ini\n-rw-r--r--. 1 root root 10029 Jul  1 13:50 www.conf\n[root@docker01 centos7.9_kod]# pwd\n&#x2F;opt&#x2F;dockfile&#x2F;centos7.9_kod<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编写Dockerfile</p>\n<pre class=\"line-numbers language-dockerfile\" data-language=\"dockerfile\"><code class=\"language-dockerfile\">FROM centos:7.9.2009\nRUN curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo &amp;&amp; \\\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo &amp;&amp; \\\nyum install openssh-server nginx net-tools php-cli php-fpm unzip php-gd php-mbstring  -y\nADD nginx.conf &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\nADD php-fpm.conf &#x2F;etc&#x2F;php-fpm.conf\nADD www.conf &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf\nADD php.ini &#x2F;etc\nADD init.sh &#x2F;root&#x2F;\nEXPOSE 80 22\nWORKDIR &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html\nRUN curl -o kod.zip https:&#x2F;&#x2F;static.kodcloud.com&#x2F;update&#x2F;download&#x2F;kodexplorer4.45.zip &amp;&amp; \\\nunzip kod.zip &amp;&amp; \\\nchmod -R 777 &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;\nCMD [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;root&#x2F;init.sh&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker build -t centos7.9_kod:v1 .<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>运行容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 -p 1022:22 -e &quot;SSH_PWD&#x3D;redhat123&quot; --privileged centos7.9_kod:v1 &#x2F;usr&#x2F;sbin&#x2F;init<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>进入容器，并运行初始化命令</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it 865 &#x2F;bin&#x2F;bash\n# 容器启动服务，设置root密码\n[root@88179198e672 html]#systemctl restart sshd php-fpm nginx\n[root@88179198e672 html]#echo &quot;redhat123&quot; | passwd --stdin root<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试访问：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">网页访问：http:&#x2F;&#x2F;10.0.0.11可进去可道云界面\nssh 10.0.0.11 -p1022 可以登录镜像<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、Dokerfile简介\"><a href=\"#一、Dokerfile简介\" class=\"headerlink\" title=\"一、Dokerfile简介\"></a>一、Dokerfile简介</h2><blockquote>\n<p>Dockerfile 是一个用来自动构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p>\n<p>建议存放在&#x2F;opt&#x2F;dockerfile中，如创建centosXX的镜像，则创建&#x2F;opt&#x2F;dockerfile&#x2F;centosXX&#x2F;Dockerfile</p>\n</blockquote>\n<h3 id=\"1-Dockerfile的简单使用\"><a href=\"#1-Dockerfile的简单使用\" class=\"headerlink\" title=\"1 Dockerfile的简单使用\"></a>1 Dockerfile的简单使用</h3><blockquote>\n<p>创建一个开启sshd服务的centos6.9镜像</p>\n</blockquote>\n<p>创建yum源文件，用于拷贝到centos6.9镜像中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cd &#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh\nvim CentOS-Base.repo\n...内容省略<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>创建Dockerfile文件&#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh&#x2F;Dockerfile，内容如下：</p>\n<pre class=\"line-numbers language-dockerfile\" data-language=\"dockerfile\"><code class=\"language-dockerfile\">FROM centos:6.9\nADD CentOS-Base.repo &#x2F;etc&#x2F;yum.repos.d\nRUN yum install openssh-server -y\nRUN service sshd restart\nRUN echo &#39;123456&#39; | passwd --stdin root\nCMD [&quot;&#x2F;usr&#x2F;sbin&#x2F;sshd&quot;,&quot;-D&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：RUN的执行过程：创建临时容器，执行命令，提交成临时镜像，删除临时容器，重复此步骤。</p>\n</blockquote>\n<p>构建镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker build -t centos6.9_ssh:v2 &#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：最后传入的是包含Dockerfile的文件夹，区分大小写，可以用”.”代替 </p>\n</blockquote>\n<p>验证镜像是否正常</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：最后不用接命令，将自动执行CMD指定的命令</p>\n</blockquote>\n<h3 id=\"2-小案例\"><a href=\"#2-小案例\" class=\"headerlink\" title=\"2 小案例\"></a>2 小案例</h3><blockquote>\n<p>创建centos6.9 + ssh + nginx的Dockerfile</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 centos6.9_ssh_nginx]# pwd\n&#x2F;opt&#x2F;dockfile&#x2F;centos6.9_ssh_nginx\n[root@docker01 centos6.9_ssh_nginx]# ls\nCentOS-Base.repo  Dockerfile  epel.repo  init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># init.sh\n#!&#x2F;bin&#x2F;bash\nservice sshd restart\nnginx -g &quot;daemon off;&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编写Dockerfile</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">FROM centos:6.9\nADD CentOS-Base.repo &#x2F;etc&#x2F;yum.repos.d\nADD epel.repo &#x2F;etc&#x2F;yum.repos.d\nADD init.sh &#x2F;root\nRUN yum install openssh-server nginx -y\nRUN echo &#39;123456&#39; | passwd --stdin root\nCMD [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;root&#x2F;init.sh&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建镜像</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker build -t centos6.9_ssh_nginx:v3 .<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 -p 81:80 centos6.9_ssh_nginx:v3<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、Docker指令\"><a href=\"#二、Docker指令\" class=\"headerlink\" title=\"二、Docker指令\"></a>二、Docker指令</h2><table>\n<thead>\n<tr>\n<th align=\"left\">命令</th>\n<th align=\"left\">说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">FROM</td>\n<td align=\"left\">基于那个镜像来构建</td>\n</tr>\n<tr>\n<td align=\"left\">MAINTAINER</td>\n<td align=\"left\">镜像的创建者</td>\n</tr>\n<tr>\n<td align=\"left\">ENV</td>\n<td align=\"left\">设置环境变量</td>\n</tr>\n<tr>\n<td align=\"left\">ADD</td>\n<td align=\"left\">添加宿主机文件到容器里，有需要解压的文件会自动解压</td>\n</tr>\n<tr>\n<td align=\"left\">COPY</td>\n<td align=\"left\">添加宿主机文件到容器里</td>\n</tr>\n<tr>\n<td align=\"left\">WORKDIR</td>\n<td align=\"left\">切换工作目录</td>\n</tr>\n<tr>\n<td align=\"left\">EXPOSE</td>\n<td align=\"left\">开放可用端口</td>\n</tr>\n<tr>\n<td align=\"left\">CMD</td>\n<td align=\"left\">容器启动后执行的命令，可被docker run指定的命令覆盖</td>\n</tr>\n<tr>\n<td align=\"left\">ENTRYPOINT</td>\n<td align=\"left\">容器启动后执行的命令，但不回被docker run指定的命令覆盖，如需覆盖，需要加–entrypoint参数</td>\n</tr>\n<tr>\n<td align=\"left\">VOLUME</td>\n<td align=\"left\">创建挂载卷，将宿主机的目录挂载到容器里</td>\n</tr>\n</tbody></table>\n<h2 id=\"三、案例：Dockerfile构建可道云容器\"><a href=\"#三、案例：Dockerfile构建可道云容器\" class=\"headerlink\" title=\"三、案例：Dockerfile构建可道云容器\"></a>三、案例：Dockerfile构建可道云容器</h2><blockquote>\n<p>项目：</p>\n<p>​\t可道云网盘kodexplorer</p>\n<p>环境：</p>\n<p>​\thttpd+php或者nginx+php<br>​\tphp所需模块：php5.5以上<br>​\t基础镜像：centos:7.9<br>​\t项目下载地址: <a href=\"http://static.kodcloud.com/update/download/kodexplorer4.37.zip\">http://static.kodcloud.com/update/download/kodexplorer4.37.zip</a><br>​\t项目官网：<a href=\"https://kodcloud.com/download/\">https://kodcloud.com/download/</a></p>\n</blockquote>\n<h3 id=\"1-手工部署一遍\"><a href=\"#1-手工部署一遍\" class=\"headerlink\" title=\"1 手工部署一遍\"></a>1 手工部署一遍</h3><blockquote>\n<p>写Dockerfile前自己手动部署一遍，主要是nginx + php的搭建，参考博客</p>\n<p><a href=\"https://cloud.tencent.com/developer/article/1015237\">https://cloud.tencent.com/developer/article/1015237</a></p>\n</blockquote>\n<p>修改nginx.conf</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># For more information on configuration, see:\n#   * Official English Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;\n#   * Official Russian Documentation: http:&#x2F;&#x2F;nginx.org&#x2F;ru&#x2F;docs&#x2F;\n\nuser nginx;\nworker_processes auto;\nerror_log &#x2F;var&#x2F;log&#x2F;nginx&#x2F;error.log;\npid &#x2F;run&#x2F;nginx.pid;\n\n# Load dynamic modules. See &#x2F;usr&#x2F;share&#x2F;doc&#x2F;nginx&#x2F;README.dynamic.\ninclude &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;modules&#x2F;*.conf;\n\nevents &#123;\n    worker_connections 1024;\n&#125;\n\nhttp &#123;\n    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#39;\n                      &#39;$status $body_bytes_sent &quot;$http_referer&quot; &#39;\n                      &#39;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#39;;\n\n    access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 4096;\n\n    include             &#x2F;etc&#x2F;nginx&#x2F;mime.types;\n    default_type        application&#x2F;octet-stream;\n\n    # Load modular configuration files from the &#x2F;etc&#x2F;nginx&#x2F;conf.d directory.\n    # See http:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;docs&#x2F;ngx_core_module.html#include\n    # for more information.\n    include &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;*.conf;\n\n    server &#123;\n        listen       80;\n        listen       [::]:80;\n        server_name  _;\n        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n\n        # Load configuration files for the default server block.\n        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n\n        error_page 404 &#x2F;404.html;\n        location &#x3D; &#x2F;404.html &#123;\n        &#125;\n\n        error_page 500 502 503 504 &#x2F;50x.html;\n        location &#x3D; &#x2F;50x.html &#123;\n        &#125;\n\n    \tlocation ~ \\.php$ &#123;\n        try_files $uri &#x3D;404;\n        fastcgi_pass unix:&#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        include fastcgi_params;\n    \t&#125;\n\t\n    \tlocation &#x2F; &#123;\n        index  index.php index.html index.htm;\n        try_files $uri $uri&#x2F; &#x2F;index.php?$args;\n    \t&#125;\n    &#125;\n\n# Settings for a TLS enabled server.\n#\n#    server &#123;\n#        listen       443 ssl http2;\n#        listen       [::]:443 ssl http2;\n#        server_name  _;\n#        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;\n#\n#        ssl_certificate &quot;&#x2F;etc&#x2F;pki&#x2F;nginx&#x2F;server.crt&quot;;\n#        ssl_certificate_key &quot;&#x2F;etc&#x2F;pki&#x2F;nginx&#x2F;private&#x2F;server.key&quot;;\n#        ssl_session_cache shared:SSL:1m;\n#        ssl_session_timeout  10m;\n#        ssl_ciphers HIGH:!aNULL:!MD5;\n#        ssl_prefer_server_ciphers on;\n#\n#        # Load configuration files for the default server block.\n#        include &#x2F;etc&#x2F;nginx&#x2F;default.d&#x2F;*.conf;\n#\n#        error_page 404 &#x2F;404.html;\n#            location &#x3D; &#x2F;40x.html &#123;\n#        &#125;\n#\n#        error_page 500 502 503 504 &#x2F;50x.html;\n#            location &#x3D; &#x2F;50x.html &#123;\n#        &#125;\n#    &#125;\n\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改php-fpm.conf</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">;;;;;;;;;;;;;;;;;;;;;\n; FPM Configuration ;\n;;;;;;;;;;;;;;;;;;;;;\n\n; All relative paths in this configuration file are relative to PHP&#39;s install\n; prefix.\n\n; Include one or more files. If glob(3) exists, it is used to include a bunch of\n; files from a glob(3) pattern. This directive can be used everywhere in the\n; file.\ninclude&#x3D;&#x2F;etc&#x2F;php-fpm.d&#x2F;*.conf\n\n;;;;;;;;;;;;;;;;;;\n; Global Options ;\n;;;;;;;;;;;;;;;;;;\n\n[global]\n; Pid file\n; Default Value: none\npid &#x3D; &#x2F;run&#x2F;php-fpm&#x2F;php-fpm.pid\n\n; Error log file\n; Default Value: &#x2F;var&#x2F;log&#x2F;php-fpm.log\nerror_log &#x3D; &#x2F;var&#x2F;log&#x2F;php-fpm&#x2F;error.log\n\n; Log level\n; Possible Values: alert, error, warning, notice, debug\n; Default Value: notice\n;log_level &#x3D; notice\n\n; If this number of child processes exit with SIGSEGV or SIGBUS within the time\n; interval set by emergency_restart_interval then FPM will restart. A value\n; of &#39;0&#39; means &#39;Off&#39;.\n; Default Value: 0\n;emergency_restart_threshold &#x3D; 0\n\n; Interval of time used by emergency_restart_interval to determine when \n; a graceful restart will be initiated.  This can be useful to work around\n; accidental corruptions in an accelerator&#39;s shared memory.\n; Available Units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;emergency_restart_interval &#x3D; 0\n\n; Time limit for child processes to wait for a reaction on signals from master.\n; Available units: s(econds), m(inutes), h(ours), or d(ays)\n; Default Unit: seconds\n; Default Value: 0\n;process_control_timeout &#x3D; 0\n\n; Send FPM to background. Set to &#39;no&#39; to keep FPM in foreground for debugging.\n; Default Value: yes\ndaemonize &#x3D; no\n\n;;;;;;;;;;;;;;;;;;;;\n; Pool Definitions ; \n;;;;;;;;;;;;;;;;;;;;\n\n; See &#x2F;etc&#x2F;php-fpm.d&#x2F;*.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改<a href=\"http://www.conf/\">www.conf</a></p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 12行\nlisten &#x3D; &#x2F;var&#x2F;run&#x2F;php-fpm&#x2F;php-fpm.sock\n# 31-32行\nlisten.owner &#x3D; nobody\nlisten.group &#x3D; nobody\n# 39-41行\nuser &#x3D; nginx\n; RPM: Keep a group allowed to write in log dir.\ngroup &#x3D; nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>修改php.ini</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">cgi.fix_pathinfo 把它的值设置为 0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-Dockerfile部署\"><a href=\"#2-Dockerfile部署\" class=\"headerlink\" title=\"2 Dockerfile部署\"></a>2 Dockerfile部署</h3><p>文件存放</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">[root@docker01 centos7.9_kod]# ll\ntotal 92\n-rw-r--r--. 1 root root   661 Jul  2 11:21 Dockerfile\n-rw-r--r--. 1 root root   171 Jul  1 14:28 init.sh\n-rw-r--r--. 1 root root  2715 Jul  1 13:50 nginx.conf\n-rw-r--r--. 1 root root  1691 Jul  1 13:50 php-fpm.conf\n-rw-r--r--. 1 root root 64945 Jul  1 14:48 php.ini\n-rw-r--r--. 1 root root 10029 Jul  1 13:50 www.conf\n[root@docker01 centos7.9_kod]# pwd\n&#x2F;opt&#x2F;dockfile&#x2F;centos7.9_kod<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>编写Dockerfile</p>\n<pre class=\"line-numbers language-dockerfile\" data-language=\"dockerfile\"><code class=\"language-dockerfile\">FROM centos:7.9.2009\nRUN curl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-7.repo &amp;&amp; \\\ncurl -o &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo &amp;&amp; \\\nyum install openssh-server nginx net-tools php-cli php-fpm unzip php-gd php-mbstring  -y\nADD nginx.conf &#x2F;etc&#x2F;nginx&#x2F;nginx.conf\nADD php-fpm.conf &#x2F;etc&#x2F;php-fpm.conf\nADD www.conf &#x2F;etc&#x2F;php-fpm.d&#x2F;www.conf\nADD php.ini &#x2F;etc\nADD init.sh &#x2F;root&#x2F;\nEXPOSE 80 22\nWORKDIR &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html\nRUN curl -o kod.zip https:&#x2F;&#x2F;static.kodcloud.com&#x2F;update&#x2F;download&#x2F;kodexplorer4.45.zip &amp;&amp; \\\nunzip kod.zip &amp;&amp; \\\nchmod -R 777 &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;\nCMD [&quot;&#x2F;bin&#x2F;bash&quot;,&quot;&#x2F;root&#x2F;init.sh&quot;]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker build -t centos7.9_kod:v1 .<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>运行容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 -p 1022:22 -e &quot;SSH_PWD&#x3D;redhat123&quot; --privileged centos7.9_kod:v1 &#x2F;usr&#x2F;sbin&#x2F;init<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>进入容器，并运行初始化命令</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker exec -it 865 &#x2F;bin&#x2F;bash\n# 容器启动服务，设置root密码\n[root@88179198e672 html]#systemctl restart sshd php-fpm nginx\n[root@88179198e672 html]#echo &quot;redhat123&quot; | passwd --stdin root<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>测试访问：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">网页访问：http:&#x2F;&#x2F;10.0.0.11可进去可道云界面\nssh 10.0.0.11 -p1022 可以登录镜像<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n\n\n"},{"title":"Docker系列(五)-手动制作docker镜像","date":"2021-06-29T05:35:26.000Z","_content":"\n## 一、制作Docker镜像\n\n### 1 启动基础容器\n\n```she\ndocker run -it centos:6.9 # yum\ndocker run -it alpine:3.9 # apk\n```\n\n### 2 在容器中安装服务\n\n修改yum源（Centos6阿里源已停止维护）\n\n```shell\necho '[centos-office]\nname=centos-office\nfailovermethod=priority\nbaseurl=https://vault.centos.org/6.10/os/x86_64/\ngpgcheck=1\ngpgkey=https://vault.centos.org/6.10/os/x86_64/RPM-GPG-KEY-CentOS-6' > CentOS-Base.repo\n```\n\n安装并启动openssh服务\n\n```shell\nyum install openssh-server -y\nservice sshd restart\n```\n\n修改root密码(默认没有密码)\n\n```shell\necho '123456' | passwd --stdin root\n# 或者\necho root:123456 | chpassw\n```\n\n将已经安装好sshd服务的容器打包成镜像\n\n```shell\ndocker container commit 981877f137c9 centos6.9_ssh:v1\n```\n\n测试镜像\n\n>sshd -D：以后台守护进程的方式运行服务\n\n```shell\n# 启动sshd并将22端口映射出来，可以使用xshell连接\ndocker run -d -p 1022:22 centos6.9_ssh:v1 /usr/sbin/sshd -D\n```\n\n## 二、小案例：创建一个ssh+nginx双服务的镜像\n\n创建容器\n\n```shell\ndocker run -d -p 1023:22 centos6.9_ssh:v1 /usr/sbin/sshd -D\n```\n\n修改yum源和epel源\n\n```she\n由于Centos6阿里云停止维护\n参考：https://blog.csdn.net/u013250554/article/details/110684307\n```\n\n安装nginx\n\n```shell\nyum install nginx -y\n```\n\n创建运行服务的脚本\n\n```shell\nvim /root/init.sh\n#!/bin/bash\nservice sshd restart\nnginx -g 'daemon off;'\n```\n\n将容器封装成镜像\n\n```shell\ndocker commit e6a6dsa6 centos6.9_ssh_nginx:v2\n```\n\n启动镜像，开启服务，并夯住\n\n>可以使用工具ssh登录，并且可以访问到nginx的欢迎页面\n\n```shell\ndocker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 /bin/bash /root/init.sh\n```\n\n## 三、通过环境变量设置容器密码\n\n修改/root/init.sh文件\n\n```shell\n#!/bin/bash\n\nif [ -z $SSH_PWD ];then\n        SSH_PWD=123456\nfi\necho \"$SSH_PWD\" | passwd --stdin root\n\nservice sshd restart\nnginx -g 'daemon off;'\n```\n\n打包成镜像\n\n```shell\ndocker commit 12386c6504d4 centos6.9_ssh_nginx_passwd\n```\n\n运行容器\n\n>docker run -e：指定环境变量\n\n```shell\ndocker run -d -p 1022:22 -p 80:80 -e \"SSH_PWD=123456\" centos6.9_ssh_nginx_passwd /bin/bash /root/init.sh\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-五-手动制作docker镜像.md","raw":"---\ntitle: Docker系列(五)-手动制作docker镜像\ndate: 2021-06-29 13:35:26\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、制作Docker镜像\n\n### 1 启动基础容器\n\n```she\ndocker run -it centos:6.9 # yum\ndocker run -it alpine:3.9 # apk\n```\n\n### 2 在容器中安装服务\n\n修改yum源（Centos6阿里源已停止维护）\n\n```shell\necho '[centos-office]\nname=centos-office\nfailovermethod=priority\nbaseurl=https://vault.centos.org/6.10/os/x86_64/\ngpgcheck=1\ngpgkey=https://vault.centos.org/6.10/os/x86_64/RPM-GPG-KEY-CentOS-6' > CentOS-Base.repo\n```\n\n安装并启动openssh服务\n\n```shell\nyum install openssh-server -y\nservice sshd restart\n```\n\n修改root密码(默认没有密码)\n\n```shell\necho '123456' | passwd --stdin root\n# 或者\necho root:123456 | chpassw\n```\n\n将已经安装好sshd服务的容器打包成镜像\n\n```shell\ndocker container commit 981877f137c9 centos6.9_ssh:v1\n```\n\n测试镜像\n\n>sshd -D：以后台守护进程的方式运行服务\n\n```shell\n# 启动sshd并将22端口映射出来，可以使用xshell连接\ndocker run -d -p 1022:22 centos6.9_ssh:v1 /usr/sbin/sshd -D\n```\n\n## 二、小案例：创建一个ssh+nginx双服务的镜像\n\n创建容器\n\n```shell\ndocker run -d -p 1023:22 centos6.9_ssh:v1 /usr/sbin/sshd -D\n```\n\n修改yum源和epel源\n\n```she\n由于Centos6阿里云停止维护\n参考：https://blog.csdn.net/u013250554/article/details/110684307\n```\n\n安装nginx\n\n```shell\nyum install nginx -y\n```\n\n创建运行服务的脚本\n\n```shell\nvim /root/init.sh\n#!/bin/bash\nservice sshd restart\nnginx -g 'daemon off;'\n```\n\n将容器封装成镜像\n\n```shell\ndocker commit e6a6dsa6 centos6.9_ssh_nginx:v2\n```\n\n启动镜像，开启服务，并夯住\n\n>可以使用工具ssh登录，并且可以访问到nginx的欢迎页面\n\n```shell\ndocker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 /bin/bash /root/init.sh\n```\n\n## 三、通过环境变量设置容器密码\n\n修改/root/init.sh文件\n\n```shell\n#!/bin/bash\n\nif [ -z $SSH_PWD ];then\n        SSH_PWD=123456\nfi\necho \"$SSH_PWD\" | passwd --stdin root\n\nservice sshd restart\nnginx -g 'daemon off;'\n```\n\n打包成镜像\n\n```shell\ndocker commit 12386c6504d4 centos6.9_ssh_nginx_passwd\n```\n\n运行容器\n\n>docker run -e：指定环境变量\n\n```shell\ndocker run -d -p 1022:22 -p 80:80 -e \"SSH_PWD=123456\" centos6.9_ssh_nginx_passwd /bin/bash /root/init.sh\n```\n\n","slug":"01_运维/03-Docker/Docker系列-五-手动制作docker镜像","published":1,"updated":"2022-07-06T07:19:57.436Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0u001ma8v764mh3un5","content":"<h2 id=\"一、制作Docker镜像\"><a href=\"#一、制作Docker镜像\" class=\"headerlink\" title=\"一、制作Docker镜像\"></a>一、制作Docker镜像</h2><h3 id=\"1-启动基础容器\"><a href=\"#1-启动基础容器\" class=\"headerlink\" title=\"1 启动基础容器\"></a>1 启动基础容器</h3><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker run -it centos:6.9 # yum\ndocker run -it alpine:3.9 # apk<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-在容器中安装服务\"><a href=\"#2-在容器中安装服务\" class=\"headerlink\" title=\"2 在容器中安装服务\"></a>2 在容器中安装服务</h3><p>修改yum源（Centos6阿里源已停止维护）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &#39;[centos-office]\nname&#x3D;centos-office\nfailovermethod&#x3D;priority\nbaseurl&#x3D;https:&#x2F;&#x2F;vault.centos.org&#x2F;6.10&#x2F;os&#x2F;x86_64&#x2F;\ngpgcheck&#x3D;1\ngpgkey&#x3D;https:&#x2F;&#x2F;vault.centos.org&#x2F;6.10&#x2F;os&#x2F;x86_64&#x2F;RPM-GPG-KEY-CentOS-6&#39; &gt; CentOS-Base.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>安装并启动openssh服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install openssh-server -y\nservice sshd restart<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改root密码(默认没有密码)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &#39;123456&#39; | passwd --stdin root\n# 或者\necho root:123456 | chpassw<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>将已经安装好sshd服务的容器打包成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container commit 981877f137c9 centos6.9_ssh:v1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试镜像</p>\n<blockquote>\n<p>sshd -D：以后台守护进程的方式运行服务</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 启动sshd并将22端口映射出来，可以使用xshell连接\ndocker run -d -p 1022:22 centos6.9_ssh:v1 &#x2F;usr&#x2F;sbin&#x2F;sshd -D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、小案例：创建一个ssh-nginx双服务的镜像\"><a href=\"#二、小案例：创建一个ssh-nginx双服务的镜像\" class=\"headerlink\" title=\"二、小案例：创建一个ssh+nginx双服务的镜像\"></a>二、小案例：创建一个ssh+nginx双服务的镜像</h2><p>创建容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1023:22 centos6.9_ssh:v1 &#x2F;usr&#x2F;sbin&#x2F;sshd -D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改yum源和epel源</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">由于Centos6阿里云停止维护\n参考：https:&#x2F;&#x2F;blog.csdn.net&#x2F;u013250554&#x2F;article&#x2F;details&#x2F;110684307<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>安装nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建运行服务的脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;root&#x2F;init.sh\n#!&#x2F;bin&#x2F;bash\nservice sshd restart\nnginx -g &#39;daemon off;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将容器封装成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker commit e6a6dsa6 centos6.9_ssh_nginx:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动镜像，开启服务，并夯住</p>\n<blockquote>\n<p>可以使用工具ssh登录，并且可以访问到nginx的欢迎页面</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;root&#x2F;init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"三、通过环境变量设置容器密码\"><a href=\"#三、通过环境变量设置容器密码\" class=\"headerlink\" title=\"三、通过环境变量设置容器密码\"></a>三、通过环境变量设置容器密码</h2><p>修改&#x2F;root&#x2F;init.sh文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\n\nif [ -z $SSH_PWD ];then\n        SSH_PWD&#x3D;123456\nfi\necho &quot;$SSH_PWD&quot; | passwd --stdin root\n\nservice sshd restart\nnginx -g &#39;daemon off;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>打包成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker commit 12386c6504d4 centos6.9_ssh_nginx_passwd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>运行容器</p>\n<blockquote>\n<p>docker run -e：指定环境变量</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 -p 80:80 -e &quot;SSH_PWD&#x3D;123456&quot; centos6.9_ssh_nginx_passwd &#x2F;bin&#x2F;bash &#x2F;root&#x2F;init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、制作Docker镜像\"><a href=\"#一、制作Docker镜像\" class=\"headerlink\" title=\"一、制作Docker镜像\"></a>一、制作Docker镜像</h2><h3 id=\"1-启动基础容器\"><a href=\"#1-启动基础容器\" class=\"headerlink\" title=\"1 启动基础容器\"></a>1 启动基础容器</h3><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">docker run -it centos:6.9 # yum\ndocker run -it alpine:3.9 # apk<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-在容器中安装服务\"><a href=\"#2-在容器中安装服务\" class=\"headerlink\" title=\"2 在容器中安装服务\"></a>2 在容器中安装服务</h3><p>修改yum源（Centos6阿里源已停止维护）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &#39;[centos-office]\nname&#x3D;centos-office\nfailovermethod&#x3D;priority\nbaseurl&#x3D;https:&#x2F;&#x2F;vault.centos.org&#x2F;6.10&#x2F;os&#x2F;x86_64&#x2F;\ngpgcheck&#x3D;1\ngpgkey&#x3D;https:&#x2F;&#x2F;vault.centos.org&#x2F;6.10&#x2F;os&#x2F;x86_64&#x2F;RPM-GPG-KEY-CentOS-6&#39; &gt; CentOS-Base.repo<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>安装并启动openssh服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install openssh-server -y\nservice sshd restart<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改root密码(默认没有密码)</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">echo &#39;123456&#39; | passwd --stdin root\n# 或者\necho root:123456 | chpassw<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>将已经安装好sshd服务的容器打包成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker container commit 981877f137c9 centos6.9_ssh:v1<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>测试镜像</p>\n<blockquote>\n<p>sshd -D：以后台守护进程的方式运行服务</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 启动sshd并将22端口映射出来，可以使用xshell连接\ndocker run -d -p 1022:22 centos6.9_ssh:v1 &#x2F;usr&#x2F;sbin&#x2F;sshd -D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、小案例：创建一个ssh-nginx双服务的镜像\"><a href=\"#二、小案例：创建一个ssh-nginx双服务的镜像\" class=\"headerlink\" title=\"二、小案例：创建一个ssh+nginx双服务的镜像\"></a>二、小案例：创建一个ssh+nginx双服务的镜像</h2><p>创建容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1023:22 centos6.9_ssh:v1 &#x2F;usr&#x2F;sbin&#x2F;sshd -D<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>修改yum源和epel源</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">由于Centos6阿里云停止维护\n参考：https:&#x2F;&#x2F;blog.csdn.net&#x2F;u013250554&#x2F;article&#x2F;details&#x2F;110684307<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>安装nginx</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">yum install nginx -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建运行服务的脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;root&#x2F;init.sh\n#!&#x2F;bin&#x2F;bash\nservice sshd restart\nnginx -g &#39;daemon off;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将容器封装成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker commit e6a6dsa6 centos6.9_ssh_nginx:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动镜像，开启服务，并夯住</p>\n<blockquote>\n<p>可以使用工具ssh登录，并且可以访问到nginx的欢迎页面</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;root&#x2F;init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"三、通过环境变量设置容器密码\"><a href=\"#三、通过环境变量设置容器密码\" class=\"headerlink\" title=\"三、通过环境变量设置容器密码\"></a>三、通过环境变量设置容器密码</h2><p>修改&#x2F;root&#x2F;init.sh文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">#!&#x2F;bin&#x2F;bash\n\nif [ -z $SSH_PWD ];then\n        SSH_PWD&#x3D;123456\nfi\necho &quot;$SSH_PWD&quot; | passwd --stdin root\n\nservice sshd restart\nnginx -g &#39;daemon off;&#39;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>打包成镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker commit 12386c6504d4 centos6.9_ssh_nginx_passwd<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>运行容器</p>\n<blockquote>\n<p>docker run -e：指定环境变量</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 1022:22 -p 80:80 -e &quot;SSH_PWD&#x3D;123456&quot; centos6.9_ssh_nginx_passwd &#x2F;bin&#x2F;bash &#x2F;root&#x2F;init.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"Docker系列(八)-Docker私有仓库","date":"2021-07-06T05:58:52.000Z","_content":"\n## 一、官方私有仓库registry\n\n### 1 安装步骤\n\n拉取私有仓库镜像\n\n```shell\ndocker pull registry\n```\n\n启动私有仓库容器\n\n```shell\ndocker run -di --name=registry -p 5000:5000 registry\n```\n\n验证是否正常\n\n```shell\n# 浏览器输入\n10.0.0.12:5000/v2/_catalog\n```\n\n修改daemon.json，让 docker信任私有仓库地址\n\n```shell\nvi /etc/docker/daemon.json\n# 添加\n{\n\t\"insecure-registries\":[\"10.0.0.12:5000\"]\n} \n```\n\n重启docker服务\n\n```shell\nsystemctl reset-failed docker.service\n```\n\n上传镜像到私有仓库\n\n```shell\ndocker push 10.0.0.11:5000/registry\n```\n\n从私有仓库下载镜像\n\n```shell\ndocker pull http://10.0.0.12:5000/registry\n```\n\n## 二、企业级私有仓库Harbor\n\n>Harbor：第三方registry组件\n>\n>项目地址：https://github.com/goharbor/harbor\n>\n>老男孩强哥博客地址：https://oldqiang.com/\n\n### 1 为什么使用Harbor\n\n因为官方仓库registry存在诸多问题：\n\n- https问题\n\n- 网页简陋，查看镜像、删除镜像不方便\n- 权限控制不方便（要么有权限，要么完全没权限），不支持多用户\n\n### 2 Harbor安装步骤\n\n>这里以v2.2.3为例\n\n离线安装包获取\n\n```shell\nwget https://github.com/goharbor/harbor/releases/download/v2.2.3/harbor-offline-installer-v2.2.3.tgz\n```\n\n解压文件，并修改配置文件\n\n```shell\ntar -vxf harbor-offline-installer-v2.2.3.tgz\ncd harbor/\ncp harbor.yml.tmpl harbor.yml\nvim harbor.yml\n# 注释https设置项，并修改以下内容\nhostname = 10.0.0.12  \nharbor_admin_password = 1qaz@WSX\n```\n\n执行安装脚本（时间比较长）\n\n>需要先安装docker-compose，\n>\n>[docker-compose安装参考](https://gsproj.github.io/2021/07/07/Docker%E7%B3%BB%E5%88%97-%E5%8D%81-Dokcer%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92docker-compose/)\n\n```shell\n./install.sh\n```\n\n网页访问\n\n```shell\nhttp://10.0.0.12\nadmin\n```\n\n### 3 镜像推送与下载\n\ndocker配置文件添加白名单\n\n```shell\nvim /etc/docker/daemon.json\n\"insecure-registries\":[\"10.0.0.12\"],  # 不要加端口,可以是IP或域名，中间逗号隔开可加多个\n```\n\n镜像打标签\n\n```shell\ndocker pull 10.0.0.12/xxx/centos6.9_ssh:v2   # xxx是仓库中的创建的项目名\n```\n\n登录到仓库\n\n```shell\ndocker login 10.0.0.12\n```\n\n推送到仓库\n\n```shell\ndocker push 10.0.0.12/xxx/centos6.9_ssh:v2\n```\n\n从仓库下载镜像\n\n```shell\ndocker pull 10.0.0.12/xxx/centos6.9_ssh:v2\n```\n\n### 4 将Harbor升级为https访问\n\n配置文件修改，主要是添加证书路径\n\n```shell\n# https related config\nhttps:\n  # https port for harbor, default is 443\n  port: 443\n  # The path of cert and key files for nginx\n  certificate: /your/certificate/path\n  private_key: /your/private/key/path\n```\n\n再次执行安装脚本\n\n```shell\n./install.sh\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-八-Docker私有仓库.md","raw":"---\ntitle: Docker系列(八)-Docker私有仓库\ndate: 2021-07-06 13:58:52\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、官方私有仓库registry\n\n### 1 安装步骤\n\n拉取私有仓库镜像\n\n```shell\ndocker pull registry\n```\n\n启动私有仓库容器\n\n```shell\ndocker run -di --name=registry -p 5000:5000 registry\n```\n\n验证是否正常\n\n```shell\n# 浏览器输入\n10.0.0.12:5000/v2/_catalog\n```\n\n修改daemon.json，让 docker信任私有仓库地址\n\n```shell\nvi /etc/docker/daemon.json\n# 添加\n{\n\t\"insecure-registries\":[\"10.0.0.12:5000\"]\n} \n```\n\n重启docker服务\n\n```shell\nsystemctl reset-failed docker.service\n```\n\n上传镜像到私有仓库\n\n```shell\ndocker push 10.0.0.11:5000/registry\n```\n\n从私有仓库下载镜像\n\n```shell\ndocker pull http://10.0.0.12:5000/registry\n```\n\n## 二、企业级私有仓库Harbor\n\n>Harbor：第三方registry组件\n>\n>项目地址：https://github.com/goharbor/harbor\n>\n>老男孩强哥博客地址：https://oldqiang.com/\n\n### 1 为什么使用Harbor\n\n因为官方仓库registry存在诸多问题：\n\n- https问题\n\n- 网页简陋，查看镜像、删除镜像不方便\n- 权限控制不方便（要么有权限，要么完全没权限），不支持多用户\n\n### 2 Harbor安装步骤\n\n>这里以v2.2.3为例\n\n离线安装包获取\n\n```shell\nwget https://github.com/goharbor/harbor/releases/download/v2.2.3/harbor-offline-installer-v2.2.3.tgz\n```\n\n解压文件，并修改配置文件\n\n```shell\ntar -vxf harbor-offline-installer-v2.2.3.tgz\ncd harbor/\ncp harbor.yml.tmpl harbor.yml\nvim harbor.yml\n# 注释https设置项，并修改以下内容\nhostname = 10.0.0.12  \nharbor_admin_password = 1qaz@WSX\n```\n\n执行安装脚本（时间比较长）\n\n>需要先安装docker-compose，\n>\n>[docker-compose安装参考](https://gsproj.github.io/2021/07/07/Docker%E7%B3%BB%E5%88%97-%E5%8D%81-Dokcer%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92docker-compose/)\n\n```shell\n./install.sh\n```\n\n网页访问\n\n```shell\nhttp://10.0.0.12\nadmin\n```\n\n### 3 镜像推送与下载\n\ndocker配置文件添加白名单\n\n```shell\nvim /etc/docker/daemon.json\n\"insecure-registries\":[\"10.0.0.12\"],  # 不要加端口,可以是IP或域名，中间逗号隔开可加多个\n```\n\n镜像打标签\n\n```shell\ndocker pull 10.0.0.12/xxx/centos6.9_ssh:v2   # xxx是仓库中的创建的项目名\n```\n\n登录到仓库\n\n```shell\ndocker login 10.0.0.12\n```\n\n推送到仓库\n\n```shell\ndocker push 10.0.0.12/xxx/centos6.9_ssh:v2\n```\n\n从仓库下载镜像\n\n```shell\ndocker pull 10.0.0.12/xxx/centos6.9_ssh:v2\n```\n\n### 4 将Harbor升级为https访问\n\n配置文件修改，主要是添加证书路径\n\n```shell\n# https related config\nhttps:\n  # https port for harbor, default is 443\n  port: 443\n  # The path of cert and key files for nginx\n  certificate: /your/certificate/path\n  private_key: /your/private/key/path\n```\n\n再次执行安装脚本\n\n```shell\n./install.sh\n```\n\n","slug":"01_运维/03-Docker/Docker系列-八-Docker私有仓库","published":1,"updated":"2022-07-06T07:19:08.230Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0u001na8v7ezwh0kst","content":"<h2 id=\"一、官方私有仓库registry\"><a href=\"#一、官方私有仓库registry\" class=\"headerlink\" title=\"一、官方私有仓库registry\"></a>一、官方私有仓库registry</h2><h3 id=\"1-安装步骤\"><a href=\"#1-安装步骤\" class=\"headerlink\" title=\"1 安装步骤\"></a>1 安装步骤</h3><p>拉取私有仓库镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动私有仓库容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -di --name&#x3D;registry -p 5000:5000 registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>验证是否正常</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 浏览器输入\n10.0.0.12:5000&#x2F;v2&#x2F;_catalog<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改daemon.json，让 docker信任私有仓库地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;docker&#x2F;daemon.json\n# 添加\n&#123;\n\t&quot;insecure-registries&quot;:[&quot;10.0.0.12:5000&quot;]\n&#125; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启docker服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl reset-failed docker.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>上传镜像到私有仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker push 10.0.0.11:5000&#x2F;registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>从私有仓库下载镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull http:&#x2F;&#x2F;10.0.0.12:5000&#x2F;registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、企业级私有仓库Harbor\"><a href=\"#二、企业级私有仓库Harbor\" class=\"headerlink\" title=\"二、企业级私有仓库Harbor\"></a>二、企业级私有仓库Harbor</h2><blockquote>\n<p>Harbor：第三方registry组件</p>\n<p>项目地址：<a href=\"https://github.com/goharbor/harbor\">https://github.com/goharbor/harbor</a></p>\n<p>老男孩强哥博客地址：<a href=\"https://oldqiang.com/\">https://oldqiang.com/</a></p>\n</blockquote>\n<h3 id=\"1-为什么使用Harbor\"><a href=\"#1-为什么使用Harbor\" class=\"headerlink\" title=\"1 为什么使用Harbor\"></a>1 为什么使用Harbor</h3><p>因为官方仓库registry存在诸多问题：</p>\n<ul>\n<li><p>https问题</p>\n</li>\n<li><p>网页简陋，查看镜像、删除镜像不方便</p>\n</li>\n<li><p>权限控制不方便（要么有权限，要么完全没权限），不支持多用户</p>\n</li>\n</ul>\n<h3 id=\"2-Harbor安装步骤\"><a href=\"#2-Harbor安装步骤\" class=\"headerlink\" title=\"2 Harbor安装步骤\"></a>2 Harbor安装步骤</h3><blockquote>\n<p>这里以v2.2.3为例</p>\n</blockquote>\n<p>离线安装包获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;github.com&#x2F;goharbor&#x2F;harbor&#x2F;releases&#x2F;download&#x2F;v2.2.3&#x2F;harbor-offline-installer-v2.2.3.tgz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>解压文件，并修改配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar -vxf harbor-offline-installer-v2.2.3.tgz\ncd harbor&#x2F;\ncp harbor.yml.tmpl harbor.yml\nvim harbor.yml\n# 注释https设置项，并修改以下内容\nhostname &#x3D; 10.0.0.12  \nharbor_admin_password &#x3D; 1qaz@WSX<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>执行安装脚本（时间比较长）</p>\n<blockquote>\n<p>需要先安装docker-compose，</p>\n<p><a href=\"https://gsproj.github.io/2021/07/07/Docker%E7%B3%BB%E5%88%97-%E5%8D%81-Dokcer%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92docker-compose/\">docker-compose安装参考</a></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">http:&#x2F;&#x2F;10.0.0.12\nadmin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-镜像推送与下载\"><a href=\"#3-镜像推送与下载\" class=\"headerlink\" title=\"3 镜像推送与下载\"></a>3 镜像推送与下载</h3><p>docker配置文件添加白名单</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json\n&quot;insecure-registries&quot;:[&quot;10.0.0.12&quot;],  # 不要加端口,可以是IP或域名，中间逗号隔开可加多个<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>镜像打标签</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2   # xxx是仓库中的创建的项目名<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>登录到仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker login 10.0.0.12<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>推送到仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker push 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>从仓库下载镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"4-将Harbor升级为https访问\"><a href=\"#4-将Harbor升级为https访问\" class=\"headerlink\" title=\"4 将Harbor升级为https访问\"></a>4 将Harbor升级为https访问</h3><p>配置文件修改，主要是添加证书路径</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># https related config\nhttps:\n  # https port for harbor, default is 443\n  port: 443\n  # The path of cert and key files for nginx\n  certificate: &#x2F;your&#x2F;certificate&#x2F;path\n  private_key: &#x2F;your&#x2F;private&#x2F;key&#x2F;path<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>再次执行安装脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、官方私有仓库registry\"><a href=\"#一、官方私有仓库registry\" class=\"headerlink\" title=\"一、官方私有仓库registry\"></a>一、官方私有仓库registry</h2><h3 id=\"1-安装步骤\"><a href=\"#1-安装步骤\" class=\"headerlink\" title=\"1 安装步骤\"></a>1 安装步骤</h3><p>拉取私有仓库镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>启动私有仓库容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -di --name&#x3D;registry -p 5000:5000 registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>验证是否正常</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 浏览器输入\n10.0.0.12:5000&#x2F;v2&#x2F;_catalog<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>修改daemon.json，让 docker信任私有仓库地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vi &#x2F;etc&#x2F;docker&#x2F;daemon.json\n# 添加\n&#123;\n\t&quot;insecure-registries&quot;:[&quot;10.0.0.12:5000&quot;]\n&#125; <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启docker服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">systemctl reset-failed docker.service<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>上传镜像到私有仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker push 10.0.0.11:5000&#x2F;registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>从私有仓库下载镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull http:&#x2F;&#x2F;10.0.0.12:5000&#x2F;registry<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、企业级私有仓库Harbor\"><a href=\"#二、企业级私有仓库Harbor\" class=\"headerlink\" title=\"二、企业级私有仓库Harbor\"></a>二、企业级私有仓库Harbor</h2><blockquote>\n<p>Harbor：第三方registry组件</p>\n<p>项目地址：<a href=\"https://github.com/goharbor/harbor\">https://github.com/goharbor/harbor</a></p>\n<p>老男孩强哥博客地址：<a href=\"https://oldqiang.com/\">https://oldqiang.com/</a></p>\n</blockquote>\n<h3 id=\"1-为什么使用Harbor\"><a href=\"#1-为什么使用Harbor\" class=\"headerlink\" title=\"1 为什么使用Harbor\"></a>1 为什么使用Harbor</h3><p>因为官方仓库registry存在诸多问题：</p>\n<ul>\n<li><p>https问题</p>\n</li>\n<li><p>网页简陋，查看镜像、删除镜像不方便</p>\n</li>\n<li><p>权限控制不方便（要么有权限，要么完全没权限），不支持多用户</p>\n</li>\n</ul>\n<h3 id=\"2-Harbor安装步骤\"><a href=\"#2-Harbor安装步骤\" class=\"headerlink\" title=\"2 Harbor安装步骤\"></a>2 Harbor安装步骤</h3><blockquote>\n<p>这里以v2.2.3为例</p>\n</blockquote>\n<p>离线安装包获取</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;github.com&#x2F;goharbor&#x2F;harbor&#x2F;releases&#x2F;download&#x2F;v2.2.3&#x2F;harbor-offline-installer-v2.2.3.tgz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>解压文件，并修改配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">tar -vxf harbor-offline-installer-v2.2.3.tgz\ncd harbor&#x2F;\ncp harbor.yml.tmpl harbor.yml\nvim harbor.yml\n# 注释https设置项，并修改以下内容\nhostname &#x3D; 10.0.0.12  \nharbor_admin_password &#x3D; 1qaz@WSX<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>执行安装脚本（时间比较长）</p>\n<blockquote>\n<p>需要先安装docker-compose，</p>\n<p><a href=\"https://gsproj.github.io/2021/07/07/Docker%E7%B3%BB%E5%88%97-%E5%8D%81-Dokcer%E5%8D%95%E6%9C%BA%E7%BC%96%E6%8E%92docker-compose/\">docker-compose安装参考</a></p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">http:&#x2F;&#x2F;10.0.0.12\nadmin<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-镜像推送与下载\"><a href=\"#3-镜像推送与下载\" class=\"headerlink\" title=\"3 镜像推送与下载\"></a>3 镜像推送与下载</h3><p>docker配置文件添加白名单</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;etc&#x2F;docker&#x2F;daemon.json\n&quot;insecure-registries&quot;:[&quot;10.0.0.12&quot;],  # 不要加端口,可以是IP或域名，中间逗号隔开可加多个<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>镜像打标签</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2   # xxx是仓库中的创建的项目名<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>登录到仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker login 10.0.0.12<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>推送到仓库</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker push 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>从仓库下载镜像</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker pull 10.0.0.12&#x2F;xxx&#x2F;centos6.9_ssh:v2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"4-将Harbor升级为https访问\"><a href=\"#4-将Harbor升级为https访问\" class=\"headerlink\" title=\"4 将Harbor升级为https访问\"></a>4 将Harbor升级为https访问</h3><p>配置文件修改，主要是添加证书路径</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># https related config\nhttps:\n  # https port for harbor, default is 443\n  port: 443\n  # The path of cert and key files for nginx\n  certificate: &#x2F;your&#x2F;certificate&#x2F;path\n  private_key: &#x2F;your&#x2F;private&#x2F;key&#x2F;path<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>再次执行安装脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">.&#x2F;install.sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"Docker系列(十)-Dokcer单机编排docker-compose","date":"2021-07-07T01:51:12.000Z","_content":"\n>docker-compose 单机版的容器编排工具\n\n## 一、安装docker-compose\n\n添加Centos7的epel源\n\n```shell\ncurl -o epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\n```\n\n安装pip\n\n>Python 2.7已于2020年1月1日到期，请停止使用。请升级您的Python，因为不再维护Python 2.7。pip 21.0将于2021年1月停止对Python 2.7的支持。pip 21.0将删除对此功能的支持。因此安装<21.0的版本\n\n```she\nyum install -y python2-pip\npip install --upgrade \"pip < 21.0\"\n```\n\n安装docker-compose\n\n```shell\npip install docker-compose\n```\n\n创建文件夹用于存放docker-compose脚本\n\n```shell\nmkdir /opt/docker-compose\n```\n\n## 一、案例：compose构建wordpress并使用nginx负载均衡\n\ndocker01主机创建docker-compose文件\n\n```shell\nvim /opt/docker-compose/wordpress/docker-compose.yml\n```\n\n```yaml\nversion: '3'\n\nservices:\n  db:\n    image: mysql:5.7\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n\n  wordpress:\n    depends_on:\n      - db\n    image: wordpress:latest\n    volumes:\n      - web_data:/var/www/html\n    ports:\n     - \"80\"  # 随机端口映射到内网80端口\n    restart: always\n    environment:\n     WORDPRESS_DB_HOST: db:3306\n     WORDPRESS_DB_USER: wordpress\n     WORDPRESS_DB_PASSWORD: wordpress\nvolumes:\n  db_data:\n  web_data:\n```\n\n构建Docker容器(三个wordpress，一个mysql）\n\n```shell\ndocker-compose up --scale wordpress=3 -d\n-d 后台运行\n--scale 生成的实例数\n```\n\n```she\nnetstaus -lntup可以看到3个连续的端口号\ntcp        0      0 0.0.0.0:49156           0.0.0.0:*               LISTEN      2110/docker-proxy\ntcp        0      0 0.0.0.0:49157           0.0.0.0:*               LISTEN      2126/docker-proxy\ntcp        0      0 0.0.0.0:49158           0.0.0.0:*               LISTEN      2143/docker-proxy\n```\n\ndocker02主机安装nginx，用于负载均衡\n\n```she\ncurl -o epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\nyum install nginx\n```\n\n配置nginx\n\n```she\ncd /etc/nginx/\nmv nginx.conf nginx.conf.bak\ngrep -Ev '^$|#' nginx.conf.default  > nginx.conf\nvim nginx.conf\n```\n\n```shell\nworker_processes  1;\nevents {\n    worker_connections  1024;\n}\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n\n    upstream wordpress {\n        server 10.0.0.11:49156;\n        server 10.0.0.11:49157;\n        server 10.0.0.11:49158;\n    }\n\n    server {\n        listen       80;\n        server_name  localhost;\n        location / {\n            proxy_pass  http://wordpress;\n            proxy_set_header Host $host;  # 不加上网页没有Host信息，显示不全\n        }\n    }\n}\n```\n\n重启nginx服务\n\n```shell\nnginx -t\nsystemctl restart nginx\n```\n\n测试访问\n\n```she\n浏览器访问:10.0.0.12,可以进入wordpress\n```\n\n查看是否负载均衡\n\n```shell\n# 创建一个查看信息的页面\ncd /var/lib/docker/volumes/wordpress_web_data/_data/\nvim info.php\n```\n\n```php\n<?php phpinfo(); ?>\n```\n\n浏览器访问：10.0.0.12/info.php，查看其中IP信息\n\n## 二、案例：构建zabbix","source":"_posts/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose.md","raw":"---\ntitle: Docker系列(十)-Dokcer单机编排docker-compose\ndate: 2021-07-07 09:51:12\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n>docker-compose 单机版的容器编排工具\n\n## 一、安装docker-compose\n\n添加Centos7的epel源\n\n```shell\ncurl -o epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\n```\n\n安装pip\n\n>Python 2.7已于2020年1月1日到期，请停止使用。请升级您的Python，因为不再维护Python 2.7。pip 21.0将于2021年1月停止对Python 2.7的支持。pip 21.0将删除对此功能的支持。因此安装<21.0的版本\n\n```she\nyum install -y python2-pip\npip install --upgrade \"pip < 21.0\"\n```\n\n安装docker-compose\n\n```shell\npip install docker-compose\n```\n\n创建文件夹用于存放docker-compose脚本\n\n```shell\nmkdir /opt/docker-compose\n```\n\n## 一、案例：compose构建wordpress并使用nginx负载均衡\n\ndocker01主机创建docker-compose文件\n\n```shell\nvim /opt/docker-compose/wordpress/docker-compose.yml\n```\n\n```yaml\nversion: '3'\n\nservices:\n  db:\n    image: mysql:5.7\n    volumes:\n      - db_data:/var/lib/mysql\n    restart: always\n    environment:\n      MYSQL_ROOT_PASSWORD: somewordpress\n      MYSQL_DATABASE: wordpress\n      MYSQL_USER: wordpress\n      MYSQL_PASSWORD: wordpress\n\n  wordpress:\n    depends_on:\n      - db\n    image: wordpress:latest\n    volumes:\n      - web_data:/var/www/html\n    ports:\n     - \"80\"  # 随机端口映射到内网80端口\n    restart: always\n    environment:\n     WORDPRESS_DB_HOST: db:3306\n     WORDPRESS_DB_USER: wordpress\n     WORDPRESS_DB_PASSWORD: wordpress\nvolumes:\n  db_data:\n  web_data:\n```\n\n构建Docker容器(三个wordpress，一个mysql）\n\n```shell\ndocker-compose up --scale wordpress=3 -d\n-d 后台运行\n--scale 生成的实例数\n```\n\n```she\nnetstaus -lntup可以看到3个连续的端口号\ntcp        0      0 0.0.0.0:49156           0.0.0.0:*               LISTEN      2110/docker-proxy\ntcp        0      0 0.0.0.0:49157           0.0.0.0:*               LISTEN      2126/docker-proxy\ntcp        0      0 0.0.0.0:49158           0.0.0.0:*               LISTEN      2143/docker-proxy\n```\n\ndocker02主机安装nginx，用于负载均衡\n\n```she\ncurl -o epel-7.repo http://mirrors.aliyun.com/repo/epel-7.repo\nyum clean all\nyum makecache\nyum install nginx\n```\n\n配置nginx\n\n```she\ncd /etc/nginx/\nmv nginx.conf nginx.conf.bak\ngrep -Ev '^$|#' nginx.conf.default  > nginx.conf\nvim nginx.conf\n```\n\n```shell\nworker_processes  1;\nevents {\n    worker_connections  1024;\n}\nhttp {\n    include       mime.types;\n    default_type  application/octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n\n    upstream wordpress {\n        server 10.0.0.11:49156;\n        server 10.0.0.11:49157;\n        server 10.0.0.11:49158;\n    }\n\n    server {\n        listen       80;\n        server_name  localhost;\n        location / {\n            proxy_pass  http://wordpress;\n            proxy_set_header Host $host;  # 不加上网页没有Host信息，显示不全\n        }\n    }\n}\n```\n\n重启nginx服务\n\n```shell\nnginx -t\nsystemctl restart nginx\n```\n\n测试访问\n\n```she\n浏览器访问:10.0.0.12,可以进入wordpress\n```\n\n查看是否负载均衡\n\n```shell\n# 创建一个查看信息的页面\ncd /var/lib/docker/volumes/wordpress_web_data/_data/\nvim info.php\n```\n\n```php\n<?php phpinfo(); ?>\n```\n\n浏览器访问：10.0.0.12/info.php，查看其中IP信息\n\n## 二、案例：构建zabbix","slug":"01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose","published":1,"updated":"2022-07-06T07:19:45.956Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0v001pa8v7a2uj51lm","content":"<blockquote>\n<p>docker-compose 单机版的容器编排工具</p>\n</blockquote>\n<h2 id=\"一、安装docker-compose\"><a href=\"#一、安装docker-compose\" class=\"headerlink\" title=\"一、安装docker-compose\"></a>一、安装docker-compose</h2><p>添加Centos7的epel源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">curl -o epel-7.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>安装pip</p>\n<blockquote>\n<p>Python 2.7已于2020年1月1日到期，请停止使用。请升级您的Python，因为不再维护Python 2.7。pip 21.0将于2021年1月停止对Python 2.7的支持。pip 21.0将删除对此功能的支持。因此安装&lt;21.0的版本</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">yum install -y python2-pip\npip install --upgrade &quot;pip &lt; 21.0&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>安装docker-compose</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">pip install docker-compose<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建文件夹用于存放docker-compose脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;opt&#x2F;docker-compose<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"一、案例：compose构建wordpress并使用nginx负载均衡\"><a href=\"#一、案例：compose构建wordpress并使用nginx负载均衡\" class=\"headerlink\" title=\"一、案例：compose构建wordpress并使用nginx负载均衡\"></a>一、案例：compose构建wordpress并使用nginx负载均衡</h2><p>docker01主机创建docker-compose文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;opt&#x2F;docker-compose&#x2F;wordpress&#x2F;docker-compose.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">5.7</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db_data<span class=\"token punctuation\">:</span>/var/lib/mysql\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> somewordpress\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> wordpress\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> wordpress\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> wordpress\n\n  <span class=\"token key atrule\">wordpress</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> wordpress<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> web_data<span class=\"token punctuation\">:</span>/var/www/html\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n     <span class=\"token punctuation\">-</span> <span class=\"token string\">\"80\"</span>  <span class=\"token comment\"># 随机端口映射到内网80端口</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n     <span class=\"token key atrule\">WORDPRESS_DB_HOST</span><span class=\"token punctuation\">:</span> db<span class=\"token punctuation\">:</span><span class=\"token number\">3306</span>\n     <span class=\"token key atrule\">WORDPRESS_DB_USER</span><span class=\"token punctuation\">:</span> wordpress\n     <span class=\"token key atrule\">WORDPRESS_DB_PASSWORD</span><span class=\"token punctuation\">:</span> wordpress\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db_data</span><span class=\"token punctuation\">:</span>\n  web_data<span class=\"token punctuation\">:</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建Docker容器(三个wordpress，一个mysql）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker-compose up --scale wordpress&#x3D;3 -d\n-d 后台运行\n--scale 生成的实例数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">netstaus -lntup可以看到3个连续的端口号\ntcp        0      0 0.0.0.0:49156           0.0.0.0:*               LISTEN      2110&#x2F;docker-proxy\ntcp        0      0 0.0.0.0:49157           0.0.0.0:*               LISTEN      2126&#x2F;docker-proxy\ntcp        0      0 0.0.0.0:49158           0.0.0.0:*               LISTEN      2143&#x2F;docker-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>docker02主机安装nginx，用于负载均衡</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">curl -o epel-7.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache\nyum install nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置nginx</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">cd &#x2F;etc&#x2F;nginx&#x2F;\nmv nginx.conf nginx.conf.bak\ngrep -Ev &#39;^$|#&#39; nginx.conf.default  &gt; nginx.conf\nvim nginx.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">worker_processes  1;\nevents &#123;\n    worker_connections  1024;\n&#125;\nhttp &#123;\n    include       mime.types;\n    default_type  application&#x2F;octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n\n    upstream wordpress &#123;\n        server 10.0.0.11:49156;\n        server 10.0.0.11:49157;\n        server 10.0.0.11:49158;\n    &#125;\n\n    server &#123;\n        listen       80;\n        server_name  localhost;\n        location &#x2F; &#123;\n            proxy_pass  http:&#x2F;&#x2F;wordpress;\n            proxy_set_header Host $host;  # 不加上网页没有Host信息，显示不全\n        &#125;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nginx -t\nsystemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试访问</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">浏览器访问:10.0.0.12,可以进入wordpress<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看是否负载均衡</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建一个查看信息的页面\ncd &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;wordpress_web_data&#x2F;_data&#x2F;\nvim info.php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token function\">phpinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>浏览器访问：10.0.0.12&#x2F;info.php，查看其中IP信息</p>\n<h2 id=\"二、案例：构建zabbix\"><a href=\"#二、案例：构建zabbix\" class=\"headerlink\" title=\"二、案例：构建zabbix\"></a>二、案例：构建zabbix</h2>","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p>docker-compose 单机版的容器编排工具</p>\n</blockquote>\n<h2 id=\"一、安装docker-compose\"><a href=\"#一、安装docker-compose\" class=\"headerlink\" title=\"一、安装docker-compose\"></a>一、安装docker-compose</h2><p>添加Centos7的epel源</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">curl -o epel-7.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>安装pip</p>\n<blockquote>\n<p>Python 2.7已于2020年1月1日到期，请停止使用。请升级您的Python，因为不再维护Python 2.7。pip 21.0将于2021年1月停止对Python 2.7的支持。pip 21.0将删除对此功能的支持。因此安装&lt;21.0的版本</p>\n</blockquote>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">yum install -y python2-pip\npip install --upgrade &quot;pip &lt; 21.0&quot;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>安装docker-compose</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">pip install docker-compose<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建文件夹用于存放docker-compose脚本</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">mkdir &#x2F;opt&#x2F;docker-compose<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"一、案例：compose构建wordpress并使用nginx负载均衡\"><a href=\"#一、案例：compose构建wordpress并使用nginx负载均衡\" class=\"headerlink\" title=\"一、案例：compose构建wordpress并使用nginx负载均衡\"></a>一、案例：compose构建wordpress并使用nginx负载均衡</h2><p>docker01主机创建docker-compose文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;opt&#x2F;docker-compose&#x2F;wordpress&#x2F;docker-compose.yml<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mysql<span class=\"token punctuation\">:</span><span class=\"token number\">5.7</span>\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db_data<span class=\"token punctuation\">:</span>/var/lib/mysql\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> somewordpress\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> wordpress\n      <span class=\"token key atrule\">MYSQL_USER</span><span class=\"token punctuation\">:</span> wordpress\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> wordpress\n\n  <span class=\"token key atrule\">wordpress</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> db\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> wordpress<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> web_data<span class=\"token punctuation\">:</span>/var/www/html\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n     <span class=\"token punctuation\">-</span> <span class=\"token string\">\"80\"</span>  <span class=\"token comment\"># 随机端口映射到内网80端口</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n     <span class=\"token key atrule\">WORDPRESS_DB_HOST</span><span class=\"token punctuation\">:</span> db<span class=\"token punctuation\">:</span><span class=\"token number\">3306</span>\n     <span class=\"token key atrule\">WORDPRESS_DB_USER</span><span class=\"token punctuation\">:</span> wordpress\n     <span class=\"token key atrule\">WORDPRESS_DB_PASSWORD</span><span class=\"token punctuation\">:</span> wordpress\n<span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">db_data</span><span class=\"token punctuation\">:</span>\n  web_data<span class=\"token punctuation\">:</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>构建Docker容器(三个wordpress，一个mysql）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker-compose up --scale wordpress&#x3D;3 -d\n-d 后台运行\n--scale 生成的实例数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">netstaus -lntup可以看到3个连续的端口号\ntcp        0      0 0.0.0.0:49156           0.0.0.0:*               LISTEN      2110&#x2F;docker-proxy\ntcp        0      0 0.0.0.0:49157           0.0.0.0:*               LISTEN      2126&#x2F;docker-proxy\ntcp        0      0 0.0.0.0:49158           0.0.0.0:*               LISTEN      2143&#x2F;docker-proxy<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>docker02主机安装nginx，用于负载均衡</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">curl -o epel-7.repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;epel-7.repo\nyum clean all\nyum makecache\nyum install nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>配置nginx</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">cd &#x2F;etc&#x2F;nginx&#x2F;\nmv nginx.conf nginx.conf.bak\ngrep -Ev &#39;^$|#&#39; nginx.conf.default  &gt; nginx.conf\nvim nginx.conf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">worker_processes  1;\nevents &#123;\n    worker_connections  1024;\n&#125;\nhttp &#123;\n    include       mime.types;\n    default_type  application&#x2F;octet-stream;\n    sendfile        on;\n    keepalive_timeout  65;\n\n    upstream wordpress &#123;\n        server 10.0.0.11:49156;\n        server 10.0.0.11:49157;\n        server 10.0.0.11:49158;\n    &#125;\n\n    server &#123;\n        listen       80;\n        server_name  localhost;\n        location &#x2F; &#123;\n            proxy_pass  http:&#x2F;&#x2F;wordpress;\n            proxy_set_header Host $host;  # 不加上网页没有Host信息，显示不全\n        &#125;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重启nginx服务</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">nginx -t\nsystemctl restart nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>测试访问</p>\n<pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">浏览器访问:10.0.0.12,可以进入wordpress<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看是否负载均衡</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 创建一个查看信息的页面\ncd &#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;wordpress_web_data&#x2F;_data&#x2F;\nvim info.php<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-php\" data-language=\"php\"><code class=\"language-php\"><span class=\"token php language-php\"><span class=\"token delimiter important\">&lt;?php</span> <span class=\"token function\">phpinfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token delimiter important\">?></span></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>浏览器访问：10.0.0.12&#x2F;info.php，查看其中IP信息</p>\n<h2 id=\"二、案例：构建zabbix\"><a href=\"#二、案例：构建zabbix\" class=\"headerlink\" title=\"二、案例：构建zabbix\"></a>二、案例：构建zabbix</h2>"},{"title":"Docker系列(四)-容器的数据卷挂载与小案例练习","date":"2021-06-29T02:31:05.000Z","_content":"\n## 一、数据卷挂载\n\n### 1 临时挂载\n\n```shell\n# 将/opt/xiaoniao目录挂载到容器的html目录\ndocker run -d -p 80:80 -v /opt/xiaoniao:/usr/share/nginx/html nginx:latest\n```\n\n### 2 使用卷挂载\n\n>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中\n\n创建名为myvol的容器卷并挂载到容器html目录\n\n```shell\ndocker run -d -p 80:80 -v myvol:/usr/share/nginx/html nginx:latest\n```\n\n查看当前有哪些容器卷\n\n```shell\ndocker volume ls\n```\n\n查看名为myvol的卷的信息\n\n```shell\ndocker volume inspect myvol\n```\n\n删除容器并删除卷（无效）\n\n```shell\n# PS：删除容器并删除卷，无法将卷删除\ndocker rm -f -v [容器ID]\n    -v --volume\n```\n\n## 二、小案例：多端口多站点\n\n>80端口访问nginx首页\n>\n>81端口访问水果忍者\n\n获取水果忍者HTML5小游戏源码\n\n```shell\nwget https://7npmedia.w3cschool.cn/1-FruitNinja.7z\n```\n\n创建81端口nginx配置文件\n\n```shell\nvim /opt/fruitninjia.conf\nserver {\n    listen       81;\n    listen  [::]:81;\n    server_name  localhost;\n\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        root   /data;\n        index  index.html index.htm;\n    }\n}\n```\n\n将游戏源码文件解压至/opt/fruitninjia，并运行nginx容器\n\n```shell\n# 将/opt/fruitninjia挂载到容器/data中\ndocker run -d -p 80:80 -p 81:81 -v /opt/fruitninjia:/data -v /opt/fruitninjia.conf:/etc/nginx/conf.d/fruitninjia.conf nginx\n```\n\n网页访问\n\n```shell\nhttps://10.0.0.11:80\n```\n\n","source":"_posts/01_运维/03-Docker/Docker系列-四-容器的数据卷挂载与小案例练习.md","raw":"---\ntitle: Docker系列(四)-容器的数据卷挂载与小案例练习\ndate: 2021-06-29 10:31:05\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n## 一、数据卷挂载\n\n### 1 临时挂载\n\n```shell\n# 将/opt/xiaoniao目录挂载到容器的html目录\ndocker run -d -p 80:80 -v /opt/xiaoniao:/usr/share/nginx/html nginx:latest\n```\n\n### 2 使用卷挂载\n\n>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中\n\n创建名为myvol的容器卷并挂载到容器html目录\n\n```shell\ndocker run -d -p 80:80 -v myvol:/usr/share/nginx/html nginx:latest\n```\n\n查看当前有哪些容器卷\n\n```shell\ndocker volume ls\n```\n\n查看名为myvol的卷的信息\n\n```shell\ndocker volume inspect myvol\n```\n\n删除容器并删除卷（无效）\n\n```shell\n# PS：删除容器并删除卷，无法将卷删除\ndocker rm -f -v [容器ID]\n    -v --volume\n```\n\n## 二、小案例：多端口多站点\n\n>80端口访问nginx首页\n>\n>81端口访问水果忍者\n\n获取水果忍者HTML5小游戏源码\n\n```shell\nwget https://7npmedia.w3cschool.cn/1-FruitNinja.7z\n```\n\n创建81端口nginx配置文件\n\n```shell\nvim /opt/fruitninjia.conf\nserver {\n    listen       81;\n    listen  [::]:81;\n    server_name  localhost;\n\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        root   /data;\n        index  index.html index.htm;\n    }\n}\n```\n\n将游戏源码文件解压至/opt/fruitninjia，并运行nginx容器\n\n```shell\n# 将/opt/fruitninjia挂载到容器/data中\ndocker run -d -p 80:80 -p 81:81 -v /opt/fruitninjia:/data -v /opt/fruitninjia.conf:/etc/nginx/conf.d/fruitninjia.conf nginx\n```\n\n网页访问\n\n```shell\nhttps://10.0.0.11:80\n```\n\n","slug":"01_运维/03-Docker/Docker系列-四-容器的数据卷挂载与小案例练习","published":1,"updated":"2022-07-06T07:19:50.579Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0w001qa8v7dehf1fnf","content":"<h2 id=\"一、数据卷挂载\"><a href=\"#一、数据卷挂载\" class=\"headerlink\" title=\"一、数据卷挂载\"></a>一、数据卷挂载</h2><h3 id=\"1-临时挂载\"><a href=\"#1-临时挂载\" class=\"headerlink\" title=\"1 临时挂载\"></a>1 临时挂载</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将&#x2F;opt&#x2F;xiaoniao目录挂载到容器的html目录\ndocker run -d -p 80:80 -v &#x2F;opt&#x2F;xiaoniao:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-使用卷挂载\"><a href=\"#2-使用卷挂载\" class=\"headerlink\" title=\"2 使用卷挂载\"></a>2 使用卷挂载</h3><blockquote>\n<p>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中</p>\n</blockquote>\n<p>创建名为myvol的容器卷并挂载到容器html目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 -v myvol:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看当前有哪些容器卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker volume ls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看名为myvol的卷的信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker volume inspect myvol<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>删除容器并删除卷（无效）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># PS：删除容器并删除卷，无法将卷删除\ndocker rm -f -v [容器ID]\n    -v --volume<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、小案例：多端口多站点\"><a href=\"#二、小案例：多端口多站点\" class=\"headerlink\" title=\"二、小案例：多端口多站点\"></a>二、小案例：多端口多站点</h2><blockquote>\n<p>80端口访问nginx首页</p>\n<p>81端口访问水果忍者</p>\n</blockquote>\n<p>获取水果忍者HTML5小游戏源码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;7npmedia.w3cschool.cn&#x2F;1-FruitNinja.7z<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建81端口nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;opt&#x2F;fruitninjia.conf\nserver &#123;\n    listen       81;\n    listen  [::]:81;\n    server_name  localhost;\n\n    #access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;host.access.log  main;\n\n    location &#x2F; &#123;\n        root   &#x2F;data;\n        index  index.html index.htm;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将游戏源码文件解压至&#x2F;opt&#x2F;fruitninjia，并运行nginx容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将&#x2F;opt&#x2F;fruitninjia挂载到容器&#x2F;data中\ndocker run -d -p 80:80 -p 81:81 -v &#x2F;opt&#x2F;fruitninjia:&#x2F;data -v &#x2F;opt&#x2F;fruitninjia.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;fruitninjia.conf nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;10.0.0.11:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、数据卷挂载\"><a href=\"#一、数据卷挂载\" class=\"headerlink\" title=\"一、数据卷挂载\"></a>一、数据卷挂载</h2><h3 id=\"1-临时挂载\"><a href=\"#1-临时挂载\" class=\"headerlink\" title=\"1 临时挂载\"></a>1 临时挂载</h3><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将&#x2F;opt&#x2F;xiaoniao目录挂载到容器的html目录\ndocker run -d -p 80:80 -v &#x2F;opt&#x2F;xiaoniao:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-使用卷挂载\"><a href=\"#2-使用卷挂载\" class=\"headerlink\" title=\"2 使用卷挂载\"></a>2 使用卷挂载</h3><blockquote>\n<p>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中</p>\n</blockquote>\n<p>创建名为myvol的容器卷并挂载到容器html目录</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker run -d -p 80:80 -v myvol:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看当前有哪些容器卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker volume ls<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看名为myvol的卷的信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">docker volume inspect myvol<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>删除容器并删除卷（无效）</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># PS：删除容器并删除卷，无法将卷删除\ndocker rm -f -v [容器ID]\n    -v --volume<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、小案例：多端口多站点\"><a href=\"#二、小案例：多端口多站点\" class=\"headerlink\" title=\"二、小案例：多端口多站点\"></a>二、小案例：多端口多站点</h2><blockquote>\n<p>80端口访问nginx首页</p>\n<p>81端口访问水果忍者</p>\n</blockquote>\n<p>获取水果忍者HTML5小游戏源码</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">wget https:&#x2F;&#x2F;7npmedia.w3cschool.cn&#x2F;1-FruitNinja.7z<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>创建81端口nginx配置文件</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">vim &#x2F;opt&#x2F;fruitninjia.conf\nserver &#123;\n    listen       81;\n    listen  [::]:81;\n    server_name  localhost;\n\n    #access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;host.access.log  main;\n\n    location &#x2F; &#123;\n        root   &#x2F;data;\n        index  index.html index.htm;\n    &#125;\n&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>将游戏源码文件解压至&#x2F;opt&#x2F;fruitninjia，并运行nginx容器</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"># 将&#x2F;opt&#x2F;fruitninjia挂载到容器&#x2F;data中\ndocker run -d -p 80:80 -p 81:81 -v &#x2F;opt&#x2F;fruitninjia:&#x2F;data -v &#x2F;opt&#x2F;fruitninjia.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;fruitninjia.conf nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>网页访问</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;10.0.0.11:80<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n"},{"title":"Docker系列(零)-Docker介绍","date":"2021-06-28T08:06:37.000Z","_content":"\n# 一、容器简介\n\n容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁。\n\n隔离环境拥有自己的系统文件，ip地址，主机名等。\n\n## 1.1 容器和虚拟化的区别\n\nKVM虚拟化：\n\n需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）\n\n开机启动流程\n\nbios开机硬件自检\n\n根据bios设置的优先启动项boot\n\n读取mbr/gpt引导，读取mbr硬盘分区信息，内核加载路径\n\n加载内核\n\n启动第一个进程（C6：/sbin/init，C7：systemd）\n\n系统初始化完成\n\n运行服务\n\n容器：\n\n不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）\n\n容器的第一个进程直接运行服务，损耗少，启动快，性能高\n\n \n\n## 1.2 容器的优缺点：\n\n优点：\n\n与宿主机使用同一个内核，性能损耗小\n\n不需要指令级模拟\n\n容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制\n\n避免了准虚拟化和系统调用替换中的复杂性\n\n轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享\n\n缺点：\n\n使用同一内核，存在安全性问题\n\n \n\n## 1.3 容器技术的发展过程\n\nchroot --- lxc ---- docker\n\n \n\n# 二、Docker安装\n\n\\# 添加docker安装源 \n\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \n\n查看所有仓库中docker版本，并选择特定版本安装：(此处我们查看社区版 docker-ce) yum list docker-ce --showduplicates | sort -r # 安装docker-ce yum install docker-ce -y\n\n \n\n# 三、Docker镜像的常用命令\n\n\\# 搜索镜像docker search [镜像名称]# 拉取镜像docker pull [域名镜像名称]:[版本号]例如：docker pull daocloud.io/hzc/alpine:3.6 # 默认拉取Lastest最新版PS: docker image pull = docker pull# 如何查看镜像有那些版本？dockerhub网页搜索 daocloud 国内的dockhub# 镜像加速：（1）阿里云docker镜像加速器服务（2）配置docker镜像加速(推荐) vi /etc/docker/daemon.json {   \"registry-mirrors\":[“https://registry.docker-cn.com”] } systemctl daemon-reload# 上传镜像docker push [镜像名称]# 查看已有镜像docker images = docker image ls# 导出镜像docker image save alpine:latest -o docker_alpine.tar.gz # save跟export选哪个？都是导出镜像，但是export没带版本标签，export弃用# 导入镜像docker image load -i docker_alpine.tar.gz # load跟import选哪个？都是导入镜像，load对应save，import不带版本标签，import弃用# 删除镜像docker image rm alpine:3.6# 构建镜像docker image build# 查看构建镜像用到的历史命令docker image histroy# 查看镜像的详细属性docker image inspect# 批量删除镜像docker image prune# 给镜像打标签docker image tag [镜像ID] oldboy:v1 # Docker的容器管理1、查看容器列表 docker container ls -a docker ps # 默认只查看活着的容器 docker ps -a # 查看所有容器 docker ps -a -q # 静默输出，显示所有容器的ID docker ps -a -l docker ps -a -l --no-trunc # 查看完整命令（不隐藏）# 停止容器docker container stop [容器ID] docker container kill [容器ID]# 恢复容器 docker container start 【容器ID】# 启动容器 docker run -d -p 80:80 nginx:latest run 创建并运行一个容器 -d   放在后台运行 -p 端口映射 -v 源地址(宿主机)：目标地址(容器) docker run -it --name centos6 centos:6.9 /bin/bash -it 分配交互式的终端 --name 制定容器的名称 /bin/sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖※进入容器（调试、排错）docker exec - it [容器名称/ID] /bin/bash docker attach 【容器名称/ID】 (使用同一个终端)临时退出容器：ctrl +p和ctrl + q退出# 删除容器docker container rm [容器ID] docker rm [容器ID]如何批量删除容器：docker rm `docker ps -a -q`\n\n \n\n**总结：**\n\ndocker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。\n\n业务在容器中运行：前台运行夯住，启动服务\n\n \n\n# 四、 Docker的网络访问\n\n## 4.1 容器网络访问流程\n\n实际上是端口映射，docker容器有自己的ip，需要靠宿主机NAT上网 \n\n \n\n \n\n -p设置自动端口映射，在iptables中有增的Chain Docker, 也可以手动设置NAT\n\n查看当前设置的nat：iptables -t nat -L -n\n\n \n\n## 4.2 容器网络访问注意事项：\n\nsysctl -a | grep ipv4 | grep forward \n\n查看\n\nnet.ipv4.ip_forward = 1 # 为1时，docker容器才能上网，虚拟机挂起将使他变成0\n\n解决方法:\n\n1、sysctl net.ipv4.ip_forward = 1 设置为1\n\n2、不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1\n\n \n\n## 4.3 指定映射(-p)参数详解\n\n-p hostPort:containerPort # 指定端口 -p ip:hostPort:containerPort # 指定ip+端口 -p ip::containerPort # 指定随机端口 -p 10.0.0.100:53:udp # 指定随机端口 + udp -p hostPort:containerPort -p hostPort:containerPort # 指定多个端口\n\n# 五、容器的数据卷挂载\n\n## 5.1 临时挂载\n\n\\# 将/opt/xiaoniao目录挂载到容器的html目录 docker run -d -p 80:80 -v /opt/xiaoniao:/usr/share/nginx/html nginx:latest\n\n## 5.2 持久化挂载\n\n容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中\n\n\\# 创建名为oldboy的容器卷并挂载到容器html目录 docker run -d -p 80:80 -v oldboy:/usr/share/nginx/html nginx:latest # 查看当前有哪些容器卷 docker volume ls # 查看名为oldboy的卷的信息 docker volume inspect oldboy # PS：删除容器并删除卷，无法将卷删除 docker rm -f -v [容器ID]   -v --volume\n\n# 六、小案例练习\n\n\\>> 基于Nginx多端点的多站点 基于nginx启动一个容器，监听80和81，访问80，出现nginx默认的欢迎首页，访问81，出现小鸟页面。\n\n# 七、如何制作Docker镜像\n\n## 7.1 启动一个基础的容器\n\ndocker run -it centos:6.9 # yum docker run -it alpine:3.9 # apk\n\n## 7.2 容器中安装服务\n\n\\# dns重定向 echo '192.168.15.84 mirrors.aliyun.com' >> /etc/hosts # 替换源为阿里源 curl -o /etc/yum.repo.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/CentOS-6.repo # 安装并启动openssh服务 yum install openssh-server -y service opensshd restart # 修改root密码 echo '123456' | passwd --stdin root 或者 echo 123456:root | chpassw\n\n7.3 把已经安装服务的容器打包成镜像\n\ndocker contanier commit 5617e5d123432 centos6.9_ssh:v1\n\n## 7.4 测试镜像的功能\n\n\\# 使用镜像启动一个新容器,并开启ssh服务 docker run -d -p 1022:22 centos6.9_ssh:v1 tail -f /usr/sbin/sshd -D\n\n## 7.5 创建一个ssh + nginx双服务的镜像\n\n(1) 启动一个基础容器 docker yun -it -p 80:80 -p 1023:22 centos6.9_ssh:v1 /bin/bash (2) 在容器中安装服务(hosts与repo源在新容器会重新挂载) # dns重定向 echo '192.168.15.84 mirrors.aliyun.com' >> /etc/hosts # 替换源为阿里源 curl -o /etc/yum.repo.d/epel.repo https://mirrors.aliyun.com/repo/epel.repo # 安装nginx服务 yum install nginx -y (3) 把已经安装好服务的容器，提交为镜像 docker commit e6a6dsa6 centos6.9_ssh_nginx:v2 (4) 测试镜像功能 vim init.sh >>>>> #!/bin/bash service sshd restart nginx -g 'daemon off;' >>>>> # 启动镜像，执行脚本：开启服务，并夯住 docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 /bin/bash /init.sh\n\n### 7.6 自定义容器镜像的密码\n\n\\# 修改脚本，添加密码相关的脚本行，见右图 vim init.sh # 启动容器，并附带环境变量 docker run -d -p 1025:22 -p 80:80 -e \"SSH_PWD=123456\" centos6.9_ssh_nginx:v2 /bin/bash /init.sh\n\n \n\n \n\n###  \n\n \n\n \n\n### 7.7 作业\n\n制作基于centos6的lnmp架构的镜像，discuz论坛\n\n怎么夯住？\n\n启动所有需要的服务\n\n最后tail -F (大F无论文件有没有) \n\n#  \n\n# 八、Dockfile的使用\n\n发布镜像太大了，而dockerfile只有几kb，使用dockfile文件可以构建出相同的镜像，\n\n## 8.1 使用dockfile自动构建镜像\n\n自动构建镜像的步骤：\n\n1、手动构建一遍\n\n2、参考历史命令，编写dockerfile\n\n3、构建镜像\n\ndockerfile build -t centos6.9_ssh .\n\n4、测试\n\n## 8.2 Dockerfile常用命令详解\n\n \n\n \n","source":"_posts/01_运维/03-Docker/Docker系列-零-Docker介绍.md","raw":"---\ntitle: Docker系列(零)-Docker介绍\ndate: 2021-06-28 16:06:37\ncategories:\n- 运维\n- （三）Docker\ntags:\n---\n\n# 一、容器简介\n\n容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁。\n\n隔离环境拥有自己的系统文件，ip地址，主机名等。\n\n## 1.1 容器和虚拟化的区别\n\nKVM虚拟化：\n\n需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）\n\n开机启动流程\n\nbios开机硬件自检\n\n根据bios设置的优先启动项boot\n\n读取mbr/gpt引导，读取mbr硬盘分区信息，内核加载路径\n\n加载内核\n\n启动第一个进程（C6：/sbin/init，C7：systemd）\n\n系统初始化完成\n\n运行服务\n\n容器：\n\n不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）\n\n容器的第一个进程直接运行服务，损耗少，启动快，性能高\n\n \n\n## 1.2 容器的优缺点：\n\n优点：\n\n与宿主机使用同一个内核，性能损耗小\n\n不需要指令级模拟\n\n容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制\n\n避免了准虚拟化和系统调用替换中的复杂性\n\n轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享\n\n缺点：\n\n使用同一内核，存在安全性问题\n\n \n\n## 1.3 容器技术的发展过程\n\nchroot --- lxc ---- docker\n\n \n\n# 二、Docker安装\n\n\\# 添加docker安装源 \n\nyum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \n\n查看所有仓库中docker版本，并选择特定版本安装：(此处我们查看社区版 docker-ce) yum list docker-ce --showduplicates | sort -r # 安装docker-ce yum install docker-ce -y\n\n \n\n# 三、Docker镜像的常用命令\n\n\\# 搜索镜像docker search [镜像名称]# 拉取镜像docker pull [域名镜像名称]:[版本号]例如：docker pull daocloud.io/hzc/alpine:3.6 # 默认拉取Lastest最新版PS: docker image pull = docker pull# 如何查看镜像有那些版本？dockerhub网页搜索 daocloud 国内的dockhub# 镜像加速：（1）阿里云docker镜像加速器服务（2）配置docker镜像加速(推荐) vi /etc/docker/daemon.json {   \"registry-mirrors\":[“https://registry.docker-cn.com”] } systemctl daemon-reload# 上传镜像docker push [镜像名称]# 查看已有镜像docker images = docker image ls# 导出镜像docker image save alpine:latest -o docker_alpine.tar.gz # save跟export选哪个？都是导出镜像，但是export没带版本标签，export弃用# 导入镜像docker image load -i docker_alpine.tar.gz # load跟import选哪个？都是导入镜像，load对应save，import不带版本标签，import弃用# 删除镜像docker image rm alpine:3.6# 构建镜像docker image build# 查看构建镜像用到的历史命令docker image histroy# 查看镜像的详细属性docker image inspect# 批量删除镜像docker image prune# 给镜像打标签docker image tag [镜像ID] oldboy:v1 # Docker的容器管理1、查看容器列表 docker container ls -a docker ps # 默认只查看活着的容器 docker ps -a # 查看所有容器 docker ps -a -q # 静默输出，显示所有容器的ID docker ps -a -l docker ps -a -l --no-trunc # 查看完整命令（不隐藏）# 停止容器docker container stop [容器ID] docker container kill [容器ID]# 恢复容器 docker container start 【容器ID】# 启动容器 docker run -d -p 80:80 nginx:latest run 创建并运行一个容器 -d   放在后台运行 -p 端口映射 -v 源地址(宿主机)：目标地址(容器) docker run -it --name centos6 centos:6.9 /bin/bash -it 分配交互式的终端 --name 制定容器的名称 /bin/sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖※进入容器（调试、排错）docker exec - it [容器名称/ID] /bin/bash docker attach 【容器名称/ID】 (使用同一个终端)临时退出容器：ctrl +p和ctrl + q退出# 删除容器docker container rm [容器ID] docker rm [容器ID]如何批量删除容器：docker rm `docker ps -a -q`\n\n \n\n**总结：**\n\ndocker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。\n\n业务在容器中运行：前台运行夯住，启动服务\n\n \n\n# 四、 Docker的网络访问\n\n## 4.1 容器网络访问流程\n\n实际上是端口映射，docker容器有自己的ip，需要靠宿主机NAT上网 \n\n \n\n \n\n -p设置自动端口映射，在iptables中有增的Chain Docker, 也可以手动设置NAT\n\n查看当前设置的nat：iptables -t nat -L -n\n\n \n\n## 4.2 容器网络访问注意事项：\n\nsysctl -a | grep ipv4 | grep forward \n\n查看\n\nnet.ipv4.ip_forward = 1 # 为1时，docker容器才能上网，虚拟机挂起将使他变成0\n\n解决方法:\n\n1、sysctl net.ipv4.ip_forward = 1 设置为1\n\n2、不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1\n\n \n\n## 4.3 指定映射(-p)参数详解\n\n-p hostPort:containerPort # 指定端口 -p ip:hostPort:containerPort # 指定ip+端口 -p ip::containerPort # 指定随机端口 -p 10.0.0.100:53:udp # 指定随机端口 + udp -p hostPort:containerPort -p hostPort:containerPort # 指定多个端口\n\n# 五、容器的数据卷挂载\n\n## 5.1 临时挂载\n\n\\# 将/opt/xiaoniao目录挂载到容器的html目录 docker run -d -p 80:80 -v /opt/xiaoniao:/usr/share/nginx/html nginx:latest\n\n## 5.2 持久化挂载\n\n容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中\n\n\\# 创建名为oldboy的容器卷并挂载到容器html目录 docker run -d -p 80:80 -v oldboy:/usr/share/nginx/html nginx:latest # 查看当前有哪些容器卷 docker volume ls # 查看名为oldboy的卷的信息 docker volume inspect oldboy # PS：删除容器并删除卷，无法将卷删除 docker rm -f -v [容器ID]   -v --volume\n\n# 六、小案例练习\n\n\\>> 基于Nginx多端点的多站点 基于nginx启动一个容器，监听80和81，访问80，出现nginx默认的欢迎首页，访问81，出现小鸟页面。\n\n# 七、如何制作Docker镜像\n\n## 7.1 启动一个基础的容器\n\ndocker run -it centos:6.9 # yum docker run -it alpine:3.9 # apk\n\n## 7.2 容器中安装服务\n\n\\# dns重定向 echo '192.168.15.84 mirrors.aliyun.com' >> /etc/hosts # 替换源为阿里源 curl -o /etc/yum.repo.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/CentOS-6.repo # 安装并启动openssh服务 yum install openssh-server -y service opensshd restart # 修改root密码 echo '123456' | passwd --stdin root 或者 echo 123456:root | chpassw\n\n7.3 把已经安装服务的容器打包成镜像\n\ndocker contanier commit 5617e5d123432 centos6.9_ssh:v1\n\n## 7.4 测试镜像的功能\n\n\\# 使用镜像启动一个新容器,并开启ssh服务 docker run -d -p 1022:22 centos6.9_ssh:v1 tail -f /usr/sbin/sshd -D\n\n## 7.5 创建一个ssh + nginx双服务的镜像\n\n(1) 启动一个基础容器 docker yun -it -p 80:80 -p 1023:22 centos6.9_ssh:v1 /bin/bash (2) 在容器中安装服务(hosts与repo源在新容器会重新挂载) # dns重定向 echo '192.168.15.84 mirrors.aliyun.com' >> /etc/hosts # 替换源为阿里源 curl -o /etc/yum.repo.d/epel.repo https://mirrors.aliyun.com/repo/epel.repo # 安装nginx服务 yum install nginx -y (3) 把已经安装好服务的容器，提交为镜像 docker commit e6a6dsa6 centos6.9_ssh_nginx:v2 (4) 测试镜像功能 vim init.sh >>>>> #!/bin/bash service sshd restart nginx -g 'daemon off;' >>>>> # 启动镜像，执行脚本：开启服务，并夯住 docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 /bin/bash /init.sh\n\n### 7.6 自定义容器镜像的密码\n\n\\# 修改脚本，添加密码相关的脚本行，见右图 vim init.sh # 启动容器，并附带环境变量 docker run -d -p 1025:22 -p 80:80 -e \"SSH_PWD=123456\" centos6.9_ssh_nginx:v2 /bin/bash /init.sh\n\n \n\n \n\n###  \n\n \n\n \n\n### 7.7 作业\n\n制作基于centos6的lnmp架构的镜像，discuz论坛\n\n怎么夯住？\n\n启动所有需要的服务\n\n最后tail -F (大F无论文件有没有) \n\n#  \n\n# 八、Dockfile的使用\n\n发布镜像太大了，而dockerfile只有几kb，使用dockfile文件可以构建出相同的镜像，\n\n## 8.1 使用dockfile自动构建镜像\n\n自动构建镜像的步骤：\n\n1、手动构建一遍\n\n2、参考历史命令，编写dockerfile\n\n3、构建镜像\n\ndockerfile build -t centos6.9_ssh .\n\n4、测试\n\n## 8.2 Dockerfile常用命令详解\n\n \n\n \n","slug":"01_运维/03-Docker/Docker系列-零-Docker介绍","published":1,"updated":"2022-07-06T07:19:24.402Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0w001sa8v7aovi4ut0","content":"<h1 id=\"一、容器简介\"><a href=\"#一、容器简介\" class=\"headerlink\" title=\"一、容器简介\"></a>一、容器简介</h1><p>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁。</p>\n<p>隔离环境拥有自己的系统文件，ip地址，主机名等。</p>\n<h2 id=\"1-1-容器和虚拟化的区别\"><a href=\"#1-1-容器和虚拟化的区别\" class=\"headerlink\" title=\"1.1 容器和虚拟化的区别\"></a>1.1 容器和虚拟化的区别</h2><p>KVM虚拟化：</p>\n<p>需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）</p>\n<p>开机启动流程</p>\n<p>bios开机硬件自检</p>\n<p>根据bios设置的优先启动项boot</p>\n<p>读取mbr&#x2F;gpt引导，读取mbr硬盘分区信息，内核加载路径</p>\n<p>加载内核</p>\n<p>启动第一个进程（C6：&#x2F;sbin&#x2F;init，C7：systemd）</p>\n<p>系统初始化完成</p>\n<p>运行服务</p>\n<p>容器：</p>\n<p>不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）</p>\n<p>容器的第一个进程直接运行服务，损耗少，启动快，性能高</p>\n<h2 id=\"1-2-容器的优缺点：\"><a href=\"#1-2-容器的优缺点：\" class=\"headerlink\" title=\"1.2 容器的优缺点：\"></a>1.2 容器的优缺点：</h2><p>优点：</p>\n<p>与宿主机使用同一个内核，性能损耗小</p>\n<p>不需要指令级模拟</p>\n<p>容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制</p>\n<p>避免了准虚拟化和系统调用替换中的复杂性</p>\n<p>轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享</p>\n<p>缺点：</p>\n<p>使用同一内核，存在安全性问题</p>\n<h2 id=\"1-3-容器技术的发展过程\"><a href=\"#1-3-容器技术的发展过程\" class=\"headerlink\" title=\"1.3 容器技术的发展过程\"></a>1.3 容器技术的发展过程</h2><p>chroot — lxc —- docker</p>\n<h1 id=\"二、Docker安装\"><a href=\"#二、Docker安装\" class=\"headerlink\" title=\"二、Docker安装\"></a>二、Docker安装</h1><p># 添加docker安装源 </p>\n<p>yum-config-manager –add-repo <a href=\"http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a> </p>\n<p>查看所有仓库中docker版本，并选择特定版本安装：(此处我们查看社区版 docker-ce) yum list docker-ce –showduplicates | sort -r # 安装docker-ce yum install docker-ce -y</p>\n<h1 id=\"三、Docker镜像的常用命令\"><a href=\"#三、Docker镜像的常用命令\" class=\"headerlink\" title=\"三、Docker镜像的常用命令\"></a>三、Docker镜像的常用命令</h1><p># 搜索镜像docker search [镜像名称]# 拉取镜像docker pull [域名镜像名称]:[版本号]例如：docker pull daocloud.io&#x2F;hzc&#x2F;alpine:3.6 # 默认拉取Lastest最新版PS: docker image pull &#x3D; docker pull# 如何查看镜像有那些版本？dockerhub网页搜索 daocloud 国内的dockhub# 镜像加速：（1）阿里云docker镜像加速器服务（2）配置docker镜像加速(推荐) vi &#x2F;etc&#x2F;docker&#x2F;daemon.json {   “registry-mirrors”:[“<a href=\"https://registry.docker-cn.com”]\">https://registry.docker-cn.com”]</a> } systemctl daemon-reload# 上传镜像docker push [镜像名称]# 查看已有镜像docker images &#x3D; docker image ls# 导出镜像docker image save alpine:latest -o docker_alpine.tar.gz # save跟export选哪个？都是导出镜像，但是export没带版本标签，export弃用# 导入镜像docker image load -i docker_alpine.tar.gz # load跟import选哪个？都是导入镜像，load对应save，import不带版本标签，import弃用# 删除镜像docker image rm alpine:3.6# 构建镜像docker image build# 查看构建镜像用到的历史命令docker image histroy# 查看镜像的详细属性docker image inspect# 批量删除镜像docker image prune# 给镜像打标签docker image tag [镜像ID] oldboy:v1 # Docker的容器管理1、查看容器列表 docker container ls -a docker ps # 默认只查看活着的容器 docker ps -a # 查看所有容器 docker ps -a -q # 静默输出，显示所有容器的ID docker ps -a -l docker ps -a -l –no-trunc # 查看完整命令（不隐藏）# 停止容器docker container stop [容器ID] docker container kill [容器ID]# 恢复容器 docker container start 【容器ID】# 启动容器 docker run -d -p 80:80 nginx:latest run 创建并运行一个容器 -d   放在后台运行 -p 端口映射 -v 源地址(宿主机)：目标地址(容器) docker run -it –name centos6 centos:6.9 &#x2F;bin&#x2F;bash -it 分配交互式的终端 –name 制定容器的名称 &#x2F;bin&#x2F;sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖※进入容器（调试、排错）docker exec - it [容器名称&#x2F;ID] &#x2F;bin&#x2F;bash docker attach 【容器名称&#x2F;ID】 (使用同一个终端)临时退出容器：ctrl +p和ctrl + q退出# 删除容器docker container rm [容器ID] docker rm [容器ID]如何批量删除容器：docker rm <code>docker ps -a -q</code></p>\n<p><strong>总结：</strong></p>\n<p>docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。</p>\n<p>业务在容器中运行：前台运行夯住，启动服务</p>\n<h1 id=\"四、-Docker的网络访问\"><a href=\"#四、-Docker的网络访问\" class=\"headerlink\" title=\"四、 Docker的网络访问\"></a>四、 Docker的网络访问</h1><h2 id=\"4-1-容器网络访问流程\"><a href=\"#4-1-容器网络访问流程\" class=\"headerlink\" title=\"4.1 容器网络访问流程\"></a>4.1 容器网络访问流程</h2><p>实际上是端口映射，docker容器有自己的ip，需要靠宿主机NAT上网 </p>\n<p> -p设置自动端口映射，在iptables中有增的Chain Docker, 也可以手动设置NAT</p>\n<p>查看当前设置的nat：iptables -t nat -L -n</p>\n<h2 id=\"4-2-容器网络访问注意事项：\"><a href=\"#4-2-容器网络访问注意事项：\" class=\"headerlink\" title=\"4.2 容器网络访问注意事项：\"></a>4.2 容器网络访问注意事项：</h2><p>sysctl -a | grep ipv4 | grep forward </p>\n<p>查看</p>\n<p>net.ipv4.ip_forward &#x3D; 1 # 为1时，docker容器才能上网，虚拟机挂起将使他变成0</p>\n<p>解决方法:</p>\n<p>1、sysctl net.ipv4.ip_forward &#x3D; 1 设置为1</p>\n<p>2、不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1</p>\n<h2 id=\"4-3-指定映射-p-参数详解\"><a href=\"#4-3-指定映射-p-参数详解\" class=\"headerlink\" title=\"4.3 指定映射(-p)参数详解\"></a>4.3 指定映射(-p)参数详解</h2><p>-p hostPort:containerPort # 指定端口 -p ip:hostPort:containerPort # 指定ip+端口 -p ip::containerPort # 指定随机端口 -p 10.0.0.100:53:udp # 指定随机端口 + udp -p hostPort:containerPort -p hostPort:containerPort # 指定多个端口</p>\n<h1 id=\"五、容器的数据卷挂载\"><a href=\"#五、容器的数据卷挂载\" class=\"headerlink\" title=\"五、容器的数据卷挂载\"></a>五、容器的数据卷挂载</h1><h2 id=\"5-1-临时挂载\"><a href=\"#5-1-临时挂载\" class=\"headerlink\" title=\"5.1 临时挂载\"></a>5.1 临时挂载</h2><p># 将&#x2F;opt&#x2F;xiaoniao目录挂载到容器的html目录 docker run -d -p 80:80 -v &#x2F;opt&#x2F;xiaoniao:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest</p>\n<h2 id=\"5-2-持久化挂载\"><a href=\"#5-2-持久化挂载\" class=\"headerlink\" title=\"5.2 持久化挂载\"></a>5.2 持久化挂载</h2><p>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中</p>\n<p># 创建名为oldboy的容器卷并挂载到容器html目录 docker run -d -p 80:80 -v oldboy:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest # 查看当前有哪些容器卷 docker volume ls # 查看名为oldboy的卷的信息 docker volume inspect oldboy # PS：删除容器并删除卷，无法将卷删除 docker rm -f -v [容器ID]   -v –volume</p>\n<h1 id=\"六、小案例练习\"><a href=\"#六、小案例练习\" class=\"headerlink\" title=\"六、小案例练习\"></a>六、小案例练习</h1><p>&gt;&gt; 基于Nginx多端点的多站点 基于nginx启动一个容器，监听80和81，访问80，出现nginx默认的欢迎首页，访问81，出现小鸟页面。</p>\n<h1 id=\"七、如何制作Docker镜像\"><a href=\"#七、如何制作Docker镜像\" class=\"headerlink\" title=\"七、如何制作Docker镜像\"></a>七、如何制作Docker镜像</h1><h2 id=\"7-1-启动一个基础的容器\"><a href=\"#7-1-启动一个基础的容器\" class=\"headerlink\" title=\"7.1 启动一个基础的容器\"></a>7.1 启动一个基础的容器</h2><p>docker run -it centos:6.9 # yum docker run -it alpine:3.9 # apk</p>\n<h2 id=\"7-2-容器中安装服务\"><a href=\"#7-2-容器中安装服务\" class=\"headerlink\" title=\"7.2 容器中安装服务\"></a>7.2 容器中安装服务</h2><p># dns重定向 echo ‘192.168.15.84 mirrors.aliyun.com’ &gt;&gt; &#x2F;etc&#x2F;hosts # 替换源为阿里源 curl -o &#x2F;etc&#x2F;yum.repo.d&#x2F;CentOS-Base.repo <a href=\"https://mirrors.aliyun.com/repo/CentOS-6.repo\">https://mirrors.aliyun.com/repo/CentOS-6.repo</a> # 安装并启动openssh服务 yum install openssh-server -y service opensshd restart # 修改root密码 echo ‘123456’ | passwd –stdin root 或者 echo 123456:root | chpassw</p>\n<p>7.3 把已经安装服务的容器打包成镜像</p>\n<p>docker contanier commit 5617e5d123432 centos6.9_ssh:v1</p>\n<h2 id=\"7-4-测试镜像的功能\"><a href=\"#7-4-测试镜像的功能\" class=\"headerlink\" title=\"7.4 测试镜像的功能\"></a>7.4 测试镜像的功能</h2><p># 使用镜像启动一个新容器,并开启ssh服务 docker run -d -p 1022:22 centos6.9_ssh:v1 tail -f &#x2F;usr&#x2F;sbin&#x2F;sshd -D</p>\n<h2 id=\"7-5-创建一个ssh-nginx双服务的镜像\"><a href=\"#7-5-创建一个ssh-nginx双服务的镜像\" class=\"headerlink\" title=\"7.5 创建一个ssh + nginx双服务的镜像\"></a>7.5 创建一个ssh + nginx双服务的镜像</h2><p>(1) 启动一个基础容器 docker yun -it -p 80:80 -p 1023:22 centos6.9_ssh:v1 &#x2F;bin&#x2F;bash (2) 在容器中安装服务(hosts与repo源在新容器会重新挂载) # dns重定向 echo ‘192.168.15.84 mirrors.aliyun.com’ &gt;&gt; &#x2F;etc&#x2F;hosts # 替换源为阿里源 curl -o &#x2F;etc&#x2F;yum.repo.d&#x2F;epel.repo <a href=\"https://mirrors.aliyun.com/repo/epel.repo\">https://mirrors.aliyun.com/repo/epel.repo</a> # 安装nginx服务 yum install nginx -y (3) 把已经安装好服务的容器，提交为镜像 docker commit e6a6dsa6 centos6.9_ssh_nginx:v2 (4) 测试镜像功能 vim init.sh &gt;&gt;&gt;&gt;&gt; #!&#x2F;bin&#x2F;bash service sshd restart nginx -g ‘daemon off;’ &gt;&gt;&gt;&gt;&gt; # 启动镜像，执行脚本：开启服务，并夯住 docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;init.sh</p>\n<h3 id=\"7-6-自定义容器镜像的密码\"><a href=\"#7-6-自定义容器镜像的密码\" class=\"headerlink\" title=\"7.6 自定义容器镜像的密码\"></a>7.6 自定义容器镜像的密码</h3><p># 修改脚本，添加密码相关的脚本行，见右图 vim init.sh # 启动容器，并附带环境变量 docker run -d -p 1025:22 -p 80:80 -e “SSH_PWD&#x3D;123456” centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;init.sh</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h3 id=\"7-7-作业\"><a href=\"#7-7-作业\" class=\"headerlink\" title=\"7.7 作业\"></a>7.7 作业</h3><p>制作基于centos6的lnmp架构的镜像，discuz论坛</p>\n<p>怎么夯住？</p>\n<p>启动所有需要的服务</p>\n<p>最后tail -F (大F无论文件有没有) </p>\n<h1 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h1><h1 id=\"八、Dockfile的使用\"><a href=\"#八、Dockfile的使用\" class=\"headerlink\" title=\"八、Dockfile的使用\"></a>八、Dockfile的使用</h1><p>发布镜像太大了，而dockerfile只有几kb，使用dockfile文件可以构建出相同的镜像，</p>\n<h2 id=\"8-1-使用dockfile自动构建镜像\"><a href=\"#8-1-使用dockfile自动构建镜像\" class=\"headerlink\" title=\"8.1 使用dockfile自动构建镜像\"></a>8.1 使用dockfile自动构建镜像</h2><p>自动构建镜像的步骤：</p>\n<p>1、手动构建一遍</p>\n<p>2、参考历史命令，编写dockerfile</p>\n<p>3、构建镜像</p>\n<p>dockerfile build -t centos6.9_ssh .</p>\n<p>4、测试</p>\n<h2 id=\"8-2-Dockerfile常用命令详解\"><a href=\"#8-2-Dockerfile常用命令详解\" class=\"headerlink\" title=\"8.2 Dockerfile常用命令详解\"></a>8.2 Dockerfile常用命令详解</h2>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"一、容器简介\"><a href=\"#一、容器简介\" class=\"headerlink\" title=\"一、容器简介\"></a>一、容器简介</h1><p>容器就是在隔离环境中运行一个进程，如果进程停止，容器就会销毁。</p>\n<p>隔离环境拥有自己的系统文件，ip地址，主机名等。</p>\n<h2 id=\"1-1-容器和虚拟化的区别\"><a href=\"#1-1-容器和虚拟化的区别\" class=\"headerlink\" title=\"1.1 容器和虚拟化的区别\"></a>1.1 容器和虚拟化的区别</h2><p>KVM虚拟化：</p>\n<p>需要硬件的支持，需要模拟硬件，可以运行不同的操作系统，启动时间分钟级（有开机启动流程）</p>\n<p>开机启动流程</p>\n<p>bios开机硬件自检</p>\n<p>根据bios设置的优先启动项boot</p>\n<p>读取mbr&#x2F;gpt引导，读取mbr硬盘分区信息，内核加载路径</p>\n<p>加载内核</p>\n<p>启动第一个进程（C6：&#x2F;sbin&#x2F;init，C7：systemd）</p>\n<p>系统初始化完成</p>\n<p>运行服务</p>\n<p>容器：</p>\n<p>不需要硬件的支持，不需要模拟硬件，公用宿主机内核，启动时间秒级（没有开机启动流程）</p>\n<p>容器的第一个进程直接运行服务，损耗少，启动快，性能高</p>\n<h2 id=\"1-2-容器的优缺点：\"><a href=\"#1-2-容器的优缺点：\" class=\"headerlink\" title=\"1.2 容器的优缺点：\"></a>1.2 容器的优缺点：</h2><p>优点：</p>\n<p>与宿主机使用同一个内核，性能损耗小</p>\n<p>不需要指令级模拟</p>\n<p>容器可以再cpu核心的本地运行指令，不需要任何专门的解释机制</p>\n<p>避免了准虚拟化和系统调用替换中的复杂性</p>\n<p>轻量级隔离，在隔离的同事还提供共享机制，以实现容器与宿主机的资源共享</p>\n<p>缺点：</p>\n<p>使用同一内核，存在安全性问题</p>\n<h2 id=\"1-3-容器技术的发展过程\"><a href=\"#1-3-容器技术的发展过程\" class=\"headerlink\" title=\"1.3 容器技术的发展过程\"></a>1.3 容器技术的发展过程</h2><p>chroot — lxc —- docker</p>\n<h1 id=\"二、Docker安装\"><a href=\"#二、Docker安装\" class=\"headerlink\" title=\"二、Docker安装\"></a>二、Docker安装</h1><p># 添加docker安装源 </p>\n<p>yum-config-manager –add-repo <a href=\"http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo\">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a> </p>\n<p>查看所有仓库中docker版本，并选择特定版本安装：(此处我们查看社区版 docker-ce) yum list docker-ce –showduplicates | sort -r # 安装docker-ce yum install docker-ce -y</p>\n<h1 id=\"三、Docker镜像的常用命令\"><a href=\"#三、Docker镜像的常用命令\" class=\"headerlink\" title=\"三、Docker镜像的常用命令\"></a>三、Docker镜像的常用命令</h1><p># 搜索镜像docker search [镜像名称]# 拉取镜像docker pull [域名镜像名称]:[版本号]例如：docker pull daocloud.io&#x2F;hzc&#x2F;alpine:3.6 # 默认拉取Lastest最新版PS: docker image pull &#x3D; docker pull# 如何查看镜像有那些版本？dockerhub网页搜索 daocloud 国内的dockhub# 镜像加速：（1）阿里云docker镜像加速器服务（2）配置docker镜像加速(推荐) vi &#x2F;etc&#x2F;docker&#x2F;daemon.json {   “registry-mirrors”:[“<a href=\"https://registry.docker-cn.com”]\">https://registry.docker-cn.com”]</a> } systemctl daemon-reload# 上传镜像docker push [镜像名称]# 查看已有镜像docker images &#x3D; docker image ls# 导出镜像docker image save alpine:latest -o docker_alpine.tar.gz # save跟export选哪个？都是导出镜像，但是export没带版本标签，export弃用# 导入镜像docker image load -i docker_alpine.tar.gz # load跟import选哪个？都是导入镜像，load对应save，import不带版本标签，import弃用# 删除镜像docker image rm alpine:3.6# 构建镜像docker image build# 查看构建镜像用到的历史命令docker image histroy# 查看镜像的详细属性docker image inspect# 批量删除镜像docker image prune# 给镜像打标签docker image tag [镜像ID] oldboy:v1 # Docker的容器管理1、查看容器列表 docker container ls -a docker ps # 默认只查看活着的容器 docker ps -a # 查看所有容器 docker ps -a -q # 静默输出，显示所有容器的ID docker ps -a -l docker ps -a -l –no-trunc # 查看完整命令（不隐藏）# 停止容器docker container stop [容器ID] docker container kill [容器ID]# 恢复容器 docker container start 【容器ID】# 启动容器 docker run -d -p 80:80 nginx:latest run 创建并运行一个容器 -d   放在后台运行 -p 端口映射 -v 源地址(宿主机)：目标地址(容器) docker run -it –name centos6 centos:6.9 &#x2F;bin&#x2F;bash -it 分配交互式的终端 –name 制定容器的名称 &#x2F;bin&#x2F;sh 容器执行的命令，每个进程默认有初始执行命令，可以覆盖※进入容器（调试、排错）docker exec - it [容器名称&#x2F;ID] &#x2F;bin&#x2F;bash docker attach 【容器名称&#x2F;ID】 (使用同一个终端)临时退出容器：ctrl +p和ctrl + q退出# 删除容器docker container rm [容器ID] docker rm [容器ID]如何批量删除容器：docker rm <code>docker ps -a -q</code></p>\n<p><strong>总结：</strong></p>\n<p>docker容器内的第一个进程（初始命令）必须一直处于前台运行的状态（必须夯住），否则这个容器，就会处于退出状态。</p>\n<p>业务在容器中运行：前台运行夯住，启动服务</p>\n<h1 id=\"四、-Docker的网络访问\"><a href=\"#四、-Docker的网络访问\" class=\"headerlink\" title=\"四、 Docker的网络访问\"></a>四、 Docker的网络访问</h1><h2 id=\"4-1-容器网络访问流程\"><a href=\"#4-1-容器网络访问流程\" class=\"headerlink\" title=\"4.1 容器网络访问流程\"></a>4.1 容器网络访问流程</h2><p>实际上是端口映射，docker容器有自己的ip，需要靠宿主机NAT上网 </p>\n<p> -p设置自动端口映射，在iptables中有增的Chain Docker, 也可以手动设置NAT</p>\n<p>查看当前设置的nat：iptables -t nat -L -n</p>\n<h2 id=\"4-2-容器网络访问注意事项：\"><a href=\"#4-2-容器网络访问注意事项：\" class=\"headerlink\" title=\"4.2 容器网络访问注意事项：\"></a>4.2 容器网络访问注意事项：</h2><p>sysctl -a | grep ipv4 | grep forward </p>\n<p>查看</p>\n<p>net.ipv4.ip_forward &#x3D; 1 # 为1时，docker容器才能上网，虚拟机挂起将使他变成0</p>\n<p>解决方法:</p>\n<p>1、sysctl net.ipv4.ip_forward &#x3D; 1 设置为1</p>\n<p>2、不要挂起虚拟机，直接关机重启，docker服务在启动时会将它改为1</p>\n<h2 id=\"4-3-指定映射-p-参数详解\"><a href=\"#4-3-指定映射-p-参数详解\" class=\"headerlink\" title=\"4.3 指定映射(-p)参数详解\"></a>4.3 指定映射(-p)参数详解</h2><p>-p hostPort:containerPort # 指定端口 -p ip:hostPort:containerPort # 指定ip+端口 -p ip::containerPort # 指定随机端口 -p 10.0.0.100:53:udp # 指定随机端口 + udp -p hostPort:containerPort -p hostPort:containerPort # 指定多个端口</p>\n<h1 id=\"五、容器的数据卷挂载\"><a href=\"#五、容器的数据卷挂载\" class=\"headerlink\" title=\"五、容器的数据卷挂载\"></a>五、容器的数据卷挂载</h1><h2 id=\"5-1-临时挂载\"><a href=\"#5-1-临时挂载\" class=\"headerlink\" title=\"5.1 临时挂载\"></a>5.1 临时挂载</h2><p># 将&#x2F;opt&#x2F;xiaoniao目录挂载到容器的html目录 docker run -d -p 80:80 -v &#x2F;opt&#x2F;xiaoniao:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest</p>\n<h2 id=\"5-2-持久化挂载\"><a href=\"#5-2-持久化挂载\" class=\"headerlink\" title=\"5.2 持久化挂载\"></a>5.2 持久化挂载</h2><p>容器被删除，创建的卷可以保留，可以再次挂载到新建的容器中</p>\n<p># 创建名为oldboy的容器卷并挂载到容器html目录 docker run -d -p 80:80 -v oldboy:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html nginx:latest # 查看当前有哪些容器卷 docker volume ls # 查看名为oldboy的卷的信息 docker volume inspect oldboy # PS：删除容器并删除卷，无法将卷删除 docker rm -f -v [容器ID]   -v –volume</p>\n<h1 id=\"六、小案例练习\"><a href=\"#六、小案例练习\" class=\"headerlink\" title=\"六、小案例练习\"></a>六、小案例练习</h1><p>&gt;&gt; 基于Nginx多端点的多站点 基于nginx启动一个容器，监听80和81，访问80，出现nginx默认的欢迎首页，访问81，出现小鸟页面。</p>\n<h1 id=\"七、如何制作Docker镜像\"><a href=\"#七、如何制作Docker镜像\" class=\"headerlink\" title=\"七、如何制作Docker镜像\"></a>七、如何制作Docker镜像</h1><h2 id=\"7-1-启动一个基础的容器\"><a href=\"#7-1-启动一个基础的容器\" class=\"headerlink\" title=\"7.1 启动一个基础的容器\"></a>7.1 启动一个基础的容器</h2><p>docker run -it centos:6.9 # yum docker run -it alpine:3.9 # apk</p>\n<h2 id=\"7-2-容器中安装服务\"><a href=\"#7-2-容器中安装服务\" class=\"headerlink\" title=\"7.2 容器中安装服务\"></a>7.2 容器中安装服务</h2><p># dns重定向 echo ‘192.168.15.84 mirrors.aliyun.com’ &gt;&gt; &#x2F;etc&#x2F;hosts # 替换源为阿里源 curl -o &#x2F;etc&#x2F;yum.repo.d&#x2F;CentOS-Base.repo <a href=\"https://mirrors.aliyun.com/repo/CentOS-6.repo\">https://mirrors.aliyun.com/repo/CentOS-6.repo</a> # 安装并启动openssh服务 yum install openssh-server -y service opensshd restart # 修改root密码 echo ‘123456’ | passwd –stdin root 或者 echo 123456:root | chpassw</p>\n<p>7.3 把已经安装服务的容器打包成镜像</p>\n<p>docker contanier commit 5617e5d123432 centos6.9_ssh:v1</p>\n<h2 id=\"7-4-测试镜像的功能\"><a href=\"#7-4-测试镜像的功能\" class=\"headerlink\" title=\"7.4 测试镜像的功能\"></a>7.4 测试镜像的功能</h2><p># 使用镜像启动一个新容器,并开启ssh服务 docker run -d -p 1022:22 centos6.9_ssh:v1 tail -f &#x2F;usr&#x2F;sbin&#x2F;sshd -D</p>\n<h2 id=\"7-5-创建一个ssh-nginx双服务的镜像\"><a href=\"#7-5-创建一个ssh-nginx双服务的镜像\" class=\"headerlink\" title=\"7.5 创建一个ssh + nginx双服务的镜像\"></a>7.5 创建一个ssh + nginx双服务的镜像</h2><p>(1) 启动一个基础容器 docker yun -it -p 80:80 -p 1023:22 centos6.9_ssh:v1 &#x2F;bin&#x2F;bash (2) 在容器中安装服务(hosts与repo源在新容器会重新挂载) # dns重定向 echo ‘192.168.15.84 mirrors.aliyun.com’ &gt;&gt; &#x2F;etc&#x2F;hosts # 替换源为阿里源 curl -o &#x2F;etc&#x2F;yum.repo.d&#x2F;epel.repo <a href=\"https://mirrors.aliyun.com/repo/epel.repo\">https://mirrors.aliyun.com/repo/epel.repo</a> # 安装nginx服务 yum install nginx -y (3) 把已经安装好服务的容器，提交为镜像 docker commit e6a6dsa6 centos6.9_ssh_nginx:v2 (4) 测试镜像功能 vim init.sh &gt;&gt;&gt;&gt;&gt; #!&#x2F;bin&#x2F;bash service sshd restart nginx -g ‘daemon off;’ &gt;&gt;&gt;&gt;&gt; # 启动镜像，执行脚本：开启服务，并夯住 docker run -d -p 1025:22 -p 80:80 centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;init.sh</p>\n<h3 id=\"7-6-自定义容器镜像的密码\"><a href=\"#7-6-自定义容器镜像的密码\" class=\"headerlink\" title=\"7.6 自定义容器镜像的密码\"></a>7.6 自定义容器镜像的密码</h3><p># 修改脚本，添加密码相关的脚本行，见右图 vim init.sh # 启动容器，并附带环境变量 docker run -d -p 1025:22 -p 80:80 -e “SSH_PWD&#x3D;123456” centos6.9_ssh_nginx:v2 &#x2F;bin&#x2F;bash &#x2F;init.sh</p>\n<h3 id=\"\"><a href=\"#\" class=\"headerlink\" title=\"\"></a></h3><h3 id=\"7-7-作业\"><a href=\"#7-7-作业\" class=\"headerlink\" title=\"7.7 作业\"></a>7.7 作业</h3><p>制作基于centos6的lnmp架构的镜像，discuz论坛</p>\n<p>怎么夯住？</p>\n<p>启动所有需要的服务</p>\n<p>最后tail -F (大F无论文件有没有) </p>\n<h1 id=\"-1\"><a href=\"#-1\" class=\"headerlink\" title=\"\"></a></h1><h1 id=\"八、Dockfile的使用\"><a href=\"#八、Dockfile的使用\" class=\"headerlink\" title=\"八、Dockfile的使用\"></a>八、Dockfile的使用</h1><p>发布镜像太大了，而dockerfile只有几kb，使用dockfile文件可以构建出相同的镜像，</p>\n<h2 id=\"8-1-使用dockfile自动构建镜像\"><a href=\"#8-1-使用dockfile自动构建镜像\" class=\"headerlink\" title=\"8.1 使用dockfile自动构建镜像\"></a>8.1 使用dockfile自动构建镜像</h2><p>自动构建镜像的步骤：</p>\n<p>1、手动构建一遍</p>\n<p>2、参考历史命令，编写dockerfile</p>\n<p>3、构建镜像</p>\n<p>dockerfile build -t centos6.9_ssh .</p>\n<p>4、测试</p>\n<h2 id=\"8-2-Dockerfile常用命令详解\"><a href=\"#8-2-Dockerfile常用命令详解\" class=\"headerlink\" title=\"8.2 Dockerfile常用命令详解\"></a>8.2 Dockerfile常用命令详解</h2>"},{"title":"01_MySQL数据库(一)","date":"2022-07-13T02:13:22.000Z","_content":"\n\n\n## 1 MySQL数据库的安装\n\n### 1.1 版本获取\n\n版本选择\n\n```shell\n目前用的较多的是5.6 / 5.7 / 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本\n```\n\nwindows版本下载地址\n\n```shell\nhttps://downloads.mysql.com/archives/installer/\n```\n\n![image-20220713102756709](../../../img/image-20220713102756709.png)\n\n### 1.2 安装\n\n\n\n\n\n## 2 数据库的基本操作\n\n","source":"_posts/03_Python/01_MySQL/01-MySQL数据库-一.md","raw":"---\ntitle: 01_MySQL数据库(一)\ndate: 2022-07-13 10:13:22\ncategories:\n- Python\n- MySQL\ntags:\n---\n\n\n\n## 1 MySQL数据库的安装\n\n### 1.1 版本获取\n\n版本选择\n\n```shell\n目前用的较多的是5.6 / 5.7 / 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本\n```\n\nwindows版本下载地址\n\n```shell\nhttps://downloads.mysql.com/archives/installer/\n```\n\n![image-20220713102756709](../../../img/image-20220713102756709.png)\n\n### 1.2 安装\n\n\n\n\n\n## 2 数据库的基本操作\n\n","slug":"03_Python/01_MySQL/01-MySQL数据库-一","published":1,"updated":"2022-07-18T07:00:41.197Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0x001ta8v7fx9h675g","content":"<h2 id=\"1-MySQL数据库的安装\"><a href=\"#1-MySQL数据库的安装\" class=\"headerlink\" title=\"1 MySQL数据库的安装\"></a>1 MySQL数据库的安装</h2><h3 id=\"1-1-版本获取\"><a href=\"#1-1-版本获取\" class=\"headerlink\" title=\"1.1 版本获取\"></a>1.1 版本获取</h3><p>版本选择</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">目前用的较多的是5.6 &#x2F; 5.7 &#x2F; 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>windows版本下载地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;downloads.mysql.com&#x2F;archives&#x2F;installer&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../../img/image-20220713102756709.png\" alt=\"image-20220713102756709\"></p>\n<h3 id=\"1-2-安装\"><a href=\"#1-2-安装\" class=\"headerlink\" title=\"1.2 安装\"></a>1.2 安装</h3><h2 id=\"2-数据库的基本操作\"><a href=\"#2-数据库的基本操作\" class=\"headerlink\" title=\"2 数据库的基本操作\"></a>2 数据库的基本操作</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-MySQL数据库的安装\"><a href=\"#1-MySQL数据库的安装\" class=\"headerlink\" title=\"1 MySQL数据库的安装\"></a>1 MySQL数据库的安装</h2><h3 id=\"1-1-版本获取\"><a href=\"#1-1-版本获取\" class=\"headerlink\" title=\"1.1 版本获取\"></a>1.1 版本获取</h3><p>版本选择</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">目前用的较多的是5.6 &#x2F; 5.7 &#x2F; 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>windows版本下载地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;downloads.mysql.com&#x2F;archives&#x2F;installer&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../../img/image-20220713102756709.png\" alt=\"image-20220713102756709\"></p>\n<h3 id=\"1-2-安装\"><a href=\"#1-2-安装\" class=\"headerlink\" title=\"1.2 安装\"></a>1.2 安装</h3><h2 id=\"2-数据库的基本操作\"><a href=\"#2-数据库的基本操作\" class=\"headerlink\" title=\"2 数据库的基本操作\"></a>2 数据库的基本操作</h2>"},{"title":"MySQL数据库(一)","date":"2022-07-13T02:13:22.000Z","_content":"\n\n\n## 1 MySQL数据库的安装\n\n### 1.1 版本获取\n\n版本选择\n\n```shell\n目前用的较多的是5.6 / 5.7 / 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本\n```\n\nwindows版本下载地址\n\n```shell\nhttps://downloads.mysql.com/archives/installer/\n```\n\n![image-20220713102756709](../../../img/image-20220713102756709.png)\n\n### 1.2 安装\n\n\n\n\n\n## 2 数据库的基本操作\n\n","source":"_posts/03_Python/01_MySQL/01_MySQL数据库-一.md","raw":"---\ntitle: MySQL数据库(一)\ndate: 2022-07-13 10:13:22\ncategories:\n- Python\n- MySQL\ntags:\n---\n\n\n\n## 1 MySQL数据库的安装\n\n### 1.1 版本获取\n\n版本选择\n\n```shell\n目前用的较多的是5.6 / 5.7 / 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本\n```\n\nwindows版本下载地址\n\n```shell\nhttps://downloads.mysql.com/archives/installer/\n```\n\n![image-20220713102756709](../../../img/image-20220713102756709.png)\n\n### 1.2 安装\n\n\n\n\n\n## 2 数据库的基本操作\n\n","slug":"03_Python/01_MySQL/01_MySQL数据库-一","published":1,"updated":"2022-07-18T07:10:19.366Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k0y001va8v78szggkma","content":"<h2 id=\"1-MySQL数据库的安装\"><a href=\"#1-MySQL数据库的安装\" class=\"headerlink\" title=\"1 MySQL数据库的安装\"></a>1 MySQL数据库的安装</h2><h3 id=\"1-1-版本获取\"><a href=\"#1-1-版本获取\" class=\"headerlink\" title=\"1.1 版本获取\"></a>1.1 版本获取</h3><p>版本选择</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">目前用的较多的是5.6 &#x2F; 5.7 &#x2F; 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>windows版本下载地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;downloads.mysql.com&#x2F;archives&#x2F;installer&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../../img/image-20220713102756709.png\" alt=\"image-20220713102756709\"></p>\n<h3 id=\"1-2-安装\"><a href=\"#1-2-安装\" class=\"headerlink\" title=\"1.2 安装\"></a>1.2 安装</h3><h2 id=\"2-数据库的基本操作\"><a href=\"#2-数据库的基本操作\" class=\"headerlink\" title=\"2 数据库的基本操作\"></a>2 数据库的基本操作</h2>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-MySQL数据库的安装\"><a href=\"#1-MySQL数据库的安装\" class=\"headerlink\" title=\"1 MySQL数据库的安装\"></a>1 MySQL数据库的安装</h2><h3 id=\"1-1-版本获取\"><a href=\"#1-1-版本获取\" class=\"headerlink\" title=\"1.1 版本获取\"></a>1.1 版本获取</h3><p>版本选择</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">目前用的较多的是5.6 &#x2F; 5.7 &#x2F; 8.0 三个版本\n生产环境大多用5.X\n其中5.6版本在2021年2月暂停更新支持，这意味着MySQL 5.6会有安全风险，请及时升级到MySQL 5.7或是MySQL 8系列\n本文选用5.7版本<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>windows版本下载地址</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\">https:&#x2F;&#x2F;downloads.mysql.com&#x2F;archives&#x2F;installer&#x2F;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"/../../../img/image-20220713102756709.png\" alt=\"image-20220713102756709\"></p>\n<h3 id=\"1-2-安装\"><a href=\"#1-2-安装\" class=\"headerlink\" title=\"1.2 安装\"></a>1.2 安装</h3><h2 id=\"2-数据库的基本操作\"><a href=\"#2-数据库的基本操作\" class=\"headerlink\" title=\"2 数据库的基本操作\"></a>2 数据库的基本操作</h2>"},{"title":"一、计算机核心基础","date":"2022-07-18T02:52:22.000Z","_content":"\n\n\n## 1 引子:\n\n接下来一段时间，我们的目标的是：学会使用python这门编程语言来编写ATM+购物车程序，那么问题来了:\n\n### 1.1 什么是语言？什么是编程语言？为何要有编程语言？\n\n![image-20220715110229082](../../../img/image-20220715110229082.png)\n\n语言其实就是人与人之间沟通的介质，如英语，汉语，俄语等。\n\n而编程语言则是人与计算机之间沟通的介质。\n\n那么为何要有编程语言，或者说人为何要与计算机沟通呢？这是因为在编程的世界里，计算机就好比是人的奴隶，人与计算机沟通的目的就是为了奴役计算机，让计算机按照人类的思维逻辑自发地去工作从而把人力解放出来。\n\n此处我们可以提炼出如下两个重要的概念\n\n### 1.2 什么是编程？为什么要编程？\n\n编程就是人把自己想命令计算机干的事用编程语言翻译出来并写到文件里（这一系列的文件就是程序），那么为什么要编程？\n\n小人类编程的目的就是为了让计算机按照人类的思维逻辑(程序)自发地去工作从而把人力解放出来。\n\n综上，我们接下来的学习应该分为两个层面\n\n1、为了更好地控制人类的奴隶（即计算机），我们需要学习计算机是由什么组成的、它能做什么事、它是怎样工作的（详见计算机组成原理、操作系统概述）\n\n2、我们需要学习编程语言，从而把原来需要人力来完成的业务（比如ATM和购物）交给计算机去做\n\n\n\n## 2 计算机组成原理\n\n### 2.1、什么是计算机？\n\n俗称电脑，即通电的大脑，电脑二字蕴含了人类对计算机的终极期望，希望它能真的像人脑一样去工作，从而解放人力。\n\n### 2.2、为什么要用计算机？\n\n世界是由聪明的懒人统治的，任何时期，总有一群聪明的懒人想要奴隶别人。在奴隶制社会，聪明的懒人奴役的是真正的人，而人是无法不吃、不喝、不睡觉一直工作的，但是计算机作为一台机器是可以做到的，所以把计算机当奴隶是上上之选。\n\n### 2.3、计算机的五大组成部分\n\n计算机有五大组成部分，既然计算机是人的奴隶，那么计算机设计核心肯定也是在模仿真正的人，所以我们完全可以把计算机的五大组件比喻成人类的各种器官\n\n#### 2.3.1、控制器\n\n控制器是计算机的指挥系统，用来控制计算机其他组件的运行，相当于人类的大脑\n\n#### 2.3.2、运算器\n\n运算器是计算机的运算功能，用来做算术运算和逻辑运算，相当于人脑。\n\nps：控制器+运算器=CPU，cpu相当于人的大脑\n\ncpu详解见：\n\nhttps://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html\n\n#### 2.3.3、存储器\n\n存储器是计算机的记忆功能，用来存取数据。\n\n存储器主要分为内存与外存：\n\n 内存相当于人的短期记忆。断电数据丢失\n\n 外存(如磁盘),相当于记事的本子，断电数据不会丢失，是用来永久保存数据的\n\n ps：内存的存取速度要远远高于外存\n\n#### 2.3.4、输入设备input\n\n输入设备是计算接收外界输入数据的工具，如键盘、鼠标，相当于人的眼睛或耳朵。\n\n#### 2.3.5、输出设备output\n\n输出设备是计算机向外输出数据的工具，如显示器、打印机，相当于人说的话，写出的文章。\n\nps：存储器如内存、磁盘等既是输入设备又是输出设备，统称为IO设备\n\n#### 一个非常重要的基础知识:与运行程序相关的三大核心硬件\n\n我们编写的程序一定是要运行于计算机硬件之上，而站在硬件的角度，与运行程序有关的三大核心硬件为CPU、内存、硬盘。\n\n程序最先是存放于硬盘中的，程序的运行是先从硬盘把代码加载到内存中，然后cpu是从内存中读取指令运行。\n\n**ps：了解其他计算机硬件知识**\n\nhttps://www.cnblogs.com/linhaifeng/p/6523843.html#4462371\n\n\n\n## 3 操作系统概述\n\n### 3.1、操作系统的由来\n\n 大前提：我们编程目的就是为了奴役计算机，让计算机硬件自发地运行起来，然而硬件毕竟是”死的“，硬件的运行都是由软件支配。\n\n 倘若我们要开发一个应用程序，比如暴风音影，该软件的一个核心业务就是播放视频，开发者若要编写程序完成播放视频这个业务逻辑，必先涉及到底层硬件硬盘的基本运作（视频文件都是先存放于硬盘中），这意味着开发者在编写业务逻辑代码之前，必须先编写一个控制硬盘基本运行的控制程序，然而这仅仅只是一个开始，事实上，在编写应用程序的业务逻辑前，需要开发者编写出一套完整的控制程序用来控制所有硬件的基本运行（这要求开发者需要详细了解计算机硬件的各种控制细节，例如我们必须把CPU里面所有指令集都掌握一遍），如此，所有的开发者在开发程序时都必须依次开发两种：\n\n```python\n#1、编写一套完整的的控制程序，用来控制硬件的基本运行，以及把复杂的硬件的操作封装成简单的接口\n#2、基于控制程序的接口开发包含一系列业务逻辑的程序，为了与控制程序区分，可以称为应用程序，以ATM这款应用程序为例，业务逻辑有提款、转账、查询余额等\n```\n\n 综上，对于不同公司的开发者来说，应用程序的业务逻辑各不相同，但硬件的控制程序都大致相同，为了避免所有程序员做重复劳动，以及不用再耗费精力去了解所有硬件的运行细节，有公司专门跳出来承担起控制程序的开发任务，这里所说的控制程序指的就是操作系统。\n\n 操作系统的功能就是帮我们把复杂的硬件的控制封装成简单的接口，对于开发应用程序来说只需要调用操作系统提供给我们的接口即可\n\n### 3.2、系统软件与应用软件\n\n硬件以上运行的都是软件，而软件分为两类：\n\n```python\n#一、应用软件（例如qq、word、暴风影音，我们学习python就是为了开发应用软件的）\n\n#二、操作系统，操作系统应用软件与硬件之间的一个桥梁，是协调、管理、控制计算机硬件与应用软件资源的控制程序。\n```\n\n### 3.3、计算机系统三层结构\n\n综上，我们开发应用程序本质是在控制硬件，但是我们直接打交道的是操作系统，应用程序都是通过操作系统来间接地操作硬件的，所以一套完整的计算机系统分为三层，如下\n\n![image-20220715110139880](../../../img/image-20220715110139880.png)\n\n### 一个非常重要的基础概念：平台\n\n应用程序都是运行于操作系统之上，而操作系统则是运行于硬件之上的，所以承载应用程序的是一台运行有操作系统的计算机，称之为应用程序的运行平台，即：硬件 + 操作系统 == 平台\n\n![image-20220715110156372](../../../img/image-20220715110156372.png)\n\n常见的平台有：windows系统+某款硬件、linux系统+某款硬件、ubuntu+某款硬件等，我们在开发应用程序时就需要考虑到应用程序的跨平台性，如果能开发出一款可以在任意平台运行的应用程序，那对于开发者来说真是极大的福音。而决定应用软件的跨平台性的关键因素往往是编程语言的选择，python恰好是一款跨平台性语言，这也是我们学习它的原因之一。","source":"_posts/03_Python/01_Python基础/01_计算机核心基础.md","raw":"---\ntitle: 一、计算机核心基础\ndate: 2022-07-18 10:52:22\ncategories:\n- Python\n- Python入门\ntags:\n---\n\n\n\n## 1 引子:\n\n接下来一段时间，我们的目标的是：学会使用python这门编程语言来编写ATM+购物车程序，那么问题来了:\n\n### 1.1 什么是语言？什么是编程语言？为何要有编程语言？\n\n![image-20220715110229082](../../../img/image-20220715110229082.png)\n\n语言其实就是人与人之间沟通的介质，如英语，汉语，俄语等。\n\n而编程语言则是人与计算机之间沟通的介质。\n\n那么为何要有编程语言，或者说人为何要与计算机沟通呢？这是因为在编程的世界里，计算机就好比是人的奴隶，人与计算机沟通的目的就是为了奴役计算机，让计算机按照人类的思维逻辑自发地去工作从而把人力解放出来。\n\n此处我们可以提炼出如下两个重要的概念\n\n### 1.2 什么是编程？为什么要编程？\n\n编程就是人把自己想命令计算机干的事用编程语言翻译出来并写到文件里（这一系列的文件就是程序），那么为什么要编程？\n\n小人类编程的目的就是为了让计算机按照人类的思维逻辑(程序)自发地去工作从而把人力解放出来。\n\n综上，我们接下来的学习应该分为两个层面\n\n1、为了更好地控制人类的奴隶（即计算机），我们需要学习计算机是由什么组成的、它能做什么事、它是怎样工作的（详见计算机组成原理、操作系统概述）\n\n2、我们需要学习编程语言，从而把原来需要人力来完成的业务（比如ATM和购物）交给计算机去做\n\n\n\n## 2 计算机组成原理\n\n### 2.1、什么是计算机？\n\n俗称电脑，即通电的大脑，电脑二字蕴含了人类对计算机的终极期望，希望它能真的像人脑一样去工作，从而解放人力。\n\n### 2.2、为什么要用计算机？\n\n世界是由聪明的懒人统治的，任何时期，总有一群聪明的懒人想要奴隶别人。在奴隶制社会，聪明的懒人奴役的是真正的人，而人是无法不吃、不喝、不睡觉一直工作的，但是计算机作为一台机器是可以做到的，所以把计算机当奴隶是上上之选。\n\n### 2.3、计算机的五大组成部分\n\n计算机有五大组成部分，既然计算机是人的奴隶，那么计算机设计核心肯定也是在模仿真正的人，所以我们完全可以把计算机的五大组件比喻成人类的各种器官\n\n#### 2.3.1、控制器\n\n控制器是计算机的指挥系统，用来控制计算机其他组件的运行，相当于人类的大脑\n\n#### 2.3.2、运算器\n\n运算器是计算机的运算功能，用来做算术运算和逻辑运算，相当于人脑。\n\nps：控制器+运算器=CPU，cpu相当于人的大脑\n\ncpu详解见：\n\nhttps://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html\n\n#### 2.3.3、存储器\n\n存储器是计算机的记忆功能，用来存取数据。\n\n存储器主要分为内存与外存：\n\n 内存相当于人的短期记忆。断电数据丢失\n\n 外存(如磁盘),相当于记事的本子，断电数据不会丢失，是用来永久保存数据的\n\n ps：内存的存取速度要远远高于外存\n\n#### 2.3.4、输入设备input\n\n输入设备是计算接收外界输入数据的工具，如键盘、鼠标，相当于人的眼睛或耳朵。\n\n#### 2.3.5、输出设备output\n\n输出设备是计算机向外输出数据的工具，如显示器、打印机，相当于人说的话，写出的文章。\n\nps：存储器如内存、磁盘等既是输入设备又是输出设备，统称为IO设备\n\n#### 一个非常重要的基础知识:与运行程序相关的三大核心硬件\n\n我们编写的程序一定是要运行于计算机硬件之上，而站在硬件的角度，与运行程序有关的三大核心硬件为CPU、内存、硬盘。\n\n程序最先是存放于硬盘中的，程序的运行是先从硬盘把代码加载到内存中，然后cpu是从内存中读取指令运行。\n\n**ps：了解其他计算机硬件知识**\n\nhttps://www.cnblogs.com/linhaifeng/p/6523843.html#4462371\n\n\n\n## 3 操作系统概述\n\n### 3.1、操作系统的由来\n\n 大前提：我们编程目的就是为了奴役计算机，让计算机硬件自发地运行起来，然而硬件毕竟是”死的“，硬件的运行都是由软件支配。\n\n 倘若我们要开发一个应用程序，比如暴风音影，该软件的一个核心业务就是播放视频，开发者若要编写程序完成播放视频这个业务逻辑，必先涉及到底层硬件硬盘的基本运作（视频文件都是先存放于硬盘中），这意味着开发者在编写业务逻辑代码之前，必须先编写一个控制硬盘基本运行的控制程序，然而这仅仅只是一个开始，事实上，在编写应用程序的业务逻辑前，需要开发者编写出一套完整的控制程序用来控制所有硬件的基本运行（这要求开发者需要详细了解计算机硬件的各种控制细节，例如我们必须把CPU里面所有指令集都掌握一遍），如此，所有的开发者在开发程序时都必须依次开发两种：\n\n```python\n#1、编写一套完整的的控制程序，用来控制硬件的基本运行，以及把复杂的硬件的操作封装成简单的接口\n#2、基于控制程序的接口开发包含一系列业务逻辑的程序，为了与控制程序区分，可以称为应用程序，以ATM这款应用程序为例，业务逻辑有提款、转账、查询余额等\n```\n\n 综上，对于不同公司的开发者来说，应用程序的业务逻辑各不相同，但硬件的控制程序都大致相同，为了避免所有程序员做重复劳动，以及不用再耗费精力去了解所有硬件的运行细节，有公司专门跳出来承担起控制程序的开发任务，这里所说的控制程序指的就是操作系统。\n\n 操作系统的功能就是帮我们把复杂的硬件的控制封装成简单的接口，对于开发应用程序来说只需要调用操作系统提供给我们的接口即可\n\n### 3.2、系统软件与应用软件\n\n硬件以上运行的都是软件，而软件分为两类：\n\n```python\n#一、应用软件（例如qq、word、暴风影音，我们学习python就是为了开发应用软件的）\n\n#二、操作系统，操作系统应用软件与硬件之间的一个桥梁，是协调、管理、控制计算机硬件与应用软件资源的控制程序。\n```\n\n### 3.3、计算机系统三层结构\n\n综上，我们开发应用程序本质是在控制硬件，但是我们直接打交道的是操作系统，应用程序都是通过操作系统来间接地操作硬件的，所以一套完整的计算机系统分为三层，如下\n\n![image-20220715110139880](../../../img/image-20220715110139880.png)\n\n### 一个非常重要的基础概念：平台\n\n应用程序都是运行于操作系统之上，而操作系统则是运行于硬件之上的，所以承载应用程序的是一台运行有操作系统的计算机，称之为应用程序的运行平台，即：硬件 + 操作系统 == 平台\n\n![image-20220715110156372](../../../img/image-20220715110156372.png)\n\n常见的平台有：windows系统+某款硬件、linux系统+某款硬件、ubuntu+某款硬件等，我们在开发应用程序时就需要考虑到应用程序的跨平台性，如果能开发出一款可以在任意平台运行的应用程序，那对于开发者来说真是极大的福音。而决定应用软件的跨平台性的关键因素往往是编程语言的选择，python恰好是一款跨平台性语言，这也是我们学习它的原因之一。","slug":"03_Python/01_Python基础/01_计算机核心基础","published":1,"updated":"2022-07-18T07:10:19.367Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k11001wa8v7hiky2boe","content":"<h2 id=\"1-引子\"><a href=\"#1-引子\" class=\"headerlink\" title=\"1 引子:\"></a>1 引子:</h2><p>接下来一段时间，我们的目标的是：学会使用python这门编程语言来编写ATM+购物车程序，那么问题来了:</p>\n<h3 id=\"1-1-什么是语言？什么是编程语言？为何要有编程语言？\"><a href=\"#1-1-什么是语言？什么是编程语言？为何要有编程语言？\" class=\"headerlink\" title=\"1.1 什么是语言？什么是编程语言？为何要有编程语言？\"></a>1.1 什么是语言？什么是编程语言？为何要有编程语言？</h3><p><img src=\"/../../../img/image-20220715110229082.png\" alt=\"image-20220715110229082\"></p>\n<p>语言其实就是人与人之间沟通的介质，如英语，汉语，俄语等。</p>\n<p>而编程语言则是人与计算机之间沟通的介质。</p>\n<p>那么为何要有编程语言，或者说人为何要与计算机沟通呢？这是因为在编程的世界里，计算机就好比是人的奴隶，人与计算机沟通的目的就是为了奴役计算机，让计算机按照人类的思维逻辑自发地去工作从而把人力解放出来。</p>\n<p>此处我们可以提炼出如下两个重要的概念</p>\n<h3 id=\"1-2-什么是编程？为什么要编程？\"><a href=\"#1-2-什么是编程？为什么要编程？\" class=\"headerlink\" title=\"1.2 什么是编程？为什么要编程？\"></a>1.2 什么是编程？为什么要编程？</h3><p>编程就是人把自己想命令计算机干的事用编程语言翻译出来并写到文件里（这一系列的文件就是程序），那么为什么要编程？</p>\n<p>小人类编程的目的就是为了让计算机按照人类的思维逻辑(程序)自发地去工作从而把人力解放出来。</p>\n<p>综上，我们接下来的学习应该分为两个层面</p>\n<p>1、为了更好地控制人类的奴隶（即计算机），我们需要学习计算机是由什么组成的、它能做什么事、它是怎样工作的（详见计算机组成原理、操作系统概述）</p>\n<p>2、我们需要学习编程语言，从而把原来需要人力来完成的业务（比如ATM和购物）交给计算机去做</p>\n<h2 id=\"2-计算机组成原理\"><a href=\"#2-计算机组成原理\" class=\"headerlink\" title=\"2 计算机组成原理\"></a>2 计算机组成原理</h2><h3 id=\"2-1、什么是计算机？\"><a href=\"#2-1、什么是计算机？\" class=\"headerlink\" title=\"2.1、什么是计算机？\"></a>2.1、什么是计算机？</h3><p>俗称电脑，即通电的大脑，电脑二字蕴含了人类对计算机的终极期望，希望它能真的像人脑一样去工作，从而解放人力。</p>\n<h3 id=\"2-2、为什么要用计算机？\"><a href=\"#2-2、为什么要用计算机？\" class=\"headerlink\" title=\"2.2、为什么要用计算机？\"></a>2.2、为什么要用计算机？</h3><p>世界是由聪明的懒人统治的，任何时期，总有一群聪明的懒人想要奴隶别人。在奴隶制社会，聪明的懒人奴役的是真正的人，而人是无法不吃、不喝、不睡觉一直工作的，但是计算机作为一台机器是可以做到的，所以把计算机当奴隶是上上之选。</p>\n<h3 id=\"2-3、计算机的五大组成部分\"><a href=\"#2-3、计算机的五大组成部分\" class=\"headerlink\" title=\"2.3、计算机的五大组成部分\"></a>2.3、计算机的五大组成部分</h3><p>计算机有五大组成部分，既然计算机是人的奴隶，那么计算机设计核心肯定也是在模仿真正的人，所以我们完全可以把计算机的五大组件比喻成人类的各种器官</p>\n<h4 id=\"2-3-1、控制器\"><a href=\"#2-3-1、控制器\" class=\"headerlink\" title=\"2.3.1、控制器\"></a>2.3.1、控制器</h4><p>控制器是计算机的指挥系统，用来控制计算机其他组件的运行，相当于人类的大脑</p>\n<h4 id=\"2-3-2、运算器\"><a href=\"#2-3-2、运算器\" class=\"headerlink\" title=\"2.3.2、运算器\"></a>2.3.2、运算器</h4><p>运算器是计算机的运算功能，用来做算术运算和逻辑运算，相当于人脑。</p>\n<p>ps：控制器+运算器&#x3D;CPU，cpu相当于人的大脑</p>\n<p>cpu详解见：</p>\n<p><a href=\"https://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html\">https://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html</a></p>\n<h4 id=\"2-3-3、存储器\"><a href=\"#2-3-3、存储器\" class=\"headerlink\" title=\"2.3.3、存储器\"></a>2.3.3、存储器</h4><p>存储器是计算机的记忆功能，用来存取数据。</p>\n<p>存储器主要分为内存与外存：</p>\n<p> 内存相当于人的短期记忆。断电数据丢失</p>\n<p> 外存(如磁盘),相当于记事的本子，断电数据不会丢失，是用来永久保存数据的</p>\n<p> ps：内存的存取速度要远远高于外存</p>\n<h4 id=\"2-3-4、输入设备input\"><a href=\"#2-3-4、输入设备input\" class=\"headerlink\" title=\"2.3.4、输入设备input\"></a>2.3.4、输入设备input</h4><p>输入设备是计算接收外界输入数据的工具，如键盘、鼠标，相当于人的眼睛或耳朵。</p>\n<h4 id=\"2-3-5、输出设备output\"><a href=\"#2-3-5、输出设备output\" class=\"headerlink\" title=\"2.3.5、输出设备output\"></a>2.3.5、输出设备output</h4><p>输出设备是计算机向外输出数据的工具，如显示器、打印机，相当于人说的话，写出的文章。</p>\n<p>ps：存储器如内存、磁盘等既是输入设备又是输出设备，统称为IO设备</p>\n<h4 id=\"一个非常重要的基础知识-与运行程序相关的三大核心硬件\"><a href=\"#一个非常重要的基础知识-与运行程序相关的三大核心硬件\" class=\"headerlink\" title=\"一个非常重要的基础知识:与运行程序相关的三大核心硬件\"></a>一个非常重要的基础知识:与运行程序相关的三大核心硬件</h4><p>我们编写的程序一定是要运行于计算机硬件之上，而站在硬件的角度，与运行程序有关的三大核心硬件为CPU、内存、硬盘。</p>\n<p>程序最先是存放于硬盘中的，程序的运行是先从硬盘把代码加载到内存中，然后cpu是从内存中读取指令运行。</p>\n<p><strong>ps：了解其他计算机硬件知识</strong></p>\n<p><a href=\"https://www.cnblogs.com/linhaifeng/p/6523843.html#4462371\">https://www.cnblogs.com/linhaifeng/p/6523843.html#4462371</a></p>\n<h2 id=\"3-操作系统概述\"><a href=\"#3-操作系统概述\" class=\"headerlink\" title=\"3 操作系统概述\"></a>3 操作系统概述</h2><h3 id=\"3-1、操作系统的由来\"><a href=\"#3-1、操作系统的由来\" class=\"headerlink\" title=\"3.1、操作系统的由来\"></a>3.1、操作系统的由来</h3><p> 大前提：我们编程目的就是为了奴役计算机，让计算机硬件自发地运行起来，然而硬件毕竟是”死的“，硬件的运行都是由软件支配。</p>\n<p> 倘若我们要开发一个应用程序，比如暴风音影，该软件的一个核心业务就是播放视频，开发者若要编写程序完成播放视频这个业务逻辑，必先涉及到底层硬件硬盘的基本运作（视频文件都是先存放于硬盘中），这意味着开发者在编写业务逻辑代码之前，必须先编写一个控制硬盘基本运行的控制程序，然而这仅仅只是一个开始，事实上，在编写应用程序的业务逻辑前，需要开发者编写出一套完整的控制程序用来控制所有硬件的基本运行（这要求开发者需要详细了解计算机硬件的各种控制细节，例如我们必须把CPU里面所有指令集都掌握一遍），如此，所有的开发者在开发程序时都必须依次开发两种：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、编写一套完整的的控制程序，用来控制硬件的基本运行，以及把复杂的硬件的操作封装成简单的接口</span>\n<span class=\"token comment\">#2、基于控制程序的接口开发包含一系列业务逻辑的程序，为了与控制程序区分，可以称为应用程序，以ATM这款应用程序为例，业务逻辑有提款、转账、查询余额等</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p> 综上，对于不同公司的开发者来说，应用程序的业务逻辑各不相同，但硬件的控制程序都大致相同，为了避免所有程序员做重复劳动，以及不用再耗费精力去了解所有硬件的运行细节，有公司专门跳出来承担起控制程序的开发任务，这里所说的控制程序指的就是操作系统。</p>\n<p> 操作系统的功能就是帮我们把复杂的硬件的控制封装成简单的接口，对于开发应用程序来说只需要调用操作系统提供给我们的接口即可</p>\n<h3 id=\"3-2、系统软件与应用软件\"><a href=\"#3-2、系统软件与应用软件\" class=\"headerlink\" title=\"3.2、系统软件与应用软件\"></a>3.2、系统软件与应用软件</h3><p>硬件以上运行的都是软件，而软件分为两类：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#一、应用软件（例如qq、word、暴风影音，我们学习python就是为了开发应用软件的）</span>\n\n<span class=\"token comment\">#二、操作系统，操作系统应用软件与硬件之间的一个桥梁，是协调、管理、控制计算机硬件与应用软件资源的控制程序。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-3、计算机系统三层结构\"><a href=\"#3-3、计算机系统三层结构\" class=\"headerlink\" title=\"3.3、计算机系统三层结构\"></a>3.3、计算机系统三层结构</h3><p>综上，我们开发应用程序本质是在控制硬件，但是我们直接打交道的是操作系统，应用程序都是通过操作系统来间接地操作硬件的，所以一套完整的计算机系统分为三层，如下</p>\n<p><img src=\"/../../../img/image-20220715110139880.png\" alt=\"image-20220715110139880\"></p>\n<h3 id=\"一个非常重要的基础概念：平台\"><a href=\"#一个非常重要的基础概念：平台\" class=\"headerlink\" title=\"一个非常重要的基础概念：平台\"></a>一个非常重要的基础概念：平台</h3><p>应用程序都是运行于操作系统之上，而操作系统则是运行于硬件之上的，所以承载应用程序的是一台运行有操作系统的计算机，称之为应用程序的运行平台，即：硬件 + 操作系统 &#x3D;&#x3D; 平台</p>\n<p><img src=\"/../../../img/image-20220715110156372.png\" alt=\"image-20220715110156372\"></p>\n<p>常见的平台有：windows系统+某款硬件、linux系统+某款硬件、ubuntu+某款硬件等，我们在开发应用程序时就需要考虑到应用程序的跨平台性，如果能开发出一款可以在任意平台运行的应用程序，那对于开发者来说真是极大的福音。而决定应用软件的跨平台性的关键因素往往是编程语言的选择，python恰好是一款跨平台性语言，这也是我们学习它的原因之一。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"1-引子\"><a href=\"#1-引子\" class=\"headerlink\" title=\"1 引子:\"></a>1 引子:</h2><p>接下来一段时间，我们的目标的是：学会使用python这门编程语言来编写ATM+购物车程序，那么问题来了:</p>\n<h3 id=\"1-1-什么是语言？什么是编程语言？为何要有编程语言？\"><a href=\"#1-1-什么是语言？什么是编程语言？为何要有编程语言？\" class=\"headerlink\" title=\"1.1 什么是语言？什么是编程语言？为何要有编程语言？\"></a>1.1 什么是语言？什么是编程语言？为何要有编程语言？</h3><p><img src=\"/../../../img/image-20220715110229082.png\" alt=\"image-20220715110229082\"></p>\n<p>语言其实就是人与人之间沟通的介质，如英语，汉语，俄语等。</p>\n<p>而编程语言则是人与计算机之间沟通的介质。</p>\n<p>那么为何要有编程语言，或者说人为何要与计算机沟通呢？这是因为在编程的世界里，计算机就好比是人的奴隶，人与计算机沟通的目的就是为了奴役计算机，让计算机按照人类的思维逻辑自发地去工作从而把人力解放出来。</p>\n<p>此处我们可以提炼出如下两个重要的概念</p>\n<h3 id=\"1-2-什么是编程？为什么要编程？\"><a href=\"#1-2-什么是编程？为什么要编程？\" class=\"headerlink\" title=\"1.2 什么是编程？为什么要编程？\"></a>1.2 什么是编程？为什么要编程？</h3><p>编程就是人把自己想命令计算机干的事用编程语言翻译出来并写到文件里（这一系列的文件就是程序），那么为什么要编程？</p>\n<p>小人类编程的目的就是为了让计算机按照人类的思维逻辑(程序)自发地去工作从而把人力解放出来。</p>\n<p>综上，我们接下来的学习应该分为两个层面</p>\n<p>1、为了更好地控制人类的奴隶（即计算机），我们需要学习计算机是由什么组成的、它能做什么事、它是怎样工作的（详见计算机组成原理、操作系统概述）</p>\n<p>2、我们需要学习编程语言，从而把原来需要人力来完成的业务（比如ATM和购物）交给计算机去做</p>\n<h2 id=\"2-计算机组成原理\"><a href=\"#2-计算机组成原理\" class=\"headerlink\" title=\"2 计算机组成原理\"></a>2 计算机组成原理</h2><h3 id=\"2-1、什么是计算机？\"><a href=\"#2-1、什么是计算机？\" class=\"headerlink\" title=\"2.1、什么是计算机？\"></a>2.1、什么是计算机？</h3><p>俗称电脑，即通电的大脑，电脑二字蕴含了人类对计算机的终极期望，希望它能真的像人脑一样去工作，从而解放人力。</p>\n<h3 id=\"2-2、为什么要用计算机？\"><a href=\"#2-2、为什么要用计算机？\" class=\"headerlink\" title=\"2.2、为什么要用计算机？\"></a>2.2、为什么要用计算机？</h3><p>世界是由聪明的懒人统治的，任何时期，总有一群聪明的懒人想要奴隶别人。在奴隶制社会，聪明的懒人奴役的是真正的人，而人是无法不吃、不喝、不睡觉一直工作的，但是计算机作为一台机器是可以做到的，所以把计算机当奴隶是上上之选。</p>\n<h3 id=\"2-3、计算机的五大组成部分\"><a href=\"#2-3、计算机的五大组成部分\" class=\"headerlink\" title=\"2.3、计算机的五大组成部分\"></a>2.3、计算机的五大组成部分</h3><p>计算机有五大组成部分，既然计算机是人的奴隶，那么计算机设计核心肯定也是在模仿真正的人，所以我们完全可以把计算机的五大组件比喻成人类的各种器官</p>\n<h4 id=\"2-3-1、控制器\"><a href=\"#2-3-1、控制器\" class=\"headerlink\" title=\"2.3.1、控制器\"></a>2.3.1、控制器</h4><p>控制器是计算机的指挥系统，用来控制计算机其他组件的运行，相当于人类的大脑</p>\n<h4 id=\"2-3-2、运算器\"><a href=\"#2-3-2、运算器\" class=\"headerlink\" title=\"2.3.2、运算器\"></a>2.3.2、运算器</h4><p>运算器是计算机的运算功能，用来做算术运算和逻辑运算，相当于人脑。</p>\n<p>ps：控制器+运算器&#x3D;CPU，cpu相当于人的大脑</p>\n<p>cpu详解见：</p>\n<p><a href=\"https://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html\">https://www.cnblogs.com/xiaoyuanqujing/articles/11640866.html</a></p>\n<h4 id=\"2-3-3、存储器\"><a href=\"#2-3-3、存储器\" class=\"headerlink\" title=\"2.3.3、存储器\"></a>2.3.3、存储器</h4><p>存储器是计算机的记忆功能，用来存取数据。</p>\n<p>存储器主要分为内存与外存：</p>\n<p> 内存相当于人的短期记忆。断电数据丢失</p>\n<p> 外存(如磁盘),相当于记事的本子，断电数据不会丢失，是用来永久保存数据的</p>\n<p> ps：内存的存取速度要远远高于外存</p>\n<h4 id=\"2-3-4、输入设备input\"><a href=\"#2-3-4、输入设备input\" class=\"headerlink\" title=\"2.3.4、输入设备input\"></a>2.3.4、输入设备input</h4><p>输入设备是计算接收外界输入数据的工具，如键盘、鼠标，相当于人的眼睛或耳朵。</p>\n<h4 id=\"2-3-5、输出设备output\"><a href=\"#2-3-5、输出设备output\" class=\"headerlink\" title=\"2.3.5、输出设备output\"></a>2.3.5、输出设备output</h4><p>输出设备是计算机向外输出数据的工具，如显示器、打印机，相当于人说的话，写出的文章。</p>\n<p>ps：存储器如内存、磁盘等既是输入设备又是输出设备，统称为IO设备</p>\n<h4 id=\"一个非常重要的基础知识-与运行程序相关的三大核心硬件\"><a href=\"#一个非常重要的基础知识-与运行程序相关的三大核心硬件\" class=\"headerlink\" title=\"一个非常重要的基础知识:与运行程序相关的三大核心硬件\"></a>一个非常重要的基础知识:与运行程序相关的三大核心硬件</h4><p>我们编写的程序一定是要运行于计算机硬件之上，而站在硬件的角度，与运行程序有关的三大核心硬件为CPU、内存、硬盘。</p>\n<p>程序最先是存放于硬盘中的，程序的运行是先从硬盘把代码加载到内存中，然后cpu是从内存中读取指令运行。</p>\n<p><strong>ps：了解其他计算机硬件知识</strong></p>\n<p><a href=\"https://www.cnblogs.com/linhaifeng/p/6523843.html#4462371\">https://www.cnblogs.com/linhaifeng/p/6523843.html#4462371</a></p>\n<h2 id=\"3-操作系统概述\"><a href=\"#3-操作系统概述\" class=\"headerlink\" title=\"3 操作系统概述\"></a>3 操作系统概述</h2><h3 id=\"3-1、操作系统的由来\"><a href=\"#3-1、操作系统的由来\" class=\"headerlink\" title=\"3.1、操作系统的由来\"></a>3.1、操作系统的由来</h3><p> 大前提：我们编程目的就是为了奴役计算机，让计算机硬件自发地运行起来，然而硬件毕竟是”死的“，硬件的运行都是由软件支配。</p>\n<p> 倘若我们要开发一个应用程序，比如暴风音影，该软件的一个核心业务就是播放视频，开发者若要编写程序完成播放视频这个业务逻辑，必先涉及到底层硬件硬盘的基本运作（视频文件都是先存放于硬盘中），这意味着开发者在编写业务逻辑代码之前，必须先编写一个控制硬盘基本运行的控制程序，然而这仅仅只是一个开始，事实上，在编写应用程序的业务逻辑前，需要开发者编写出一套完整的控制程序用来控制所有硬件的基本运行（这要求开发者需要详细了解计算机硬件的各种控制细节，例如我们必须把CPU里面所有指令集都掌握一遍），如此，所有的开发者在开发程序时都必须依次开发两种：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、编写一套完整的的控制程序，用来控制硬件的基本运行，以及把复杂的硬件的操作封装成简单的接口</span>\n<span class=\"token comment\">#2、基于控制程序的接口开发包含一系列业务逻辑的程序，为了与控制程序区分，可以称为应用程序，以ATM这款应用程序为例，业务逻辑有提款、转账、查询余额等</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p> 综上，对于不同公司的开发者来说，应用程序的业务逻辑各不相同，但硬件的控制程序都大致相同，为了避免所有程序员做重复劳动，以及不用再耗费精力去了解所有硬件的运行细节，有公司专门跳出来承担起控制程序的开发任务，这里所说的控制程序指的就是操作系统。</p>\n<p> 操作系统的功能就是帮我们把复杂的硬件的控制封装成简单的接口，对于开发应用程序来说只需要调用操作系统提供给我们的接口即可</p>\n<h3 id=\"3-2、系统软件与应用软件\"><a href=\"#3-2、系统软件与应用软件\" class=\"headerlink\" title=\"3.2、系统软件与应用软件\"></a>3.2、系统软件与应用软件</h3><p>硬件以上运行的都是软件，而软件分为两类：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#一、应用软件（例如qq、word、暴风影音，我们学习python就是为了开发应用软件的）</span>\n\n<span class=\"token comment\">#二、操作系统，操作系统应用软件与硬件之间的一个桥梁，是协调、管理、控制计算机硬件与应用软件资源的控制程序。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-3、计算机系统三层结构\"><a href=\"#3-3、计算机系统三层结构\" class=\"headerlink\" title=\"3.3、计算机系统三层结构\"></a>3.3、计算机系统三层结构</h3><p>综上，我们开发应用程序本质是在控制硬件，但是我们直接打交道的是操作系统，应用程序都是通过操作系统来间接地操作硬件的，所以一套完整的计算机系统分为三层，如下</p>\n<p><img src=\"/../../../img/image-20220715110139880.png\" alt=\"image-20220715110139880\"></p>\n<h3 id=\"一个非常重要的基础概念：平台\"><a href=\"#一个非常重要的基础概念：平台\" class=\"headerlink\" title=\"一个非常重要的基础概念：平台\"></a>一个非常重要的基础概念：平台</h3><p>应用程序都是运行于操作系统之上，而操作系统则是运行于硬件之上的，所以承载应用程序的是一台运行有操作系统的计算机，称之为应用程序的运行平台，即：硬件 + 操作系统 &#x3D;&#x3D; 平台</p>\n<p><img src=\"/../../../img/image-20220715110156372.png\" alt=\"image-20220715110156372\"></p>\n<p>常见的平台有：windows系统+某款硬件、linux系统+某款硬件、ubuntu+某款硬件等，我们在开发应用程序时就需要考虑到应用程序的跨平台性，如果能开发出一款可以在任意平台运行的应用程序，那对于开发者来说真是极大的福音。而决定应用软件的跨平台性的关键因素往往是编程语言的选择，python恰好是一款跨平台性语言，这也是我们学习它的原因之一。</p>\n"},{"_content":"## 一 引入\n\n我们知道学习 **Python** 语言的目的是为了与计算机进行沟通/交流，从而控制计算机帮助我们做一些事情，所以，在 **Python** 语言的所有语法中，每个语法存在的意义都是为了让计算机能够像人类一样，直白地讲，就是让计算机具备我们人类的某一项技能。这是我们理解后续所有 **Python** 语法的根本，一定要熟记。\n\n\n\n## 二 变量\n\n## 一、什么是变量？\n\n```python\n# 变量就是可以变化的量，量指的是事物的状态，比如人的年龄、性别，游戏角色的等级、金钱等等\n```\n\n## 二、为什么要有变量？\n\n```python\n# 为了让计算机能够像人一样去记忆事物的某种状态，并且状态是可以发生变化的\n# 详细地说：\n# 程序执行的本质就是一系列状态的变化，变是程序执行的直接体现，所以我们需要有一种机制能够反映或者说是保存下来程序执行时状态，以及状态的变化。\n```\n\n\n\n## 三、怎么使用变量（先定义、后使用）\n\n### 3.1、变量的定义与使用\n\n变量的定义由三部分组成，如下图\n\n![image-20220718091017221](../../../img/image-20220718091017221.png)\n\n定义变量示范如下\n\n```python\nname = 'Jason' # 记下人的名字为'Jason'\nsex = '男'    # 记下人的性别为男性\nage = 18      # 记下人的年龄为18岁\nsalary = 30000.1  # 记下人的薪资为30000.1元\n```\n\n解释器执行到变量定义的代码时会申请内存空间存放变量值，然后将变量值的内存地址绑定给变量名，以变量的定义age=18为例，如下图\n\n插图：定义变量申请内存\n\n通过变量名即可引用到对应的值\n\n```python\n# 通过变量名即可引用到值，我们可以结合print()功能将其打印出来\nprint(age) # 通过变量名age找到值18，然后执行print(18),输出：18\n```\n\n### 3.2、变量名的命名规范\n\n变量名的命名应该见名知意\n\n```python\n# 如果我们要存储的数据18代表的是一个人的年龄，那么变量名推荐命名为age\nage = 18 \n# 如果我们要存储的数据18代表的是一个人的等级，那么变量名推荐命名为level\nlevel = 18\n```\n\n其他详细规范如下\n\n```python\n# 命名规范\n1. 变量名只能是 字母、数字或下划线的任意组合\n2. 变量名的第一个字符不能是数字\n3. 关键字不能声明为变量名，常用关键字如下\n['and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'exec', 'finally', 'for', 'from','global', 'if', 'import', 'in', 'is', 'lambda', 'not', 'or', 'pass', 'print', 'raise', 'return', 'try', 'while', 'with', 'yield']\n\n# 错误示范如下：\n*a=123\n$b=456\nc$=789\n2_name='lili'\n123='lili'\nand=123\n年龄=18 # 强烈建议不要使用中文命名\n\n# 正确示范如下\nage_of_jason=31\npage1='首页'\n_class='终极一班'\n```\n\n### 3.3、变量名的命名风格\n\n```python\n# 风格一：驼峰体\nAgeOfTony = 56 \nNumberOfStudents = 80\n# 风格二：纯小写下划线(在python中，变量名的命名推荐使用该风格)\nage_of_tony = 56 \nnumber_of_students = 80\n```\n\n### 3.4、变量值的三大特性\n\n变量的值具备三大特性\n\n```python\n#1、id\n反应的是变量在内存中的唯一编号，内存地址不同id肯定不同\n\n#2、type\n变量值的类型\n\n#3、value\n变量值\n```\n\n查看变量值三大特性的方式如下，我们将会在运算符中用到变量值的三大特性\n\n```python\n>>> x='Info Tony:18'\n>>> id(x),type(x),x\n4376607152，<class 'str'>,'Info Tony:18'\n```\n\n了解：[Python是一门解释型的强类型动态语言](https://zhuanlan.zhihu.com/p/113408690)\n\n\n\n## 三、常量\n\n## 3.1、什么是常量？\n\n常量指在程序运行过程中不会改变的量\n\n## 3.2、为什么要有常量？\n\n在程序运行过程中，有些值是固定的、不应该被改变，比如圆周率 3.141592653...\n\n## 3.3、怎么使用常量？\n\n在Python中没有一个专门的语法定义常量，约定俗成是用全部大写的变量名表示常量。如：PI=3.14159。所以单从语法层面去讲，常量的使用与变量完全一致。\n\n![image-20220718091033465](../../../img/image-20220718091033465.png)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471?p=4www.bilibili.com/video/av73342471?p=4](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D4)","source":"_posts/03_Python/01_Python基础/03_Python语法入门之变量.md","raw":"## 一 引入\n\n我们知道学习 **Python** 语言的目的是为了与计算机进行沟通/交流，从而控制计算机帮助我们做一些事情，所以，在 **Python** 语言的所有语法中，每个语法存在的意义都是为了让计算机能够像人类一样，直白地讲，就是让计算机具备我们人类的某一项技能。这是我们理解后续所有 **Python** 语法的根本，一定要熟记。\n\n\n\n## 二 变量\n\n## 一、什么是变量？\n\n```python\n# 变量就是可以变化的量，量指的是事物的状态，比如人的年龄、性别，游戏角色的等级、金钱等等\n```\n\n## 二、为什么要有变量？\n\n```python\n# 为了让计算机能够像人一样去记忆事物的某种状态，并且状态是可以发生变化的\n# 详细地说：\n# 程序执行的本质就是一系列状态的变化，变是程序执行的直接体现，所以我们需要有一种机制能够反映或者说是保存下来程序执行时状态，以及状态的变化。\n```\n\n\n\n## 三、怎么使用变量（先定义、后使用）\n\n### 3.1、变量的定义与使用\n\n变量的定义由三部分组成，如下图\n\n![image-20220718091017221](../../../img/image-20220718091017221.png)\n\n定义变量示范如下\n\n```python\nname = 'Jason' # 记下人的名字为'Jason'\nsex = '男'    # 记下人的性别为男性\nage = 18      # 记下人的年龄为18岁\nsalary = 30000.1  # 记下人的薪资为30000.1元\n```\n\n解释器执行到变量定义的代码时会申请内存空间存放变量值，然后将变量值的内存地址绑定给变量名，以变量的定义age=18为例，如下图\n\n插图：定义变量申请内存\n\n通过变量名即可引用到对应的值\n\n```python\n# 通过变量名即可引用到值，我们可以结合print()功能将其打印出来\nprint(age) # 通过变量名age找到值18，然后执行print(18),输出：18\n```\n\n### 3.2、变量名的命名规范\n\n变量名的命名应该见名知意\n\n```python\n# 如果我们要存储的数据18代表的是一个人的年龄，那么变量名推荐命名为age\nage = 18 \n# 如果我们要存储的数据18代表的是一个人的等级，那么变量名推荐命名为level\nlevel = 18\n```\n\n其他详细规范如下\n\n```python\n# 命名规范\n1. 变量名只能是 字母、数字或下划线的任意组合\n2. 变量名的第一个字符不能是数字\n3. 关键字不能声明为变量名，常用关键字如下\n['and', 'as', 'assert', 'break', 'class', 'continue', 'def', 'del', 'elif', 'else', 'except', 'exec', 'finally', 'for', 'from','global', 'if', 'import', 'in', 'is', 'lambda', 'not', 'or', 'pass', 'print', 'raise', 'return', 'try', 'while', 'with', 'yield']\n\n# 错误示范如下：\n*a=123\n$b=456\nc$=789\n2_name='lili'\n123='lili'\nand=123\n年龄=18 # 强烈建议不要使用中文命名\n\n# 正确示范如下\nage_of_jason=31\npage1='首页'\n_class='终极一班'\n```\n\n### 3.3、变量名的命名风格\n\n```python\n# 风格一：驼峰体\nAgeOfTony = 56 \nNumberOfStudents = 80\n# 风格二：纯小写下划线(在python中，变量名的命名推荐使用该风格)\nage_of_tony = 56 \nnumber_of_students = 80\n```\n\n### 3.4、变量值的三大特性\n\n变量的值具备三大特性\n\n```python\n#1、id\n反应的是变量在内存中的唯一编号，内存地址不同id肯定不同\n\n#2、type\n变量值的类型\n\n#3、value\n变量值\n```\n\n查看变量值三大特性的方式如下，我们将会在运算符中用到变量值的三大特性\n\n```python\n>>> x='Info Tony:18'\n>>> id(x),type(x),x\n4376607152，<class 'str'>,'Info Tony:18'\n```\n\n了解：[Python是一门解释型的强类型动态语言](https://zhuanlan.zhihu.com/p/113408690)\n\n\n\n## 三、常量\n\n## 3.1、什么是常量？\n\n常量指在程序运行过程中不会改变的量\n\n## 3.2、为什么要有常量？\n\n在程序运行过程中，有些值是固定的、不应该被改变，比如圆周率 3.141592653...\n\n## 3.3、怎么使用常量？\n\n在Python中没有一个专门的语法定义常量，约定俗成是用全部大写的变量名表示常量。如：PI=3.14159。所以单从语法层面去讲，常量的使用与变量完全一致。\n\n![image-20220718091033465](../../../img/image-20220718091033465.png)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471?p=4www.bilibili.com/video/av73342471?p=4](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D4)","slug":"03_Python/01_Python基础/03_Python语法入门之变量","published":1,"date":"2022-07-18T07:10:19.369Z","updated":"2022-07-18T07:10:19.369Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k12001ya8v7fl1q6y6p","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p>我们知道学习 <strong>Python</strong> 语言的目的是为了与计算机进行沟通&#x2F;交流，从而控制计算机帮助我们做一些事情，所以，在 <strong>Python</strong> 语言的所有语法中，每个语法存在的意义都是为了让计算机能够像人类一样，直白地讲，就是让计算机具备我们人类的某一项技能。这是我们理解后续所有 <strong>Python</strong> 语法的根本，一定要熟记。</p>\n<h2 id=\"二-变量\"><a href=\"#二-变量\" class=\"headerlink\" title=\"二 变量\"></a>二 变量</h2><h2 id=\"一、什么是变量？\"><a href=\"#一、什么是变量？\" class=\"headerlink\" title=\"一、什么是变量？\"></a>一、什么是变量？</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 变量就是可以变化的量，量指的是事物的状态，比如人的年龄、性别，游戏角色的等级、金钱等等</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、为什么要有变量？\"><a href=\"#二、为什么要有变量？\" class=\"headerlink\" title=\"二、为什么要有变量？\"></a>二、为什么要有变量？</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 为了让计算机能够像人一样去记忆事物的某种状态，并且状态是可以发生变化的</span>\n<span class=\"token comment\"># 详细地说：</span>\n<span class=\"token comment\"># 程序执行的本质就是一系列状态的变化，变是程序执行的直接体现，所以我们需要有一种机制能够反映或者说是保存下来程序执行时状态，以及状态的变化。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"三、怎么使用变量（先定义、后使用）\"><a href=\"#三、怎么使用变量（先定义、后使用）\" class=\"headerlink\" title=\"三、怎么使用变量（先定义、后使用）\"></a>三、怎么使用变量（先定义、后使用）</h2><h3 id=\"3-1、变量的定义与使用\"><a href=\"#3-1、变量的定义与使用\" class=\"headerlink\" title=\"3.1、变量的定义与使用\"></a>3.1、变量的定义与使用</h3><p>变量的定义由三部分组成，如下图</p>\n<p><img src=\"/../../../img/image-20220718091017221.png\" alt=\"image-20220718091017221\"></p>\n<p>定义变量示范如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">name <span class=\"token operator\">=</span> <span class=\"token string\">'Jason'</span> <span class=\"token comment\"># 记下人的名字为'Jason'</span>\nsex <span class=\"token operator\">=</span> <span class=\"token string\">'男'</span>    <span class=\"token comment\"># 记下人的性别为男性</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span>      <span class=\"token comment\"># 记下人的年龄为18岁</span>\nsalary <span class=\"token operator\">=</span> <span class=\"token number\">30000.1</span>  <span class=\"token comment\"># 记下人的薪资为30000.1元</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>解释器执行到变量定义的代码时会申请内存空间存放变量值，然后将变量值的内存地址绑定给变量名，以变量的定义age&#x3D;18为例，如下图</p>\n<p>插图：定义变量申请内存</p>\n<p>通过变量名即可引用到对应的值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 通过变量名即可引用到值，我们可以结合print()功能将其打印出来</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 通过变量名age找到值18，然后执行print(18),输出：18</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2、变量名的命名规范\"><a href=\"#3-2、变量名的命名规范\" class=\"headerlink\" title=\"3.2、变量名的命名规范\"></a>3.2、变量名的命名规范</h3><p>变量名的命名应该见名知意</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 如果我们要存储的数据18代表的是一个人的年龄，那么变量名推荐命名为age</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span> \n<span class=\"token comment\"># 如果我们要存储的数据18代表的是一个人的等级，那么变量名推荐命名为level</span>\nlevel <span class=\"token operator\">=</span> <span class=\"token number\">18</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>其他详细规范如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 命名规范</span>\n<span class=\"token number\">1.</span> 变量名只能是 字母、数字或下划线的任意组合\n<span class=\"token number\">2.</span> 变量名的第一个字符不能是数字\n<span class=\"token number\">3.</span> 关键字不能声明为变量名，常用关键字如下\n<span class=\"token punctuation\">[</span><span class=\"token string\">'and'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'as'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'assert'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'break'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'continue'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'def'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'del'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'elif'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'else'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'except'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'exec'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'finally'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'for'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'from'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'global'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'if'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'import'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'in'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'is'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lambda'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'not'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'or'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pass'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'print'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'raise'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'return'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'try'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'while'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'with'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yield'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 错误示范如下：</span>\n<span class=\"token operator\">*</span>a<span class=\"token operator\">=</span><span class=\"token number\">123</span>\n$b<span class=\"token operator\">=</span><span class=\"token number\">456</span>\nc$<span class=\"token operator\">=</span><span class=\"token number\">789</span>\n2_name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span>\n<span class=\"token number\">123</span><span class=\"token operator\">=</span><span class=\"token string\">'lili'</span>\n<span class=\"token keyword\">and</span><span class=\"token operator\">=</span><span class=\"token number\">123</span>\n年龄<span class=\"token operator\">=</span><span class=\"token number\">18</span> <span class=\"token comment\"># 强烈建议不要使用中文命名</span>\n\n<span class=\"token comment\"># 正确示范如下</span>\nage_of_jason<span class=\"token operator\">=</span><span class=\"token number\">31</span>\npage1<span class=\"token operator\">=</span><span class=\"token string\">'首页'</span>\n_class<span class=\"token operator\">=</span><span class=\"token string\">'终极一班'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-3、变量名的命名风格\"><a href=\"#3-3、变量名的命名风格\" class=\"headerlink\" title=\"3.3、变量名的命名风格\"></a>3.3、变量名的命名风格</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 风格一：驼峰体</span>\nAgeOfTony <span class=\"token operator\">=</span> <span class=\"token number\">56</span> \nNumberOfStudents <span class=\"token operator\">=</span> <span class=\"token number\">80</span>\n<span class=\"token comment\"># 风格二：纯小写下划线(在python中，变量名的命名推荐使用该风格)</span>\nage_of_tony <span class=\"token operator\">=</span> <span class=\"token number\">56</span> \nnumber_of_students <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-4、变量值的三大特性\"><a href=\"#3-4、变量值的三大特性\" class=\"headerlink\" title=\"3.4、变量值的三大特性\"></a>3.4、变量值的三大特性</h3><p>变量的值具备三大特性</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、id</span>\n反应的是变量在内存中的唯一编号，内存地址不同<span class=\"token builtin\">id</span>肯定不同\n\n<span class=\"token comment\">#2、type</span>\n变量值的类型\n\n<span class=\"token comment\">#3、value</span>\n变量值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看变量值三大特性的方式如下，我们将会在运算符中用到变量值的三大特性</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token string\">'Info Tony:18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>x\n<span class=\"token number\">4376607152</span>，<span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token string\">'str'</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span><span class=\"token string\">'Info Tony:18'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>了解：<a href=\"https://zhuanlan.zhihu.com/p/113408690\">Python是一门解释型的强类型动态语言</a></p>\n<h2 id=\"三、常量\"><a href=\"#三、常量\" class=\"headerlink\" title=\"三、常量\"></a>三、常量</h2><h2 id=\"3-1、什么是常量？\"><a href=\"#3-1、什么是常量？\" class=\"headerlink\" title=\"3.1、什么是常量？\"></a>3.1、什么是常量？</h2><p>常量指在程序运行过程中不会改变的量</p>\n<h2 id=\"3-2、为什么要有常量？\"><a href=\"#3-2、为什么要有常量？\" class=\"headerlink\" title=\"3.2、为什么要有常量？\"></a>3.2、为什么要有常量？</h2><p>在程序运行过程中，有些值是固定的、不应该被改变，比如圆周率 3.141592653…</p>\n<h2 id=\"3-3、怎么使用常量？\"><a href=\"#3-3、怎么使用常量？\" class=\"headerlink\" title=\"3.3、怎么使用常量？\"></a>3.3、怎么使用常量？</h2><p>在Python中没有一个专门的语法定义常量，约定俗成是用全部大写的变量名表示常量。如：PI&#x3D;3.14159。所以单从语法层面去讲，常量的使用与变量完全一致。</p>\n<p><img src=\"/../../../img/image-20220718091033465.png\" alt=\"image-20220718091033465\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=4\">https://www.bilibili.com/video/av73342471?p=4www.bilibili.com/video/av73342471?p=4</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p>我们知道学习 <strong>Python</strong> 语言的目的是为了与计算机进行沟通&#x2F;交流，从而控制计算机帮助我们做一些事情，所以，在 <strong>Python</strong> 语言的所有语法中，每个语法存在的意义都是为了让计算机能够像人类一样，直白地讲，就是让计算机具备我们人类的某一项技能。这是我们理解后续所有 <strong>Python</strong> 语法的根本，一定要熟记。</p>\n<h2 id=\"二-变量\"><a href=\"#二-变量\" class=\"headerlink\" title=\"二 变量\"></a>二 变量</h2><h2 id=\"一、什么是变量？\"><a href=\"#一、什么是变量？\" class=\"headerlink\" title=\"一、什么是变量？\"></a>一、什么是变量？</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 变量就是可以变化的量，量指的是事物的状态，比如人的年龄、性别，游戏角色的等级、金钱等等</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"二、为什么要有变量？\"><a href=\"#二、为什么要有变量？\" class=\"headerlink\" title=\"二、为什么要有变量？\"></a>二、为什么要有变量？</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 为了让计算机能够像人一样去记忆事物的某种状态，并且状态是可以发生变化的</span>\n<span class=\"token comment\"># 详细地说：</span>\n<span class=\"token comment\"># 程序执行的本质就是一系列状态的变化，变是程序执行的直接体现，所以我们需要有一种机制能够反映或者说是保存下来程序执行时状态，以及状态的变化。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n\n\n<h2 id=\"三、怎么使用变量（先定义、后使用）\"><a href=\"#三、怎么使用变量（先定义、后使用）\" class=\"headerlink\" title=\"三、怎么使用变量（先定义、后使用）\"></a>三、怎么使用变量（先定义、后使用）</h2><h3 id=\"3-1、变量的定义与使用\"><a href=\"#3-1、变量的定义与使用\" class=\"headerlink\" title=\"3.1、变量的定义与使用\"></a>3.1、变量的定义与使用</h3><p>变量的定义由三部分组成，如下图</p>\n<p><img src=\"/../../../img/image-20220718091017221.png\" alt=\"image-20220718091017221\"></p>\n<p>定义变量示范如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">name <span class=\"token operator\">=</span> <span class=\"token string\">'Jason'</span> <span class=\"token comment\"># 记下人的名字为'Jason'</span>\nsex <span class=\"token operator\">=</span> <span class=\"token string\">'男'</span>    <span class=\"token comment\"># 记下人的性别为男性</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span>      <span class=\"token comment\"># 记下人的年龄为18岁</span>\nsalary <span class=\"token operator\">=</span> <span class=\"token number\">30000.1</span>  <span class=\"token comment\"># 记下人的薪资为30000.1元</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>解释器执行到变量定义的代码时会申请内存空间存放变量值，然后将变量值的内存地址绑定给变量名，以变量的定义age&#x3D;18为例，如下图</p>\n<p>插图：定义变量申请内存</p>\n<p>通过变量名即可引用到对应的值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 通过变量名即可引用到值，我们可以结合print()功能将其打印出来</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>age<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 通过变量名age找到值18，然后执行print(18),输出：18</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2、变量名的命名规范\"><a href=\"#3-2、变量名的命名规范\" class=\"headerlink\" title=\"3.2、变量名的命名规范\"></a>3.2、变量名的命名规范</h3><p>变量名的命名应该见名知意</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 如果我们要存储的数据18代表的是一个人的年龄，那么变量名推荐命名为age</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span> \n<span class=\"token comment\"># 如果我们要存储的数据18代表的是一个人的等级，那么变量名推荐命名为level</span>\nlevel <span class=\"token operator\">=</span> <span class=\"token number\">18</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>其他详细规范如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 命名规范</span>\n<span class=\"token number\">1.</span> 变量名只能是 字母、数字或下划线的任意组合\n<span class=\"token number\">2.</span> 变量名的第一个字符不能是数字\n<span class=\"token number\">3.</span> 关键字不能声明为变量名，常用关键字如下\n<span class=\"token punctuation\">[</span><span class=\"token string\">'and'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'as'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'assert'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'break'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'class'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'continue'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'def'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'del'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'elif'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'else'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'except'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'exec'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'finally'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'for'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'from'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'global'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'if'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'import'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'in'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'is'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'lambda'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'not'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'or'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'pass'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'print'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'raise'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'return'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'try'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'while'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'with'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'yield'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 错误示范如下：</span>\n<span class=\"token operator\">*</span>a<span class=\"token operator\">=</span><span class=\"token number\">123</span>\n$b<span class=\"token operator\">=</span><span class=\"token number\">456</span>\nc$<span class=\"token operator\">=</span><span class=\"token number\">789</span>\n2_name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span>\n<span class=\"token number\">123</span><span class=\"token operator\">=</span><span class=\"token string\">'lili'</span>\n<span class=\"token keyword\">and</span><span class=\"token operator\">=</span><span class=\"token number\">123</span>\n年龄<span class=\"token operator\">=</span><span class=\"token number\">18</span> <span class=\"token comment\"># 强烈建议不要使用中文命名</span>\n\n<span class=\"token comment\"># 正确示范如下</span>\nage_of_jason<span class=\"token operator\">=</span><span class=\"token number\">31</span>\npage1<span class=\"token operator\">=</span><span class=\"token string\">'首页'</span>\n_class<span class=\"token operator\">=</span><span class=\"token string\">'终极一班'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-3、变量名的命名风格\"><a href=\"#3-3、变量名的命名风格\" class=\"headerlink\" title=\"3.3、变量名的命名风格\"></a>3.3、变量名的命名风格</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 风格一：驼峰体</span>\nAgeOfTony <span class=\"token operator\">=</span> <span class=\"token number\">56</span> \nNumberOfStudents <span class=\"token operator\">=</span> <span class=\"token number\">80</span>\n<span class=\"token comment\"># 风格二：纯小写下划线(在python中，变量名的命名推荐使用该风格)</span>\nage_of_tony <span class=\"token operator\">=</span> <span class=\"token number\">56</span> \nnumber_of_students <span class=\"token operator\">=</span> <span class=\"token number\">80</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-4、变量值的三大特性\"><a href=\"#3-4、变量值的三大特性\" class=\"headerlink\" title=\"3.4、变量值的三大特性\"></a>3.4、变量值的三大特性</h3><p>变量的值具备三大特性</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、id</span>\n反应的是变量在内存中的唯一编号，内存地址不同<span class=\"token builtin\">id</span>肯定不同\n\n<span class=\"token comment\">#2、type</span>\n变量值的类型\n\n<span class=\"token comment\">#3、value</span>\n变量值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看变量值三大特性的方式如下，我们将会在运算符中用到变量值的三大特性</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token string\">'Info Tony:18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">id</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>x\n<span class=\"token number\">4376607152</span>，<span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token string\">'str'</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span><span class=\"token string\">'Info Tony:18'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>了解：<a href=\"https://zhuanlan.zhihu.com/p/113408690\">Python是一门解释型的强类型动态语言</a></p>\n<h2 id=\"三、常量\"><a href=\"#三、常量\" class=\"headerlink\" title=\"三、常量\"></a>三、常量</h2><h2 id=\"3-1、什么是常量？\"><a href=\"#3-1、什么是常量？\" class=\"headerlink\" title=\"3.1、什么是常量？\"></a>3.1、什么是常量？</h2><p>常量指在程序运行过程中不会改变的量</p>\n<h2 id=\"3-2、为什么要有常量？\"><a href=\"#3-2、为什么要有常量？\" class=\"headerlink\" title=\"3.2、为什么要有常量？\"></a>3.2、为什么要有常量？</h2><p>在程序运行过程中，有些值是固定的、不应该被改变，比如圆周率 3.141592653…</p>\n<h2 id=\"3-3、怎么使用常量？\"><a href=\"#3-3、怎么使用常量？\" class=\"headerlink\" title=\"3.3、怎么使用常量？\"></a>3.3、怎么使用常量？</h2><p>在Python中没有一个专门的语法定义常量，约定俗成是用全部大写的变量名表示常量。如：PI&#x3D;3.14159。所以单从语法层面去讲，常量的使用与变量完全一致。</p>\n<p><img src=\"/../../../img/image-20220718091033465.png\" alt=\"image-20220718091033465\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=4\">https://www.bilibili.com/video/av73342471?p=4www.bilibili.com/video/av73342471?p=4</a></p>\n"},{"_content":"## 一 引入\n\n我们学习变量是为了让计算机能够像人一样去记忆事物的某种状态，而变量的值就是用来存储事物状态的，很明显事物的状态分成不同种类的（比如人的年龄，身高，职位，工资等等），所以变量值也应该有不同的类型，例如\n\n```python\nsalary = 3.1 # 用浮点型去记录薪资\nage = 18 # 用整型去记录年龄\nname = 'lili' # 用字符串类型去记录人名\n```\n\n![img](https://pic4.zhimg.com/80/v2-350a0a150010ed0dc13cf18062f4919b_720w.jpg)\n\n## 二 数字类型\n\n## 2.1 int整型\n\n### 2.1.1 作用\n\n用来记录人的年龄，出生年份，学生人数等整数相关的状态\n\n### 2.1.2 定义\n\n```python\nage=18\n\nbirthday=1990\n\nstudent_count=48\n```\n\n## 2.2 float浮点型\n\n### 2.2.1 作用\n\n用来记录人的身高，体重，薪资等小数相关的状态\n\n### 2.2.2 定义\n\n```python\nheight=172.3\n\nweight=103.5\n\nsalary=15000.89\n```\n\n## 2.3 数字类型的使用\n\n1 、数学运算\n\n```python\n>>> a = 1\n>>> b = 3\n>>> c = a + b\n>>> c\n4\n```\n\n2、比较大小\n\n```python\n>>> x = 10\n>>> y = 11\n>>> x > y\nFalse\n```\n\n## 三 字符串类型str\n\n## 3.1 作用\n\n用来记录人的名字，家庭住址，性别等描述性质的状态\n\n## 3.2 定义\n\n```python\nname = 'Tony'\n\naddress = '上海市浦东新区'\n\nsex = '男'\n```\n\n用单引号、双引号、多引号，都可以定义字符串，本质上是没有区别的，但是\n\n```python\n#1、需要考虑引号嵌套的配对问题\nmsg = \"My name is Tony , I'm 18 years old!\" #内层有单引号，外层就需要用双引号\n#2、多引号可以写多行字符串\nmsg = '''\n        天下只有两种人。比如一串葡萄到手，一种人挑最好的先吃，另一种人把最好的留到最后吃。\n        照例第一种人应该乐观，因为他每吃一颗都是吃剩的葡萄里最好的；第二种人应该悲观，因为他每吃一颗都是吃剩的葡萄里最坏的。\n        不过事实却适得其反，缘故是第二种人还有希望，第一种人只有回忆。\n      '''\n```\n\n## 3.3 使用\n\n```python\n数字可以进行加减乘除等运算，字符串呢？也可以，但只能进行\"相加\"和\"相乘\"运算。\n>>> name = 'tony'\n>>> age = '18'\n>>> name + age #相加其实就是简单的字符串拼接\n'tony18'\n>>> name * 5 #相乘就相当于将字符串相加了5次\n'tonytonytonytonytony'\n```\n\n![img](https://pic2.zhimg.com/80/v2-118b686f12172e202cd10eceb93a2edd_720w.jpg)\n\n## 四 列表list\n\n## 4.1 作用\n\n如果我们需要用一个变量记录多个学生的姓名，用数字类型是无法实现，字符串类型确实可以记录下来，比如\n\nstu_names='张三 李四 王五'，但存的目的是为了取，此时若想取出第二个学生的姓名实现起来相当麻烦，而列表类型就是专门用来记录多个同种属性的值（比如同一个班级多个学生的姓名、同一个人的多个爱好等），并且存取都十分方便\n\n## 4.2 定义\n\n```python\n>>> stu_names=['张三','李四','王五']\n```\n\n## 4.3 使用\n\n```python\n# 1、列表类型是用索引来对应值，索引代表的是数据的位置，从0开始计数\n>>> stu_names=['张三','李四','王五']\n>>> stu_names[0] \n'张三'\n>>> stu_names[1]\n'李四'\n>>> stu_names[2]\n'王五'\n# 2、列表可以嵌套，嵌套取值如下\n>>> students_info=[['tony',18,['jack',]],['jason',18,['play','sleep']]]\n>>> students_info[0][2][0] #取出第一个学生的第一个爱好\n'play'\n```\n\n## 五 字典dict\n\n## 5.1 作用\n\n如果我们需要用一个变量记录多个值，但多个值是不同属性的，比如人的姓名、年龄、身高，用列表可以存，但列表是用索引对应值的，而索引不能明确地表示值的含义，这就用到字典类型，字典类型是用key：value形式来存储数据，其中key可以对value有描述性的功能\n\n## 5.2 定义\n\n```python\n>>> person_info={'name':'tony','age':18,'height':185.3}\n```\n\n## 5.3 使用\n\n```python\n# 1、字典类型是用key来对应值，key可以对值有描述性的功能，通常为字符串类型\n>>> person_info={'name':'tony','age':18,'height':185.3}\n>>> person_info['name']\n'tony'\n>>> person_info['age']\n18\n>>> person_info['height']\n185.3\n# 2、字典可以嵌套，嵌套取值如下\n>>> students=[\n... {'name':'tony','age':38,'hobbies':['play','sleep']},\n... {'name':'jack','age':18,'hobbies':['read','sleep']},\n... {'name':'rose','age':58,'hobbies':['music','read','sleep']},\n... ]\n>>> students[1]['hobbies'][1] #取第二个学生的第二个爱好\n'sleep'\n```\n\n## 六 布尔bool\n\n## 6.1 作用\n\n用来记录真假这两种状态\n\n## 6.2 定义\n\n```python\n>>> is_ok = True\n>>> is_ok = False\n```\n\n## 6.3 使用\n\n```python\n通常用来当作判断的条件，我们将在if判断中用到它\n```\n\n![img](https://pic2.zhimg.com/80/v2-a933426890a5ab350b920e812f7d7b99_720w.jpg)\n\n## 视频链接：\n\n\n\n编辑于 2022-04-26 18:53","source":"_posts/03_Python/01_Python基础/04_Python语法入门之基本数据类型.md","raw":"## 一 引入\n\n我们学习变量是为了让计算机能够像人一样去记忆事物的某种状态，而变量的值就是用来存储事物状态的，很明显事物的状态分成不同种类的（比如人的年龄，身高，职位，工资等等），所以变量值也应该有不同的类型，例如\n\n```python\nsalary = 3.1 # 用浮点型去记录薪资\nage = 18 # 用整型去记录年龄\nname = 'lili' # 用字符串类型去记录人名\n```\n\n![img](https://pic4.zhimg.com/80/v2-350a0a150010ed0dc13cf18062f4919b_720w.jpg)\n\n## 二 数字类型\n\n## 2.1 int整型\n\n### 2.1.1 作用\n\n用来记录人的年龄，出生年份，学生人数等整数相关的状态\n\n### 2.1.2 定义\n\n```python\nage=18\n\nbirthday=1990\n\nstudent_count=48\n```\n\n## 2.2 float浮点型\n\n### 2.2.1 作用\n\n用来记录人的身高，体重，薪资等小数相关的状态\n\n### 2.2.2 定义\n\n```python\nheight=172.3\n\nweight=103.5\n\nsalary=15000.89\n```\n\n## 2.3 数字类型的使用\n\n1 、数学运算\n\n```python\n>>> a = 1\n>>> b = 3\n>>> c = a + b\n>>> c\n4\n```\n\n2、比较大小\n\n```python\n>>> x = 10\n>>> y = 11\n>>> x > y\nFalse\n```\n\n## 三 字符串类型str\n\n## 3.1 作用\n\n用来记录人的名字，家庭住址，性别等描述性质的状态\n\n## 3.2 定义\n\n```python\nname = 'Tony'\n\naddress = '上海市浦东新区'\n\nsex = '男'\n```\n\n用单引号、双引号、多引号，都可以定义字符串，本质上是没有区别的，但是\n\n```python\n#1、需要考虑引号嵌套的配对问题\nmsg = \"My name is Tony , I'm 18 years old!\" #内层有单引号，外层就需要用双引号\n#2、多引号可以写多行字符串\nmsg = '''\n        天下只有两种人。比如一串葡萄到手，一种人挑最好的先吃，另一种人把最好的留到最后吃。\n        照例第一种人应该乐观，因为他每吃一颗都是吃剩的葡萄里最好的；第二种人应该悲观，因为他每吃一颗都是吃剩的葡萄里最坏的。\n        不过事实却适得其反，缘故是第二种人还有希望，第一种人只有回忆。\n      '''\n```\n\n## 3.3 使用\n\n```python\n数字可以进行加减乘除等运算，字符串呢？也可以，但只能进行\"相加\"和\"相乘\"运算。\n>>> name = 'tony'\n>>> age = '18'\n>>> name + age #相加其实就是简单的字符串拼接\n'tony18'\n>>> name * 5 #相乘就相当于将字符串相加了5次\n'tonytonytonytonytony'\n```\n\n![img](https://pic2.zhimg.com/80/v2-118b686f12172e202cd10eceb93a2edd_720w.jpg)\n\n## 四 列表list\n\n## 4.1 作用\n\n如果我们需要用一个变量记录多个学生的姓名，用数字类型是无法实现，字符串类型确实可以记录下来，比如\n\nstu_names='张三 李四 王五'，但存的目的是为了取，此时若想取出第二个学生的姓名实现起来相当麻烦，而列表类型就是专门用来记录多个同种属性的值（比如同一个班级多个学生的姓名、同一个人的多个爱好等），并且存取都十分方便\n\n## 4.2 定义\n\n```python\n>>> stu_names=['张三','李四','王五']\n```\n\n## 4.3 使用\n\n```python\n# 1、列表类型是用索引来对应值，索引代表的是数据的位置，从0开始计数\n>>> stu_names=['张三','李四','王五']\n>>> stu_names[0] \n'张三'\n>>> stu_names[1]\n'李四'\n>>> stu_names[2]\n'王五'\n# 2、列表可以嵌套，嵌套取值如下\n>>> students_info=[['tony',18,['jack',]],['jason',18,['play','sleep']]]\n>>> students_info[0][2][0] #取出第一个学生的第一个爱好\n'play'\n```\n\n## 五 字典dict\n\n## 5.1 作用\n\n如果我们需要用一个变量记录多个值，但多个值是不同属性的，比如人的姓名、年龄、身高，用列表可以存，但列表是用索引对应值的，而索引不能明确地表示值的含义，这就用到字典类型，字典类型是用key：value形式来存储数据，其中key可以对value有描述性的功能\n\n## 5.2 定义\n\n```python\n>>> person_info={'name':'tony','age':18,'height':185.3}\n```\n\n## 5.3 使用\n\n```python\n# 1、字典类型是用key来对应值，key可以对值有描述性的功能，通常为字符串类型\n>>> person_info={'name':'tony','age':18,'height':185.3}\n>>> person_info['name']\n'tony'\n>>> person_info['age']\n18\n>>> person_info['height']\n185.3\n# 2、字典可以嵌套，嵌套取值如下\n>>> students=[\n... {'name':'tony','age':38,'hobbies':['play','sleep']},\n... {'name':'jack','age':18,'hobbies':['read','sleep']},\n... {'name':'rose','age':58,'hobbies':['music','read','sleep']},\n... ]\n>>> students[1]['hobbies'][1] #取第二个学生的第二个爱好\n'sleep'\n```\n\n## 六 布尔bool\n\n## 6.1 作用\n\n用来记录真假这两种状态\n\n## 6.2 定义\n\n```python\n>>> is_ok = True\n>>> is_ok = False\n```\n\n## 6.3 使用\n\n```python\n通常用来当作判断的条件，我们将在if判断中用到它\n```\n\n![img](https://pic2.zhimg.com/80/v2-a933426890a5ab350b920e812f7d7b99_720w.jpg)\n\n## 视频链接：\n\n\n\n编辑于 2022-04-26 18:53","slug":"03_Python/01_Python基础/04_Python语法入门之基本数据类型","published":1,"date":"2022-07-18T07:10:19.370Z","updated":"2022-07-18T07:10:19.370Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k13001za8v777gp34rd","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p>我们学习变量是为了让计算机能够像人一样去记忆事物的某种状态，而变量的值就是用来存储事物状态的，很明显事物的状态分成不同种类的（比如人的年龄，身高，职位，工资等等），所以变量值也应该有不同的类型，例如</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">salary <span class=\"token operator\">=</span> <span class=\"token number\">3.1</span> <span class=\"token comment\"># 用浮点型去记录薪资</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span> <span class=\"token comment\"># 用整型去记录年龄</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">'lili'</span> <span class=\"token comment\"># 用字符串类型去记录人名</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-350a0a150010ed0dc13cf18062f4919b_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-数字类型\"><a href=\"#二-数字类型\" class=\"headerlink\" title=\"二 数字类型\"></a>二 数字类型</h2><h2 id=\"2-1-int整型\"><a href=\"#2-1-int整型\" class=\"headerlink\" title=\"2.1 int整型\"></a>2.1 int整型</h2><h3 id=\"2-1-1-作用\"><a href=\"#2-1-1-作用\" class=\"headerlink\" title=\"2.1.1 作用\"></a>2.1.1 作用</h3><p>用来记录人的年龄，出生年份，学生人数等整数相关的状态</p>\n<h3 id=\"2-1-2-定义\"><a href=\"#2-1-2-定义\" class=\"headerlink\" title=\"2.1.2 定义\"></a>2.1.2 定义</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">age<span class=\"token operator\">=</span><span class=\"token number\">18</span>\n\nbirthday<span class=\"token operator\">=</span><span class=\"token number\">1990</span>\n\nstudent_count<span class=\"token operator\">=</span><span class=\"token number\">48</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-2-float浮点型\"><a href=\"#2-2-float浮点型\" class=\"headerlink\" title=\"2.2 float浮点型\"></a>2.2 float浮点型</h2><h3 id=\"2-2-1-作用\"><a href=\"#2-2-1-作用\" class=\"headerlink\" title=\"2.2.1 作用\"></a>2.2.1 作用</h3><p>用来记录人的身高，体重，薪资等小数相关的状态</p>\n<h3 id=\"2-2-2-定义\"><a href=\"#2-2-2-定义\" class=\"headerlink\" title=\"2.2.2 定义\"></a>2.2.2 定义</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">height<span class=\"token operator\">=</span><span class=\"token number\">172.3</span>\n\nweight<span class=\"token operator\">=</span><span class=\"token number\">103.5</span>\n\nsalary<span class=\"token operator\">=</span><span class=\"token number\">15000.89</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-3-数字类型的使用\"><a href=\"#2-3-数字类型的使用\" class=\"headerlink\" title=\"2.3 数字类型的使用\"></a>2.3 数字类型的使用</h2><p>1 、数学运算</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> b <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> c <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> c\n<span class=\"token number\">4</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、比较大小</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> y <span class=\"token operator\">=</span> <span class=\"token number\">11</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x <span class=\"token operator\">></span> y\n<span class=\"token boolean\">False</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三-字符串类型str\"><a href=\"#三-字符串类型str\" class=\"headerlink\" title=\"三 字符串类型str\"></a>三 字符串类型str</h2><h2 id=\"3-1-作用\"><a href=\"#3-1-作用\" class=\"headerlink\" title=\"3.1 作用\"></a>3.1 作用</h2><p>用来记录人的名字，家庭住址，性别等描述性质的状态</p>\n<h2 id=\"3-2-定义\"><a href=\"#3-2-定义\" class=\"headerlink\" title=\"3.2 定义\"></a>3.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">name <span class=\"token operator\">=</span> <span class=\"token string\">'Tony'</span>\n\naddress <span class=\"token operator\">=</span> <span class=\"token string\">'上海市浦东新区'</span>\n\nsex <span class=\"token operator\">=</span> <span class=\"token string\">'男'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用单引号、双引号、多引号，都可以定义字符串，本质上是没有区别的，但是</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、需要考虑引号嵌套的配对问题</span>\nmsg <span class=\"token operator\">=</span> <span class=\"token string\">\"My name is Tony , I'm 18 years old!\"</span> <span class=\"token comment\">#内层有单引号，外层就需要用双引号</span>\n<span class=\"token comment\">#2、多引号可以写多行字符串</span>\nmsg <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''\n        天下只有两种人。比如一串葡萄到手，一种人挑最好的先吃，另一种人把最好的留到最后吃。\n        照例第一种人应该乐观，因为他每吃一颗都是吃剩的葡萄里最好的；第二种人应该悲观，因为他每吃一颗都是吃剩的葡萄里最坏的。\n        不过事实却适得其反，缘故是第二种人还有希望，第一种人只有回忆。\n      '''</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-3-使用\"><a href=\"#3-3-使用\" class=\"headerlink\" title=\"3.3 使用\"></a>3.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">数字可以进行加减乘除等运算，字符串呢？也可以，但只能进行<span class=\"token string\">\"相加\"</span>和<span class=\"token string\">\"相乘\"</span>运算。\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">=</span> <span class=\"token string\">'tony'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> age <span class=\"token operator\">=</span> <span class=\"token string\">'18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">+</span> age <span class=\"token comment\">#相加其实就是简单的字符串拼接</span>\n<span class=\"token string\">'tony18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">*</span> <span class=\"token number\">5</span> <span class=\"token comment\">#相乘就相当于将字符串相加了5次</span>\n<span class=\"token string\">'tonytonytonytonytony'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-118b686f12172e202cd10eceb93a2edd_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-列表list\"><a href=\"#四-列表list\" class=\"headerlink\" title=\"四 列表list\"></a>四 列表list</h2><h2 id=\"4-1-作用\"><a href=\"#4-1-作用\" class=\"headerlink\" title=\"4.1 作用\"></a>4.1 作用</h2><p>如果我们需要用一个变量记录多个学生的姓名，用数字类型是无法实现，字符串类型确实可以记录下来，比如</p>\n<p>stu_names&#x3D;’张三 李四 王五’，但存的目的是为了取，此时若想取出第二个学生的姓名实现起来相当麻烦，而列表类型就是专门用来记录多个同种属性的值（比如同一个班级多个学生的姓名、同一个人的多个爱好等），并且存取都十分方便</p>\n<h2 id=\"4-2-定义\"><a href=\"#4-2-定义\" class=\"headerlink\" title=\"4.2 定义\"></a>4.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'李四'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'王五'</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"4-3-使用\"><a href=\"#4-3-使用\" class=\"headerlink\" title=\"4.3 使用\"></a>4.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、列表类型是用索引来对应值，索引代表的是数据的位置，从0开始计数</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'李四'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'王五'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> \n<span class=\"token string\">'张三'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'李四'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'王五'</span>\n<span class=\"token comment\"># 2、列表可以嵌套，嵌套取值如下</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students_info<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'jason'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'play'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students_info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#取出第一个学生的第一个爱好</span>\n<span class=\"token string\">'play'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五-字典dict\"><a href=\"#五-字典dict\" class=\"headerlink\" title=\"五 字典dict\"></a>五 字典dict</h2><h2 id=\"5-1-作用\"><a href=\"#5-1-作用\" class=\"headerlink\" title=\"5.1 作用\"></a>5.1 作用</h2><p>如果我们需要用一个变量记录多个值，但多个值是不同属性的，比如人的姓名、年龄、身高，用列表可以存，但列表是用索引对应值的，而索引不能明确地表示值的含义，这就用到字典类型，字典类型是用key：value形式来存储数据，其中key可以对value有描述性的功能</p>\n<h2 id=\"5-2-定义\"><a href=\"#5-2-定义\" class=\"headerlink\" title=\"5.2 定义\"></a>5.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">:</span><span class=\"token number\">185.3</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"5-3-使用\"><a href=\"#5-3-使用\" class=\"headerlink\" title=\"5.3 使用\"></a>5.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、字典类型是用key来对应值，key可以对值有描述性的功能，通常为字符串类型</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">:</span><span class=\"token number\">185.3</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'tony'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">]</span>\n<span class=\"token number\">18</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span>\n<span class=\"token number\">185.3</span>\n<span class=\"token comment\"># 2、字典可以嵌套，嵌套取值如下</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">38</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'play'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'rose'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">58</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'music'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#取第二个学生的第二个爱好</span>\n<span class=\"token string\">'sleep'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六-布尔bool\"><a href=\"#六-布尔bool\" class=\"headerlink\" title=\"六 布尔bool\"></a>六 布尔bool</h2><h2 id=\"6-1-作用\"><a href=\"#6-1-作用\" class=\"headerlink\" title=\"6.1 作用\"></a>6.1 作用</h2><p>用来记录真假这两种状态</p>\n<h2 id=\"6-2-定义\"><a href=\"#6-2-定义\" class=\"headerlink\" title=\"6.2 定义\"></a>6.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> is_ok <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> is_ok <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-3-使用\"><a href=\"#6-3-使用\" class=\"headerlink\" title=\"6.3 使用\"></a>6.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">通常用来当作判断的条件，我们将在<span class=\"token keyword\">if</span>判断中用到它<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-a933426890a5ab350b920e812f7d7b99_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>编辑于 2022-04-26 18:53</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p>我们学习变量是为了让计算机能够像人一样去记忆事物的某种状态，而变量的值就是用来存储事物状态的，很明显事物的状态分成不同种类的（比如人的年龄，身高，职位，工资等等），所以变量值也应该有不同的类型，例如</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">salary <span class=\"token operator\">=</span> <span class=\"token number\">3.1</span> <span class=\"token comment\"># 用浮点型去记录薪资</span>\nage <span class=\"token operator\">=</span> <span class=\"token number\">18</span> <span class=\"token comment\"># 用整型去记录年龄</span>\nname <span class=\"token operator\">=</span> <span class=\"token string\">'lili'</span> <span class=\"token comment\"># 用字符串类型去记录人名</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-350a0a150010ed0dc13cf18062f4919b_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-数字类型\"><a href=\"#二-数字类型\" class=\"headerlink\" title=\"二 数字类型\"></a>二 数字类型</h2><h2 id=\"2-1-int整型\"><a href=\"#2-1-int整型\" class=\"headerlink\" title=\"2.1 int整型\"></a>2.1 int整型</h2><h3 id=\"2-1-1-作用\"><a href=\"#2-1-1-作用\" class=\"headerlink\" title=\"2.1.1 作用\"></a>2.1.1 作用</h3><p>用来记录人的年龄，出生年份，学生人数等整数相关的状态</p>\n<h3 id=\"2-1-2-定义\"><a href=\"#2-1-2-定义\" class=\"headerlink\" title=\"2.1.2 定义\"></a>2.1.2 定义</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">age<span class=\"token operator\">=</span><span class=\"token number\">18</span>\n\nbirthday<span class=\"token operator\">=</span><span class=\"token number\">1990</span>\n\nstudent_count<span class=\"token operator\">=</span><span class=\"token number\">48</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-2-float浮点型\"><a href=\"#2-2-float浮点型\" class=\"headerlink\" title=\"2.2 float浮点型\"></a>2.2 float浮点型</h2><h3 id=\"2-2-1-作用\"><a href=\"#2-2-1-作用\" class=\"headerlink\" title=\"2.2.1 作用\"></a>2.2.1 作用</h3><p>用来记录人的身高，体重，薪资等小数相关的状态</p>\n<h3 id=\"2-2-2-定义\"><a href=\"#2-2-2-定义\" class=\"headerlink\" title=\"2.2.2 定义\"></a>2.2.2 定义</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">height<span class=\"token operator\">=</span><span class=\"token number\">172.3</span>\n\nweight<span class=\"token operator\">=</span><span class=\"token number\">103.5</span>\n\nsalary<span class=\"token operator\">=</span><span class=\"token number\">15000.89</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-3-数字类型的使用\"><a href=\"#2-3-数字类型的使用\" class=\"headerlink\" title=\"2.3 数字类型的使用\"></a>2.3 数字类型的使用</h2><p>1 、数学运算</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> b <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> c <span class=\"token operator\">=</span> a <span class=\"token operator\">+</span> b\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> c\n<span class=\"token number\">4</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、比较大小</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> y <span class=\"token operator\">=</span> <span class=\"token number\">11</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x <span class=\"token operator\">></span> y\n<span class=\"token boolean\">False</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三-字符串类型str\"><a href=\"#三-字符串类型str\" class=\"headerlink\" title=\"三 字符串类型str\"></a>三 字符串类型str</h2><h2 id=\"3-1-作用\"><a href=\"#3-1-作用\" class=\"headerlink\" title=\"3.1 作用\"></a>3.1 作用</h2><p>用来记录人的名字，家庭住址，性别等描述性质的状态</p>\n<h2 id=\"3-2-定义\"><a href=\"#3-2-定义\" class=\"headerlink\" title=\"3.2 定义\"></a>3.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">name <span class=\"token operator\">=</span> <span class=\"token string\">'Tony'</span>\n\naddress <span class=\"token operator\">=</span> <span class=\"token string\">'上海市浦东新区'</span>\n\nsex <span class=\"token operator\">=</span> <span class=\"token string\">'男'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用单引号、双引号、多引号，都可以定义字符串，本质上是没有区别的，但是</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、需要考虑引号嵌套的配对问题</span>\nmsg <span class=\"token operator\">=</span> <span class=\"token string\">\"My name is Tony , I'm 18 years old!\"</span> <span class=\"token comment\">#内层有单引号，外层就需要用双引号</span>\n<span class=\"token comment\">#2、多引号可以写多行字符串</span>\nmsg <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''\n        天下只有两种人。比如一串葡萄到手，一种人挑最好的先吃，另一种人把最好的留到最后吃。\n        照例第一种人应该乐观，因为他每吃一颗都是吃剩的葡萄里最好的；第二种人应该悲观，因为他每吃一颗都是吃剩的葡萄里最坏的。\n        不过事实却适得其反，缘故是第二种人还有希望，第一种人只有回忆。\n      '''</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"3-3-使用\"><a href=\"#3-3-使用\" class=\"headerlink\" title=\"3.3 使用\"></a>3.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">数字可以进行加减乘除等运算，字符串呢？也可以，但只能进行<span class=\"token string\">\"相加\"</span>和<span class=\"token string\">\"相乘\"</span>运算。\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">=</span> <span class=\"token string\">'tony'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> age <span class=\"token operator\">=</span> <span class=\"token string\">'18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">+</span> age <span class=\"token comment\">#相加其实就是简单的字符串拼接</span>\n<span class=\"token string\">'tony18'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> name <span class=\"token operator\">*</span> <span class=\"token number\">5</span> <span class=\"token comment\">#相乘就相当于将字符串相加了5次</span>\n<span class=\"token string\">'tonytonytonytonytony'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-118b686f12172e202cd10eceb93a2edd_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-列表list\"><a href=\"#四-列表list\" class=\"headerlink\" title=\"四 列表list\"></a>四 列表list</h2><h2 id=\"4-1-作用\"><a href=\"#4-1-作用\" class=\"headerlink\" title=\"4.1 作用\"></a>4.1 作用</h2><p>如果我们需要用一个变量记录多个学生的姓名，用数字类型是无法实现，字符串类型确实可以记录下来，比如</p>\n<p>stu_names&#x3D;’张三 李四 王五’，但存的目的是为了取，此时若想取出第二个学生的姓名实现起来相当麻烦，而列表类型就是专门用来记录多个同种属性的值（比如同一个班级多个学生的姓名、同一个人的多个爱好等），并且存取都十分方便</p>\n<h2 id=\"4-2-定义\"><a href=\"#4-2-定义\" class=\"headerlink\" title=\"4.2 定义\"></a>4.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'李四'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'王五'</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"4-3-使用\"><a href=\"#4-3-使用\" class=\"headerlink\" title=\"4.3 使用\"></a>4.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、列表类型是用索引来对应值，索引代表的是数据的位置，从0开始计数</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'张三'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'李四'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'王五'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> \n<span class=\"token string\">'张三'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'李四'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> stu_names<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'王五'</span>\n<span class=\"token comment\"># 2、列表可以嵌套，嵌套取值如下</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students_info<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'jason'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">[</span><span class=\"token string\">'play'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students_info<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#取出第一个学生的第一个爱好</span>\n<span class=\"token string\">'play'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"五-字典dict\"><a href=\"#五-字典dict\" class=\"headerlink\" title=\"五 字典dict\"></a>五 字典dict</h2><h2 id=\"5-1-作用\"><a href=\"#5-1-作用\" class=\"headerlink\" title=\"5.1 作用\"></a>5.1 作用</h2><p>如果我们需要用一个变量记录多个值，但多个值是不同属性的，比如人的姓名、年龄、身高，用列表可以存，但列表是用索引对应值的，而索引不能明确地表示值的含义，这就用到字典类型，字典类型是用key：value形式来存储数据，其中key可以对value有描述性的功能</p>\n<h2 id=\"5-2-定义\"><a href=\"#5-2-定义\" class=\"headerlink\" title=\"5.2 定义\"></a>5.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">:</span><span class=\"token number\">185.3</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"5-3-使用\"><a href=\"#5-3-使用\" class=\"headerlink\" title=\"5.3 使用\"></a>5.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、字典类型是用key来对应值，key可以对值有描述性的功能，通常为字符串类型</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">:</span><span class=\"token number\">185.3</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'tony'</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">]</span>\n<span class=\"token number\">18</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> person_info<span class=\"token punctuation\">[</span><span class=\"token string\">'height'</span><span class=\"token punctuation\">]</span>\n<span class=\"token number\">185.3</span>\n<span class=\"token comment\"># 2、字典可以嵌套，嵌套取值如下</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'tony'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">38</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'play'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'rose'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'age'</span><span class=\"token punctuation\">:</span><span class=\"token number\">58</span><span class=\"token punctuation\">,</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'music'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'read'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sleep'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> students<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'hobbies'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token comment\">#取第二个学生的第二个爱好</span>\n<span class=\"token string\">'sleep'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"六-布尔bool\"><a href=\"#六-布尔bool\" class=\"headerlink\" title=\"六 布尔bool\"></a>六 布尔bool</h2><h2 id=\"6-1-作用\"><a href=\"#6-1-作用\" class=\"headerlink\" title=\"6.1 作用\"></a>6.1 作用</h2><p>用来记录真假这两种状态</p>\n<h2 id=\"6-2-定义\"><a href=\"#6-2-定义\" class=\"headerlink\" title=\"6.2 定义\"></a>6.2 定义</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> is_ok <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> is_ok <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-3-使用\"><a href=\"#6-3-使用\" class=\"headerlink\" title=\"6.3 使用\"></a>6.3 使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">通常用来当作判断的条件，我们将在<span class=\"token keyword\">if</span>判断中用到它<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-a933426890a5ab350b920e812f7d7b99_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>编辑于 2022-04-26 18:53</p>\n"},{"_content":"## 一 引入\n\n 解释器在执行到定义变量的语法时，会申请内存空间来存放变量的值，而内存的容量是有限的，这就涉及到变量值所占用内存空间的回收问题，当一个变量值没有用了（简称垃圾）就应该将其占用的内存给回收掉，那什么样的变量值是没有用的呢？\n\n单从逻辑层面分析，我们定义变量将变量值存起来的目的是为了以后取出来使用，而取得变量值需要通过其绑定的直接引用（如x=10，10被x直接引用）或间接引用（如l=[x,]，x=10，10被x直接引用，而被容器类型l间接引用），所以当一个变量值不再绑定任何引用时，我们就无法再访问到该变量值了，该变量值自然就是没有用的，就应该被当成一个垃圾回收。\n\n毫无疑问，内存空间的申请与回收都是非常耗费精力的事情，而且存在很大的危险性，稍有不慎就有可能引发内存溢出问题，好在Cpython解释器提供了自动的垃圾回收机制来帮我们解决了这件事。\n\n![img](https://pic4.zhimg.com/80/v2-fdd6ee1176778e295514ae8f3d0d6053_720w.jpg)\n\n## 二、什么是垃圾回收机制？\n\n垃圾回收机制（简称GC）是Python解释器自带一种机，专门用来回收不可用的变量值所占用的内存空间\n\n## 三、为什么要用垃圾回收机制？\n\n程序运行过程中会申请大量的内存空间，而对于一些无用的内存空间如果不及时清理的话会导致内存使用殆尽（内存溢出），导致程序崩溃，因此管理内存是一件重要且繁杂的事情，而python解释器自带的垃圾回收机制把程序员从繁杂的内存管理中解放出来。\n\n![img](https://pic2.zhimg.com/80/v2-1dade7ff0e1a23520534e517b2cde6b1_720w.jpg)\n\n## 四、垃圾回收机制原理分析\n\nPython的GC模块主要运用了“引用计数”（reference counting）来跟踪和回收垃圾。在引用计数的基础上，还可以通过“标记-清除”（mark and sweep）解决容器对象可能产生的循环引用的问题，并且通过“分代回收”（generation collection）以空间换取时间的方式来进一步提高垃圾回收的效率。\n\n![img](https://pic1.zhimg.com/80/v2-d0747b871d71091eff8ab5b0ebb6b3b0_720w.jpg)\n\n## 4.1、什么是引用计数？\n\n引用计数就是：变量值被变量名关联的次数\n\n如：age=18\n\n变量值18被关联了一个变量名age，称之为引用计数为1\n\n![img](https://pic3.zhimg.com/80/v2-89915f2dc64db1fe79ce739a233bb09a_720w.jpg)\n\n引用计数增加：\n\nage=18 （此时，变量值18的引用计数为1）\n\nm=age （把age的内存地址给了m，此时，m,age都关联了18，所以变量值18的引用计数为2）\n\n![img](https://pic4.zhimg.com/80/v2-8a46e8993c193017bbbbca370ce6970b_720w.jpg)\n\n引用计数减少：\n\nage=10（名字age先与值18解除关联，再与3建立了关联，变量值18的引用计数为1）\n\ndel m（del的意思是解除变量名x与变量值18的关联关系，此时，变量18的引用计数为0）\n\n![img](https://pic3.zhimg.com/80/v2-6d0ed3fa462194215235ae22888b373a_720w.jpg)\n\n值18的引用计数一旦变为0，其占用的内存地址就应该被解释器的垃圾回收机制回收\n\n## 4.2、引用计数扩展阅读\n\n变量值被关联次数的增加或减少，都会引发引用计数机制的执行（增加或减少值的引用计数），这存在明显的效率问题。\n\n![img](https://pic1.zhimg.com/80/v2-2876d1bad8466226f58b1edcb84714a0_720w.jpg)\n\n如果说执行效率还仅仅是引用计数机制的一个软肋的话，那么很不幸，引用计数机制还存在着一个致命的弱点，即循环引用（也称交叉引用）\n\n```python\n# 如下我们定义了两个列表，简称列表1与列表2，变量名l1指向列表1，变量名l2指向列表2\n>>> l1=['xxx']  # 列表1被引用一次，列表1的引用计数变为1   \n>>> l2=['yyy']  # 列表2被引用一次，列表2的引用计数变为1   \n>>> l1.append(l2)             # 把列表2追加到l1中作为第二个元素，列表2的引用计数变为2\n>>> l2.append(l1)             # 把列表1追加到l2中作为第二个元素，列表1的引用计数变为2\n\n# l1与l2之间有相互引用\n# l1 = ['xxx'的内存地址,列表2的内存地址]\n# l2 = ['yyy'的内存地址,列表1的内存地址]\n>>> l1\n['xxx', ['yyy', [...]]]\n>>> l2\n['yyy', ['xxx', [...]]]\n>>> l1[1][1][0]\n'xxx'\n```\n\n循环引用会导致：值不再被任何名字关联，但是值的引用计数并不会为0，应该被回收但不能被回收，什么意思呢？试想一下，请看如下操作\n\n```python\n>>> del l1 # 列表1的引用计数减1，列表1的引用计数变为1\n>>> del l2 # 列表2的引用计数减1，列表2的引用计数变为1\n```\n\n此时，只剩下列表1与列表2之间的相互引用，两个列表的引用计数均不为0，但两个列表不再被任何其他对象关联，没有任何人可以再引用到它们，所以它俩占用内存空间应该被回收，但由于相互引用的存在，每一个对象的引用计数都不为0，因此这些对象所占用的内存永远不会被释放，所以循环引用是致命的，这与手动进行内存管理所产生的内存泄露毫无区别。 所以Python引入了“标记-清除” 与“分代回收”来分别解决引用计数的循环引用与效率低的问题\n\n![img](https://pic1.zhimg.com/80/v2-3c62f9500a8809200caa264257b93b14_720w.jpg)\n\n### 4.2.1 标记-清除\n\n容器对象（比如：list，set，dict，class，instance）都可以包含对其他对象的引用，所以都可能产生循环引用。而“标记-清除”计数就是为了解决循环引用的问题。\n\n在了解标记清除算法前，我们需要明确一点，关于变量的存储，内存中有两块区域：堆区与栈区，在定义变量时，变量名与值内存地址的关联关系存放于栈区，变量值存放于堆区，内存管理回收的则是堆区的内容，详解如下图,\n\n定义了两个变量x = 10、y = 20\n\n![img](https://pic1.zhimg.com/80/v2-73d5845ef7dc5a403333d2099d456fc0_720w.jpg)\n\n当我们执行x=y时，内存中的栈区与堆区变化如下\n\n![img](https://pic1.zhimg.com/80/v2-9ec5b20fd2c2d2e9c90194d57bcf7778_720w.jpg)\n\n标记/清除算法的做法是当应用程序可用的内存空间被耗尽的时，就会停止整个程序，然后进行两项工作，第一项则是标记，第二项则是清除\n\n```python\n#1、标记\n通俗地讲就是：标记的过程就行相当于从栈区出发一条线，“连接”到堆区，再由堆区间接“连接”到其他地址，凡是被这条自栈区起始的线连接到内存空间都属于可以访达的，会被标记为存活\n\n具体地：标记的过程其实就是，遍历所有的GC Roots对象(栈区中的所有内容或者线程都可以作为GC Roots对象），然后将所有GC Roots的对象可以直接或间接访问到的对象标记为存活的对象，其余的均为非存活对象，应该被清除。\n                          \n#2、清除\n清除的过程将遍历堆中所有的对象，将没有标记存活的对象全部清除掉。\n```\n\n直接引用指的是从栈区出发直接引用到的内存地址，间接引用指的是从栈区出发引用到堆区后再进一步引用到的内存地址，以我们之前的两个列表l1与l2为例画出如下图像\n\n![img](https://pic3.zhimg.com/80/v2-1bfee07a84fc747da5980d990430d10a_720w.jpg)\n\n当我们同时删除l1与l2时，会清理到栈区中l1与l2的内容\n\n![img](https://pic2.zhimg.com/80/v2-509de2bd1adfb0566368719c73620fbd_720w.jpg)\n\n这样在启用标记清除算法时，发现栈区内不再有l1与l2（只剩下堆区内二者的相互引用），于是列表1与列表2都没有被标记为存活，二者会被清理掉，这样就解决了循环引用带来的内存泄漏问题。\n\n### 4.2.2 分代回收\n\n背景：\n\n基于引用计数的回收机制，每次回收内存，都需要把所有对象的引用计数都遍历一遍，这是非常消耗时间的，于是引入了分代回收来提高回收效率，分代回收采用的是用“空间换时间”的策略。\n\n**分代：**\n\n分代回收的核心思想是：在历经多次扫描的情况下，都没有被回收的变量，gc机制就会认为，该变量是常用变量，gc对其扫描的频率会降低，具体实现原理如下：\n\n```python\n分代指的是根据存活时间来为变量划分不同等级（也就是不同的代）\n\n新定义的变量，放到新生代这个等级中，假设每隔1分钟扫描新生代一次，如果发现变量依然被引用，那么该对象的权重（权重本质就是个整数）加一，当变量的权重大于某个设定得值（假设为3），会将它移动到更高一级的青春代，青春代的gc扫描的频率低于新生代（扫描时间间隔更长），假设5分钟扫描青春代一次，这样每次gc需要扫描的变量的总个数就变少了，节省了扫描的总时间，接下来，青春代中的对象，也会以同样的方式被移动到老年代中。也就是等级（代）越高，被垃圾回收机制扫描的频率越低\n```\n\n**回收：**\n\n回收依然是使用引用计数作为回收的依据\n\n![img](https://pic1.zhimg.com/80/v2-2458685b385b338192d6b90628ed92a8_720w.jpg)\n\n虽然分代回收可以起到提升效率的效果，但也存在一定的缺点：\n\n```python\n#例如一个变量刚刚从新生代移入青春代，该变量的绑定关系就解除了，该变量应该被回收，但青春代的扫描频率低于新生代，\n```","source":"_posts/03_Python/01_Python基础/05_Python语法入门之垃圾回收机制.md","raw":"## 一 引入\n\n 解释器在执行到定义变量的语法时，会申请内存空间来存放变量的值，而内存的容量是有限的，这就涉及到变量值所占用内存空间的回收问题，当一个变量值没有用了（简称垃圾）就应该将其占用的内存给回收掉，那什么样的变量值是没有用的呢？\n\n单从逻辑层面分析，我们定义变量将变量值存起来的目的是为了以后取出来使用，而取得变量值需要通过其绑定的直接引用（如x=10，10被x直接引用）或间接引用（如l=[x,]，x=10，10被x直接引用，而被容器类型l间接引用），所以当一个变量值不再绑定任何引用时，我们就无法再访问到该变量值了，该变量值自然就是没有用的，就应该被当成一个垃圾回收。\n\n毫无疑问，内存空间的申请与回收都是非常耗费精力的事情，而且存在很大的危险性，稍有不慎就有可能引发内存溢出问题，好在Cpython解释器提供了自动的垃圾回收机制来帮我们解决了这件事。\n\n![img](https://pic4.zhimg.com/80/v2-fdd6ee1176778e295514ae8f3d0d6053_720w.jpg)\n\n## 二、什么是垃圾回收机制？\n\n垃圾回收机制（简称GC）是Python解释器自带一种机，专门用来回收不可用的变量值所占用的内存空间\n\n## 三、为什么要用垃圾回收机制？\n\n程序运行过程中会申请大量的内存空间，而对于一些无用的内存空间如果不及时清理的话会导致内存使用殆尽（内存溢出），导致程序崩溃，因此管理内存是一件重要且繁杂的事情，而python解释器自带的垃圾回收机制把程序员从繁杂的内存管理中解放出来。\n\n![img](https://pic2.zhimg.com/80/v2-1dade7ff0e1a23520534e517b2cde6b1_720w.jpg)\n\n## 四、垃圾回收机制原理分析\n\nPython的GC模块主要运用了“引用计数”（reference counting）来跟踪和回收垃圾。在引用计数的基础上，还可以通过“标记-清除”（mark and sweep）解决容器对象可能产生的循环引用的问题，并且通过“分代回收”（generation collection）以空间换取时间的方式来进一步提高垃圾回收的效率。\n\n![img](https://pic1.zhimg.com/80/v2-d0747b871d71091eff8ab5b0ebb6b3b0_720w.jpg)\n\n## 4.1、什么是引用计数？\n\n引用计数就是：变量值被变量名关联的次数\n\n如：age=18\n\n变量值18被关联了一个变量名age，称之为引用计数为1\n\n![img](https://pic3.zhimg.com/80/v2-89915f2dc64db1fe79ce739a233bb09a_720w.jpg)\n\n引用计数增加：\n\nage=18 （此时，变量值18的引用计数为1）\n\nm=age （把age的内存地址给了m，此时，m,age都关联了18，所以变量值18的引用计数为2）\n\n![img](https://pic4.zhimg.com/80/v2-8a46e8993c193017bbbbca370ce6970b_720w.jpg)\n\n引用计数减少：\n\nage=10（名字age先与值18解除关联，再与3建立了关联，变量值18的引用计数为1）\n\ndel m（del的意思是解除变量名x与变量值18的关联关系，此时，变量18的引用计数为0）\n\n![img](https://pic3.zhimg.com/80/v2-6d0ed3fa462194215235ae22888b373a_720w.jpg)\n\n值18的引用计数一旦变为0，其占用的内存地址就应该被解释器的垃圾回收机制回收\n\n## 4.2、引用计数扩展阅读\n\n变量值被关联次数的增加或减少，都会引发引用计数机制的执行（增加或减少值的引用计数），这存在明显的效率问题。\n\n![img](https://pic1.zhimg.com/80/v2-2876d1bad8466226f58b1edcb84714a0_720w.jpg)\n\n如果说执行效率还仅仅是引用计数机制的一个软肋的话，那么很不幸，引用计数机制还存在着一个致命的弱点，即循环引用（也称交叉引用）\n\n```python\n# 如下我们定义了两个列表，简称列表1与列表2，变量名l1指向列表1，变量名l2指向列表2\n>>> l1=['xxx']  # 列表1被引用一次，列表1的引用计数变为1   \n>>> l2=['yyy']  # 列表2被引用一次，列表2的引用计数变为1   \n>>> l1.append(l2)             # 把列表2追加到l1中作为第二个元素，列表2的引用计数变为2\n>>> l2.append(l1)             # 把列表1追加到l2中作为第二个元素，列表1的引用计数变为2\n\n# l1与l2之间有相互引用\n# l1 = ['xxx'的内存地址,列表2的内存地址]\n# l2 = ['yyy'的内存地址,列表1的内存地址]\n>>> l1\n['xxx', ['yyy', [...]]]\n>>> l2\n['yyy', ['xxx', [...]]]\n>>> l1[1][1][0]\n'xxx'\n```\n\n循环引用会导致：值不再被任何名字关联，但是值的引用计数并不会为0，应该被回收但不能被回收，什么意思呢？试想一下，请看如下操作\n\n```python\n>>> del l1 # 列表1的引用计数减1，列表1的引用计数变为1\n>>> del l2 # 列表2的引用计数减1，列表2的引用计数变为1\n```\n\n此时，只剩下列表1与列表2之间的相互引用，两个列表的引用计数均不为0，但两个列表不再被任何其他对象关联，没有任何人可以再引用到它们，所以它俩占用内存空间应该被回收，但由于相互引用的存在，每一个对象的引用计数都不为0，因此这些对象所占用的内存永远不会被释放，所以循环引用是致命的，这与手动进行内存管理所产生的内存泄露毫无区别。 所以Python引入了“标记-清除” 与“分代回收”来分别解决引用计数的循环引用与效率低的问题\n\n![img](https://pic1.zhimg.com/80/v2-3c62f9500a8809200caa264257b93b14_720w.jpg)\n\n### 4.2.1 标记-清除\n\n容器对象（比如：list，set，dict，class，instance）都可以包含对其他对象的引用，所以都可能产生循环引用。而“标记-清除”计数就是为了解决循环引用的问题。\n\n在了解标记清除算法前，我们需要明确一点，关于变量的存储，内存中有两块区域：堆区与栈区，在定义变量时，变量名与值内存地址的关联关系存放于栈区，变量值存放于堆区，内存管理回收的则是堆区的内容，详解如下图,\n\n定义了两个变量x = 10、y = 20\n\n![img](https://pic1.zhimg.com/80/v2-73d5845ef7dc5a403333d2099d456fc0_720w.jpg)\n\n当我们执行x=y时，内存中的栈区与堆区变化如下\n\n![img](https://pic1.zhimg.com/80/v2-9ec5b20fd2c2d2e9c90194d57bcf7778_720w.jpg)\n\n标记/清除算法的做法是当应用程序可用的内存空间被耗尽的时，就会停止整个程序，然后进行两项工作，第一项则是标记，第二项则是清除\n\n```python\n#1、标记\n通俗地讲就是：标记的过程就行相当于从栈区出发一条线，“连接”到堆区，再由堆区间接“连接”到其他地址，凡是被这条自栈区起始的线连接到内存空间都属于可以访达的，会被标记为存活\n\n具体地：标记的过程其实就是，遍历所有的GC Roots对象(栈区中的所有内容或者线程都可以作为GC Roots对象），然后将所有GC Roots的对象可以直接或间接访问到的对象标记为存活的对象，其余的均为非存活对象，应该被清除。\n                          \n#2、清除\n清除的过程将遍历堆中所有的对象，将没有标记存活的对象全部清除掉。\n```\n\n直接引用指的是从栈区出发直接引用到的内存地址，间接引用指的是从栈区出发引用到堆区后再进一步引用到的内存地址，以我们之前的两个列表l1与l2为例画出如下图像\n\n![img](https://pic3.zhimg.com/80/v2-1bfee07a84fc747da5980d990430d10a_720w.jpg)\n\n当我们同时删除l1与l2时，会清理到栈区中l1与l2的内容\n\n![img](https://pic2.zhimg.com/80/v2-509de2bd1adfb0566368719c73620fbd_720w.jpg)\n\n这样在启用标记清除算法时，发现栈区内不再有l1与l2（只剩下堆区内二者的相互引用），于是列表1与列表2都没有被标记为存活，二者会被清理掉，这样就解决了循环引用带来的内存泄漏问题。\n\n### 4.2.2 分代回收\n\n背景：\n\n基于引用计数的回收机制，每次回收内存，都需要把所有对象的引用计数都遍历一遍，这是非常消耗时间的，于是引入了分代回收来提高回收效率，分代回收采用的是用“空间换时间”的策略。\n\n**分代：**\n\n分代回收的核心思想是：在历经多次扫描的情况下，都没有被回收的变量，gc机制就会认为，该变量是常用变量，gc对其扫描的频率会降低，具体实现原理如下：\n\n```python\n分代指的是根据存活时间来为变量划分不同等级（也就是不同的代）\n\n新定义的变量，放到新生代这个等级中，假设每隔1分钟扫描新生代一次，如果发现变量依然被引用，那么该对象的权重（权重本质就是个整数）加一，当变量的权重大于某个设定得值（假设为3），会将它移动到更高一级的青春代，青春代的gc扫描的频率低于新生代（扫描时间间隔更长），假设5分钟扫描青春代一次，这样每次gc需要扫描的变量的总个数就变少了，节省了扫描的总时间，接下来，青春代中的对象，也会以同样的方式被移动到老年代中。也就是等级（代）越高，被垃圾回收机制扫描的频率越低\n```\n\n**回收：**\n\n回收依然是使用引用计数作为回收的依据\n\n![img](https://pic1.zhimg.com/80/v2-2458685b385b338192d6b90628ed92a8_720w.jpg)\n\n虽然分代回收可以起到提升效率的效果，但也存在一定的缺点：\n\n```python\n#例如一个变量刚刚从新生代移入青春代，该变量的绑定关系就解除了，该变量应该被回收，但青春代的扫描频率低于新生代，\n```","slug":"03_Python/01_Python基础/05_Python语法入门之垃圾回收机制","published":1,"date":"2022-07-18T07:10:19.370Z","updated":"2022-07-18T07:10:19.370Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k140021a8v76ylw120m","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 解释器在执行到定义变量的语法时，会申请内存空间来存放变量的值，而内存的容量是有限的，这就涉及到变量值所占用内存空间的回收问题，当一个变量值没有用了（简称垃圾）就应该将其占用的内存给回收掉，那什么样的变量值是没有用的呢？</p>\n<p>单从逻辑层面分析，我们定义变量将变量值存起来的目的是为了以后取出来使用，而取得变量值需要通过其绑定的直接引用（如x&#x3D;10，10被x直接引用）或间接引用（如l&#x3D;[x,]，x&#x3D;10，10被x直接引用，而被容器类型l间接引用），所以当一个变量值不再绑定任何引用时，我们就无法再访问到该变量值了，该变量值自然就是没有用的，就应该被当成一个垃圾回收。</p>\n<p>毫无疑问，内存空间的申请与回收都是非常耗费精力的事情，而且存在很大的危险性，稍有不慎就有可能引发内存溢出问题，好在Cpython解释器提供了自动的垃圾回收机制来帮我们解决了这件事。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-fdd6ee1176778e295514ae8f3d0d6053_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二、什么是垃圾回收机制？\"><a href=\"#二、什么是垃圾回收机制？\" class=\"headerlink\" title=\"二、什么是垃圾回收机制？\"></a>二、什么是垃圾回收机制？</h2><p>垃圾回收机制（简称GC）是Python解释器自带一种机，专门用来回收不可用的变量值所占用的内存空间</p>\n<h2 id=\"三、为什么要用垃圾回收机制？\"><a href=\"#三、为什么要用垃圾回收机制？\" class=\"headerlink\" title=\"三、为什么要用垃圾回收机制？\"></a>三、为什么要用垃圾回收机制？</h2><p>程序运行过程中会申请大量的内存空间，而对于一些无用的内存空间如果不及时清理的话会导致内存使用殆尽（内存溢出），导致程序崩溃，因此管理内存是一件重要且繁杂的事情，而python解释器自带的垃圾回收机制把程序员从繁杂的内存管理中解放出来。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-1dade7ff0e1a23520534e517b2cde6b1_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四、垃圾回收机制原理分析\"><a href=\"#四、垃圾回收机制原理分析\" class=\"headerlink\" title=\"四、垃圾回收机制原理分析\"></a>四、垃圾回收机制原理分析</h2><p>Python的GC模块主要运用了“引用计数”（reference counting）来跟踪和回收垃圾。在引用计数的基础上，还可以通过“标记-清除”（mark and sweep）解决容器对象可能产生的循环引用的问题，并且通过“分代回收”（generation collection）以空间换取时间的方式来进一步提高垃圾回收的效率。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-d0747b871d71091eff8ab5b0ebb6b3b0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-1、什么是引用计数？\"><a href=\"#4-1、什么是引用计数？\" class=\"headerlink\" title=\"4.1、什么是引用计数？\"></a>4.1、什么是引用计数？</h2><p>引用计数就是：变量值被变量名关联的次数</p>\n<p>如：age&#x3D;18</p>\n<p>变量值18被关联了一个变量名age，称之为引用计数为1</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-89915f2dc64db1fe79ce739a233bb09a_720w.jpg\" alt=\"img\"></p>\n<p>引用计数增加：</p>\n<p>age&#x3D;18 （此时，变量值18的引用计数为1）</p>\n<p>m&#x3D;age （把age的内存地址给了m，此时，m,age都关联了18，所以变量值18的引用计数为2）</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-8a46e8993c193017bbbbca370ce6970b_720w.jpg\" alt=\"img\"></p>\n<p>引用计数减少：</p>\n<p>age&#x3D;10（名字age先与值18解除关联，再与3建立了关联，变量值18的引用计数为1）</p>\n<p>del m（del的意思是解除变量名x与变量值18的关联关系，此时，变量18的引用计数为0）</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-6d0ed3fa462194215235ae22888b373a_720w.jpg\" alt=\"img\"></p>\n<p>值18的引用计数一旦变为0，其占用的内存地址就应该被解释器的垃圾回收机制回收</p>\n<h2 id=\"4-2、引用计数扩展阅读\"><a href=\"#4-2、引用计数扩展阅读\" class=\"headerlink\" title=\"4.2、引用计数扩展阅读\"></a>4.2、引用计数扩展阅读</h2><p>变量值被关联次数的增加或减少，都会引发引用计数机制的执行（增加或减少值的引用计数），这存在明显的效率问题。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-2876d1bad8466226f58b1edcb84714a0_720w.jpg\" alt=\"img\"></p>\n<p>如果说执行效率还仅仅是引用计数机制的一个软肋的话，那么很不幸，引用计数机制还存在着一个致命的弱点，即循环引用（也称交叉引用）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 如下我们定义了两个列表，简称列表1与列表2，变量名l1指向列表1，变量名l2指向列表2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 列表1被引用一次，列表1的引用计数变为1   </span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 列表2被引用一次，列表2的引用计数变为1   </span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>l2<span class=\"token punctuation\">)</span>             <span class=\"token comment\"># 把列表2追加到l1中作为第二个元素，列表2的引用计数变为2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>l1<span class=\"token punctuation\">)</span>             <span class=\"token comment\"># 把列表1追加到l2中作为第二个元素，列表1的引用计数变为2</span>\n\n<span class=\"token comment\"># l1与l2之间有相互引用</span>\n<span class=\"token comment\"># l1 = ['xxx'的内存地址,列表2的内存地址]</span>\n<span class=\"token comment\"># l2 = ['yyy'的内存地址,列表1的内存地址]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1\n<span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2\n<span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'xxx'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>循环引用会导致：值不再被任何名字关联，但是值的引用计数并不会为0，应该被回收但不能被回收，什么意思呢？试想一下，请看如下操作</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">del</span> l1 <span class=\"token comment\"># 列表1的引用计数减1，列表1的引用计数变为1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">del</span> l2 <span class=\"token comment\"># 列表2的引用计数减1，列表2的引用计数变为1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>此时，只剩下列表1与列表2之间的相互引用，两个列表的引用计数均不为0，但两个列表不再被任何其他对象关联，没有任何人可以再引用到它们，所以它俩占用内存空间应该被回收，但由于相互引用的存在，每一个对象的引用计数都不为0，因此这些对象所占用的内存永远不会被释放，所以循环引用是致命的，这与手动进行内存管理所产生的内存泄露毫无区别。 所以Python引入了“标记-清除” 与“分代回收”来分别解决引用计数的循环引用与效率低的问题</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-3c62f9500a8809200caa264257b93b14_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"4-2-1-标记-清除\"><a href=\"#4-2-1-标记-清除\" class=\"headerlink\" title=\"4.2.1 标记-清除\"></a>4.2.1 标记-清除</h3><p>容器对象（比如：list，set，dict，class，instance）都可以包含对其他对象的引用，所以都可能产生循环引用。而“标记-清除”计数就是为了解决循环引用的问题。</p>\n<p>在了解标记清除算法前，我们需要明确一点，关于变量的存储，内存中有两块区域：堆区与栈区，在定义变量时，变量名与值内存地址的关联关系存放于栈区，变量值存放于堆区，内存管理回收的则是堆区的内容，详解如下图,</p>\n<p>定义了两个变量x &#x3D; 10、y &#x3D; 20</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-73d5845ef7dc5a403333d2099d456fc0_720w.jpg\" alt=\"img\"></p>\n<p>当我们执行x&#x3D;y时，内存中的栈区与堆区变化如下</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-9ec5b20fd2c2d2e9c90194d57bcf7778_720w.jpg\" alt=\"img\"></p>\n<p>标记&#x2F;清除算法的做法是当应用程序可用的内存空间被耗尽的时，就会停止整个程序，然后进行两项工作，第一项则是标记，第二项则是清除</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、标记</span>\n通俗地讲就是：标记的过程就行相当于从栈区出发一条线，“连接”到堆区，再由堆区间接“连接”到其他地址，凡是被这条自栈区起始的线连接到内存空间都属于可以访达的，会被标记为存活\n\n具体地：标记的过程其实就是，遍历所有的GC Roots对象<span class=\"token punctuation\">(</span>栈区中的所有内容或者线程都可以作为GC Roots对象），然后将所有GC Roots的对象可以直接或间接访问到的对象标记为存活的对象，其余的均为非存活对象，应该被清除。\n                          \n<span class=\"token comment\">#2、清除</span>\n清除的过程将遍历堆中所有的对象，将没有标记存活的对象全部清除掉。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>直接引用指的是从栈区出发直接引用到的内存地址，间接引用指的是从栈区出发引用到堆区后再进一步引用到的内存地址，以我们之前的两个列表l1与l2为例画出如下图像</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-1bfee07a84fc747da5980d990430d10a_720w.jpg\" alt=\"img\"></p>\n<p>当我们同时删除l1与l2时，会清理到栈区中l1与l2的内容</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-509de2bd1adfb0566368719c73620fbd_720w.jpg\" alt=\"img\"></p>\n<p>这样在启用标记清除算法时，发现栈区内不再有l1与l2（只剩下堆区内二者的相互引用），于是列表1与列表2都没有被标记为存活，二者会被清理掉，这样就解决了循环引用带来的内存泄漏问题。</p>\n<h3 id=\"4-2-2-分代回收\"><a href=\"#4-2-2-分代回收\" class=\"headerlink\" title=\"4.2.2 分代回收\"></a>4.2.2 分代回收</h3><p>背景：</p>\n<p>基于引用计数的回收机制，每次回收内存，都需要把所有对象的引用计数都遍历一遍，这是非常消耗时间的，于是引入了分代回收来提高回收效率，分代回收采用的是用“空间换时间”的策略。</p>\n<p><strong>分代：</strong></p>\n<p>分代回收的核心思想是：在历经多次扫描的情况下，都没有被回收的变量，gc机制就会认为，该变量是常用变量，gc对其扫描的频率会降低，具体实现原理如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">分代指的是根据存活时间来为变量划分不同等级（也就是不同的代）\n\n新定义的变量，放到新生代这个等级中，假设每隔<span class=\"token number\">1</span>分钟扫描新生代一次，如果发现变量依然被引用，那么该对象的权重（权重本质就是个整数）加一，当变量的权重大于某个设定得值（假设为<span class=\"token number\">3</span>），会将它移动到更高一级的青春代，青春代的gc扫描的频率低于新生代（扫描时间间隔更长），假设<span class=\"token number\">5</span>分钟扫描青春代一次，这样每次gc需要扫描的变量的总个数就变少了，节省了扫描的总时间，接下来，青春代中的对象，也会以同样的方式被移动到老年代中。也就是等级（代）越高，被垃圾回收机制扫描的频率越低<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><strong>回收：</strong></p>\n<p>回收依然是使用引用计数作为回收的依据</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-2458685b385b338192d6b90628ed92a8_720w.jpg\" alt=\"img\"></p>\n<p>虽然分代回收可以起到提升效率的效果，但也存在一定的缺点：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#例如一个变量刚刚从新生代移入青春代，该变量的绑定关系就解除了，该变量应该被回收，但青春代的扫描频率低于新生代，</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 解释器在执行到定义变量的语法时，会申请内存空间来存放变量的值，而内存的容量是有限的，这就涉及到变量值所占用内存空间的回收问题，当一个变量值没有用了（简称垃圾）就应该将其占用的内存给回收掉，那什么样的变量值是没有用的呢？</p>\n<p>单从逻辑层面分析，我们定义变量将变量值存起来的目的是为了以后取出来使用，而取得变量值需要通过其绑定的直接引用（如x&#x3D;10，10被x直接引用）或间接引用（如l&#x3D;[x,]，x&#x3D;10，10被x直接引用，而被容器类型l间接引用），所以当一个变量值不再绑定任何引用时，我们就无法再访问到该变量值了，该变量值自然就是没有用的，就应该被当成一个垃圾回收。</p>\n<p>毫无疑问，内存空间的申请与回收都是非常耗费精力的事情，而且存在很大的危险性，稍有不慎就有可能引发内存溢出问题，好在Cpython解释器提供了自动的垃圾回收机制来帮我们解决了这件事。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-fdd6ee1176778e295514ae8f3d0d6053_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二、什么是垃圾回收机制？\"><a href=\"#二、什么是垃圾回收机制？\" class=\"headerlink\" title=\"二、什么是垃圾回收机制？\"></a>二、什么是垃圾回收机制？</h2><p>垃圾回收机制（简称GC）是Python解释器自带一种机，专门用来回收不可用的变量值所占用的内存空间</p>\n<h2 id=\"三、为什么要用垃圾回收机制？\"><a href=\"#三、为什么要用垃圾回收机制？\" class=\"headerlink\" title=\"三、为什么要用垃圾回收机制？\"></a>三、为什么要用垃圾回收机制？</h2><p>程序运行过程中会申请大量的内存空间，而对于一些无用的内存空间如果不及时清理的话会导致内存使用殆尽（内存溢出），导致程序崩溃，因此管理内存是一件重要且繁杂的事情，而python解释器自带的垃圾回收机制把程序员从繁杂的内存管理中解放出来。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-1dade7ff0e1a23520534e517b2cde6b1_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四、垃圾回收机制原理分析\"><a href=\"#四、垃圾回收机制原理分析\" class=\"headerlink\" title=\"四、垃圾回收机制原理分析\"></a>四、垃圾回收机制原理分析</h2><p>Python的GC模块主要运用了“引用计数”（reference counting）来跟踪和回收垃圾。在引用计数的基础上，还可以通过“标记-清除”（mark and sweep）解决容器对象可能产生的循环引用的问题，并且通过“分代回收”（generation collection）以空间换取时间的方式来进一步提高垃圾回收的效率。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-d0747b871d71091eff8ab5b0ebb6b3b0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-1、什么是引用计数？\"><a href=\"#4-1、什么是引用计数？\" class=\"headerlink\" title=\"4.1、什么是引用计数？\"></a>4.1、什么是引用计数？</h2><p>引用计数就是：变量值被变量名关联的次数</p>\n<p>如：age&#x3D;18</p>\n<p>变量值18被关联了一个变量名age，称之为引用计数为1</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-89915f2dc64db1fe79ce739a233bb09a_720w.jpg\" alt=\"img\"></p>\n<p>引用计数增加：</p>\n<p>age&#x3D;18 （此时，变量值18的引用计数为1）</p>\n<p>m&#x3D;age （把age的内存地址给了m，此时，m,age都关联了18，所以变量值18的引用计数为2）</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-8a46e8993c193017bbbbca370ce6970b_720w.jpg\" alt=\"img\"></p>\n<p>引用计数减少：</p>\n<p>age&#x3D;10（名字age先与值18解除关联，再与3建立了关联，变量值18的引用计数为1）</p>\n<p>del m（del的意思是解除变量名x与变量值18的关联关系，此时，变量18的引用计数为0）</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-6d0ed3fa462194215235ae22888b373a_720w.jpg\" alt=\"img\"></p>\n<p>值18的引用计数一旦变为0，其占用的内存地址就应该被解释器的垃圾回收机制回收</p>\n<h2 id=\"4-2、引用计数扩展阅读\"><a href=\"#4-2、引用计数扩展阅读\" class=\"headerlink\" title=\"4.2、引用计数扩展阅读\"></a>4.2、引用计数扩展阅读</h2><p>变量值被关联次数的增加或减少，都会引发引用计数机制的执行（增加或减少值的引用计数），这存在明显的效率问题。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-2876d1bad8466226f58b1edcb84714a0_720w.jpg\" alt=\"img\"></p>\n<p>如果说执行效率还仅仅是引用计数机制的一个软肋的话，那么很不幸，引用计数机制还存在着一个致命的弱点，即循环引用（也称交叉引用）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 如下我们定义了两个列表，简称列表1与列表2，变量名l1指向列表1，变量名l2指向列表2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 列表1被引用一次，列表1的引用计数变为1   </span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># 列表2被引用一次，列表2的引用计数变为1   </span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>l2<span class=\"token punctuation\">)</span>             <span class=\"token comment\"># 把列表2追加到l1中作为第二个元素，列表2的引用计数变为2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>l1<span class=\"token punctuation\">)</span>             <span class=\"token comment\"># 把列表1追加到l2中作为第二个元素，列表1的引用计数变为2</span>\n\n<span class=\"token comment\"># l1与l2之间有相互引用</span>\n<span class=\"token comment\"># l1 = ['xxx'的内存地址,列表2的内存地址]</span>\n<span class=\"token comment\"># l2 = ['yyy'的内存地址,列表1的内存地址]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1\n<span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l2\n<span class=\"token punctuation\">[</span><span class=\"token string\">'yyy'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> l1<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n<span class=\"token string\">'xxx'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>循环引用会导致：值不再被任何名字关联，但是值的引用计数并不会为0，应该被回收但不能被回收，什么意思呢？试想一下，请看如下操作</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">del</span> l1 <span class=\"token comment\"># 列表1的引用计数减1，列表1的引用计数变为1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">del</span> l2 <span class=\"token comment\"># 列表2的引用计数减1，列表2的引用计数变为1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>此时，只剩下列表1与列表2之间的相互引用，两个列表的引用计数均不为0，但两个列表不再被任何其他对象关联，没有任何人可以再引用到它们，所以它俩占用内存空间应该被回收，但由于相互引用的存在，每一个对象的引用计数都不为0，因此这些对象所占用的内存永远不会被释放，所以循环引用是致命的，这与手动进行内存管理所产生的内存泄露毫无区别。 所以Python引入了“标记-清除” 与“分代回收”来分别解决引用计数的循环引用与效率低的问题</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-3c62f9500a8809200caa264257b93b14_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"4-2-1-标记-清除\"><a href=\"#4-2-1-标记-清除\" class=\"headerlink\" title=\"4.2.1 标记-清除\"></a>4.2.1 标记-清除</h3><p>容器对象（比如：list，set，dict，class，instance）都可以包含对其他对象的引用，所以都可能产生循环引用。而“标记-清除”计数就是为了解决循环引用的问题。</p>\n<p>在了解标记清除算法前，我们需要明确一点，关于变量的存储，内存中有两块区域：堆区与栈区，在定义变量时，变量名与值内存地址的关联关系存放于栈区，变量值存放于堆区，内存管理回收的则是堆区的内容，详解如下图,</p>\n<p>定义了两个变量x &#x3D; 10、y &#x3D; 20</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-73d5845ef7dc5a403333d2099d456fc0_720w.jpg\" alt=\"img\"></p>\n<p>当我们执行x&#x3D;y时，内存中的栈区与堆区变化如下</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-9ec5b20fd2c2d2e9c90194d57bcf7778_720w.jpg\" alt=\"img\"></p>\n<p>标记&#x2F;清除算法的做法是当应用程序可用的内存空间被耗尽的时，就会停止整个程序，然后进行两项工作，第一项则是标记，第二项则是清除</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、标记</span>\n通俗地讲就是：标记的过程就行相当于从栈区出发一条线，“连接”到堆区，再由堆区间接“连接”到其他地址，凡是被这条自栈区起始的线连接到内存空间都属于可以访达的，会被标记为存活\n\n具体地：标记的过程其实就是，遍历所有的GC Roots对象<span class=\"token punctuation\">(</span>栈区中的所有内容或者线程都可以作为GC Roots对象），然后将所有GC Roots的对象可以直接或间接访问到的对象标记为存活的对象，其余的均为非存活对象，应该被清除。\n                          \n<span class=\"token comment\">#2、清除</span>\n清除的过程将遍历堆中所有的对象，将没有标记存活的对象全部清除掉。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>直接引用指的是从栈区出发直接引用到的内存地址，间接引用指的是从栈区出发引用到堆区后再进一步引用到的内存地址，以我们之前的两个列表l1与l2为例画出如下图像</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-1bfee07a84fc747da5980d990430d10a_720w.jpg\" alt=\"img\"></p>\n<p>当我们同时删除l1与l2时，会清理到栈区中l1与l2的内容</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-509de2bd1adfb0566368719c73620fbd_720w.jpg\" alt=\"img\"></p>\n<p>这样在启用标记清除算法时，发现栈区内不再有l1与l2（只剩下堆区内二者的相互引用），于是列表1与列表2都没有被标记为存活，二者会被清理掉，这样就解决了循环引用带来的内存泄漏问题。</p>\n<h3 id=\"4-2-2-分代回收\"><a href=\"#4-2-2-分代回收\" class=\"headerlink\" title=\"4.2.2 分代回收\"></a>4.2.2 分代回收</h3><p>背景：</p>\n<p>基于引用计数的回收机制，每次回收内存，都需要把所有对象的引用计数都遍历一遍，这是非常消耗时间的，于是引入了分代回收来提高回收效率，分代回收采用的是用“空间换时间”的策略。</p>\n<p><strong>分代：</strong></p>\n<p>分代回收的核心思想是：在历经多次扫描的情况下，都没有被回收的变量，gc机制就会认为，该变量是常用变量，gc对其扫描的频率会降低，具体实现原理如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">分代指的是根据存活时间来为变量划分不同等级（也就是不同的代）\n\n新定义的变量，放到新生代这个等级中，假设每隔<span class=\"token number\">1</span>分钟扫描新生代一次，如果发现变量依然被引用，那么该对象的权重（权重本质就是个整数）加一，当变量的权重大于某个设定得值（假设为<span class=\"token number\">3</span>），会将它移动到更高一级的青春代，青春代的gc扫描的频率低于新生代（扫描时间间隔更长），假设<span class=\"token number\">5</span>分钟扫描青春代一次，这样每次gc需要扫描的变量的总个数就变少了，节省了扫描的总时间，接下来，青春代中的对象，也会以同样的方式被移动到老年代中。也就是等级（代）越高，被垃圾回收机制扫描的频率越低<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><strong>回收：</strong></p>\n<p>回收依然是使用引用计数作为回收的依据</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-2458685b385b338192d6b90628ed92a8_720w.jpg\" alt=\"img\"></p>\n<p>虽然分代回收可以起到提升效率的效果，但也存在一定的缺点：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#例如一个变量刚刚从新生代移入青春代，该变量的绑定关系就解除了，该变量应该被回收，但青春代的扫描频率低于新生代，</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>"},{"_content":"## 一 引入\n\n 字符串类型、文本文件的内容都是由字符组成的，但凡涉及到字符的存取，都需要考虑字符编码的问题。\n\n 字符编码这个知识点的典型特征就是理论多、结论少，但对于开发而言只需要记住结论即可，下面让我们来一点点介绍它\n\n![img](https://pic1.zhimg.com/80/v2-621d28181cc40a235414a49fc9d14738_720w.jpg)\n\n## 二 知识储备\n\n## 2.1 三大核心硬件\n\n所有软件都是运行硬件之上的，与运行软件相关的三大核心硬件为cpu、内存、硬盘，我们需要明确三点\n\n```python\n#1、软件运行前，软件的代码及其相关数据都是存放于硬盘中的\n\n#2、任何软件的启动都是将数据从硬盘中读入内存，然后cpu从内存中取出指令并执行\n\n#3、软件运行过程中产生的数据最先都是存放于内存中的，若想永久保存软件产生的数据，则需要将数据由内存写入硬盘\n```\n\n![img](https://pic3.zhimg.com/80/v2-48e25e7f03030e066f8fcaf4750cc892_720w.jpg)\n\n## 2.2 文本编辑器读取文件内容的流程\n\n```python\n#阶段1、启动一个文件编辑器（文本编辑器如nodepad++，pycharm，word）\n\n#阶段2、文件编辑器会将文件内容从硬盘读入内存\n\n#阶段3、文本编辑器会将刚刚读入内存中的内容显示到屏幕上\n```\n\n## 2.3 python解释器执行文件的流程\n\n以python test.py为例，执行流程如下\n\n```python\n#阶段1、启动python解释器，此时就相当于启动了一个文本编辑器\n\n#阶段2、python解释器相当于文本编辑器，从硬盘上将test.py的内容读入到内存中\n\n#阶段3、python解释器解释执行刚刚读入的内存的内容，开始识别python语法\n```\n\n## 2.4 总结\n\npython解释器与文件本编辑的异同如下\n\n```python\n#1、相同点：前两个阶段二者完全一致，都是将硬盘中文件的内容读入内存，详解如下\npython解释器是解释执行文件内容的，因而python解释器具备读py文件的功能，这一点与文本编辑器一样\n\n#2、不同点：在阶段3时，针对内存中读入的内容处理方式不同，详解如下\n文本编辑器将文件内容读入内存后，是为了显示或者编辑，根本不去理会python的语法，而python解释器将文件内容读入内存后，可不是为了给你瞅一眼python代码写的啥，而是为了执行python代码、会识别python语法）\n```\n\n![img](https://pic4.zhimg.com/80/v2-c80921c5d7ede2fd94262892c7e0a733_720w.jpg)\n\n## 三、字符编码介绍\n\n## 3.1 什么是字符编码？\n\n人类在与计算机交互时，用的都是人类能读懂的字符，如中文字符、英文字符、日文字符等\n\n而计算机只能识别二进制数,详解如下\n\n```python\n#二进制数即由0和1组成的数字，例如010010101010。计算机是基于电工作的，电的特性即高低电平，人类从逻辑层面将高电平对应为数字1,低电平对应为数字0，这直接决定了计算机可以识别的是由0和1组成的数字\n```\n\n毫无疑问，由人类的字符到计算机中的数字，必须经历一个过程，如下\n\n![img](https://pic1.zhimg.com/80/v2-80b925e192579faa59dcffbb046535a4_720w.jpg)\n\n翻译的过程必须参照一个特定的标准，该标准称之为字符编码表，该表上存放的就是字符与数字一一对应的关系。\n\n字符编码中的编码指的是翻译或者转换的意思，即将人能理解的字符翻译成计算机能识别的数字\n\n## 3.2 字符编码表的发展史 (了解)\n\n字符编码的发展经历了三个重要的阶段，如下\n\n### 3.2.1 阶段一：一家独大\n\n现代计算机起源于美国，所以最先考虑仅仅是让计算机识别英文字符，于是诞生了ASCII表\n\n```python\n# ASCII表的特点:\n    1、只有英文字符与数字的一一对应关系\n    2、一个英文字符对应1Bytes，1Bytes=8bit，8bit最多包含256个数字，可以对应256个字符，足够表示所有英文字符\n```\n\n![img](https://pic2.zhimg.com/80/v2-c4a210efb1a57b869288eb7e89bf6fc9_720w.jpg)\n\n### 3.2.2 阶段二：诸侯割据、天下大乱\n\n![img](https://pic2.zhimg.com/80/v2-114700ee2814bcf3de172a4b673001e1_720w.jpg)\n\n为了让计算机能够识别中文和英文，中国人定制了GBK\n\n```python\n# GBK表的特点：\n    1、只有中文字符、英文字符与数字的一一对应关系\n    2、一个英文字符对应1Bytes\n       一个中文字符对应2Bytes   \n       补充说明：\n       1Bytes=8bit，8bit最多包含256个数字，可以对应256个字符，足够表示所有英文字符\n       2Bytes=16bit，16bit最多包含65536个数字，可以对应65536个字符，足够表示所有中文字符\n```\n\n每个国家都各自的字符，为让计算机能够识别自己国家的字符外加英文字符，各个国家都制定了自己的字符编码表\n\n```python\n# Shift_JIS表的特点：\n    1、只有日文字符、英文字符与数字的一一对应关系\n\n# Euc-kr表的特点：\n    1、只有韩文字符、英文字符与数字的一一对应关系\n```\n\n此时,美国人用的计算机里使用字符编码标准是ASCII、中国人用的计算机里使用字符编码标准是GBK、日本人用的计算机里使用字符编码标准是Shift_JIS,如下图所示，\n\n![img](https://pic3.zhimg.com/80/v2-19bac7b0910652bbd1f7e026683a28be_720w.jpg)\n\n字符编码发展到了这个阶段，可以用一句话概括：诸侯割据、天下大乱，详解如下\n\n![img](https://pic3.zhimg.com/80/v2-b6ac2031b2082daa422c8dc233be95ee_720w.jpg)\n\n图1中，文本编辑存取文件的原理如下\n\n```python\n文本文件内容全都为字符，无论存取都是涉及到字符编码问题\n#1、存文本文件\n人类通过文本编辑器输入的字符会被转化成ASCII格式的二进制存放于内存中，如果需要永久保存，则直接将内存中的ASCII格式的二进制写入硬盘\n\n#2、读文本文件\n直接将硬盘中的ASCII格式的二进制读入内存，然后通过ASCII表反解成英文字符\n```\n\n图2图3都是相同的过程，此时无论是存还是取由于采用的字符编码表一样，所以肯定不会出现乱码问题，但问题是在美国人用的计算机里只能输入英文字符，而在中国人用的计算机里只能输入中文字符和英文字符....,毫无疑问我们希望计算机允许我们输入万国字符均可识别、不乱码，而现阶段计算机采用的字符编码ASCII、GBK、Shift_JIS都无法识别万国字符，所以我们必须定制一个兼容万国字符的编码表，请看阶段三\n\n![img](https://pic3.zhimg.com/80/v2-aeb16d83abab152e00e7e2f99eaeb102_720w.jpg)\n\n### 3.2.3 阶段三：分久必合\n\n![img](https://pic1.zhimg.com/80/v2-f405404cd434f2280b4586c4f95ce760_720w.jpg)\n\nunicode于1990年开始研发，1994年正式公布，具备两大特点：\n\n```python\n#1. 存在所有语言中的所有字符与数字的一一对应关系,即兼容万国字符\n\n#2. 与传统的字符编码的二进制数都有对应关系，详解如下\n```\n\n很多地方或老的系统、应用软件仍会采用各种各样传统的编码，这是历史遗留问题。此处需要强调：软件是存放于硬盘的，而运行软件是要将软件加载到内存的，面对硬盘中存放的各种传统编码的软件，想让我们的计算机能够将它们全都正常运行而不出现乱码，内存中必须有一种兼容万国的编码，并且该编码需要与其他编码有相对应的映射/转换关系，这就是unicode的第二大特点产生的缘由\n\n![img](https://pic1.zhimg.com/80/v2-484a43054d2217ed11c7d5d9170675f8_720w.jpg)\n\n文本编辑器输入任何字符都是最新存在于内存中，是unicode编码的，存放于硬盘中，则可以转换成任意其他编码，只要该编码可以支持相应的字符\n\n```python\n# 英文字符可以被ASCII识别\n英文字符--->unciode格式的数字--->ASCII格式的数字\n\n# 中文字符、英文字符可以被GBK识别\n中文字符、英文字符--->unicode格式的数字--->gbk格式的数字\n\n# 日文字符、英文字符可以被shift-JIS识别\n日文字符、英文字符--->unicode格式的数字--->shift-JIS格式的数字\n```\n\n![img](https://pic4.zhimg.com/80/v2-77be4ea6e528d6ed700fd08b2096566f_720w.jpg)\n\n## 3.3 编码与解码\n\n由字符转换成内存中的unicode，以及由unicode转换成其他编码的过程，都称为编码encode\n\n![img](https://pic3.zhimg.com/80/v2-08a12814397a5a6d3e530a66cf2dbc02_720w.jpg)\n\n由内存中的unicode转换成字符，以及由其他编码转换成unicode的过程，都称为解码decode\n\n![img](https://pic4.zhimg.com/80/v2-5f7b25aaeb4ccc913f0c23d586acdbab_720w.jpg)\n\n在诸多文件类型中，只有文本文件的内存是由字符组成的，因而文本文件的存取也涉及到字符编码的问题\n\n## 3.4 utf-8的由来\n\n注意：如果保存到硬盘的是GBK格式二进制，当初用户输入的字符只能是中文或英文，同理如果保存到硬盘的是Shift_JIS格式二进制，当初用户输入的字符只能是日文或英文……如果我们输入的字符中包含多国字符，那么该如何处理？\n\n```python\n#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（GBK格式的二进制）\n\n#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（Shift_JIS格式的二进制）\n\n#多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（???格式的二进制）\n```\n\n理论上是可以将内存中unicode格式的二进制直接存放于硬盘中的，但由于unicode固定使用两个字节来存储一个字符，如果多国字符中包含大量的英文字符时，使用unicode格式存放会额外占用一倍空间（英文字符其实只需要用一个字节存放即可），然而空间占用并不是最致命的问题，最致命地是当我们由内存写入硬盘时会额外耗费一倍的时间，所以将内存中的unicode二进制写入硬盘或者基于网络传输时必须将其转换成一种精简的格式，这种格式即utf-8（全称Unicode Transformation Format，即unicode的转换格式）\n\n```python\n# 多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（utf-8格式的二进制）\n```\n\n![img](https://pic3.zhimg.com/80/v2-c2a4ec82d946e4e35645f9782dbc798a_720w.jpg)\n\n那为何在内存中不直接使用utf-8呢？\n\n```python\nutf-8是针对Unicode的可变长度字符编码：一个英文字符占1Bytes，一个中文字符占3Bytes，生僻字用更多的Bytes存储\n\nunicode更像是一个过渡版本，我们新开发的软件或文件存入硬盘都采用utf-8格式，等过去几十年，所有老编码的文件都淘汰掉之后，会出现一个令人开心的场景，即硬盘里放的都是utf-8格式，此时unicode便可以退出历史舞台，内存里也改用utf-8，天下重新归于统一\n```\n\n![img](https://pic4.zhimg.com/80/v2-183090ce203c9e1b6edab8aff77460cb_720w.jpg)\n\n## 四 字符编码的应用\n\n我们学习字符编码就是为了存取字符时不发生乱码问题：\n\n```python\n#1、内存中固定使用unicode无论输入任何字符都不会发生乱码\n\n#2、我们能够修改的是存/取硬盘的编码方式，如果编码设置不正确将会出现乱码问题。乱码问题分为两种：存乱了，读乱了\n\n#2.1 存乱了：如果用户输入的内容中包含中文和日文字符，如果单纯以shift_JIS存，日文可以正常写入硬盘，而由于中文字符在shift_jis中没有找到对应关系而导致存乱了\n\n#2.2 读乱了：如果硬盘中的数据是shift_JIS格式存储的，采GBK格式读入内存就读乱了\n```\n\n总结：\n\n```python\n#1. 保证存的时候不乱：在由内存写入硬盘时，必须将编码格式设置为支持所输入字符的编码格式\n#2. 保证存的时候不乱：在由硬盘读入内存时，必须采用与写入硬盘时相同的编码格式\n```\n\n## 4.1 文本编辑器nodpad++存取文本文件\n\n文本编辑器存取的都是文本文件，而文本文件中包含的内容全为字符，所以存取文本文件都涉及到字符编码的问题。\n\n![img](https://pic4.zhimg.com/80/v2-80d179cdb9262eced650c8574bc74d33_720w.jpg)\n\n![img](https://pic4.zhimg.com/80/v2-75e2cb4b6932bc76c6161a086ad1a5a3_720w.jpg)\n\n![img](https://pic1.zhimg.com/80/v2-3d3b0ae681354751c1a85d75b27ee1d0_720w.jpg)\n\n\n\n## 4.2 python解释器执行文件的前两个阶段\n\n执行py文件的前两个阶段就是python解释器读文本文件的过程，与文本编辑读文本文件的前两个阶段没人任何区别，要保证读不乱码，则必须将python解释器读文件时采用的编码方式设置为文件当初写入硬盘时的编码格式，如果没有设置，python解释器则才用默认的编码方式，在python3中默认为utf-8，在python2中默认为ASCII，我们可以通过指定文件头来修改默认的编码\n\n- 在文件首行写入包含#号在内的以下内容\n\n```python\n# coding: 当初文件写入硬盘时采用的编码格式\n```\n\n解释器会先用默认的编码方式读取文件的首行内容，由于首行是纯英文组成，而任何编码方式都可以识别英文字符。\n\n![img](https://pic4.zhimg.com/80/v2-b39022bd9969bcba565b7cfe6c067b13_720w.jpg)\n\n## 4.3 python解释器执行文件的第三个阶段\n\n设置文件头的作用是保证运行python程序的前两个阶段不乱码，经过前两个阶段后py文件的内容都会以unicode格式存放于内存中。\n\n在经历第三个阶段时开始识别python语法，当遇到特定的语法name = '上'（代码本身也都全都是unicode格式存的）时，需要申请内存空间来存储字符串'上'，这就又涉及到应该以什么编码存储‘上’的问题了。\n\n在Python3中，字符串类的值都是使用unicode格式来存储\n\n由于Python2的盛行是早于unicode的，因此在Python2中是按照文件头指定的编码来存储字符串类型的值的（如果文件头中没有指定编码，那么解释器会按照它自己默认的编码方式来存储‘上’），所以，这就有可能导致乱码问题\n\n![img](https://pic2.zhimg.com/80/v2-d27cfdaa0659c34c85fcff4a48a4e2f9_720w.jpg)\n\n```python\n# coding:utf-8\nx = '上' # x的值为untf-8格式的二进制\nprint(x) # 打印操作是将x的值，即utf-8格式的二进制交给终端，当终端收到后发现并不是unicode（只有unicode才与字符有对应关系），所以终端会执行操作：utf-8二进制---解码-->unicode格式的二进制，解码的过程终端会采用自己默认的编码，而在pycharm的终端默认编码为utf-8、windows下的cmd终端的默认编码为gbk，所以该打印操作在pycharm中显示正常，而在windows下的cmd中则乱码\n\n# 在windows下的cmd中运行效果如下\nC:\\Users\\Administrator>python2 E:\\aaa.py\n涓\n```\n\npython2后推出了一种补救措施，就是在字符串类型前加u，则会将字符串类型强制存储unicode，这就与python3保持一致了，对于unicode格式无论丢给任何终端进行打印，都可以直接对应字符不会出现乱码问题\n\n```python\n# coding:utf-8\nx = u'上' # 即便文件头为utf-8，x的值依然存成unicode\n```\n\n![img](https://pic3.zhimg.com/80/v2-1ef12a426d5d928e8ce10eafef489616_720w.jpg)\n\n## 4.4 字符串encode编码与decode解码的使用\n\n```python\n# 1、unicode格式------编码encode-------->其它编码格式\n>>> x='上' # 在python3在'上'被存成unicode\n>>> res=x.encode('utf-8')\n>>> res,type(res) # unicode编码成了utf-8格式，而编码的结果为bytes类型，可以当作直接当作二进制去使用\n(b'\\xe4\\xb8\\x8a', <class 'bytes'>)\n\n# 2、其它编码格式------解码decode-------->unicode格式\n>>> res.decode('utf-8') \n'上'\n```\n\n## 视频链接：\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=27![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D27)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=28![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D28)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=29![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D29)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=30![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D30)","source":"_posts/03_Python/01_Python基础/09_字符编码.md","raw":"## 一 引入\n\n 字符串类型、文本文件的内容都是由字符组成的，但凡涉及到字符的存取，都需要考虑字符编码的问题。\n\n 字符编码这个知识点的典型特征就是理论多、结论少，但对于开发而言只需要记住结论即可，下面让我们来一点点介绍它\n\n![img](https://pic1.zhimg.com/80/v2-621d28181cc40a235414a49fc9d14738_720w.jpg)\n\n## 二 知识储备\n\n## 2.1 三大核心硬件\n\n所有软件都是运行硬件之上的，与运行软件相关的三大核心硬件为cpu、内存、硬盘，我们需要明确三点\n\n```python\n#1、软件运行前，软件的代码及其相关数据都是存放于硬盘中的\n\n#2、任何软件的启动都是将数据从硬盘中读入内存，然后cpu从内存中取出指令并执行\n\n#3、软件运行过程中产生的数据最先都是存放于内存中的，若想永久保存软件产生的数据，则需要将数据由内存写入硬盘\n```\n\n![img](https://pic3.zhimg.com/80/v2-48e25e7f03030e066f8fcaf4750cc892_720w.jpg)\n\n## 2.2 文本编辑器读取文件内容的流程\n\n```python\n#阶段1、启动一个文件编辑器（文本编辑器如nodepad++，pycharm，word）\n\n#阶段2、文件编辑器会将文件内容从硬盘读入内存\n\n#阶段3、文本编辑器会将刚刚读入内存中的内容显示到屏幕上\n```\n\n## 2.3 python解释器执行文件的流程\n\n以python test.py为例，执行流程如下\n\n```python\n#阶段1、启动python解释器，此时就相当于启动了一个文本编辑器\n\n#阶段2、python解释器相当于文本编辑器，从硬盘上将test.py的内容读入到内存中\n\n#阶段3、python解释器解释执行刚刚读入的内存的内容，开始识别python语法\n```\n\n## 2.4 总结\n\npython解释器与文件本编辑的异同如下\n\n```python\n#1、相同点：前两个阶段二者完全一致，都是将硬盘中文件的内容读入内存，详解如下\npython解释器是解释执行文件内容的，因而python解释器具备读py文件的功能，这一点与文本编辑器一样\n\n#2、不同点：在阶段3时，针对内存中读入的内容处理方式不同，详解如下\n文本编辑器将文件内容读入内存后，是为了显示或者编辑，根本不去理会python的语法，而python解释器将文件内容读入内存后，可不是为了给你瞅一眼python代码写的啥，而是为了执行python代码、会识别python语法）\n```\n\n![img](https://pic4.zhimg.com/80/v2-c80921c5d7ede2fd94262892c7e0a733_720w.jpg)\n\n## 三、字符编码介绍\n\n## 3.1 什么是字符编码？\n\n人类在与计算机交互时，用的都是人类能读懂的字符，如中文字符、英文字符、日文字符等\n\n而计算机只能识别二进制数,详解如下\n\n```python\n#二进制数即由0和1组成的数字，例如010010101010。计算机是基于电工作的，电的特性即高低电平，人类从逻辑层面将高电平对应为数字1,低电平对应为数字0，这直接决定了计算机可以识别的是由0和1组成的数字\n```\n\n毫无疑问，由人类的字符到计算机中的数字，必须经历一个过程，如下\n\n![img](https://pic1.zhimg.com/80/v2-80b925e192579faa59dcffbb046535a4_720w.jpg)\n\n翻译的过程必须参照一个特定的标准，该标准称之为字符编码表，该表上存放的就是字符与数字一一对应的关系。\n\n字符编码中的编码指的是翻译或者转换的意思，即将人能理解的字符翻译成计算机能识别的数字\n\n## 3.2 字符编码表的发展史 (了解)\n\n字符编码的发展经历了三个重要的阶段，如下\n\n### 3.2.1 阶段一：一家独大\n\n现代计算机起源于美国，所以最先考虑仅仅是让计算机识别英文字符，于是诞生了ASCII表\n\n```python\n# ASCII表的特点:\n    1、只有英文字符与数字的一一对应关系\n    2、一个英文字符对应1Bytes，1Bytes=8bit，8bit最多包含256个数字，可以对应256个字符，足够表示所有英文字符\n```\n\n![img](https://pic2.zhimg.com/80/v2-c4a210efb1a57b869288eb7e89bf6fc9_720w.jpg)\n\n### 3.2.2 阶段二：诸侯割据、天下大乱\n\n![img](https://pic2.zhimg.com/80/v2-114700ee2814bcf3de172a4b673001e1_720w.jpg)\n\n为了让计算机能够识别中文和英文，中国人定制了GBK\n\n```python\n# GBK表的特点：\n    1、只有中文字符、英文字符与数字的一一对应关系\n    2、一个英文字符对应1Bytes\n       一个中文字符对应2Bytes   \n       补充说明：\n       1Bytes=8bit，8bit最多包含256个数字，可以对应256个字符，足够表示所有英文字符\n       2Bytes=16bit，16bit最多包含65536个数字，可以对应65536个字符，足够表示所有中文字符\n```\n\n每个国家都各自的字符，为让计算机能够识别自己国家的字符外加英文字符，各个国家都制定了自己的字符编码表\n\n```python\n# Shift_JIS表的特点：\n    1、只有日文字符、英文字符与数字的一一对应关系\n\n# Euc-kr表的特点：\n    1、只有韩文字符、英文字符与数字的一一对应关系\n```\n\n此时,美国人用的计算机里使用字符编码标准是ASCII、中国人用的计算机里使用字符编码标准是GBK、日本人用的计算机里使用字符编码标准是Shift_JIS,如下图所示，\n\n![img](https://pic3.zhimg.com/80/v2-19bac7b0910652bbd1f7e026683a28be_720w.jpg)\n\n字符编码发展到了这个阶段，可以用一句话概括：诸侯割据、天下大乱，详解如下\n\n![img](https://pic3.zhimg.com/80/v2-b6ac2031b2082daa422c8dc233be95ee_720w.jpg)\n\n图1中，文本编辑存取文件的原理如下\n\n```python\n文本文件内容全都为字符，无论存取都是涉及到字符编码问题\n#1、存文本文件\n人类通过文本编辑器输入的字符会被转化成ASCII格式的二进制存放于内存中，如果需要永久保存，则直接将内存中的ASCII格式的二进制写入硬盘\n\n#2、读文本文件\n直接将硬盘中的ASCII格式的二进制读入内存，然后通过ASCII表反解成英文字符\n```\n\n图2图3都是相同的过程，此时无论是存还是取由于采用的字符编码表一样，所以肯定不会出现乱码问题，但问题是在美国人用的计算机里只能输入英文字符，而在中国人用的计算机里只能输入中文字符和英文字符....,毫无疑问我们希望计算机允许我们输入万国字符均可识别、不乱码，而现阶段计算机采用的字符编码ASCII、GBK、Shift_JIS都无法识别万国字符，所以我们必须定制一个兼容万国字符的编码表，请看阶段三\n\n![img](https://pic3.zhimg.com/80/v2-aeb16d83abab152e00e7e2f99eaeb102_720w.jpg)\n\n### 3.2.3 阶段三：分久必合\n\n![img](https://pic1.zhimg.com/80/v2-f405404cd434f2280b4586c4f95ce760_720w.jpg)\n\nunicode于1990年开始研发，1994年正式公布，具备两大特点：\n\n```python\n#1. 存在所有语言中的所有字符与数字的一一对应关系,即兼容万国字符\n\n#2. 与传统的字符编码的二进制数都有对应关系，详解如下\n```\n\n很多地方或老的系统、应用软件仍会采用各种各样传统的编码，这是历史遗留问题。此处需要强调：软件是存放于硬盘的，而运行软件是要将软件加载到内存的，面对硬盘中存放的各种传统编码的软件，想让我们的计算机能够将它们全都正常运行而不出现乱码，内存中必须有一种兼容万国的编码，并且该编码需要与其他编码有相对应的映射/转换关系，这就是unicode的第二大特点产生的缘由\n\n![img](https://pic1.zhimg.com/80/v2-484a43054d2217ed11c7d5d9170675f8_720w.jpg)\n\n文本编辑器输入任何字符都是最新存在于内存中，是unicode编码的，存放于硬盘中，则可以转换成任意其他编码，只要该编码可以支持相应的字符\n\n```python\n# 英文字符可以被ASCII识别\n英文字符--->unciode格式的数字--->ASCII格式的数字\n\n# 中文字符、英文字符可以被GBK识别\n中文字符、英文字符--->unicode格式的数字--->gbk格式的数字\n\n# 日文字符、英文字符可以被shift-JIS识别\n日文字符、英文字符--->unicode格式的数字--->shift-JIS格式的数字\n```\n\n![img](https://pic4.zhimg.com/80/v2-77be4ea6e528d6ed700fd08b2096566f_720w.jpg)\n\n## 3.3 编码与解码\n\n由字符转换成内存中的unicode，以及由unicode转换成其他编码的过程，都称为编码encode\n\n![img](https://pic3.zhimg.com/80/v2-08a12814397a5a6d3e530a66cf2dbc02_720w.jpg)\n\n由内存中的unicode转换成字符，以及由其他编码转换成unicode的过程，都称为解码decode\n\n![img](https://pic4.zhimg.com/80/v2-5f7b25aaeb4ccc913f0c23d586acdbab_720w.jpg)\n\n在诸多文件类型中，只有文本文件的内存是由字符组成的，因而文本文件的存取也涉及到字符编码的问题\n\n## 3.4 utf-8的由来\n\n注意：如果保存到硬盘的是GBK格式二进制，当初用户输入的字符只能是中文或英文，同理如果保存到硬盘的是Shift_JIS格式二进制，当初用户输入的字符只能是日文或英文……如果我们输入的字符中包含多国字符，那么该如何处理？\n\n```python\n#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（GBK格式的二进制）\n\n#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（Shift_JIS格式的二进制）\n\n#多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（???格式的二进制）\n```\n\n理论上是可以将内存中unicode格式的二进制直接存放于硬盘中的，但由于unicode固定使用两个字节来存储一个字符，如果多国字符中包含大量的英文字符时，使用unicode格式存放会额外占用一倍空间（英文字符其实只需要用一个字节存放即可），然而空间占用并不是最致命的问题，最致命地是当我们由内存写入硬盘时会额外耗费一倍的时间，所以将内存中的unicode二进制写入硬盘或者基于网络传输时必须将其转换成一种精简的格式，这种格式即utf-8（全称Unicode Transformation Format，即unicode的转换格式）\n\n```python\n# 多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（utf-8格式的二进制）\n```\n\n![img](https://pic3.zhimg.com/80/v2-c2a4ec82d946e4e35645f9782dbc798a_720w.jpg)\n\n那为何在内存中不直接使用utf-8呢？\n\n```python\nutf-8是针对Unicode的可变长度字符编码：一个英文字符占1Bytes，一个中文字符占3Bytes，生僻字用更多的Bytes存储\n\nunicode更像是一个过渡版本，我们新开发的软件或文件存入硬盘都采用utf-8格式，等过去几十年，所有老编码的文件都淘汰掉之后，会出现一个令人开心的场景，即硬盘里放的都是utf-8格式，此时unicode便可以退出历史舞台，内存里也改用utf-8，天下重新归于统一\n```\n\n![img](https://pic4.zhimg.com/80/v2-183090ce203c9e1b6edab8aff77460cb_720w.jpg)\n\n## 四 字符编码的应用\n\n我们学习字符编码就是为了存取字符时不发生乱码问题：\n\n```python\n#1、内存中固定使用unicode无论输入任何字符都不会发生乱码\n\n#2、我们能够修改的是存/取硬盘的编码方式，如果编码设置不正确将会出现乱码问题。乱码问题分为两种：存乱了，读乱了\n\n#2.1 存乱了：如果用户输入的内容中包含中文和日文字符，如果单纯以shift_JIS存，日文可以正常写入硬盘，而由于中文字符在shift_jis中没有找到对应关系而导致存乱了\n\n#2.2 读乱了：如果硬盘中的数据是shift_JIS格式存储的，采GBK格式读入内存就读乱了\n```\n\n总结：\n\n```python\n#1. 保证存的时候不乱：在由内存写入硬盘时，必须将编码格式设置为支持所输入字符的编码格式\n#2. 保证存的时候不乱：在由硬盘读入内存时，必须采用与写入硬盘时相同的编码格式\n```\n\n## 4.1 文本编辑器nodpad++存取文本文件\n\n文本编辑器存取的都是文本文件，而文本文件中包含的内容全为字符，所以存取文本文件都涉及到字符编码的问题。\n\n![img](https://pic4.zhimg.com/80/v2-80d179cdb9262eced650c8574bc74d33_720w.jpg)\n\n![img](https://pic4.zhimg.com/80/v2-75e2cb4b6932bc76c6161a086ad1a5a3_720w.jpg)\n\n![img](https://pic1.zhimg.com/80/v2-3d3b0ae681354751c1a85d75b27ee1d0_720w.jpg)\n\n\n\n## 4.2 python解释器执行文件的前两个阶段\n\n执行py文件的前两个阶段就是python解释器读文本文件的过程，与文本编辑读文本文件的前两个阶段没人任何区别，要保证读不乱码，则必须将python解释器读文件时采用的编码方式设置为文件当初写入硬盘时的编码格式，如果没有设置，python解释器则才用默认的编码方式，在python3中默认为utf-8，在python2中默认为ASCII，我们可以通过指定文件头来修改默认的编码\n\n- 在文件首行写入包含#号在内的以下内容\n\n```python\n# coding: 当初文件写入硬盘时采用的编码格式\n```\n\n解释器会先用默认的编码方式读取文件的首行内容，由于首行是纯英文组成，而任何编码方式都可以识别英文字符。\n\n![img](https://pic4.zhimg.com/80/v2-b39022bd9969bcba565b7cfe6c067b13_720w.jpg)\n\n## 4.3 python解释器执行文件的第三个阶段\n\n设置文件头的作用是保证运行python程序的前两个阶段不乱码，经过前两个阶段后py文件的内容都会以unicode格式存放于内存中。\n\n在经历第三个阶段时开始识别python语法，当遇到特定的语法name = '上'（代码本身也都全都是unicode格式存的）时，需要申请内存空间来存储字符串'上'，这就又涉及到应该以什么编码存储‘上’的问题了。\n\n在Python3中，字符串类的值都是使用unicode格式来存储\n\n由于Python2的盛行是早于unicode的，因此在Python2中是按照文件头指定的编码来存储字符串类型的值的（如果文件头中没有指定编码，那么解释器会按照它自己默认的编码方式来存储‘上’），所以，这就有可能导致乱码问题\n\n![img](https://pic2.zhimg.com/80/v2-d27cfdaa0659c34c85fcff4a48a4e2f9_720w.jpg)\n\n```python\n# coding:utf-8\nx = '上' # x的值为untf-8格式的二进制\nprint(x) # 打印操作是将x的值，即utf-8格式的二进制交给终端，当终端收到后发现并不是unicode（只有unicode才与字符有对应关系），所以终端会执行操作：utf-8二进制---解码-->unicode格式的二进制，解码的过程终端会采用自己默认的编码，而在pycharm的终端默认编码为utf-8、windows下的cmd终端的默认编码为gbk，所以该打印操作在pycharm中显示正常，而在windows下的cmd中则乱码\n\n# 在windows下的cmd中运行效果如下\nC:\\Users\\Administrator>python2 E:\\aaa.py\n涓\n```\n\npython2后推出了一种补救措施，就是在字符串类型前加u，则会将字符串类型强制存储unicode，这就与python3保持一致了，对于unicode格式无论丢给任何终端进行打印，都可以直接对应字符不会出现乱码问题\n\n```python\n# coding:utf-8\nx = u'上' # 即便文件头为utf-8，x的值依然存成unicode\n```\n\n![img](https://pic3.zhimg.com/80/v2-1ef12a426d5d928e8ce10eafef489616_720w.jpg)\n\n## 4.4 字符串encode编码与decode解码的使用\n\n```python\n# 1、unicode格式------编码encode-------->其它编码格式\n>>> x='上' # 在python3在'上'被存成unicode\n>>> res=x.encode('utf-8')\n>>> res,type(res) # unicode编码成了utf-8格式，而编码的结果为bytes类型，可以当作直接当作二进制去使用\n(b'\\xe4\\xb8\\x8a', <class 'bytes'>)\n\n# 2、其它编码格式------解码decode-------->unicode格式\n>>> res.decode('utf-8') \n'上'\n```\n\n## 视频链接：\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=27![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D27)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=28![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D28)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=29![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D29)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=30![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D30)","slug":"03_Python/01_Python基础/09_字符编码","published":1,"date":"2022-07-18T07:10:19.373Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k140022a8v7cafbhxp1","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 字符串类型、文本文件的内容都是由字符组成的，但凡涉及到字符的存取，都需要考虑字符编码的问题。</p>\n<p> 字符编码这个知识点的典型特征就是理论多、结论少，但对于开发而言只需要记住结论即可，下面让我们来一点点介绍它</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-621d28181cc40a235414a49fc9d14738_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-知识储备\"><a href=\"#二-知识储备\" class=\"headerlink\" title=\"二 知识储备\"></a>二 知识储备</h2><h2 id=\"2-1-三大核心硬件\"><a href=\"#2-1-三大核心硬件\" class=\"headerlink\" title=\"2.1 三大核心硬件\"></a>2.1 三大核心硬件</h2><p>所有软件都是运行硬件之上的，与运行软件相关的三大核心硬件为cpu、内存、硬盘，我们需要明确三点</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、软件运行前，软件的代码及其相关数据都是存放于硬盘中的</span>\n\n<span class=\"token comment\">#2、任何软件的启动都是将数据从硬盘中读入内存，然后cpu从内存中取出指令并执行</span>\n\n<span class=\"token comment\">#3、软件运行过程中产生的数据最先都是存放于内存中的，若想永久保存软件产生的数据，则需要将数据由内存写入硬盘</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-48e25e7f03030e066f8fcaf4750cc892_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-文本编辑器读取文件内容的流程\"><a href=\"#2-2-文本编辑器读取文件内容的流程\" class=\"headerlink\" title=\"2.2 文本编辑器读取文件内容的流程\"></a>2.2 文本编辑器读取文件内容的流程</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#阶段1、启动一个文件编辑器（文本编辑器如nodepad++，pycharm，word）</span>\n\n<span class=\"token comment\">#阶段2、文件编辑器会将文件内容从硬盘读入内存</span>\n\n<span class=\"token comment\">#阶段3、文本编辑器会将刚刚读入内存中的内容显示到屏幕上</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-3-python解释器执行文件的流程\"><a href=\"#2-3-python解释器执行文件的流程\" class=\"headerlink\" title=\"2.3 python解释器执行文件的流程\"></a>2.3 python解释器执行文件的流程</h2><p>以python test.py为例，执行流程如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#阶段1、启动python解释器，此时就相当于启动了一个文本编辑器</span>\n\n<span class=\"token comment\">#阶段2、python解释器相当于文本编辑器，从硬盘上将test.py的内容读入到内存中</span>\n\n<span class=\"token comment\">#阶段3、python解释器解释执行刚刚读入的内存的内容，开始识别python语法</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-4-总结\"><a href=\"#2-4-总结\" class=\"headerlink\" title=\"2.4 总结\"></a>2.4 总结</h2><p>python解释器与文件本编辑的异同如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、相同点：前两个阶段二者完全一致，都是将硬盘中文件的内容读入内存，详解如下</span>\npython解释器是解释执行文件内容的，因而python解释器具备读py文件的功能，这一点与文本编辑器一样\n\n<span class=\"token comment\">#2、不同点：在阶段3时，针对内存中读入的内容处理方式不同，详解如下</span>\n文本编辑器将文件内容读入内存后，是为了显示或者编辑，根本不去理会python的语法，而python解释器将文件内容读入内存后，可不是为了给你瞅一眼python代码写的啥，而是为了执行python代码、会识别python语法）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-c80921c5d7ede2fd94262892c7e0a733_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三、字符编码介绍\"><a href=\"#三、字符编码介绍\" class=\"headerlink\" title=\"三、字符编码介绍\"></a>三、字符编码介绍</h2><h2 id=\"3-1-什么是字符编码？\"><a href=\"#3-1-什么是字符编码？\" class=\"headerlink\" title=\"3.1 什么是字符编码？\"></a>3.1 什么是字符编码？</h2><p>人类在与计算机交互时，用的都是人类能读懂的字符，如中文字符、英文字符、日文字符等</p>\n<p>而计算机只能识别二进制数,详解如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#二进制数即由0和1组成的数字，例如010010101010。计算机是基于电工作的，电的特性即高低电平，人类从逻辑层面将高电平对应为数字1,低电平对应为数字0，这直接决定了计算机可以识别的是由0和1组成的数字</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>毫无疑问，由人类的字符到计算机中的数字，必须经历一个过程，如下</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-80b925e192579faa59dcffbb046535a4_720w.jpg\" alt=\"img\"></p>\n<p>翻译的过程必须参照一个特定的标准，该标准称之为字符编码表，该表上存放的就是字符与数字一一对应的关系。</p>\n<p>字符编码中的编码指的是翻译或者转换的意思，即将人能理解的字符翻译成计算机能识别的数字</p>\n<h2 id=\"3-2-字符编码表的发展史-了解\"><a href=\"#3-2-字符编码表的发展史-了解\" class=\"headerlink\" title=\"3.2 字符编码表的发展史 (了解)\"></a>3.2 字符编码表的发展史 (了解)</h2><p>字符编码的发展经历了三个重要的阶段，如下</p>\n<h3 id=\"3-2-1-阶段一：一家独大\"><a href=\"#3-2-1-阶段一：一家独大\" class=\"headerlink\" title=\"3.2.1 阶段一：一家独大\"></a>3.2.1 阶段一：一家独大</h3><p>现代计算机起源于美国，所以最先考虑仅仅是让计算机识别英文字符，于是诞生了ASCII表</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># ASCII表的特点:</span>\n    <span class=\"token number\">1</span>、只有英文字符与数字的一一对应关系\n    <span class=\"token number\">2</span>、一个英文字符对应1Bytes，1Bytes<span class=\"token operator\">=</span>8bit，8bit最多包含<span class=\"token number\">256</span>个数字，可以对应<span class=\"token number\">256</span>个字符，足够表示所有英文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-c4a210efb1a57b869288eb7e89bf6fc9_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"3-2-2-阶段二：诸侯割据、天下大乱\"><a href=\"#3-2-2-阶段二：诸侯割据、天下大乱\" class=\"headerlink\" title=\"3.2.2 阶段二：诸侯割据、天下大乱\"></a>3.2.2 阶段二：诸侯割据、天下大乱</h3><p><img src=\"https://pic2.zhimg.com/80/v2-114700ee2814bcf3de172a4b673001e1_720w.jpg\" alt=\"img\"></p>\n<p>为了让计算机能够识别中文和英文，中国人定制了GBK</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># GBK表的特点：</span>\n    <span class=\"token number\">1</span>、只有中文字符、英文字符与数字的一一对应关系\n    <span class=\"token number\">2</span>、一个英文字符对应1Bytes\n       一个中文字符对应2Bytes   \n       补充说明：\n       1Bytes<span class=\"token operator\">=</span>8bit，8bit最多包含<span class=\"token number\">256</span>个数字，可以对应<span class=\"token number\">256</span>个字符，足够表示所有英文字符\n       2Bytes<span class=\"token operator\">=</span>16bit，16bit最多包含<span class=\"token number\">65536</span>个数字，可以对应<span class=\"token number\">65536</span>个字符，足够表示所有中文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>每个国家都各自的字符，为让计算机能够识别自己国家的字符外加英文字符，各个国家都制定了自己的字符编码表</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># Shift_JIS表的特点：</span>\n    <span class=\"token number\">1</span>、只有日文字符、英文字符与数字的一一对应关系\n\n<span class=\"token comment\"># Euc-kr表的特点：</span>\n    <span class=\"token number\">1</span>、只有韩文字符、英文字符与数字的一一对应关系<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>此时,美国人用的计算机里使用字符编码标准是ASCII、中国人用的计算机里使用字符编码标准是GBK、日本人用的计算机里使用字符编码标准是Shift_JIS,如下图所示，</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-19bac7b0910652bbd1f7e026683a28be_720w.jpg\" alt=\"img\"></p>\n<p>字符编码发展到了这个阶段，可以用一句话概括：诸侯割据、天下大乱，详解如下</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-b6ac2031b2082daa422c8dc233be95ee_720w.jpg\" alt=\"img\"></p>\n<p>图1中，文本编辑存取文件的原理如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">文本文件内容全都为字符，无论存取都是涉及到字符编码问题\n<span class=\"token comment\">#1、存文本文件</span>\n人类通过文本编辑器输入的字符会被转化成ASCII格式的二进制存放于内存中，如果需要永久保存，则直接将内存中的ASCII格式的二进制写入硬盘\n\n<span class=\"token comment\">#2、读文本文件</span>\n直接将硬盘中的ASCII格式的二进制读入内存，然后通过ASCII表反解成英文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>图2图3都是相同的过程，此时无论是存还是取由于采用的字符编码表一样，所以肯定不会出现乱码问题，但问题是在美国人用的计算机里只能输入英文字符，而在中国人用的计算机里只能输入中文字符和英文字符….,毫无疑问我们希望计算机允许我们输入万国字符均可识别、不乱码，而现阶段计算机采用的字符编码ASCII、GBK、Shift_JIS都无法识别万国字符，所以我们必须定制一个兼容万国字符的编码表，请看阶段三</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-aeb16d83abab152e00e7e2f99eaeb102_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"3-2-3-阶段三：分久必合\"><a href=\"#3-2-3-阶段三：分久必合\" class=\"headerlink\" title=\"3.2.3 阶段三：分久必合\"></a>3.2.3 阶段三：分久必合</h3><p><img src=\"https://pic1.zhimg.com/80/v2-f405404cd434f2280b4586c4f95ce760_720w.jpg\" alt=\"img\"></p>\n<p>unicode于1990年开始研发，1994年正式公布，具备两大特点：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1. 存在所有语言中的所有字符与数字的一一对应关系,即兼容万国字符</span>\n\n<span class=\"token comment\">#2. 与传统的字符编码的二进制数都有对应关系，详解如下</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>很多地方或老的系统、应用软件仍会采用各种各样传统的编码，这是历史遗留问题。此处需要强调：软件是存放于硬盘的，而运行软件是要将软件加载到内存的，面对硬盘中存放的各种传统编码的软件，想让我们的计算机能够将它们全都正常运行而不出现乱码，内存中必须有一种兼容万国的编码，并且该编码需要与其他编码有相对应的映射&#x2F;转换关系，这就是unicode的第二大特点产生的缘由</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-484a43054d2217ed11c7d5d9170675f8_720w.jpg\" alt=\"img\"></p>\n<p>文本编辑器输入任何字符都是最新存在于内存中，是unicode编码的，存放于硬盘中，则可以转换成任意其他编码，只要该编码可以支持相应的字符</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 英文字符可以被ASCII识别</span>\n英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>unciode格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>ASCII格式的数字\n\n<span class=\"token comment\"># 中文字符、英文字符可以被GBK识别</span>\n中文字符、英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token builtin\">unicode</span>格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>gbk格式的数字\n\n<span class=\"token comment\"># 日文字符、英文字符可以被shift-JIS识别</span>\n日文字符、英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token builtin\">unicode</span>格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>shift<span class=\"token operator\">-</span>JIS格式的数字<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-77be4ea6e528d6ed700fd08b2096566f_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-3-编码与解码\"><a href=\"#3-3-编码与解码\" class=\"headerlink\" title=\"3.3 编码与解码\"></a>3.3 编码与解码</h2><p>由字符转换成内存中的unicode，以及由unicode转换成其他编码的过程，都称为编码encode</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-08a12814397a5a6d3e530a66cf2dbc02_720w.jpg\" alt=\"img\"></p>\n<p>由内存中的unicode转换成字符，以及由其他编码转换成unicode的过程，都称为解码decode</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-5f7b25aaeb4ccc913f0c23d586acdbab_720w.jpg\" alt=\"img\"></p>\n<p>在诸多文件类型中，只有文本文件的内存是由字符组成的，因而文本文件的存取也涉及到字符编码的问题</p>\n<h2 id=\"3-4-utf-8的由来\"><a href=\"#3-4-utf-8的由来\" class=\"headerlink\" title=\"3.4 utf-8的由来\"></a>3.4 utf-8的由来</h2><p>注意：如果保存到硬盘的是GBK格式二进制，当初用户输入的字符只能是中文或英文，同理如果保存到硬盘的是Shift_JIS格式二进制，当初用户输入的字符只能是日文或英文……如果我们输入的字符中包含多国字符，那么该如何处理？</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（GBK格式的二进制）</span>\n\n<span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（Shift_JIS格式的二进制）</span>\n\n<span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（???格式的二进制）</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>理论上是可以将内存中unicode格式的二进制直接存放于硬盘中的，但由于unicode固定使用两个字节来存储一个字符，如果多国字符中包含大量的英文字符时，使用unicode格式存放会额外占用一倍空间（英文字符其实只需要用一个字节存放即可），然而空间占用并不是最致命的问题，最致命地是当我们由内存写入硬盘时会额外耗费一倍的时间，所以将内存中的unicode二进制写入硬盘或者基于网络传输时必须将其转换成一种精简的格式，这种格式即utf-8（全称Unicode Transformation Format，即unicode的转换格式）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（utf-8格式的二进制）</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-c2a4ec82d946e4e35645f9782dbc798a_720w.jpg\" alt=\"img\"></p>\n<p>那为何在内存中不直接使用utf-8呢？</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>是针对Unicode的可变长度字符编码：一个英文字符占1Bytes，一个中文字符占3Bytes，生僻字用更多的Bytes存储\n\n<span class=\"token builtin\">unicode</span>更像是一个过渡版本，我们新开发的软件或文件存入硬盘都采用utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>格式，等过去几十年，所有老编码的文件都淘汰掉之后，会出现一个令人开心的场景，即硬盘里放的都是utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>格式，此时<span class=\"token builtin\">unicode</span>便可以退出历史舞台，内存里也改用utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>，天下重新归于统一<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-183090ce203c9e1b6edab8aff77460cb_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-字符编码的应用\"><a href=\"#四-字符编码的应用\" class=\"headerlink\" title=\"四 字符编码的应用\"></a>四 字符编码的应用</h2><p>我们学习字符编码就是为了存取字符时不发生乱码问题：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、内存中固定使用unicode无论输入任何字符都不会发生乱码</span>\n\n<span class=\"token comment\">#2、我们能够修改的是存/取硬盘的编码方式，如果编码设置不正确将会出现乱码问题。乱码问题分为两种：存乱了，读乱了</span>\n\n<span class=\"token comment\">#2.1 存乱了：如果用户输入的内容中包含中文和日文字符，如果单纯以shift_JIS存，日文可以正常写入硬盘，而由于中文字符在shift_jis中没有找到对应关系而导致存乱了</span>\n\n<span class=\"token comment\">#2.2 读乱了：如果硬盘中的数据是shift_JIS格式存储的，采GBK格式读入内存就读乱了</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>总结：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1. 保证存的时候不乱：在由内存写入硬盘时，必须将编码格式设置为支持所输入字符的编码格式</span>\n<span class=\"token comment\">#2. 保证存的时候不乱：在由硬盘读入内存时，必须采用与写入硬盘时相同的编码格式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"4-1-文本编辑器nodpad-存取文本文件\"><a href=\"#4-1-文本编辑器nodpad-存取文本文件\" class=\"headerlink\" title=\"4.1 文本编辑器nodpad++存取文本文件\"></a>4.1 文本编辑器nodpad++存取文本文件</h2><p>文本编辑器存取的都是文本文件，而文本文件中包含的内容全为字符，所以存取文本文件都涉及到字符编码的问题。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-80d179cdb9262eced650c8574bc74d33_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-75e2cb4b6932bc76c6161a086ad1a5a3_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-3d3b0ae681354751c1a85d75b27ee1d0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-2-python解释器执行文件的前两个阶段\"><a href=\"#4-2-python解释器执行文件的前两个阶段\" class=\"headerlink\" title=\"4.2 python解释器执行文件的前两个阶段\"></a>4.2 python解释器执行文件的前两个阶段</h2><p>执行py文件的前两个阶段就是python解释器读文本文件的过程，与文本编辑读文本文件的前两个阶段没人任何区别，要保证读不乱码，则必须将python解释器读文件时采用的编码方式设置为文件当初写入硬盘时的编码格式，如果没有设置，python解释器则才用默认的编码方式，在python3中默认为utf-8，在python2中默认为ASCII，我们可以通过指定文件头来修改默认的编码</p>\n<ul>\n<li>在文件首行写入包含#号在内的以下内容</li>\n</ul>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding: 当初文件写入硬盘时采用的编码格式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>解释器会先用默认的编码方式读取文件的首行内容，由于首行是纯英文组成，而任何编码方式都可以识别英文字符。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-b39022bd9969bcba565b7cfe6c067b13_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-3-python解释器执行文件的第三个阶段\"><a href=\"#4-3-python解释器执行文件的第三个阶段\" class=\"headerlink\" title=\"4.3 python解释器执行文件的第三个阶段\"></a>4.3 python解释器执行文件的第三个阶段</h2><p>设置文件头的作用是保证运行python程序的前两个阶段不乱码，经过前两个阶段后py文件的内容都会以unicode格式存放于内存中。</p>\n<p>在经历第三个阶段时开始识别python语法，当遇到特定的语法name &#x3D; ‘上’（代码本身也都全都是unicode格式存的）时，需要申请内存空间来存储字符串’上’，这就又涉及到应该以什么编码存储‘上’的问题了。</p>\n<p>在Python3中，字符串类的值都是使用unicode格式来存储</p>\n<p>由于Python2的盛行是早于unicode的，因此在Python2中是按照文件头指定的编码来存储字符串类型的值的（如果文件头中没有指定编码，那么解释器会按照它自己默认的编码方式来存储‘上’），所以，这就有可能导致乱码问题</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-d27cfdaa0659c34c85fcff4a48a4e2f9_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding:utf-8</span>\nx <span class=\"token operator\">=</span> <span class=\"token string\">'上'</span> <span class=\"token comment\"># x的值为untf-8格式的二进制</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 打印操作是将x的值，即utf-8格式的二进制交给终端，当终端收到后发现并不是unicode（只有unicode才与字符有对应关系），所以终端会执行操作：utf-8二进制---解码-->unicode格式的二进制，解码的过程终端会采用自己默认的编码，而在pycharm的终端默认编码为utf-8、windows下的cmd终端的默认编码为gbk，所以该打印操作在pycharm中显示正常，而在windows下的cmd中则乱码</span>\n\n<span class=\"token comment\"># 在windows下的cmd中运行效果如下</span>\nC<span class=\"token punctuation\">:</span>\\Users\\Administrator<span class=\"token operator\">></span>python2 E<span class=\"token punctuation\">:</span>\\aaa<span class=\"token punctuation\">.</span>py\n涓<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>python2后推出了一种补救措施，就是在字符串类型前加u，则会将字符串类型强制存储unicode，这就与python3保持一致了，对于unicode格式无论丢给任何终端进行打印，都可以直接对应字符不会出现乱码问题</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding:utf-8</span>\nx <span class=\"token operator\">=</span> <span class=\"token string\">u'上'</span> <span class=\"token comment\"># 即便文件头为utf-8，x的值依然存成unicode</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-1ef12a426d5d928e8ce10eafef489616_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-4-字符串encode编码与decode解码的使用\"><a href=\"#4-4-字符串encode编码与decode解码的使用\" class=\"headerlink\" title=\"4.4 字符串encode编码与decode解码的使用\"></a>4.4 字符串encode编码与decode解码的使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、unicode格式------编码encode-------->其它编码格式</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token string\">'上'</span> <span class=\"token comment\"># 在python3在'上'被存成unicode</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token operator\">=</span>x<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token punctuation\">,</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token comment\"># unicode编码成了utf-8格式，而编码的结果为bytes类型，可以当作直接当作二进制去使用</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">b'\\xe4\\xb8\\x8a'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token string\">'bytes'</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 2、其它编码格式------解码decode-------->unicode格式</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> \n<span class=\"token string\">'上'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=27\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=27<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=28\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=28<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=29\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=29<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=30\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=30<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 字符串类型、文本文件的内容都是由字符组成的，但凡涉及到字符的存取，都需要考虑字符编码的问题。</p>\n<p> 字符编码这个知识点的典型特征就是理论多、结论少，但对于开发而言只需要记住结论即可，下面让我们来一点点介绍它</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-621d28181cc40a235414a49fc9d14738_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-知识储备\"><a href=\"#二-知识储备\" class=\"headerlink\" title=\"二 知识储备\"></a>二 知识储备</h2><h2 id=\"2-1-三大核心硬件\"><a href=\"#2-1-三大核心硬件\" class=\"headerlink\" title=\"2.1 三大核心硬件\"></a>2.1 三大核心硬件</h2><p>所有软件都是运行硬件之上的，与运行软件相关的三大核心硬件为cpu、内存、硬盘，我们需要明确三点</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、软件运行前，软件的代码及其相关数据都是存放于硬盘中的</span>\n\n<span class=\"token comment\">#2、任何软件的启动都是将数据从硬盘中读入内存，然后cpu从内存中取出指令并执行</span>\n\n<span class=\"token comment\">#3、软件运行过程中产生的数据最先都是存放于内存中的，若想永久保存软件产生的数据，则需要将数据由内存写入硬盘</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-48e25e7f03030e066f8fcaf4750cc892_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-文本编辑器读取文件内容的流程\"><a href=\"#2-2-文本编辑器读取文件内容的流程\" class=\"headerlink\" title=\"2.2 文本编辑器读取文件内容的流程\"></a>2.2 文本编辑器读取文件内容的流程</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#阶段1、启动一个文件编辑器（文本编辑器如nodepad++，pycharm，word）</span>\n\n<span class=\"token comment\">#阶段2、文件编辑器会将文件内容从硬盘读入内存</span>\n\n<span class=\"token comment\">#阶段3、文本编辑器会将刚刚读入内存中的内容显示到屏幕上</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-3-python解释器执行文件的流程\"><a href=\"#2-3-python解释器执行文件的流程\" class=\"headerlink\" title=\"2.3 python解释器执行文件的流程\"></a>2.3 python解释器执行文件的流程</h2><p>以python test.py为例，执行流程如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#阶段1、启动python解释器，此时就相当于启动了一个文本编辑器</span>\n\n<span class=\"token comment\">#阶段2、python解释器相当于文本编辑器，从硬盘上将test.py的内容读入到内存中</span>\n\n<span class=\"token comment\">#阶段3、python解释器解释执行刚刚读入的内存的内容，开始识别python语法</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-4-总结\"><a href=\"#2-4-总结\" class=\"headerlink\" title=\"2.4 总结\"></a>2.4 总结</h2><p>python解释器与文件本编辑的异同如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、相同点：前两个阶段二者完全一致，都是将硬盘中文件的内容读入内存，详解如下</span>\npython解释器是解释执行文件内容的，因而python解释器具备读py文件的功能，这一点与文本编辑器一样\n\n<span class=\"token comment\">#2、不同点：在阶段3时，针对内存中读入的内容处理方式不同，详解如下</span>\n文本编辑器将文件内容读入内存后，是为了显示或者编辑，根本不去理会python的语法，而python解释器将文件内容读入内存后，可不是为了给你瞅一眼python代码写的啥，而是为了执行python代码、会识别python语法）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-c80921c5d7ede2fd94262892c7e0a733_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三、字符编码介绍\"><a href=\"#三、字符编码介绍\" class=\"headerlink\" title=\"三、字符编码介绍\"></a>三、字符编码介绍</h2><h2 id=\"3-1-什么是字符编码？\"><a href=\"#3-1-什么是字符编码？\" class=\"headerlink\" title=\"3.1 什么是字符编码？\"></a>3.1 什么是字符编码？</h2><p>人类在与计算机交互时，用的都是人类能读懂的字符，如中文字符、英文字符、日文字符等</p>\n<p>而计算机只能识别二进制数,详解如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#二进制数即由0和1组成的数字，例如010010101010。计算机是基于电工作的，电的特性即高低电平，人类从逻辑层面将高电平对应为数字1,低电平对应为数字0，这直接决定了计算机可以识别的是由0和1组成的数字</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>毫无疑问，由人类的字符到计算机中的数字，必须经历一个过程，如下</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-80b925e192579faa59dcffbb046535a4_720w.jpg\" alt=\"img\"></p>\n<p>翻译的过程必须参照一个特定的标准，该标准称之为字符编码表，该表上存放的就是字符与数字一一对应的关系。</p>\n<p>字符编码中的编码指的是翻译或者转换的意思，即将人能理解的字符翻译成计算机能识别的数字</p>\n<h2 id=\"3-2-字符编码表的发展史-了解\"><a href=\"#3-2-字符编码表的发展史-了解\" class=\"headerlink\" title=\"3.2 字符编码表的发展史 (了解)\"></a>3.2 字符编码表的发展史 (了解)</h2><p>字符编码的发展经历了三个重要的阶段，如下</p>\n<h3 id=\"3-2-1-阶段一：一家独大\"><a href=\"#3-2-1-阶段一：一家独大\" class=\"headerlink\" title=\"3.2.1 阶段一：一家独大\"></a>3.2.1 阶段一：一家独大</h3><p>现代计算机起源于美国，所以最先考虑仅仅是让计算机识别英文字符，于是诞生了ASCII表</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># ASCII表的特点:</span>\n    <span class=\"token number\">1</span>、只有英文字符与数字的一一对应关系\n    <span class=\"token number\">2</span>、一个英文字符对应1Bytes，1Bytes<span class=\"token operator\">=</span>8bit，8bit最多包含<span class=\"token number\">256</span>个数字，可以对应<span class=\"token number\">256</span>个字符，足够表示所有英文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-c4a210efb1a57b869288eb7e89bf6fc9_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"3-2-2-阶段二：诸侯割据、天下大乱\"><a href=\"#3-2-2-阶段二：诸侯割据、天下大乱\" class=\"headerlink\" title=\"3.2.2 阶段二：诸侯割据、天下大乱\"></a>3.2.2 阶段二：诸侯割据、天下大乱</h3><p><img src=\"https://pic2.zhimg.com/80/v2-114700ee2814bcf3de172a4b673001e1_720w.jpg\" alt=\"img\"></p>\n<p>为了让计算机能够识别中文和英文，中国人定制了GBK</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># GBK表的特点：</span>\n    <span class=\"token number\">1</span>、只有中文字符、英文字符与数字的一一对应关系\n    <span class=\"token number\">2</span>、一个英文字符对应1Bytes\n       一个中文字符对应2Bytes   \n       补充说明：\n       1Bytes<span class=\"token operator\">=</span>8bit，8bit最多包含<span class=\"token number\">256</span>个数字，可以对应<span class=\"token number\">256</span>个字符，足够表示所有英文字符\n       2Bytes<span class=\"token operator\">=</span>16bit，16bit最多包含<span class=\"token number\">65536</span>个数字，可以对应<span class=\"token number\">65536</span>个字符，足够表示所有中文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>每个国家都各自的字符，为让计算机能够识别自己国家的字符外加英文字符，各个国家都制定了自己的字符编码表</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># Shift_JIS表的特点：</span>\n    <span class=\"token number\">1</span>、只有日文字符、英文字符与数字的一一对应关系\n\n<span class=\"token comment\"># Euc-kr表的特点：</span>\n    <span class=\"token number\">1</span>、只有韩文字符、英文字符与数字的一一对应关系<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>此时,美国人用的计算机里使用字符编码标准是ASCII、中国人用的计算机里使用字符编码标准是GBK、日本人用的计算机里使用字符编码标准是Shift_JIS,如下图所示，</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-19bac7b0910652bbd1f7e026683a28be_720w.jpg\" alt=\"img\"></p>\n<p>字符编码发展到了这个阶段，可以用一句话概括：诸侯割据、天下大乱，详解如下</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-b6ac2031b2082daa422c8dc233be95ee_720w.jpg\" alt=\"img\"></p>\n<p>图1中，文本编辑存取文件的原理如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">文本文件内容全都为字符，无论存取都是涉及到字符编码问题\n<span class=\"token comment\">#1、存文本文件</span>\n人类通过文本编辑器输入的字符会被转化成ASCII格式的二进制存放于内存中，如果需要永久保存，则直接将内存中的ASCII格式的二进制写入硬盘\n\n<span class=\"token comment\">#2、读文本文件</span>\n直接将硬盘中的ASCII格式的二进制读入内存，然后通过ASCII表反解成英文字符<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>图2图3都是相同的过程，此时无论是存还是取由于采用的字符编码表一样，所以肯定不会出现乱码问题，但问题是在美国人用的计算机里只能输入英文字符，而在中国人用的计算机里只能输入中文字符和英文字符….,毫无疑问我们希望计算机允许我们输入万国字符均可识别、不乱码，而现阶段计算机采用的字符编码ASCII、GBK、Shift_JIS都无法识别万国字符，所以我们必须定制一个兼容万国字符的编码表，请看阶段三</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-aeb16d83abab152e00e7e2f99eaeb102_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"3-2-3-阶段三：分久必合\"><a href=\"#3-2-3-阶段三：分久必合\" class=\"headerlink\" title=\"3.2.3 阶段三：分久必合\"></a>3.2.3 阶段三：分久必合</h3><p><img src=\"https://pic1.zhimg.com/80/v2-f405404cd434f2280b4586c4f95ce760_720w.jpg\" alt=\"img\"></p>\n<p>unicode于1990年开始研发，1994年正式公布，具备两大特点：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1. 存在所有语言中的所有字符与数字的一一对应关系,即兼容万国字符</span>\n\n<span class=\"token comment\">#2. 与传统的字符编码的二进制数都有对应关系，详解如下</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>很多地方或老的系统、应用软件仍会采用各种各样传统的编码，这是历史遗留问题。此处需要强调：软件是存放于硬盘的，而运行软件是要将软件加载到内存的，面对硬盘中存放的各种传统编码的软件，想让我们的计算机能够将它们全都正常运行而不出现乱码，内存中必须有一种兼容万国的编码，并且该编码需要与其他编码有相对应的映射&#x2F;转换关系，这就是unicode的第二大特点产生的缘由</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-484a43054d2217ed11c7d5d9170675f8_720w.jpg\" alt=\"img\"></p>\n<p>文本编辑器输入任何字符都是最新存在于内存中，是unicode编码的，存放于硬盘中，则可以转换成任意其他编码，只要该编码可以支持相应的字符</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 英文字符可以被ASCII识别</span>\n英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>unciode格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>ASCII格式的数字\n\n<span class=\"token comment\"># 中文字符、英文字符可以被GBK识别</span>\n中文字符、英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token builtin\">unicode</span>格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>gbk格式的数字\n\n<span class=\"token comment\"># 日文字符、英文字符可以被shift-JIS识别</span>\n日文字符、英文字符<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token builtin\">unicode</span>格式的数字<span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">></span>shift<span class=\"token operator\">-</span>JIS格式的数字<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-77be4ea6e528d6ed700fd08b2096566f_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-3-编码与解码\"><a href=\"#3-3-编码与解码\" class=\"headerlink\" title=\"3.3 编码与解码\"></a>3.3 编码与解码</h2><p>由字符转换成内存中的unicode，以及由unicode转换成其他编码的过程，都称为编码encode</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-08a12814397a5a6d3e530a66cf2dbc02_720w.jpg\" alt=\"img\"></p>\n<p>由内存中的unicode转换成字符，以及由其他编码转换成unicode的过程，都称为解码decode</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-5f7b25aaeb4ccc913f0c23d586acdbab_720w.jpg\" alt=\"img\"></p>\n<p>在诸多文件类型中，只有文本文件的内存是由字符组成的，因而文本文件的存取也涉及到字符编码的问题</p>\n<h2 id=\"3-4-utf-8的由来\"><a href=\"#3-4-utf-8的由来\" class=\"headerlink\" title=\"3.4 utf-8的由来\"></a>3.4 utf-8的由来</h2><p>注意：如果保存到硬盘的是GBK格式二进制，当初用户输入的字符只能是中文或英文，同理如果保存到硬盘的是Shift_JIS格式二进制，当初用户输入的字符只能是日文或英文……如果我们输入的字符中包含多国字符，那么该如何处理？</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（GBK格式的二进制）</span>\n\n<span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——X—》硬盘（Shift_JIS格式的二进制）</span>\n\n<span class=\"token comment\">#多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（???格式的二进制）</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>理论上是可以将内存中unicode格式的二进制直接存放于硬盘中的，但由于unicode固定使用两个字节来存储一个字符，如果多国字符中包含大量的英文字符时，使用unicode格式存放会额外占用一倍空间（英文字符其实只需要用一个字节存放即可），然而空间占用并不是最致命的问题，最致命地是当我们由内存写入硬盘时会额外耗费一倍的时间，所以将内存中的unicode二进制写入硬盘或者基于网络传输时必须将其转换成一种精简的格式，这种格式即utf-8（全称Unicode Transformation Format，即unicode的转换格式）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 多国字符—√—》内存（unicode格式的二进制）——√—》硬盘（utf-8格式的二进制）</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-c2a4ec82d946e4e35645f9782dbc798a_720w.jpg\" alt=\"img\"></p>\n<p>那为何在内存中不直接使用utf-8呢？</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>是针对Unicode的可变长度字符编码：一个英文字符占1Bytes，一个中文字符占3Bytes，生僻字用更多的Bytes存储\n\n<span class=\"token builtin\">unicode</span>更像是一个过渡版本，我们新开发的软件或文件存入硬盘都采用utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>格式，等过去几十年，所有老编码的文件都淘汰掉之后，会出现一个令人开心的场景，即硬盘里放的都是utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>格式，此时<span class=\"token builtin\">unicode</span>便可以退出历史舞台，内存里也改用utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>，天下重新归于统一<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-183090ce203c9e1b6edab8aff77460cb_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-字符编码的应用\"><a href=\"#四-字符编码的应用\" class=\"headerlink\" title=\"四 字符编码的应用\"></a>四 字符编码的应用</h2><p>我们学习字符编码就是为了存取字符时不发生乱码问题：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、内存中固定使用unicode无论输入任何字符都不会发生乱码</span>\n\n<span class=\"token comment\">#2、我们能够修改的是存/取硬盘的编码方式，如果编码设置不正确将会出现乱码问题。乱码问题分为两种：存乱了，读乱了</span>\n\n<span class=\"token comment\">#2.1 存乱了：如果用户输入的内容中包含中文和日文字符，如果单纯以shift_JIS存，日文可以正常写入硬盘，而由于中文字符在shift_jis中没有找到对应关系而导致存乱了</span>\n\n<span class=\"token comment\">#2.2 读乱了：如果硬盘中的数据是shift_JIS格式存储的，采GBK格式读入内存就读乱了</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>总结：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1. 保证存的时候不乱：在由内存写入硬盘时，必须将编码格式设置为支持所输入字符的编码格式</span>\n<span class=\"token comment\">#2. 保证存的时候不乱：在由硬盘读入内存时，必须采用与写入硬盘时相同的编码格式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"4-1-文本编辑器nodpad-存取文本文件\"><a href=\"#4-1-文本编辑器nodpad-存取文本文件\" class=\"headerlink\" title=\"4.1 文本编辑器nodpad++存取文本文件\"></a>4.1 文本编辑器nodpad++存取文本文件</h2><p>文本编辑器存取的都是文本文件，而文本文件中包含的内容全为字符，所以存取文本文件都涉及到字符编码的问题。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-80d179cdb9262eced650c8574bc74d33_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-75e2cb4b6932bc76c6161a086ad1a5a3_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-3d3b0ae681354751c1a85d75b27ee1d0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-2-python解释器执行文件的前两个阶段\"><a href=\"#4-2-python解释器执行文件的前两个阶段\" class=\"headerlink\" title=\"4.2 python解释器执行文件的前两个阶段\"></a>4.2 python解释器执行文件的前两个阶段</h2><p>执行py文件的前两个阶段就是python解释器读文本文件的过程，与文本编辑读文本文件的前两个阶段没人任何区别，要保证读不乱码，则必须将python解释器读文件时采用的编码方式设置为文件当初写入硬盘时的编码格式，如果没有设置，python解释器则才用默认的编码方式，在python3中默认为utf-8，在python2中默认为ASCII，我们可以通过指定文件头来修改默认的编码</p>\n<ul>\n<li>在文件首行写入包含#号在内的以下内容</li>\n</ul>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding: 当初文件写入硬盘时采用的编码格式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>解释器会先用默认的编码方式读取文件的首行内容，由于首行是纯英文组成，而任何编码方式都可以识别英文字符。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-b39022bd9969bcba565b7cfe6c067b13_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-3-python解释器执行文件的第三个阶段\"><a href=\"#4-3-python解释器执行文件的第三个阶段\" class=\"headerlink\" title=\"4.3 python解释器执行文件的第三个阶段\"></a>4.3 python解释器执行文件的第三个阶段</h2><p>设置文件头的作用是保证运行python程序的前两个阶段不乱码，经过前两个阶段后py文件的内容都会以unicode格式存放于内存中。</p>\n<p>在经历第三个阶段时开始识别python语法，当遇到特定的语法name &#x3D; ‘上’（代码本身也都全都是unicode格式存的）时，需要申请内存空间来存储字符串’上’，这就又涉及到应该以什么编码存储‘上’的问题了。</p>\n<p>在Python3中，字符串类的值都是使用unicode格式来存储</p>\n<p>由于Python2的盛行是早于unicode的，因此在Python2中是按照文件头指定的编码来存储字符串类型的值的（如果文件头中没有指定编码，那么解释器会按照它自己默认的编码方式来存储‘上’），所以，这就有可能导致乱码问题</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-d27cfdaa0659c34c85fcff4a48a4e2f9_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding:utf-8</span>\nx <span class=\"token operator\">=</span> <span class=\"token string\">'上'</span> <span class=\"token comment\"># x的值为untf-8格式的二进制</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 打印操作是将x的值，即utf-8格式的二进制交给终端，当终端收到后发现并不是unicode（只有unicode才与字符有对应关系），所以终端会执行操作：utf-8二进制---解码-->unicode格式的二进制，解码的过程终端会采用自己默认的编码，而在pycharm的终端默认编码为utf-8、windows下的cmd终端的默认编码为gbk，所以该打印操作在pycharm中显示正常，而在windows下的cmd中则乱码</span>\n\n<span class=\"token comment\"># 在windows下的cmd中运行效果如下</span>\nC<span class=\"token punctuation\">:</span>\\Users\\Administrator<span class=\"token operator\">></span>python2 E<span class=\"token punctuation\">:</span>\\aaa<span class=\"token punctuation\">.</span>py\n涓<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>python2后推出了一种补救措施，就是在字符串类型前加u，则会将字符串类型强制存储unicode，这就与python3保持一致了，对于unicode格式无论丢给任何终端进行打印，都可以直接对应字符不会出现乱码问题</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># coding:utf-8</span>\nx <span class=\"token operator\">=</span> <span class=\"token string\">u'上'</span> <span class=\"token comment\"># 即便文件头为utf-8，x的值依然存成unicode</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-1ef12a426d5d928e8ce10eafef489616_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-4-字符串encode编码与decode解码的使用\"><a href=\"#4-4-字符串encode编码与decode解码的使用\" class=\"headerlink\" title=\"4.4 字符串encode编码与decode解码的使用\"></a>4.4 字符串encode编码与decode解码的使用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、unicode格式------编码encode-------->其它编码格式</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token string\">'上'</span> <span class=\"token comment\"># 在python3在'上'被存成unicode</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token operator\">=</span>x<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token punctuation\">,</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token comment\"># unicode编码成了utf-8格式，而编码的结果为bytes类型，可以当作直接当作二进制去使用</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">b'\\xe4\\xb8\\x8a'</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&lt;</span><span class=\"token keyword\">class</span> <span class=\"token string\">'bytes'</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 2、其它编码格式------解码decode-------->unicode格式</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> \n<span class=\"token string\">'上'</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=27\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=27<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=28\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=28<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=29\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=29<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=30\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=30<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n"},{"_content":"## 一 引入\n\n 基于前一部分的学习，我们已经能开发一些功能简单的小程序了，但随着程序功能的增多，代码量随之增大，此时仍不加区分地把所有功能的实现代码放到一起，将会使得程序的组织结构不清晰，可读性变差，且程序中需要频繁使用同一功能时，只能重复编写该功能的实现代码，日积月累，程序将变得冗长，并且当某一功能需要修改时，又不得不找出所有定义及使用这段功能的地方修改之，管理维护的难度极大，好吧，装了半天逼，到底该如何解决提出的这些问题呢？\n\n![img](https://pic1.zhimg.com/80/v2-9c9953bf70a721520e78add4ceeeb340_720w.jpg)\n\n我们完全可以从现实生活中找到简化程序设计的方案：比如一个修理工会事先准备好螺丝刀、锤子等工具，这样在进行修理的过程中，需要用到拧螺丝的功能时就直接拿来螺丝刀使用，需要用到锤击物体的功能时就直接拿来锤子使用，而无需临时制造。这个例子的核心在于’事先准备好工具’，遇到应用场景时’拿来就用’，。\n\n在程序中，具备某一功能的‘工具’指的就是函数，‘事先准备工具’的过程即函数的定义，‘拿来就用’即函数的调用。\n\n## 二 定义函数\n\n函数的使用必须遵循’先定义，后调用’的原则。函数的定义就相当于事先将函数体代码保存起来，然后将内存地址赋值给函数名，函数名就是对这段代码的引用，这和变量的定义是相似的。没有事先定义函数而直接调用，就相当于在引用一个不存在的’变量名’。\n\n定义函数的语法\n\n```python\ndef 函数名(参数1,参数2,...):\n    \"\"\"文档描述\"\"\"\n    函数体\n    return 值\n```\n\n1. def: 定义函数的关键字；\n2. 函数名：函数名指向函数内存地址，是对函数体代码的引用。函数的命名应该反映出函数的功能；\n3. 括号：括号内定义参数，参数是可有可无的，且无需指定参数的类型；\n4. 冒号：括号后要加冒号，然后在下一行开始缩进编写函数体的代码；\n5. \"\"\"文档描述\"\"\": 描述函数功能，参数介绍等信息的文档，非必要，但是建议加上，从而增强函数的可读性；\n6. 函数体：由语句和表达式组成；\n7. return 值：定义函数的返回值，return是可有可无的。\n\n![img](https://pic1.zhimg.com/80/v2-b6820acb8b8135a298d22c46d88dc078_720w.jpg)\n\n参数是函数的调用者向函数体传值的媒介，若函数体代码逻辑依赖外部传来的参数时则需要定义为参函数，\n\n```python\ndef my_min(x,y):\n    res=x if x < y else y\n    return res\n```\n\n否则定义为无参函数\n\n```python\ndef interactive():\n    user=input('user>>: ').strip()\n    pwd=input('password>>: ').strip()\n    return (user,pwd)\n```\n\n 函数体为pass代表什么都不做，称之为空函数。定义空函数通常是有用的，因为在程序设计的开始，往往是先想好程序都需要完成什么功能，然后把所有功能都列举出来用pass充当函数体“占位符”，这将使得程序的体系结构立见，清晰且可读性强。例如要编写一个ftp程序，我们可能想到的功能有用户认证，下载，上传，浏览，切换目录等功能，可以先做出如下定义：\n\n```python\ndef auth_user():\n    \"\"\"user authentication function\"\"\"\n    pass\n\ndef download_file():\n    \"\"\"download file function\"\"\"\n    pass\n\ndef upload_file():\n    \"\"\"upload file function\"\"\"\n    pass\n\ndef ls():\n    \"\"\"list contents function\"\"\"\n    pass\n\ndef cd():\n    \"\"\"change directory\"\"\"\n    pass\n```\n\n之后我们便可以统筹安排编程任务，有选择性的去实现上述功能来替换掉pass，从而提高开发效率。\n\n![img](https://pic3.zhimg.com/80/v2-7eec3d29ee04903367255ddf4ba56fa2_720w.jpg)\n\n## 三 调用函数与函数返回值\n\n 函数的使用分为定义阶段与调用阶段，定义函数时只检测语法，不执行函数体代码，函数名加括号即函数调用，只有调用函数时才会执行函数体代码\n\n```python\n#定义阶段\ndef foo():\n    print('in the foo')\n    bar()\n\ndef bar():\n    print('in the bar')\n\n#调用阶段\nfoo()\n```\n\n执行结果：\n\n```python\nin the foo\nin the bar\n```\n\n定义阶段函数foo与bar均无语法错误，而在调用阶段调用foo()时，函数foo与bar都早已经存在于内存中了，所以不会有任何问题。\n\n![img](https://pic4.zhimg.com/80/v2-49571392a08c9cb0980b37d25890cf57_720w.jpg)\n\n按照在程序出现的形式和位置，可将函数的调用形式分为三种：\n\n```python\n#1、语句形式：\nfoo()\n\n#2、表达式形式：\nm=my_min(1,2) #将调用函数的返回值赋值给x\nn=10*my_min(1,2) #将调用函数的返回值乘以10的结果赋值给n\n\n#3、函数调用作为参数的形式：\n# my_min（2，3）作为函数my_min的第二个参数，实现了取1,2,3中的较小者赋值给m\nm=my_min(1，my_min（2，3）)\n```\n\n若需要将函数体代码执行的结果返回给调用者，则需要用到return。return后无值或直接省略return，则默认返回None，return的返回值无类型限制，且可以将多个返回值放到一个元组内。\n\n```python\n>>> def test(x,y,z):\n...     return x,y,z #等同于return (x,y,z)\n... \n>>> res=test(1,2,3)\n>>> print(res)\n(1, 2, 3)\n```\n\nreturn是一个函数结束的标志,函数内可以有多个return，但只执行一次函数就结束了，并把return后定义的值作为本次调用的结果返回。\n\n![img](https://pic3.zhimg.com/80/v2-46449ad493f48f4863cefab55f8da196_720w.jpg)\n\n## 视频链接：\n\n函数基础\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=38![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D38)\n\n函数返回值\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=39![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D39)","source":"_posts/03_Python/01_Python基础/11_函数的基本使用.md","raw":"## 一 引入\n\n 基于前一部分的学习，我们已经能开发一些功能简单的小程序了，但随着程序功能的增多，代码量随之增大，此时仍不加区分地把所有功能的实现代码放到一起，将会使得程序的组织结构不清晰，可读性变差，且程序中需要频繁使用同一功能时，只能重复编写该功能的实现代码，日积月累，程序将变得冗长，并且当某一功能需要修改时，又不得不找出所有定义及使用这段功能的地方修改之，管理维护的难度极大，好吧，装了半天逼，到底该如何解决提出的这些问题呢？\n\n![img](https://pic1.zhimg.com/80/v2-9c9953bf70a721520e78add4ceeeb340_720w.jpg)\n\n我们完全可以从现实生活中找到简化程序设计的方案：比如一个修理工会事先准备好螺丝刀、锤子等工具，这样在进行修理的过程中，需要用到拧螺丝的功能时就直接拿来螺丝刀使用，需要用到锤击物体的功能时就直接拿来锤子使用，而无需临时制造。这个例子的核心在于’事先准备好工具’，遇到应用场景时’拿来就用’，。\n\n在程序中，具备某一功能的‘工具’指的就是函数，‘事先准备工具’的过程即函数的定义，‘拿来就用’即函数的调用。\n\n## 二 定义函数\n\n函数的使用必须遵循’先定义，后调用’的原则。函数的定义就相当于事先将函数体代码保存起来，然后将内存地址赋值给函数名，函数名就是对这段代码的引用，这和变量的定义是相似的。没有事先定义函数而直接调用，就相当于在引用一个不存在的’变量名’。\n\n定义函数的语法\n\n```python\ndef 函数名(参数1,参数2,...):\n    \"\"\"文档描述\"\"\"\n    函数体\n    return 值\n```\n\n1. def: 定义函数的关键字；\n2. 函数名：函数名指向函数内存地址，是对函数体代码的引用。函数的命名应该反映出函数的功能；\n3. 括号：括号内定义参数，参数是可有可无的，且无需指定参数的类型；\n4. 冒号：括号后要加冒号，然后在下一行开始缩进编写函数体的代码；\n5. \"\"\"文档描述\"\"\": 描述函数功能，参数介绍等信息的文档，非必要，但是建议加上，从而增强函数的可读性；\n6. 函数体：由语句和表达式组成；\n7. return 值：定义函数的返回值，return是可有可无的。\n\n![img](https://pic1.zhimg.com/80/v2-b6820acb8b8135a298d22c46d88dc078_720w.jpg)\n\n参数是函数的调用者向函数体传值的媒介，若函数体代码逻辑依赖外部传来的参数时则需要定义为参函数，\n\n```python\ndef my_min(x,y):\n    res=x if x < y else y\n    return res\n```\n\n否则定义为无参函数\n\n```python\ndef interactive():\n    user=input('user>>: ').strip()\n    pwd=input('password>>: ').strip()\n    return (user,pwd)\n```\n\n 函数体为pass代表什么都不做，称之为空函数。定义空函数通常是有用的，因为在程序设计的开始，往往是先想好程序都需要完成什么功能，然后把所有功能都列举出来用pass充当函数体“占位符”，这将使得程序的体系结构立见，清晰且可读性强。例如要编写一个ftp程序，我们可能想到的功能有用户认证，下载，上传，浏览，切换目录等功能，可以先做出如下定义：\n\n```python\ndef auth_user():\n    \"\"\"user authentication function\"\"\"\n    pass\n\ndef download_file():\n    \"\"\"download file function\"\"\"\n    pass\n\ndef upload_file():\n    \"\"\"upload file function\"\"\"\n    pass\n\ndef ls():\n    \"\"\"list contents function\"\"\"\n    pass\n\ndef cd():\n    \"\"\"change directory\"\"\"\n    pass\n```\n\n之后我们便可以统筹安排编程任务，有选择性的去实现上述功能来替换掉pass，从而提高开发效率。\n\n![img](https://pic3.zhimg.com/80/v2-7eec3d29ee04903367255ddf4ba56fa2_720w.jpg)\n\n## 三 调用函数与函数返回值\n\n 函数的使用分为定义阶段与调用阶段，定义函数时只检测语法，不执行函数体代码，函数名加括号即函数调用，只有调用函数时才会执行函数体代码\n\n```python\n#定义阶段\ndef foo():\n    print('in the foo')\n    bar()\n\ndef bar():\n    print('in the bar')\n\n#调用阶段\nfoo()\n```\n\n执行结果：\n\n```python\nin the foo\nin the bar\n```\n\n定义阶段函数foo与bar均无语法错误，而在调用阶段调用foo()时，函数foo与bar都早已经存在于内存中了，所以不会有任何问题。\n\n![img](https://pic4.zhimg.com/80/v2-49571392a08c9cb0980b37d25890cf57_720w.jpg)\n\n按照在程序出现的形式和位置，可将函数的调用形式分为三种：\n\n```python\n#1、语句形式：\nfoo()\n\n#2、表达式形式：\nm=my_min(1,2) #将调用函数的返回值赋值给x\nn=10*my_min(1,2) #将调用函数的返回值乘以10的结果赋值给n\n\n#3、函数调用作为参数的形式：\n# my_min（2，3）作为函数my_min的第二个参数，实现了取1,2,3中的较小者赋值给m\nm=my_min(1，my_min（2，3）)\n```\n\n若需要将函数体代码执行的结果返回给调用者，则需要用到return。return后无值或直接省略return，则默认返回None，return的返回值无类型限制，且可以将多个返回值放到一个元组内。\n\n```python\n>>> def test(x,y,z):\n...     return x,y,z #等同于return (x,y,z)\n... \n>>> res=test(1,2,3)\n>>> print(res)\n(1, 2, 3)\n```\n\nreturn是一个函数结束的标志,函数内可以有多个return，但只执行一次函数就结束了，并把return后定义的值作为本次调用的结果返回。\n\n![img](https://pic3.zhimg.com/80/v2-46449ad493f48f4863cefab55f8da196_720w.jpg)\n\n## 视频链接：\n\n函数基础\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=38![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D38)\n\n函数返回值\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=39![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D39)","slug":"03_Python/01_Python基础/11_函数的基本使用","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k150024a8v7dohc76ee","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 基于前一部分的学习，我们已经能开发一些功能简单的小程序了，但随着程序功能的增多，代码量随之增大，此时仍不加区分地把所有功能的实现代码放到一起，将会使得程序的组织结构不清晰，可读性变差，且程序中需要频繁使用同一功能时，只能重复编写该功能的实现代码，日积月累，程序将变得冗长，并且当某一功能需要修改时，又不得不找出所有定义及使用这段功能的地方修改之，管理维护的难度极大，好吧，装了半天逼，到底该如何解决提出的这些问题呢？</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-9c9953bf70a721520e78add4ceeeb340_720w.jpg\" alt=\"img\"></p>\n<p>我们完全可以从现实生活中找到简化程序设计的方案：比如一个修理工会事先准备好螺丝刀、锤子等工具，这样在进行修理的过程中，需要用到拧螺丝的功能时就直接拿来螺丝刀使用，需要用到锤击物体的功能时就直接拿来锤子使用，而无需临时制造。这个例子的核心在于’事先准备好工具’，遇到应用场景时’拿来就用’，。</p>\n<p>在程序中，具备某一功能的‘工具’指的就是函数，‘事先准备工具’的过程即函数的定义，‘拿来就用’即函数的调用。</p>\n<h2 id=\"二-定义函数\"><a href=\"#二-定义函数\" class=\"headerlink\" title=\"二 定义函数\"></a>二 定义函数</h2><p>函数的使用必须遵循’先定义，后调用’的原则。函数的定义就相当于事先将函数体代码保存起来，然后将内存地址赋值给函数名，函数名就是对这段代码的引用，这和变量的定义是相似的。没有事先定义函数而直接调用，就相当于在引用一个不存在的’变量名’。</p>\n<p>定义函数的语法</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> 函数名<span class=\"token punctuation\">(</span>参数<span class=\"token number\">1</span><span class=\"token punctuation\">,</span>参数<span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"文档描述\"\"\"</span>\n    函数体\n    <span class=\"token keyword\">return</span> 值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>def: 定义函数的关键字；</li>\n<li>函数名：函数名指向函数内存地址，是对函数体代码的引用。函数的命名应该反映出函数的功能；</li>\n<li>括号：括号内定义参数，参数是可有可无的，且无需指定参数的类型；</li>\n<li>冒号：括号后要加冒号，然后在下一行开始缩进编写函数体的代码；</li>\n<li>“””文档描述”””: 描述函数功能，参数介绍等信息的文档，非必要，但是建议加上，从而增强函数的可读性；</li>\n<li>函数体：由语句和表达式组成；</li>\n<li>return 值：定义函数的返回值，return是可有可无的。</li>\n</ol>\n<p><img src=\"https://pic1.zhimg.com/80/v2-b6820acb8b8135a298d22c46d88dc078_720w.jpg\" alt=\"img\"></p>\n<p>参数是函数的调用者向函数体传值的媒介，若函数体代码逻辑依赖外部传来的参数时则需要定义为参函数，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">my_min</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    res<span class=\"token operator\">=</span>x <span class=\"token keyword\">if</span> x <span class=\"token operator\">&lt;</span> y <span class=\"token keyword\">else</span> y\n    <span class=\"token keyword\">return</span> res<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>否则定义为无参函数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">interactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'password>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>pwd<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p> 函数体为pass代表什么都不做，称之为空函数。定义空函数通常是有用的，因为在程序设计的开始，往往是先想好程序都需要完成什么功能，然后把所有功能都列举出来用pass充当函数体“占位符”，这将使得程序的体系结构立见，清晰且可读性强。例如要编写一个ftp程序，我们可能想到的功能有用户认证，下载，上传，浏览，切换目录等功能，可以先做出如下定义：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">auth_user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"user authentication function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">download_file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"download file function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">upload_file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"upload file function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">ls</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"list contents function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">cd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"change directory\"\"\"</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>之后我们便可以统筹安排编程任务，有选择性的去实现上述功能来替换掉pass，从而提高开发效率。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-7eec3d29ee04903367255ddf4ba56fa2_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-调用函数与函数返回值\"><a href=\"#三-调用函数与函数返回值\" class=\"headerlink\" title=\"三 调用函数与函数返回值\"></a>三 调用函数与函数返回值</h2><p> 函数的使用分为定义阶段与调用阶段，定义函数时只检测语法，不执行函数体代码，函数名加括号即函数调用，只有调用函数时才会执行函数体代码</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#定义阶段</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'in the foo'</span><span class=\"token punctuation\">)</span>\n    bar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'in the bar'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#调用阶段</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>执行结果：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">in</span> the foo\n<span class=\"token keyword\">in</span> the bar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>定义阶段函数foo与bar均无语法错误，而在调用阶段调用foo()时，函数foo与bar都早已经存在于内存中了，所以不会有任何问题。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-49571392a08c9cb0980b37d25890cf57_720w.jpg\" alt=\"img\"></p>\n<p>按照在程序出现的形式和位置，可将函数的调用形式分为三种：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、语句形式：</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#2、表达式形式：</span>\nm<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#将调用函数的返回值赋值给x</span>\nn<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#将调用函数的返回值乘以10的结果赋值给n</span>\n\n<span class=\"token comment\">#3、函数调用作为参数的形式：</span>\n<span class=\"token comment\"># my_min（2，3）作为函数my_min的第二个参数，实现了取1,2,3中的较小者赋值给m</span>\nm<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>，my_min（<span class=\"token number\">2</span>，<span class=\"token number\">3</span>）<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>若需要将函数体代码执行的结果返回给调用者，则需要用到return。return后无值或直接省略return，则默认返回None，return的返回值无类型限制，且可以将多个返回值放到一个元组内。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z <span class=\"token comment\">#等同于return (x,y,z)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token operator\">=</span>test<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>return是一个函数结束的标志,函数内可以有多个return，但只执行一次函数就结束了，并把return后定义的值作为本次调用的结果返回。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-46449ad493f48f4863cefab55f8da196_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>函数基础</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=38\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=38<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p>函数返回值</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=39\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=39<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 基于前一部分的学习，我们已经能开发一些功能简单的小程序了，但随着程序功能的增多，代码量随之增大，此时仍不加区分地把所有功能的实现代码放到一起，将会使得程序的组织结构不清晰，可读性变差，且程序中需要频繁使用同一功能时，只能重复编写该功能的实现代码，日积月累，程序将变得冗长，并且当某一功能需要修改时，又不得不找出所有定义及使用这段功能的地方修改之，管理维护的难度极大，好吧，装了半天逼，到底该如何解决提出的这些问题呢？</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-9c9953bf70a721520e78add4ceeeb340_720w.jpg\" alt=\"img\"></p>\n<p>我们完全可以从现实生活中找到简化程序设计的方案：比如一个修理工会事先准备好螺丝刀、锤子等工具，这样在进行修理的过程中，需要用到拧螺丝的功能时就直接拿来螺丝刀使用，需要用到锤击物体的功能时就直接拿来锤子使用，而无需临时制造。这个例子的核心在于’事先准备好工具’，遇到应用场景时’拿来就用’，。</p>\n<p>在程序中，具备某一功能的‘工具’指的就是函数，‘事先准备工具’的过程即函数的定义，‘拿来就用’即函数的调用。</p>\n<h2 id=\"二-定义函数\"><a href=\"#二-定义函数\" class=\"headerlink\" title=\"二 定义函数\"></a>二 定义函数</h2><p>函数的使用必须遵循’先定义，后调用’的原则。函数的定义就相当于事先将函数体代码保存起来，然后将内存地址赋值给函数名，函数名就是对这段代码的引用，这和变量的定义是相似的。没有事先定义函数而直接调用，就相当于在引用一个不存在的’变量名’。</p>\n<p>定义函数的语法</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> 函数名<span class=\"token punctuation\">(</span>参数<span class=\"token number\">1</span><span class=\"token punctuation\">,</span>参数<span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"文档描述\"\"\"</span>\n    函数体\n    <span class=\"token keyword\">return</span> 值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>def: 定义函数的关键字；</li>\n<li>函数名：函数名指向函数内存地址，是对函数体代码的引用。函数的命名应该反映出函数的功能；</li>\n<li>括号：括号内定义参数，参数是可有可无的，且无需指定参数的类型；</li>\n<li>冒号：括号后要加冒号，然后在下一行开始缩进编写函数体的代码；</li>\n<li>“””文档描述”””: 描述函数功能，参数介绍等信息的文档，非必要，但是建议加上，从而增强函数的可读性；</li>\n<li>函数体：由语句和表达式组成；</li>\n<li>return 值：定义函数的返回值，return是可有可无的。</li>\n</ol>\n<p><img src=\"https://pic1.zhimg.com/80/v2-b6820acb8b8135a298d22c46d88dc078_720w.jpg\" alt=\"img\"></p>\n<p>参数是函数的调用者向函数体传值的媒介，若函数体代码逻辑依赖外部传来的参数时则需要定义为参函数，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">my_min</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    res<span class=\"token operator\">=</span>x <span class=\"token keyword\">if</span> x <span class=\"token operator\">&lt;</span> y <span class=\"token keyword\">else</span> y\n    <span class=\"token keyword\">return</span> res<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>否则定义为无参函数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">interactive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'user>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'password>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>pwd<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p> 函数体为pass代表什么都不做，称之为空函数。定义空函数通常是有用的，因为在程序设计的开始，往往是先想好程序都需要完成什么功能，然后把所有功能都列举出来用pass充当函数体“占位符”，这将使得程序的体系结构立见，清晰且可读性强。例如要编写一个ftp程序，我们可能想到的功能有用户认证，下载，上传，浏览，切换目录等功能，可以先做出如下定义：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">auth_user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"user authentication function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">download_file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"download file function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">upload_file</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"upload file function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">ls</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"list contents function\"\"\"</span>\n    <span class=\"token keyword\">pass</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">cd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"change directory\"\"\"</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>之后我们便可以统筹安排编程任务，有选择性的去实现上述功能来替换掉pass，从而提高开发效率。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-7eec3d29ee04903367255ddf4ba56fa2_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-调用函数与函数返回值\"><a href=\"#三-调用函数与函数返回值\" class=\"headerlink\" title=\"三 调用函数与函数返回值\"></a>三 调用函数与函数返回值</h2><p> 函数的使用分为定义阶段与调用阶段，定义函数时只检测语法，不执行函数体代码，函数名加括号即函数调用，只有调用函数时才会执行函数体代码</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#定义阶段</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'in the foo'</span><span class=\"token punctuation\">)</span>\n    bar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'in the bar'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#调用阶段</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>执行结果：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">in</span> the foo\n<span class=\"token keyword\">in</span> the bar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>定义阶段函数foo与bar均无语法错误，而在调用阶段调用foo()时，函数foo与bar都早已经存在于内存中了，所以不会有任何问题。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-49571392a08c9cb0980b37d25890cf57_720w.jpg\" alt=\"img\"></p>\n<p>按照在程序出现的形式和位置，可将函数的调用形式分为三种：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1、语句形式：</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#2、表达式形式：</span>\nm<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#将调用函数的返回值赋值给x</span>\nn<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#将调用函数的返回值乘以10的结果赋值给n</span>\n\n<span class=\"token comment\">#3、函数调用作为参数的形式：</span>\n<span class=\"token comment\"># my_min（2，3）作为函数my_min的第二个参数，实现了取1,2,3中的较小者赋值给m</span>\nm<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>，my_min（<span class=\"token number\">2</span>，<span class=\"token number\">3</span>）<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>若需要将函数体代码执行的结果返回给调用者，则需要用到return。return后无值或直接省略return，则默认返回None，return的返回值无类型限制，且可以将多个返回值放到一个元组内。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z <span class=\"token comment\">#等同于return (x,y,z)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> res<span class=\"token operator\">=</span>test<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>return是一个函数结束的标志,函数内可以有多个return，但只执行一次函数就结束了，并把return后定义的值作为本次调用的结果返回。</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-46449ad493f48f4863cefab55f8da196_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>函数基础</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=38\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=38<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p>函数返回值</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=39\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=39<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n"},{"_content":"## 一 引入\n\n 应用程序运行过程中产生的数据最先都是存放于内存中的，若想永久保存下来，必须要保存于硬盘中。应用程序若想操作硬件必须通过操作系统，而文件就是操作系统提供给应用程序来操作硬盘的虚拟概念，用户或应用程序对文件的操作，就是向操作系统发起调用，然后由操作系统完成对硬盘的具体操作。\n\n![img](https://pic2.zhimg.com/80/v2-e1c5ac2494f15c2d7a1ee4732fbb9289_720w.jpg)\n\n## 二 文件操作的基本流程\n\n## 2.1 基本流程\n\n![img](https://pic3.zhimg.com/80/v2-5f2bdccc6b9d407c733fe1c4315a050a_720w.jpg)\n\n有了文件的概念，我们无需再去考虑操作硬盘的细节，只需要关注操作文件的流程：\n\n```python\n# 1. 打开文件，由应用程序向操作系统发起系统调用open(...)，操作系统打开该文件，对应一块硬盘空间，并返回一个文件对象赋值给一个变量f\nf=open('a.txt','r',encoding='utf-8') #默认打开模式就为r\n\n# 2. 调用文件对象下的读/写方法，会被操作系统转换为读/写硬盘的操作\ndata=f.read()\n\n# 3. 向操作系统发起关闭文件的请求，回收系统资源\nf.close()\n```\n\n![img](https://pic2.zhimg.com/80/v2-df5334d72003b1b12e88bdf983af6b5d_720w.jpg)\n\n## 2.2 资源回收与with上下文管理\n\n打开一个文件包含两部分资源：应用程序的变量f和操作系统打开的文件。在操作完毕一个文件时，必须把与该文件的这两部分资源全部回收，回收方法为：\n\n```python\n1、f.close() #回收操作系统打开的文件资源\n2、del f #回收应用程序级的变量\n```\n\n其中del f一定要发生在f.close()之后，否则就会导致操作系统打开的文件无法关闭，白白占用资源， 而python自动的垃圾回收机制决定了我们无需考虑del f，这就要求我们，在操作完毕文件后，一定要记住f.close()，虽然我们如此强调，但是大多数读者还是会不由自主地忘记f.close()，考虑到这一点，python提供了with关键字来帮我们管理上下文\n\n```python\n# 1、在执行完子代码块后，with 会自动执行f.close()\nwith open('a.txt','w') as f:\n    pass \n\n# 2、可用用with同时打开多个文件，用逗号分隔开即可\nwith open('a.txt','r') as read_f,open('b.txt','w') as write_f:  \n    data = read_f.read()\n    write_f.write(data)\n```\n\n![img](https://pic2.zhimg.com/80/v2-d5d2e9ba1e1584d711be9141313c9a55_720w.jpg)\n\n## 2.3 指定操作文本文件的字符编码\n\n```python\nf = open(...)是由操作系统打开文件，如果打开的是文本文件，会涉及到字符编码问题，如果没有为open指定编码，那么打开文本文件的默认编码很明显是操作系统说了算了，操作系统会用自己的默认编码去打开文件，在windows下是gbk，在linux下是utf-8。\n这就用到了上节课讲的字符编码的知识：若要保证不乱码，文件以什么方式存的，就要以什么方式打开。\n\nf = open('a.txt','r',encoding='utf-8')\n```\n\n![img](https://pic4.zhimg.com/80/v2-fc61df44636a5f14346f24fae99f1b67_720w.jpg)\n\n## 三 文件的操作模式\n\n## 3.1 控制文件读写操作的模式\n\n```python\nr(默认的)：只读\nw：只写\na：只追加写\n```\n\n### 3.1.1 案例一：r 模式的使用\n\n```python\n# r只读模式: 在文件不存在时则报错,文件存在文件内指针直接跳到文件开头\n with open('a.txt',mode='r',encoding='utf-8') as f:\n     res=f.read() # 会将文件的内容由硬盘全部读入内存，赋值给res\n\n# 小练习：实现用户认证功能\n inp_name=input('请输入你的名字: ').strip()\n inp_pwd=input('请输入你的密码: ').strip()\n with open(r'db.txt',mode='r',encoding='utf-8') as f:\n     for line in f:\n         # 把用户输入的名字与密码与读出内容做比对\n         u,p=line.strip('\\n').split(':')\n         if inp_name == u and inp_pwd == p:\n             print('登录成功')\n             break\n     else:\n         print('账号名或者密码错误')\n```\n\n### 3.1.2 案例二：w 模式的使用\n\n```python\n# w只写模式: 在文件不存在时会创建空文档,文件存在会清空文件,文件指针跑到文件开头\nwith open('b.txt',mode='w',encoding='utf-8') as f:\n    f.write('你好\\n')\n    f.write('我好\\n') \n    f.write('大家好\\n')\n    f.write('111\\n222\\n333\\n')\n#强调：\n# 1 在文件不关闭的情况下,连续的写入，后写的内容一定跟在前写内容的后面\n# 2 如果重新以w模式打开文件，则会清空文件内容\n```\n\n### 3.1.3 案例三：a 模式的使用\n\n```python\n# a只追加写模式: 在文件不存在时会创建空文档,文件存在会将文件指针直接移动到文件末尾\n with open('c.txt',mode='a',encoding='utf-8') as f:\n     f.write('44444\\n')\n     f.write('55555\\n')\n#强调 w 模式与 a 模式的异同：\n# 1 相同点：在打开的文件不关闭的情况下，连续的写入，新写的内容总会跟在前写的内容之后\n# 2 不同点：以 a 模式重新打开文件，不会清空原文件内容，会将文件指针直接移动到文件末尾，新写的内容永远写在最后\n\n# 小练习：实现注册功能:\n name=input('username>>>: ').strip()\n pwd=input('password>>>: ').strip()\n with open('db1.txt',mode='a',encoding='utf-8') as f:\n     info='%s:%s\\n' %(name,pwd)\n     f.write(info)\n```\n\n### 3.1.4 案例四：+ 模式的使用(了解)\n\n```python\n# r+ w+ a+ :可读可写\n#在平时工作中，我们只单纯使用r/w/a，要么只读，要么只写，一般不用可读可写的模式\n```\n\n![img](https://pic4.zhimg.com/80/v2-bea42b94950b49f8be785289904e17b7_720w.jpg)\n\n## 3.2 控制文件读写内容的模式\n\n```python\n大前提: tb模式均不能单独使用,必须与r/w/a之一结合使用\nt（默认的）：文本模式\n    1. 读写文件都是以字符串为单位的\n    2. 只能针对文本文件\n    3. 必须指定encoding参数\nb：二进制模式:\n   1.读写文件都是以bytes/二进制为单位的\n   2. 可以针对所有文件\n   3. 一定不能指定encoding参数\n```\n\n### 3.2.1 案例一：t 模式的使用\n\n```python\n# t 模式：如果我们指定的文件打开模式为r/w/a，其实默认就是rt/wt/at\n with open('a.txt',mode='rt',encoding='utf-8') as f:\n     res=f.read() \n     print(type(res)) # 输出结果为：<class 'str'>\n\n with open('a.txt',mode='wt',encoding='utf-8') as f:\n     s='abc'\n     f.write(s) # 写入的也必须是字符串类型\n\n #强调：t 模式只能用于操作文本文件,无论读写，都应该以字符串为单位，而存取硬盘本质都是二进制的形式，当指定 t 模式时，内部帮我们做了编码与解码\n```\n\n### 3.2.2 案例二： b 模式的使用\n\n```python\n# b: 读写都是以二进制位单位\n with open('1.mp4',mode='rb') as f:\n     data=f.read()\n     print(type(data)) # 输出结果为：<class 'bytes'>\n\n with open('a.txt',mode='wb') as f:\n     msg=\"你好\"\n     res=msg.encode('utf-8') # res为bytes类型\n     f.write(res) # 在b模式下写入文件的只能是bytes类型\n\n#强调：b模式对比t模式\n1、在操作纯文本文件方面t模式帮我们省去了编码与解码的环节，b模式则需要手动编码与解码，所以此时t模式更为方便\n2、针对非文本文件（如图片、视频、音频等）只能使用b模式\n\n# 小练习： 编写拷贝工具\nsrc_file=input('源文件路径: ').strip()\ndst_file=input('目标文件路径: ').strip()\nwith open(r'%s' %src_file,mode='rb') as read_f,open(r'%s' %dst_file,mode='wb') as write_f:\n    for line in read_f:\n        # print(line)\n        write_f.write(line)\n```\n\n![img](https://pic3.zhimg.com/80/v2-4af94c11c6a45976fca8c53a0794c3a2_720w.jpg)\n\n## 四 操作文件的方法\n\n## 4.1 重点\n\n```python\n# 读操作\nf.read()  # 读取所有内容,执行完该操作后，文件指针会移动到文件末尾\nf.readline()  # 读取一行内容,光标移动到第二行首部\nf.readlines()  # 读取每一行内容,存放于列表中\n\n# 强调：\n# f.read()与f.readlines()都是将内容一次性读入内容，如果内容过大会导致内存溢出，若还想将内容全读入内存，则必须分多次读入，有两种实现方式：\n# 方式一\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n    for line in f:\n        print(line) # 同一时刻只读入一行内容到内存中\n\n# 方式二\nwith open('1.mp4',mode='rb') as f:\n    while True:\n        data=f.read(1024) # 同一时刻只读入1024个Bytes到内存中\n        if len(data) == 0:\n            break\n        print(data)\n\n# 写操作\nf.write('1111\\n222\\n')  # 针对文本模式的写,需要自己写换行符\nf.write('1111\\n222\\n'.encode('utf-8'))  # 针对b模式的写,需要自己写换行符\nf.writelines(['333\\n','444\\n'])  # 文件模式\nf.writelines([bytes('333\\n',encoding='utf-8'),'444\\n'.encode('utf-8')]) #b模式\n```\n\n![img](https://pic3.zhimg.com/80/v2-30d5763461db05414c3ac2cc944a8f6e_720w.jpg)\n\n## 4.2 了解\n\n```python\nf.readable()  # 文件是否可读\nf.writable()  # 文件是否可读\nf.closed  # 文件是否关闭\nf.encoding  # 如果文件打开模式为b,则没有该属性\nf.flush()  # 立刻将文件内容从内存刷到硬盘\nf.name\n```\n\n![img](https://pic1.zhimg.com/80/v2-3474d487b3fb518ce9b511c73153ce78_720w.jpg)\n\n## 五 主动控制文件内指针移动\n\n```python\n#大前提:文件内指针的移动都是Bytes为单位的,唯一例外的是t模式下的read(n),n以字符为单位\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n     data=f.read(3) # 读取3个字符\n\n\nwith open('a.txt',mode='rb') as f:\n     data=f.read(3) # 读取3个Bytes\n\n\n# 之前文件内指针的移动都是由读/写操作而被动触发的，若想读取文件某一特定位置的数据，则则需要用f.seek方法主动控制文件内指针的移动，详细用法如下：\n# f.seek(指针移动的字节数,模式控制): \n# 模式控制:\n# 0: 默认的模式,该模式代表指针移动的字节数是以文件开头为参照的\n# 1: 该模式代表指针移动的字节数是以当前所在的位置为参照的\n# 2: 该模式代表指针移动的字节数是以文件末尾的位置为参照的\n# 强调:其中0模式可以在t或者b模式使用,而1跟2模式只能在b模式下用\n```\n\n![img](https://pic3.zhimg.com/80/v2-2b5a0f6ecedec41601c52959b34d7f5a_720w.jpg)\n\n## 5.1 案例一： 0模式详解\n\n```python\n# a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）\nabc你好\n\n# 0模式的使用\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n    f.seek(3,0)     # 参照文件开头移动了3个字节\n    print(f.tell()) # 查看当前文件指针距离文件开头的位置，输出结果为3\n    print(f.read()) # 从第3个字节的位置读到文件末尾，输出结果为：你好\n    # 注意：由于在t模式下，会将读取的内容自动解码，所以必须保证读取的内容是一个完整中文数据，否则解码失败\n\nwith open('a.txt',mode='rb') as f:\n    f.seek(6,0)\n    print(f.read().decode('utf-8')) #输出结果为: 好\n```\n\n![img](https://pic4.zhimg.com/80/v2-9a9115785268e099152bbed9d0bc7e97_720w.jpg)\n\n## 5.2 案例二： 1模式详解\n\n```python\n# 1模式的使用\nwith open('a.txt',mode='rb') as f:\n    f.seek(3,1) # 从当前位置往后移动3个字节，而此时的当前位置就是文件开头\n    print(f.tell()) # 输出结果为：3\n    f.seek(4,1)     # 从当前位置往后移动4个字节，而此时的当前位置为3\n    print(f.tell()) # 输出结果为：7\n```\n\n![img](https://pic1.zhimg.com/80/v2-2122d50b6c97ed1c5fe27a13126266d0_720w.jpg)\n\n## 5.3 案例三： 2模式详解\n\n```python\n# a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）\nabc你好\n\n# 2模式的使用\nwith open('a.txt',mode='rb') as f:\n    f.seek(0,2)     # 参照文件末尾移动0个字节， 即直接跳到文件末尾\n    print(f.tell()) # 输出结果为：9\n    f.seek(-3,2)     # 参照文件末尾往前移动了3个字节\n    print(f.read().decode('utf-8')) # 输出结果为：好\n\n# 小练习：实现动态查看最新一条日志的效果\nimport time\nwith open('access.log',mode='rb') as f:\n    f.seek(0,2)\n    while True:\n        line=f.readline()\n        if len(line) == 0:\n            # 没有内容\n            time.sleep(0.5)\n        else:\n            print(line.decode('utf-8'),end='')\n```\n\n![img](https://pic1.zhimg.com/80/v2-009f54e4493921a84480b80a4fa5aa90_720w.jpg)\n\n## 六 文件的修改\n\n```python\n# 文件a.txt内容如下\n张一蛋     山东    179    49    12344234523\n李二蛋     河北    163    57    13913453521\n王全蛋     山西    153    62    18651433422\n\n# 执行操作\nwith open('a.txt',mode='r+t',encoding='utf-8') as f:\n    f.seek(9)\n    f.write('<妇女主任>')\n\n# 文件修改后的内容如下\n张一蛋<妇女主任> 179    49    12344234523\n李二蛋     河北    163    57    13913453521\n王全蛋     山西    153    62    18651433422\n\n# 强调：\n# 1、硬盘空间是无法修改的,硬盘中数据的更新都是用新内容覆盖旧内容\n# 2、内存中的数据是可以修改的\n```\n\n![img](https://pic1.zhimg.com/80/v2-138c4c7000b5db3a37d691ea0aa09fb0_720w.jpg)\n\n文件对应的是硬盘空间,硬盘不能修改对应着文件本质也不能修改, 那我们看到文件的内容可以修改,是如何实现的呢? 大致的思路是将硬盘中文件内容读入内存,然后在内存中修改完毕后再覆盖回硬盘 具体的实现方式分为两种:\n\n## 6.1 文件修改方式一\n\n```python\n# 实现思路：将文件内容发一次性全部读入内存,然后在内存中修改完毕后再覆盖写回原文件\n# 优点: 在文件修改过程中同一份数据只有一份\n# 缺点: 会过多地占用内存\nwith open('db.txt',mode='rt',encoding='utf-8') as f:\n    data=f.read()\n\nwith open('db.txt',mode='wt',encoding='utf-8') as f:\n    f.write(data.replace('kevin','SB'))\n```\n\n## 6.1 文件修改方式二\n\n```python\n# 实现思路：以读的方式打开原文件,以写的方式打开一个临时文件,一行行读取原文件内容,修改完后写入临时文件...,删掉原文件,将临时文件重命名原文件名\n# 优点: 不会占用过多的内存\n# 缺点: 在文件修改过程中同一份数据存了两份\nimport os\n\nwith open('db.txt',mode='rt',encoding='utf-8') as read_f,\\\n        open('.db.txt.swap',mode='wt',encoding='utf-8') as wrife_f:\n    for line in read_f:\n        wrife_f.write(line.replace('SB','kevin'))\n\nos.remove('db.txt')\nos.rename('.db.txt.swap','db.txt')\n```\n\n![img](https://pic4.zhimg.com/80/v2-d45f4a423f5dd6e9880e4dbcdb1bdaf7_720w.jpg)\n\n## 视频链接：\n\n文件处理\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=31![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D31)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=32![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D32)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=33![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D33)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=34![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D34)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=35![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D35)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=36![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D36)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=37![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D37)","source":"_posts/03_Python/01_Python基础/10_文件处理.md","raw":"## 一 引入\n\n 应用程序运行过程中产生的数据最先都是存放于内存中的，若想永久保存下来，必须要保存于硬盘中。应用程序若想操作硬件必须通过操作系统，而文件就是操作系统提供给应用程序来操作硬盘的虚拟概念，用户或应用程序对文件的操作，就是向操作系统发起调用，然后由操作系统完成对硬盘的具体操作。\n\n![img](https://pic2.zhimg.com/80/v2-e1c5ac2494f15c2d7a1ee4732fbb9289_720w.jpg)\n\n## 二 文件操作的基本流程\n\n## 2.1 基本流程\n\n![img](https://pic3.zhimg.com/80/v2-5f2bdccc6b9d407c733fe1c4315a050a_720w.jpg)\n\n有了文件的概念，我们无需再去考虑操作硬盘的细节，只需要关注操作文件的流程：\n\n```python\n# 1. 打开文件，由应用程序向操作系统发起系统调用open(...)，操作系统打开该文件，对应一块硬盘空间，并返回一个文件对象赋值给一个变量f\nf=open('a.txt','r',encoding='utf-8') #默认打开模式就为r\n\n# 2. 调用文件对象下的读/写方法，会被操作系统转换为读/写硬盘的操作\ndata=f.read()\n\n# 3. 向操作系统发起关闭文件的请求，回收系统资源\nf.close()\n```\n\n![img](https://pic2.zhimg.com/80/v2-df5334d72003b1b12e88bdf983af6b5d_720w.jpg)\n\n## 2.2 资源回收与with上下文管理\n\n打开一个文件包含两部分资源：应用程序的变量f和操作系统打开的文件。在操作完毕一个文件时，必须把与该文件的这两部分资源全部回收，回收方法为：\n\n```python\n1、f.close() #回收操作系统打开的文件资源\n2、del f #回收应用程序级的变量\n```\n\n其中del f一定要发生在f.close()之后，否则就会导致操作系统打开的文件无法关闭，白白占用资源， 而python自动的垃圾回收机制决定了我们无需考虑del f，这就要求我们，在操作完毕文件后，一定要记住f.close()，虽然我们如此强调，但是大多数读者还是会不由自主地忘记f.close()，考虑到这一点，python提供了with关键字来帮我们管理上下文\n\n```python\n# 1、在执行完子代码块后，with 会自动执行f.close()\nwith open('a.txt','w') as f:\n    pass \n\n# 2、可用用with同时打开多个文件，用逗号分隔开即可\nwith open('a.txt','r') as read_f,open('b.txt','w') as write_f:  \n    data = read_f.read()\n    write_f.write(data)\n```\n\n![img](https://pic2.zhimg.com/80/v2-d5d2e9ba1e1584d711be9141313c9a55_720w.jpg)\n\n## 2.3 指定操作文本文件的字符编码\n\n```python\nf = open(...)是由操作系统打开文件，如果打开的是文本文件，会涉及到字符编码问题，如果没有为open指定编码，那么打开文本文件的默认编码很明显是操作系统说了算了，操作系统会用自己的默认编码去打开文件，在windows下是gbk，在linux下是utf-8。\n这就用到了上节课讲的字符编码的知识：若要保证不乱码，文件以什么方式存的，就要以什么方式打开。\n\nf = open('a.txt','r',encoding='utf-8')\n```\n\n![img](https://pic4.zhimg.com/80/v2-fc61df44636a5f14346f24fae99f1b67_720w.jpg)\n\n## 三 文件的操作模式\n\n## 3.1 控制文件读写操作的模式\n\n```python\nr(默认的)：只读\nw：只写\na：只追加写\n```\n\n### 3.1.1 案例一：r 模式的使用\n\n```python\n# r只读模式: 在文件不存在时则报错,文件存在文件内指针直接跳到文件开头\n with open('a.txt',mode='r',encoding='utf-8') as f:\n     res=f.read() # 会将文件的内容由硬盘全部读入内存，赋值给res\n\n# 小练习：实现用户认证功能\n inp_name=input('请输入你的名字: ').strip()\n inp_pwd=input('请输入你的密码: ').strip()\n with open(r'db.txt',mode='r',encoding='utf-8') as f:\n     for line in f:\n         # 把用户输入的名字与密码与读出内容做比对\n         u,p=line.strip('\\n').split(':')\n         if inp_name == u and inp_pwd == p:\n             print('登录成功')\n             break\n     else:\n         print('账号名或者密码错误')\n```\n\n### 3.1.2 案例二：w 模式的使用\n\n```python\n# w只写模式: 在文件不存在时会创建空文档,文件存在会清空文件,文件指针跑到文件开头\nwith open('b.txt',mode='w',encoding='utf-8') as f:\n    f.write('你好\\n')\n    f.write('我好\\n') \n    f.write('大家好\\n')\n    f.write('111\\n222\\n333\\n')\n#强调：\n# 1 在文件不关闭的情况下,连续的写入，后写的内容一定跟在前写内容的后面\n# 2 如果重新以w模式打开文件，则会清空文件内容\n```\n\n### 3.1.3 案例三：a 模式的使用\n\n```python\n# a只追加写模式: 在文件不存在时会创建空文档,文件存在会将文件指针直接移动到文件末尾\n with open('c.txt',mode='a',encoding='utf-8') as f:\n     f.write('44444\\n')\n     f.write('55555\\n')\n#强调 w 模式与 a 模式的异同：\n# 1 相同点：在打开的文件不关闭的情况下，连续的写入，新写的内容总会跟在前写的内容之后\n# 2 不同点：以 a 模式重新打开文件，不会清空原文件内容，会将文件指针直接移动到文件末尾，新写的内容永远写在最后\n\n# 小练习：实现注册功能:\n name=input('username>>>: ').strip()\n pwd=input('password>>>: ').strip()\n with open('db1.txt',mode='a',encoding='utf-8') as f:\n     info='%s:%s\\n' %(name,pwd)\n     f.write(info)\n```\n\n### 3.1.4 案例四：+ 模式的使用(了解)\n\n```python\n# r+ w+ a+ :可读可写\n#在平时工作中，我们只单纯使用r/w/a，要么只读，要么只写，一般不用可读可写的模式\n```\n\n![img](https://pic4.zhimg.com/80/v2-bea42b94950b49f8be785289904e17b7_720w.jpg)\n\n## 3.2 控制文件读写内容的模式\n\n```python\n大前提: tb模式均不能单独使用,必须与r/w/a之一结合使用\nt（默认的）：文本模式\n    1. 读写文件都是以字符串为单位的\n    2. 只能针对文本文件\n    3. 必须指定encoding参数\nb：二进制模式:\n   1.读写文件都是以bytes/二进制为单位的\n   2. 可以针对所有文件\n   3. 一定不能指定encoding参数\n```\n\n### 3.2.1 案例一：t 模式的使用\n\n```python\n# t 模式：如果我们指定的文件打开模式为r/w/a，其实默认就是rt/wt/at\n with open('a.txt',mode='rt',encoding='utf-8') as f:\n     res=f.read() \n     print(type(res)) # 输出结果为：<class 'str'>\n\n with open('a.txt',mode='wt',encoding='utf-8') as f:\n     s='abc'\n     f.write(s) # 写入的也必须是字符串类型\n\n #强调：t 模式只能用于操作文本文件,无论读写，都应该以字符串为单位，而存取硬盘本质都是二进制的形式，当指定 t 模式时，内部帮我们做了编码与解码\n```\n\n### 3.2.2 案例二： b 模式的使用\n\n```python\n# b: 读写都是以二进制位单位\n with open('1.mp4',mode='rb') as f:\n     data=f.read()\n     print(type(data)) # 输出结果为：<class 'bytes'>\n\n with open('a.txt',mode='wb') as f:\n     msg=\"你好\"\n     res=msg.encode('utf-8') # res为bytes类型\n     f.write(res) # 在b模式下写入文件的只能是bytes类型\n\n#强调：b模式对比t模式\n1、在操作纯文本文件方面t模式帮我们省去了编码与解码的环节，b模式则需要手动编码与解码，所以此时t模式更为方便\n2、针对非文本文件（如图片、视频、音频等）只能使用b模式\n\n# 小练习： 编写拷贝工具\nsrc_file=input('源文件路径: ').strip()\ndst_file=input('目标文件路径: ').strip()\nwith open(r'%s' %src_file,mode='rb') as read_f,open(r'%s' %dst_file,mode='wb') as write_f:\n    for line in read_f:\n        # print(line)\n        write_f.write(line)\n```\n\n![img](https://pic3.zhimg.com/80/v2-4af94c11c6a45976fca8c53a0794c3a2_720w.jpg)\n\n## 四 操作文件的方法\n\n## 4.1 重点\n\n```python\n# 读操作\nf.read()  # 读取所有内容,执行完该操作后，文件指针会移动到文件末尾\nf.readline()  # 读取一行内容,光标移动到第二行首部\nf.readlines()  # 读取每一行内容,存放于列表中\n\n# 强调：\n# f.read()与f.readlines()都是将内容一次性读入内容，如果内容过大会导致内存溢出，若还想将内容全读入内存，则必须分多次读入，有两种实现方式：\n# 方式一\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n    for line in f:\n        print(line) # 同一时刻只读入一行内容到内存中\n\n# 方式二\nwith open('1.mp4',mode='rb') as f:\n    while True:\n        data=f.read(1024) # 同一时刻只读入1024个Bytes到内存中\n        if len(data) == 0:\n            break\n        print(data)\n\n# 写操作\nf.write('1111\\n222\\n')  # 针对文本模式的写,需要自己写换行符\nf.write('1111\\n222\\n'.encode('utf-8'))  # 针对b模式的写,需要自己写换行符\nf.writelines(['333\\n','444\\n'])  # 文件模式\nf.writelines([bytes('333\\n',encoding='utf-8'),'444\\n'.encode('utf-8')]) #b模式\n```\n\n![img](https://pic3.zhimg.com/80/v2-30d5763461db05414c3ac2cc944a8f6e_720w.jpg)\n\n## 4.2 了解\n\n```python\nf.readable()  # 文件是否可读\nf.writable()  # 文件是否可读\nf.closed  # 文件是否关闭\nf.encoding  # 如果文件打开模式为b,则没有该属性\nf.flush()  # 立刻将文件内容从内存刷到硬盘\nf.name\n```\n\n![img](https://pic1.zhimg.com/80/v2-3474d487b3fb518ce9b511c73153ce78_720w.jpg)\n\n## 五 主动控制文件内指针移动\n\n```python\n#大前提:文件内指针的移动都是Bytes为单位的,唯一例外的是t模式下的read(n),n以字符为单位\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n     data=f.read(3) # 读取3个字符\n\n\nwith open('a.txt',mode='rb') as f:\n     data=f.read(3) # 读取3个Bytes\n\n\n# 之前文件内指针的移动都是由读/写操作而被动触发的，若想读取文件某一特定位置的数据，则则需要用f.seek方法主动控制文件内指针的移动，详细用法如下：\n# f.seek(指针移动的字节数,模式控制): \n# 模式控制:\n# 0: 默认的模式,该模式代表指针移动的字节数是以文件开头为参照的\n# 1: 该模式代表指针移动的字节数是以当前所在的位置为参照的\n# 2: 该模式代表指针移动的字节数是以文件末尾的位置为参照的\n# 强调:其中0模式可以在t或者b模式使用,而1跟2模式只能在b模式下用\n```\n\n![img](https://pic3.zhimg.com/80/v2-2b5a0f6ecedec41601c52959b34d7f5a_720w.jpg)\n\n## 5.1 案例一： 0模式详解\n\n```python\n# a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）\nabc你好\n\n# 0模式的使用\nwith open('a.txt',mode='rt',encoding='utf-8') as f:\n    f.seek(3,0)     # 参照文件开头移动了3个字节\n    print(f.tell()) # 查看当前文件指针距离文件开头的位置，输出结果为3\n    print(f.read()) # 从第3个字节的位置读到文件末尾，输出结果为：你好\n    # 注意：由于在t模式下，会将读取的内容自动解码，所以必须保证读取的内容是一个完整中文数据，否则解码失败\n\nwith open('a.txt',mode='rb') as f:\n    f.seek(6,0)\n    print(f.read().decode('utf-8')) #输出结果为: 好\n```\n\n![img](https://pic4.zhimg.com/80/v2-9a9115785268e099152bbed9d0bc7e97_720w.jpg)\n\n## 5.2 案例二： 1模式详解\n\n```python\n# 1模式的使用\nwith open('a.txt',mode='rb') as f:\n    f.seek(3,1) # 从当前位置往后移动3个字节，而此时的当前位置就是文件开头\n    print(f.tell()) # 输出结果为：3\n    f.seek(4,1)     # 从当前位置往后移动4个字节，而此时的当前位置为3\n    print(f.tell()) # 输出结果为：7\n```\n\n![img](https://pic1.zhimg.com/80/v2-2122d50b6c97ed1c5fe27a13126266d0_720w.jpg)\n\n## 5.3 案例三： 2模式详解\n\n```python\n# a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）\nabc你好\n\n# 2模式的使用\nwith open('a.txt',mode='rb') as f:\n    f.seek(0,2)     # 参照文件末尾移动0个字节， 即直接跳到文件末尾\n    print(f.tell()) # 输出结果为：9\n    f.seek(-3,2)     # 参照文件末尾往前移动了3个字节\n    print(f.read().decode('utf-8')) # 输出结果为：好\n\n# 小练习：实现动态查看最新一条日志的效果\nimport time\nwith open('access.log',mode='rb') as f:\n    f.seek(0,2)\n    while True:\n        line=f.readline()\n        if len(line) == 0:\n            # 没有内容\n            time.sleep(0.5)\n        else:\n            print(line.decode('utf-8'),end='')\n```\n\n![img](https://pic1.zhimg.com/80/v2-009f54e4493921a84480b80a4fa5aa90_720w.jpg)\n\n## 六 文件的修改\n\n```python\n# 文件a.txt内容如下\n张一蛋     山东    179    49    12344234523\n李二蛋     河北    163    57    13913453521\n王全蛋     山西    153    62    18651433422\n\n# 执行操作\nwith open('a.txt',mode='r+t',encoding='utf-8') as f:\n    f.seek(9)\n    f.write('<妇女主任>')\n\n# 文件修改后的内容如下\n张一蛋<妇女主任> 179    49    12344234523\n李二蛋     河北    163    57    13913453521\n王全蛋     山西    153    62    18651433422\n\n# 强调：\n# 1、硬盘空间是无法修改的,硬盘中数据的更新都是用新内容覆盖旧内容\n# 2、内存中的数据是可以修改的\n```\n\n![img](https://pic1.zhimg.com/80/v2-138c4c7000b5db3a37d691ea0aa09fb0_720w.jpg)\n\n文件对应的是硬盘空间,硬盘不能修改对应着文件本质也不能修改, 那我们看到文件的内容可以修改,是如何实现的呢? 大致的思路是将硬盘中文件内容读入内存,然后在内存中修改完毕后再覆盖回硬盘 具体的实现方式分为两种:\n\n## 6.1 文件修改方式一\n\n```python\n# 实现思路：将文件内容发一次性全部读入内存,然后在内存中修改完毕后再覆盖写回原文件\n# 优点: 在文件修改过程中同一份数据只有一份\n# 缺点: 会过多地占用内存\nwith open('db.txt',mode='rt',encoding='utf-8') as f:\n    data=f.read()\n\nwith open('db.txt',mode='wt',encoding='utf-8') as f:\n    f.write(data.replace('kevin','SB'))\n```\n\n## 6.1 文件修改方式二\n\n```python\n# 实现思路：以读的方式打开原文件,以写的方式打开一个临时文件,一行行读取原文件内容,修改完后写入临时文件...,删掉原文件,将临时文件重命名原文件名\n# 优点: 不会占用过多的内存\n# 缺点: 在文件修改过程中同一份数据存了两份\nimport os\n\nwith open('db.txt',mode='rt',encoding='utf-8') as read_f,\\\n        open('.db.txt.swap',mode='wt',encoding='utf-8') as wrife_f:\n    for line in read_f:\n        wrife_f.write(line.replace('SB','kevin'))\n\nos.remove('db.txt')\nos.rename('.db.txt.swap','db.txt')\n```\n\n![img](https://pic4.zhimg.com/80/v2-d45f4a423f5dd6e9880e4dbcdb1bdaf7_720w.jpg)\n\n## 视频链接：\n\n文件处理\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=31![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D31)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=32![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D32)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=33![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D33)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=34![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D34)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=35![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D35)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=36![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D36)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=37![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D37)","slug":"03_Python/01_Python基础/10_文件处理","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k150025a8v7gh61cjaq","content":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 应用程序运行过程中产生的数据最先都是存放于内存中的，若想永久保存下来，必须要保存于硬盘中。应用程序若想操作硬件必须通过操作系统，而文件就是操作系统提供给应用程序来操作硬盘的虚拟概念，用户或应用程序对文件的操作，就是向操作系统发起调用，然后由操作系统完成对硬盘的具体操作。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-e1c5ac2494f15c2d7a1ee4732fbb9289_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-文件操作的基本流程\"><a href=\"#二-文件操作的基本流程\" class=\"headerlink\" title=\"二 文件操作的基本流程\"></a>二 文件操作的基本流程</h2><h2 id=\"2-1-基本流程\"><a href=\"#2-1-基本流程\" class=\"headerlink\" title=\"2.1 基本流程\"></a>2.1 基本流程</h2><p><img src=\"https://pic3.zhimg.com/80/v2-5f2bdccc6b9d407c733fe1c4315a050a_720w.jpg\" alt=\"img\"></p>\n<p>有了文件的概念，我们无需再去考虑操作硬盘的细节，只需要关注操作文件的流程：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1. 打开文件，由应用程序向操作系统发起系统调用open(...)，操作系统打开该文件，对应一块硬盘空间，并返回一个文件对象赋值给一个变量f</span>\nf<span class=\"token operator\">=</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#默认打开模式就为r</span>\n\n<span class=\"token comment\"># 2. 调用文件对象下的读/写方法，会被操作系统转换为读/写硬盘的操作</span>\ndata<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 3. 向操作系统发起关闭文件的请求，回收系统资源</span>\nf<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-df5334d72003b1b12e88bdf983af6b5d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-资源回收与with上下文管理\"><a href=\"#2-2-资源回收与with上下文管理\" class=\"headerlink\" title=\"2.2 资源回收与with上下文管理\"></a>2.2 资源回收与with上下文管理</h2><p>打开一个文件包含两部分资源：应用程序的变量f和操作系统打开的文件。在操作完毕一个文件时，必须把与该文件的这两部分资源全部回收，回收方法为：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token number\">1</span>、f<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#回收操作系统打开的文件资源</span>\n<span class=\"token number\">2</span>、<span class=\"token keyword\">del</span> f <span class=\"token comment\">#回收应用程序级的变量</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>其中del f一定要发生在f.close()之后，否则就会导致操作系统打开的文件无法关闭，白白占用资源， 而python自动的垃圾回收机制决定了我们无需考虑del f，这就要求我们，在操作完毕文件后，一定要记住f.close()，虽然我们如此强调，但是大多数读者还是会不由自主地忘记f.close()，考虑到这一点，python提供了with关键字来帮我们管理上下文</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、在执行完子代码块后，with 会自动执行f.close()</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span> \n\n<span class=\"token comment\"># 2、可用用with同时打开多个文件，用逗号分隔开即可</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> write_f<span class=\"token punctuation\">:</span>  \n    data <span class=\"token operator\">=</span> read_f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    write_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-d5d2e9ba1e1584d711be9141313c9a55_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-3-指定操作文本文件的字符编码\"><a href=\"#2-3-指定操作文本文件的字符编码\" class=\"headerlink\" title=\"2.3 指定操作文本文件的字符编码\"></a>2.3 指定操作文本文件的字符编码</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">f <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>是由操作系统打开文件，如果打开的是文本文件，会涉及到字符编码问题，如果没有为<span class=\"token builtin\">open</span>指定编码，那么打开文本文件的默认编码很明显是操作系统说了算了，操作系统会用自己的默认编码去打开文件，在windows下是gbk，在linux下是utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>。\n这就用到了上节课讲的字符编码的知识：若要保证不乱码，文件以什么方式存的，就要以什么方式打开。\n\nf <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-fc61df44636a5f14346f24fae99f1b67_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-文件的操作模式\"><a href=\"#三-文件的操作模式\" class=\"headerlink\" title=\"三 文件的操作模式\"></a>三 文件的操作模式</h2><h2 id=\"3-1-控制文件读写操作的模式\"><a href=\"#3-1-控制文件读写操作的模式\" class=\"headerlink\" title=\"3.1 控制文件读写操作的模式\"></a>3.1 控制文件读写操作的模式</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">r<span class=\"token punctuation\">(</span>默认的<span class=\"token punctuation\">)</span>：只读\nw：只写\na：只追加写<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-1-案例一：r-模式的使用\"><a href=\"#3-1-1-案例一：r-模式的使用\" class=\"headerlink\" title=\"3.1.1 案例一：r 模式的使用\"></a>3.1.1 案例一：r 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># r只读模式: 在文件不存在时则报错,文件存在文件内指针直接跳到文件开头</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     res<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 会将文件的内容由硬盘全部读入内存，赋值给res</span>\n\n<span class=\"token comment\"># 小练习：实现用户认证功能</span>\n inp_name<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请输入你的名字: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n inp_pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请输入你的密码: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">:</span>\n         <span class=\"token comment\"># 把用户输入的名字与密码与读出内容做比对</span>\n         u<span class=\"token punctuation\">,</span>p<span class=\"token operator\">=</span>line<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">)</span>\n         <span class=\"token keyword\">if</span> inp_name <span class=\"token operator\">==</span> u <span class=\"token keyword\">and</span> inp_pwd <span class=\"token operator\">==</span> p<span class=\"token punctuation\">:</span>\n             <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'登录成功'</span><span class=\"token punctuation\">)</span>\n             <span class=\"token keyword\">break</span>\n     <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'账号名或者密码错误'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-2-案例二：w-模式的使用\"><a href=\"#3-1-2-案例二：w-模式的使用\" class=\"headerlink\" title=\"3.1.2 案例二：w 模式的使用\"></a>3.1.2 案例二：w 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># w只写模式: 在文件不存在时会创建空文档,文件存在会清空文件,文件指针跑到文件开头</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'你好\\n'</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'我好\\n'</span><span class=\"token punctuation\">)</span> \n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'大家好\\n'</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'111\\n222\\n333\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#强调：</span>\n<span class=\"token comment\"># 1 在文件不关闭的情况下,连续的写入，后写的内容一定跟在前写内容的后面</span>\n<span class=\"token comment\"># 2 如果重新以w模式打开文件，则会清空文件内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-3-案例三：a-模式的使用\"><a href=\"#3-1-3-案例三：a-模式的使用\" class=\"headerlink\" title=\"3.1.3 案例三：a 模式的使用\"></a>3.1.3 案例三：a 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a只追加写模式: 在文件不存在时会创建空文档,文件存在会将文件指针直接移动到文件末尾</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'c.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'44444\\n'</span><span class=\"token punctuation\">)</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'55555\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#强调 w 模式与 a 模式的异同：</span>\n<span class=\"token comment\"># 1 相同点：在打开的文件不关闭的情况下，连续的写入，新写的内容总会跟在前写的内容之后</span>\n<span class=\"token comment\"># 2 不同点：以 a 模式重新打开文件，不会清空原文件内容，会将文件指针直接移动到文件末尾，新写的内容永远写在最后</span>\n\n<span class=\"token comment\"># 小练习：实现注册功能:</span>\n name<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'username>>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'password>>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db1.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     info<span class=\"token operator\">=</span><span class=\"token string\">'%s:%s\\n'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>pwd<span class=\"token punctuation\">)</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-4-案例四：-模式的使用-了解\"><a href=\"#3-1-4-案例四：-模式的使用-了解\" class=\"headerlink\" title=\"3.1.4 案例四：+ 模式的使用(了解)\"></a>3.1.4 案例四：+ 模式的使用(了解)</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># r+ w+ a+ :可读可写</span>\n<span class=\"token comment\">#在平时工作中，我们只单纯使用r/w/a，要么只读，要么只写，一般不用可读可写的模式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-bea42b94950b49f8be785289904e17b7_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-控制文件读写内容的模式\"><a href=\"#3-2-控制文件读写内容的模式\" class=\"headerlink\" title=\"3.2 控制文件读写内容的模式\"></a>3.2 控制文件读写内容的模式</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">大前提<span class=\"token punctuation\">:</span> tb模式均不能单独使用<span class=\"token punctuation\">,</span>必须与r<span class=\"token operator\">/</span>w<span class=\"token operator\">/</span>a之一结合使用\nt（默认的）：文本模式\n    <span class=\"token number\">1.</span> 读写文件都是以字符串为单位的\n    <span class=\"token number\">2.</span> 只能针对文本文件\n    <span class=\"token number\">3.</span> 必须指定encoding参数\nb：二进制模式<span class=\"token punctuation\">:</span>\n   <span class=\"token number\">1.</span>读写文件都是以<span class=\"token builtin\">bytes</span><span class=\"token operator\">/</span>二进制为单位的\n   <span class=\"token number\">2.</span> 可以针对所有文件\n   <span class=\"token number\">3.</span> 一定不能指定encoding参数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-1-案例一：t-模式的使用\"><a href=\"#3-2-1-案例一：t-模式的使用\" class=\"headerlink\" title=\"3.2.1 案例一：t 模式的使用\"></a>3.2.1 案例一：t 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># t 模式：如果我们指定的文件打开模式为r/w/a，其实默认就是rt/wt/at</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     res<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：&lt;class 'str'></span>\n\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     s<span class=\"token operator\">=</span><span class=\"token string\">'abc'</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 写入的也必须是字符串类型</span>\n\n <span class=\"token comment\">#强调：t 模式只能用于操作文本文件,无论读写，都应该以字符串为单位，而存取硬盘本质都是二进制的形式，当指定 t 模式时，内部帮我们做了编码与解码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-2-案例二：-b-模式的使用\"><a href=\"#3-2-2-案例二：-b-模式的使用\" class=\"headerlink\" title=\"3.2.2 案例二： b 模式的使用\"></a>3.2.2 案例二： b 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># b: 读写都是以二进制位单位</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1.mp4'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：&lt;class 'bytes'></span>\n\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     msg<span class=\"token operator\">=</span><span class=\"token string\">\"你好\"</span>\n     res<span class=\"token operator\">=</span>msg<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># res为bytes类型</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 在b模式下写入文件的只能是bytes类型</span>\n\n<span class=\"token comment\">#强调：b模式对比t模式</span>\n<span class=\"token number\">1</span>、在操作纯文本文件方面t模式帮我们省去了编码与解码的环节，b模式则需要手动编码与解码，所以此时t模式更为方便\n<span class=\"token number\">2</span>、针对非文本文件（如图片、视频、音频等）只能使用b模式\n\n<span class=\"token comment\"># 小练习： 编写拷贝工具</span>\nsrc_file<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'源文件路径: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ndst_file<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'目标文件路径: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'%s'</span> <span class=\"token operator\">%</span>src_file<span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'%s'</span> <span class=\"token operator\">%</span>dst_file<span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> write_f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> read_f<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># print(line)</span>\n        write_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-4af94c11c6a45976fca8c53a0794c3a2_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-操作文件的方法\"><a href=\"#四-操作文件的方法\" class=\"headerlink\" title=\"四 操作文件的方法\"></a>四 操作文件的方法</h2><h2 id=\"4-1-重点\"><a href=\"#4-1-重点\" class=\"headerlink\" title=\"4.1 重点\"></a>4.1 重点</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 读操作</span>\nf<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取所有内容,执行完该操作后，文件指针会移动到文件末尾</span>\nf<span class=\"token punctuation\">.</span>readline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取一行内容,光标移动到第二行首部</span>\nf<span class=\"token punctuation\">.</span>readlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取每一行内容,存放于列表中</span>\n\n<span class=\"token comment\"># 强调：</span>\n<span class=\"token comment\"># f.read()与f.readlines()都是将内容一次性读入内容，如果内容过大会导致内存溢出，若还想将内容全读入内存，则必须分多次读入，有两种实现方式：</span>\n<span class=\"token comment\"># 方式一</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 同一时刻只读入一行内容到内存中</span>\n\n<span class=\"token comment\"># 方式二</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1.mp4'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 同一时刻只读入1024个Bytes到内存中</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">break</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 写操作</span>\nf<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'1111\\n222\\n'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 针对文本模式的写,需要自己写换行符</span>\nf<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'1111\\n222\\n'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 针对b模式的写,需要自己写换行符</span>\nf<span class=\"token punctuation\">.</span>writelines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'333\\n'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'444\\n'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件模式</span>\nf<span class=\"token punctuation\">.</span>writelines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'333\\n'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'444\\n'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#b模式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-30d5763461db05414c3ac2cc944a8f6e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-2-了解\"><a href=\"#4-2-了解\" class=\"headerlink\" title=\"4.2 了解\"></a>4.2 了解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">f<span class=\"token punctuation\">.</span>readable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件是否可读</span>\nf<span class=\"token punctuation\">.</span>writable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件是否可读</span>\nf<span class=\"token punctuation\">.</span>closed  <span class=\"token comment\"># 文件是否关闭</span>\nf<span class=\"token punctuation\">.</span>encoding  <span class=\"token comment\"># 如果文件打开模式为b,则没有该属性</span>\nf<span class=\"token punctuation\">.</span>flush<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 立刻将文件内容从内存刷到硬盘</span>\nf<span class=\"token punctuation\">.</span>name<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-3474d487b3fb518ce9b511c73153ce78_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"五-主动控制文件内指针移动\"><a href=\"#五-主动控制文件内指针移动\" class=\"headerlink\" title=\"五 主动控制文件内指针移动\"></a>五 主动控制文件内指针移动</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#大前提:文件内指针的移动都是Bytes为单位的,唯一例外的是t模式下的read(n),n以字符为单位</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 读取3个字符</span>\n\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 读取3个Bytes</span>\n\n\n<span class=\"token comment\"># 之前文件内指针的移动都是由读/写操作而被动触发的，若想读取文件某一特定位置的数据，则则需要用f.seek方法主动控制文件内指针的移动，详细用法如下：</span>\n<span class=\"token comment\"># f.seek(指针移动的字节数,模式控制): </span>\n<span class=\"token comment\"># 模式控制:</span>\n<span class=\"token comment\"># 0: 默认的模式,该模式代表指针移动的字节数是以文件开头为参照的</span>\n<span class=\"token comment\"># 1: 该模式代表指针移动的字节数是以当前所在的位置为参照的</span>\n<span class=\"token comment\"># 2: 该模式代表指针移动的字节数是以文件末尾的位置为参照的</span>\n<span class=\"token comment\"># 强调:其中0模式可以在t或者b模式使用,而1跟2模式只能在b模式下用</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-2b5a0f6ecedec41601c52959b34d7f5a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-1-案例一：-0模式详解\"><a href=\"#5-1-案例一：-0模式详解\" class=\"headerlink\" title=\"5.1 案例一： 0模式详解\"></a>5.1 案例一： 0模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）</span>\nabc你好\n\n<span class=\"token comment\"># 0模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件开头移动了3个字节</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 查看当前文件指针距离文件开头的位置，输出结果为3</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 从第3个字节的位置读到文件末尾，输出结果为：你好</span>\n    <span class=\"token comment\"># 注意：由于在t模式下，会将读取的内容自动解码，所以必须保证读取的内容是一个完整中文数据，否则解码失败</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#输出结果为: 好</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-9a9115785268e099152bbed9d0bc7e97_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-2-案例二：-1模式详解\"><a href=\"#5-2-案例二：-1模式详解\" class=\"headerlink\" title=\"5.2 案例二： 1模式详解\"></a>5.2 案例二： 1模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 从当前位置往后移动3个字节，而此时的当前位置就是文件开头</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：3</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 从当前位置往后移动4个字节，而此时的当前位置为3</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：7</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-2122d50b6c97ed1c5fe27a13126266d0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-3-案例三：-2模式详解\"><a href=\"#5-3-案例三：-2模式详解\" class=\"headerlink\" title=\"5.3 案例三： 2模式详解\"></a>5.3 案例三： 2模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）</span>\nabc你好\n\n<span class=\"token comment\"># 2模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件末尾移动0个字节， 即直接跳到文件末尾</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：9</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件末尾往前移动了3个字节</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：好</span>\n\n<span class=\"token comment\"># 小练习：实现动态查看最新一条日志的效果</span>\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'access.log'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        line<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>readline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># 没有内容</span>\n            time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-009f54e4493921a84480b80a4fa5aa90_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"六-文件的修改\"><a href=\"#六-文件的修改\" class=\"headerlink\" title=\"六 文件的修改\"></a>六 文件的修改</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 文件a.txt内容如下</span>\n张一蛋     山东    <span class=\"token number\">179</span>    <span class=\"token number\">49</span>    <span class=\"token number\">12344234523</span>\n李二蛋     河北    <span class=\"token number\">163</span>    <span class=\"token number\">57</span>    <span class=\"token number\">13913453521</span>\n王全蛋     山西    <span class=\"token number\">153</span>    <span class=\"token number\">62</span>    <span class=\"token number\">18651433422</span>\n\n<span class=\"token comment\"># 执行操作</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r+t'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;妇女主任>'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 文件修改后的内容如下</span>\n张一蛋<span class=\"token operator\">&lt;</span>妇女主任<span class=\"token operator\">></span> <span class=\"token number\">179</span>    <span class=\"token number\">49</span>    <span class=\"token number\">12344234523</span>\n李二蛋     河北    <span class=\"token number\">163</span>    <span class=\"token number\">57</span>    <span class=\"token number\">13913453521</span>\n王全蛋     山西    <span class=\"token number\">153</span>    <span class=\"token number\">62</span>    <span class=\"token number\">18651433422</span>\n\n<span class=\"token comment\"># 强调：</span>\n<span class=\"token comment\"># 1、硬盘空间是无法修改的,硬盘中数据的更新都是用新内容覆盖旧内容</span>\n<span class=\"token comment\"># 2、内存中的数据是可以修改的</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-138c4c7000b5db3a37d691ea0aa09fb0_720w.jpg\" alt=\"img\"></p>\n<p>文件对应的是硬盘空间,硬盘不能修改对应着文件本质也不能修改, 那我们看到文件的内容可以修改,是如何实现的呢? 大致的思路是将硬盘中文件内容读入内存,然后在内存中修改完毕后再覆盖回硬盘 具体的实现方式分为两种:</p>\n<h2 id=\"6-1-文件修改方式一\"><a href=\"#6-1-文件修改方式一\" class=\"headerlink\" title=\"6.1 文件修改方式一\"></a>6.1 文件修改方式一</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 实现思路：将文件内容发一次性全部读入内存,然后在内存中修改完毕后再覆盖写回原文件</span>\n<span class=\"token comment\"># 优点: 在文件修改过程中同一份数据只有一份</span>\n<span class=\"token comment\"># 缺点: 会过多地占用内存</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'kevin'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'SB'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-1-文件修改方式二\"><a href=\"#6-1-文件修改方式二\" class=\"headerlink\" title=\"6.1 文件修改方式二\"></a>6.1 文件修改方式二</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 实现思路：以读的方式打开原文件,以写的方式打开一个临时文件,一行行读取原文件内容,修改完后写入临时文件...,删掉原文件,将临时文件重命名原文件名</span>\n<span class=\"token comment\"># 优点: 不会占用过多的内存</span>\n<span class=\"token comment\"># 缺点: 在文件修改过程中同一份数据存了两份</span>\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span>\\\n        <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.db.txt.swap'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> wrife_f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> read_f<span class=\"token punctuation\">:</span>\n        wrife_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'SB'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'kevin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nos<span class=\"token punctuation\">.</span>remove<span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">)</span>\nos<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span><span class=\"token string\">'.db.txt.swap'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-d45f4a423f5dd6e9880e4dbcdb1bdaf7_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>文件处理</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=31\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=31<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=32\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=32<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=33\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=33<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=34\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=34<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=35\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=35<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=36\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=36<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=37\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=37<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-引入\"><a href=\"#一-引入\" class=\"headerlink\" title=\"一 引入\"></a>一 引入</h2><p> 应用程序运行过程中产生的数据最先都是存放于内存中的，若想永久保存下来，必须要保存于硬盘中。应用程序若想操作硬件必须通过操作系统，而文件就是操作系统提供给应用程序来操作硬盘的虚拟概念，用户或应用程序对文件的操作，就是向操作系统发起调用，然后由操作系统完成对硬盘的具体操作。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-e1c5ac2494f15c2d7a1ee4732fbb9289_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-文件操作的基本流程\"><a href=\"#二-文件操作的基本流程\" class=\"headerlink\" title=\"二 文件操作的基本流程\"></a>二 文件操作的基本流程</h2><h2 id=\"2-1-基本流程\"><a href=\"#2-1-基本流程\" class=\"headerlink\" title=\"2.1 基本流程\"></a>2.1 基本流程</h2><p><img src=\"https://pic3.zhimg.com/80/v2-5f2bdccc6b9d407c733fe1c4315a050a_720w.jpg\" alt=\"img\"></p>\n<p>有了文件的概念，我们无需再去考虑操作硬盘的细节，只需要关注操作文件的流程：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1. 打开文件，由应用程序向操作系统发起系统调用open(...)，操作系统打开该文件，对应一块硬盘空间，并返回一个文件对象赋值给一个变量f</span>\nf<span class=\"token operator\">=</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#默认打开模式就为r</span>\n\n<span class=\"token comment\"># 2. 调用文件对象下的读/写方法，会被操作系统转换为读/写硬盘的操作</span>\ndata<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 3. 向操作系统发起关闭文件的请求，回收系统资源</span>\nf<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-df5334d72003b1b12e88bdf983af6b5d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-资源回收与with上下文管理\"><a href=\"#2-2-资源回收与with上下文管理\" class=\"headerlink\" title=\"2.2 资源回收与with上下文管理\"></a>2.2 资源回收与with上下文管理</h2><p>打开一个文件包含两部分资源：应用程序的变量f和操作系统打开的文件。在操作完毕一个文件时，必须把与该文件的这两部分资源全部回收，回收方法为：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token number\">1</span>、f<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#回收操作系统打开的文件资源</span>\n<span class=\"token number\">2</span>、<span class=\"token keyword\">del</span> f <span class=\"token comment\">#回收应用程序级的变量</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>其中del f一定要发生在f.close()之后，否则就会导致操作系统打开的文件无法关闭，白白占用资源， 而python自动的垃圾回收机制决定了我们无需考虑del f，这就要求我们，在操作完毕文件后，一定要记住f.close()，虽然我们如此强调，但是大多数读者还是会不由自主地忘记f.close()，考虑到这一点，python提供了with关键字来帮我们管理上下文</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1、在执行完子代码块后，with 会自动执行f.close()</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span> \n\n<span class=\"token comment\"># 2、可用用with同时打开多个文件，用逗号分隔开即可</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> write_f<span class=\"token punctuation\">:</span>  \n    data <span class=\"token operator\">=</span> read_f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    write_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-d5d2e9ba1e1584d711be9141313c9a55_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-3-指定操作文本文件的字符编码\"><a href=\"#2-3-指定操作文本文件的字符编码\" class=\"headerlink\" title=\"2.3 指定操作文本文件的字符编码\"></a>2.3 指定操作文本文件的字符编码</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">f <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>是由操作系统打开文件，如果打开的是文本文件，会涉及到字符编码问题，如果没有为<span class=\"token builtin\">open</span>指定编码，那么打开文本文件的默认编码很明显是操作系统说了算了，操作系统会用自己的默认编码去打开文件，在windows下是gbk，在linux下是utf<span class=\"token operator\">-</span><span class=\"token number\">8</span>。\n这就用到了上节课讲的字符编码的知识：若要保证不乱码，文件以什么方式存的，就要以什么方式打开。\n\nf <span class=\"token operator\">=</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-fc61df44636a5f14346f24fae99f1b67_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-文件的操作模式\"><a href=\"#三-文件的操作模式\" class=\"headerlink\" title=\"三 文件的操作模式\"></a>三 文件的操作模式</h2><h2 id=\"3-1-控制文件读写操作的模式\"><a href=\"#3-1-控制文件读写操作的模式\" class=\"headerlink\" title=\"3.1 控制文件读写操作的模式\"></a>3.1 控制文件读写操作的模式</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">r<span class=\"token punctuation\">(</span>默认的<span class=\"token punctuation\">)</span>：只读\nw：只写\na：只追加写<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-1-案例一：r-模式的使用\"><a href=\"#3-1-1-案例一：r-模式的使用\" class=\"headerlink\" title=\"3.1.1 案例一：r 模式的使用\"></a>3.1.1 案例一：r 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># r只读模式: 在文件不存在时则报错,文件存在文件内指针直接跳到文件开头</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     res<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 会将文件的内容由硬盘全部读入内存，赋值给res</span>\n\n<span class=\"token comment\"># 小练习：实现用户认证功能</span>\n inp_name<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请输入你的名字: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n inp_pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'请输入你的密码: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">:</span>\n         <span class=\"token comment\"># 把用户输入的名字与密码与读出内容做比对</span>\n         u<span class=\"token punctuation\">,</span>p<span class=\"token operator\">=</span>line<span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">':'</span><span class=\"token punctuation\">)</span>\n         <span class=\"token keyword\">if</span> inp_name <span class=\"token operator\">==</span> u <span class=\"token keyword\">and</span> inp_pwd <span class=\"token operator\">==</span> p<span class=\"token punctuation\">:</span>\n             <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'登录成功'</span><span class=\"token punctuation\">)</span>\n             <span class=\"token keyword\">break</span>\n     <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'账号名或者密码错误'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-2-案例二：w-模式的使用\"><a href=\"#3-1-2-案例二：w-模式的使用\" class=\"headerlink\" title=\"3.1.2 案例二：w 模式的使用\"></a>3.1.2 案例二：w 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># w只写模式: 在文件不存在时会创建空文档,文件存在会清空文件,文件指针跑到文件开头</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'w'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'你好\\n'</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'我好\\n'</span><span class=\"token punctuation\">)</span> \n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'大家好\\n'</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'111\\n222\\n333\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#强调：</span>\n<span class=\"token comment\"># 1 在文件不关闭的情况下,连续的写入，后写的内容一定跟在前写内容的后面</span>\n<span class=\"token comment\"># 2 如果重新以w模式打开文件，则会清空文件内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-3-案例三：a-模式的使用\"><a href=\"#3-1-3-案例三：a-模式的使用\" class=\"headerlink\" title=\"3.1.3 案例三：a 模式的使用\"></a>3.1.3 案例三：a 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a只追加写模式: 在文件不存在时会创建空文档,文件存在会将文件指针直接移动到文件末尾</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'c.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'44444\\n'</span><span class=\"token punctuation\">)</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'55555\\n'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#强调 w 模式与 a 模式的异同：</span>\n<span class=\"token comment\"># 1 相同点：在打开的文件不关闭的情况下，连续的写入，新写的内容总会跟在前写的内容之后</span>\n<span class=\"token comment\"># 2 不同点：以 a 模式重新打开文件，不会清空原文件内容，会将文件指针直接移动到文件末尾，新写的内容永远写在最后</span>\n\n<span class=\"token comment\"># 小练习：实现注册功能:</span>\n name<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'username>>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n pwd<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'password>>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db1.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     info<span class=\"token operator\">=</span><span class=\"token string\">'%s:%s\\n'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>pwd<span class=\"token punctuation\">)</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-1-4-案例四：-模式的使用-了解\"><a href=\"#3-1-4-案例四：-模式的使用-了解\" class=\"headerlink\" title=\"3.1.4 案例四：+ 模式的使用(了解)\"></a>3.1.4 案例四：+ 模式的使用(了解)</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># r+ w+ a+ :可读可写</span>\n<span class=\"token comment\">#在平时工作中，我们只单纯使用r/w/a，要么只读，要么只写，一般不用可读可写的模式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-bea42b94950b49f8be785289904e17b7_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-控制文件读写内容的模式\"><a href=\"#3-2-控制文件读写内容的模式\" class=\"headerlink\" title=\"3.2 控制文件读写内容的模式\"></a>3.2 控制文件读写内容的模式</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">大前提<span class=\"token punctuation\">:</span> tb模式均不能单独使用<span class=\"token punctuation\">,</span>必须与r<span class=\"token operator\">/</span>w<span class=\"token operator\">/</span>a之一结合使用\nt（默认的）：文本模式\n    <span class=\"token number\">1.</span> 读写文件都是以字符串为单位的\n    <span class=\"token number\">2.</span> 只能针对文本文件\n    <span class=\"token number\">3.</span> 必须指定encoding参数\nb：二进制模式<span class=\"token punctuation\">:</span>\n   <span class=\"token number\">1.</span>读写文件都是以<span class=\"token builtin\">bytes</span><span class=\"token operator\">/</span>二进制为单位的\n   <span class=\"token number\">2.</span> 可以针对所有文件\n   <span class=\"token number\">3.</span> 一定不能指定encoding参数<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-1-案例一：t-模式的使用\"><a href=\"#3-2-1-案例一：t-模式的使用\" class=\"headerlink\" title=\"3.2.1 案例一：t 模式的使用\"></a>3.2.1 案例一：t 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># t 模式：如果我们指定的文件打开模式为r/w/a，其实默认就是rt/wt/at</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     res<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：&lt;class 'str'></span>\n\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     s<span class=\"token operator\">=</span><span class=\"token string\">'abc'</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 写入的也必须是字符串类型</span>\n\n <span class=\"token comment\">#强调：t 模式只能用于操作文本文件,无论读写，都应该以字符串为单位，而存取硬盘本质都是二进制的形式，当指定 t 模式时，内部帮我们做了编码与解码</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-2-2-案例二：-b-模式的使用\"><a href=\"#3-2-2-案例二：-b-模式的使用\" class=\"headerlink\" title=\"3.2.2 案例二： b 模式的使用\"></a>3.2.2 案例二： b 模式的使用</h3><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># b: 读写都是以二进制位单位</span>\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1.mp4'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：&lt;class 'bytes'></span>\n\n <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     msg<span class=\"token operator\">=</span><span class=\"token string\">\"你好\"</span>\n     res<span class=\"token operator\">=</span>msg<span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># res为bytes类型</span>\n     f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 在b模式下写入文件的只能是bytes类型</span>\n\n<span class=\"token comment\">#强调：b模式对比t模式</span>\n<span class=\"token number\">1</span>、在操作纯文本文件方面t模式帮我们省去了编码与解码的环节，b模式则需要手动编码与解码，所以此时t模式更为方便\n<span class=\"token number\">2</span>、针对非文本文件（如图片、视频、音频等）只能使用b模式\n\n<span class=\"token comment\"># 小练习： 编写拷贝工具</span>\nsrc_file<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'源文件路径: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ndst_file<span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'目标文件路径: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'%s'</span> <span class=\"token operator\">%</span>src_file<span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">r'%s'</span> <span class=\"token operator\">%</span>dst_file<span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> write_f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> read_f<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># print(line)</span>\n        write_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-4af94c11c6a45976fca8c53a0794c3a2_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"四-操作文件的方法\"><a href=\"#四-操作文件的方法\" class=\"headerlink\" title=\"四 操作文件的方法\"></a>四 操作文件的方法</h2><h2 id=\"4-1-重点\"><a href=\"#4-1-重点\" class=\"headerlink\" title=\"4.1 重点\"></a>4.1 重点</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 读操作</span>\nf<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取所有内容,执行完该操作后，文件指针会移动到文件末尾</span>\nf<span class=\"token punctuation\">.</span>readline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取一行内容,光标移动到第二行首部</span>\nf<span class=\"token punctuation\">.</span>readlines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 读取每一行内容,存放于列表中</span>\n\n<span class=\"token comment\"># 强调：</span>\n<span class=\"token comment\"># f.read()与f.readlines()都是将内容一次性读入内容，如果内容过大会导致内存溢出，若还想将内容全读入内存，则必须分多次读入，有两种实现方式：</span>\n<span class=\"token comment\"># 方式一</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 同一时刻只读入一行内容到内存中</span>\n\n<span class=\"token comment\"># 方式二</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'1.mp4'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">1024</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 同一时刻只读入1024个Bytes到内存中</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">break</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 写操作</span>\nf<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'1111\\n222\\n'</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 针对文本模式的写,需要自己写换行符</span>\nf<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'1111\\n222\\n'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 针对b模式的写,需要自己写换行符</span>\nf<span class=\"token punctuation\">.</span>writelines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'333\\n'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'444\\n'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件模式</span>\nf<span class=\"token punctuation\">.</span>writelines<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">bytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'333\\n'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'444\\n'</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#b模式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-30d5763461db05414c3ac2cc944a8f6e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"4-2-了解\"><a href=\"#4-2-了解\" class=\"headerlink\" title=\"4.2 了解\"></a>4.2 了解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">f<span class=\"token punctuation\">.</span>readable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件是否可读</span>\nf<span class=\"token punctuation\">.</span>writable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 文件是否可读</span>\nf<span class=\"token punctuation\">.</span>closed  <span class=\"token comment\"># 文件是否关闭</span>\nf<span class=\"token punctuation\">.</span>encoding  <span class=\"token comment\"># 如果文件打开模式为b,则没有该属性</span>\nf<span class=\"token punctuation\">.</span>flush<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 立刻将文件内容从内存刷到硬盘</span>\nf<span class=\"token punctuation\">.</span>name<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-3474d487b3fb518ce9b511c73153ce78_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"五-主动控制文件内指针移动\"><a href=\"#五-主动控制文件内指针移动\" class=\"headerlink\" title=\"五 主动控制文件内指针移动\"></a>五 主动控制文件内指针移动</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#大前提:文件内指针的移动都是Bytes为单位的,唯一例外的是t模式下的read(n),n以字符为单位</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 读取3个字符</span>\n\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n     data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 读取3个Bytes</span>\n\n\n<span class=\"token comment\"># 之前文件内指针的移动都是由读/写操作而被动触发的，若想读取文件某一特定位置的数据，则则需要用f.seek方法主动控制文件内指针的移动，详细用法如下：</span>\n<span class=\"token comment\"># f.seek(指针移动的字节数,模式控制): </span>\n<span class=\"token comment\"># 模式控制:</span>\n<span class=\"token comment\"># 0: 默认的模式,该模式代表指针移动的字节数是以文件开头为参照的</span>\n<span class=\"token comment\"># 1: 该模式代表指针移动的字节数是以当前所在的位置为参照的</span>\n<span class=\"token comment\"># 2: 该模式代表指针移动的字节数是以文件末尾的位置为参照的</span>\n<span class=\"token comment\"># 强调:其中0模式可以在t或者b模式使用,而1跟2模式只能在b模式下用</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-2b5a0f6ecedec41601c52959b34d7f5a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-1-案例一：-0模式详解\"><a href=\"#5-1-案例一：-0模式详解\" class=\"headerlink\" title=\"5.1 案例一： 0模式详解\"></a>5.1 案例一： 0模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）</span>\nabc你好\n\n<span class=\"token comment\"># 0模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件开头移动了3个字节</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 查看当前文件指针距离文件开头的位置，输出结果为3</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 从第3个字节的位置读到文件末尾，输出结果为：你好</span>\n    <span class=\"token comment\"># 注意：由于在t模式下，会将读取的内容自动解码，所以必须保证读取的内容是一个完整中文数据，否则解码失败</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#输出结果为: 好</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-9a9115785268e099152bbed9d0bc7e97_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-2-案例二：-1模式详解\"><a href=\"#5-2-案例二：-1模式详解\" class=\"headerlink\" title=\"5.2 案例二： 1模式详解\"></a>5.2 案例二： 1模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 1模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 从当前位置往后移动3个字节，而此时的当前位置就是文件开头</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：3</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 从当前位置往后移动4个字节，而此时的当前位置为3</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：7</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-2122d50b6c97ed1c5fe27a13126266d0_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"5-3-案例三：-2模式详解\"><a href=\"#5-3-案例三：-2模式详解\" class=\"headerlink\" title=\"5.3 案例三： 2模式详解\"></a>5.3 案例三： 2模式详解</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># a.txt用utf-8编码，内容如下（abc各占1个字节，中文“你好”各占3个字节）</span>\nabc你好\n\n<span class=\"token comment\"># 2模式的使用</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件末尾移动0个字节， 即直接跳到文件末尾</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>tell<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：9</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>     <span class=\"token comment\"># 参照文件末尾往前移动了3个字节</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 输出结果为：好</span>\n\n<span class=\"token comment\"># 小练习：实现动态查看最新一条日志的效果</span>\n<span class=\"token keyword\">import</span> time\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'access.log'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        line<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>readline<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            <span class=\"token comment\"># 没有内容</span>\n            time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>end<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-009f54e4493921a84480b80a4fa5aa90_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"六-文件的修改\"><a href=\"#六-文件的修改\" class=\"headerlink\" title=\"六 文件的修改\"></a>六 文件的修改</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 文件a.txt内容如下</span>\n张一蛋     山东    <span class=\"token number\">179</span>    <span class=\"token number\">49</span>    <span class=\"token number\">12344234523</span>\n李二蛋     河北    <span class=\"token number\">163</span>    <span class=\"token number\">57</span>    <span class=\"token number\">13913453521</span>\n王全蛋     山西    <span class=\"token number\">153</span>    <span class=\"token number\">62</span>    <span class=\"token number\">18651433422</span>\n\n<span class=\"token comment\"># 执行操作</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'r+t'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>seek<span class=\"token punctuation\">(</span><span class=\"token number\">9</span><span class=\"token punctuation\">)</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;妇女主任>'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 文件修改后的内容如下</span>\n张一蛋<span class=\"token operator\">&lt;</span>妇女主任<span class=\"token operator\">></span> <span class=\"token number\">179</span>    <span class=\"token number\">49</span>    <span class=\"token number\">12344234523</span>\n李二蛋     河北    <span class=\"token number\">163</span>    <span class=\"token number\">57</span>    <span class=\"token number\">13913453521</span>\n王全蛋     山西    <span class=\"token number\">153</span>    <span class=\"token number\">62</span>    <span class=\"token number\">18651433422</span>\n\n<span class=\"token comment\"># 强调：</span>\n<span class=\"token comment\"># 1、硬盘空间是无法修改的,硬盘中数据的更新都是用新内容覆盖旧内容</span>\n<span class=\"token comment\"># 2、内存中的数据是可以修改的</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-138c4c7000b5db3a37d691ea0aa09fb0_720w.jpg\" alt=\"img\"></p>\n<p>文件对应的是硬盘空间,硬盘不能修改对应着文件本质也不能修改, 那我们看到文件的内容可以修改,是如何实现的呢? 大致的思路是将硬盘中文件内容读入内存,然后在内存中修改完毕后再覆盖回硬盘 具体的实现方式分为两种:</p>\n<h2 id=\"6-1-文件修改方式一\"><a href=\"#6-1-文件修改方式一\" class=\"headerlink\" title=\"6.1 文件修改方式一\"></a>6.1 文件修改方式一</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 实现思路：将文件内容发一次性全部读入内存,然后在内存中修改完毕后再覆盖写回原文件</span>\n<span class=\"token comment\"># 优点: 在文件修改过程中同一份数据只有一份</span>\n<span class=\"token comment\"># 缺点: 会过多地占用内存</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    data<span class=\"token operator\">=</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'kevin'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'SB'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"6-1-文件修改方式二\"><a href=\"#6-1-文件修改方式二\" class=\"headerlink\" title=\"6.1 文件修改方式二\"></a>6.1 文件修改方式二</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 实现思路：以读的方式打开原文件,以写的方式打开一个临时文件,一行行读取原文件内容,修改完后写入临时文件...,删掉原文件,将临时文件重命名原文件名</span>\n<span class=\"token comment\"># 优点: 不会占用过多的内存</span>\n<span class=\"token comment\"># 缺点: 在文件修改过程中同一份数据存了两份</span>\n<span class=\"token keyword\">import</span> os\n\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'rt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> read_f<span class=\"token punctuation\">,</span>\\\n        <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.db.txt.swap'</span><span class=\"token punctuation\">,</span>mode<span class=\"token operator\">=</span><span class=\"token string\">'wt'</span><span class=\"token punctuation\">,</span>encoding<span class=\"token operator\">=</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> wrife_f<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> read_f<span class=\"token punctuation\">:</span>\n        wrife_f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span><span class=\"token string\">'SB'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'kevin'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nos<span class=\"token punctuation\">.</span>remove<span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">)</span>\nos<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span><span class=\"token string\">'.db.txt.swap'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-d45f4a423f5dd6e9880e4dbcdb1bdaf7_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>文件处理</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=31\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=31<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=32\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=32<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=33\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=33<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=34\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=34<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=35\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=35<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=36\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=36<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=37\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=37<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n"},{"_content":"## 一 形参与实参介绍\n\n![img](https://pic2.zhimg.com/80/v2-3be956bc3ace8da945af47995ea41b19_720w.jpg)\n\n函数的参数分为形式参数和实际参数，简称形参和实参：\n\n形参即在定义函数时，括号内声明的参数。形参本质就是一个变量名，用来接收外部传来的值。\n\n实参即在调用函数时，括号内传入的值，值可以是常量、变量、表达式或三者的组合:\n\n```python\n#1：实参是常量\nres=my_min(1,2)\n\n#2：实参是变量\na=1\nb=2\nres=my_min(a,b)\n\n#3：实参是表达式\nres=my_min(10*2,10*my_min(3,4))\n\n#4：实参可以是常量、变量、表达式的任意组合\na=2\nmy_min(1,a,10*my_min(3,4))\n```\n\n在调用有参函数时，实参（值）会赋值给形参（变量名）。在Python中，变量名与值只是单纯的绑定关系，而对于函数来说，这种绑定关系只在函数调用时生效，在调用结束后解除。\n\n![img](https://pic2.zhimg.com/80/v2-b0036c8f8942a558d95a3200f38338d1_720w.jpg)\n\n## 二 形参与实参的具体使用\n\n## 2.1 位置参数\n\n位置即顺序，位置参数指的是按顺序定义的参数，需要从两个角度去看：\n\n1. 在定义函数时，按照从左到右的顺序依次定义形参,称为位置形参，凡是按照这种形式定义的形参都必须被传值\n\n```python\ndef register(name,age,sex): #定义位置形参：name，age，sex，三者都必须被传值\n    print('Name:%s Age:%s Sex:%s' %(name,age,sex))\nregister() #TypeError：缺少3个位置参数 \n```\n\n1. 在调用函数时，按照从左到右的顺序依次定义实参，称为位置实参，凡是按照这种形式定义的实参会按照从左到右的顺序与形参一一对应\n\n```python\ndef register(name,age,sex): #定义位置形参：name，age，sex，三者都必须被传值\n    print('Name:%s Age:%s Sex:%s' %(name,age,sex))\nregister() #TypeError：缺少3个位置参数\n```\n\n![img](https://pic3.zhimg.com/80/v2-1152d1943f7d6b217981965ad5d2b8be_720w.jpg)\n\n## 2.2 关键字参数\n\n在调用函数时，实参可以是key=value的形式，称为关键字参数，凡是按照这种形式定义的实参，可以完全不按照从左到右的顺序定义，但仍能为指定的形参赋值\n\n```python\n>>> register(sex='male',name='lili',age=18)\nName:lili Age:18 Sex:male\n```\n\n需要注意在调用函数时，实参也可以是按位置或按关键字的混合使用，但必须保证关键字参数在位置参数后面，且不可以对一个形参重复赋值\n\n```python\n>>> register('lili',sex='male',age=18) #正确使用\n>>> register(name='lili',18,sex='male') #SyntaxError：关键字参数name=‘lili’在位置参数18之前\n>>> register('lili',sex='male',age=18,name='jack') #TypeError：形参name被重复赋值\n```\n\n![img](https://pic3.zhimg.com/80/v2-751903e8073067049e6c42c5196754fe_720w.jpg)\n\n## 2.3 默认参数\n\n在定义函数时，就已经为形参赋值，这类形参称之为默认参数，当函数有多个参数时，需要将值经常改变的参数定义成位置参数，而将值改变较少的参数定义成默认参数。例如编写一个注册学生信息的函数，如果大多数学生的性别都为男，那完全可以将形参sex定义成默认参数\n\n```python\n>>> def register(name,age,sex='male'): #默认sex的值为male\n...     print('Name:%s Age:%s Sex:%s' %(name,age,sex))\n...\n```\n\n定义时就已经为参数sex赋值，意味着调用时可以不对sex赋值，这降低了函数调用的复杂度\n\n```python\n>>> register('tom',17) #大多数情况,无需为sex传值,默认为male\nName:tom Age:17 Sex:male\n>>> register('Lili',18,'female') #少数情况,可以为sex传值female\nName:Lili Age:18 Sex:female\n```\n\n![img](https://pic2.zhimg.com/80/v2-85c49040b5ca19b0a6cd236d6a335d21_720w.jpg)\n\n需要注意：\n\n1. 默认参数必须在位置参数之后\n2. 默认参数的值仅在函数定义阶段被赋值一次\n\n```python\n>>> x=1\n>>> def foo(arg=x):\n...     print(arg)\n... \n>>> x=5 #定义阶段arg已被赋值为1，此处的修改与默认参数arg无任何关系\n>>> foo()\n1\n```\n\n1. 默认参数的值通常应设为不可变类型\n\n```python\ndef foo(n,arg=[]):    \n     arg.append(n)    \n     return arg    \nfoo(1)    \n[1] \nfoo(2)    \n[1, 2] \nfoo(3)    \n[1, 2, 3]\n```\n\n每次调用是在上一次的基础上向同一列表增加值，修改如下\n\n```python\ndef foo(n,arg=None):    \n     if arg is None:    \n         arg=[]    \n     arg.append(n)    \n     return arg    \nfoo(1)    \n[1] \nfoo(2)    \n[2] \nfoo(3)    \n[3]\n```\n\n![img](https://pic3.zhimg.com/80/v2-c48b74c4968b946d68531c2ef2c1b40e_720w.jpg)\n\n## 2.4 可变长度的参数（*与**的用法）\n\n![img](https://pic2.zhimg.com/80/v2-ac1ed3f13dbd9fea9e3c5cfbb1047611_720w.jpg)\n\n参数的长度可变指的是在调用函数时，实参的个数可以不固定，而在调用函数时，实参的定义无非是按位置或者按关键字两种形式，这就要求形参提供两种解决方案来分别处理两种形式的可变长度的参数\n\n### 2.4.1 可变长度的位置参数\n\n如果在最后一个形参名前加*号,那么在调用函数时，溢出的位置实参，都会被*接收，以元组的形式保存下来赋值给该形参\n\n```python\n>>> def foo(x,y,z=1,*args): #在最后一个形参名args前加*号\n...     print(x)\n...     print(y)\n...     print(z)\n...     print(args)\n... \n>>> foo(1,2,3,4,5,6,7)  #实参1、2、3按位置为形参x、y、z赋值，多余的位置实参4、5、6、7都被*接收，以元组的形式保存下来，赋值给args，即args=(4, 5, 6,7)\n\n1\n2\n3\n(4, 5, 6, 7)\n```\n\n如果我们事先生成了一个列表,仍然是可以传值给*args的\n\n```python\n>>> def foo(x,y,*args):\n...     print(x)\n...     print(y)\n...     print(args)\n... \n>>> L=[3,4,5]\n>>> foo(1,2,*L) # *L就相当于位置参数3，4，5, foo(1,2,*L)就等同于foo(1,2,3,4,5)\n1\n2\n(3, 4, 5)\n```\n\n![img](https://pic1.zhimg.com/80/v2-e73cc42b02d988741717036dab3ef3d8_720w.jpg)\n\n注意：如果在传入L时没有加*,那L就只是一个普通的位置参数了\n\n```python\n>>> foo(1,2,L) #仅多出一个位置实参L\n1\n2\n([1, 2, 3],)\n```\n\n如果形参为常规的参数（位置或默认），实参仍可以是*的形式\n\n```python\n>>> def foo(x,y,z=3):\n...     print(x)\n...     print(y)\n...     print(z)\n... \n>>> foo(*[1,2]) #等同于foo(1,2)\n1\n2\n3\n```\n\n如果我们想要求多个值的和，*args就派上用场了\n\n```python\n>>> def add(*args):\n...     res=0\n...     for i in args:\n...         res+=i\n...     return res\n... \n>>> add(1,2,3,4,5)\n15\n```\n\n![img](https://pic1.zhimg.com/80/v2-8996656ee55ad76ec5b15628a8044140_720w.jpg)\n\n### 2.4.2 可变长度的关键字参数\n\n如果在最后一个形参名前加**号,那么在调用函数时，溢出的关键字参数，都会被**接收，以字典的形式保存下来赋值给该形参\n\n```python\n>>> def foo(x,**kwargs): #在最后一个参数kwargs前加**\n...     print(x)        \n...     print(kwargs)   \n... \n>>> foo(y=2,x=1,z=3) #溢出的关键字实参y=2，z=3都被**接收，以字典的形式保存下来，赋值给kwargs\n1\n{'z': 3, 'y': 2}\n```\n\n如果我们事先生成了一个字典,仍然是可以传值给**kwargs的\n\n```python\n>>> def foo(x,y,**kwargs):\n...     print(x)\n...     print(y)\n...     print(kwargs)\n... \n>>> dic={'a':1,'b':2} \n>>> foo(1,2,**dic) #**dic就相当于关键字参数a=1，b=2，foo(1,2,**dic)等同foo(1,2,a=1,b=2)\n1\n2\n{'a': 1, 'b': 2}\n```\n\n![img](https://pic1.zhimg.com/80/v2-b4374327737ac837551b67f7813666e8_720w.jpg)\n\n注意：如果在传入dic时没有加**,那dic就只是一个普通的位置参数了\n\n```python\n>>> foo(1,2,dic) #TypeError:函数foo只需要2个位置参数，但是传了3个\n```\n\n如果形参为常规参数（位置或默认），实参仍可以是**的形式\n\n```python\n>>> def foo(x,y,z=3):\n...     print(x)\n...     print(y)\n...     print(z)\n... \n>>> foo(**{'x':1,'y':2}) #等同于foo(y=2,x=1)\n1\n2\n3\n```\n\n如果我们要编写一个用户认证的函数，起初可能只基于用户名密码的验证就可以了，可以使用**kwargs为日后的扩展供良好的环境，同时保持了函数的简洁性。\n\n```python\n>>> def auth(user,password,**kwargs): \n...     pass \n...\n```\n\n## 2.5 命名关键字参数\n\n在定义了**kwargs参数后，函数调用者就可以传入任意的关键字参数key=value，如果函数体代码的执行需要依赖某个key，必须在函数内进行判断\n\n```python\n>>> def register(name,age,**kwargs):\n...     if 'sex' in kwargs:\n...         #有sex参数\n...         pass\n...     if 'height' in kwargs:\n...         #有height参数\n...         pass\n...\n```\n\n想要限定函数的调用者必须以key=value的形式传值，Python3提供了专门的语法：需要在定义形参时，用*作为一个分隔符号，*号之后的形参称为命名关键字参数。对于这类参数，在函数调用时，必须按照key=value的形式为其传值，且必须被传值\n\n```python\n>>> def register(name,age,*,sex,height): #sex,height为命名关键字参数\n...     pass\n... \n>>> register('lili',18,sex='male',height='1.8m') #正确使用\n>>> register('lili',18,'male','1.8m') # TypeError:未使用关键字的形式为sex和height传值\n>>> register('lili',18,height='1.8m') # TypeError没有为命名关键字参数height传值。\n```\n\n![img](https://pic4.zhimg.com/80/v2-536b4db7a18e1f39795a152f4c6249bb_720w.jpg)\n\n命名关键字参数也可以有默认值，从而简化调用\n\n```python\n>>> def register(name,age,*,sex='male',height):\n...     print('Name:%s,Age:%s,Sex:%s,Height:%s' %(name,age,sex,height))\n... \n>>> register('lili',18,height='1.8m')\nName:lili,Age:18,Sex:male,Height:1.8m\n```\n\n需要强调的是：sex不是默认参数，height也不是位置参数，因为二者均在*后，所以都是命名关键字参数，形参sex=’male’属于命名关键字参数的默认值，因而即便是放到形参height之前也不会有问题。另外，如果形参中已经有一个*args了，命名关键字参数就不再需要一个单独的*作为分隔符号了\n\n```python\n>>> def register(name,age,*args,sex='male',height):\n...   print('Name:%s,Age:%s,Args:%s,Sex:%s,Height:%s' %(name,age,args,sex,height))\n... \n>>> register('lili',18,1,2,3,height='1.8m') #sex与height仍为命名关键字参数\nName:lili,Age:18,Args:(1, 2, 3),Sex:male,Height:1.8m\n```\n\n![img](https://pic4.zhimg.com/80/v2-daa2f3a7038bc4603a334da19e216dcf_720w.jpg)\n\n![img](https://pic1.zhimg.com/80/v2-f69da71d076e7119fd2ec2e84817dd6c_720w.jpg)\n\n## 2.6 组合使用\n\n综上所述所有参数可任意组合使用，但定义顺序必须是：位置参数、默认参数、*args、命名关键字参数、**kwargs\n\n可变参数*args与关键字参数**kwargs通常是组合在一起使用的，如果一个函数的形参为\\*args与**kwargs，那么代表该函数可以接收任何形式、任意长度的参数\n\n```python\n>>> def wrapper(*args,**kwargs):\n...     pass\n...\n```\n\n![img](https://pic4.zhimg.com/80/v2-8a33c0e3ae4f314dc75eca6250b66fe7_720w.jpg)\n\n在该函数内部还可以把接收到的参数传给另外一个函数（这在4.6小节装饰器的实现中大有用处）\n\n```python\n>>> def func(x,y,z):\n...     print(x,y,z)\n... \n>>> def wrapper(*args,**kwargs):\n...     func(*args,**kwargs)\n...\n>>> wrapper(1,z=3,y=2)\n1 2 3\n```\n\n按照上述写法，在为函数wrapper传参时，其实遵循的是函数func的参数规则，调用函数wrapper的过程分析如下：\n\n1. 位置实参1被*接收，以元组的形式保存下来，赋值给args，即args=(1,),关键字实参z=3，y=2被**接收，以字典的形式保存下来，赋值给kwargs，即kwargs={'y': 2, 'z': 3}\n2. 执行func(*args,*kwargs),即func(*(1,),** {'y': 2, 'z': 3}),等同于func(1,z=3,y=2)\n\n```python\n提示： *args、**kwargs中的args和kwargs被替换成其他名字并无语法错误，但使用args、kwargs是约定俗成的。\n```\n\n![img](https://pic3.zhimg.com/80/v2-0064bdc3b1e3fd19d4240f375fecce8a_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471/?p=40www.bilibili.com/video/av73342471/?p=40](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471/%3Fp%3D40)\n\n[https://www.bilibili.com/video/av73342471?p=41www.bilibili.com/video/av73342471?p=41](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D41)\n\n[https://www.bilibili.com/video/av73342471?p=42www.bilibili.com/video/av73342471?p=42](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D42)","source":"_posts/03_Python/01_Python基础/12_函数的参数.md","raw":"## 一 形参与实参介绍\n\n![img](https://pic2.zhimg.com/80/v2-3be956bc3ace8da945af47995ea41b19_720w.jpg)\n\n函数的参数分为形式参数和实际参数，简称形参和实参：\n\n形参即在定义函数时，括号内声明的参数。形参本质就是一个变量名，用来接收外部传来的值。\n\n实参即在调用函数时，括号内传入的值，值可以是常量、变量、表达式或三者的组合:\n\n```python\n#1：实参是常量\nres=my_min(1,2)\n\n#2：实参是变量\na=1\nb=2\nres=my_min(a,b)\n\n#3：实参是表达式\nres=my_min(10*2,10*my_min(3,4))\n\n#4：实参可以是常量、变量、表达式的任意组合\na=2\nmy_min(1,a,10*my_min(3,4))\n```\n\n在调用有参函数时，实参（值）会赋值给形参（变量名）。在Python中，变量名与值只是单纯的绑定关系，而对于函数来说，这种绑定关系只在函数调用时生效，在调用结束后解除。\n\n![img](https://pic2.zhimg.com/80/v2-b0036c8f8942a558d95a3200f38338d1_720w.jpg)\n\n## 二 形参与实参的具体使用\n\n## 2.1 位置参数\n\n位置即顺序，位置参数指的是按顺序定义的参数，需要从两个角度去看：\n\n1. 在定义函数时，按照从左到右的顺序依次定义形参,称为位置形参，凡是按照这种形式定义的形参都必须被传值\n\n```python\ndef register(name,age,sex): #定义位置形参：name，age，sex，三者都必须被传值\n    print('Name:%s Age:%s Sex:%s' %(name,age,sex))\nregister() #TypeError：缺少3个位置参数 \n```\n\n1. 在调用函数时，按照从左到右的顺序依次定义实参，称为位置实参，凡是按照这种形式定义的实参会按照从左到右的顺序与形参一一对应\n\n```python\ndef register(name,age,sex): #定义位置形参：name，age，sex，三者都必须被传值\n    print('Name:%s Age:%s Sex:%s' %(name,age,sex))\nregister() #TypeError：缺少3个位置参数\n```\n\n![img](https://pic3.zhimg.com/80/v2-1152d1943f7d6b217981965ad5d2b8be_720w.jpg)\n\n## 2.2 关键字参数\n\n在调用函数时，实参可以是key=value的形式，称为关键字参数，凡是按照这种形式定义的实参，可以完全不按照从左到右的顺序定义，但仍能为指定的形参赋值\n\n```python\n>>> register(sex='male',name='lili',age=18)\nName:lili Age:18 Sex:male\n```\n\n需要注意在调用函数时，实参也可以是按位置或按关键字的混合使用，但必须保证关键字参数在位置参数后面，且不可以对一个形参重复赋值\n\n```python\n>>> register('lili',sex='male',age=18) #正确使用\n>>> register(name='lili',18,sex='male') #SyntaxError：关键字参数name=‘lili’在位置参数18之前\n>>> register('lili',sex='male',age=18,name='jack') #TypeError：形参name被重复赋值\n```\n\n![img](https://pic3.zhimg.com/80/v2-751903e8073067049e6c42c5196754fe_720w.jpg)\n\n## 2.3 默认参数\n\n在定义函数时，就已经为形参赋值，这类形参称之为默认参数，当函数有多个参数时，需要将值经常改变的参数定义成位置参数，而将值改变较少的参数定义成默认参数。例如编写一个注册学生信息的函数，如果大多数学生的性别都为男，那完全可以将形参sex定义成默认参数\n\n```python\n>>> def register(name,age,sex='male'): #默认sex的值为male\n...     print('Name:%s Age:%s Sex:%s' %(name,age,sex))\n...\n```\n\n定义时就已经为参数sex赋值，意味着调用时可以不对sex赋值，这降低了函数调用的复杂度\n\n```python\n>>> register('tom',17) #大多数情况,无需为sex传值,默认为male\nName:tom Age:17 Sex:male\n>>> register('Lili',18,'female') #少数情况,可以为sex传值female\nName:Lili Age:18 Sex:female\n```\n\n![img](https://pic2.zhimg.com/80/v2-85c49040b5ca19b0a6cd236d6a335d21_720w.jpg)\n\n需要注意：\n\n1. 默认参数必须在位置参数之后\n2. 默认参数的值仅在函数定义阶段被赋值一次\n\n```python\n>>> x=1\n>>> def foo(arg=x):\n...     print(arg)\n... \n>>> x=5 #定义阶段arg已被赋值为1，此处的修改与默认参数arg无任何关系\n>>> foo()\n1\n```\n\n1. 默认参数的值通常应设为不可变类型\n\n```python\ndef foo(n,arg=[]):    \n     arg.append(n)    \n     return arg    \nfoo(1)    \n[1] \nfoo(2)    \n[1, 2] \nfoo(3)    \n[1, 2, 3]\n```\n\n每次调用是在上一次的基础上向同一列表增加值，修改如下\n\n```python\ndef foo(n,arg=None):    \n     if arg is None:    \n         arg=[]    \n     arg.append(n)    \n     return arg    \nfoo(1)    \n[1] \nfoo(2)    \n[2] \nfoo(3)    \n[3]\n```\n\n![img](https://pic3.zhimg.com/80/v2-c48b74c4968b946d68531c2ef2c1b40e_720w.jpg)\n\n## 2.4 可变长度的参数（*与**的用法）\n\n![img](https://pic2.zhimg.com/80/v2-ac1ed3f13dbd9fea9e3c5cfbb1047611_720w.jpg)\n\n参数的长度可变指的是在调用函数时，实参的个数可以不固定，而在调用函数时，实参的定义无非是按位置或者按关键字两种形式，这就要求形参提供两种解决方案来分别处理两种形式的可变长度的参数\n\n### 2.4.1 可变长度的位置参数\n\n如果在最后一个形参名前加*号,那么在调用函数时，溢出的位置实参，都会被*接收，以元组的形式保存下来赋值给该形参\n\n```python\n>>> def foo(x,y,z=1,*args): #在最后一个形参名args前加*号\n...     print(x)\n...     print(y)\n...     print(z)\n...     print(args)\n... \n>>> foo(1,2,3,4,5,6,7)  #实参1、2、3按位置为形参x、y、z赋值，多余的位置实参4、5、6、7都被*接收，以元组的形式保存下来，赋值给args，即args=(4, 5, 6,7)\n\n1\n2\n3\n(4, 5, 6, 7)\n```\n\n如果我们事先生成了一个列表,仍然是可以传值给*args的\n\n```python\n>>> def foo(x,y,*args):\n...     print(x)\n...     print(y)\n...     print(args)\n... \n>>> L=[3,4,5]\n>>> foo(1,2,*L) # *L就相当于位置参数3，4，5, foo(1,2,*L)就等同于foo(1,2,3,4,5)\n1\n2\n(3, 4, 5)\n```\n\n![img](https://pic1.zhimg.com/80/v2-e73cc42b02d988741717036dab3ef3d8_720w.jpg)\n\n注意：如果在传入L时没有加*,那L就只是一个普通的位置参数了\n\n```python\n>>> foo(1,2,L) #仅多出一个位置实参L\n1\n2\n([1, 2, 3],)\n```\n\n如果形参为常规的参数（位置或默认），实参仍可以是*的形式\n\n```python\n>>> def foo(x,y,z=3):\n...     print(x)\n...     print(y)\n...     print(z)\n... \n>>> foo(*[1,2]) #等同于foo(1,2)\n1\n2\n3\n```\n\n如果我们想要求多个值的和，*args就派上用场了\n\n```python\n>>> def add(*args):\n...     res=0\n...     for i in args:\n...         res+=i\n...     return res\n... \n>>> add(1,2,3,4,5)\n15\n```\n\n![img](https://pic1.zhimg.com/80/v2-8996656ee55ad76ec5b15628a8044140_720w.jpg)\n\n### 2.4.2 可变长度的关键字参数\n\n如果在最后一个形参名前加**号,那么在调用函数时，溢出的关键字参数，都会被**接收，以字典的形式保存下来赋值给该形参\n\n```python\n>>> def foo(x,**kwargs): #在最后一个参数kwargs前加**\n...     print(x)        \n...     print(kwargs)   \n... \n>>> foo(y=2,x=1,z=3) #溢出的关键字实参y=2，z=3都被**接收，以字典的形式保存下来，赋值给kwargs\n1\n{'z': 3, 'y': 2}\n```\n\n如果我们事先生成了一个字典,仍然是可以传值给**kwargs的\n\n```python\n>>> def foo(x,y,**kwargs):\n...     print(x)\n...     print(y)\n...     print(kwargs)\n... \n>>> dic={'a':1,'b':2} \n>>> foo(1,2,**dic) #**dic就相当于关键字参数a=1，b=2，foo(1,2,**dic)等同foo(1,2,a=1,b=2)\n1\n2\n{'a': 1, 'b': 2}\n```\n\n![img](https://pic1.zhimg.com/80/v2-b4374327737ac837551b67f7813666e8_720w.jpg)\n\n注意：如果在传入dic时没有加**,那dic就只是一个普通的位置参数了\n\n```python\n>>> foo(1,2,dic) #TypeError:函数foo只需要2个位置参数，但是传了3个\n```\n\n如果形参为常规参数（位置或默认），实参仍可以是**的形式\n\n```python\n>>> def foo(x,y,z=3):\n...     print(x)\n...     print(y)\n...     print(z)\n... \n>>> foo(**{'x':1,'y':2}) #等同于foo(y=2,x=1)\n1\n2\n3\n```\n\n如果我们要编写一个用户认证的函数，起初可能只基于用户名密码的验证就可以了，可以使用**kwargs为日后的扩展供良好的环境，同时保持了函数的简洁性。\n\n```python\n>>> def auth(user,password,**kwargs): \n...     pass \n...\n```\n\n## 2.5 命名关键字参数\n\n在定义了**kwargs参数后，函数调用者就可以传入任意的关键字参数key=value，如果函数体代码的执行需要依赖某个key，必须在函数内进行判断\n\n```python\n>>> def register(name,age,**kwargs):\n...     if 'sex' in kwargs:\n...         #有sex参数\n...         pass\n...     if 'height' in kwargs:\n...         #有height参数\n...         pass\n...\n```\n\n想要限定函数的调用者必须以key=value的形式传值，Python3提供了专门的语法：需要在定义形参时，用*作为一个分隔符号，*号之后的形参称为命名关键字参数。对于这类参数，在函数调用时，必须按照key=value的形式为其传值，且必须被传值\n\n```python\n>>> def register(name,age,*,sex,height): #sex,height为命名关键字参数\n...     pass\n... \n>>> register('lili',18,sex='male',height='1.8m') #正确使用\n>>> register('lili',18,'male','1.8m') # TypeError:未使用关键字的形式为sex和height传值\n>>> register('lili',18,height='1.8m') # TypeError没有为命名关键字参数height传值。\n```\n\n![img](https://pic4.zhimg.com/80/v2-536b4db7a18e1f39795a152f4c6249bb_720w.jpg)\n\n命名关键字参数也可以有默认值，从而简化调用\n\n```python\n>>> def register(name,age,*,sex='male',height):\n...     print('Name:%s,Age:%s,Sex:%s,Height:%s' %(name,age,sex,height))\n... \n>>> register('lili',18,height='1.8m')\nName:lili,Age:18,Sex:male,Height:1.8m\n```\n\n需要强调的是：sex不是默认参数，height也不是位置参数，因为二者均在*后，所以都是命名关键字参数，形参sex=’male’属于命名关键字参数的默认值，因而即便是放到形参height之前也不会有问题。另外，如果形参中已经有一个*args了，命名关键字参数就不再需要一个单独的*作为分隔符号了\n\n```python\n>>> def register(name,age,*args,sex='male',height):\n...   print('Name:%s,Age:%s,Args:%s,Sex:%s,Height:%s' %(name,age,args,sex,height))\n... \n>>> register('lili',18,1,2,3,height='1.8m') #sex与height仍为命名关键字参数\nName:lili,Age:18,Args:(1, 2, 3),Sex:male,Height:1.8m\n```\n\n![img](https://pic4.zhimg.com/80/v2-daa2f3a7038bc4603a334da19e216dcf_720w.jpg)\n\n![img](https://pic1.zhimg.com/80/v2-f69da71d076e7119fd2ec2e84817dd6c_720w.jpg)\n\n## 2.6 组合使用\n\n综上所述所有参数可任意组合使用，但定义顺序必须是：位置参数、默认参数、*args、命名关键字参数、**kwargs\n\n可变参数*args与关键字参数**kwargs通常是组合在一起使用的，如果一个函数的形参为\\*args与**kwargs，那么代表该函数可以接收任何形式、任意长度的参数\n\n```python\n>>> def wrapper(*args,**kwargs):\n...     pass\n...\n```\n\n![img](https://pic4.zhimg.com/80/v2-8a33c0e3ae4f314dc75eca6250b66fe7_720w.jpg)\n\n在该函数内部还可以把接收到的参数传给另外一个函数（这在4.6小节装饰器的实现中大有用处）\n\n```python\n>>> def func(x,y,z):\n...     print(x,y,z)\n... \n>>> def wrapper(*args,**kwargs):\n...     func(*args,**kwargs)\n...\n>>> wrapper(1,z=3,y=2)\n1 2 3\n```\n\n按照上述写法，在为函数wrapper传参时，其实遵循的是函数func的参数规则，调用函数wrapper的过程分析如下：\n\n1. 位置实参1被*接收，以元组的形式保存下来，赋值给args，即args=(1,),关键字实参z=3，y=2被**接收，以字典的形式保存下来，赋值给kwargs，即kwargs={'y': 2, 'z': 3}\n2. 执行func(*args,*kwargs),即func(*(1,),** {'y': 2, 'z': 3}),等同于func(1,z=3,y=2)\n\n```python\n提示： *args、**kwargs中的args和kwargs被替换成其他名字并无语法错误，但使用args、kwargs是约定俗成的。\n```\n\n![img](https://pic3.zhimg.com/80/v2-0064bdc3b1e3fd19d4240f375fecce8a_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471/?p=40www.bilibili.com/video/av73342471/?p=40](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471/%3Fp%3D40)\n\n[https://www.bilibili.com/video/av73342471?p=41www.bilibili.com/video/av73342471?p=41](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D41)\n\n[https://www.bilibili.com/video/av73342471?p=42www.bilibili.com/video/av73342471?p=42](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D42)","slug":"03_Python/01_Python基础/12_函数的参数","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k160028a8v7av167gs8","content":"<h2 id=\"一-形参与实参介绍\"><a href=\"#一-形参与实参介绍\" class=\"headerlink\" title=\"一 形参与实参介绍\"></a>一 形参与实参介绍</h2><p><img src=\"https://pic2.zhimg.com/80/v2-3be956bc3ace8da945af47995ea41b19_720w.jpg\" alt=\"img\"></p>\n<p>函数的参数分为形式参数和实际参数，简称形参和实参：</p>\n<p>形参即在定义函数时，括号内声明的参数。形参本质就是一个变量名，用来接收外部传来的值。</p>\n<p>实参即在调用函数时，括号内传入的值，值可以是常量、变量、表达式或三者的组合:</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1：实参是常量</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#2：实参是变量</span>\na<span class=\"token operator\">=</span><span class=\"token number\">1</span>\nb<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#3：实参是表达式</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">*</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#4：实参可以是常量、变量、表达式的任意组合</span>\na<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nmy_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在调用有参函数时，实参（值）会赋值给形参（变量名）。在Python中，变量名与值只是单纯的绑定关系，而对于函数来说，这种绑定关系只在函数调用时生效，在调用结束后解除。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-b0036c8f8942a558d95a3200f38338d1_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-形参与实参的具体使用\"><a href=\"#二-形参与实参的具体使用\" class=\"headerlink\" title=\"二 形参与实参的具体使用\"></a>二 形参与实参的具体使用</h2><h2 id=\"2-1-位置参数\"><a href=\"#2-1-位置参数\" class=\"headerlink\" title=\"2.1 位置参数\"></a>2.1 位置参数</h2><p>位置即顺序，位置参数指的是按顺序定义的参数，需要从两个角度去看：</p>\n<ol>\n<li>在定义函数时，按照从左到右的顺序依次定义形参,称为位置形参，凡是按照这种形式定义的形参都必须被传值</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#定义位置形参：name，age，sex，三者都必须被传值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nregister<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：缺少3个位置参数 </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>在调用函数时，按照从左到右的顺序依次定义实参，称为位置实参，凡是按照这种形式定义的实参会按照从左到右的顺序与形参一一对应</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#定义位置形参：name，age，sex，三者都必须被传值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nregister<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：缺少3个位置参数</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-1152d1943f7d6b217981965ad5d2b8be_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-关键字参数\"><a href=\"#2-2-关键字参数\" class=\"headerlink\" title=\"2.2 关键字参数\"></a>2.2 关键字参数</h2><p>在调用函数时，实参可以是key&#x3D;value的形式，称为关键字参数，凡是按照这种形式定义的实参，可以完全不按照从左到右的顺序定义，但仍能为指定的形参赋值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span>\nName<span class=\"token punctuation\">:</span>lili Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span> Sex<span class=\"token punctuation\">:</span>male<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>需要注意在调用函数时，实参也可以是按位置或按关键字的混合使用，但必须保证关键字参数在位置参数后面，且不可以对一个形参重复赋值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#正确使用</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#SyntaxError：关键字参数name=‘lili’在位置参数18之前</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>name<span class=\"token operator\">=</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：形参name被重复赋值</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-751903e8073067049e6c42c5196754fe_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-3-默认参数\"><a href=\"#2-3-默认参数\" class=\"headerlink\" title=\"2.3 默认参数\"></a>2.3 默认参数</h2><p>在定义函数时，就已经为形参赋值，这类形参称之为默认参数，当函数有多个参数时，需要将值经常改变的参数定义成位置参数，而将值改变较少的参数定义成默认参数。例如编写一个注册学生信息的函数，如果大多数学生的性别都为男，那完全可以将形参sex定义成默认参数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#默认sex的值为male</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>定义时就已经为参数sex赋值，意味着调用时可以不对sex赋值，这降低了函数调用的复杂度</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'tom'</span><span class=\"token punctuation\">,</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#大多数情况,无需为sex传值,默认为male</span>\nName<span class=\"token punctuation\">:</span>tom Age<span class=\"token punctuation\">:</span><span class=\"token number\">17</span> Sex<span class=\"token punctuation\">:</span>male\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'Lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'female'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#少数情况,可以为sex传值female</span>\nName<span class=\"token punctuation\">:</span>Lili Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span> Sex<span class=\"token punctuation\">:</span>female<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-85c49040b5ca19b0a6cd236d6a335d21_720w.jpg\" alt=\"img\"></p>\n<p>需要注意：</p>\n<ol>\n<li>默认参数必须在位置参数之后</li>\n<li>默认参数的值仅在函数定义阶段被赋值一次</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>arg<span class=\"token operator\">=</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token comment\">#定义阶段arg已被赋值为1，此处的修改与默认参数arg无任何关系</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>默认参数的值通常应设为不可变类型</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span>arg<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>    \n     arg<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span>    \n     <span class=\"token keyword\">return</span> arg    \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>每次调用是在上一次的基础上向同一列表增加值，修改如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span>arg<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>    \n     <span class=\"token keyword\">if</span> arg <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>    \n         arg<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>    \n     arg<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span>    \n     <span class=\"token keyword\">return</span> arg    \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-c48b74c4968b946d68531c2ef2c1b40e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-4-可变长度的参数（-与-的用法）\"><a href=\"#2-4-可变长度的参数（-与-的用法）\" class=\"headerlink\" title=\"2.4 可变长度的参数（*与**的用法）\"></a>2.4 可变长度的参数（*与**的用法）</h2><p><img src=\"https://pic2.zhimg.com/80/v2-ac1ed3f13dbd9fea9e3c5cfbb1047611_720w.jpg\" alt=\"img\"></p>\n<p>参数的长度可变指的是在调用函数时，实参的个数可以不固定，而在调用函数时，实参的定义无非是按位置或者按关键字两种形式，这就要求形参提供两种解决方案来分别处理两种形式的可变长度的参数</p>\n<h3 id=\"2-4-1-可变长度的位置参数\"><a href=\"#2-4-1-可变长度的位置参数\" class=\"headerlink\" title=\"2.4.1 可变长度的位置参数\"></a>2.4.1 可变长度的位置参数</h3><p>如果在最后一个形参名前加<em>号,那么在调用函数时，溢出的位置实参，都会被</em>接收，以元组的形式保存下来赋值给该形参</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#在最后一个形参名args前加*号</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">#实参1、2、3按位置为形参x、y、z赋值，多余的位置实参4、5、6、7都被*接收，以元组的形式保存下来，赋值给args，即args=(4, 5, 6,7)</span>\n\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们事先生成了一个列表,仍然是可以传值给*args的</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> L<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>L<span class=\"token punctuation\">)</span> <span class=\"token comment\"># *L就相当于位置参数3，4，5, foo(1,2,*L)就等同于foo(1,2,3,4,5)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-e73cc42b02d988741717036dab3ef3d8_720w.jpg\" alt=\"img\"></p>\n<p>注意：如果在传入L时没有加*,那L就只是一个普通的位置参数了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>L<span class=\"token punctuation\">)</span> <span class=\"token comment\">#仅多出一个位置实参L</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果形参为常规的参数（位置或默认），实参仍可以是*的形式</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#等同于foo(1,2)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们想要求多个值的和，*args就派上用场了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     res<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> args<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         res<span class=\"token operator\">+=</span>i\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> res\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">15</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-8996656ee55ad76ec5b15628a8044140_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"2-4-2-可变长度的关键字参数\"><a href=\"#2-4-2-可变长度的关键字参数\" class=\"headerlink\" title=\"2.4.2 可变长度的关键字参数\"></a>2.4.2 可变长度的关键字参数</h3><p>如果在最后一个形参名前加<strong>号,那么在调用函数时，溢出的关键字参数，都会被</strong>接收，以字典的形式保存下来赋值给该形参</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#在最后一个参数kwargs前加**</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>        \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>kwargs<span class=\"token punctuation\">)</span>   \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span>y<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>x<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#溢出的关键字实参y=2，z=3都被**接收，以字典的形式保存下来，赋值给kwargs</span>\n<span class=\"token number\">1</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们事先生成了一个字典,仍然是可以传值给**kwargs的</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>kwargs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>dic<span class=\"token punctuation\">)</span> <span class=\"token comment\">#**dic就相当于关键字参数a=1，b=2，foo(1,2,**dic)等同foo(1,2,a=1,b=2)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-b4374327737ac837551b67f7813666e8_720w.jpg\" alt=\"img\"></p>\n<p>注意：如果在传入dic时没有加**,那dic就只是一个普通的位置参数了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>dic<span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError:函数foo只需要2个位置参数，但是传了3个</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>如果形参为常规参数（位置或默认），实参仍可以是**的形式</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'x'</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#等同于foo(y=2,x=1)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们要编写一个用户认证的函数，起初可能只基于用户名密码的验证就可以了，可以使用**kwargs为日后的扩展供良好的环境，同时保持了函数的简洁性。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>password<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span> \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-5-命名关键字参数\"><a href=\"#2-5-命名关键字参数\" class=\"headerlink\" title=\"2.5 命名关键字参数\"></a>2.5 命名关键字参数</h2><p>在定义了**kwargs参数后，函数调用者就可以传入任意的关键字参数key&#x3D;value，如果函数体代码的执行需要依赖某个key，必须在函数内进行判断</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">if</span> <span class=\"token string\">'sex'</span> <span class=\"token keyword\">in</span> kwargs<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token comment\">#有sex参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">if</span> <span class=\"token string\">'height'</span> <span class=\"token keyword\">in</span> kwargs<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token comment\">#有height参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>想要限定函数的调用者必须以key&#x3D;value的形式传值，Python3提供了专门的语法：需要在定义形参时，用<em>作为一个分隔符号，</em>号之后的形参称为命名关键字参数。对于这类参数，在函数调用时，必须按照key&#x3D;value的形式为其传值，且必须被传值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#sex,height为命名关键字参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#正确使用</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># TypeError:未使用关键字的形式为sex和height传值</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># TypeError没有为命名关键字参数height传值。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-536b4db7a18e1f39795a152f4c6249bb_720w.jpg\" alt=\"img\"></p>\n<p>命名关键字参数也可以有默认值，从而简化调用</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s,Age:%s,Sex:%s,Height:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span>\nName<span class=\"token punctuation\">:</span>lili<span class=\"token punctuation\">,</span>Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>Sex<span class=\"token punctuation\">:</span>male<span class=\"token punctuation\">,</span>Height<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>8m<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>需要强调的是：sex不是默认参数，height也不是位置参数，因为二者均在<em>后，所以都是命名关键字参数，形参sex&#x3D;’male’属于命名关键字参数的默认值，因而即便是放到形参height之前也不会有问题。另外，如果形参中已经有一个</em>args了，命名关键字参数就不再需要一个单独的*作为分隔符号了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>   <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s,Age:%s,Args:%s,Sex:%s,Height:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#sex与height仍为命名关键字参数</span>\nName<span class=\"token punctuation\">:</span>lili<span class=\"token punctuation\">,</span>Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>Args<span class=\"token punctuation\">:</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>Sex<span class=\"token punctuation\">:</span>male<span class=\"token punctuation\">,</span>Height<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>8m<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-daa2f3a7038bc4603a334da19e216dcf_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-f69da71d076e7119fd2ec2e84817dd6c_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-6-组合使用\"><a href=\"#2-6-组合使用\" class=\"headerlink\" title=\"2.6 组合使用\"></a>2.6 组合使用</h2><p>综上所述所有参数可任意组合使用，但定义顺序必须是：位置参数、默认参数、*args、命名关键字参数、**kwargs</p>\n<p>可变参数*args与关键字参数<strong>kwargs通常是组合在一起使用的，如果一个函数的形参为*args与</strong>kwargs，那么代表该函数可以接收任何形式、任意长度的参数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-8a33c0e3ae4f314dc75eca6250b66fe7_720w.jpg\" alt=\"img\"></p>\n<p>在该函数内部还可以把接收到的参数传给另外一个函数（这在4.6小节装饰器的实现中大有用处）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> wrapper<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>y<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span> <span class=\"token number\">2</span> <span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照上述写法，在为函数wrapper传参时，其实遵循的是函数func的参数规则，调用函数wrapper的过程分析如下：</p>\n<ol>\n<li>位置实参1被*接收，以元组的形式保存下来，赋值给args，即args&#x3D;(1,),关键字实参z&#x3D;3，y&#x3D;2被**接收，以字典的形式保存下来，赋值给kwargs，即kwargs&#x3D;{‘y’: 2, ‘z’: 3}</li>\n<li>执行func(<em>args,<em>kwargs),即func(</em>(1,),</em>* {‘y’: 2, ‘z’: 3}),等同于func(1,z&#x3D;3,y&#x3D;2)</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">提示： <span class=\"token operator\">*</span>args、<span class=\"token operator\">**</span>kwargs中的args和kwargs被替换成其他名字并无语法错误，但使用args、kwargs是约定俗成的。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-0064bdc3b1e3fd19d4240f375fecce8a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471/?p=40\">https://www.bilibili.com/video/av73342471/?p=40www.bilibili.com/video/av73342471/?p=40</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=41\">https://www.bilibili.com/video/av73342471?p=41www.bilibili.com/video/av73342471?p=41</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=42\">https://www.bilibili.com/video/av73342471?p=42www.bilibili.com/video/av73342471?p=42</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-形参与实参介绍\"><a href=\"#一-形参与实参介绍\" class=\"headerlink\" title=\"一 形参与实参介绍\"></a>一 形参与实参介绍</h2><p><img src=\"https://pic2.zhimg.com/80/v2-3be956bc3ace8da945af47995ea41b19_720w.jpg\" alt=\"img\"></p>\n<p>函数的参数分为形式参数和实际参数，简称形参和实参：</p>\n<p>形参即在定义函数时，括号内声明的参数。形参本质就是一个变量名，用来接收外部传来的值。</p>\n<p>实参即在调用函数时，括号内传入的值，值可以是常量、变量、表达式或三者的组合:</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\">#1：实参是常量</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#2：实参是变量</span>\na<span class=\"token operator\">=</span><span class=\"token number\">1</span>\nb<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span>b<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#3：实参是表达式</span>\nres<span class=\"token operator\">=</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token operator\">*</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#4：实参可以是常量、变量、表达式的任意组合</span>\na<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nmy_min<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>a<span class=\"token punctuation\">,</span><span class=\"token number\">10</span><span class=\"token operator\">*</span>my_min<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在调用有参函数时，实参（值）会赋值给形参（变量名）。在Python中，变量名与值只是单纯的绑定关系，而对于函数来说，这种绑定关系只在函数调用时生效，在调用结束后解除。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-b0036c8f8942a558d95a3200f38338d1_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-形参与实参的具体使用\"><a href=\"#二-形参与实参的具体使用\" class=\"headerlink\" title=\"二 形参与实参的具体使用\"></a>二 形参与实参的具体使用</h2><h2 id=\"2-1-位置参数\"><a href=\"#2-1-位置参数\" class=\"headerlink\" title=\"2.1 位置参数\"></a>2.1 位置参数</h2><p>位置即顺序，位置参数指的是按顺序定义的参数，需要从两个角度去看：</p>\n<ol>\n<li>在定义函数时，按照从左到右的顺序依次定义形参,称为位置形参，凡是按照这种形式定义的形参都必须被传值</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#定义位置形参：name，age，sex，三者都必须被传值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nregister<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：缺少3个位置参数 </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>在调用函数时，按照从左到右的顺序依次定义实参，称为位置实参，凡是按照这种形式定义的实参会按照从左到右的顺序与形参一一对应</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#定义位置形参：name，age，sex，三者都必须被传值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nregister<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：缺少3个位置参数</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-1152d1943f7d6b217981965ad5d2b8be_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-关键字参数\"><a href=\"#2-2-关键字参数\" class=\"headerlink\" title=\"2.2 关键字参数\"></a>2.2 关键字参数</h2><p>在调用函数时，实参可以是key&#x3D;value的形式，称为关键字参数，凡是按照这种形式定义的实参，可以完全不按照从左到右的顺序定义，但仍能为指定的形参赋值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span>\nName<span class=\"token punctuation\">:</span>lili Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span> Sex<span class=\"token punctuation\">:</span>male<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>需要注意在调用函数时，实参也可以是按位置或按关键字的混合使用，但必须保证关键字参数在位置参数后面，且不可以对一个形参重复赋值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#正确使用</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#SyntaxError：关键字参数name=‘lili’在位置参数18之前</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>age<span class=\"token operator\">=</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>name<span class=\"token operator\">=</span><span class=\"token string\">'jack'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError：形参name被重复赋值</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-751903e8073067049e6c42c5196754fe_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-3-默认参数\"><a href=\"#2-3-默认参数\" class=\"headerlink\" title=\"2.3 默认参数\"></a>2.3 默认参数</h2><p>在定义函数时，就已经为形参赋值，这类形参称之为默认参数，当函数有多个参数时，需要将值经常改变的参数定义成位置参数，而将值改变较少的参数定义成默认参数。例如编写一个注册学生信息的函数，如果大多数学生的性别都为男，那完全可以将形参sex定义成默认参数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#默认sex的值为male</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s Age:%s Sex:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>定义时就已经为参数sex赋值，意味着调用时可以不对sex赋值，这降低了函数调用的复杂度</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'tom'</span><span class=\"token punctuation\">,</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#大多数情况,无需为sex传值,默认为male</span>\nName<span class=\"token punctuation\">:</span>tom Age<span class=\"token punctuation\">:</span><span class=\"token number\">17</span> Sex<span class=\"token punctuation\">:</span>male\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'Lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'female'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#少数情况,可以为sex传值female</span>\nName<span class=\"token punctuation\">:</span>Lili Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span> Sex<span class=\"token punctuation\">:</span>female<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-85c49040b5ca19b0a6cd236d6a335d21_720w.jpg\" alt=\"img\"></p>\n<p>需要注意：</p>\n<ol>\n<li>默认参数必须在位置参数之后</li>\n<li>默认参数的值仅在函数定义阶段被赋值一次</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>arg<span class=\"token operator\">=</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> x<span class=\"token operator\">=</span><span class=\"token number\">5</span> <span class=\"token comment\">#定义阶段arg已被赋值为1，此处的修改与默认参数arg无任何关系</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ol>\n<li>默认参数的值通常应设为不可变类型</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span>arg<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>    \n     arg<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span>    \n     <span class=\"token keyword\">return</span> arg    \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>每次调用是在上一次的基础上向同一列表增加值，修改如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">,</span>arg<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>    \n     <span class=\"token keyword\">if</span> arg <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>    \n         arg<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>    \n     arg<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span>    \n     <span class=\"token keyword\">return</span> arg    \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> \nfoo<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>    \n<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-c48b74c4968b946d68531c2ef2c1b40e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-4-可变长度的参数（-与-的用法）\"><a href=\"#2-4-可变长度的参数（-与-的用法）\" class=\"headerlink\" title=\"2.4 可变长度的参数（*与**的用法）\"></a>2.4 可变长度的参数（*与**的用法）</h2><p><img src=\"https://pic2.zhimg.com/80/v2-ac1ed3f13dbd9fea9e3c5cfbb1047611_720w.jpg\" alt=\"img\"></p>\n<p>参数的长度可变指的是在调用函数时，实参的个数可以不固定，而在调用函数时，实参的定义无非是按位置或者按关键字两种形式，这就要求形参提供两种解决方案来分别处理两种形式的可变长度的参数</p>\n<h3 id=\"2-4-1-可变长度的位置参数\"><a href=\"#2-4-1-可变长度的位置参数\" class=\"headerlink\" title=\"2.4.1 可变长度的位置参数\"></a>2.4.1 可变长度的位置参数</h3><p>如果在最后一个形参名前加<em>号,那么在调用函数时，溢出的位置实参，都会被</em>接收，以元组的形式保存下来赋值给该形参</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#在最后一个形参名args前加*号</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">#实参1、2、3按位置为形参x、y、z赋值，多余的位置实参4、5、6、7都被*接收，以元组的形式保存下来，赋值给args，即args=(4, 5, 6,7)</span>\n\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们事先生成了一个列表,仍然是可以传值给*args的</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> L<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>L<span class=\"token punctuation\">)</span> <span class=\"token comment\"># *L就相当于位置参数3，4，5, foo(1,2,*L)就等同于foo(1,2,3,4,5)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-e73cc42b02d988741717036dab3ef3d8_720w.jpg\" alt=\"img\"></p>\n<p>注意：如果在传入L时没有加*,那L就只是一个普通的位置参数了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>L<span class=\"token punctuation\">)</span> <span class=\"token comment\">#仅多出一个位置实参L</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果形参为常规的参数（位置或默认），实参仍可以是*的形式</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#等同于foo(1,2)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们想要求多个值的和，*args就派上用场了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     res<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> args<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         res<span class=\"token operator\">+=</span>i\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> res\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> add<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">15</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-8996656ee55ad76ec5b15628a8044140_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"2-4-2-可变长度的关键字参数\"><a href=\"#2-4-2-可变长度的关键字参数\" class=\"headerlink\" title=\"2.4.2 可变长度的关键字参数\"></a>2.4.2 可变长度的关键字参数</h3><p>如果在最后一个形参名前加<strong>号,那么在调用函数时，溢出的关键字参数，都会被</strong>接收，以字典的形式保存下来赋值给该形参</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#在最后一个参数kwargs前加**</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>        \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>kwargs<span class=\"token punctuation\">)</span>   \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span>y<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>x<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#溢出的关键字实参y=2，z=3都被**接收，以字典的形式保存下来，赋值给kwargs</span>\n<span class=\"token number\">1</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'z'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'y'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们事先生成了一个字典,仍然是可以传值给**kwargs的</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>kwargs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>dic<span class=\"token punctuation\">)</span> <span class=\"token comment\">#**dic就相当于关键字参数a=1，b=2，foo(1,2,**dic)等同foo(1,2,a=1,b=2)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'b'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-b4374327737ac837551b67f7813666e8_720w.jpg\" alt=\"img\"></p>\n<p>注意：如果在传入dic时没有加**,那dic就只是一个普通的位置参数了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>dic<span class=\"token punctuation\">)</span> <span class=\"token comment\">#TypeError:函数foo只需要2个位置参数，但是传了3个</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>如果形参为常规参数（位置或默认），实参仍可以是**的形式</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'x'</span><span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token string\">'y'</span><span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#等同于foo(y=2,x=1)</span>\n<span class=\"token number\">1</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们要编写一个用户认证的函数，起初可能只基于用户名密码的验证就可以了，可以使用**kwargs为日后的扩展供良好的环境，同时保持了函数的简洁性。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">,</span>password<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span> \n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"2-5-命名关键字参数\"><a href=\"#2-5-命名关键字参数\" class=\"headerlink\" title=\"2.5 命名关键字参数\"></a>2.5 命名关键字参数</h2><p>在定义了**kwargs参数后，函数调用者就可以传入任意的关键字参数key&#x3D;value，如果函数体代码的执行需要依赖某个key，必须在函数内进行判断</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">if</span> <span class=\"token string\">'sex'</span> <span class=\"token keyword\">in</span> kwargs<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token comment\">#有sex参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">if</span> <span class=\"token string\">'height'</span> <span class=\"token keyword\">in</span> kwargs<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token comment\">#有height参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>想要限定函数的调用者必须以key&#x3D;value的形式传值，Python3提供了专门的语法：需要在定义形参时，用<em>作为一个分隔符号，</em>号之后的形参称为命名关键字参数。对于这类参数，在函数调用时，必须按照key&#x3D;value的形式为其传值，且必须被传值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#sex,height为命名关键字参数</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#正确使用</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># TypeError:未使用关键字的形式为sex和height传值</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># TypeError没有为命名关键字参数height传值。</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-536b4db7a18e1f39795a152f4c6249bb_720w.jpg\" alt=\"img\"></p>\n<p>命名关键字参数也可以有默认值，从而简化调用</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span><span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s,Age:%s,Sex:%s,Height:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span>\nName<span class=\"token punctuation\">:</span>lili<span class=\"token punctuation\">,</span>Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>Sex<span class=\"token punctuation\">:</span>male<span class=\"token punctuation\">,</span>Height<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>8m<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>需要强调的是：sex不是默认参数，height也不是位置参数，因为二者均在<em>后，所以都是命名关键字参数，形参sex&#x3D;’male’属于命名关键字参数的默认值，因而即便是放到形参height之前也不会有问题。另外，如果形参中已经有一个</em>args了，命名关键字参数就不再需要一个单独的*作为分隔符号了</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">register</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span>sex<span class=\"token operator\">=</span><span class=\"token string\">'male'</span><span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>   <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Name:%s,Age:%s,Args:%s,Sex:%s,Height:%s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span>age<span class=\"token punctuation\">,</span>args<span class=\"token punctuation\">,</span>sex<span class=\"token punctuation\">,</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> register<span class=\"token punctuation\">(</span><span class=\"token string\">'lili'</span><span class=\"token punctuation\">,</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>height<span class=\"token operator\">=</span><span class=\"token string\">'1.8m'</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#sex与height仍为命名关键字参数</span>\nName<span class=\"token punctuation\">:</span>lili<span class=\"token punctuation\">,</span>Age<span class=\"token punctuation\">:</span><span class=\"token number\">18</span><span class=\"token punctuation\">,</span>Args<span class=\"token punctuation\">:</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>Sex<span class=\"token punctuation\">:</span>male<span class=\"token punctuation\">,</span>Height<span class=\"token punctuation\">:</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span>8m<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-daa2f3a7038bc4603a334da19e216dcf_720w.jpg\" alt=\"img\"></p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-f69da71d076e7119fd2ec2e84817dd6c_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-6-组合使用\"><a href=\"#2-6-组合使用\" class=\"headerlink\" title=\"2.6 组合使用\"></a>2.6 组合使用</h2><p>综上所述所有参数可任意组合使用，但定义顺序必须是：位置参数、默认参数、*args、命名关键字参数、**kwargs</p>\n<p>可变参数*args与关键字参数<strong>kwargs通常是组合在一起使用的，如果一个函数的形参为*args与</strong>kwargs，那么代表该函数可以接收任何形式、任意长度的参数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">pass</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-8a33c0e3ae4f314dc75eca6250b66fe7_720w.jpg\" alt=\"img\"></p>\n<p>在该函数内部还可以把接收到的参数传给另外一个函数（这在4.6小节装饰器的实现中大有用处）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">func</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>z<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> wrapper<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>z<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>y<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span> <span class=\"token number\">2</span> <span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照上述写法，在为函数wrapper传参时，其实遵循的是函数func的参数规则，调用函数wrapper的过程分析如下：</p>\n<ol>\n<li>位置实参1被*接收，以元组的形式保存下来，赋值给args，即args&#x3D;(1,),关键字实参z&#x3D;3，y&#x3D;2被**接收，以字典的形式保存下来，赋值给kwargs，即kwargs&#x3D;{‘y’: 2, ‘z’: 3}</li>\n<li>执行func(<em>args,<em>kwargs),即func(</em>(1,),</em>* {‘y’: 2, ‘z’: 3}),等同于func(1,z&#x3D;3,y&#x3D;2)</li>\n</ol>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">提示： <span class=\"token operator\">*</span>args、<span class=\"token operator\">**</span>kwargs中的args和kwargs被替换成其他名字并无语法错误，但使用args、kwargs是约定俗成的。<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-0064bdc3b1e3fd19d4240f375fecce8a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471/?p=40\">https://www.bilibili.com/video/av73342471/?p=40www.bilibili.com/video/av73342471/?p=40</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=41\">https://www.bilibili.com/video/av73342471?p=41www.bilibili.com/video/av73342471?p=41</a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=42\">https://www.bilibili.com/video/av73342471?p=42www.bilibili.com/video/av73342471?p=42</a></p>\n"},{"_content":"## 一 名称空间\n\n名称空间即存放名字与对象映射/绑定关系的地方。对于x=3，Python会申请内存空间存放对象3，然后将名字x与3的绑定关系存放于名称空间中，del x表示清除该绑定关系。\n\n 在程序执行期间最多会存在三种名称空间\n\n![img](https://pic2.zhimg.com/80/v2-596e030156bc539213fb080d356ca1d9_720w.jpg)\n\n## 1.1 内建名称空间\n\n伴随python解释器的启动/关闭而产生/回收，因而是第一个被加载的名称空间，用来存放一些内置的名字，比如内建函数名\n\n```python\n>>> max\n<built-in function max> #built-in内建\n```\n\n![img](https://pic3.zhimg.com/80/v2-6b1e7070c484f0d266dcfdc04ebf265a_720w.jpg)\n\n## 1.2 全局名称空间\n\n伴随python文件的开始执行/执行完毕而产生/回收，是第二个被加载的名称空间，文件执行过程中产生的名字都会存放于该名称空间中，如下名字\n\n```python\nimport sys #模块名sys\n\nx=1 #变量名x\n\nif x == 1:\n    y=2 #变量名y\n\ndef foo(x): #函数名foo\n    y=1\n    def bar():\n        pass\n\nClass Bar: #类名Bar\n    pass\n```\n\n![img](https://pic2.zhimg.com/80/v2-2def7f8d2d87802b200813e691a5acfd_720w.jpg)\n\n## 1.3 局部名称空间\n\n伴随函数的调用/结束而临时产生/回收，函数的形参、函数内定义的名字都会被存放于该名称空间中\n\n```python\ndef foo(x):\n    y=3 #调用函数时，才会执行函数代码，名字x和y都存放于该函数的局部名称空间中\n```\n\n名称空间的加载顺序是：内置名称空间->全局名称空间->局部名称空间，而查找一个名字，必须从三个名称空间之一找到，查找顺序为：局部名称空间->全局名称空间->内置名称空间。\n\n![img](https://pic1.zhimg.com/80/v2-521d2bf3131371f8d2656b184ad17798_720w.jpg)\n\n## 二 作用域\n\n## 2.1 全局作用域与局部作用域\n\n按照名字作用范围的不同可以将三个名称空间划分为两个区域：\n\n1. 全局作用域:位于全局名称空间、内建名称空间中的名字属于全局范围，该范围内的名字全局存活（除非被删除，否则在整个文件执行过程中存活）、全局有效（在任意位置都可以使用）；\n2. 局部作用域:位于局部名称空间中的名字属于局部范围。该范围内的名字临时存活（即在函数调用时临时生成，函数调用结束后就释放）、局部有效（只能在函数内使用）。\n\n![img](https://pic4.zhimg.com/80/v2-c7c952d4554d6db0cf46305be525bafb_720w.jpg)\n\n## 2.2 作用域与名字查找的优先级\n\n 在局部作用域查找名字时，起始位置是局部作用域，所以先查找局部名称空间，没有找到，再去全局作用域查找：先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常\n\n```python\nx=100 #全局作用域的名字x\ndef foo():\n    x=300 #局部作用域的名字x\n    print(x) #在局部找x\nfoo()#结果为300\n```\n\n在全局作用域查找名字时，起始位置便是全局作用域，所以先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常\n\n```python\nx=100\ndef foo():\n    x=300 #在函数调用时产生局部作用域的名字x\nfoo()\nprint(x) #在全局找x,结果为100\n```\n\n提示：可以调用内建函数locals()和globals()来分别查看局部作用域和全局作用域的名字，查看的结果都是字典格式。在全局作用域查看到的locals()的结果等于globals()\n\n![img](https://pic3.zhimg.com/80/v2-7adbbd64e5216724e7933789054d0f1e_720w.jpg)\n\nPython支持函数的嵌套定义，在内嵌的函数内查找名字时，会优先查找自己局部作用域的名字，然后由内而外一层层查找外部嵌套函数定义的作用域，没有找到，则查找全局作用域\n\n```python\nx=1\ndef outer():\n    x=2\n    def inner(): # 函数名inner属于outer这一层作用域的名字\n        x=3\n        print('inner x:%s' %x)\n\n    inner()\n    print('outer x:%s' %x)\n\nouter() \n#结果为\ninner x:3\nouter x:2\n```\n\n在函数内，无论嵌套多少层，都可以查看到全局作用域的名字，若要在函数内修改全局名称空间中名字的值，当值为不可变类型时，则需要用到global关键字\n\n```python\nx=1\ndef foo():\n    global x #声明x为全局名称空间的名字\n    x=2\nfoo()\nprint(x) #结果为2\n```\n\n当实参的值为可变类型时，函数体内对该值的修改将直接反应到原值，\n\n```python\nnum_list=[1,2,3]\ndef foo(nums):\n    nums.append(5)\n\nfoo(num_list)\nprint(num_list)\n#结果为\n[1, 2, 3, 5]\n```\n\n对于嵌套多层的函数，使用nonlocal关键字可以将名字声明为来自外部嵌套函数定义的作用域（非全局）\n\n```python\ndef  f1():\n    x=2\n    def f2():\n        nonlocal x\n        x=3\n    f2() #调用f2(),修改f1作用域中名字x的值\n    print(x) #在f1作用域查看x\n\nf1()\n\n#结果\n3\n```\n\nnonlocal x会从当前函数的外层函数开始一层层去查找名字x，若是一直到最外层函数都找不到，则会抛出异常。\n\n![img](https://pic2.zhimg.com/80/v2-632ec1c5586b42b1b603268097360c35_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471/?p=45www.bilibili.com/video/av73342471/?p=45](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471/%3Fp%3D45)","source":"_posts/03_Python/01_Python基础/13_名称空间与作用域.md","raw":"## 一 名称空间\n\n名称空间即存放名字与对象映射/绑定关系的地方。对于x=3，Python会申请内存空间存放对象3，然后将名字x与3的绑定关系存放于名称空间中，del x表示清除该绑定关系。\n\n 在程序执行期间最多会存在三种名称空间\n\n![img](https://pic2.zhimg.com/80/v2-596e030156bc539213fb080d356ca1d9_720w.jpg)\n\n## 1.1 内建名称空间\n\n伴随python解释器的启动/关闭而产生/回收，因而是第一个被加载的名称空间，用来存放一些内置的名字，比如内建函数名\n\n```python\n>>> max\n<built-in function max> #built-in内建\n```\n\n![img](https://pic3.zhimg.com/80/v2-6b1e7070c484f0d266dcfdc04ebf265a_720w.jpg)\n\n## 1.2 全局名称空间\n\n伴随python文件的开始执行/执行完毕而产生/回收，是第二个被加载的名称空间，文件执行过程中产生的名字都会存放于该名称空间中，如下名字\n\n```python\nimport sys #模块名sys\n\nx=1 #变量名x\n\nif x == 1:\n    y=2 #变量名y\n\ndef foo(x): #函数名foo\n    y=1\n    def bar():\n        pass\n\nClass Bar: #类名Bar\n    pass\n```\n\n![img](https://pic2.zhimg.com/80/v2-2def7f8d2d87802b200813e691a5acfd_720w.jpg)\n\n## 1.3 局部名称空间\n\n伴随函数的调用/结束而临时产生/回收，函数的形参、函数内定义的名字都会被存放于该名称空间中\n\n```python\ndef foo(x):\n    y=3 #调用函数时，才会执行函数代码，名字x和y都存放于该函数的局部名称空间中\n```\n\n名称空间的加载顺序是：内置名称空间->全局名称空间->局部名称空间，而查找一个名字，必须从三个名称空间之一找到，查找顺序为：局部名称空间->全局名称空间->内置名称空间。\n\n![img](https://pic1.zhimg.com/80/v2-521d2bf3131371f8d2656b184ad17798_720w.jpg)\n\n## 二 作用域\n\n## 2.1 全局作用域与局部作用域\n\n按照名字作用范围的不同可以将三个名称空间划分为两个区域：\n\n1. 全局作用域:位于全局名称空间、内建名称空间中的名字属于全局范围，该范围内的名字全局存活（除非被删除，否则在整个文件执行过程中存活）、全局有效（在任意位置都可以使用）；\n2. 局部作用域:位于局部名称空间中的名字属于局部范围。该范围内的名字临时存活（即在函数调用时临时生成，函数调用结束后就释放）、局部有效（只能在函数内使用）。\n\n![img](https://pic4.zhimg.com/80/v2-c7c952d4554d6db0cf46305be525bafb_720w.jpg)\n\n## 2.2 作用域与名字查找的优先级\n\n 在局部作用域查找名字时，起始位置是局部作用域，所以先查找局部名称空间，没有找到，再去全局作用域查找：先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常\n\n```python\nx=100 #全局作用域的名字x\ndef foo():\n    x=300 #局部作用域的名字x\n    print(x) #在局部找x\nfoo()#结果为300\n```\n\n在全局作用域查找名字时，起始位置便是全局作用域，所以先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常\n\n```python\nx=100\ndef foo():\n    x=300 #在函数调用时产生局部作用域的名字x\nfoo()\nprint(x) #在全局找x,结果为100\n```\n\n提示：可以调用内建函数locals()和globals()来分别查看局部作用域和全局作用域的名字，查看的结果都是字典格式。在全局作用域查看到的locals()的结果等于globals()\n\n![img](https://pic3.zhimg.com/80/v2-7adbbd64e5216724e7933789054d0f1e_720w.jpg)\n\nPython支持函数的嵌套定义，在内嵌的函数内查找名字时，会优先查找自己局部作用域的名字，然后由内而外一层层查找外部嵌套函数定义的作用域，没有找到，则查找全局作用域\n\n```python\nx=1\ndef outer():\n    x=2\n    def inner(): # 函数名inner属于outer这一层作用域的名字\n        x=3\n        print('inner x:%s' %x)\n\n    inner()\n    print('outer x:%s' %x)\n\nouter() \n#结果为\ninner x:3\nouter x:2\n```\n\n在函数内，无论嵌套多少层，都可以查看到全局作用域的名字，若要在函数内修改全局名称空间中名字的值，当值为不可变类型时，则需要用到global关键字\n\n```python\nx=1\ndef foo():\n    global x #声明x为全局名称空间的名字\n    x=2\nfoo()\nprint(x) #结果为2\n```\n\n当实参的值为可变类型时，函数体内对该值的修改将直接反应到原值，\n\n```python\nnum_list=[1,2,3]\ndef foo(nums):\n    nums.append(5)\n\nfoo(num_list)\nprint(num_list)\n#结果为\n[1, 2, 3, 5]\n```\n\n对于嵌套多层的函数，使用nonlocal关键字可以将名字声明为来自外部嵌套函数定义的作用域（非全局）\n\n```python\ndef  f1():\n    x=2\n    def f2():\n        nonlocal x\n        x=3\n    f2() #调用f2(),修改f1作用域中名字x的值\n    print(x) #在f1作用域查看x\n\nf1()\n\n#结果\n3\n```\n\nnonlocal x会从当前函数的外层函数开始一层层去查找名字x，若是一直到最外层函数都找不到，则会抛出异常。\n\n![img](https://pic2.zhimg.com/80/v2-632ec1c5586b42b1b603268097360c35_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471/?p=45www.bilibili.com/video/av73342471/?p=45](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471/%3Fp%3D45)","slug":"03_Python/01_Python基础/13_名称空间与作用域","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k16002aa8v7f1h81jv9","content":"<h2 id=\"一-名称空间\"><a href=\"#一-名称空间\" class=\"headerlink\" title=\"一 名称空间\"></a>一 名称空间</h2><p>名称空间即存放名字与对象映射&#x2F;绑定关系的地方。对于x&#x3D;3，Python会申请内存空间存放对象3，然后将名字x与3的绑定关系存放于名称空间中，del x表示清除该绑定关系。</p>\n<p> 在程序执行期间最多会存在三种名称空间</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-596e030156bc539213fb080d356ca1d9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-内建名称空间\"><a href=\"#1-1-内建名称空间\" class=\"headerlink\" title=\"1.1 内建名称空间\"></a>1.1 内建名称空间</h2><p>伴随python解释器的启动&#x2F;关闭而产生&#x2F;回收，因而是第一个被加载的名称空间，用来存放一些内置的名字，比如内建函数名</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">max</span>\n<span class=\"token operator\">&lt;</span>built<span class=\"token operator\">-</span><span class=\"token keyword\">in</span> function <span class=\"token builtin\">max</span><span class=\"token operator\">></span> <span class=\"token comment\">#built-in内建</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-6b1e7070c484f0d266dcfdc04ebf265a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-2-全局名称空间\"><a href=\"#1-2-全局名称空间\" class=\"headerlink\" title=\"1.2 全局名称空间\"></a>1.2 全局名称空间</h2><p>伴随python文件的开始执行&#x2F;执行完毕而产生&#x2F;回收，是第二个被加载的名称空间，文件执行过程中产生的名字都会存放于该名称空间中，如下名字</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys <span class=\"token comment\">#模块名sys</span>\n\nx<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token comment\">#变量名x</span>\n\n<span class=\"token keyword\">if</span> x <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token comment\">#变量名y</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#函数名foo</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span>\n\nClass <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#类名Bar</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-2def7f8d2d87802b200813e691a5acfd_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-3-局部名称空间\"><a href=\"#1-3-局部名称空间\" class=\"headerlink\" title=\"1.3 局部名称空间\"></a>1.3 局部名称空间</h2><p>伴随函数的调用&#x2F;结束而临时产生&#x2F;回收，函数的形参、函数内定义的名字都会被存放于该名称空间中</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token comment\">#调用函数时，才会执行函数代码，名字x和y都存放于该函数的局部名称空间中</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>名称空间的加载顺序是：内置名称空间-&gt;全局名称空间-&gt;局部名称空间，而查找一个名字，必须从三个名称空间之一找到，查找顺序为：局部名称空间-&gt;全局名称空间-&gt;内置名称空间。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-521d2bf3131371f8d2656b184ad17798_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-作用域\"><a href=\"#二-作用域\" class=\"headerlink\" title=\"二 作用域\"></a>二 作用域</h2><h2 id=\"2-1-全局作用域与局部作用域\"><a href=\"#2-1-全局作用域与局部作用域\" class=\"headerlink\" title=\"2.1 全局作用域与局部作用域\"></a>2.1 全局作用域与局部作用域</h2><p>按照名字作用范围的不同可以将三个名称空间划分为两个区域：</p>\n<ol>\n<li>全局作用域:位于全局名称空间、内建名称空间中的名字属于全局范围，该范围内的名字全局存活（除非被删除，否则在整个文件执行过程中存活）、全局有效（在任意位置都可以使用）；</li>\n<li>局部作用域:位于局部名称空间中的名字属于局部范围。该范围内的名字临时存活（即在函数调用时临时生成，函数调用结束后就释放）、局部有效（只能在函数内使用）。</li>\n</ol>\n<p><img src=\"https://pic4.zhimg.com/80/v2-c7c952d4554d6db0cf46305be525bafb_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-作用域与名字查找的优先级\"><a href=\"#2-2-作用域与名字查找的优先级\" class=\"headerlink\" title=\"2.2 作用域与名字查找的优先级\"></a>2.2 作用域与名字查找的优先级</h2><p> 在局部作用域查找名字时，起始位置是局部作用域，所以先查找局部名称空间，没有找到，再去全局作用域查找：先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">100</span> <span class=\"token comment\">#全局作用域的名字x</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">300</span> <span class=\"token comment\">#局部作用域的名字x</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在局部找x</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#结果为300</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在全局作用域查找名字时，起始位置便是全局作用域，所以先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">100</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">300</span> <span class=\"token comment\">#在函数调用时产生局部作用域的名字x</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在全局找x,结果为100</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示：可以调用内建函数locals()和globals()来分别查看局部作用域和全局作用域的名字，查看的结果都是字典格式。在全局作用域查看到的locals()的结果等于globals()</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-7adbbd64e5216724e7933789054d0f1e_720w.jpg\" alt=\"img\"></p>\n<p>Python支持函数的嵌套定义，在内嵌的函数内查找名字时，会优先查找自己局部作用域的名字，然后由内而外一层层查找外部嵌套函数定义的作用域，没有找到，则查找全局作用域</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">outer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">inner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 函数名inner属于outer这一层作用域的名字</span>\n        x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'inner x:%s'</span> <span class=\"token operator\">%</span>x<span class=\"token punctuation\">)</span>\n\n    inner<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'outer x:%s'</span> <span class=\"token operator\">%</span>x<span class=\"token punctuation\">)</span>\n\nouter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n<span class=\"token comment\">#结果为</span>\ninner x<span class=\"token punctuation\">:</span><span class=\"token number\">3</span>\nouter x<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在函数内，无论嵌套多少层，都可以查看到全局作用域的名字，若要在函数内修改全局名称空间中名字的值，当值为不可变类型时，则需要用到global关键字</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> x <span class=\"token comment\">#声明x为全局名称空间的名字</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#结果为2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>当实参的值为可变类型时，函数体内对该值的修改将直接反应到原值，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">num_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    nums<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\nfoo<span class=\"token punctuation\">(</span>num_list<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>num_list<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#结果为</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>对于嵌套多层的函数，使用nonlocal关键字可以将名字声明为来自外部嵌套函数定义的作用域（非全局）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span>  <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">nonlocal</span> x\n        x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n    f2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#调用f2(),修改f1作用域中名字x的值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在f1作用域查看x</span>\n\nf1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#结果</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>nonlocal x会从当前函数的外层函数开始一层层去查找名字x，若是一直到最外层函数都找不到，则会抛出异常。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-632ec1c5586b42b1b603268097360c35_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471/?p=45\">https://www.bilibili.com/video/av73342471/?p=45www.bilibili.com/video/av73342471/?p=45</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-名称空间\"><a href=\"#一-名称空间\" class=\"headerlink\" title=\"一 名称空间\"></a>一 名称空间</h2><p>名称空间即存放名字与对象映射&#x2F;绑定关系的地方。对于x&#x3D;3，Python会申请内存空间存放对象3，然后将名字x与3的绑定关系存放于名称空间中，del x表示清除该绑定关系。</p>\n<p> 在程序执行期间最多会存在三种名称空间</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-596e030156bc539213fb080d356ca1d9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-内建名称空间\"><a href=\"#1-1-内建名称空间\" class=\"headerlink\" title=\"1.1 内建名称空间\"></a>1.1 内建名称空间</h2><p>伴随python解释器的启动&#x2F;关闭而产生&#x2F;回收，因而是第一个被加载的名称空间，用来存放一些内置的名字，比如内建函数名</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">max</span>\n<span class=\"token operator\">&lt;</span>built<span class=\"token operator\">-</span><span class=\"token keyword\">in</span> function <span class=\"token builtin\">max</span><span class=\"token operator\">></span> <span class=\"token comment\">#built-in内建</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-6b1e7070c484f0d266dcfdc04ebf265a_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-2-全局名称空间\"><a href=\"#1-2-全局名称空间\" class=\"headerlink\" title=\"1.2 全局名称空间\"></a>1.2 全局名称空间</h2><p>伴随python文件的开始执行&#x2F;执行完毕而产生&#x2F;回收，是第二个被加载的名称空间，文件执行过程中产生的名字都会存放于该名称空间中，如下名字</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> sys <span class=\"token comment\">#模块名sys</span>\n\nx<span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token comment\">#变量名x</span>\n\n<span class=\"token keyword\">if</span> x <span class=\"token operator\">==</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token comment\">#变量名y</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#函数名foo</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">pass</span>\n\nClass <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">#类名Bar</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-2def7f8d2d87802b200813e691a5acfd_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-3-局部名称空间\"><a href=\"#1-3-局部名称空间\" class=\"headerlink\" title=\"1.3 局部名称空间\"></a>1.3 局部名称空间</h2><p>伴随函数的调用&#x2F;结束而临时产生&#x2F;回收，函数的形参、函数内定义的名字都会被存放于该名称空间中</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    y<span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token comment\">#调用函数时，才会执行函数代码，名字x和y都存放于该函数的局部名称空间中</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>名称空间的加载顺序是：内置名称空间-&gt;全局名称空间-&gt;局部名称空间，而查找一个名字，必须从三个名称空间之一找到，查找顺序为：局部名称空间-&gt;全局名称空间-&gt;内置名称空间。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-521d2bf3131371f8d2656b184ad17798_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-作用域\"><a href=\"#二-作用域\" class=\"headerlink\" title=\"二 作用域\"></a>二 作用域</h2><h2 id=\"2-1-全局作用域与局部作用域\"><a href=\"#2-1-全局作用域与局部作用域\" class=\"headerlink\" title=\"2.1 全局作用域与局部作用域\"></a>2.1 全局作用域与局部作用域</h2><p>按照名字作用范围的不同可以将三个名称空间划分为两个区域：</p>\n<ol>\n<li>全局作用域:位于全局名称空间、内建名称空间中的名字属于全局范围，该范围内的名字全局存活（除非被删除，否则在整个文件执行过程中存活）、全局有效（在任意位置都可以使用）；</li>\n<li>局部作用域:位于局部名称空间中的名字属于局部范围。该范围内的名字临时存活（即在函数调用时临时生成，函数调用结束后就释放）、局部有效（只能在函数内使用）。</li>\n</ol>\n<p><img src=\"https://pic4.zhimg.com/80/v2-c7c952d4554d6db0cf46305be525bafb_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-作用域与名字查找的优先级\"><a href=\"#2-2-作用域与名字查找的优先级\" class=\"headerlink\" title=\"2.2 作用域与名字查找的优先级\"></a>2.2 作用域与名字查找的优先级</h2><p> 在局部作用域查找名字时，起始位置是局部作用域，所以先查找局部名称空间，没有找到，再去全局作用域查找：先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">100</span> <span class=\"token comment\">#全局作用域的名字x</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">300</span> <span class=\"token comment\">#局部作用域的名字x</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在局部找x</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token comment\">#结果为300</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在全局作用域查找名字时，起始位置便是全局作用域，所以先查找全局名称空间，没有找到，再查找内置名称空间，最后都没有找到就会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">100</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">300</span> <span class=\"token comment\">#在函数调用时产生局部作用域的名字x</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在全局找x,结果为100</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示：可以调用内建函数locals()和globals()来分别查看局部作用域和全局作用域的名字，查看的结果都是字典格式。在全局作用域查看到的locals()的结果等于globals()</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-7adbbd64e5216724e7933789054d0f1e_720w.jpg\" alt=\"img\"></p>\n<p>Python支持函数的嵌套定义，在内嵌的函数内查找名字时，会优先查找自己局部作用域的名字，然后由内而外一层层查找外部嵌套函数定义的作用域，没有找到，则查找全局作用域</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">outer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">inner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 函数名inner属于outer这一层作用域的名字</span>\n        x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'inner x:%s'</span> <span class=\"token operator\">%</span>x<span class=\"token punctuation\">)</span>\n\n    inner<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'outer x:%s'</span> <span class=\"token operator\">%</span>x<span class=\"token punctuation\">)</span>\n\nouter<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n<span class=\"token comment\">#结果为</span>\ninner x<span class=\"token punctuation\">:</span><span class=\"token number\">3</span>\nouter x<span class=\"token punctuation\">:</span><span class=\"token number\">2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>在函数内，无论嵌套多少层，都可以查看到全局作用域的名字，若要在函数内修改全局名称空间中名字的值，当值为不可变类型时，则需要用到global关键字</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> x <span class=\"token comment\">#声明x为全局名称空间的名字</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nfoo<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#结果为2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>当实参的值为可变类型时，函数体内对该值的修改将直接反应到原值，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">num_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    nums<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\nfoo<span class=\"token punctuation\">(</span>num_list<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>num_list<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#结果为</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>对于嵌套多层的函数，使用nonlocal关键字可以将名字声明为来自外部嵌套函数定义的作用域（非全局）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span>  <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">nonlocal</span> x\n        x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n    f2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#调用f2(),修改f1作用域中名字x的值</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span> <span class=\"token comment\">#在f1作用域查看x</span>\n\nf1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#结果</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>nonlocal x会从当前函数的外层函数开始一层层去查找名字x，若是一直到最外层函数都找不到，则会抛出异常。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-632ec1c5586b42b1b603268097360c35_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471/?p=45\">https://www.bilibili.com/video/av73342471/?p=45www.bilibili.com/video/av73342471/?p=45</a></p>\n"},{"_content":"## 一 函数对象\n\n函数对象指的是函数可以被当做’数据’来处理，具体可以分为四个方面的使用，我们如下\n\n![img](https://pic2.zhimg.com/80/v2-610f07da055d449976326f5e234075d9_720w.jpg)\n\n## 1.1 函数可以被引用\n\n```python\n>>> def add(x,y):\n...     return x+y\n... \n>>> func=add\n>>> func(1,2)\n3\n```\n\n## 1.2 函数可以作为容器类型的元素\n\n```python\n>>> dic={'add':add,'max':max}\n>>> dic\n{'add': <function add at 0x100661e18>, 'max': <built-in function max>}\n>>> dic['add'](1,2)\n3\n```\n\n## 1.3 函数可以作为参数传入另外一个函数\n\n```python\n>>> def foo(x,y,func):\n...     return func(x,y)\n...\n>>> foo(1,2,add)\n3\n```\n\n## 1.4 函数的返回值可以是一个函数\n\n```python\ndef bar(): \n     return add \nfunc=bar() \nfunc(1,2)\n3 \n```\n\n![img](https://pic3.zhimg.com/80/v2-3a92b83b2c4ab23b0e237f071b6bcd7e_720w.jpg)\n\n## 二 闭包函数\n\n## 2.1 闭与包\n\n基于函数对象的概念，可以将函数返回到任意位置去调用，但作用域的关系是在定义完函数时就已经被确定了的，与函数的调用位置无关。\n\n```python\nx=1\n\ndef f1():\n    def f2():\n        print(x)\n\n    return f2\n\ndef f3():\n    x=3\n    f2=f1() #调用f1()返回函数f2\n    f2() #需要按照函数定义时的作用关系去执行，与调用位置无关\n\nf3() #结果为1\n```\n\n也就是说函数被当做数据处理时，始终以自带的作用域为准。若内嵌函数包含对外部函数作用域（而非全局作用域）中变量的引用，那么该’内嵌函数’就是闭包函数，简称闭包(Closures)\n\n```python\nx=1\ndef outer():\n    x=2\n    def inner():\n        print(x)\n    return inner\n\nfunc=outer()\nfunc() # 结果为2\n```\n\n![img](https://pic4.zhimg.com/80/v2-f8b3a3ff993a95277b4ec5b1514cb103_720w.jpg)\n\n可以通过函数的**closure**属性，查看到闭包函数所包裹的外部变量\n\n```python\n>>> func.__closure__\n(<cell at 0x10212af78: int object at 0x10028cca0>,)\n>>> func.__closure__[0].cell_contents\n2\n```\n\n“闭”代表函数是内部的，“包”代表函数外’包裹’着对外层作用域的引用。因而无论在何处调用闭包函数，使用的仍然是包裹在其外层的变量。\n\n![img](https://pic4.zhimg.com/80/v2-c6e623206aa2c60c1036f30656ffbbaf_720w.jpg)\n\n## 2.2 闭包的用途\n\n目前为止，我们得到了两种为函数体传值的方式，一种是直接将值以参数的形式传入，另外一种就是将值包给函数\n\n```python\nimport requests\n\n#方式一：\ndef get(url):\n    return requests.get(url).text\n\n#方式二：\ndef page(url):\n    def get():\n        return requests.get(url).text\n    return get\n```\n\n提示：requests模块是用来模拟浏览器向网站发送请求并将页面内容下载到本地，需要事先安装：pip3 install requests\n\n![img](https://pic1.zhimg.com/80/v2-25aba810eb15ef9e3d59241516b05358_720w.jpg)\n\n对比两种方式，方式一在下载同一页面时需要重复传入url，而方式二只需要传一次值，就会得到一个包含指定url的闭包函数，以后调用该闭包函数无需再传url\n\n```python\n# 方式一下载同一页面\nget('https://www.python.org')\nget('https://www.python.org')\nget('https://www.python.org')\n……\n\n# 方式二下载同一页面\npython=page('https://www.python.org')\npython()\npython()\npython()\n……\n```\n\n闭包函数的这种特性有时又称为惰性计算。使用将值包给函数的方式，在接下来的装饰器中也将大有用处\n\n![img](https://pic3.zhimg.com/80/v2-fbcde5e64980428d3864f2c389ce3f3e_720w.jpg)\n\n## 视频链接：\n\n函数对象：\n\n[https://www.bilibili.com/video/av73342471?p=43www.bilibili.com/video/av73342471?p=43](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D43)\n\n闭包函数：\n\n[https://www.bilibili.com/video/av73342471?p=46www.bilibili.com/video/av73342471?p=46](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D46)","source":"_posts/03_Python/01_Python基础/14_函数对象和闭包.md","raw":"## 一 函数对象\n\n函数对象指的是函数可以被当做’数据’来处理，具体可以分为四个方面的使用，我们如下\n\n![img](https://pic2.zhimg.com/80/v2-610f07da055d449976326f5e234075d9_720w.jpg)\n\n## 1.1 函数可以被引用\n\n```python\n>>> def add(x,y):\n...     return x+y\n... \n>>> func=add\n>>> func(1,2)\n3\n```\n\n## 1.2 函数可以作为容器类型的元素\n\n```python\n>>> dic={'add':add,'max':max}\n>>> dic\n{'add': <function add at 0x100661e18>, 'max': <built-in function max>}\n>>> dic['add'](1,2)\n3\n```\n\n## 1.3 函数可以作为参数传入另外一个函数\n\n```python\n>>> def foo(x,y,func):\n...     return func(x,y)\n...\n>>> foo(1,2,add)\n3\n```\n\n## 1.4 函数的返回值可以是一个函数\n\n```python\ndef bar(): \n     return add \nfunc=bar() \nfunc(1,2)\n3 \n```\n\n![img](https://pic3.zhimg.com/80/v2-3a92b83b2c4ab23b0e237f071b6bcd7e_720w.jpg)\n\n## 二 闭包函数\n\n## 2.1 闭与包\n\n基于函数对象的概念，可以将函数返回到任意位置去调用，但作用域的关系是在定义完函数时就已经被确定了的，与函数的调用位置无关。\n\n```python\nx=1\n\ndef f1():\n    def f2():\n        print(x)\n\n    return f2\n\ndef f3():\n    x=3\n    f2=f1() #调用f1()返回函数f2\n    f2() #需要按照函数定义时的作用关系去执行，与调用位置无关\n\nf3() #结果为1\n```\n\n也就是说函数被当做数据处理时，始终以自带的作用域为准。若内嵌函数包含对外部函数作用域（而非全局作用域）中变量的引用，那么该’内嵌函数’就是闭包函数，简称闭包(Closures)\n\n```python\nx=1\ndef outer():\n    x=2\n    def inner():\n        print(x)\n    return inner\n\nfunc=outer()\nfunc() # 结果为2\n```\n\n![img](https://pic4.zhimg.com/80/v2-f8b3a3ff993a95277b4ec5b1514cb103_720w.jpg)\n\n可以通过函数的**closure**属性，查看到闭包函数所包裹的外部变量\n\n```python\n>>> func.__closure__\n(<cell at 0x10212af78: int object at 0x10028cca0>,)\n>>> func.__closure__[0].cell_contents\n2\n```\n\n“闭”代表函数是内部的，“包”代表函数外’包裹’着对外层作用域的引用。因而无论在何处调用闭包函数，使用的仍然是包裹在其外层的变量。\n\n![img](https://pic4.zhimg.com/80/v2-c6e623206aa2c60c1036f30656ffbbaf_720w.jpg)\n\n## 2.2 闭包的用途\n\n目前为止，我们得到了两种为函数体传值的方式，一种是直接将值以参数的形式传入，另外一种就是将值包给函数\n\n```python\nimport requests\n\n#方式一：\ndef get(url):\n    return requests.get(url).text\n\n#方式二：\ndef page(url):\n    def get():\n        return requests.get(url).text\n    return get\n```\n\n提示：requests模块是用来模拟浏览器向网站发送请求并将页面内容下载到本地，需要事先安装：pip3 install requests\n\n![img](https://pic1.zhimg.com/80/v2-25aba810eb15ef9e3d59241516b05358_720w.jpg)\n\n对比两种方式，方式一在下载同一页面时需要重复传入url，而方式二只需要传一次值，就会得到一个包含指定url的闭包函数，以后调用该闭包函数无需再传url\n\n```python\n# 方式一下载同一页面\nget('https://www.python.org')\nget('https://www.python.org')\nget('https://www.python.org')\n……\n\n# 方式二下载同一页面\npython=page('https://www.python.org')\npython()\npython()\npython()\n……\n```\n\n闭包函数的这种特性有时又称为惰性计算。使用将值包给函数的方式，在接下来的装饰器中也将大有用处\n\n![img](https://pic3.zhimg.com/80/v2-fbcde5e64980428d3864f2c389ce3f3e_720w.jpg)\n\n## 视频链接：\n\n函数对象：\n\n[https://www.bilibili.com/video/av73342471?p=43www.bilibili.com/video/av73342471?p=43](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D43)\n\n闭包函数：\n\n[https://www.bilibili.com/video/av73342471?p=46www.bilibili.com/video/av73342471?p=46](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D46)","slug":"03_Python/01_Python基础/14_函数对象和闭包","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k17002da8v76ch39s77","content":"<h2 id=\"一-函数对象\"><a href=\"#一-函数对象\" class=\"headerlink\" title=\"一 函数对象\"></a>一 函数对象</h2><p>函数对象指的是函数可以被当做’数据’来处理，具体可以分为四个方面的使用，我们如下</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-610f07da055d449976326f5e234075d9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-函数可以被引用\"><a href=\"#1-1-函数可以被引用\" class=\"headerlink\" title=\"1.1 函数可以被引用\"></a>1.1 函数可以被引用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> x<span class=\"token operator\">+</span>y\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token operator\">=</span>add\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-2-函数可以作为容器类型的元素\"><a href=\"#1-2-函数可以作为容器类型的元素\" class=\"headerlink\" title=\"1.2 函数可以作为容器类型的元素\"></a>1.2 函数可以作为容器类型的元素</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">:</span>add<span class=\"token punctuation\">,</span><span class=\"token string\">'max'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&lt;</span>function add at <span class=\"token number\">0x100661e18</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'max'</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&lt;</span>built<span class=\"token operator\">-</span><span class=\"token keyword\">in</span> function <span class=\"token builtin\">max</span><span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token punctuation\">[</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-3-函数可以作为参数传入另外一个函数\"><a href=\"#1-3-函数可以作为参数传入另外一个函数\" class=\"headerlink\" title=\"1.3 函数可以作为参数传入另外一个函数\"></a>1.3 函数可以作为参数传入另外一个函数</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> func<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>add<span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-4-函数的返回值可以是一个函数\"><a href=\"#1-4-函数的返回值可以是一个函数\" class=\"headerlink\" title=\"1.4 函数的返回值可以是一个函数\"></a>1.4 函数的返回值可以是一个函数</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n     <span class=\"token keyword\">return</span> add \nfunc<span class=\"token operator\">=</span>bar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \nfunc<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-3a92b83b2c4ab23b0e237f071b6bcd7e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-闭包函数\"><a href=\"#二-闭包函数\" class=\"headerlink\" title=\"二 闭包函数\"></a>二 闭包函数</h2><h2 id=\"2-1-闭与包\"><a href=\"#2-1-闭与包\" class=\"headerlink\" title=\"2.1 闭与包\"></a>2.1 闭与包</h2><p>基于函数对象的概念，可以将函数返回到任意位置去调用，但作用域的关系是在定义完函数时就已经被确定了的，与函数的调用位置无关。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> f2\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">f3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n    f2<span class=\"token operator\">=</span>f1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#调用f1()返回函数f2</span>\n    f2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#需要按照函数定义时的作用关系去执行，与调用位置无关</span>\n\nf3<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#结果为1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>也就是说函数被当做数据处理时，始终以自带的作用域为准。若内嵌函数包含对外部函数作用域（而非全局作用域）中变量的引用，那么该’内嵌函数’就是闭包函数，简称闭包(Closures)</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">outer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">inner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> inner\n\nfunc<span class=\"token operator\">=</span>outer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nfunc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 结果为2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-f8b3a3ff993a95277b4ec5b1514cb103_720w.jpg\" alt=\"img\"></p>\n<p>可以通过函数的<strong>closure</strong>属性，查看到闭包函数所包裹的外部变量</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">.</span>__closure__\n<span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>cell at <span class=\"token number\">0x10212af78</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token builtin\">object</span> at <span class=\"token number\">0x10028cca0</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">.</span>__closure__<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>cell_contents\n<span class=\"token number\">2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>“闭”代表函数是内部的，“包”代表函数外’包裹’着对外层作用域的引用。因而无论在何处调用闭包函数，使用的仍然是包裹在其外层的变量。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-c6e623206aa2c60c1036f30656ffbbaf_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-闭包的用途\"><a href=\"#2-2-闭包的用途\" class=\"headerlink\" title=\"2.2 闭包的用途\"></a>2.2 闭包的用途</h2><p>目前为止，我们得到了两种为函数体传值的方式，一种是直接将值以参数的形式传入，另外一种就是将值包给函数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> requests\n\n<span class=\"token comment\">#方式一：</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text\n\n<span class=\"token comment\">#方式二：</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">page</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text\n    <span class=\"token keyword\">return</span> get<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示：requests模块是用来模拟浏览器向网站发送请求并将页面内容下载到本地，需要事先安装：pip3 install requests</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-25aba810eb15ef9e3d59241516b05358_720w.jpg\" alt=\"img\"></p>\n<p>对比两种方式，方式一在下载同一页面时需要重复传入url，而方式二只需要传一次值，就会得到一个包含指定url的闭包函数，以后调用该闭包函数无需再传url</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 方式一下载同一页面</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\n……\n\n<span class=\"token comment\"># 方式二下载同一页面</span>\npython<span class=\"token operator\">=</span>page<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n……<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>闭包函数的这种特性有时又称为惰性计算。使用将值包给函数的方式，在接下来的装饰器中也将大有用处</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-fbcde5e64980428d3864f2c389ce3f3e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>函数对象：</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=43\">https://www.bilibili.com/video/av73342471?p=43www.bilibili.com/video/av73342471?p=43</a></p>\n<p>闭包函数：</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=46\">https://www.bilibili.com/video/av73342471?p=46www.bilibili.com/video/av73342471?p=46</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-函数对象\"><a href=\"#一-函数对象\" class=\"headerlink\" title=\"一 函数对象\"></a>一 函数对象</h2><p>函数对象指的是函数可以被当做’数据’来处理，具体可以分为四个方面的使用，我们如下</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-610f07da055d449976326f5e234075d9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-函数可以被引用\"><a href=\"#1-1-函数可以被引用\" class=\"headerlink\" title=\"1.1 函数可以被引用\"></a>1.1 函数可以被引用</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">add</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> x<span class=\"token operator\">+</span>y\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token operator\">=</span>add\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-2-函数可以作为容器类型的元素\"><a href=\"#1-2-函数可以作为容器类型的元素\" class=\"headerlink\" title=\"1.2 函数可以作为容器类型的元素\"></a>1.2 函数可以作为容器类型的元素</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">:</span>add<span class=\"token punctuation\">,</span><span class=\"token string\">'max'</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">max</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic\n<span class=\"token punctuation\">&#123;</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&lt;</span>function add at <span class=\"token number\">0x100661e18</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'max'</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">&lt;</span>built<span class=\"token operator\">-</span><span class=\"token keyword\">in</span> function <span class=\"token builtin\">max</span><span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> dic<span class=\"token punctuation\">[</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-3-函数可以作为参数传入另外一个函数\"><a href=\"#1-3-函数可以作为参数传入另外一个函数\" class=\"headerlink\" title=\"1.3 函数可以作为参数传入另外一个函数\"></a>1.3 函数可以作为参数传入另外一个函数</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">,</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">return</span> func<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> foo<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>add<span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"1-4-函数的返回值可以是一个函数\"><a href=\"#1-4-函数的返回值可以是一个函数\" class=\"headerlink\" title=\"1.4 函数的返回值可以是一个函数\"></a>1.4 函数的返回值可以是一个函数</h2><pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n     <span class=\"token keyword\">return</span> add \nfunc<span class=\"token operator\">=</span>bar<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \nfunc<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span> <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-3a92b83b2c4ab23b0e237f071b6bcd7e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-闭包函数\"><a href=\"#二-闭包函数\" class=\"headerlink\" title=\"二 闭包函数\"></a>二 闭包函数</h2><h2 id=\"2-1-闭与包\"><a href=\"#2-1-闭与包\" class=\"headerlink\" title=\"2.1 闭与包\"></a>2.1 闭与包</h2><p>基于函数对象的概念，可以将函数返回到任意位置去调用，但作用域的关系是在定义完函数时就已经被确定了的，与函数的调用位置无关。</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> f2\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">f3</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">3</span>\n    f2<span class=\"token operator\">=</span>f1<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#调用f1()返回函数f2</span>\n    f2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#需要按照函数定义时的作用关系去执行，与调用位置无关</span>\n\nf3<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#结果为1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>也就是说函数被当做数据处理时，始终以自带的作用域为准。若内嵌函数包含对外部函数作用域（而非全局作用域）中变量的引用，那么该’内嵌函数’就是闭包函数，简称闭包(Closures)</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">outer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    x<span class=\"token operator\">=</span><span class=\"token number\">2</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">inner</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> inner\n\nfunc<span class=\"token operator\">=</span>outer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nfunc<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 结果为2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-f8b3a3ff993a95277b4ec5b1514cb103_720w.jpg\" alt=\"img\"></p>\n<p>可以通过函数的<strong>closure</strong>属性，查看到闭包函数所包裹的外部变量</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">.</span>__closure__\n<span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>cell at <span class=\"token number\">0x10212af78</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">int</span> <span class=\"token builtin\">object</span> at <span class=\"token number\">0x10028cca0</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> func<span class=\"token punctuation\">.</span>__closure__<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>cell_contents\n<span class=\"token number\">2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>“闭”代表函数是内部的，“包”代表函数外’包裹’着对外层作用域的引用。因而无论在何处调用闭包函数，使用的仍然是包裹在其外层的变量。</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-c6e623206aa2c60c1036f30656ffbbaf_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-闭包的用途\"><a href=\"#2-2-闭包的用途\" class=\"headerlink\" title=\"2.2 闭包的用途\"></a>2.2 闭包的用途</h2><p>目前为止，我们得到了两种为函数体传值的方式，一种是直接将值以参数的形式传入，另外一种就是将值包给函数</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> requests\n\n<span class=\"token comment\">#方式一：</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text\n\n<span class=\"token comment\">#方式二：</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">page</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>text\n    <span class=\"token keyword\">return</span> get<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>提示：requests模块是用来模拟浏览器向网站发送请求并将页面内容下载到本地，需要事先安装：pip3 install requests</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-25aba810eb15ef9e3d59241516b05358_720w.jpg\" alt=\"img\"></p>\n<p>对比两种方式，方式一在下载同一页面时需要重复传入url，而方式二只需要传一次值，就会得到一个包含指定url的闭包函数，以后调用该闭包函数无需再传url</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token comment\"># 方式一下载同一页面</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\nget<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\n……\n\n<span class=\"token comment\"># 方式二下载同一页面</span>\npython<span class=\"token operator\">=</span>page<span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.python.org'</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\npython<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n……<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>闭包函数的这种特性有时又称为惰性计算。使用将值包给函数的方式，在接下来的装饰器中也将大有用处</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-fbcde5e64980428d3864f2c389ce3f3e_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>函数对象：</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=43\">https://www.bilibili.com/video/av73342471?p=43www.bilibili.com/video/av73342471?p=43</a></p>\n<p>闭包函数：</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=46\">https://www.bilibili.com/video/av73342471?p=46www.bilibili.com/video/av73342471?p=46</a></p>\n"},{"_content":"## 一 装饰器介绍\n\n## 1.1 为何要用装饰器\n\n![img](https://pic3.zhimg.com/80/v2-5f0bd90a1428a4b373be52c22f7d871a_720w.jpg)\n\n软件的设计应该遵循开放封闭原则，即对扩展是开放的，而对修改是封闭的。对扩展开放，意味着有新的需求或变化时，可以对现有代码进行扩展，以适应新的情况。对修改封闭，意味着对象一旦设计完成，就可以独立完成其工作，而不要对其进行修改。\n\n软件包含的所有功能的源代码以及调用方式，都应该避免修改，否则一旦改错，则极有可能产生连锁反应，最终导致程序崩溃，而对于上线后的软件，新需求或者变化又层出不穷，我们必须为程序提供扩展的可能性，这就用到了装饰器。\n\n## 1.2 什么是装饰器\n\n![img](https://pic2.zhimg.com/80/v2-b43bfaa7c4abf2a53d535ce272d937b9_720w.jpg)\n\n’装饰’代指为被装饰对象添加新的功能，’器’代指器具/工具，装饰器与被装饰的对象均可以是任意可调用对象。概括地讲，装饰器的作用就是在不修改被装饰对象源代码和调用方式的前提下为被装饰对象添加额外的功能。装饰器经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等应用场景，装饰器是解决这类问题的绝佳设计，有了装饰器，就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。\n\n提示：可调用对象有函数，方法或者类，此处我们单以本章主题函数为例，来介绍函数装饰器，并且被装饰的对象也是函数。\n\n## 二 装饰器的实现\n\n函数装饰器分为：无参装饰器和有参装饰两种，二者的实现原理一样，都是’函数嵌套+闭包+函数对象’的组合使用的产物。\n\n![img](https://pic2.zhimg.com/80/v2-21b3488ea792ad818b3eea81740f6945_720w.jpg)\n\n## 2.1 无参装饰器的实现\n\n如果想为下述函数添加统计其执行时间的功能\n\n```python\nimport time\n\ndef index():\n    time.sleep(3)\n    print('Welcome to the index page’)\n    return 200\n\nindex() #函数执行\n```\n\n遵循不修改被装饰对象源代码的原则，我们想到的解决方法可能是这样\n\n```python\nstart_time=time.time()\nindex() #函数执行\nstop_time=time.time()\nprint('run time is %s' %(stop_time-start_time))\n```\n\n![img](https://pic2.zhimg.com/80/v2-2e3af8429a3c2606c4cfbedb0b196e89_720w.jpg)\n\n考虑到还有可能要统计其他函数的执行时间，于是我们将其做成一个单独的工具，函数体需要外部传入被装饰的函数从而进行调用，我们可以使用参数的形式传入\n\n```python\ndef wrapper(func): # 通过参数接收外部的值\n    start_time=time.time()\n    res=func()\n    stop_time=time.time()\n    print('run time is %s' %(stop_time-start_time))\n    return res\n```\n\n但之后函数的调用方式都需要统一改成\n\n```python\nwrapper(index)\nwrapper(其他函数)\n```\n\n这便违反了不能修改被装饰对象调用方式的原则，于是我们换一种为函数体传值的方式，即将值包给函数，如下\n\n```python\ndef timer(func):\n    def wrapper(): # 引用外部作用域的变量func\n        start_time=time.time()\n        res=func()\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n这样我们便可以在不修改被装饰函数源代码和调用方式的前提下为其加上统计时间的功能，只不过需要事先执行一次timer将被装饰的函数传入，返回一个闭包函数wrapper重新赋值给变量名 /函数名index，如下\n\n```python\nindex=timer(index)  #得到index=wrapper，wrapper携带对外作用域的引用：func=原始的index\nindex() # 执行的是wrapper()，在wrapper的函数体内再执行最原始的index\n```\n\n![img](https://pic2.zhimg.com/80/v2-6c1260375fb70d489df20b676c5cac51_720w.jpg)\n\n至此我们便实现了一个无参装饰器timer，可以在不修改被装饰对象index源代码和调用方式的前提下为其加上新功能。但我们忽略了若被装饰的函数是一个有参函数，便会抛出异常\n\n```python\ndef home(name):\n    time.sleep(5)\n    print('Welcome to the home page',name)\n\nhome=timer(home)\nhome('egon')\n#抛出异常\nTypeError: wrapper() takes 0 positional arguments but 1 was given\n```\n\n之所以会抛出异常，是因为home(‘egon’)调用的其实是wrapper(‘egon’)，而函数wrapper没有参数。wrapper函数接收的参数其实是给最原始的func用的，为了能满足被装饰函数参数的所有情况，便用上*args+**kwargs组合（见4.3小节）,于是修正装饰器timer如下\n\n```python\ndef timer(func):\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n![img](https://pic4.zhimg.com/80/v2-da8d9c6733f96b2a897c986e3515ffe3_720w.jpg)\n\n此时我们就可以用timer来装饰带参数或不带参数的函数了，但是为了简洁而优雅地使用装饰器，Python提供了专门的装饰器语法来取代index=timer(index)的形式，需要在被装饰对象的正上方单独一行添加@timer,当解释器解释到@timer时就会调用timer函数，且把它正下方的函数名当做实参传入，然后将返回的结果重新赋值给原函数名\n\n```python\n@timer # index=timer(index)\ndef index():\n    time.sleep(3)\n    print('Welcome to the index page')\n    return 200\n@timer # index=timer(home)           def home(name):\n    time.sleep(5)\n    print('Welcome to the home page’,name)\n```\n\n如果我们有多个装饰器，可以叠加多个\n\n```python\n@deco3\n@deco2\n@deco1\ndef index():\n    pass\n```\n\n叠加多个装饰器也无特殊之处，上述代码语义如下：\n\n```python\nindex=deco3(deco2(deco1(index)))\n```\n\n![img](https://pic2.zhimg.com/80/v2-c6e67404ac0e4319ce3cd89af56ead5d_720w.jpg)\n\n## 2.2 有参装饰器的实现\n\n了解无参装饰器的实现原理后，我们可以再实现一个用来为被装饰对象添加认证功能的装饰器，实现的基本形式如下\n\n```python\ndef deco(func):\n    def wrapper(*args,**kwargs):\n        编写基于文件的认证,认证通过则执行res=func(*args,**kwargs),并返回res\n    return wrapper\n```\n\n如果我们想提供多种不同的认证方式以供选择，单从wrapper函数的实现角度改写如下\n\n```python\ndef deco(func):\n        def wrapper(*args,**kwargs):\n            if driver == 'file':\n                编写基于文件的认证,认证通过则执行res=func(*args,**kwargs),并返回res\n            elif driver == 'mysql':\n                编写基于mysql认证,认证通过则执行res=func(*args,**kwargs),并返回res\n        return wrapper\n```\n\n![img](https://pic1.zhimg.com/80/v2-82fb584a53b2277048a09561b3e19b58_720w.jpg)\n\n函数wrapper需要一个driver参数，而函数deco与wrapper的参数都有其特定的功能，不能用来接受其他类别的参数，可以在deco的外部再包一层函数auth，用来专门接受额外的参数，这样便保证了在auth函数内无论多少层都可以引用到\n\n```python\ndef auth(driver):\n    def deco(func):\n        ……\n    return deco\n```\n\n此时我们就实现了一个有参装饰器，使用方式如下\n\n```python\n先调用auth_type(driver='file')，得到@deco，deco是一个闭包函数，\n包含了对外部作用域名字driver的引用，@deco的语法意义与无参装饰器一样\n@auth(driver='file') \ndef index():     \n    pass\n@auth(driver='mysql') \ndef home():\n    pass  \n```\n\n可以使用help(函数名)来查看函数的文档注释，本质就是查看函数的**doc**属性，但对于被装饰之后的函数，查看文档注释\n\n```python\n@timer\ndef home(name):\n    '''\n    home page function\n    :param name: str\n    :return: None\n    '''\n    time.sleep(5)\n    print('Welcome to the home page',name)\n\nprint(help(home))\n'''\n打印结果：\n\nHelp on function wrapper in module __main__:\n\nwrapper(*args, **kwargs)\n\nNone\n```\n\n![img](https://pic3.zhimg.com/80/v2-3380e05c82d8501f9ac1c2681311a062_720w.jpg)\n\n在被装饰之后home=wrapper,查看home.**name**也可以发现home的函数名确实是wrapper，想要保留原函数的文档和函数名属性，需要修正装饰器\n\n```python\ndef timer(func):\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    wrapper.__doc__=func.__doc__\n    wrapper.__name__=func.__name__\n    return wrapper\n```\n\n按照上述方式来实现保留原函数属性过于麻烦，functools模块下提供一个装饰器wraps专门用来帮我们实现这件事，用法如下\n\n```python\nfrom functools import wraps\n\ndef timer(func):\n    @wraps(func)\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n![img](https://pic2.zhimg.com/80/v2-091acff94160bf2b8258553158168f79_720w.jpg)\n\n## 视频链接：\n\n简单装饰器的实现\n\n[https://www.bilibili.com/video/av73342471?p=47www.bilibili.com/video/av73342471?p=47](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D47)\n\n装饰器修订\n\n[https://www.bilibili.com/video/av73342471?p=48www.bilibili.com/video/av73342471?p=48](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D48)\n\nwraps补充\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=49![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D49)","source":"_posts/03_Python/01_Python基础/15_装饰器.md","raw":"## 一 装饰器介绍\n\n## 1.1 为何要用装饰器\n\n![img](https://pic3.zhimg.com/80/v2-5f0bd90a1428a4b373be52c22f7d871a_720w.jpg)\n\n软件的设计应该遵循开放封闭原则，即对扩展是开放的，而对修改是封闭的。对扩展开放，意味着有新的需求或变化时，可以对现有代码进行扩展，以适应新的情况。对修改封闭，意味着对象一旦设计完成，就可以独立完成其工作，而不要对其进行修改。\n\n软件包含的所有功能的源代码以及调用方式，都应该避免修改，否则一旦改错，则极有可能产生连锁反应，最终导致程序崩溃，而对于上线后的软件，新需求或者变化又层出不穷，我们必须为程序提供扩展的可能性，这就用到了装饰器。\n\n## 1.2 什么是装饰器\n\n![img](https://pic2.zhimg.com/80/v2-b43bfaa7c4abf2a53d535ce272d937b9_720w.jpg)\n\n’装饰’代指为被装饰对象添加新的功能，’器’代指器具/工具，装饰器与被装饰的对象均可以是任意可调用对象。概括地讲，装饰器的作用就是在不修改被装饰对象源代码和调用方式的前提下为被装饰对象添加额外的功能。装饰器经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等应用场景，装饰器是解决这类问题的绝佳设计，有了装饰器，就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。\n\n提示：可调用对象有函数，方法或者类，此处我们单以本章主题函数为例，来介绍函数装饰器，并且被装饰的对象也是函数。\n\n## 二 装饰器的实现\n\n函数装饰器分为：无参装饰器和有参装饰两种，二者的实现原理一样，都是’函数嵌套+闭包+函数对象’的组合使用的产物。\n\n![img](https://pic2.zhimg.com/80/v2-21b3488ea792ad818b3eea81740f6945_720w.jpg)\n\n## 2.1 无参装饰器的实现\n\n如果想为下述函数添加统计其执行时间的功能\n\n```python\nimport time\n\ndef index():\n    time.sleep(3)\n    print('Welcome to the index page’)\n    return 200\n\nindex() #函数执行\n```\n\n遵循不修改被装饰对象源代码的原则，我们想到的解决方法可能是这样\n\n```python\nstart_time=time.time()\nindex() #函数执行\nstop_time=time.time()\nprint('run time is %s' %(stop_time-start_time))\n```\n\n![img](https://pic2.zhimg.com/80/v2-2e3af8429a3c2606c4cfbedb0b196e89_720w.jpg)\n\n考虑到还有可能要统计其他函数的执行时间，于是我们将其做成一个单独的工具，函数体需要外部传入被装饰的函数从而进行调用，我们可以使用参数的形式传入\n\n```python\ndef wrapper(func): # 通过参数接收外部的值\n    start_time=time.time()\n    res=func()\n    stop_time=time.time()\n    print('run time is %s' %(stop_time-start_time))\n    return res\n```\n\n但之后函数的调用方式都需要统一改成\n\n```python\nwrapper(index)\nwrapper(其他函数)\n```\n\n这便违反了不能修改被装饰对象调用方式的原则，于是我们换一种为函数体传值的方式，即将值包给函数，如下\n\n```python\ndef timer(func):\n    def wrapper(): # 引用外部作用域的变量func\n        start_time=time.time()\n        res=func()\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n这样我们便可以在不修改被装饰函数源代码和调用方式的前提下为其加上统计时间的功能，只不过需要事先执行一次timer将被装饰的函数传入，返回一个闭包函数wrapper重新赋值给变量名 /函数名index，如下\n\n```python\nindex=timer(index)  #得到index=wrapper，wrapper携带对外作用域的引用：func=原始的index\nindex() # 执行的是wrapper()，在wrapper的函数体内再执行最原始的index\n```\n\n![img](https://pic2.zhimg.com/80/v2-6c1260375fb70d489df20b676c5cac51_720w.jpg)\n\n至此我们便实现了一个无参装饰器timer，可以在不修改被装饰对象index源代码和调用方式的前提下为其加上新功能。但我们忽略了若被装饰的函数是一个有参函数，便会抛出异常\n\n```python\ndef home(name):\n    time.sleep(5)\n    print('Welcome to the home page',name)\n\nhome=timer(home)\nhome('egon')\n#抛出异常\nTypeError: wrapper() takes 0 positional arguments but 1 was given\n```\n\n之所以会抛出异常，是因为home(‘egon’)调用的其实是wrapper(‘egon’)，而函数wrapper没有参数。wrapper函数接收的参数其实是给最原始的func用的，为了能满足被装饰函数参数的所有情况，便用上*args+**kwargs组合（见4.3小节）,于是修正装饰器timer如下\n\n```python\ndef timer(func):\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n![img](https://pic4.zhimg.com/80/v2-da8d9c6733f96b2a897c986e3515ffe3_720w.jpg)\n\n此时我们就可以用timer来装饰带参数或不带参数的函数了，但是为了简洁而优雅地使用装饰器，Python提供了专门的装饰器语法来取代index=timer(index)的形式，需要在被装饰对象的正上方单独一行添加@timer,当解释器解释到@timer时就会调用timer函数，且把它正下方的函数名当做实参传入，然后将返回的结果重新赋值给原函数名\n\n```python\n@timer # index=timer(index)\ndef index():\n    time.sleep(3)\n    print('Welcome to the index page')\n    return 200\n@timer # index=timer(home)           def home(name):\n    time.sleep(5)\n    print('Welcome to the home page’,name)\n```\n\n如果我们有多个装饰器，可以叠加多个\n\n```python\n@deco3\n@deco2\n@deco1\ndef index():\n    pass\n```\n\n叠加多个装饰器也无特殊之处，上述代码语义如下：\n\n```python\nindex=deco3(deco2(deco1(index)))\n```\n\n![img](https://pic2.zhimg.com/80/v2-c6e67404ac0e4319ce3cd89af56ead5d_720w.jpg)\n\n## 2.2 有参装饰器的实现\n\n了解无参装饰器的实现原理后，我们可以再实现一个用来为被装饰对象添加认证功能的装饰器，实现的基本形式如下\n\n```python\ndef deco(func):\n    def wrapper(*args,**kwargs):\n        编写基于文件的认证,认证通过则执行res=func(*args,**kwargs),并返回res\n    return wrapper\n```\n\n如果我们想提供多种不同的认证方式以供选择，单从wrapper函数的实现角度改写如下\n\n```python\ndef deco(func):\n        def wrapper(*args,**kwargs):\n            if driver == 'file':\n                编写基于文件的认证,认证通过则执行res=func(*args,**kwargs),并返回res\n            elif driver == 'mysql':\n                编写基于mysql认证,认证通过则执行res=func(*args,**kwargs),并返回res\n        return wrapper\n```\n\n![img](https://pic1.zhimg.com/80/v2-82fb584a53b2277048a09561b3e19b58_720w.jpg)\n\n函数wrapper需要一个driver参数，而函数deco与wrapper的参数都有其特定的功能，不能用来接受其他类别的参数，可以在deco的外部再包一层函数auth，用来专门接受额外的参数，这样便保证了在auth函数内无论多少层都可以引用到\n\n```python\ndef auth(driver):\n    def deco(func):\n        ……\n    return deco\n```\n\n此时我们就实现了一个有参装饰器，使用方式如下\n\n```python\n先调用auth_type(driver='file')，得到@deco，deco是一个闭包函数，\n包含了对外部作用域名字driver的引用，@deco的语法意义与无参装饰器一样\n@auth(driver='file') \ndef index():     \n    pass\n@auth(driver='mysql') \ndef home():\n    pass  \n```\n\n可以使用help(函数名)来查看函数的文档注释，本质就是查看函数的**doc**属性，但对于被装饰之后的函数，查看文档注释\n\n```python\n@timer\ndef home(name):\n    '''\n    home page function\n    :param name: str\n    :return: None\n    '''\n    time.sleep(5)\n    print('Welcome to the home page',name)\n\nprint(help(home))\n'''\n打印结果：\n\nHelp on function wrapper in module __main__:\n\nwrapper(*args, **kwargs)\n\nNone\n```\n\n![img](https://pic3.zhimg.com/80/v2-3380e05c82d8501f9ac1c2681311a062_720w.jpg)\n\n在被装饰之后home=wrapper,查看home.**name**也可以发现home的函数名确实是wrapper，想要保留原函数的文档和函数名属性，需要修正装饰器\n\n```python\ndef timer(func):\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    wrapper.__doc__=func.__doc__\n    wrapper.__name__=func.__name__\n    return wrapper\n```\n\n按照上述方式来实现保留原函数属性过于麻烦，functools模块下提供一个装饰器wraps专门用来帮我们实现这件事，用法如下\n\n```python\nfrom functools import wraps\n\ndef timer(func):\n    @wraps(func)\n    def wrapper(*args,**kwargs):\n        start_time=time.time()\n        res=func(*args,**kwargs)\n        stop_time=time.time()\n        print('run time is %s' %(stop_time-start_time))\n        return res\n    return wrapper\n```\n\n![img](https://pic2.zhimg.com/80/v2-091acff94160bf2b8258553158168f79_720w.jpg)\n\n## 视频链接：\n\n简单装饰器的实现\n\n[https://www.bilibili.com/video/av73342471?p=47www.bilibili.com/video/av73342471?p=47](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D47)\n\n装饰器修订\n\n[https://www.bilibili.com/video/av73342471?p=48www.bilibili.com/video/av73342471?p=48](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D48)\n\nwraps补充\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=49![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D49)","slug":"03_Python/01_Python基础/15_装饰器","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k18002fa8v75qxh2qva","content":"<h2 id=\"一-装饰器介绍\"><a href=\"#一-装饰器介绍\" class=\"headerlink\" title=\"一 装饰器介绍\"></a>一 装饰器介绍</h2><h2 id=\"1-1-为何要用装饰器\"><a href=\"#1-1-为何要用装饰器\" class=\"headerlink\" title=\"1.1 为何要用装饰器\"></a>1.1 为何要用装饰器</h2><p><img src=\"https://pic3.zhimg.com/80/v2-5f0bd90a1428a4b373be52c22f7d871a_720w.jpg\" alt=\"img\"></p>\n<p>软件的设计应该遵循开放封闭原则，即对扩展是开放的，而对修改是封闭的。对扩展开放，意味着有新的需求或变化时，可以对现有代码进行扩展，以适应新的情况。对修改封闭，意味着对象一旦设计完成，就可以独立完成其工作，而不要对其进行修改。</p>\n<p>软件包含的所有功能的源代码以及调用方式，都应该避免修改，否则一旦改错，则极有可能产生连锁反应，最终导致程序崩溃，而对于上线后的软件，新需求或者变化又层出不穷，我们必须为程序提供扩展的可能性，这就用到了装饰器。</p>\n<h2 id=\"1-2-什么是装饰器\"><a href=\"#1-2-什么是装饰器\" class=\"headerlink\" title=\"1.2 什么是装饰器\"></a>1.2 什么是装饰器</h2><p><img src=\"https://pic2.zhimg.com/80/v2-b43bfaa7c4abf2a53d535ce272d937b9_720w.jpg\" alt=\"img\"></p>\n<p>’装饰’代指为被装饰对象添加新的功能，’器’代指器具&#x2F;工具，装饰器与被装饰的对象均可以是任意可调用对象。概括地讲，装饰器的作用就是在不修改被装饰对象源代码和调用方式的前提下为被装饰对象添加额外的功能。装饰器经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等应用场景，装饰器是解决这类问题的绝佳设计，有了装饰器，就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。</p>\n<p>提示：可调用对象有函数，方法或者类，此处我们单以本章主题函数为例，来介绍函数装饰器，并且被装饰的对象也是函数。</p>\n<h2 id=\"二-装饰器的实现\"><a href=\"#二-装饰器的实现\" class=\"headerlink\" title=\"二 装饰器的实现\"></a>二 装饰器的实现</h2><p>函数装饰器分为：无参装饰器和有参装饰两种，二者的实现原理一样，都是’函数嵌套+闭包+函数对象’的组合使用的产物。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-21b3488ea792ad818b3eea81740f6945_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-1-无参装饰器的实现\"><a href=\"#2-1-无参装饰器的实现\" class=\"headerlink\" title=\"2.1 无参装饰器的实现\"></a>2.1 无参装饰器的实现</h2><p>如果想为下述函数添加统计其执行时间的功能</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>'Welcome to the index page’<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">200</span>\n\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#函数执行</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>遵循不修改被装饰对象源代码的原则，我们想到的解决方法可能是这样</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#函数执行</span>\nstop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-2e3af8429a3c2606c4cfbedb0b196e89_720w.jpg\" alt=\"img\"></p>\n<p>考虑到还有可能要统计其他函数的执行时间，于是我们将其做成一个单独的工具，函数体需要外部传入被装饰的函数从而进行调用，我们可以使用参数的形式传入</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 通过参数接收外部的值</span>\n    start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但之后函数的调用方式都需要统一改成</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">wrapper<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span>\nwrapper<span class=\"token punctuation\">(</span>其他函数<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>这便违反了不能修改被装饰对象调用方式的原则，于是我们换一种为函数体传值的方式，即将值包给函数，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 引用外部作用域的变量func</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这样我们便可以在不修改被装饰函数源代码和调用方式的前提下为其加上统计时间的功能，只不过需要事先执行一次timer将被装饰的函数传入，返回一个闭包函数wrapper重新赋值给变量名 &#x2F;函数名index，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">index<span class=\"token operator\">=</span>timer<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span>  <span class=\"token comment\">#得到index=wrapper，wrapper携带对外作用域的引用：func=原始的index</span>\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 执行的是wrapper()，在wrapper的函数体内再执行最原始的index</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-6c1260375fb70d489df20b676c5cac51_720w.jpg\" alt=\"img\"></p>\n<p>至此我们便实现了一个无参装饰器timer，可以在不修改被装饰对象index源代码和调用方式的前提下为其加上新功能。但我们忽略了若被装饰的函数是一个有参函数，便会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the home page'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\n\nhome<span class=\"token operator\">=</span>timer<span class=\"token punctuation\">(</span>home<span class=\"token punctuation\">)</span>\nhome<span class=\"token punctuation\">(</span><span class=\"token string\">'egon'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#抛出异常</span>\nTypeError<span class=\"token punctuation\">:</span> wrapper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> takes <span class=\"token number\">0</span> positional arguments but <span class=\"token number\">1</span> was given<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>之所以会抛出异常，是因为home(‘egon’)调用的其实是wrapper(‘egon’)，而函数wrapper没有参数。wrapper函数接收的参数其实是给最原始的func用的，为了能满足被装饰函数参数的所有情况，便用上*args+**kwargs组合（见4.3小节）,于是修正装饰器timer如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-da8d9c6733f96b2a897c986e3515ffe3_720w.jpg\" alt=\"img\"></p>\n<p>此时我们就可以用timer来装饰带参数或不带参数的函数了，但是为了简洁而优雅地使用装饰器，Python提供了专门的装饰器语法来取代index&#x3D;timer(index)的形式，需要在被装饰对象的正上方单独一行添加@timer,当解释器解释到@timer时就会调用timer函数，且把它正下方的函数名当做实参传入，然后将返回的结果重新赋值给原函数名</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@timer</span> <span class=\"token comment\"># index=timer(index)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the index page'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">200</span>\n<span class=\"token decorator annotation punctuation\">@timer</span> <span class=\"token comment\"># index=timer(home)</span>           <span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>'Welcome to the home page’<span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们有多个装饰器，可以叠加多个</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@deco3</span>\n<span class=\"token decorator annotation punctuation\">@deco2</span>\n<span class=\"token decorator annotation punctuation\">@deco1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>叠加多个装饰器也无特殊之处，上述代码语义如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">index<span class=\"token operator\">=</span>deco3<span class=\"token punctuation\">(</span>deco2<span class=\"token punctuation\">(</span>deco1<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-c6e67404ac0e4319ce3cd89af56ead5d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-有参装饰器的实现\"><a href=\"#2-2-有参装饰器的实现\" class=\"headerlink\" title=\"2.2 有参装饰器的实现\"></a>2.2 有参装饰器的实现</h2><p>了解无参装饰器的实现原理后，我们可以再实现一个用来为被装饰对象添加认证功能的装饰器，实现的基本形式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        编写基于文件的认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们想提供多种不同的认证方式以供选择，单从wrapper函数的实现角度改写如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> driver <span class=\"token operator\">==</span> <span class=\"token string\">'file'</span><span class=\"token punctuation\">:</span>\n                编写基于文件的认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n            <span class=\"token keyword\">elif</span> driver <span class=\"token operator\">==</span> <span class=\"token string\">'mysql'</span><span class=\"token punctuation\">:</span>\n                编写基于mysql认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n        <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-82fb584a53b2277048a09561b3e19b58_720w.jpg\" alt=\"img\"></p>\n<p>函数wrapper需要一个driver参数，而函数deco与wrapper的参数都有其特定的功能，不能用来接受其他类别的参数，可以在deco的外部再包一层函数auth，用来专门接受额外的参数，这样便保证了在auth函数内无论多少层都可以引用到</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        ……\n    <span class=\"token keyword\">return</span> deco<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>此时我们就实现了一个有参装饰器，使用方式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">先调用auth_type<span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">)</span>，得到@deco，deco是一个闭包函数，\n包含了对外部作用域名字driver的引用，@deco的语法意义与无参装饰器一样\n<span class=\"token decorator annotation punctuation\">@auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>     \n    <span class=\"token keyword\">pass</span>\n<span class=\"token decorator annotation punctuation\">@auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'mysql'</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span>  <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>可以使用help(函数名)来查看函数的文档注释，本质就是查看函数的<strong>doc</strong>属性，但对于被装饰之后的函数，查看文档注释</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@timer</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">'''\n    home page function\n    :param name: str\n    :return: None\n    '''</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the home page'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">help</span><span class=\"token punctuation\">(</span>home<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token string\">''</span>'\n打印结果：\n\nHelp on function wrapper <span class=\"token keyword\">in</span> module __main__<span class=\"token punctuation\">:</span>\n\nwrapper<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n\n<span class=\"token boolean\">None</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-3380e05c82d8501f9ac1c2681311a062_720w.jpg\" alt=\"img\"></p>\n<p>在被装饰之后home&#x3D;wrapper,查看home.<strong>name</strong>也可以发现home的函数名确实是wrapper，想要保留原函数的文档和函数名属性，需要修正装饰器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    wrapper<span class=\"token punctuation\">.</span>__doc__<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>__doc__\n    wrapper<span class=\"token punctuation\">.</span>__name__<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>__name__\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照上述方式来实现保留原函数属性过于麻烦，functools模块下提供一个装饰器wraps专门用来帮我们实现这件事，用法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> functools <span class=\"token keyword\">import</span> wraps\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token decorator annotation punctuation\">@wraps</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-091acff94160bf2b8258553158168f79_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>简单装饰器的实现</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=47\">https://www.bilibili.com/video/av73342471?p=47www.bilibili.com/video/av73342471?p=47</a></p>\n<p>装饰器修订</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=48\">https://www.bilibili.com/video/av73342471?p=48www.bilibili.com/video/av73342471?p=48</a></p>\n<p>wraps补充</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=49\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=49<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-装饰器介绍\"><a href=\"#一-装饰器介绍\" class=\"headerlink\" title=\"一 装饰器介绍\"></a>一 装饰器介绍</h2><h2 id=\"1-1-为何要用装饰器\"><a href=\"#1-1-为何要用装饰器\" class=\"headerlink\" title=\"1.1 为何要用装饰器\"></a>1.1 为何要用装饰器</h2><p><img src=\"https://pic3.zhimg.com/80/v2-5f0bd90a1428a4b373be52c22f7d871a_720w.jpg\" alt=\"img\"></p>\n<p>软件的设计应该遵循开放封闭原则，即对扩展是开放的，而对修改是封闭的。对扩展开放，意味着有新的需求或变化时，可以对现有代码进行扩展，以适应新的情况。对修改封闭，意味着对象一旦设计完成，就可以独立完成其工作，而不要对其进行修改。</p>\n<p>软件包含的所有功能的源代码以及调用方式，都应该避免修改，否则一旦改错，则极有可能产生连锁反应，最终导致程序崩溃，而对于上线后的软件，新需求或者变化又层出不穷，我们必须为程序提供扩展的可能性，这就用到了装饰器。</p>\n<h2 id=\"1-2-什么是装饰器\"><a href=\"#1-2-什么是装饰器\" class=\"headerlink\" title=\"1.2 什么是装饰器\"></a>1.2 什么是装饰器</h2><p><img src=\"https://pic2.zhimg.com/80/v2-b43bfaa7c4abf2a53d535ce272d937b9_720w.jpg\" alt=\"img\"></p>\n<p>’装饰’代指为被装饰对象添加新的功能，’器’代指器具&#x2F;工具，装饰器与被装饰的对象均可以是任意可调用对象。概括地讲，装饰器的作用就是在不修改被装饰对象源代码和调用方式的前提下为被装饰对象添加额外的功能。装饰器经常用于有切面需求的场景，比如：插入日志、性能测试、事务处理、缓存、权限校验等应用场景，装饰器是解决这类问题的绝佳设计，有了装饰器，就可以抽离出大量与函数功能本身无关的雷同代码并继续重用。</p>\n<p>提示：可调用对象有函数，方法或者类，此处我们单以本章主题函数为例，来介绍函数装饰器，并且被装饰的对象也是函数。</p>\n<h2 id=\"二-装饰器的实现\"><a href=\"#二-装饰器的实现\" class=\"headerlink\" title=\"二 装饰器的实现\"></a>二 装饰器的实现</h2><p>函数装饰器分为：无参装饰器和有参装饰两种，二者的实现原理一样，都是’函数嵌套+闭包+函数对象’的组合使用的产物。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-21b3488ea792ad818b3eea81740f6945_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-1-无参装饰器的实现\"><a href=\"#2-1-无参装饰器的实现\" class=\"headerlink\" title=\"2.1 无参装饰器的实现\"></a>2.1 无参装饰器的实现</h2><p>如果想为下述函数添加统计其执行时间的功能</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> time\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>'Welcome to the index page’<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">200</span>\n\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#函数执行</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>遵循不修改被装饰对象源代码的原则，我们想到的解决方法可能是这样</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#函数执行</span>\nstop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-2e3af8429a3c2606c4cfbedb0b196e89_720w.jpg\" alt=\"img\"></p>\n<p>考虑到还有可能要统计其他函数的执行时间，于是我们将其做成一个单独的工具，函数体需要外部传入被装饰的函数从而进行调用，我们可以使用参数的形式传入</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 通过参数接收外部的值</span>\n    start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> res<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但之后函数的调用方式都需要统一改成</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">wrapper<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span>\nwrapper<span class=\"token punctuation\">(</span>其他函数<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>这便违反了不能修改被装饰对象调用方式的原则，于是我们换一种为函数体传值的方式，即将值包给函数，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># 引用外部作用域的变量func</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>这样我们便可以在不修改被装饰函数源代码和调用方式的前提下为其加上统计时间的功能，只不过需要事先执行一次timer将被装饰的函数传入，返回一个闭包函数wrapper重新赋值给变量名 &#x2F;函数名index，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">index<span class=\"token operator\">=</span>timer<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span>  <span class=\"token comment\">#得到index=wrapper，wrapper携带对外作用域的引用：func=原始的index</span>\nindex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 执行的是wrapper()，在wrapper的函数体内再执行最原始的index</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-6c1260375fb70d489df20b676c5cac51_720w.jpg\" alt=\"img\"></p>\n<p>至此我们便实现了一个无参装饰器timer，可以在不修改被装饰对象index源代码和调用方式的前提下为其加上新功能。但我们忽略了若被装饰的函数是一个有参函数，便会抛出异常</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the home page'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\n\nhome<span class=\"token operator\">=</span>timer<span class=\"token punctuation\">(</span>home<span class=\"token punctuation\">)</span>\nhome<span class=\"token punctuation\">(</span><span class=\"token string\">'egon'</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">#抛出异常</span>\nTypeError<span class=\"token punctuation\">:</span> wrapper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> takes <span class=\"token number\">0</span> positional arguments but <span class=\"token number\">1</span> was given<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>之所以会抛出异常，是因为home(‘egon’)调用的其实是wrapper(‘egon’)，而函数wrapper没有参数。wrapper函数接收的参数其实是给最原始的func用的，为了能满足被装饰函数参数的所有情况，便用上*args+**kwargs组合（见4.3小节）,于是修正装饰器timer如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-da8d9c6733f96b2a897c986e3515ffe3_720w.jpg\" alt=\"img\"></p>\n<p>此时我们就可以用timer来装饰带参数或不带参数的函数了，但是为了简洁而优雅地使用装饰器，Python提供了专门的装饰器语法来取代index&#x3D;timer(index)的形式，需要在被装饰对象的正上方单独一行添加@timer,当解释器解释到@timer时就会调用timer函数，且把它正下方的函数名当做实参传入，然后将返回的结果重新赋值给原函数名</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@timer</span> <span class=\"token comment\"># index=timer(index)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the index page'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token number\">200</span>\n<span class=\"token decorator annotation punctuation\">@timer</span> <span class=\"token comment\"># index=timer(home)</span>           <span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>'Welcome to the home page’<span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们有多个装饰器，可以叠加多个</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@deco3</span>\n<span class=\"token decorator annotation punctuation\">@deco2</span>\n<span class=\"token decorator annotation punctuation\">@deco1</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>叠加多个装饰器也无特殊之处，上述代码语义如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">index<span class=\"token operator\">=</span>deco3<span class=\"token punctuation\">(</span>deco2<span class=\"token punctuation\">(</span>deco1<span class=\"token punctuation\">(</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-c6e67404ac0e4319ce3cd89af56ead5d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"2-2-有参装饰器的实现\"><a href=\"#2-2-有参装饰器的实现\" class=\"headerlink\" title=\"2.2 有参装饰器的实现\"></a>2.2 有参装饰器的实现</h2><p>了解无参装饰器的实现原理后，我们可以再实现一个用来为被装饰对象添加认证功能的装饰器，实现的基本形式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        编写基于文件的认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们想提供多种不同的认证方式以供选择，单从wrapper函数的实现角度改写如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> driver <span class=\"token operator\">==</span> <span class=\"token string\">'file'</span><span class=\"token punctuation\">:</span>\n                编写基于文件的认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n            <span class=\"token keyword\">elif</span> driver <span class=\"token operator\">==</span> <span class=\"token string\">'mysql'</span><span class=\"token punctuation\">:</span>\n                编写基于mysql认证<span class=\"token punctuation\">,</span>认证通过则执行res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>并返回res\n        <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-82fb584a53b2277048a09561b3e19b58_720w.jpg\" alt=\"img\"></p>\n<p>函数wrapper需要一个driver参数，而函数deco与wrapper的参数都有其特定的功能，不能用来接受其他类别的参数，可以在deco的外部再包一层函数auth，用来专门接受额外的参数，这样便保证了在auth函数内无论多少层都可以引用到</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">deco</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        ……\n    <span class=\"token keyword\">return</span> deco<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>此时我们就实现了一个有参装饰器，使用方式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">先调用auth_type<span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">)</span>，得到@deco，deco是一个闭包函数，\n包含了对外部作用域名字driver的引用，@deco的语法意义与无参装饰器一样\n<span class=\"token decorator annotation punctuation\">@auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'file'</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>     \n    <span class=\"token keyword\">pass</span>\n<span class=\"token decorator annotation punctuation\">@auth</span><span class=\"token punctuation\">(</span>driver<span class=\"token operator\">=</span><span class=\"token string\">'mysql'</span><span class=\"token punctuation\">)</span> \n<span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">pass</span>  <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>可以使用help(函数名)来查看函数的文档注释，本质就是查看函数的<strong>doc</strong>属性，但对于被装饰之后的函数，查看文档注释</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@timer</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">home</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">'''\n    home page function\n    :param name: str\n    :return: None\n    '''</span>\n    time<span class=\"token punctuation\">.</span>sleep<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Welcome to the home page'</span><span class=\"token punctuation\">,</span>name<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">help</span><span class=\"token punctuation\">(</span>home<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token string\">''</span>'\n打印结果：\n\nHelp on function wrapper <span class=\"token keyword\">in</span> module __main__<span class=\"token punctuation\">:</span>\n\nwrapper<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n\n<span class=\"token boolean\">None</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-3380e05c82d8501f9ac1c2681311a062_720w.jpg\" alt=\"img\"></p>\n<p>在被装饰之后home&#x3D;wrapper,查看home.<strong>name</strong>也可以发现home的函数名确实是wrapper，想要保留原函数的文档和函数名属性，需要修正装饰器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    wrapper<span class=\"token punctuation\">.</span>__doc__<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>__doc__\n    wrapper<span class=\"token punctuation\">.</span>__name__<span class=\"token operator\">=</span>func<span class=\"token punctuation\">.</span>__name__\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>按照上述方式来实现保留原函数属性过于麻烦，functools模块下提供一个装饰器wraps专门用来帮我们实现这件事，用法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> functools <span class=\"token keyword\">import</span> wraps\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">timer</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token decorator annotation punctuation\">@wraps</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        start_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        res<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        stop_time<span class=\"token operator\">=</span>time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'run time is %s'</span> <span class=\"token operator\">%</span><span class=\"token punctuation\">(</span>stop_time<span class=\"token operator\">-</span>start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> res\n    <span class=\"token keyword\">return</span> wrapper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-091acff94160bf2b8258553158168f79_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p>简单装饰器的实现</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=47\">https://www.bilibili.com/video/av73342471?p=47www.bilibili.com/video/av73342471?p=47</a></p>\n<p>装饰器修订</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=48\">https://www.bilibili.com/video/av73342471?p=48www.bilibili.com/video/av73342471?p=48</a></p>\n<p>wraps补充</p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=49\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=49<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n"},{"_content":"类型提示 **Type hinting**（最低Python版本为3.5）\n\npython3新增类型提示功能，例如我们可以为函数增加类型提示信息，而不影响函数本身的执行：\n\n注释的一般规则是参数名后跟一个冒号（：），然后再跟一个expression，这个expression可以是任何形式。\n\n```text\ndef func(a: 'spam', b: (1, 10), c: float) -> int:\n    return a + b + c\n \n>>> func(1, 2, 3)\n6\n```\n\n返回值的形式是 -> int，annotation可被保存为函数的attributes。查看所有的annotation，可通过如下语句\n\n```text\n>>> func.__annotations__\n{'c': <class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': <class 'int'>}\n```\n\n如果为函数增加了注释，可不可以继续使用默认参数呢？答案是肯定的。\n\n```text\n>>> def func(a: 'spam' = 4, b: (1, 10) = 5, c: float = 6) -> int:\n...   return a + b + c\n... \n>>> func(1, 2, 3)\n6\n>>> func()\n15\n>>> func(1, c=10)\n16\n>>> func.__annotations__\n{'c': <class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': <class 'int'>}\n```","source":"_posts/03_Python/01_Python基础/54_附录九：Type.md","raw":"类型提示 **Type hinting**（最低Python版本为3.5）\n\npython3新增类型提示功能，例如我们可以为函数增加类型提示信息，而不影响函数本身的执行：\n\n注释的一般规则是参数名后跟一个冒号（：），然后再跟一个expression，这个expression可以是任何形式。\n\n```text\ndef func(a: 'spam', b: (1, 10), c: float) -> int:\n    return a + b + c\n \n>>> func(1, 2, 3)\n6\n```\n\n返回值的形式是 -> int，annotation可被保存为函数的attributes。查看所有的annotation，可通过如下语句\n\n```text\n>>> func.__annotations__\n{'c': <class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': <class 'int'>}\n```\n\n如果为函数增加了注释，可不可以继续使用默认参数呢？答案是肯定的。\n\n```text\n>>> def func(a: 'spam' = 4, b: (1, 10) = 5, c: float = 6) -> int:\n...   return a + b + c\n... \n>>> func(1, 2, 3)\n6\n>>> func()\n15\n>>> func(1, c=10)\n16\n>>> func.__annotations__\n{'c': <class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': <class 'int'>}\n```","slug":"03_Python/01_Python基础/54_附录九：Type","published":1,"date":"2022-07-18T07:10:19.389Z","updated":"2022-07-18T07:10:19.389Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k19002ia8v7esh42l7q","content":"<p>类型提示 <strong>Type hinting</strong>（最低Python版本为3.5）</p>\n<p>python3新增类型提示功能，例如我们可以为函数增加类型提示信息，而不影响函数本身的执行：</p>\n<p>注释的一般规则是参数名后跟一个冒号（：），然后再跟一个expression，这个expression可以是任何形式。</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">def func(a: 'spam', b: (1, 10), c: float) -> int:\n    return a + b + c\n \n>>> func(1, 2, 3)\n6<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>返回值的形式是 -&gt; int，annotation可被保存为函数的attributes。查看所有的annotation，可通过如下语句</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">>>> func.__annotations__\n&#123;'c': &lt;class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': &lt;class 'int'>&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>如果为函数增加了注释，可不可以继续使用默认参数呢？答案是肯定的。</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">>>> def func(a: 'spam' = 4, b: (1, 10) = 5, c: float = 6) -> int:\n...   return a + b + c\n... \n>>> func(1, 2, 3)\n6\n>>> func()\n15\n>>> func(1, c=10)\n16\n>>> func.__annotations__\n&#123;'c': &lt;class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': &lt;class 'int'>&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>","site":{"data":{}},"excerpt":"","more":"<p>类型提示 <strong>Type hinting</strong>（最低Python版本为3.5）</p>\n<p>python3新增类型提示功能，例如我们可以为函数增加类型提示信息，而不影响函数本身的执行：</p>\n<p>注释的一般规则是参数名后跟一个冒号（：），然后再跟一个expression，这个expression可以是任何形式。</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">def func(a: 'spam', b: (1, 10), c: float) -> int:\n    return a + b + c\n \n>>> func(1, 2, 3)\n6<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>返回值的形式是 -&gt; int，annotation可被保存为函数的attributes。查看所有的annotation，可通过如下语句</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">>>> func.__annotations__\n&#123;'c': &lt;class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': &lt;class 'int'>&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>如果为函数增加了注释，可不可以继续使用默认参数呢？答案是肯定的。</p>\n<pre class=\"line-numbers language-text\" data-language=\"text\"><code class=\"language-text\">>>> def func(a: 'spam' = 4, b: (1, 10) = 5, c: float = 6) -> int:\n...   return a + b + c\n... \n>>> func(1, 2, 3)\n6\n>>> func()\n15\n>>> func(1, c=10)\n16\n>>> func.__annotations__\n&#123;'c': &lt;class 'float'>, 'a': 'spam', 'b': (1, 10), 'return': &lt;class 'int'>&#125;<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>"},{"_content":"## 一 迭代器介绍\n\n迭代器即用来迭代取值的工具，而迭代是重复反馈过程的活动，其目的通常是为了逼近所需的目标或结果，每一次对过程的重复称为一次“迭代”，而每一次迭代得到的结果会作为下一次迭代的初始值,单纯的重复并不是迭代\n\n![img](https://pic4.zhimg.com/80/v2-565373773a847faa7a97a79b8851d2db_720w.jpg)\n\n```python\nwhile True:\n    msg = input('>>: ').strip()\n    print(msg)\n```\n\n下述while循环才是一个迭代过程，不仅满足重复，而且以每次重新赋值后的index值作为下一次循环中新的索引进行取值，反复迭代，最终可以取尽列表中的值\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\n\nindex=0\nwhile index < len(goods):\n    print(goods[index])\n    index+=1\n```\n\n![img](https://pic2.zhimg.com/80/v2-70866f67008dbbd32b1db9a0122e5a85_720w.jpg)\n\n## 1.1 可迭代对象\n\n通过索引的方式进行迭代取值，实现简单，但仅适用于序列类型：字符串，列表，元组。对于没有索引的字典、集合等非序列类型，必须找到一种不依赖索引来进行迭代取值的方式，这就用到了迭代器。\n\n要想了解迭代器为何物，必须事先搞清楚一个很重要的概念：可迭代对象(Iterable)。从语法形式上讲，内置有__iter__方法的对象都是可迭代对象，字符串、列表、元组、字典、集合、打开的文件都是可迭代对象：\n\n```python\n{'name':'egon'}.__iter__\n{7,8,9}.__iter__\n……\n```\n\n![img](https://pic1.zhimg.com/80/v2-2d426dd7229747e25b7342c4bba5be50_720w.jpg)\n\n### 1.2 迭代器对象\n\n调用obj.**iter**()方法返回的结果就是一个迭代器对象(Iterator)。迭代器对象是内置有**iter**和**next**方法的对象，打开的文件本身就是一个迭代器对象，执行迭代器对象.**iter**()方法得到的仍然是迭代器本身，而执行迭代器.**next**()方法就会计算出迭代器中的下一个值。 迭代器是Python提供的一种统一的、不依赖于索引的迭代取值方式，只要存在多个“值”，无论序列类型还是非序列类型都可以按照迭代器的方式取值\n\n```python\n>>> s={1,2,3} # 可迭代对象s\n>>> i=iter(s)  # 本质就是在调用s.__iter__(),返回s的迭代器对象i，\n>>> next(i) # 本质就是在调用i.__next__()\n1\n>>> next(i)\n2\n>>> next(i)\n3\n>>> next(i)  #抛出StopIteration的异常，代表无值可取，迭代结束\n```\n\n![img](https://pic4.zhimg.com/80/v2-737e0d369eb76a990b772d9666e25a4f_720w.jpg)\n\n## 二 for循环原理\n\n有了迭代器后，我们便可以不依赖索引迭代取值了，使用while循环的实现方式如下\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\ni=iter(goods) #每次都需要重新获取一个迭代器对象\nwhile True:\n    try:\n        print(next(i))\n    except StopIteration: #捕捉异常终止循环\n        break\n```\n\nfor循环又称为迭代循环，in后可以跟任意可迭代对象，上述while循环可以简写为\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\nfor item in goods:   \n    print(item)\n```\n\nfor 循环在工作时，首先会调用可迭代对象goods内置的**iter**方法拿到一个迭代器对象，然后再调用该迭代器对象的**next**方法将取到的值赋给item,执行循环体完成一次循环，周而复始，直到捕捉StopIteration异常，结束迭代。\n\n![img](https://pic2.zhimg.com/80/v2-c64b3c28a2b8977bfce7621078da63b9_720w.jpg)\n\n## 三 迭代器的优缺点\n\n基于索引的迭代取值，所有迭代的状态都保存在了索引中，而基于迭代器实现迭代的方式不再需要索引，所有迭代的状态就保存在迭代器中，然而这种处理方式优点与缺点并存：\n\n## 3.1 优点：\n\n1、为序列和非序列类型提供了一种统一的迭代取值方式。\n\n2、惰性计算：迭代器对象表示的是一个数据流，可以只在需要时才去调用**next**来计算出一个值，就迭代器本身来说，同一时刻在内存中只有一个值，因而可以存放无限大的数据流，而对于其他容器类型，如列表，需要把所有的元素都存放于内存中，受内存大小的限制，可以存放的值的个数是有限的。\n\n![img](https://pic2.zhimg.com/80/v2-c91b05bd30f1abae45ec6867bb5e9625_720w.jpg)\n\n## 3.2 缺点：\n\n1、除非取尽，否则无法获取迭代器的长度\n\n2、只能取下一个值，不能回到开始，更像是‘一次性的’，迭代器产生后的唯一目标就是重复执行next方法直到值取尽，否则就会停留在某个位置，等待下一次调用next；若是要再次迭代同个对象，你只能重新调用iter方法去创建一个新的迭代器对象，如果有两个或者多个循环使用同一个迭代器，必然只会有一个循环能取到值。\n\n![img](https://pic2.zhimg.com/80/v2-8e0f71376333332d0411bb2199131c6d_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471?p=51www.bilibili.com/video/av73342471?p=51](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D51)","source":"_posts/03_Python/01_Python基础/16_迭代器.md","raw":"## 一 迭代器介绍\n\n迭代器即用来迭代取值的工具，而迭代是重复反馈过程的活动，其目的通常是为了逼近所需的目标或结果，每一次对过程的重复称为一次“迭代”，而每一次迭代得到的结果会作为下一次迭代的初始值,单纯的重复并不是迭代\n\n![img](https://pic4.zhimg.com/80/v2-565373773a847faa7a97a79b8851d2db_720w.jpg)\n\n```python\nwhile True:\n    msg = input('>>: ').strip()\n    print(msg)\n```\n\n下述while循环才是一个迭代过程，不仅满足重复，而且以每次重新赋值后的index值作为下一次循环中新的索引进行取值，反复迭代，最终可以取尽列表中的值\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\n\nindex=0\nwhile index < len(goods):\n    print(goods[index])\n    index+=1\n```\n\n![img](https://pic2.zhimg.com/80/v2-70866f67008dbbd32b1db9a0122e5a85_720w.jpg)\n\n## 1.1 可迭代对象\n\n通过索引的方式进行迭代取值，实现简单，但仅适用于序列类型：字符串，列表，元组。对于没有索引的字典、集合等非序列类型，必须找到一种不依赖索引来进行迭代取值的方式，这就用到了迭代器。\n\n要想了解迭代器为何物，必须事先搞清楚一个很重要的概念：可迭代对象(Iterable)。从语法形式上讲，内置有__iter__方法的对象都是可迭代对象，字符串、列表、元组、字典、集合、打开的文件都是可迭代对象：\n\n```python\n{'name':'egon'}.__iter__\n{7,8,9}.__iter__\n……\n```\n\n![img](https://pic1.zhimg.com/80/v2-2d426dd7229747e25b7342c4bba5be50_720w.jpg)\n\n### 1.2 迭代器对象\n\n调用obj.**iter**()方法返回的结果就是一个迭代器对象(Iterator)。迭代器对象是内置有**iter**和**next**方法的对象，打开的文件本身就是一个迭代器对象，执行迭代器对象.**iter**()方法得到的仍然是迭代器本身，而执行迭代器.**next**()方法就会计算出迭代器中的下一个值。 迭代器是Python提供的一种统一的、不依赖于索引的迭代取值方式，只要存在多个“值”，无论序列类型还是非序列类型都可以按照迭代器的方式取值\n\n```python\n>>> s={1,2,3} # 可迭代对象s\n>>> i=iter(s)  # 本质就是在调用s.__iter__(),返回s的迭代器对象i，\n>>> next(i) # 本质就是在调用i.__next__()\n1\n>>> next(i)\n2\n>>> next(i)\n3\n>>> next(i)  #抛出StopIteration的异常，代表无值可取，迭代结束\n```\n\n![img](https://pic4.zhimg.com/80/v2-737e0d369eb76a990b772d9666e25a4f_720w.jpg)\n\n## 二 for循环原理\n\n有了迭代器后，我们便可以不依赖索引迭代取值了，使用while循环的实现方式如下\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\ni=iter(goods) #每次都需要重新获取一个迭代器对象\nwhile True:\n    try:\n        print(next(i))\n    except StopIteration: #捕捉异常终止循环\n        break\n```\n\nfor循环又称为迭代循环，in后可以跟任意可迭代对象，上述while循环可以简写为\n\n```python\ngoods=['mac','lenovo','acer','dell','sony']\nfor item in goods:   \n    print(item)\n```\n\nfor 循环在工作时，首先会调用可迭代对象goods内置的**iter**方法拿到一个迭代器对象，然后再调用该迭代器对象的**next**方法将取到的值赋给item,执行循环体完成一次循环，周而复始，直到捕捉StopIteration异常，结束迭代。\n\n![img](https://pic2.zhimg.com/80/v2-c64b3c28a2b8977bfce7621078da63b9_720w.jpg)\n\n## 三 迭代器的优缺点\n\n基于索引的迭代取值，所有迭代的状态都保存在了索引中，而基于迭代器实现迭代的方式不再需要索引，所有迭代的状态就保存在迭代器中，然而这种处理方式优点与缺点并存：\n\n## 3.1 优点：\n\n1、为序列和非序列类型提供了一种统一的迭代取值方式。\n\n2、惰性计算：迭代器对象表示的是一个数据流，可以只在需要时才去调用**next**来计算出一个值，就迭代器本身来说，同一时刻在内存中只有一个值，因而可以存放无限大的数据流，而对于其他容器类型，如列表，需要把所有的元素都存放于内存中，受内存大小的限制，可以存放的值的个数是有限的。\n\n![img](https://pic2.zhimg.com/80/v2-c91b05bd30f1abae45ec6867bb5e9625_720w.jpg)\n\n## 3.2 缺点：\n\n1、除非取尽，否则无法获取迭代器的长度\n\n2、只能取下一个值，不能回到开始，更像是‘一次性的’，迭代器产生后的唯一目标就是重复执行next方法直到值取尽，否则就会停留在某个位置，等待下一次调用next；若是要再次迭代同个对象，你只能重新调用iter方法去创建一个新的迭代器对象，如果有两个或者多个循环使用同一个迭代器，必然只会有一个循环能取到值。\n\n![img](https://pic2.zhimg.com/80/v2-8e0f71376333332d0411bb2199131c6d_720w.jpg)\n\n## 视频链接：\n\n[https://www.bilibili.com/video/av73342471?p=51www.bilibili.com/video/av73342471?p=51](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D51)","slug":"03_Python/01_Python基础/16_迭代器","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k19002ka8v73qbv77mi","content":"<h2 id=\"一-迭代器介绍\"><a href=\"#一-迭代器介绍\" class=\"headerlink\" title=\"一 迭代器介绍\"></a>一 迭代器介绍</h2><p>迭代器即用来迭代取值的工具，而迭代是重复反馈过程的活动，其目的通常是为了逼近所需的目标或结果，每一次对过程的重复称为一次“迭代”，而每一次迭代得到的结果会作为下一次迭代的初始值,单纯的重复并不是迭代</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-565373773a847faa7a97a79b8851d2db_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    msg <span class=\"token operator\">=</span> <span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>下述while循环才是一个迭代过程，不仅满足重复，而且以每次重新赋值后的index值作为下一次循环中新的索引进行取值，反复迭代，最终可以取尽列表中的值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\n\nindex<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token keyword\">while</span> index <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    index<span class=\"token operator\">+=</span><span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-70866f67008dbbd32b1db9a0122e5a85_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-可迭代对象\"><a href=\"#1-1-可迭代对象\" class=\"headerlink\" title=\"1.1 可迭代对象\"></a>1.1 可迭代对象</h2><p>通过索引的方式进行迭代取值，实现简单，但仅适用于序列类型：字符串，列表，元组。对于没有索引的字典、集合等非序列类型，必须找到一种不依赖索引来进行迭代取值的方式，这就用到了迭代器。</p>\n<p>要想了解迭代器为何物，必须事先搞清楚一个很重要的概念：可迭代对象(Iterable)。从语法形式上讲，内置有__iter__方法的对象都是可迭代对象，字符串、列表、元组、字典、集合、打开的文件都是可迭代对象：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'egon'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span>__iter__\n<span class=\"token punctuation\">&#123;</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span>__iter__\n……<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-2d426dd7229747e25b7342c4bba5be50_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"1-2-迭代器对象\"><a href=\"#1-2-迭代器对象\" class=\"headerlink\" title=\"1.2 迭代器对象\"></a>1.2 迭代器对象</h3><p>调用obj.<strong>iter</strong>()方法返回的结果就是一个迭代器对象(Iterator)。迭代器对象是内置有<strong>iter</strong>和<strong>next</strong>方法的对象，打开的文件本身就是一个迭代器对象，执行迭代器对象.<strong>iter</strong>()方法得到的仍然是迭代器本身，而执行迭代器.<strong>next</strong>()方法就会计算出迭代器中的下一个值。 迭代器是Python提供的一种统一的、不依赖于索引的迭代取值方式，只要存在多个“值”，无论序列类型还是非序列类型都可以按照迭代器的方式取值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> s<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\"># 可迭代对象s</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> i<span class=\"token operator\">=</span><span class=\"token builtin\">iter</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 本质就是在调用s.__iter__(),返回s的迭代器对象i，</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 本质就是在调用i.__next__()</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token number\">2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>  <span class=\"token comment\">#抛出StopIteration的异常，代表无值可取，迭代结束</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-737e0d369eb76a990b772d9666e25a4f_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-for循环原理\"><a href=\"#二-for循环原理\" class=\"headerlink\" title=\"二 for循环原理\"></a>二 for循环原理</h2><p>有了迭代器后，我们便可以不依赖索引迭代取值了，使用while循环的实现方式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\ni<span class=\"token operator\">=</span><span class=\"token builtin\">iter</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">)</span> <span class=\"token comment\">#每次都需要重新获取一个迭代器对象</span>\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> StopIteration<span class=\"token punctuation\">:</span> <span class=\"token comment\">#捕捉异常终止循环</span>\n        <span class=\"token keyword\">break</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>for循环又称为迭代循环，in后可以跟任意可迭代对象，上述while循环可以简写为</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> goods<span class=\"token punctuation\">:</span>   \n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>for 循环在工作时，首先会调用可迭代对象goods内置的<strong>iter</strong>方法拿到一个迭代器对象，然后再调用该迭代器对象的<strong>next</strong>方法将取到的值赋给item,执行循环体完成一次循环，周而复始，直到捕捉StopIteration异常，结束迭代。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-c64b3c28a2b8977bfce7621078da63b9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-迭代器的优缺点\"><a href=\"#三-迭代器的优缺点\" class=\"headerlink\" title=\"三 迭代器的优缺点\"></a>三 迭代器的优缺点</h2><p>基于索引的迭代取值，所有迭代的状态都保存在了索引中，而基于迭代器实现迭代的方式不再需要索引，所有迭代的状态就保存在迭代器中，然而这种处理方式优点与缺点并存：</p>\n<h2 id=\"3-1-优点：\"><a href=\"#3-1-优点：\" class=\"headerlink\" title=\"3.1 优点：\"></a>3.1 优点：</h2><p>1、为序列和非序列类型提供了一种统一的迭代取值方式。</p>\n<p>2、惰性计算：迭代器对象表示的是一个数据流，可以只在需要时才去调用<strong>next</strong>来计算出一个值，就迭代器本身来说，同一时刻在内存中只有一个值，因而可以存放无限大的数据流，而对于其他容器类型，如列表，需要把所有的元素都存放于内存中，受内存大小的限制，可以存放的值的个数是有限的。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-c91b05bd30f1abae45ec6867bb5e9625_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-缺点：\"><a href=\"#3-2-缺点：\" class=\"headerlink\" title=\"3.2 缺点：\"></a>3.2 缺点：</h2><p>1、除非取尽，否则无法获取迭代器的长度</p>\n<p>2、只能取下一个值，不能回到开始，更像是‘一次性的’，迭代器产生后的唯一目标就是重复执行next方法直到值取尽，否则就会停留在某个位置，等待下一次调用next；若是要再次迭代同个对象，你只能重新调用iter方法去创建一个新的迭代器对象，如果有两个或者多个循环使用同一个迭代器，必然只会有一个循环能取到值。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-8e0f71376333332d0411bb2199131c6d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=51\">https://www.bilibili.com/video/av73342471?p=51www.bilibili.com/video/av73342471?p=51</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-迭代器介绍\"><a href=\"#一-迭代器介绍\" class=\"headerlink\" title=\"一 迭代器介绍\"></a>一 迭代器介绍</h2><p>迭代器即用来迭代取值的工具，而迭代是重复反馈过程的活动，其目的通常是为了逼近所需的目标或结果，每一次对过程的重复称为一次“迭代”，而每一次迭代得到的结果会作为下一次迭代的初始值,单纯的重复并不是迭代</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-565373773a847faa7a97a79b8851d2db_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    msg <span class=\"token operator\">=</span> <span class=\"token builtin\">input</span><span class=\"token punctuation\">(</span><span class=\"token string\">'>>: '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>下述while循环才是一个迭代过程，不仅满足重复，而且以每次重新赋值后的index值作为下一次循环中新的索引进行取值，反复迭代，最终可以取尽列表中的值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\n\nindex<span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token keyword\">while</span> index <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    index<span class=\"token operator\">+=</span><span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-70866f67008dbbd32b1db9a0122e5a85_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"1-1-可迭代对象\"><a href=\"#1-1-可迭代对象\" class=\"headerlink\" title=\"1.1 可迭代对象\"></a>1.1 可迭代对象</h2><p>通过索引的方式进行迭代取值，实现简单，但仅适用于序列类型：字符串，列表，元组。对于没有索引的字典、集合等非序列类型，必须找到一种不依赖索引来进行迭代取值的方式，这就用到了迭代器。</p>\n<p>要想了解迭代器为何物，必须事先搞清楚一个很重要的概念：可迭代对象(Iterable)。从语法形式上讲，内置有__iter__方法的对象都是可迭代对象，字符串、列表、元组、字典、集合、打开的文件都是可迭代对象：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">&#123;</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">:</span><span class=\"token string\">'egon'</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span>__iter__\n<span class=\"token punctuation\">&#123;</span><span class=\"token number\">7</span><span class=\"token punctuation\">,</span><span class=\"token number\">8</span><span class=\"token punctuation\">,</span><span class=\"token number\">9</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">.</span>__iter__\n……<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-2d426dd7229747e25b7342c4bba5be50_720w.jpg\" alt=\"img\"></p>\n<h3 id=\"1-2-迭代器对象\"><a href=\"#1-2-迭代器对象\" class=\"headerlink\" title=\"1.2 迭代器对象\"></a>1.2 迭代器对象</h3><p>调用obj.<strong>iter</strong>()方法返回的结果就是一个迭代器对象(Iterator)。迭代器对象是内置有<strong>iter</strong>和<strong>next</strong>方法的对象，打开的文件本身就是一个迭代器对象，执行迭代器对象.<strong>iter</strong>()方法得到的仍然是迭代器本身，而执行迭代器.<strong>next</strong>()方法就会计算出迭代器中的下一个值。 迭代器是Python提供的一种统一的、不依赖于索引的迭代取值方式，只要存在多个“值”，无论序列类型还是非序列类型都可以按照迭代器的方式取值</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> s<span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">&#125;</span> <span class=\"token comment\"># 可迭代对象s</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> i<span class=\"token operator\">=</span><span class=\"token builtin\">iter</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 本质就是在调用s.__iter__(),返回s的迭代器对象i，</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 本质就是在调用i.__next__()</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token number\">2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token number\">3</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>  <span class=\"token comment\">#抛出StopIteration的异常，代表无值可取，迭代结束</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic4.zhimg.com/80/v2-737e0d369eb76a990b772d9666e25a4f_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-for循环原理\"><a href=\"#二-for循环原理\" class=\"headerlink\" title=\"二 for循环原理\"></a>二 for循环原理</h2><p>有了迭代器后，我们便可以不依赖索引迭代取值了，使用while循环的实现方式如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\ni<span class=\"token operator\">=</span><span class=\"token builtin\">iter</span><span class=\"token punctuation\">(</span>goods<span class=\"token punctuation\">)</span> <span class=\"token comment\">#每次都需要重新获取一个迭代器对象</span>\n<span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">except</span> StopIteration<span class=\"token punctuation\">:</span> <span class=\"token comment\">#捕捉异常终止循环</span>\n        <span class=\"token keyword\">break</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>for循环又称为迭代循环，in后可以跟任意可迭代对象，上述while循环可以简写为</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">goods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'mac'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'lenovo'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'acer'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'dell'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'sony'</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> goods<span class=\"token punctuation\">:</span>   \n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>for 循环在工作时，首先会调用可迭代对象goods内置的<strong>iter</strong>方法拿到一个迭代器对象，然后再调用该迭代器对象的<strong>next</strong>方法将取到的值赋给item,执行循环体完成一次循环，周而复始，直到捕捉StopIteration异常，结束迭代。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-c64b3c28a2b8977bfce7621078da63b9_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"三-迭代器的优缺点\"><a href=\"#三-迭代器的优缺点\" class=\"headerlink\" title=\"三 迭代器的优缺点\"></a>三 迭代器的优缺点</h2><p>基于索引的迭代取值，所有迭代的状态都保存在了索引中，而基于迭代器实现迭代的方式不再需要索引，所有迭代的状态就保存在迭代器中，然而这种处理方式优点与缺点并存：</p>\n<h2 id=\"3-1-优点：\"><a href=\"#3-1-优点：\" class=\"headerlink\" title=\"3.1 优点：\"></a>3.1 优点：</h2><p>1、为序列和非序列类型提供了一种统一的迭代取值方式。</p>\n<p>2、惰性计算：迭代器对象表示的是一个数据流，可以只在需要时才去调用<strong>next</strong>来计算出一个值，就迭代器本身来说，同一时刻在内存中只有一个值，因而可以存放无限大的数据流，而对于其他容器类型，如列表，需要把所有的元素都存放于内存中，受内存大小的限制，可以存放的值的个数是有限的。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-c91b05bd30f1abae45ec6867bb5e9625_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-缺点：\"><a href=\"#3-2-缺点：\" class=\"headerlink\" title=\"3.2 缺点：\"></a>3.2 缺点：</h2><p>1、除非取尽，否则无法获取迭代器的长度</p>\n<p>2、只能取下一个值，不能回到开始，更像是‘一次性的’，迭代器产生后的唯一目标就是重复执行next方法直到值取尽，否则就会停留在某个位置，等待下一次调用next；若是要再次迭代同个对象，你只能重新调用iter方法去创建一个新的迭代器对象，如果有两个或者多个循环使用同一个迭代器，必然只会有一个循环能取到值。</p>\n<p><img src=\"https://pic2.zhimg.com/80/v2-8e0f71376333332d0411bb2199131c6d_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=51\">https://www.bilibili.com/video/av73342471?p=51www.bilibili.com/video/av73342471?p=51</a></p>\n"},{"_content":"## 一 生成器与yield\n\n![img](https://pic2.zhimg.com/80/v2-2c92ed3ae0da1fd192339be9abc973a1_720w.jpg)\n\n若函数体包含yield关键字，再调用函数，并不会执行函数体代码，得到的返回值即生成器对象\n\n```python\n>>> def my_range(start,stop,step=1):\n...     print('start...')\n...     while start < stop:\n...         yield start\n...         start+=step\n...     print('end...')\n... \n>>> g=my_range(0,3)\n>>> g\n<generator object my_range at 0x104105678>\n```\n\n生成器内置有__iter__和__next__方法，所以生成器本身就是一个迭代器\n\n```python\n>>> g.__iter__\n<method-wrapper '__iter__' of generator object at 0x1037d2af0>\n>>> g.__next__\n<method-wrapper '__next__' of generator object at 0x1037d2af0>\n```\n\n![img](https://pic2.zhimg.com/80/v2-31590362f23201814f45879db5dd6a51_720w.jpg)\n\n因而我们可以用next(生成器)触发生成器所对应函数的执行，\n\n```python\n>>> next(g) # 触发函数执行直到遇到yield则停止,将yield后的值返回，并在当前位置挂起函数\nstart...\n0\n>>> next(g) # 再次调用next(g)，函数从上次暂停的位置继续执行，直到重新遇到yield...\n1\n>>> next(g) # 周而复始...\n2\n>>> next(g) # 触发函数执行没有遇到yield则无值返回，即取值完毕抛出异常结束迭代\nend...\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nStopIteration\n```\n\n![img](https://pic2.zhimg.com/80/v2-fa04ec0eaa5bd7bb8804908ad7b88369_720w.jpg)\n\n既然生成器对象属于迭代器，那么必然可以使用for循环迭代，如下：\n\n```python\n>>> for i in countdown(3):\n...     print(i)\n... \ncountdown start\n3\n2\n1\nDone!\n```\n\n有了yield关键字，我们就有了一种自定义迭代器的实现方式。yield可以用于返回值，但不同于return，函数一旦遇到return就结束了，而yield可以保存函数的运行状态挂起函数，用来返回多次值\n\n![img](https://pic4.zhimg.com/80/v2-024f3ac36393f784226497828d53eebf_720w.jpg)\n\n## 二 yield表达式应用\n\n在函数内可以采用表达式形式的yield\n\n```python\n>>> def eater():\n...     print('Ready to eat')\n...     while True:\n...         food=yield\n...         print('get the food: %s, and start to eat' %food)\n...\n```\n\n可以拿到函数的生成器对象持续为函数体send值，如下\n\n```python\n>>> g=eater() # 得到生成器对象\n>>> g\n<generator object eater at 0x101b6e2b0>\n>>> next(e) # 需要事先”初始化”一次，让函数挂起在food=yield，等待调用g.send()方法为其传值\nReady to eat\n>>> g.send('包子')\nget the food: 包子, and start to eat\n>>> g.send('鸡腿')\nget the food: 鸡腿, and start to eat\n```\n\n针对表达式形式的yield，生成器对象必须事先被初始化一次，让函数挂起在food=yield的位置，等待调用g.send()方法为函数体传值，g.send(None)等同于next(g)。\n\n![img](https://pic1.zhimg.com/80/v2-277c3fe7374520dba8973dea02474790_720w.jpg)\n\n 我们可以编写装饰器来完成为所有表达式形式yield对应生成器的初始化操作，如下\n\n```python\ndef init(func):\n    def wrapper(*args,**kwargs):\n        g=func(*args,**kwargs)\n        next(g)\n        return g\n    return wrapper\n\n@init\ndef eater():\n    print('Ready to eat')\n    while True:\n        food=yield\n        print('get the food: %s, and start to eat' %food)\n```\n\n表达式形式的yield也可以用于返回多次值，即`变量名=yield 值`的形式，如下\n\n```python\n>>> def eater():\n...     print('Ready to eat')\n...     food_list=[]\n...     while True:\n...         food=yield food_list\n...         food_list.append(food)\n... \n>>> e=eater()\n>>> next(e)\nReady to eat\n[]\n>>> e.send('蒸羊羔')\n['蒸羊羔']\n>>> e.send('蒸熊掌')\n['蒸羊羔', '蒸熊掌']\n>>> e.send('蒸鹿尾儿')\n['蒸羊羔', '蒸熊掌', '蒸鹿尾儿']\n```\n\n## 三 三元表达式、列表生成式、生成器表达式\n\n## 3.1 三元表达式\n\n三元表达式是python为我们提供的一种简化代码的解决方案，语法如下\n\n```python\nres = 条件成立时返回的值 if 条件 else 条件不成立时返回的值\n```\n\n针对下述场景\n\n```python\ndef max2(x,y):\n    if x > y:\n        return x\n    else:\n        return y\n\nres = max2(1,2)\n```\n\n用三元表达式可以一行解决\n\n```python\nx=1\ny=2\nres = x if x > y else y # 三元表达式\n```\n\n![img](https://pic2.zhimg.com/80/v2-6b5e335f9c2baca1a9d076721c672b19_720w.jpg)\n\n## 3.2 列表生成式\n\n列表生成式是python为我们提供的一种简化代码的解决方案，用来快速生成列表，语法如下\n\n```python\n[expression for item1 in iterable1 if condition1\nfor item2 in iterable2 if condition2\n...\nfor itemN in iterableN if conditionN\n]\n\n#类似于\nres=[]\nfor item1 in iterable1:\n    if condition1:\n        for item2 in iterable2:\n            if condition2\n                ...\n                for itemN in iterableN:\n                    if conditionN:\n                        res.append(expression)\n```\n\n针对下述场景\n\n```python\negg_list=[]\nfor i in range(10):\n    egg_list.append('鸡蛋%s' %i)\n```\n\n用列表生成式可以一行解决\n\n```python\negg_list=['鸡蛋%s' %i for i in range(10)]\n```\n\n![img](https://pic3.zhimg.com/80/v2-d9640f4c3f1c13bbd78e7cf6de6dc316_720w.jpg)\n\n## 3.3 生成器表达式\n\n创建一个生成器对象有两种方式，一种是调用带yield关键字的函数，另一种就是生成器表达式，与列表生成式的语法格式相同，只需要将[]换成()，即：\n\n![img](https://pic3.zhimg.com/80/v2-70257d333a3e9a49704c10982ce48856_720w.jpg)\n\n```python\n（expression for item in iterable if condition）\n```\n\n对比列表生成式返回的是一个列表，生成器表达式返回的是一个生成器对象\n\n```python\n>>> [x*x for x in range(3)]\n[0, 1, 4]\n>>> g=(x*x for x in range(3))\n>>> g\n<generator object <genexpr> at 0x101be0ba0>\n```\n\n对比列表生成式，生成器表达式的优点自然是节省内存（一次只产生一个值在内存中）\n\n```python\n>>> next(g)\n0\n>>> next(g)\n1\n>>> next(g)\n4\n>>> next(g) #抛出异常StopIteration\n```\n\n如果我们要读取一个大文件的字节数，应该基于生成器表达式的方式完成\n\n```python\nwith open('db.txt','rb') as f:\n    nums=(len(line) for line in f)\n    total_size=sum(nums) # 依次执行next(nums)，然后累加到一起得到结果=\n```\n\n![img](https://pic1.zhimg.com/80/v2-f0a061871b663d857e13ada7c10b31ac_720w.jpg)\n\n## 视频链接：\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=52![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D52)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=53![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D53)\n\n[https://www.bilibili.com/video/av73342471?p=54www.bilibili.com/video/av73342471?p=54](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D54)","source":"_posts/03_Python/01_Python基础/17_生成器.md","raw":"## 一 生成器与yield\n\n![img](https://pic2.zhimg.com/80/v2-2c92ed3ae0da1fd192339be9abc973a1_720w.jpg)\n\n若函数体包含yield关键字，再调用函数，并不会执行函数体代码，得到的返回值即生成器对象\n\n```python\n>>> def my_range(start,stop,step=1):\n...     print('start...')\n...     while start < stop:\n...         yield start\n...         start+=step\n...     print('end...')\n... \n>>> g=my_range(0,3)\n>>> g\n<generator object my_range at 0x104105678>\n```\n\n生成器内置有__iter__和__next__方法，所以生成器本身就是一个迭代器\n\n```python\n>>> g.__iter__\n<method-wrapper '__iter__' of generator object at 0x1037d2af0>\n>>> g.__next__\n<method-wrapper '__next__' of generator object at 0x1037d2af0>\n```\n\n![img](https://pic2.zhimg.com/80/v2-31590362f23201814f45879db5dd6a51_720w.jpg)\n\n因而我们可以用next(生成器)触发生成器所对应函数的执行，\n\n```python\n>>> next(g) # 触发函数执行直到遇到yield则停止,将yield后的值返回，并在当前位置挂起函数\nstart...\n0\n>>> next(g) # 再次调用next(g)，函数从上次暂停的位置继续执行，直到重新遇到yield...\n1\n>>> next(g) # 周而复始...\n2\n>>> next(g) # 触发函数执行没有遇到yield则无值返回，即取值完毕抛出异常结束迭代\nend...\nTraceback (most recent call last):\n  File \"<stdin>\", line 1, in <module>\nStopIteration\n```\n\n![img](https://pic2.zhimg.com/80/v2-fa04ec0eaa5bd7bb8804908ad7b88369_720w.jpg)\n\n既然生成器对象属于迭代器，那么必然可以使用for循环迭代，如下：\n\n```python\n>>> for i in countdown(3):\n...     print(i)\n... \ncountdown start\n3\n2\n1\nDone!\n```\n\n有了yield关键字，我们就有了一种自定义迭代器的实现方式。yield可以用于返回值，但不同于return，函数一旦遇到return就结束了，而yield可以保存函数的运行状态挂起函数，用来返回多次值\n\n![img](https://pic4.zhimg.com/80/v2-024f3ac36393f784226497828d53eebf_720w.jpg)\n\n## 二 yield表达式应用\n\n在函数内可以采用表达式形式的yield\n\n```python\n>>> def eater():\n...     print('Ready to eat')\n...     while True:\n...         food=yield\n...         print('get the food: %s, and start to eat' %food)\n...\n```\n\n可以拿到函数的生成器对象持续为函数体send值，如下\n\n```python\n>>> g=eater() # 得到生成器对象\n>>> g\n<generator object eater at 0x101b6e2b0>\n>>> next(e) # 需要事先”初始化”一次，让函数挂起在food=yield，等待调用g.send()方法为其传值\nReady to eat\n>>> g.send('包子')\nget the food: 包子, and start to eat\n>>> g.send('鸡腿')\nget the food: 鸡腿, and start to eat\n```\n\n针对表达式形式的yield，生成器对象必须事先被初始化一次，让函数挂起在food=yield的位置，等待调用g.send()方法为函数体传值，g.send(None)等同于next(g)。\n\n![img](https://pic1.zhimg.com/80/v2-277c3fe7374520dba8973dea02474790_720w.jpg)\n\n 我们可以编写装饰器来完成为所有表达式形式yield对应生成器的初始化操作，如下\n\n```python\ndef init(func):\n    def wrapper(*args,**kwargs):\n        g=func(*args,**kwargs)\n        next(g)\n        return g\n    return wrapper\n\n@init\ndef eater():\n    print('Ready to eat')\n    while True:\n        food=yield\n        print('get the food: %s, and start to eat' %food)\n```\n\n表达式形式的yield也可以用于返回多次值，即`变量名=yield 值`的形式，如下\n\n```python\n>>> def eater():\n...     print('Ready to eat')\n...     food_list=[]\n...     while True:\n...         food=yield food_list\n...         food_list.append(food)\n... \n>>> e=eater()\n>>> next(e)\nReady to eat\n[]\n>>> e.send('蒸羊羔')\n['蒸羊羔']\n>>> e.send('蒸熊掌')\n['蒸羊羔', '蒸熊掌']\n>>> e.send('蒸鹿尾儿')\n['蒸羊羔', '蒸熊掌', '蒸鹿尾儿']\n```\n\n## 三 三元表达式、列表生成式、生成器表达式\n\n## 3.1 三元表达式\n\n三元表达式是python为我们提供的一种简化代码的解决方案，语法如下\n\n```python\nres = 条件成立时返回的值 if 条件 else 条件不成立时返回的值\n```\n\n针对下述场景\n\n```python\ndef max2(x,y):\n    if x > y:\n        return x\n    else:\n        return y\n\nres = max2(1,2)\n```\n\n用三元表达式可以一行解决\n\n```python\nx=1\ny=2\nres = x if x > y else y # 三元表达式\n```\n\n![img](https://pic2.zhimg.com/80/v2-6b5e335f9c2baca1a9d076721c672b19_720w.jpg)\n\n## 3.2 列表生成式\n\n列表生成式是python为我们提供的一种简化代码的解决方案，用来快速生成列表，语法如下\n\n```python\n[expression for item1 in iterable1 if condition1\nfor item2 in iterable2 if condition2\n...\nfor itemN in iterableN if conditionN\n]\n\n#类似于\nres=[]\nfor item1 in iterable1:\n    if condition1:\n        for item2 in iterable2:\n            if condition2\n                ...\n                for itemN in iterableN:\n                    if conditionN:\n                        res.append(expression)\n```\n\n针对下述场景\n\n```python\negg_list=[]\nfor i in range(10):\n    egg_list.append('鸡蛋%s' %i)\n```\n\n用列表生成式可以一行解决\n\n```python\negg_list=['鸡蛋%s' %i for i in range(10)]\n```\n\n![img](https://pic3.zhimg.com/80/v2-d9640f4c3f1c13bbd78e7cf6de6dc316_720w.jpg)\n\n## 3.3 生成器表达式\n\n创建一个生成器对象有两种方式，一种是调用带yield关键字的函数，另一种就是生成器表达式，与列表生成式的语法格式相同，只需要将[]换成()，即：\n\n![img](https://pic3.zhimg.com/80/v2-70257d333a3e9a49704c10982ce48856_720w.jpg)\n\n```python\n（expression for item in iterable if condition）\n```\n\n对比列表生成式返回的是一个列表，生成器表达式返回的是一个生成器对象\n\n```python\n>>> [x*x for x in range(3)]\n[0, 1, 4]\n>>> g=(x*x for x in range(3))\n>>> g\n<generator object <genexpr> at 0x101be0ba0>\n```\n\n对比列表生成式，生成器表达式的优点自然是节省内存（一次只产生一个值在内存中）\n\n```python\n>>> next(g)\n0\n>>> next(g)\n1\n>>> next(g)\n4\n>>> next(g) #抛出异常StopIteration\n```\n\n如果我们要读取一个大文件的字节数，应该基于生成器表达式的方式完成\n\n```python\nwith open('db.txt','rb') as f:\n    nums=(len(line) for line in f)\n    total_size=sum(nums) # 依次执行next(nums)，然后累加到一起得到结果=\n```\n\n![img](https://pic1.zhimg.com/80/v2-f0a061871b663d857e13ada7c10b31ac_720w.jpg)\n\n## 视频链接：\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=52![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D52)\n\n[python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=53![img](https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg)](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D53)\n\n[https://www.bilibili.com/video/av73342471?p=54www.bilibili.com/video/av73342471?p=54](https://link.zhihu.com/?target=https%3A//www.bilibili.com/video/av73342471%3Fp%3D54)","slug":"03_Python/01_Python基础/17_生成器","published":1,"date":"2022-07-18T07:10:19.374Z","updated":"2022-07-18T07:10:19.374Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1a002na8v73azkc1la","content":"<h2 id=\"一-生成器与yield\"><a href=\"#一-生成器与yield\" class=\"headerlink\" title=\"一 生成器与yield\"></a>一 生成器与yield</h2><p><img src=\"https://pic2.zhimg.com/80/v2-2c92ed3ae0da1fd192339be9abc973a1_720w.jpg\" alt=\"img\"></p>\n<p>若函数体包含yield关键字，再调用函数，并不会执行函数体代码，得到的返回值即生成器对象</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">my_range</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span>stop<span class=\"token punctuation\">,</span>step<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'start...'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> start <span class=\"token operator\">&lt;</span> stop<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">yield</span> start\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         start<span class=\"token operator\">+=</span>step\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end...'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span>my_range<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> my_range at <span class=\"token number\">0x104105678</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>生成器内置有__iter__和__next__方法，所以生成器本身就是一个迭代器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>__iter__\n<span class=\"token operator\">&lt;</span>method<span class=\"token operator\">-</span>wrapper <span class=\"token string\">'__iter__'</span> of generator <span class=\"token builtin\">object</span> at <span class=\"token number\">0x1037d2af0</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>__next__\n<span class=\"token operator\">&lt;</span>method<span class=\"token operator\">-</span>wrapper <span class=\"token string\">'__next__'</span> of generator <span class=\"token builtin\">object</span> at <span class=\"token number\">0x1037d2af0</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-31590362f23201814f45879db5dd6a51_720w.jpg\" alt=\"img\"></p>\n<p>因而我们可以用next(生成器)触发生成器所对应函数的执行，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 触发函数执行直到遇到yield则停止,将yield后的值返回，并在当前位置挂起函数</span>\nstart<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">0</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 再次调用next(g)，函数从上次暂停的位置继续执行，直到重新遇到yield...</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 周而复始...</span>\n<span class=\"token number\">2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 触发函数执行没有遇到yield则无值返回，即取值完毕抛出异常结束迭代</span>\nend<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  File <span class=\"token string\">\"&lt;stdin>\"</span><span class=\"token punctuation\">,</span> line <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>module<span class=\"token operator\">></span>\nStopIteration<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-fa04ec0eaa5bd7bb8804908ad7b88369_720w.jpg\" alt=\"img\"></p>\n<p>既然生成器对象属于迭代器，那么必然可以使用for循环迭代，如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> countdown<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \ncountdown start\n<span class=\"token number\">3</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">1</span>\nDone!<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>有了yield关键字，我们就有了一种自定义迭代器的实现方式。yield可以用于返回值，但不同于return，函数一旦遇到return就结束了，而yield可以保存函数的运行状态挂起函数，用来返回多次值</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-024f3ac36393f784226497828d53eebf_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-yield表达式应用\"><a href=\"#二-yield表达式应用\" class=\"headerlink\" title=\"二 yield表达式应用\"></a>二 yield表达式应用</h2><p>在函数内可以采用表达式形式的yield</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get the food: %s, and start to eat'</span> <span class=\"token operator\">%</span>food<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>可以拿到函数的生成器对象持续为函数体send值，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span>eater<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 得到生成器对象</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> eater at <span class=\"token number\">0x101b6e2b0</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 需要事先”初始化”一次，让函数挂起在food=yield，等待调用g.send()方法为其传值</span>\nReady to eat\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'包子'</span><span class=\"token punctuation\">)</span>\nget the food<span class=\"token punctuation\">:</span> 包子<span class=\"token punctuation\">,</span> <span class=\"token keyword\">and</span> start to eat\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'鸡腿'</span><span class=\"token punctuation\">)</span>\nget the food<span class=\"token punctuation\">:</span> 鸡腿<span class=\"token punctuation\">,</span> <span class=\"token keyword\">and</span> start to eat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>针对表达式形式的yield，生成器对象必须事先被初始化一次，让函数挂起在food&#x3D;yield的位置，等待调用g.send()方法为函数体传值，g.send(None)等同于next(g)。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-277c3fe7374520dba8973dea02474790_720w.jpg\" alt=\"img\"></p>\n<p> 我们可以编写装饰器来完成为所有表达式形式yield对应生成器的初始化操作，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        g<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> g\n    <span class=\"token keyword\">return</span> wrapper\n\n<span class=\"token decorator annotation punctuation\">@init</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get the food: %s, and start to eat'</span> <span class=\"token operator\">%</span>food<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>表达式形式的yield也可以用于返回多次值，即<code>变量名=yield 值</code>的形式，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     food_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span> food_list\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>food<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token operator\">=</span>eater<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\nReady to eat\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸鹿尾儿'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸鹿尾儿'</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三-三元表达式、列表生成式、生成器表达式\"><a href=\"#三-三元表达式、列表生成式、生成器表达式\" class=\"headerlink\" title=\"三 三元表达式、列表生成式、生成器表达式\"></a>三 三元表达式、列表生成式、生成器表达式</h2><h2 id=\"3-1-三元表达式\"><a href=\"#3-1-三元表达式\" class=\"headerlink\" title=\"3.1 三元表达式\"></a>3.1 三元表达式</h2><p>三元表达式是python为我们提供的一种简化代码的解决方案，语法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">res <span class=\"token operator\">=</span> 条件成立时返回的值 <span class=\"token keyword\">if</span> 条件 <span class=\"token keyword\">else</span> 条件不成立时返回的值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>针对下述场景</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">max2</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> x <span class=\"token operator\">></span> y<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> x\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> y\n\nres <span class=\"token operator\">=</span> max2<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用三元表达式可以一行解决</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\ny<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nres <span class=\"token operator\">=</span> x <span class=\"token keyword\">if</span> x <span class=\"token operator\">></span> y <span class=\"token keyword\">else</span> y <span class=\"token comment\"># 三元表达式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-6b5e335f9c2baca1a9d076721c672b19_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-列表生成式\"><a href=\"#3-2-列表生成式\" class=\"headerlink\" title=\"3.2 列表生成式\"></a>3.2 列表生成式</h2><p>列表生成式是python为我们提供的一种简化代码的解决方案，用来快速生成列表，语法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">[</span>expression <span class=\"token keyword\">for</span> item1 <span class=\"token keyword\">in</span> iterable1 <span class=\"token keyword\">if</span> condition1\n<span class=\"token keyword\">for</span> item2 <span class=\"token keyword\">in</span> iterable2 <span class=\"token keyword\">if</span> condition2\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">for</span> itemN <span class=\"token keyword\">in</span> iterableN <span class=\"token keyword\">if</span> conditionN\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">#类似于</span>\nres<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> item1 <span class=\"token keyword\">in</span> iterable1<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> condition1<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> item2 <span class=\"token keyword\">in</span> iterable2<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> condition2\n                <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n                <span class=\"token keyword\">for</span> itemN <span class=\"token keyword\">in</span> iterableN<span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">if</span> conditionN<span class=\"token punctuation\">:</span>\n                        res<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>expression<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>针对下述场景</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">egg_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    egg_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">'鸡蛋%s'</span> <span class=\"token operator\">%</span>i<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>用列表生成式可以一行解决</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">egg_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'鸡蛋%s'</span> <span class=\"token operator\">%</span>i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-d9640f4c3f1c13bbd78e7cf6de6dc316_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-3-生成器表达式\"><a href=\"#3-3-生成器表达式\" class=\"headerlink\" title=\"3.3 生成器表达式\"></a>3.3 生成器表达式</h2><p>创建一个生成器对象有两种方式，一种是调用带yield关键字的函数，另一种就是生成器表达式，与列表生成式的语法格式相同，只需要将[]换成()，即：</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-70257d333a3e9a49704c10982ce48856_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">（expression <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> iterable <span class=\"token keyword\">if</span> condition）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>对比列表生成式返回的是一个列表，生成器表达式返回的是一个生成器对象</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>x<span class=\"token operator\">*</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">*</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> <span class=\"token operator\">&lt;</span>genexpr<span class=\"token operator\">></span> at <span class=\"token number\">0x101be0ba0</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>对比列表生成式，生成器表达式的优点自然是节省内存（一次只产生一个值在内存中）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">0</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">4</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\">#抛出异常StopIteration</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们要读取一个大文件的字节数，应该基于生成器表达式的方式完成</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    nums<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">)</span>\n    total_size<span class=\"token operator\">=</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 依次执行next(nums)，然后累加到一起得到结果=</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-f0a061871b663d857e13ada7c10b31ac_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=52\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=52<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=53\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=53<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=54\">https://www.bilibili.com/video/av73342471?p=54www.bilibili.com/video/av73342471?p=54</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一-生成器与yield\"><a href=\"#一-生成器与yield\" class=\"headerlink\" title=\"一 生成器与yield\"></a>一 生成器与yield</h2><p><img src=\"https://pic2.zhimg.com/80/v2-2c92ed3ae0da1fd192339be9abc973a1_720w.jpg\" alt=\"img\"></p>\n<p>若函数体包含yield关键字，再调用函数，并不会执行函数体代码，得到的返回值即生成器对象</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">my_range</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">,</span>stop<span class=\"token punctuation\">,</span>step<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'start...'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> start <span class=\"token operator\">&lt;</span> stop<span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">yield</span> start\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         start<span class=\"token operator\">+=</span>step\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'end...'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span>my_range<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> my_range at <span class=\"token number\">0x104105678</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>生成器内置有__iter__和__next__方法，所以生成器本身就是一个迭代器</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>__iter__\n<span class=\"token operator\">&lt;</span>method<span class=\"token operator\">-</span>wrapper <span class=\"token string\">'__iter__'</span> of generator <span class=\"token builtin\">object</span> at <span class=\"token number\">0x1037d2af0</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>__next__\n<span class=\"token operator\">&lt;</span>method<span class=\"token operator\">-</span>wrapper <span class=\"token string\">'__next__'</span> of generator <span class=\"token builtin\">object</span> at <span class=\"token number\">0x1037d2af0</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-31590362f23201814f45879db5dd6a51_720w.jpg\" alt=\"img\"></p>\n<p>因而我们可以用next(生成器)触发生成器所对应函数的执行，</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 触发函数执行直到遇到yield则停止,将yield后的值返回，并在当前位置挂起函数</span>\nstart<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token number\">0</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 再次调用next(g)，函数从上次暂停的位置继续执行，直到重新遇到yield...</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 周而复始...</span>\n<span class=\"token number\">2</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 触发函数执行没有遇到yield则无值返回，即取值完毕抛出异常结束迭代</span>\nend<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  File <span class=\"token string\">\"&lt;stdin>\"</span><span class=\"token punctuation\">,</span> line <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>module<span class=\"token operator\">></span>\nStopIteration<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-fa04ec0eaa5bd7bb8804908ad7b88369_720w.jpg\" alt=\"img\"></p>\n<p>既然生成器对象属于迭代器，那么必然可以使用for循环迭代，如下：</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> countdown<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \ncountdown start\n<span class=\"token number\">3</span>\n<span class=\"token number\">2</span>\n<span class=\"token number\">1</span>\nDone!<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>有了yield关键字，我们就有了一种自定义迭代器的实现方式。yield可以用于返回值，但不同于return，函数一旦遇到return就结束了，而yield可以保存函数的运行状态挂起函数，用来返回多次值</p>\n<p><img src=\"https://pic4.zhimg.com/80/v2-024f3ac36393f784226497828d53eebf_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"二-yield表达式应用\"><a href=\"#二-yield表达式应用\" class=\"headerlink\" title=\"二 yield表达式应用\"></a>二 yield表达式应用</h2><p>在函数内可以采用表达式形式的yield</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get the food: %s, and start to eat'</span> <span class=\"token operator\">%</span>food<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>可以拿到函数的生成器对象持续为函数体send值，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span>eater<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># 得到生成器对象</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> eater at <span class=\"token number\">0x101b6e2b0</span><span class=\"token operator\">></span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 需要事先”初始化”一次，让函数挂起在food=yield，等待调用g.send()方法为其传值</span>\nReady to eat\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'包子'</span><span class=\"token punctuation\">)</span>\nget the food<span class=\"token punctuation\">:</span> 包子<span class=\"token punctuation\">,</span> <span class=\"token keyword\">and</span> start to eat\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'鸡腿'</span><span class=\"token punctuation\">)</span>\nget the food<span class=\"token punctuation\">:</span> 鸡腿<span class=\"token punctuation\">,</span> <span class=\"token keyword\">and</span> start to eat<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>针对表达式形式的yield，生成器对象必须事先被初始化一次，让函数挂起在food&#x3D;yield的位置，等待调用g.send()方法为函数体传值，g.send(None)等同于next(g)。</p>\n<p><img src=\"https://pic1.zhimg.com/80/v2-277c3fe7374520dba8973dea02474790_720w.jpg\" alt=\"img\"></p>\n<p> 我们可以编写装饰器来完成为所有表达式形式yield对应生成器的初始化操作，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">init</span><span class=\"token punctuation\">(</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">wrapper</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        g<span class=\"token operator\">=</span>func<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">,</span><span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span>\n        <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> g\n    <span class=\"token keyword\">return</span> wrapper\n\n<span class=\"token decorator annotation punctuation\">@init</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n        food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'get the food: %s, and start to eat'</span> <span class=\"token operator\">%</span>food<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>表达式形式的yield也可以用于返回多次值，即<code>变量名=yield 值</code>的形式，如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token keyword\">def</span> <span class=\"token function\">eater</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Ready to eat'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     food_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>     <span class=\"token keyword\">while</span> <span class=\"token boolean\">True</span><span class=\"token punctuation\">:</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food<span class=\"token operator\">=</span><span class=\"token keyword\">yield</span> food_list\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>         food_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>food<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> \n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token operator\">=</span>eater<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span>\nReady to eat\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> e<span class=\"token punctuation\">.</span>send<span class=\"token punctuation\">(</span><span class=\"token string\">'蒸鹿尾儿'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span><span class=\"token string\">'蒸羊羔'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸熊掌'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'蒸鹿尾儿'</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三-三元表达式、列表生成式、生成器表达式\"><a href=\"#三-三元表达式、列表生成式、生成器表达式\" class=\"headerlink\" title=\"三 三元表达式、列表生成式、生成器表达式\"></a>三 三元表达式、列表生成式、生成器表达式</h2><h2 id=\"3-1-三元表达式\"><a href=\"#3-1-三元表达式\" class=\"headerlink\" title=\"3.1 三元表达式\"></a>3.1 三元表达式</h2><p>三元表达式是python为我们提供的一种简化代码的解决方案，语法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">res <span class=\"token operator\">=</span> 条件成立时返回的值 <span class=\"token keyword\">if</span> 条件 <span class=\"token keyword\">else</span> 条件不成立时返回的值<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>针对下述场景</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">max2</span><span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> x <span class=\"token operator\">></span> y<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> x\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> y\n\nres <span class=\"token operator\">=</span> max2<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>用三元表达式可以一行解决</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">x<span class=\"token operator\">=</span><span class=\"token number\">1</span>\ny<span class=\"token operator\">=</span><span class=\"token number\">2</span>\nres <span class=\"token operator\">=</span> x <span class=\"token keyword\">if</span> x <span class=\"token operator\">></span> y <span class=\"token keyword\">else</span> y <span class=\"token comment\"># 三元表达式</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic2.zhimg.com/80/v2-6b5e335f9c2baca1a9d076721c672b19_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-2-列表生成式\"><a href=\"#3-2-列表生成式\" class=\"headerlink\" title=\"3.2 列表生成式\"></a>3.2 列表生成式</h2><p>列表生成式是python为我们提供的一种简化代码的解决方案，用来快速生成列表，语法如下</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token punctuation\">[</span>expression <span class=\"token keyword\">for</span> item1 <span class=\"token keyword\">in</span> iterable1 <span class=\"token keyword\">if</span> condition1\n<span class=\"token keyword\">for</span> item2 <span class=\"token keyword\">in</span> iterable2 <span class=\"token keyword\">if</span> condition2\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">for</span> itemN <span class=\"token keyword\">in</span> iterableN <span class=\"token keyword\">if</span> conditionN\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\">#类似于</span>\nres<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> item1 <span class=\"token keyword\">in</span> iterable1<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> condition1<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">for</span> item2 <span class=\"token keyword\">in</span> iterable2<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> condition2\n                <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n                <span class=\"token keyword\">for</span> itemN <span class=\"token keyword\">in</span> iterableN<span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">if</span> conditionN<span class=\"token punctuation\">:</span>\n                        res<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>expression<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>针对下述场景</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">egg_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    egg_list<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">'鸡蛋%s'</span> <span class=\"token operator\">%</span>i<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>用列表生成式可以一行解决</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">egg_list<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'鸡蛋%s'</span> <span class=\"token operator\">%</span>i <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://pic3.zhimg.com/80/v2-d9640f4c3f1c13bbd78e7cf6de6dc316_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"3-3-生成器表达式\"><a href=\"#3-3-生成器表达式\" class=\"headerlink\" title=\"3.3 生成器表达式\"></a>3.3 生成器表达式</h2><p>创建一个生成器对象有两种方式，一种是调用带yield关键字的函数，另一种就是生成器表达式，与列表生成式的语法格式相同，只需要将[]换成()，即：</p>\n<p><img src=\"https://pic3.zhimg.com/80/v2-70257d333a3e9a49704c10982ce48856_720w.jpg\" alt=\"img\"></p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\">（expression <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> iterable <span class=\"token keyword\">if</span> condition）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>对比列表生成式返回的是一个列表，生成器表达式返回的是一个生成器对象</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>x<span class=\"token operator\">*</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>x<span class=\"token operator\">*</span>x <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> g\n<span class=\"token operator\">&lt;</span>generator <span class=\"token builtin\">object</span> <span class=\"token operator\">&lt;</span>genexpr<span class=\"token operator\">></span> at <span class=\"token number\">0x101be0ba0</span><span class=\"token operator\">></span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>对比列表生成式，生成器表达式的优点自然是节省内存（一次只产生一个值在内存中）</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">0</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">1</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span>\n<span class=\"token number\">4</span>\n<span class=\"token operator\">>></span><span class=\"token operator\">></span> <span class=\"token builtin\">next</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">)</span> <span class=\"token comment\">#抛出异常StopIteration</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>如果我们要读取一个大文件的字节数，应该基于生成器表达式的方式完成</p>\n<pre class=\"line-numbers language-python\" data-language=\"python\"><code class=\"language-python\"><span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db.txt'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n    nums<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>line<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> line <span class=\"token keyword\">in</span> f<span class=\"token punctuation\">)</span>\n    total_size<span class=\"token operator\">=</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>nums<span class=\"token punctuation\">)</span> <span class=\"token comment\"># 依次执行next(nums)，然后累加到一起得到结果=</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://pic1.zhimg.com/80/v2-f0a061871b663d857e13ada7c10b31ac_720w.jpg\" alt=\"img\"></p>\n<h2 id=\"视频链接：\"><a href=\"#视频链接：\" class=\"headerlink\" title=\"视频链接：\"></a>视频链接：</h2><p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=52\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=52<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=53\">python快速入门（一）_哔哩哔哩 (゜-゜)つロ 干杯~-bilibiliwww.bilibili.com/video/av73342471?p=53<img src=\"https://pic4.zhimg.com/v2-c64ada0dd06d0c57ed905be65d17acb7_180x120.jpg\" alt=\"img\"></a></p>\n<p><a href=\"https://link.zhihu.com/?target=https://www.bilibili.com/video/av73342471?p=54\">https://www.bilibili.com/video/av73342471?p=54www.bilibili.com/video/av73342471?p=54</a></p>\n"},{"_content":"","source":"_posts/03_Python/01_Python基础/hinting.md","raw":"","slug":"03_Python/01_Python基础/hinting","published":1,"date":"2022-07-18T07:10:19.389Z","updated":"2022-07-18T07:10:19.389Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1b002pa8v7dmurd0qs","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"运维之基础命令--虚拟机安装","date":"2022-07-06T03:19:52.000Z","_content":"\n# day01 : 课堂笔记\n\n## 安装系统\n\n**1、安装虚拟机**\n\n![image-20210302121236930](.\\assets\\image-20210302121236930.png)\n\n解压上述软件，创建vmware.exe快捷方式，然后用快捷方式打开。\n\n![image-20210302121408360](.\\assets\\image-20210302121408360.png)\n\n**2、创建虚拟机**\n\n![image-20210302121456338](.\\assets\\image-20210302121456338.png)\n\n![image-20210302121550128](.\\assets\\image-20210302121550128.png)\n\n![image-20210302121622000](.\\assets\\image-20210302121622000.png)\n\n![image-20210302121745568](.\\assets\\image-20210302121745568.png)\n\n![image-20210302122035359](.\\assets\\image-20210302122035359.png)\n\n![image-20210302122256831](.\\assets\\image-20210302122256831.png)\n\n![image-20210302122359568](.\\assets\\image-20210302122359568.png)\n\n![image-20210302122603313](.\\assets\\image-20210302122603313.png)\n\n![image-20210302122657199](.\\assets\\image-20210302122657199.png)\n\n![image-20210302123826623](.\\assets\\image-20210302123826623.png)\n\n![image-20210302124229475](.\\assets\\image-20210302124229475.png)\n\n![image-20210302124308081](.\\assets\\image-20210302124308081.png)\n\n![image-20210302124327456](.\\assets\\image-20210302124327456.png)\n\n![image-20210302124404318](.\\assets\\image-20210302124404318.png)\n\n![image-20210302124713502](.\\assets\\image-20210302124713502.png)\n\n![image-20210302124741038](.\\assets\\image-20210302124741038.png)\n\n![image-20210302125049653](.\\assets\\image-20210302125049653.png)\n\n","source":"_posts/01_运维/01-基础命令/day01-虚拟机安装/课堂笔记.md","raw":"---\ntitle: 运维之基础命令--虚拟机安装\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# day01 : 课堂笔记\n\n## 安装系统\n\n**1、安装虚拟机**\n\n![image-20210302121236930](.\\assets\\image-20210302121236930.png)\n\n解压上述软件，创建vmware.exe快捷方式，然后用快捷方式打开。\n\n![image-20210302121408360](.\\assets\\image-20210302121408360.png)\n\n**2、创建虚拟机**\n\n![image-20210302121456338](.\\assets\\image-20210302121456338.png)\n\n![image-20210302121550128](.\\assets\\image-20210302121550128.png)\n\n![image-20210302121622000](.\\assets\\image-20210302121622000.png)\n\n![image-20210302121745568](.\\assets\\image-20210302121745568.png)\n\n![image-20210302122035359](.\\assets\\image-20210302122035359.png)\n\n![image-20210302122256831](.\\assets\\image-20210302122256831.png)\n\n![image-20210302122359568](.\\assets\\image-20210302122359568.png)\n\n![image-20210302122603313](.\\assets\\image-20210302122603313.png)\n\n![image-20210302122657199](.\\assets\\image-20210302122657199.png)\n\n![image-20210302123826623](.\\assets\\image-20210302123826623.png)\n\n![image-20210302124229475](.\\assets\\image-20210302124229475.png)\n\n![image-20210302124308081](.\\assets\\image-20210302124308081.png)\n\n![image-20210302124327456](.\\assets\\image-20210302124327456.png)\n\n![image-20210302124404318](.\\assets\\image-20210302124404318.png)\n\n![image-20210302124713502](.\\assets\\image-20210302124713502.png)\n\n![image-20210302124741038](.\\assets\\image-20210302124741038.png)\n\n![image-20210302125049653](.\\assets\\image-20210302125049653.png)\n\n","slug":"01_运维/01-基础命令/day01-虚拟机安装/课堂笔记","published":1,"updated":"2022-07-06T07:08:58.094Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1c002sa8v72cl2bble","content":"<h1 id=\"day01-课堂笔记\"><a href=\"#day01-课堂笔记\" class=\"headerlink\" title=\"day01 : 课堂笔记\"></a>day01 : 课堂笔记</h1><h2 id=\"安装系统\"><a href=\"#安装系统\" class=\"headerlink\" title=\"安装系统\"></a>安装系统</h2><p><strong>1、安装虚拟机</strong></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121236930.png\" alt=\"image-20210302121236930\"></p>\n<p>解压上述软件，创建vmware.exe快捷方式，然后用快捷方式打开。</p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121408360.png\" alt=\"image-20210302121408360\"></p>\n<p><strong>2、创建虚拟机</strong></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121456338.png\" alt=\"image-20210302121456338\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121550128.png\" alt=\"image-20210302121550128\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121622000.png\" alt=\"image-20210302121622000\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121745568.png\" alt=\"image-20210302121745568\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122035359.png\" alt=\"image-20210302122035359\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122256831.png\" alt=\"image-20210302122256831\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122359568.png\" alt=\"image-20210302122359568\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122603313.png\" alt=\"image-20210302122603313\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122657199.png\" alt=\"image-20210302122657199\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302123826623.png\" alt=\"image-20210302123826623\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124229475.png\" alt=\"image-20210302124229475\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124308081.png\" alt=\"image-20210302124308081\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124327456.png\" alt=\"image-20210302124327456\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124404318.png\" alt=\"image-20210302124404318\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124713502.png\" alt=\"image-20210302124713502\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124741038.png\" alt=\"image-20210302124741038\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302125049653.png\" alt=\"image-20210302125049653\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"day01-课堂笔记\"><a href=\"#day01-课堂笔记\" class=\"headerlink\" title=\"day01 : 课堂笔记\"></a>day01 : 课堂笔记</h1><h2 id=\"安装系统\"><a href=\"#安装系统\" class=\"headerlink\" title=\"安装系统\"></a>安装系统</h2><p><strong>1、安装虚拟机</strong></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121236930.png\" alt=\"image-20210302121236930\"></p>\n<p>解压上述软件，创建vmware.exe快捷方式，然后用快捷方式打开。</p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121408360.png\" alt=\"image-20210302121408360\"></p>\n<p><strong>2、创建虚拟机</strong></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121456338.png\" alt=\"image-20210302121456338\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121550128.png\" alt=\"image-20210302121550128\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121622000.png\" alt=\"image-20210302121622000\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302121745568.png\" alt=\"image-20210302121745568\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122035359.png\" alt=\"image-20210302122035359\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122256831.png\" alt=\"image-20210302122256831\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122359568.png\" alt=\"image-20210302122359568\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122603313.png\" alt=\"image-20210302122603313\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302122657199.png\" alt=\"image-20210302122657199\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302123826623.png\" alt=\"image-20210302123826623\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124229475.png\" alt=\"image-20210302124229475\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124308081.png\" alt=\"image-20210302124308081\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124327456.png\" alt=\"image-20210302124327456\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124404318.png\" alt=\"image-20210302124404318\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124713502.png\" alt=\"image-20210302124713502\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302124741038.png\" alt=\"image-20210302124741038\"></p>\n<p><img src=\"/.%5Cassets%5Cimage-20210302125049653.png\" alt=\"image-20210302125049653\"></p>\n"},{"title":"运维之基础命令--打包与压缩","date":"2022-07-06T03:19:52.000Z","_content":"\n# 打包和压缩\n\n> 将文件或文件夹合并成一个包，然后通过压缩算法进行数据压缩，减小包的体积，方便网络传输。\n\n```bash\nwindows：\n\tzip\n\trar\n\nlinux:\n\tzip\n\ttar\n\tgz\n\tbz2\n\ttar.gz\n\ttar.bz2\n\n压缩算法：\n\tgzip\n\tbzip2\n```\n\n## zip\n\n> 是一个Windows和Linux中常用打包压缩工具，支持的压缩算法是zip。\n\n```bash\nzip工具需要安装\n\tyum install zip unzip -y\n```\n\n### zip压缩一个文件\n\n```bash\n# 格式\n\tzip [参数] 压缩包名称  文件路径\n\n[root@abc ~]# zip 123.zip 123.log \n  adding: 123.log (deflated 87%)\n[root@abc ~]# ls -l\ntotal 4732\n-rw-r--r--  1 root root  646165 Mar  9 10:31 123.log\n-rw-r--r--  1 root root   85296 Mar 11 11:58 123.zip\n```\n\n### zip压缩文件夹\n\n```bash\n# 需要一个-r参数去递归压缩文件夹下的所有内容\n[root@abc ~]# zip -r dir.zip dir/\n  adding: dir/ (stored 0%)\n  adding: dir/one/ (stored 0%)\n  adding: dir/123.log (deflated 87%)\n```\n\n### zip的静默输出\n\n```bash\n# -q：参数就是不输出任何打包信息\n[root@abc opt]# zip -r -q etc.zip /etc/\n[root@abc opt]# ls -l\ntotal 14200\n-rw-r--r-- 1 root root 13674457 Mar 11 12:15 etc.zip\n```\n\n### zip解压命令（unzip）\n\n```bash\n# 格式\n\tunzip [参数] 压缩包路径\n\n# unzip解压命令只能解压由zip打包的压缩文件\n[root@abc ~]# unzip dir.zip \nArchive:  dir.zip\n  inflating: dir/123.log             \n[root@abc ~]# \n\n# 其他压缩包由unzip解压时随即报错。\n[root@abc opt]# unzip nginx-.tar.gz\nArchive:  nginx-.tar.gz\n  End-of-central-directory signature not found.  Either this file is not\n  a zipfile, or it constitutes one disk of a multi-part archive.  In the\n  latter case the central directory and zipfile comment will be found on\n  the last disk(s) of this archive.\nunzip:  cannot find zipfile directory in one of nginx-.tar.gz or\n        nginx-.tar.gz.zip, and cannot find nginx-.tar.gz.ZIP, period.\n\n\n# 查看压缩包中压缩那些内容，不解压？\n# 只查看压缩包内容不解压需要使用 -l 参数\n[root@abc opt]# unzip -l dir.zip \nArchive:  dir.zip\n  Length      Date    Time    Name\n---------  ---------- -----   ----\n        0  03-11-2021 12:04   dir/\n---------                     -------\n        0                     1 file\n\n# 解压到指定目录（-d）\n[root@abc ~]# unzip -d /root/  etc.zip \n[root@abc opt]# cd /root/\n[root@abc ~]# ls\n]        anaconda-ks.cfg  dir.zip  index.html           test.pdf.gz  xxxeth0xxx           系统优化.md\n123.log  demo.txt         etc      nginx-0.1.22.tar.gz  test.txt     上传与下载.md\n123.zip  dir              eth0xxx  test                 xxxeth0      文件管理_(高级).pdf\n\n# 静默输出(-q)\n[root@abc ~]# rm -rf etc\n[root@abc ~]# unzip -q -d /root/ /opt/etc.zip \n[root@abc ~]# ls -l\ntotal 4828\ndrwxr-xr-x  91 root root    8192 Mar 11 11:16 etc\n```\n\n## tar\n\n> tar压缩支持多种压缩算法\n>\n> tar.gz   gzip (用的最多)\n>\n> tar.bz2 bzip2\n\n### gzip\n\n> 通过gzip压缩算法，将文件压缩一定体积，有利于传输, 不支持打包\n\n```bash\n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  244977 Mar 10 12:12 index.html\n[root@abc ~]# gzip index.html \n[root@abc ~]# ls -l\ntotal 4612\n-rw-r--r--   1 root root   22652 Mar 10 12:12 index.html.gz\n```\n\n#### gzip压缩一个目录\n\n```bash\n[root@abc etc]# gzip -r /etc\n[root@abc etc]# ls \nabrt                        GREP_COLORS.gz               my.cnf.d                 security\nadjtime.gz                  groff                        my.cnf.gz                selinux\naliases.db.gz               group-.gz                    NetworkManager           services.gz\naliases.gz                  group.gz                     networks.gz              sestatus.conf.gz\nalternatives                grub2.cfg                    nsswitch.conf.bak.gz     sgml\nanacrontab.gz               grub.d                       nsswitch.conf.gz         shadow\n```\n\n### gzip解压(-d)\n\n```bash\n[root@abc ~]# ls -l\n-rw-r--r--   1 0 0   22652 Mar 10 12:12 index.html.gz\n[root@abc ~]# gzip -d index.html.gz \n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 0 0  244977 Mar 10 12:12 index.html\n```\n\n### bzip2\n\n> 使用bzip2 压缩算法来压缩一定体积的文件。\n\n```bash\n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  646165 Mar  9 10:31 123.log     \n[root@abc ~]# bzip2 123.log \n[root@abc ~]# ls -l\ntotal 4240\n-rw-r--r--   1 root root       0 Mar 10 12:04 ]\n-rw-r--r--   1 root root   42210 Mar  9 10:31 123.log.bz2\n```\n\n### bzip2解压（-d）\n\n> bzip2解压是针对于bzip2压缩的压缩包来进行解压。\n\n```bash\n[root@abc ~]# ls -l\ntotal 4240\n-rw-r--r--   1 root root   42210 Mar  9 10:31 123.log.bz2\n[root@abc ~]# bzip2 -d 123.log.bz2 \n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  646165 Mar  9 10:31 123.log\n```\n\n### tar\n\n> tar其实是一个打包工具，不具备压缩功能，但是可以使用参数调用压缩工具来进行解压。\n\n#### 参数\n\n- -c : 创建压缩包\n\n- -f : 指定压缩包名称\n\n  ```bash\n  [root@abc ~]# tar -c -f test.tar 123.log \n  [root@abc ~]# ls -l\n  total 5468\n  -rw-r--r--   1 root root  655360 Mar 11 15:49 test.tar\n  ```\n\n- -z ： 指定使用gzip压缩工具进行压缩\n\n  ```bash\n  [root@abc ~]# tar  -c -z -f test-one.tar 123.log \n  [root@abc ~]# ls -l \n  total 5084\n  -rw-r--r--   1 root root   85279 Mar 11 15:56 test-one.tar\n  \n  # 注：使用-z参数，不会自动添加.gz后缀\n  \n  [root@abc ~]# tar -c -z -f anaconda.tar.gz  anaconda-ks.cfg \n  [root@abc ~]# ls -l\n  total 5084\n  -rw-r--r--   1 root root    1010 Mar 11 15:58 anaconda.tar.gz\n  ```\n\n- -j : 指定使用bzip2压缩工具进行压缩\n\n  ```bash\n  [root@abc ~]# tar -c -j -f 123-bask-one.tar 123.log \n  [root@abc ~]# ls -l\n  total 5172\n  -rw-r--r--   1 root root   42328 Mar 11 16:00 123-bak.tar.bz2\n  -rw-r--r--   1 root root   42328 Mar 11 16:01 123-bask-one.tar\n  ```\n\n- -J : 指定使用xz压缩工具进行压缩\n\n  ```bash\n  [root@abc test-tar]# tar -c -J  -f etc.tar.xz /etc/\n  [root@abc ~]# ls -l\n  -rw-r--r-- 1 root root 9493376 Mar 11 17:00 etc.tar.xz\n  ```\n\n- -t : 查看压缩包内容\n\n  ```bash\n  [root@abc ~]# tar -t -f 123-bak.tar.bz2 \n  123.log\n  [root@abc ~]# \n  ```\n\n- -v ： 显示压缩包压缩过程\n\n  ```bash\n  [root@abc ~]# tar -x -v -f etc.tar -C /opt/\n  /etc/centos-release\n  /etc/DIR_COLORS.lightbgcolor\n  /etc/libaudit.conf\n  /etc/mail.rc\n  ```\n\n- -P : 允许使用绝对路径进行打包\n\n  ```bash\n  [root@abc ~]# tar -c -P -f 123-three.tar /etc/passwd\n  [root@abc ~]# tar -c -f 123-three.tar /etc/passwd\n  tar: Removing leading `/' from member names\n  [root@abc ~]# \n  ```\n\n- -x ： 解压\n\n  ```bash\n  # tar解压是按照原来的路径进行解压\n  [root@abc test]# tar -x -f etc.tar \n  \n  # tar会自动识别压缩功能\n  ```\n\n- -C ： 指定解压路径\n\n  ```bash\n  [root@abc ~]# tar -x -f etc.tar -C /opt/\n  tar: Removing leading `/' from member names\n  [root@abc ~]# cd /opt/\n  [root@abc opt]# ls\n  abc23  dir  dir.zip  etc  nginx-0.1.22.tar.gz  nginx-.tar.gz  xxx\n  [root@abc opt]# \n  ```\n\n- --exclude : 排除某些文件\n\n  ```bash\n  [root@abc test-tar]# tar -c -f abc.tar ./* --exclude=abc7 --exclude=abc5   --exclude=abc1 \n  [root@abc test-tar]# tar -t -f abc.tar \n  ./abc2\n  ./abc3\n  ./abc4\n  ./abc6\n  ./abc8\n  ./abc9\n  [root@abc test-tar]# \n  ```\n\n- --exclude-from : 根据某个文件列表排除多个文件\n\n  ```bash\n  [root@abc test-tar]# cat list.txt \n  abc995\n  abc996\n  abc997\n  abc998\n  abc999\n  [root@abc test-tar]# tar -c -f abc.tar ./* --exclude-from=list.txt \n  ```\n\n- -h : 打包软连接\n\n  ```bash\n  [root@abc test-tar]# tar -c -h -f bin-h.tar /bin\n  ```\n\n  \n\n  \n\n  \n\n  \n\n```bash\ntar参数\n\t-c : 创建压缩\n\t-f ； 指定压缩包名称\n\t-z : 使用gzip压缩工具进行压缩\n\t-j : 使用bzip2压缩工具进行压缩\n\t-J : 使用xz压缩工具进行压缩\n\t-t : 显示压缩包内容，不解压\n\t-v : 显示压缩过程\n\t-P : 允许使用绝对路径进行压缩\n\t-x : 解压\n\t-C : 指定解压路径\n\t-h : 打包软连接\n\t--exclude : 排除某些文件\n\t--exclude-from : 根据文件列表排除多个文件\n```\n\n\n\n\n\n## 习题\n\n```bash\n1.linux下常见的压缩包类型有哪些\nzip \ngz \nbz2 \ntar.gz \ntar.bz \ntar\n\n2.将/etc/hosts文件用tar格式打包。\ntar -c -P -f hosts.tar /etc/hosts\n\n3.查看打包之后的/etc/hosts的文件内容，在不解压的情况下查看。\ntar -t -f hosts.tar\n\n4.使用tar打包/var/log/目录。\ntar -c -P -f hosts.tar /var/log/\n\n5.使用zip打包/etc目录。\nzip -r etc.zip /etc\n\n6.查看/var/log/abc.zip目录的压缩包中有哪些内容。\nunzip -l /var/log/abc.zip\n\n7.将/var/log/abc.zip目录解压到/opt目录中。\nunzip -d /opt /var/log/abc.zip\n\n10.解压/etc/abc.tar.gz目录到/opt目录中。\ntar -xf /etc/abc.tar.gz -C /opt\n\n11.用zip打包/opt目录，要求不显示打包过程。\nzip -q opt.zip /opt\n\nzip [参数] 压缩包名称  压缩文件路径\n \n12.打包/etc/目录，要求是.bz2格式\ntar -c -j -f etc.tar /etc\n\n13.打包/var/log目录，要求是.xz格式\ntar -c -J -f log.tar.xz /var/log\n\n14.使用tar命令打包/etc/时，会出现一个删根的操作，怎样打包不会进行删根的操作\ntar -c -P -f etc.tar /etc\n\n15.打包/etc/目录，要求不打包/etc/hosts这个文件。\n\n16.打包/etc/目录，要求不打包/etc/hosts和/etc/hostname这两个文件。\n\n17.打包/etc/目录，但要排除passwd,shadow,group,gshadow,hosts,hostname这些文件。(你能用两种方法实现吗)\n\n18.已知/etc/grub2.cfg文件是个软连接文件，在你不知道的情况下，请问怎么打包该文件的真实文件。\n\n19.把/var/log/目录中所有.log的文件进行打包成一个压缩包，名称定义为log.tar.gz的压缩包。\n\n20.已知文件oldboy.gz,请问在不解压的情况下，怎样查看该文件的内容。\n\n21.打包/etc/目录，当前时间方式的压缩包:比如: 2019-12-24_etc.tar.gz\n\n22.创建/data/bak目录，然后复制如下文件到/data/bak目录下\n\n23.接22题，使用tar命令对/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下（压缩包的名字以自己名字命名）\n\n24.使用tar命令查看上题/data目录下压缩包内的内容。\n\n25.把第23题/data目录下的压缩包，解压到/backup目录下\n\n26.再次使用tar命令把/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下，但是在进行归档压缩时，排除文件“sudoers”，然后查看该压缩包内容是否存在文件“sudoers”（压缩包名自行拟定）\n\n27.打包/etc目录下所有普通文件到root用户家目录。\n\n28.打包/etc/目录到/opt/目录下，名称要求以当前主机名和ip地址命名，例：oldboy_10.0.0.100.tar.gz\n\n29.如何使用gzip命令对文件进行压缩、解压\n\n30.如何用zip命令对文件以及目录进行压缩、解压\n\n32.打包opt整个目录，并命名test_opt.tar.gz\n\n33.查看打包好的test_opt.tar.gz里的文件\n\n34.将打包好的test_opt.tar.gz内容指定解压至/tmp目录\n\n35.打包etc目录下的所有文件，不要目录只要文件\n\n36.打包etc目录下的所有文件，排除passwd，shadow\n\n37.打包etc目录下的所有以p开头的文件\n\n38.打包etc目录下所有大于1M的文件\n```\n\n\n\n\n\n\n\n## 习题\n\n```bash\n2.权限中的rwx-，每个字符所代表什么意思？对应的数字是什么？\n\nr\t\t可读\t\t4\n\nw\t\t可写\t\t2\n\nx\t\t可执行\t\t1\n\n-\t\t没有权限\t0\n\n\n3.-rwxr-xr-x，写出对应数字权限\n\n\n\n4.-rwxr--r--，写出对应数字权限\n\n\n5.-r-xr-x--x，写出对应数字权限\n\n\n\n6.-rw-r-xr-x，写出对应数字权限\n\n\n7.-r--r--r--，写出对应数字权限\n\n\n\n8.-r-xr-----，写出对应数字权限\n\n\n9.---x-w-r--，写出对应数字权限\n\n\n10.-rwxr--rw-，写出对应数字权限\n\n\n\n11.-rw-r--r--，写出对应数字权限\n\n\n12.---xr--rwx，写出对应数字权限\n\n\n13.777，写出对应字母权限\n\n\n14.545，写出对应字母权限\n\n\n\n\n15.744，写出对应字母权限\n\n\n\n16.600，写出对应字母权限\n\n\n\n17.641，写出对应字母权限\n\n\n18.711，写出对应字母权限\n\n\n\n19.700，写出对应字母权限\n\n\n\n20.555，写出对应字母权限\n\n\n\n21.733，写出对应字母权限\n\n\n22.713，写出对应字母权限\n\n\n\n23.建一个目录/test,查看这个目录的默认权限是?\n\n\n\n\n24.进入/test目录中,建一个文件abc,查看其默认的权限为？\n\n\n\n\n25.创建一个文件test.txt,并其将权限改为600.\n\n\n\n26.将test.txt文件的权限改为755.\n\n\n\n27.将test.txt文件的权限改为000.\n\n\n\n28.修改test.txt文件的权限为644.\n\n\n\n29.给test.txt文件的属主加上x权限。\n\n\n\n\n30.给test.txt文件的其他用户加上x权限。\n\n\n\n31.去除test.txt文件的所有执行权限。\n\n\n\n32.给/test目录及目录下的所有文件或目录的权限统一改为744。\n\n\n```\n\n","source":"_posts/01_运维/01-基础命令/day08-打包与压缩/打包与压缩笔记.md","raw":"---\ntitle: 运维之基础命令--打包与压缩\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 打包和压缩\n\n> 将文件或文件夹合并成一个包，然后通过压缩算法进行数据压缩，减小包的体积，方便网络传输。\n\n```bash\nwindows：\n\tzip\n\trar\n\nlinux:\n\tzip\n\ttar\n\tgz\n\tbz2\n\ttar.gz\n\ttar.bz2\n\n压缩算法：\n\tgzip\n\tbzip2\n```\n\n## zip\n\n> 是一个Windows和Linux中常用打包压缩工具，支持的压缩算法是zip。\n\n```bash\nzip工具需要安装\n\tyum install zip unzip -y\n```\n\n### zip压缩一个文件\n\n```bash\n# 格式\n\tzip [参数] 压缩包名称  文件路径\n\n[root@abc ~]# zip 123.zip 123.log \n  adding: 123.log (deflated 87%)\n[root@abc ~]# ls -l\ntotal 4732\n-rw-r--r--  1 root root  646165 Mar  9 10:31 123.log\n-rw-r--r--  1 root root   85296 Mar 11 11:58 123.zip\n```\n\n### zip压缩文件夹\n\n```bash\n# 需要一个-r参数去递归压缩文件夹下的所有内容\n[root@abc ~]# zip -r dir.zip dir/\n  adding: dir/ (stored 0%)\n  adding: dir/one/ (stored 0%)\n  adding: dir/123.log (deflated 87%)\n```\n\n### zip的静默输出\n\n```bash\n# -q：参数就是不输出任何打包信息\n[root@abc opt]# zip -r -q etc.zip /etc/\n[root@abc opt]# ls -l\ntotal 14200\n-rw-r--r-- 1 root root 13674457 Mar 11 12:15 etc.zip\n```\n\n### zip解压命令（unzip）\n\n```bash\n# 格式\n\tunzip [参数] 压缩包路径\n\n# unzip解压命令只能解压由zip打包的压缩文件\n[root@abc ~]# unzip dir.zip \nArchive:  dir.zip\n  inflating: dir/123.log             \n[root@abc ~]# \n\n# 其他压缩包由unzip解压时随即报错。\n[root@abc opt]# unzip nginx-.tar.gz\nArchive:  nginx-.tar.gz\n  End-of-central-directory signature not found.  Either this file is not\n  a zipfile, or it constitutes one disk of a multi-part archive.  In the\n  latter case the central directory and zipfile comment will be found on\n  the last disk(s) of this archive.\nunzip:  cannot find zipfile directory in one of nginx-.tar.gz or\n        nginx-.tar.gz.zip, and cannot find nginx-.tar.gz.ZIP, period.\n\n\n# 查看压缩包中压缩那些内容，不解压？\n# 只查看压缩包内容不解压需要使用 -l 参数\n[root@abc opt]# unzip -l dir.zip \nArchive:  dir.zip\n  Length      Date    Time    Name\n---------  ---------- -----   ----\n        0  03-11-2021 12:04   dir/\n---------                     -------\n        0                     1 file\n\n# 解压到指定目录（-d）\n[root@abc ~]# unzip -d /root/  etc.zip \n[root@abc opt]# cd /root/\n[root@abc ~]# ls\n]        anaconda-ks.cfg  dir.zip  index.html           test.pdf.gz  xxxeth0xxx           系统优化.md\n123.log  demo.txt         etc      nginx-0.1.22.tar.gz  test.txt     上传与下载.md\n123.zip  dir              eth0xxx  test                 xxxeth0      文件管理_(高级).pdf\n\n# 静默输出(-q)\n[root@abc ~]# rm -rf etc\n[root@abc ~]# unzip -q -d /root/ /opt/etc.zip \n[root@abc ~]# ls -l\ntotal 4828\ndrwxr-xr-x  91 root root    8192 Mar 11 11:16 etc\n```\n\n## tar\n\n> tar压缩支持多种压缩算法\n>\n> tar.gz   gzip (用的最多)\n>\n> tar.bz2 bzip2\n\n### gzip\n\n> 通过gzip压缩算法，将文件压缩一定体积，有利于传输, 不支持打包\n\n```bash\n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  244977 Mar 10 12:12 index.html\n[root@abc ~]# gzip index.html \n[root@abc ~]# ls -l\ntotal 4612\n-rw-r--r--   1 root root   22652 Mar 10 12:12 index.html.gz\n```\n\n#### gzip压缩一个目录\n\n```bash\n[root@abc etc]# gzip -r /etc\n[root@abc etc]# ls \nabrt                        GREP_COLORS.gz               my.cnf.d                 security\nadjtime.gz                  groff                        my.cnf.gz                selinux\naliases.db.gz               group-.gz                    NetworkManager           services.gz\naliases.gz                  group.gz                     networks.gz              sestatus.conf.gz\nalternatives                grub2.cfg                    nsswitch.conf.bak.gz     sgml\nanacrontab.gz               grub.d                       nsswitch.conf.gz         shadow\n```\n\n### gzip解压(-d)\n\n```bash\n[root@abc ~]# ls -l\n-rw-r--r--   1 0 0   22652 Mar 10 12:12 index.html.gz\n[root@abc ~]# gzip -d index.html.gz \n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 0 0  244977 Mar 10 12:12 index.html\n```\n\n### bzip2\n\n> 使用bzip2 压缩算法来压缩一定体积的文件。\n\n```bash\n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  646165 Mar  9 10:31 123.log     \n[root@abc ~]# bzip2 123.log \n[root@abc ~]# ls -l\ntotal 4240\n-rw-r--r--   1 root root       0 Mar 10 12:04 ]\n-rw-r--r--   1 root root   42210 Mar  9 10:31 123.log.bz2\n```\n\n### bzip2解压（-d）\n\n> bzip2解压是针对于bzip2压缩的压缩包来进行解压。\n\n```bash\n[root@abc ~]# ls -l\ntotal 4240\n-rw-r--r--   1 root root   42210 Mar  9 10:31 123.log.bz2\n[root@abc ~]# bzip2 -d 123.log.bz2 \n[root@abc ~]# ls -l\ntotal 4828\n-rw-r--r--   1 root root  646165 Mar  9 10:31 123.log\n```\n\n### tar\n\n> tar其实是一个打包工具，不具备压缩功能，但是可以使用参数调用压缩工具来进行解压。\n\n#### 参数\n\n- -c : 创建压缩包\n\n- -f : 指定压缩包名称\n\n  ```bash\n  [root@abc ~]# tar -c -f test.tar 123.log \n  [root@abc ~]# ls -l\n  total 5468\n  -rw-r--r--   1 root root  655360 Mar 11 15:49 test.tar\n  ```\n\n- -z ： 指定使用gzip压缩工具进行压缩\n\n  ```bash\n  [root@abc ~]# tar  -c -z -f test-one.tar 123.log \n  [root@abc ~]# ls -l \n  total 5084\n  -rw-r--r--   1 root root   85279 Mar 11 15:56 test-one.tar\n  \n  # 注：使用-z参数，不会自动添加.gz后缀\n  \n  [root@abc ~]# tar -c -z -f anaconda.tar.gz  anaconda-ks.cfg \n  [root@abc ~]# ls -l\n  total 5084\n  -rw-r--r--   1 root root    1010 Mar 11 15:58 anaconda.tar.gz\n  ```\n\n- -j : 指定使用bzip2压缩工具进行压缩\n\n  ```bash\n  [root@abc ~]# tar -c -j -f 123-bask-one.tar 123.log \n  [root@abc ~]# ls -l\n  total 5172\n  -rw-r--r--   1 root root   42328 Mar 11 16:00 123-bak.tar.bz2\n  -rw-r--r--   1 root root   42328 Mar 11 16:01 123-bask-one.tar\n  ```\n\n- -J : 指定使用xz压缩工具进行压缩\n\n  ```bash\n  [root@abc test-tar]# tar -c -J  -f etc.tar.xz /etc/\n  [root@abc ~]# ls -l\n  -rw-r--r-- 1 root root 9493376 Mar 11 17:00 etc.tar.xz\n  ```\n\n- -t : 查看压缩包内容\n\n  ```bash\n  [root@abc ~]# tar -t -f 123-bak.tar.bz2 \n  123.log\n  [root@abc ~]# \n  ```\n\n- -v ： 显示压缩包压缩过程\n\n  ```bash\n  [root@abc ~]# tar -x -v -f etc.tar -C /opt/\n  /etc/centos-release\n  /etc/DIR_COLORS.lightbgcolor\n  /etc/libaudit.conf\n  /etc/mail.rc\n  ```\n\n- -P : 允许使用绝对路径进行打包\n\n  ```bash\n  [root@abc ~]# tar -c -P -f 123-three.tar /etc/passwd\n  [root@abc ~]# tar -c -f 123-three.tar /etc/passwd\n  tar: Removing leading `/' from member names\n  [root@abc ~]# \n  ```\n\n- -x ： 解压\n\n  ```bash\n  # tar解压是按照原来的路径进行解压\n  [root@abc test]# tar -x -f etc.tar \n  \n  # tar会自动识别压缩功能\n  ```\n\n- -C ： 指定解压路径\n\n  ```bash\n  [root@abc ~]# tar -x -f etc.tar -C /opt/\n  tar: Removing leading `/' from member names\n  [root@abc ~]# cd /opt/\n  [root@abc opt]# ls\n  abc23  dir  dir.zip  etc  nginx-0.1.22.tar.gz  nginx-.tar.gz  xxx\n  [root@abc opt]# \n  ```\n\n- --exclude : 排除某些文件\n\n  ```bash\n  [root@abc test-tar]# tar -c -f abc.tar ./* --exclude=abc7 --exclude=abc5   --exclude=abc1 \n  [root@abc test-tar]# tar -t -f abc.tar \n  ./abc2\n  ./abc3\n  ./abc4\n  ./abc6\n  ./abc8\n  ./abc9\n  [root@abc test-tar]# \n  ```\n\n- --exclude-from : 根据某个文件列表排除多个文件\n\n  ```bash\n  [root@abc test-tar]# cat list.txt \n  abc995\n  abc996\n  abc997\n  abc998\n  abc999\n  [root@abc test-tar]# tar -c -f abc.tar ./* --exclude-from=list.txt \n  ```\n\n- -h : 打包软连接\n\n  ```bash\n  [root@abc test-tar]# tar -c -h -f bin-h.tar /bin\n  ```\n\n  \n\n  \n\n  \n\n  \n\n```bash\ntar参数\n\t-c : 创建压缩\n\t-f ； 指定压缩包名称\n\t-z : 使用gzip压缩工具进行压缩\n\t-j : 使用bzip2压缩工具进行压缩\n\t-J : 使用xz压缩工具进行压缩\n\t-t : 显示压缩包内容，不解压\n\t-v : 显示压缩过程\n\t-P : 允许使用绝对路径进行压缩\n\t-x : 解压\n\t-C : 指定解压路径\n\t-h : 打包软连接\n\t--exclude : 排除某些文件\n\t--exclude-from : 根据文件列表排除多个文件\n```\n\n\n\n\n\n## 习题\n\n```bash\n1.linux下常见的压缩包类型有哪些\nzip \ngz \nbz2 \ntar.gz \ntar.bz \ntar\n\n2.将/etc/hosts文件用tar格式打包。\ntar -c -P -f hosts.tar /etc/hosts\n\n3.查看打包之后的/etc/hosts的文件内容，在不解压的情况下查看。\ntar -t -f hosts.tar\n\n4.使用tar打包/var/log/目录。\ntar -c -P -f hosts.tar /var/log/\n\n5.使用zip打包/etc目录。\nzip -r etc.zip /etc\n\n6.查看/var/log/abc.zip目录的压缩包中有哪些内容。\nunzip -l /var/log/abc.zip\n\n7.将/var/log/abc.zip目录解压到/opt目录中。\nunzip -d /opt /var/log/abc.zip\n\n10.解压/etc/abc.tar.gz目录到/opt目录中。\ntar -xf /etc/abc.tar.gz -C /opt\n\n11.用zip打包/opt目录，要求不显示打包过程。\nzip -q opt.zip /opt\n\nzip [参数] 压缩包名称  压缩文件路径\n \n12.打包/etc/目录，要求是.bz2格式\ntar -c -j -f etc.tar /etc\n\n13.打包/var/log目录，要求是.xz格式\ntar -c -J -f log.tar.xz /var/log\n\n14.使用tar命令打包/etc/时，会出现一个删根的操作，怎样打包不会进行删根的操作\ntar -c -P -f etc.tar /etc\n\n15.打包/etc/目录，要求不打包/etc/hosts这个文件。\n\n16.打包/etc/目录，要求不打包/etc/hosts和/etc/hostname这两个文件。\n\n17.打包/etc/目录，但要排除passwd,shadow,group,gshadow,hosts,hostname这些文件。(你能用两种方法实现吗)\n\n18.已知/etc/grub2.cfg文件是个软连接文件，在你不知道的情况下，请问怎么打包该文件的真实文件。\n\n19.把/var/log/目录中所有.log的文件进行打包成一个压缩包，名称定义为log.tar.gz的压缩包。\n\n20.已知文件oldboy.gz,请问在不解压的情况下，怎样查看该文件的内容。\n\n21.打包/etc/目录，当前时间方式的压缩包:比如: 2019-12-24_etc.tar.gz\n\n22.创建/data/bak目录，然后复制如下文件到/data/bak目录下\n\n23.接22题，使用tar命令对/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下（压缩包的名字以自己名字命名）\n\n24.使用tar命令查看上题/data目录下压缩包内的内容。\n\n25.把第23题/data目录下的压缩包，解压到/backup目录下\n\n26.再次使用tar命令把/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下，但是在进行归档压缩时，排除文件“sudoers”，然后查看该压缩包内容是否存在文件“sudoers”（压缩包名自行拟定）\n\n27.打包/etc目录下所有普通文件到root用户家目录。\n\n28.打包/etc/目录到/opt/目录下，名称要求以当前主机名和ip地址命名，例：oldboy_10.0.0.100.tar.gz\n\n29.如何使用gzip命令对文件进行压缩、解压\n\n30.如何用zip命令对文件以及目录进行压缩、解压\n\n32.打包opt整个目录，并命名test_opt.tar.gz\n\n33.查看打包好的test_opt.tar.gz里的文件\n\n34.将打包好的test_opt.tar.gz内容指定解压至/tmp目录\n\n35.打包etc目录下的所有文件，不要目录只要文件\n\n36.打包etc目录下的所有文件，排除passwd，shadow\n\n37.打包etc目录下的所有以p开头的文件\n\n38.打包etc目录下所有大于1M的文件\n```\n\n\n\n\n\n\n\n## 习题\n\n```bash\n2.权限中的rwx-，每个字符所代表什么意思？对应的数字是什么？\n\nr\t\t可读\t\t4\n\nw\t\t可写\t\t2\n\nx\t\t可执行\t\t1\n\n-\t\t没有权限\t0\n\n\n3.-rwxr-xr-x，写出对应数字权限\n\n\n\n4.-rwxr--r--，写出对应数字权限\n\n\n5.-r-xr-x--x，写出对应数字权限\n\n\n\n6.-rw-r-xr-x，写出对应数字权限\n\n\n7.-r--r--r--，写出对应数字权限\n\n\n\n8.-r-xr-----，写出对应数字权限\n\n\n9.---x-w-r--，写出对应数字权限\n\n\n10.-rwxr--rw-，写出对应数字权限\n\n\n\n11.-rw-r--r--，写出对应数字权限\n\n\n12.---xr--rwx，写出对应数字权限\n\n\n13.777，写出对应字母权限\n\n\n14.545，写出对应字母权限\n\n\n\n\n15.744，写出对应字母权限\n\n\n\n16.600，写出对应字母权限\n\n\n\n17.641，写出对应字母权限\n\n\n18.711，写出对应字母权限\n\n\n\n19.700，写出对应字母权限\n\n\n\n20.555，写出对应字母权限\n\n\n\n21.733，写出对应字母权限\n\n\n22.713，写出对应字母权限\n\n\n\n23.建一个目录/test,查看这个目录的默认权限是?\n\n\n\n\n24.进入/test目录中,建一个文件abc,查看其默认的权限为？\n\n\n\n\n25.创建一个文件test.txt,并其将权限改为600.\n\n\n\n26.将test.txt文件的权限改为755.\n\n\n\n27.将test.txt文件的权限改为000.\n\n\n\n28.修改test.txt文件的权限为644.\n\n\n\n29.给test.txt文件的属主加上x权限。\n\n\n\n\n30.给test.txt文件的其他用户加上x权限。\n\n\n\n31.去除test.txt文件的所有执行权限。\n\n\n\n32.给/test目录及目录下的所有文件或目录的权限统一改为744。\n\n\n```\n\n","slug":"01_运维/01-基础命令/day08-打包与压缩/打包与压缩笔记","published":1,"updated":"2022-07-06T07:13:25.722Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1c002ua8v7hpl7huiz","content":"<h1 id=\"打包和压缩\"><a href=\"#打包和压缩\" class=\"headerlink\" title=\"打包和压缩\"></a>打包和压缩</h1><blockquote>\n<p>将文件或文件夹合并成一个包，然后通过压缩算法进行数据压缩，减小包的体积，方便网络传输。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">windows：\n\t<span class=\"token function\">zip</span>\n\t<span class=\"token function\">rar</span>\n\nlinux:\n\t<span class=\"token function\">zip</span>\n\t<span class=\"token function\">tar</span>\n\tgz\n\tbz2\n\ttar.gz\n\ttar.bz2\n\n压缩算法：\n\t<span class=\"token function\">gzip</span>\n\t<span class=\"token function\">bzip2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"zip\"><a href=\"#zip\" class=\"headerlink\" title=\"zip\"></a>zip</h2><blockquote>\n<p>是一个Windows和Linux中常用打包压缩工具，支持的压缩算法是zip。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">zip工具需要安装\n\tyum <span class=\"token function\">install</span> <span class=\"token function\">zip</span> <span class=\"token function\">unzip</span> -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip压缩一个文件\"><a href=\"#zip压缩一个文件\" class=\"headerlink\" title=\"zip压缩一个文件\"></a>zip压缩一个文件</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 格式</span>\n\t<span class=\"token function\">zip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包名称  文件路径\n\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip 123.zip 123.log </span>\n  adding: <span class=\"token number\">123</span>.log <span class=\"token punctuation\">(</span>deflated <span class=\"token number\">87</span>%<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4732</span>\n-rw-r--r--  <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log\n-rw-r--r--  <span class=\"token number\">1</span> root root   <span class=\"token number\">85296</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">11</span>:58 <span class=\"token number\">123</span>.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip压缩文件夹\"><a href=\"#zip压缩文件夹\" class=\"headerlink\" title=\"zip压缩文件夹\"></a>zip压缩文件夹</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 需要一个-r参数去递归压缩文件夹下的所有内容</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip -r dir.zip dir/</span>\n  adding: dir/ <span class=\"token punctuation\">(</span>stored <span class=\"token number\">0</span>%<span class=\"token punctuation\">)</span>\n  adding: dir/one/ <span class=\"token punctuation\">(</span>stored <span class=\"token number\">0</span>%<span class=\"token punctuation\">)</span>\n  adding: dir/123.log <span class=\"token punctuation\">(</span>deflated <span class=\"token number\">87</span>%<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip的静默输出\"><a href=\"#zip的静默输出\" class=\"headerlink\" title=\"zip的静默输出\"></a>zip的静默输出</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># -q：参数就是不输出任何打包信息</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip -r -q etc.zip /etc/</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">14200</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">13674457</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">12</span>:15 etc.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip解压命令（unzip）\"><a href=\"#zip解压命令（unzip）\" class=\"headerlink\" title=\"zip解压命令（unzip）\"></a>zip解压命令（unzip）</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 格式</span>\n\t<span class=\"token function\">unzip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包路径\n\n<span class=\"token comment\"># unzip解压命令只能解压由zip打包的压缩文件</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip dir.zip </span>\nArchive:  dir.zip\n  inflating: dir/123.log             \n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 其他压缩包由unzip解压时随即报错。</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip nginx-.tar.gz</span>\nArchive:  nginx-.tar.gz\n  End-of-central-directory signature not found.  Either this <span class=\"token function\">file</span> is not\n  a zipfile, or it constitutes one disk of a multi-part archive.  In the\n  latter <span class=\"token keyword\">case</span> the central directory and zipfile comment will be found on\n  the last disk<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> of this archive.\nunzip:  cannot <span class=\"token function\">find</span> zipfile directory <span class=\"token keyword\">in</span> one of nginx-.tar.gz or\n        nginx-.tar.gz.zip, and cannot <span class=\"token function\">find</span> nginx-.tar.gz.ZIP, period.\n\n\n<span class=\"token comment\"># 查看压缩包中压缩那些内容，不解压？</span>\n<span class=\"token comment\"># 只查看压缩包内容不解压需要使用 -l 参数</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -l dir.zip </span>\nArchive:  dir.zip\n  Length      Date    Time    Name\n---------  ---------- -----   ----\n        <span class=\"token number\">0</span>  03-11-2021 <span class=\"token number\">12</span>:04   dir/\n---------                     -------\n        <span class=\"token number\">0</span>                     <span class=\"token number\">1</span> <span class=\"token function\">file</span>\n\n<span class=\"token comment\"># 解压到指定目录（-d）</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -d /root/  etc.zip </span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span>\n<span class=\"token punctuation\">]</span>        anaconda-ks.cfg  dir.zip  index.html           test.pdf.gz  xxxeth0xxx           系统优化.md\n<span class=\"token number\">123</span>.log  demo.txt         etc      nginx-0.1.22.tar.gz  test.txt     上传与下载.md\n<span class=\"token number\">123</span>.zip  <span class=\"token function\">dir</span>              eth0xxx  <span class=\"token builtin class-name\">test</span>                 xxxeth0      文件管理_<span class=\"token punctuation\">(</span>高级<span class=\"token punctuation\">)</span>.pdf\n\n<span class=\"token comment\"># 静默输出(-q)</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf etc</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -q -d /root/ /opt/etc.zip </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\ndrwxr-xr-x  <span class=\"token number\">91</span> root root    <span class=\"token number\">8192</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">11</span>:16 etc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"tar\"><a href=\"#tar\" class=\"headerlink\" title=\"tar\"></a>tar</h2><blockquote>\n<p>tar压缩支持多种压缩算法</p>\n<p>tar.gz   gzip (用的最多)</p>\n<p>tar.bz2 bzip2</p>\n</blockquote>\n<h3 id=\"gzip\"><a href=\"#gzip\" class=\"headerlink\" title=\"gzip\"></a>gzip</h3><blockquote>\n<p>通过gzip压缩算法，将文件压缩一定体积，有利于传输, 不支持打包</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">244977</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip index.html </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4612</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">22652</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"gzip压缩一个目录\"><a href=\"#gzip压缩一个目录\" class=\"headerlink\" title=\"gzip压缩一个目录\"></a>gzip压缩一个目录</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip -r /etc</span>\n<span class=\"token punctuation\">[</span>root@abc etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls </span>\nabrt                        GREP_COLORS.gz               my.cnf.d                 security\nadjtime.gz                  groff                        my.cnf.gz                selinux\naliases.db.gz               group-.gz                    NetworkManager           services.gz\naliases.gz                  group.gz                     networks.gz              sestatus.conf.gz\nalternatives                grub2.cfg                    nsswitch.conf.bak.gz     sgml\nanacrontab.gz               grub.d                       nsswitch.conf.gz         shadow<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"gzip解压-d\"><a href=\"#gzip解压-d\" class=\"headerlink\" title=\"gzip解压(-d)\"></a>gzip解压(-d)</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\n-rw-r--r--   <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>   <span class=\"token number\">22652</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html.gz\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip -d index.html.gz </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>  <span class=\"token number\">244977</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"bzip2\"><a href=\"#bzip2\" class=\"headerlink\" title=\"bzip2\"></a>bzip2</h3><blockquote>\n<p>使用bzip2 压缩算法来压缩一定体积的文件。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log     \n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bzip2 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4240</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root       <span class=\"token number\">0</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:04 <span class=\"token punctuation\">]</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42210</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log.bz2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"bzip2解压（-d）\"><a href=\"#bzip2解压（-d）\" class=\"headerlink\" title=\"bzip2解压（-d）\"></a>bzip2解压（-d）</h3><blockquote>\n<p>bzip2解压是针对于bzip2压缩的压缩包来进行解压。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4240</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42210</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log.bz2\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bzip2 -d 123.log.bz2 </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"tar-1\"><a href=\"#tar-1\" class=\"headerlink\" title=\"tar\"></a>tar</h3><blockquote>\n<p>tar其实是一个打包工具，不具备压缩功能，但是可以使用参数调用压缩工具来进行解压。</p>\n</blockquote>\n<h4 id=\"参数\"><a href=\"#参数\" class=\"headerlink\" title=\"参数\"></a>参数</h4><ul>\n<li><p>-c : 创建压缩包</p>\n</li>\n<li><p>-f : 指定压缩包名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f test.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5468</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">655360</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:49 test.tar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-z ： 指定使用gzip压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar  -c -z -f test-one.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l </span>\ntotal <span class=\"token number\">5084</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">85279</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:56 test-one.tar\n\n<span class=\"token comment\"># 注：使用-z参数，不会自动添加.gz后缀</span>\n\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -z -f anaconda.tar.gz  anaconda-ks.cfg </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5084</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root    <span class=\"token number\">1010</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:58 anaconda.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-j : 指定使用bzip2压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -j -f 123-bask-one.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5172</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42328</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">16</span>:00 <span class=\"token number\">123</span>-bak.tar.bz2\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42328</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">16</span>:01 <span class=\"token number\">123</span>-bask-one.tar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-J : 指定使用xz压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -J  -f etc.tar.xz /etc/</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9493376</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">17</span>:00 etc.tar.xz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-t : 查看压缩包内容</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -t -f 123-bak.tar.bz2 </span>\n<span class=\"token number\">123</span>.log\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-v ： 显示压缩包压缩过程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -v -f etc.tar -C /opt/</span>\n/etc/centos-release\n/etc/DIR_COLORS.lightbgcolor\n/etc/libaudit.conf\n/etc/mail.rc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-P : 允许使用绝对路径进行打包</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -P -f 123-three.tar /etc/passwd</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f 123-three.tar /etc/passwd</span>\ntar: Removing leading `/' from member names\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-x ： 解压</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># tar解压是按照原来的路径进行解压</span>\n<span class=\"token punctuation\">[</span>root@abc test<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -f etc.tar </span>\n\n<span class=\"token comment\"># tar会自动识别压缩功能</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-C ： 指定解压路径</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -f etc.tar -C /opt/</span>\ntar: Removing leading `/' from member names\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /opt/</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span>\nabc23  <span class=\"token function\">dir</span>  dir.zip  etc  nginx-0.1.22.tar.gz  nginx-.tar.gz  xxx\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>–exclude : 排除某些文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f abc.tar ./* --exclude=abc7 --exclude=abc5   --exclude=abc1 </span>\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -t -f abc.tar </span>\n./abc2\n./abc3\n./abc4\n./abc6\n./abc8\n./abc9\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>–exclude-from : 根据某个文件列表排除多个文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat list.txt </span>\nabc995\nabc996\nabc997\nabc998\nabc999\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f abc.tar ./* --exclude-from=list.txt </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-h : 打包软连接</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -h -f bin-h.tar /bin</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tar参数\n\t-c <span class=\"token builtin class-name\">:</span> 创建压缩\n\t-f ； 指定压缩包名称\n\t-z <span class=\"token builtin class-name\">:</span> 使用gzip压缩工具进行压缩\n\t-j <span class=\"token builtin class-name\">:</span> 使用bzip2压缩工具进行压缩\n\t-J <span class=\"token builtin class-name\">:</span> 使用xz压缩工具进行压缩\n\t-t <span class=\"token builtin class-name\">:</span> 显示压缩包内容，不解压\n\t-v <span class=\"token builtin class-name\">:</span> 显示压缩过程\n\t-P <span class=\"token builtin class-name\">:</span> 允许使用绝对路径进行压缩\n\t-x <span class=\"token builtin class-name\">:</span> 解压\n\t-C <span class=\"token builtin class-name\">:</span> 指定解压路径\n\t-h <span class=\"token builtin class-name\">:</span> 打包软连接\n\t--exclude <span class=\"token builtin class-name\">:</span> 排除某些文件\n\t--exclude-from <span class=\"token builtin class-name\">:</span> 根据文件列表排除多个文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<h2 id=\"习题\"><a href=\"#习题\" class=\"headerlink\" title=\"习题\"></a>习题</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>.linux下常见的压缩包类型有哪些\n<span class=\"token function\">zip</span> \ngz \nbz2 \ntar.gz \ntar.bz \n<span class=\"token function\">tar</span>\n\n<span class=\"token number\">2</span>.将/etc/hosts文件用tar格式打包。\n<span class=\"token function\">tar</span> -c -P -f hosts.tar /etc/hosts\n\n<span class=\"token number\">3</span>.查看打包之后的/etc/hosts的文件内容，在不解压的情况下查看。\n<span class=\"token function\">tar</span> -t -f hosts.tar\n\n<span class=\"token number\">4</span>.使用tar打包/var/log/目录。\n<span class=\"token function\">tar</span> -c -P -f hosts.tar /var/log/\n\n<span class=\"token number\">5</span>.使用zip打包/etc目录。\n<span class=\"token function\">zip</span> -r etc.zip /etc\n\n<span class=\"token number\">6</span>.查看/var/log/abc.zip目录的压缩包中有哪些内容。\n<span class=\"token function\">unzip</span> -l /var/log/abc.zip\n\n<span class=\"token number\">7</span>.将/var/log/abc.zip目录解压到/opt目录中。\n<span class=\"token function\">unzip</span> -d /opt /var/log/abc.zip\n\n<span class=\"token number\">10</span>.解压/etc/abc.tar.gz目录到/opt目录中。\n<span class=\"token function\">tar</span> -xf /etc/abc.tar.gz -C /opt\n\n<span class=\"token number\">11</span>.用zip打包/opt目录，要求不显示打包过程。\n<span class=\"token function\">zip</span> -q opt.zip /opt\n\n<span class=\"token function\">zip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包名称  压缩文件路径\n \n<span class=\"token number\">12</span>.打包/etc/目录，要求是.bz2格式\n<span class=\"token function\">tar</span> -c -j -f etc.tar /etc\n\n<span class=\"token number\">13</span>.打包/var/log目录，要求是.xz格式\n<span class=\"token function\">tar</span> -c -J -f log.tar.xz /var/log\n\n<span class=\"token number\">14</span>.使用tar命令打包/etc/时，会出现一个删根的操作，怎样打包不会进行删根的操作\n<span class=\"token function\">tar</span> -c -P -f etc.tar /etc\n\n<span class=\"token number\">15</span>.打包/etc/目录，要求不打包/etc/hosts这个文件。\n\n<span class=\"token number\">16</span>.打包/etc/目录，要求不打包/etc/hosts和/etc/hostname这两个文件。\n\n<span class=\"token number\">17</span>.打包/etc/目录，但要排除passwd,shadow,group,gshadow,hosts,hostname这些文件。<span class=\"token punctuation\">(</span>你能用两种方法实现吗<span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">18</span>.已知/etc/grub2.cfg文件是个软连接文件，在你不知道的情况下，请问怎么打包该文件的真实文件。\n\n<span class=\"token number\">19</span>.把/var/log/目录中所有.log的文件进行打包成一个压缩包，名称定义为log.tar.gz的压缩包。\n\n<span class=\"token number\">20</span>.已知文件oldboy.gz,请问在不解压的情况下，怎样查看该文件的内容。\n\n<span class=\"token number\">21</span>.打包/etc/目录，当前时间方式的压缩包:比如: <span class=\"token number\">2019</span>-12-24_etc.tar.gz\n\n<span class=\"token number\">22</span>.创建/data/bak目录，然后复制如下文件到/data/bak目录下\n\n<span class=\"token number\">23</span>.接22题，使用tar命令对/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下（压缩包的名字以自己名字命名）\n\n<span class=\"token number\">24</span>.使用tar命令查看上题/data目录下压缩包内的内容。\n\n<span class=\"token number\">25</span>.把第23题/data目录下的压缩包，解压到/backup目录下\n\n<span class=\"token number\">26</span>.再次使用tar命令把/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下，但是在进行归档压缩时，排除文件“sudoers”，然后查看该压缩包内容是否存在文件“sudoers”（压缩包名自行拟定）\n\n<span class=\"token number\">27</span>.打包/etc目录下所有普通文件到root用户家目录。\n\n<span class=\"token number\">28</span>.打包/etc/目录到/opt/目录下，名称要求以当前主机名和ip地址命名，例：oldboy_10.0.0.100.tar.gz\n\n<span class=\"token number\">29</span>.如何使用gzip命令对文件进行压缩、解压\n\n<span class=\"token number\">30</span>.如何用zip命令对文件以及目录进行压缩、解压\n\n<span class=\"token number\">32</span>.打包opt整个目录，并命名test_opt.tar.gz\n\n<span class=\"token number\">33</span>.查看打包好的test_opt.tar.gz里的文件\n\n<span class=\"token number\">34</span>.将打包好的test_opt.tar.gz内容指定解压至/tmp目录\n\n<span class=\"token number\">35</span>.打包etc目录下的所有文件，不要目录只要文件\n\n<span class=\"token number\">36</span>.打包etc目录下的所有文件，排除passwd，shadow\n\n<span class=\"token number\">37</span>.打包etc目录下的所有以p开头的文件\n\n<span class=\"token number\">38</span>.打包etc目录下所有大于1M的文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n<h2 id=\"习题-1\"><a href=\"#习题-1\" class=\"headerlink\" title=\"习题\"></a>习题</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">2</span>.权限中的rwx-，每个字符所代表什么意思？对应的数字是什么？\n\nr\t\t可读\t\t<span class=\"token number\">4</span>\n\nw\t\t可写\t\t<span class=\"token number\">2</span>\n\nx\t\t可执行\t\t<span class=\"token number\">1</span>\n\n-\t\t没有权限\t<span class=\"token number\">0</span>\n\n\n<span class=\"token number\">3</span>.-rwxr-xr-x，写出对应数字权限\n\n\n\n<span class=\"token number\">4</span>.-rwxr--r--，写出对应数字权限\n\n\n<span class=\"token number\">5</span>.-r-xr-x--x，写出对应数字权限\n\n\n\n<span class=\"token number\">6</span>.-rw-r-xr-x，写出对应数字权限\n\n\n<span class=\"token number\">7</span>.-r--r--r--，写出对应数字权限\n\n\n\n<span class=\"token number\">8</span>.-r-xr-----，写出对应数字权限\n\n\n<span class=\"token number\">9</span>.---x-w-r--，写出对应数字权限\n\n\n<span class=\"token number\">10</span>.-rwxr--rw-，写出对应数字权限\n\n\n\n<span class=\"token number\">11</span>.-rw-r--r--，写出对应数字权限\n\n\n<span class=\"token number\">12</span>.---xr--rwx，写出对应数字权限\n\n\n<span class=\"token number\">13.777</span>，写出对应字母权限\n\n\n<span class=\"token number\">14.545</span>，写出对应字母权限\n\n\n\n\n<span class=\"token number\">15.744</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">16.600</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">17.641</span>，写出对应字母权限\n\n\n<span class=\"token number\">18.711</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">19.700</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">20.555</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">21.733</span>，写出对应字母权限\n\n\n<span class=\"token number\">22.713</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">23</span>.建一个目录/test,查看这个目录的默认权限是?\n\n\n\n\n<span class=\"token number\">24</span>.进入/test目录中,建一个文件abc,查看其默认的权限为？\n\n\n\n\n<span class=\"token number\">25</span>.创建一个文件test.txt,并其将权限改为600.\n\n\n\n<span class=\"token number\">26</span>.将test.txt文件的权限改为755.\n\n\n\n<span class=\"token number\">27</span>.将test.txt文件的权限改为000.\n\n\n\n<span class=\"token number\">28</span>.修改test.txt文件的权限为644.\n\n\n\n<span class=\"token number\">29</span>.给test.txt文件的属主加上x权限。\n\n\n\n\n<span class=\"token number\">30</span>.给test.txt文件的其他用户加上x权限。\n\n\n\n<span class=\"token number\">31</span>.去除test.txt文件的所有执行权限。\n\n\n\n<span class=\"token number\">32</span>.给/test目录及目录下的所有文件或目录的权限统一改为744。\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"打包和压缩\"><a href=\"#打包和压缩\" class=\"headerlink\" title=\"打包和压缩\"></a>打包和压缩</h1><blockquote>\n<p>将文件或文件夹合并成一个包，然后通过压缩算法进行数据压缩，减小包的体积，方便网络传输。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">windows：\n\t<span class=\"token function\">zip</span>\n\t<span class=\"token function\">rar</span>\n\nlinux:\n\t<span class=\"token function\">zip</span>\n\t<span class=\"token function\">tar</span>\n\tgz\n\tbz2\n\ttar.gz\n\ttar.bz2\n\n压缩算法：\n\t<span class=\"token function\">gzip</span>\n\t<span class=\"token function\">bzip2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"zip\"><a href=\"#zip\" class=\"headerlink\" title=\"zip\"></a>zip</h2><blockquote>\n<p>是一个Windows和Linux中常用打包压缩工具，支持的压缩算法是zip。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">zip工具需要安装\n\tyum <span class=\"token function\">install</span> <span class=\"token function\">zip</span> <span class=\"token function\">unzip</span> -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip压缩一个文件\"><a href=\"#zip压缩一个文件\" class=\"headerlink\" title=\"zip压缩一个文件\"></a>zip压缩一个文件</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 格式</span>\n\t<span class=\"token function\">zip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包名称  文件路径\n\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip 123.zip 123.log </span>\n  adding: <span class=\"token number\">123</span>.log <span class=\"token punctuation\">(</span>deflated <span class=\"token number\">87</span>%<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4732</span>\n-rw-r--r--  <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log\n-rw-r--r--  <span class=\"token number\">1</span> root root   <span class=\"token number\">85296</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">11</span>:58 <span class=\"token number\">123</span>.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip压缩文件夹\"><a href=\"#zip压缩文件夹\" class=\"headerlink\" title=\"zip压缩文件夹\"></a>zip压缩文件夹</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 需要一个-r参数去递归压缩文件夹下的所有内容</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip -r dir.zip dir/</span>\n  adding: dir/ <span class=\"token punctuation\">(</span>stored <span class=\"token number\">0</span>%<span class=\"token punctuation\">)</span>\n  adding: dir/one/ <span class=\"token punctuation\">(</span>stored <span class=\"token number\">0</span>%<span class=\"token punctuation\">)</span>\n  adding: dir/123.log <span class=\"token punctuation\">(</span>deflated <span class=\"token number\">87</span>%<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip的静默输出\"><a href=\"#zip的静默输出\" class=\"headerlink\" title=\"zip的静默输出\"></a>zip的静默输出</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># -q：参数就是不输出任何打包信息</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># zip -r -q etc.zip /etc/</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">14200</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">13674457</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">12</span>:15 etc.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"zip解压命令（unzip）\"><a href=\"#zip解压命令（unzip）\" class=\"headerlink\" title=\"zip解压命令（unzip）\"></a>zip解压命令（unzip）</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 格式</span>\n\t<span class=\"token function\">unzip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包路径\n\n<span class=\"token comment\"># unzip解压命令只能解压由zip打包的压缩文件</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip dir.zip </span>\nArchive:  dir.zip\n  inflating: dir/123.log             \n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 其他压缩包由unzip解压时随即报错。</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip nginx-.tar.gz</span>\nArchive:  nginx-.tar.gz\n  End-of-central-directory signature not found.  Either this <span class=\"token function\">file</span> is not\n  a zipfile, or it constitutes one disk of a multi-part archive.  In the\n  latter <span class=\"token keyword\">case</span> the central directory and zipfile comment will be found on\n  the last disk<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> of this archive.\nunzip:  cannot <span class=\"token function\">find</span> zipfile directory <span class=\"token keyword\">in</span> one of nginx-.tar.gz or\n        nginx-.tar.gz.zip, and cannot <span class=\"token function\">find</span> nginx-.tar.gz.ZIP, period.\n\n\n<span class=\"token comment\"># 查看压缩包中压缩那些内容，不解压？</span>\n<span class=\"token comment\"># 只查看压缩包内容不解压需要使用 -l 参数</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -l dir.zip </span>\nArchive:  dir.zip\n  Length      Date    Time    Name\n---------  ---------- -----   ----\n        <span class=\"token number\">0</span>  03-11-2021 <span class=\"token number\">12</span>:04   dir/\n---------                     -------\n        <span class=\"token number\">0</span>                     <span class=\"token number\">1</span> <span class=\"token function\">file</span>\n\n<span class=\"token comment\"># 解压到指定目录（-d）</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -d /root/  etc.zip </span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span>\n<span class=\"token punctuation\">]</span>        anaconda-ks.cfg  dir.zip  index.html           test.pdf.gz  xxxeth0xxx           系统优化.md\n<span class=\"token number\">123</span>.log  demo.txt         etc      nginx-0.1.22.tar.gz  test.txt     上传与下载.md\n<span class=\"token number\">123</span>.zip  <span class=\"token function\">dir</span>              eth0xxx  <span class=\"token builtin class-name\">test</span>                 xxxeth0      文件管理_<span class=\"token punctuation\">(</span>高级<span class=\"token punctuation\">)</span>.pdf\n\n<span class=\"token comment\"># 静默输出(-q)</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf etc</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip -q -d /root/ /opt/etc.zip </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\ndrwxr-xr-x  <span class=\"token number\">91</span> root root    <span class=\"token number\">8192</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">11</span>:16 etc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"tar\"><a href=\"#tar\" class=\"headerlink\" title=\"tar\"></a>tar</h2><blockquote>\n<p>tar压缩支持多种压缩算法</p>\n<p>tar.gz   gzip (用的最多)</p>\n<p>tar.bz2 bzip2</p>\n</blockquote>\n<h3 id=\"gzip\"><a href=\"#gzip\" class=\"headerlink\" title=\"gzip\"></a>gzip</h3><blockquote>\n<p>通过gzip压缩算法，将文件压缩一定体积，有利于传输, 不支持打包</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">244977</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip index.html </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4612</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">22652</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"gzip压缩一个目录\"><a href=\"#gzip压缩一个目录\" class=\"headerlink\" title=\"gzip压缩一个目录\"></a>gzip压缩一个目录</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip -r /etc</span>\n<span class=\"token punctuation\">[</span>root@abc etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls </span>\nabrt                        GREP_COLORS.gz               my.cnf.d                 security\nadjtime.gz                  groff                        my.cnf.gz                selinux\naliases.db.gz               group-.gz                    NetworkManager           services.gz\naliases.gz                  group.gz                     networks.gz              sestatus.conf.gz\nalternatives                grub2.cfg                    nsswitch.conf.bak.gz     sgml\nanacrontab.gz               grub.d                       nsswitch.conf.gz         shadow<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"gzip解压-d\"><a href=\"#gzip解压-d\" class=\"headerlink\" title=\"gzip解压(-d)\"></a>gzip解压(-d)</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\n-rw-r--r--   <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>   <span class=\"token number\">22652</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html.gz\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gzip -d index.html.gz </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> <span class=\"token number\">0</span> <span class=\"token number\">0</span>  <span class=\"token number\">244977</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:12 index.html<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"bzip2\"><a href=\"#bzip2\" class=\"headerlink\" title=\"bzip2\"></a>bzip2</h3><blockquote>\n<p>使用bzip2 压缩算法来压缩一定体积的文件。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log     \n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bzip2 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4240</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root       <span class=\"token number\">0</span> Mar <span class=\"token number\">10</span> <span class=\"token number\">12</span>:04 <span class=\"token punctuation\">]</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42210</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log.bz2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"bzip2解压（-d）\"><a href=\"#bzip2解压（-d）\" class=\"headerlink\" title=\"bzip2解压（-d）\"></a>bzip2解压（-d）</h3><blockquote>\n<p>bzip2解压是针对于bzip2压缩的压缩包来进行解压。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4240</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42210</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log.bz2\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bzip2 -d 123.log.bz2 </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">4828</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">646165</span> Mar  <span class=\"token number\">9</span> <span class=\"token number\">10</span>:31 <span class=\"token number\">123</span>.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"tar-1\"><a href=\"#tar-1\" class=\"headerlink\" title=\"tar\"></a>tar</h3><blockquote>\n<p>tar其实是一个打包工具，不具备压缩功能，但是可以使用参数调用压缩工具来进行解压。</p>\n</blockquote>\n<h4 id=\"参数\"><a href=\"#参数\" class=\"headerlink\" title=\"参数\"></a>参数</h4><ul>\n<li><p>-c : 创建压缩包</p>\n</li>\n<li><p>-f : 指定压缩包名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f test.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5468</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root  <span class=\"token number\">655360</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:49 test.tar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-z ： 指定使用gzip压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar  -c -z -f test-one.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l </span>\ntotal <span class=\"token number\">5084</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">85279</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:56 test-one.tar\n\n<span class=\"token comment\"># 注：使用-z参数，不会自动添加.gz后缀</span>\n\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -z -f anaconda.tar.gz  anaconda-ks.cfg </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5084</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root    <span class=\"token number\">1010</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">15</span>:58 anaconda.tar.gz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-j : 指定使用bzip2压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -j -f 123-bask-one.tar 123.log </span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">5172</span>\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42328</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">16</span>:00 <span class=\"token number\">123</span>-bak.tar.bz2\n-rw-r--r--   <span class=\"token number\">1</span> root root   <span class=\"token number\">42328</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">16</span>:01 <span class=\"token number\">123</span>-bask-one.tar<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-J : 指定使用xz压缩工具进行压缩</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -J  -f etc.tar.xz /etc/</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9493376</span> Mar <span class=\"token number\">11</span> <span class=\"token number\">17</span>:00 etc.tar.xz<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-t : 查看压缩包内容</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -t -f 123-bak.tar.bz2 </span>\n<span class=\"token number\">123</span>.log\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-v ： 显示压缩包压缩过程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -v -f etc.tar -C /opt/</span>\n/etc/centos-release\n/etc/DIR_COLORS.lightbgcolor\n/etc/libaudit.conf\n/etc/mail.rc<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-P : 允许使用绝对路径进行打包</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -P -f 123-three.tar /etc/passwd</span>\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f 123-three.tar /etc/passwd</span>\ntar: Removing leading `/' from member names\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-x ： 解压</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># tar解压是按照原来的路径进行解压</span>\n<span class=\"token punctuation\">[</span>root@abc test<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -f etc.tar </span>\n\n<span class=\"token comment\"># tar会自动识别压缩功能</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-C ： 指定解压路径</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -x -f etc.tar -C /opt/</span>\ntar: Removing leading `/' from member names\n<span class=\"token punctuation\">[</span>root@abc ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /opt/</span>\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span>\nabc23  <span class=\"token function\">dir</span>  dir.zip  etc  nginx-0.1.22.tar.gz  nginx-.tar.gz  xxx\n<span class=\"token punctuation\">[</span>root@abc opt<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>–exclude : 排除某些文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f abc.tar ./* --exclude=abc7 --exclude=abc5   --exclude=abc1 </span>\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -t -f abc.tar </span>\n./abc2\n./abc3\n./abc4\n./abc6\n./abc8\n./abc9\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>–exclude-from : 根据某个文件列表排除多个文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat list.txt </span>\nabc995\nabc996\nabc997\nabc998\nabc999\n<span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -f abc.tar ./* --exclude-from=list.txt </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>-h : 打包软连接</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@abc test-tar<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -c -h -f bin-h.tar /bin</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre></li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tar参数\n\t-c <span class=\"token builtin class-name\">:</span> 创建压缩\n\t-f ； 指定压缩包名称\n\t-z <span class=\"token builtin class-name\">:</span> 使用gzip压缩工具进行压缩\n\t-j <span class=\"token builtin class-name\">:</span> 使用bzip2压缩工具进行压缩\n\t-J <span class=\"token builtin class-name\">:</span> 使用xz压缩工具进行压缩\n\t-t <span class=\"token builtin class-name\">:</span> 显示压缩包内容，不解压\n\t-v <span class=\"token builtin class-name\">:</span> 显示压缩过程\n\t-P <span class=\"token builtin class-name\">:</span> 允许使用绝对路径进行压缩\n\t-x <span class=\"token builtin class-name\">:</span> 解压\n\t-C <span class=\"token builtin class-name\">:</span> 指定解压路径\n\t-h <span class=\"token builtin class-name\">:</span> 打包软连接\n\t--exclude <span class=\"token builtin class-name\">:</span> 排除某些文件\n\t--exclude-from <span class=\"token builtin class-name\">:</span> 根据文件列表排除多个文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n<h2 id=\"习题\"><a href=\"#习题\" class=\"headerlink\" title=\"习题\"></a>习题</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>.linux下常见的压缩包类型有哪些\n<span class=\"token function\">zip</span> \ngz \nbz2 \ntar.gz \ntar.bz \n<span class=\"token function\">tar</span>\n\n<span class=\"token number\">2</span>.将/etc/hosts文件用tar格式打包。\n<span class=\"token function\">tar</span> -c -P -f hosts.tar /etc/hosts\n\n<span class=\"token number\">3</span>.查看打包之后的/etc/hosts的文件内容，在不解压的情况下查看。\n<span class=\"token function\">tar</span> -t -f hosts.tar\n\n<span class=\"token number\">4</span>.使用tar打包/var/log/目录。\n<span class=\"token function\">tar</span> -c -P -f hosts.tar /var/log/\n\n<span class=\"token number\">5</span>.使用zip打包/etc目录。\n<span class=\"token function\">zip</span> -r etc.zip /etc\n\n<span class=\"token number\">6</span>.查看/var/log/abc.zip目录的压缩包中有哪些内容。\n<span class=\"token function\">unzip</span> -l /var/log/abc.zip\n\n<span class=\"token number\">7</span>.将/var/log/abc.zip目录解压到/opt目录中。\n<span class=\"token function\">unzip</span> -d /opt /var/log/abc.zip\n\n<span class=\"token number\">10</span>.解压/etc/abc.tar.gz目录到/opt目录中。\n<span class=\"token function\">tar</span> -xf /etc/abc.tar.gz -C /opt\n\n<span class=\"token number\">11</span>.用zip打包/opt目录，要求不显示打包过程。\n<span class=\"token function\">zip</span> -q opt.zip /opt\n\n<span class=\"token function\">zip</span> <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 压缩包名称  压缩文件路径\n \n<span class=\"token number\">12</span>.打包/etc/目录，要求是.bz2格式\n<span class=\"token function\">tar</span> -c -j -f etc.tar /etc\n\n<span class=\"token number\">13</span>.打包/var/log目录，要求是.xz格式\n<span class=\"token function\">tar</span> -c -J -f log.tar.xz /var/log\n\n<span class=\"token number\">14</span>.使用tar命令打包/etc/时，会出现一个删根的操作，怎样打包不会进行删根的操作\n<span class=\"token function\">tar</span> -c -P -f etc.tar /etc\n\n<span class=\"token number\">15</span>.打包/etc/目录，要求不打包/etc/hosts这个文件。\n\n<span class=\"token number\">16</span>.打包/etc/目录，要求不打包/etc/hosts和/etc/hostname这两个文件。\n\n<span class=\"token number\">17</span>.打包/etc/目录，但要排除passwd,shadow,group,gshadow,hosts,hostname这些文件。<span class=\"token punctuation\">(</span>你能用两种方法实现吗<span class=\"token punctuation\">)</span>\n\n<span class=\"token number\">18</span>.已知/etc/grub2.cfg文件是个软连接文件，在你不知道的情况下，请问怎么打包该文件的真实文件。\n\n<span class=\"token number\">19</span>.把/var/log/目录中所有.log的文件进行打包成一个压缩包，名称定义为log.tar.gz的压缩包。\n\n<span class=\"token number\">20</span>.已知文件oldboy.gz,请问在不解压的情况下，怎样查看该文件的内容。\n\n<span class=\"token number\">21</span>.打包/etc/目录，当前时间方式的压缩包:比如: <span class=\"token number\">2019</span>-12-24_etc.tar.gz\n\n<span class=\"token number\">22</span>.创建/data/bak目录，然后复制如下文件到/data/bak目录下\n\n<span class=\"token number\">23</span>.接22题，使用tar命令对/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下（压缩包的名字以自己名字命名）\n\n<span class=\"token number\">24</span>.使用tar命令查看上题/data目录下压缩包内的内容。\n\n<span class=\"token number\">25</span>.把第23题/data目录下的压缩包，解压到/backup目录下\n\n<span class=\"token number\">26</span>.再次使用tar命令把/data/bak目录下的文件及目录以gzip的格式进行归档压缩到/data目录下，但是在进行归档压缩时，排除文件“sudoers”，然后查看该压缩包内容是否存在文件“sudoers”（压缩包名自行拟定）\n\n<span class=\"token number\">27</span>.打包/etc目录下所有普通文件到root用户家目录。\n\n<span class=\"token number\">28</span>.打包/etc/目录到/opt/目录下，名称要求以当前主机名和ip地址命名，例：oldboy_10.0.0.100.tar.gz\n\n<span class=\"token number\">29</span>.如何使用gzip命令对文件进行压缩、解压\n\n<span class=\"token number\">30</span>.如何用zip命令对文件以及目录进行压缩、解压\n\n<span class=\"token number\">32</span>.打包opt整个目录，并命名test_opt.tar.gz\n\n<span class=\"token number\">33</span>.查看打包好的test_opt.tar.gz里的文件\n\n<span class=\"token number\">34</span>.将打包好的test_opt.tar.gz内容指定解压至/tmp目录\n\n<span class=\"token number\">35</span>.打包etc目录下的所有文件，不要目录只要文件\n\n<span class=\"token number\">36</span>.打包etc目录下的所有文件，排除passwd，shadow\n\n<span class=\"token number\">37</span>.打包etc目录下的所有以p开头的文件\n\n<span class=\"token number\">38</span>.打包etc目录下所有大于1M的文件<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n<h2 id=\"习题-1\"><a href=\"#习题-1\" class=\"headerlink\" title=\"习题\"></a>习题</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">2</span>.权限中的rwx-，每个字符所代表什么意思？对应的数字是什么？\n\nr\t\t可读\t\t<span class=\"token number\">4</span>\n\nw\t\t可写\t\t<span class=\"token number\">2</span>\n\nx\t\t可执行\t\t<span class=\"token number\">1</span>\n\n-\t\t没有权限\t<span class=\"token number\">0</span>\n\n\n<span class=\"token number\">3</span>.-rwxr-xr-x，写出对应数字权限\n\n\n\n<span class=\"token number\">4</span>.-rwxr--r--，写出对应数字权限\n\n\n<span class=\"token number\">5</span>.-r-xr-x--x，写出对应数字权限\n\n\n\n<span class=\"token number\">6</span>.-rw-r-xr-x，写出对应数字权限\n\n\n<span class=\"token number\">7</span>.-r--r--r--，写出对应数字权限\n\n\n\n<span class=\"token number\">8</span>.-r-xr-----，写出对应数字权限\n\n\n<span class=\"token number\">9</span>.---x-w-r--，写出对应数字权限\n\n\n<span class=\"token number\">10</span>.-rwxr--rw-，写出对应数字权限\n\n\n\n<span class=\"token number\">11</span>.-rw-r--r--，写出对应数字权限\n\n\n<span class=\"token number\">12</span>.---xr--rwx，写出对应数字权限\n\n\n<span class=\"token number\">13.777</span>，写出对应字母权限\n\n\n<span class=\"token number\">14.545</span>，写出对应字母权限\n\n\n\n\n<span class=\"token number\">15.744</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">16.600</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">17.641</span>，写出对应字母权限\n\n\n<span class=\"token number\">18.711</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">19.700</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">20.555</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">21.733</span>，写出对应字母权限\n\n\n<span class=\"token number\">22.713</span>，写出对应字母权限\n\n\n\n<span class=\"token number\">23</span>.建一个目录/test,查看这个目录的默认权限是?\n\n\n\n\n<span class=\"token number\">24</span>.进入/test目录中,建一个文件abc,查看其默认的权限为？\n\n\n\n\n<span class=\"token number\">25</span>.创建一个文件test.txt,并其将权限改为600.\n\n\n\n<span class=\"token number\">26</span>.将test.txt文件的权限改为755.\n\n\n\n<span class=\"token number\">27</span>.将test.txt文件的权限改为000.\n\n\n\n<span class=\"token number\">28</span>.修改test.txt文件的权限为644.\n\n\n\n<span class=\"token number\">29</span>.给test.txt文件的属主加上x权限。\n\n\n\n\n<span class=\"token number\">30</span>.给test.txt文件的其他用户加上x权限。\n\n\n\n<span class=\"token number\">31</span>.去除test.txt文件的所有执行权限。\n\n\n\n<span class=\"token number\">32</span>.给/test目录及目录下的所有文件或目录的权限统一改为744。\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"_content":"","source":"_posts/03_Python/02_Python进阶/01_类与对象.md","raw":"","slug":"03_Python/02_Python进阶/01_类与对象","published":1,"date":"2022-07-18T07:10:19.405Z","updated":"2022-07-18T07:10:19.405Z","title":"","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1d002xa8v7738a24xu","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"运维之基础命令--用户权限","date":"2022-07-06T03:19:52.000Z","_content":"\n# 修改用户信息(usermod)\n\n> 修改用户信息最主要的命令是usermod命令，其参数跟useradd基本一致。\n\n- 修改UID\n\n  ```bash\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2002:2002::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# usermod -u 2302 xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n  ```\n\n- 修改基本组及附加组\n\n  ```bash\n  # 基本组 : 一个用户必须拥有的哪个组\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# id xiaoyu\n  uid=2302(xiaoyu) gid=2002(xiaoyu) groups=2002(xiaoyu)\n  [root@localhost ~]# usermod -g group1 xiaoyu\n  [root@localhost ~]# id xiaoyu\n  uid=2302(xiaoyu) gid=2003(group1) groups=2003(group1)\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# \n  \n  # 附加组 ： 用户加入的其他用户组\n  [root@localhost ~]# groupadd group1\n  [root@localhost ~]# id\n  uid=0(root) gid=0(root) groups=0(root),1000(oldboy),1001(sssssssssssssssssssssss),1002(test)\n  [root@localhost ~]# usermod -G group1 root\n  [root@localhost ~]# vim /etc/group\n  [root@localhost ~]# tail -1 /etc/group\n  group1:x:2003:root\n  ```\n\n- 修改家目录\n\n  ```bash\n  [root@localhost ~]# usermod  -d /home/xiaoyu123 xiaoyu\n  \n  # 注：修改家目录仅仅修改了配置，而原来的家目录文件没有迁移\n  ```\n\n- 修改用户描述信息\n\n  ```bash\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003::/home/xiaoyu123:/bin/bash\n  [root@localhost ~]# usermod -c \"这是一个甩锅\" xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash\n  ```\n\n- 修改用户默认解析器\n\n  ```bash\n  [root@localhost ~]# usermod -s /bin/sh xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/sh\n  ```\n\n- 锁定与解锁\n\n  ```bash\n  [root@localhost home]# usermod -L xiaoyu\n  [root@localhost home]# usermod -U xiaoyu\n  ```\n\n- 修改登录名称\n\n  ```bash\n  [root@localhost home]# usermod -l dayu xiaoyu\n  [root@localhost home]# tail -1 /etc/passwd\n  dayu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash\n  ```\n\n- 追加\n\n  ```bash\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy)\n  [root@localhost home]# usermod -G root dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root)\n  [root@localhost home]# usermod -G oldboy dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy)\n  [root@localhost home]# usermod -a -G root dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root),1000(oldboy)\n  ```\n\n  \n\n# 密码（passwd）\n\n> 修改或添加Linux普通用户的密码。直接影响的文件是/etc/shadow\n\n- 增加或修改密码\n\n  当用户密码不存在的时候即为增加密码，当用户密码存在时即为修改密码。\n\n  ```bash\n  [root@localhost home]# useradd password\n  [root@localhost home]# tail -1 /etc/passwd\n  password:x:2303:2303::/home/password:/bin/bash\n  [root@localhost home]# tail -1 /etc/shadow\n  password:!!:18701:0:99999:7:::\n  [root@localhost home]# passwd password\n  Changing password for user password.\n  New password: \n  BAD PASSWORD: The password is a palindrome\n  Retype new password: \n  passwd: all authentication tokens updated successfully.\n  [root@localhost home]# tail -1 /etc/passwd\n  password:x:2303:2303::/home/password:/bin/bash\n  [root@localhost home]# tail -1 /etc/shadow\n  password:$6$.EmM.4Bl$f.LimfvMsxxFZq6yFklfyk08JKQORdQovlk2a2dtrpkP31lAMLQpezFqLheBYOTm4Sur9aAqZlC/6MN6wHFBM1:18701:0:99999:7:::\n  [root@localhost home]# \n  ```\n\n- 免交互修改密码\n\n  ```bash\n  [root@localhost home]# echo \"123\" | passwd --stdin dayu\n  Changing password for user dayu.\n  passwd: all authentication tokens updated successfully.\n  ```\n\n  \n\n\n\n# 用户组\n\n> 就类似于班级，是某个同权限用户的集合。\n\n## 创建组\n\n```bash\n[root@localhost home]# groupadd group2\n[root@localhost home]# tail -1 /etc/group\ngroup2:x:2304:\n[root@localhost home]# \n```\n\n- 指定gid\n\n```bash\n[root@localhost home]# groupadd -g 2204 group3\n[root@localhost home]# tail -1 /etc/group\ngroup3:x:2204:\n```\n\n- 创建系统组\n\n```bash\n[root@localhost home]# groupadd -r group4\n[root@localhost home]# tail -1 /etc/group\ngroup4:x:996:\n```\n\n## 修改组\n\n- 修改名称\n\n  ```bash\n  [root@localhost home]# tail -8 /etc/group\n  girl:x:2001:\n  [root@localhost home]# groupmod -n boy girl\n  [root@localhost home]# tail -8 /etc/group\n  boy:x:2001:\n  ```\n\n- 修改gid\n\n  ```bash\n  [root@localhost home]# groupmod -g 2021 boy\n  [root@localhost home]# tail -8 /etc/group\n  boy:x:2021:\n  ```\n\n## 删除组\n\n> 用户组在系统中删除，如果一个组被用户占用则不能删除。\n\n```bash\n[root@localhost home]# groupdel group4\n[root@localhost home]# tail -8 /etc/group\ndajige:x:1003:\nabc:x:2000:\nxiaoyu:x:2002:\ngroup1:x:2003:root\npassword:x:2303:\ngroup2:x:2304:\ngroup3:x:2204:\nboy:x:2021:\n[root@localhost home]# \n\n# 注：用户被删除，用户基本组也会被删除\n[root@localhost home]# useradd test-group-del\n[root@localhost home]# tail -1 /etc/passwd\ntest-group-del:x:2304:2305::/home/test-group-del:/bin/bash\n[root@localhost home]# tail -1 /etc/group\ntest-group-del:x:2305:\n[root@localhost home]# userdel -r test-group-del\n[root@localhost home]# tail -1 /etc/passwd\npassword:x:2303:2303::/home/password:/bin/bash\n[root@localhost home]# tail -1 /etc/group\nboy:x:2021:\n[root@localhost home]# \n```\n\n## 组成员管理\n\n```bash\n# 添加一个组到用户\n[root@localhost home]# useradd gtest\n[root@localhost home]# vim /etc/group\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2204(group3)\n[root@localhost home]# gpasswd -a gtest group2\nAdding user gtest to group group2\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2304(group2),2204(group3)\n\n# 添加多个组到用户\n[root@localhost home]# gpasswd -M gtest,root,dayu group\ngpasswd: group 'group' does not exist in /etc/group\n[root@localhost home]# gpasswd -M gtest,root,dayu group3\n[root@localhost home]# id root\nuid=0(root) gid=0(root) groups=0(root),2000(abc),2003(group1),2204(group3)\n[root@localhost home]# id dayu\nuid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root),1000(oldboy),2204(group3)\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2304(group2),2204(group3)\n\n# 为一个组添加组长(组长有权限向组内添加用户，其他用户[除root外]没有权限添加用户到该组)\n[root@localhost ~]# gpasswd -A dayu group3\n[root@localhost ~]# cat /etc/gshadow\ngroup3:!:dayu:gtest,dayu,oldboy\n\n# 组权限\n[root@localhost ~]# id dayu\nuid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy),2204(group3)\n[root@localhost ~]# chown .group3 /tmp/12.txt \n[root@localhost ~]# ls -l /tmp/12.txt\n-rw-r--r-- 1 root group3 4 Mar 15 11:35 /tmp/12.txt\n[root@localhost ~]# chmod g+w /tmp/12.txt\n[root@localhost ~]# ls -l /tmp/12.txt\n-rw-rw-r-- 1 root group3 4 Mar 15 11:35 /tmp/12.txt\n[root@localhost ~]# su - dayu\nLast login: Mon Mar 15 11:37:05 CST 2021 on pts/3\n[dayu@localhost ~]$ echo \"456\" > /tmp/12.txt \n[dayu@localhost ~]$ cat /tmp/12.txt\n456\n[dayu@localhost ~]$ \n```\n\n\n\n","source":"_posts/01_运维/01-基础命令/day10-Linux文件权限/笔记.md","raw":"---\ntitle: 运维之基础命令--用户权限\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 修改用户信息(usermod)\n\n> 修改用户信息最主要的命令是usermod命令，其参数跟useradd基本一致。\n\n- 修改UID\n\n  ```bash\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2002:2002::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# usermod -u 2302 xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n  ```\n\n- 修改基本组及附加组\n\n  ```bash\n  # 基本组 : 一个用户必须拥有的哪个组\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# id xiaoyu\n  uid=2302(xiaoyu) gid=2002(xiaoyu) groups=2002(xiaoyu)\n  [root@localhost ~]# usermod -g group1 xiaoyu\n  [root@localhost ~]# id xiaoyu\n  uid=2302(xiaoyu) gid=2003(group1) groups=2003(group1)\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003::/home/xiaoyu:/bin/bash\n  [root@localhost ~]# \n  \n  # 附加组 ： 用户加入的其他用户组\n  [root@localhost ~]# groupadd group1\n  [root@localhost ~]# id\n  uid=0(root) gid=0(root) groups=0(root),1000(oldboy),1001(sssssssssssssssssssssss),1002(test)\n  [root@localhost ~]# usermod -G group1 root\n  [root@localhost ~]# vim /etc/group\n  [root@localhost ~]# tail -1 /etc/group\n  group1:x:2003:root\n  ```\n\n- 修改家目录\n\n  ```bash\n  [root@localhost ~]# usermod  -d /home/xiaoyu123 xiaoyu\n  \n  # 注：修改家目录仅仅修改了配置，而原来的家目录文件没有迁移\n  ```\n\n- 修改用户描述信息\n\n  ```bash\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003::/home/xiaoyu123:/bin/bash\n  [root@localhost ~]# usermod -c \"这是一个甩锅\" xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash\n  ```\n\n- 修改用户默认解析器\n\n  ```bash\n  [root@localhost ~]# usermod -s /bin/sh xiaoyu\n  [root@localhost ~]# tail -1 /etc/passwd\n  xiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/sh\n  ```\n\n- 锁定与解锁\n\n  ```bash\n  [root@localhost home]# usermod -L xiaoyu\n  [root@localhost home]# usermod -U xiaoyu\n  ```\n\n- 修改登录名称\n\n  ```bash\n  [root@localhost home]# usermod -l dayu xiaoyu\n  [root@localhost home]# tail -1 /etc/passwd\n  dayu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash\n  ```\n\n- 追加\n\n  ```bash\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy)\n  [root@localhost home]# usermod -G root dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root)\n  [root@localhost home]# usermod -G oldboy dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy)\n  [root@localhost home]# usermod -a -G root dayu\n  [root@localhost home]# id dayu\n  uid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root),1000(oldboy)\n  ```\n\n  \n\n# 密码（passwd）\n\n> 修改或添加Linux普通用户的密码。直接影响的文件是/etc/shadow\n\n- 增加或修改密码\n\n  当用户密码不存在的时候即为增加密码，当用户密码存在时即为修改密码。\n\n  ```bash\n  [root@localhost home]# useradd password\n  [root@localhost home]# tail -1 /etc/passwd\n  password:x:2303:2303::/home/password:/bin/bash\n  [root@localhost home]# tail -1 /etc/shadow\n  password:!!:18701:0:99999:7:::\n  [root@localhost home]# passwd password\n  Changing password for user password.\n  New password: \n  BAD PASSWORD: The password is a palindrome\n  Retype new password: \n  passwd: all authentication tokens updated successfully.\n  [root@localhost home]# tail -1 /etc/passwd\n  password:x:2303:2303::/home/password:/bin/bash\n  [root@localhost home]# tail -1 /etc/shadow\n  password:$6$.EmM.4Bl$f.LimfvMsxxFZq6yFklfyk08JKQORdQovlk2a2dtrpkP31lAMLQpezFqLheBYOTm4Sur9aAqZlC/6MN6wHFBM1:18701:0:99999:7:::\n  [root@localhost home]# \n  ```\n\n- 免交互修改密码\n\n  ```bash\n  [root@localhost home]# echo \"123\" | passwd --stdin dayu\n  Changing password for user dayu.\n  passwd: all authentication tokens updated successfully.\n  ```\n\n  \n\n\n\n# 用户组\n\n> 就类似于班级，是某个同权限用户的集合。\n\n## 创建组\n\n```bash\n[root@localhost home]# groupadd group2\n[root@localhost home]# tail -1 /etc/group\ngroup2:x:2304:\n[root@localhost home]# \n```\n\n- 指定gid\n\n```bash\n[root@localhost home]# groupadd -g 2204 group3\n[root@localhost home]# tail -1 /etc/group\ngroup3:x:2204:\n```\n\n- 创建系统组\n\n```bash\n[root@localhost home]# groupadd -r group4\n[root@localhost home]# tail -1 /etc/group\ngroup4:x:996:\n```\n\n## 修改组\n\n- 修改名称\n\n  ```bash\n  [root@localhost home]# tail -8 /etc/group\n  girl:x:2001:\n  [root@localhost home]# groupmod -n boy girl\n  [root@localhost home]# tail -8 /etc/group\n  boy:x:2001:\n  ```\n\n- 修改gid\n\n  ```bash\n  [root@localhost home]# groupmod -g 2021 boy\n  [root@localhost home]# tail -8 /etc/group\n  boy:x:2021:\n  ```\n\n## 删除组\n\n> 用户组在系统中删除，如果一个组被用户占用则不能删除。\n\n```bash\n[root@localhost home]# groupdel group4\n[root@localhost home]# tail -8 /etc/group\ndajige:x:1003:\nabc:x:2000:\nxiaoyu:x:2002:\ngroup1:x:2003:root\npassword:x:2303:\ngroup2:x:2304:\ngroup3:x:2204:\nboy:x:2021:\n[root@localhost home]# \n\n# 注：用户被删除，用户基本组也会被删除\n[root@localhost home]# useradd test-group-del\n[root@localhost home]# tail -1 /etc/passwd\ntest-group-del:x:2304:2305::/home/test-group-del:/bin/bash\n[root@localhost home]# tail -1 /etc/group\ntest-group-del:x:2305:\n[root@localhost home]# userdel -r test-group-del\n[root@localhost home]# tail -1 /etc/passwd\npassword:x:2303:2303::/home/password:/bin/bash\n[root@localhost home]# tail -1 /etc/group\nboy:x:2021:\n[root@localhost home]# \n```\n\n## 组成员管理\n\n```bash\n# 添加一个组到用户\n[root@localhost home]# useradd gtest\n[root@localhost home]# vim /etc/group\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2204(group3)\n[root@localhost home]# gpasswd -a gtest group2\nAdding user gtest to group group2\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2304(group2),2204(group3)\n\n# 添加多个组到用户\n[root@localhost home]# gpasswd -M gtest,root,dayu group\ngpasswd: group 'group' does not exist in /etc/group\n[root@localhost home]# gpasswd -M gtest,root,dayu group3\n[root@localhost home]# id root\nuid=0(root) gid=0(root) groups=0(root),2000(abc),2003(group1),2204(group3)\n[root@localhost home]# id dayu\nuid=2302(dayu) gid=2003(group1) groups=2003(group1),0(root),1000(oldboy),2204(group3)\n[root@localhost home]# id gtest\nuid=2304(gtest) gid=2305(gtest) groups=2305(gtest),2304(group2),2204(group3)\n\n# 为一个组添加组长(组长有权限向组内添加用户，其他用户[除root外]没有权限添加用户到该组)\n[root@localhost ~]# gpasswd -A dayu group3\n[root@localhost ~]# cat /etc/gshadow\ngroup3:!:dayu:gtest,dayu,oldboy\n\n# 组权限\n[root@localhost ~]# id dayu\nuid=2302(dayu) gid=2003(group1) groups=2003(group1),1000(oldboy),2204(group3)\n[root@localhost ~]# chown .group3 /tmp/12.txt \n[root@localhost ~]# ls -l /tmp/12.txt\n-rw-r--r-- 1 root group3 4 Mar 15 11:35 /tmp/12.txt\n[root@localhost ~]# chmod g+w /tmp/12.txt\n[root@localhost ~]# ls -l /tmp/12.txt\n-rw-rw-r-- 1 root group3 4 Mar 15 11:35 /tmp/12.txt\n[root@localhost ~]# su - dayu\nLast login: Mon Mar 15 11:37:05 CST 2021 on pts/3\n[dayu@localhost ~]$ echo \"456\" > /tmp/12.txt \n[dayu@localhost ~]$ cat /tmp/12.txt\n456\n[dayu@localhost ~]$ \n```\n\n\n\n","slug":"01_运维/01-基础命令/day10-Linux文件权限/笔记","published":1,"updated":"2022-07-06T07:13:19.071Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1d002za8v71r3y3a58","content":"<h1 id=\"修改用户信息-usermod\"><a href=\"#修改用户信息-usermod\" class=\"headerlink\" title=\"修改用户信息(usermod)\"></a>修改用户信息(usermod)</h1><blockquote>\n<p>修改用户信息最主要的命令是usermod命令，其参数跟useradd基本一致。</p>\n</blockquote>\n<ul>\n<li><p>修改UID</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2002:2002::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -u 2302 xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改基本组及附加组</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 基本组 : 一个用户必须拥有的哪个组</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id xiaoyu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2002</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2002</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -g group1 xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id xiaoyu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 附加组 ： 用户加入的其他用户组</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd group1</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,1001<span class=\"token punctuation\">(</span>sssssssssssssssssssssss<span class=\"token punctuation\">)</span>,1002<span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G group1 root</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/group</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup1:x:2003:root<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改家目录</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod  -d /home/xiaoyu123 xiaoyu</span>\n\n<span class=\"token comment\"># 注：修改家目录仅仅修改了配置，而原来的家目录文件没有迁移</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改用户描述信息</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003::/home/xiaoyu123:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -c \"这是一个甩锅\" xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改用户默认解析器</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -s /bin/sh xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>锁定与解锁</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -L xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -U xiaoyu</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改登录名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -l dayu xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\ndayu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>追加</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G root dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G oldboy dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -a -G root dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"密码（passwd）\"><a href=\"#密码（passwd）\" class=\"headerlink\" title=\"密码（passwd）\"></a>密码（passwd）</h1><blockquote>\n<p>修改或添加Linux普通用户的密码。直接影响的文件是&#x2F;etc&#x2F;shadow</p>\n</blockquote>\n<ul>\n<li><p>增加或修改密码</p>\n<p>当用户密码不存在的时候即为增加密码，当用户密码存在时即为修改密码。</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd password</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/shadow</span>\npassword:<span class=\"token operator\">!</span><span class=\"token operator\">!</span>:18701:0:99999:7:::\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># passwd password</span>\nChanging password <span class=\"token keyword\">for</span> user password.\nNew password: \nBAD PASSWORD: The password is a palindrome\nRetype new password: \npasswd: all authentication tokens updated successfully.\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/shadow</span>\npassword:<span class=\"token variable\">$6</span>$.EmM.4Bl<span class=\"token variable\">$f</span>.LimfvMsxxFZq6yFklfyk08JKQORdQovlk2a2dtrpkP31lAMLQpezFqLheBYOTm4Sur9aAqZlC/6MN6wHFBM1:18701:0:99999:7:::\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>免交互修改密码</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"123\" | passwd --stdin dayu</span>\nChanging password <span class=\"token keyword\">for</span> user dayu.\npasswd: all authentication tokens updated successfully.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"用户组\"><a href=\"#用户组\" class=\"headerlink\" title=\"用户组\"></a>用户组</h1><blockquote>\n<p>就类似于班级，是某个同权限用户的集合。</p>\n</blockquote>\n<h2 id=\"创建组\"><a href=\"#创建组\" class=\"headerlink\" title=\"创建组\"></a>创建组</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd group2</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup2:x:2304:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>指定gid</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 2204 group3</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup3:x:2204:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>创建系统组</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -r group4</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup4:x:996:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"修改组\"><a href=\"#修改组\" class=\"headerlink\" title=\"修改组\"></a>修改组</h2><ul>\n<li><p>修改名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\ngirl:x:2001:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupmod -n boy girl</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\nboy:x:2001:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改gid</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupmod -g 2021 boy</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\nboy:x:2021:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"删除组\"><a href=\"#删除组\" class=\"headerlink\" title=\"删除组\"></a>删除组</h2><blockquote>\n<p>用户组在系统中删除，如果一个组被用户占用则不能删除。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupdel group4</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\ndajige:x:1003:\nabc:x:2000:\nxiaoyu:x:2002:\ngroup1:x:2003:root\npassword:x:2303:\ngroup2:x:2304:\ngroup3:x:2204:\nboy:x:2021:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 注：用户被删除，用户基本组也会被删除</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd test-group-del</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\ntest-group-del:x:2304:2305::/home/test-group-del:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ntest-group-del:x:2305:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># userdel -r test-group-del</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\nboy:x:2021:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"组成员管理\"><a href=\"#组成员管理\" class=\"headerlink\" title=\"组成员管理\"></a>组成员管理</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 添加一个组到用户</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd gtest</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/group</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -a gtest group2</span>\nAdding user gtest to group group2\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2304<span class=\"token punctuation\">(</span>group2<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 添加多个组到用户</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -M gtest,root,dayu group</span>\ngpasswd: group <span class=\"token string\">'group'</span> does not exist <span class=\"token keyword\">in</span> /etc/group\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -M gtest,root,dayu group3</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id root</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,2000<span class=\"token punctuation\">(</span>abc<span class=\"token punctuation\">)</span>,2003<span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2304<span class=\"token punctuation\">(</span>group2<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 为一个组添加组长(组长有权限向组内添加用户，其他用户[除root外]没有权限添加用户到该组)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -A dayu group3</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/gshadow</span>\ngroup3:<span class=\"token operator\">!</span>:dayu:gtest,dayu,oldboy\n\n<span class=\"token comment\"># 组权限</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown .group3 /tmp/12.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l /tmp/12.txt</span>\n-rw-r--r-- <span class=\"token number\">1</span> root group3 <span class=\"token number\">4</span> Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:35 /tmp/12.txt\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod g+w /tmp/12.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l /tmp/12.txt</span>\n-rw-rw-r-- <span class=\"token number\">1</span> root group3 <span class=\"token number\">4</span> Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:35 /tmp/12.txt\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># su - dayu</span>\nLast login: Mon Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:37:05 CST <span class=\"token number\">2021</span> on pts/3\n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"456\"</span> <span class=\"token operator\">></span> /tmp/12.txt \n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> /tmp/12.txt\n<span class=\"token number\">456</span>\n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"修改用户信息-usermod\"><a href=\"#修改用户信息-usermod\" class=\"headerlink\" title=\"修改用户信息(usermod)\"></a>修改用户信息(usermod)</h1><blockquote>\n<p>修改用户信息最主要的命令是usermod命令，其参数跟useradd基本一致。</p>\n</blockquote>\n<ul>\n<li><p>修改UID</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2002:2002::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -u 2302 xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改基本组及附加组</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 基本组 : 一个用户必须拥有的哪个组</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2002::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id xiaoyu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2002</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2002</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -g group1 xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id xiaoyu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>xiaoyu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003::/home/xiaoyu:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 附加组 ： 用户加入的其他用户组</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd group1</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,1001<span class=\"token punctuation\">(</span>sssssssssssssssssssssss<span class=\"token punctuation\">)</span>,1002<span class=\"token punctuation\">(</span>test<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G group1 root</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/group</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup1:x:2003:root<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改家目录</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod  -d /home/xiaoyu123 xiaoyu</span>\n\n<span class=\"token comment\"># 注：修改家目录仅仅修改了配置，而原来的家目录文件没有迁移</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改用户描述信息</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003::/home/xiaoyu123:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -c \"这是一个甩锅\" xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改用户默认解析器</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -s /bin/sh xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\nxiaoyu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/sh<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>锁定与解锁</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -L xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -U xiaoyu</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改登录名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -l dayu xiaoyu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\ndayu:x:2302:2003:这是一个甩锅:/home/xiaoyu123:/bin/bash<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>追加</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G root dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -G oldboy dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># usermod -a -G root dayu</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"密码（passwd）\"><a href=\"#密码（passwd）\" class=\"headerlink\" title=\"密码（passwd）\"></a>密码（passwd）</h1><blockquote>\n<p>修改或添加Linux普通用户的密码。直接影响的文件是&#x2F;etc&#x2F;shadow</p>\n</blockquote>\n<ul>\n<li><p>增加或修改密码</p>\n<p>当用户密码不存在的时候即为增加密码，当用户密码存在时即为修改密码。</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd password</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/shadow</span>\npassword:<span class=\"token operator\">!</span><span class=\"token operator\">!</span>:18701:0:99999:7:::\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># passwd password</span>\nChanging password <span class=\"token keyword\">for</span> user password.\nNew password: \nBAD PASSWORD: The password is a palindrome\nRetype new password: \npasswd: all authentication tokens updated successfully.\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/shadow</span>\npassword:<span class=\"token variable\">$6</span>$.EmM.4Bl<span class=\"token variable\">$f</span>.LimfvMsxxFZq6yFklfyk08JKQORdQovlk2a2dtrpkP31lAMLQpezFqLheBYOTm4Sur9aAqZlC/6MN6wHFBM1:18701:0:99999:7:::\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>免交互修改密码</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"123\" | passwd --stdin dayu</span>\nChanging password <span class=\"token keyword\">for</span> user dayu.\npasswd: all authentication tokens updated successfully.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"用户组\"><a href=\"#用户组\" class=\"headerlink\" title=\"用户组\"></a>用户组</h1><blockquote>\n<p>就类似于班级，是某个同权限用户的集合。</p>\n</blockquote>\n<h2 id=\"创建组\"><a href=\"#创建组\" class=\"headerlink\" title=\"创建组\"></a>创建组</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd group2</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup2:x:2304:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>指定gid</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 2204 group3</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup3:x:2204:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<ul>\n<li>创建系统组</li>\n</ul>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -r group4</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ngroup4:x:996:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"修改组\"><a href=\"#修改组\" class=\"headerlink\" title=\"修改组\"></a>修改组</h2><ul>\n<li><p>修改名称</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\ngirl:x:2001:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupmod -n boy girl</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\nboy:x:2001:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>修改gid</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupmod -g 2021 boy</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\nboy:x:2021:<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"删除组\"><a href=\"#删除组\" class=\"headerlink\" title=\"删除组\"></a>删除组</h2><blockquote>\n<p>用户组在系统中删除，如果一个组被用户占用则不能删除。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupdel group4</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -8 /etc/group</span>\ndajige:x:1003:\nabc:x:2000:\nxiaoyu:x:2002:\ngroup1:x:2003:root\npassword:x:2303:\ngroup2:x:2304:\ngroup3:x:2204:\nboy:x:2021:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 注：用户被删除，用户基本组也会被删除</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd test-group-del</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\ntest-group-del:x:2304:2305::/home/test-group-del:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\ntest-group-del:x:2305:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># userdel -r test-group-del</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/passwd</span>\npassword:x:2303:2303::/home/password:/bin/bash\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -1 /etc/group</span>\nboy:x:2021:\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"组成员管理\"><a href=\"#组成员管理\" class=\"headerlink\" title=\"组成员管理\"></a>组成员管理</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 添加一个组到用户</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd gtest</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/group</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -a gtest group2</span>\nAdding user gtest to group group2\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2304<span class=\"token punctuation\">(</span>group2<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 添加多个组到用户</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -M gtest,root,dayu group</span>\ngpasswd: group <span class=\"token string\">'group'</span> does not exist <span class=\"token keyword\">in</span> /etc/group\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -M gtest,root,dayu group3</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id root</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,2000<span class=\"token punctuation\">(</span>abc<span class=\"token punctuation\">)</span>,2003<span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,0<span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost home<span class=\"token punctuation\">]</span><span class=\"token comment\"># id gtest</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2304</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2305</span><span class=\"token punctuation\">(</span>gtest<span class=\"token punctuation\">)</span>,2304<span class=\"token punctuation\">(</span>group2<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 为一个组添加组长(组长有权限向组内添加用户，其他用户[除root外]没有权限添加用户到该组)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># gpasswd -A dayu group3</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/gshadow</span>\ngroup3:<span class=\"token operator\">!</span>:dayu:gtest,dayu,oldboy\n\n<span class=\"token comment\"># 组权限</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># id dayu</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">2302</span><span class=\"token punctuation\">(</span>dayu<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">2003</span><span class=\"token punctuation\">(</span>group1<span class=\"token punctuation\">)</span>,1000<span class=\"token punctuation\">(</span>oldboy<span class=\"token punctuation\">)</span>,2204<span class=\"token punctuation\">(</span>group3<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown .group3 /tmp/12.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l /tmp/12.txt</span>\n-rw-r--r-- <span class=\"token number\">1</span> root group3 <span class=\"token number\">4</span> Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:35 /tmp/12.txt\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod g+w /tmp/12.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l /tmp/12.txt</span>\n-rw-rw-r-- <span class=\"token number\">1</span> root group3 <span class=\"token number\">4</span> Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:35 /tmp/12.txt\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># su - dayu</span>\nLast login: Mon Mar <span class=\"token number\">15</span> <span class=\"token number\">11</span>:37:05 CST <span class=\"token number\">2021</span> on pts/3\n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"456\"</span> <span class=\"token operator\">></span> /tmp/12.txt \n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> /tmp/12.txt\n<span class=\"token number\">456</span>\n<span class=\"token punctuation\">[</span>dayu@localhost ~<span class=\"token punctuation\">]</span>$ <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n"},{"title":"运维之基础命令--用户组管理","date":"2022-07-06T03:19:52.000Z","_content":"\n# 用户管理\n\n## linux中用户介绍\n\n什么是用户？\n\n```bash\n用户其实就是相当于权限的化身，\n处于安全考虑\n所以，我们在进入系统之前都需要登录，根据用户给相应权限\n```\n\nLinux系统中用户角色\n\n```bash\nuid : Linux系统当中用户ID（相当于身份证号）\ngid : ANTA20163307\n\n用户组其实是统一某一类用户权限\n\n需求：\n\t大项目 ： \n\t\t开发者：a b c d\n\t\t运维 ： e f\n\t\t测试：g\n\t共同的权限：\n```\n\n超级用户\n\n```bash\nlinux当中的老大（皇帝）: root\nWindows当中的老大：administrator\n```\n\n## 用户与组相关的文件\n\n```bash\n[root@localhost ~]# cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\n用户名称   是否存在密码   uid  gid  组名称/注释信息 家目录  默认解析器 \n```\n\n","source":"_posts/01_运维/01-基础命令/day09-用户组管理/笔记.md","raw":"---\ntitle: 运维之基础命令--用户组管理\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 用户管理\n\n## linux中用户介绍\n\n什么是用户？\n\n```bash\n用户其实就是相当于权限的化身，\n处于安全考虑\n所以，我们在进入系统之前都需要登录，根据用户给相应权限\n```\n\nLinux系统中用户角色\n\n```bash\nuid : Linux系统当中用户ID（相当于身份证号）\ngid : ANTA20163307\n\n用户组其实是统一某一类用户权限\n\n需求：\n\t大项目 ： \n\t\t开发者：a b c d\n\t\t运维 ： e f\n\t\t测试：g\n\t共同的权限：\n```\n\n超级用户\n\n```bash\nlinux当中的老大（皇帝）: root\nWindows当中的老大：administrator\n```\n\n## 用户与组相关的文件\n\n```bash\n[root@localhost ~]# cat /etc/passwd\nroot:x:0:0:root:/root:/bin/bash\n用户名称   是否存在密码   uid  gid  组名称/注释信息 家目录  默认解析器 \n```\n\n","slug":"01_运维/01-基础命令/day09-用户组管理/笔记","published":1,"updated":"2022-07-06T07:13:11.710Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1e0032a8v7hjyyc2kz","content":"<h1 id=\"用户管理\"><a href=\"#用户管理\" class=\"headerlink\" title=\"用户管理\"></a>用户管理</h1><h2 id=\"linux中用户介绍\"><a href=\"#linux中用户介绍\" class=\"headerlink\" title=\"linux中用户介绍\"></a>linux中用户介绍</h2><p>什么是用户？</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">用户其实就是相当于权限的化身，\n处于安全考虑\n所以，我们在进入系统之前都需要登录，根据用户给相应权限<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>Linux系统中用户角色</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">uid <span class=\"token builtin class-name\">:</span> Linux系统当中用户ID（相当于身份证号）\ngid <span class=\"token builtin class-name\">:</span> ANTA20163307\n\n用户组其实是统一某一类用户权限\n\n需求：\n\t大项目 ： \n\t\t开发者：a b c d\n\t\t运维 ： e f\n\t\t测试：g\n\t共同的权限：<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>超级用户</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">linux当中的老大（皇帝）: root\nWindows当中的老大：administrator<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"用户与组相关的文件\"><a href=\"#用户与组相关的文件\" class=\"headerlink\" title=\"用户与组相关的文件\"></a>用户与组相关的文件</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/passwd</span>\nroot:x:0:0:root:/root:/bin/bash\n用户名称   是否存在密码   uid  gid  组名称/注释信息 家目录  默认解析器 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"用户管理\"><a href=\"#用户管理\" class=\"headerlink\" title=\"用户管理\"></a>用户管理</h1><h2 id=\"linux中用户介绍\"><a href=\"#linux中用户介绍\" class=\"headerlink\" title=\"linux中用户介绍\"></a>linux中用户介绍</h2><p>什么是用户？</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">用户其实就是相当于权限的化身，\n处于安全考虑\n所以，我们在进入系统之前都需要登录，根据用户给相应权限<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>Linux系统中用户角色</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">uid <span class=\"token builtin class-name\">:</span> Linux系统当中用户ID（相当于身份证号）\ngid <span class=\"token builtin class-name\">:</span> ANTA20163307\n\n用户组其实是统一某一类用户权限\n\n需求：\n\t大项目 ： \n\t\t开发者：a b c d\n\t\t运维 ： e f\n\t\t测试：g\n\t共同的权限：<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>超级用户</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">linux当中的老大（皇帝）: root\nWindows当中的老大：administrator<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h2 id=\"用户与组相关的文件\"><a href=\"#用户与组相关的文件\" class=\"headerlink\" title=\"用户与组相关的文件\"></a>用户与组相关的文件</h2><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/passwd</span>\nroot:x:0:0:root:/root:/bin/bash\n用户名称   是否存在密码   uid  gid  组名称/注释信息 家目录  默认解析器 <span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--软件包管理","date":"2022-07-06T03:19:52.000Z","_content":"\n# 软件包\n\n- rpm包来源\n\n  ```bash\n  1、来源网络下载\n  2、来源本地：自己的镜像自带的rpm包\n  ```\n\n  \n\n\n\n- rpm命令\n\n  ```bash\n  # 安装\n  \n  rpm -ivh xxx.rpm\n  \n  # http://nginx.org/packages/centos/7/x86_64/RPMS/\n  \n  -v : 显示安装过程\n  -i ：显示安装包的详细信息\n  -h : 安装包哈希标记\n  \n  # 下载Nginx rpm安装包的全名\n  [root@localhost ~]# wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\n  --2021-03-17 12:16:47--  http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\n  Resolving nginx.org (nginx.org)... 52.58.199.22, 3.125.197.172, 2a05:d014:edb:5702::6, ...\n  Connecting to nginx.org (nginx.org)|52.58.199.22|:80... connected.\n  HTTP request sent, awaiting response... 200 OK\n  Length: 790284 (772K) [application/x-redhat-package-manager]\n  Saving to: ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’\n  \n  100%[====================================================>] 790,284      339KB/s   in 2.3s   \n  \n  2021-03-17 12:16:51 (339 KB/s) - ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’ saved [790284/790284]\n  \n  # 安装rpm安装包\n  [root@localhost ~]# rpm -ivh nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Preparing...                          ################################# [100%]\n  Updating / installing...\n     1:nginx-1:1.18.0-1.el7.ngx         ################################# [100%]\n  ----------------------------------------------------------------------\n  \n  Thanks for using nginx!\n  \n  Please find the official documentation for nginx here:\n  * http://nginx.org/en/docs/\n  \n  Please subscribe to nginx-announce mailing list to get\n  the most important news about nginx:\n  * http://nginx.org/en/support.html\n  \n  Commercial subscriptions for nginx are available on:\n  * http://nginx.com/products/\n  \n  ----------------------------------------------------------------------\n  \n  # 验证nginx是否安装成功\n  [root@localhost ~]# nginx -v\n  nginx version: nginx/1.18.0\n  \n  \n  # 卸载\n  [root@localhost ~]# rpm -e nginx (软件包名称)\n  [root@localhost ~]# nginx -v\n  -bash: /usr/sbin/nginx: No such file or directory\n  [root@localhost ~]# \n  \n  \n  # 查看系统当中安装了哪些rpm软件包\n  rpm -qa\n  \n  # 查看系统当中是否安装了某个rpm软件包\n  [root@localhost ~]# rpm -q nginx（软件包名）\n  nginx-1.18.0-1.el7.ngx.x86_64\n  [root@localhost ~]# rpm -q safsdgsfdgfd\n  package safsdgsfdgfd is not installed\n  \n  \n  # 显示已经安装过的rpm包详细信息。\n  [root@localhost ~]# rpm -qi nginx\n  Name        : nginx\n  Epoch       : 1\n  Version     : 1.18.0\n  Release     : 1.el7.ngx\n  Architecture: x86_64\n  Install Date: Wed 17 Mar 2021 04:18:55 PM CST\n  Group       : System Environment/Daemons\n  Size        : 2830028\n  License     : 2-clause BSD-like license\n  Signature   : RSA/SHA1, Tue 21 Apr 2020 11:19:18 PM CST, Key ID abf5bd827bd9bf62\n  Source RPM  : nginx-1.18.0-1.el7.ngx.src.rpm\n  Build Date  : Tue 21 Apr 2020 11:07:33 PM CST\n  Build Host  : ip-10-1-17-101.eu-central-1.compute.internal\n  Relocations : (not relocatable)\n  Vendor      : Nginx, Inc.\n  URL         : http://nginx.org/\n  Summary     : High performance web server\n  Description :\n  nginx [engine x] is an HTTP and reverse proxy server, as well as\n  a mail proxy server.\n  \n  # 查看安装包的内容\n  [root@localhost nginx]# rpm -ql nginx\n  /etc/logrotate.d/nginx\n  /etc/nginx\n  /etc/nginx/conf.d\n  /etc/nginx/conf.d/default.conf\n  /etc/nginx/fastcgi_params\n  /etc/nginx/koi-utf\n  /etc/nginx/koi-win\n  /etc/nginx/mime.types\n  /etc/nginx/modules\n  /etc/nginx/nginx.conf\n  /etc/nginx/scgi_params\n  /etc/nginx/uwsgi_params\n  /etc/nginx/win-utf\n  /etc/sysconfig/nginx\n  /etc/sysconfig/nginx-debug\n  /usr/lib/systemd/system/nginx-debug.service\n  /usr/lib/systemd/system/nginx.service\n  /usr/lib64/nginx\n  /usr/lib64/nginx/modules\n  /usr/libexec/initscripts/legacy-actions/nginx\n  /usr/libexec/initscripts/legacy-actions/nginx/check-reload\n  /usr/libexec/initscripts/legacy-actions/nginx/upgrade\n  /usr/sbin/nginx\n  /usr/sbin/nginx-debug\n  /usr/share/doc/nginx-1.18.0\n  /usr/share/doc/nginx-1.18.0/COPYRIGHT\n  /usr/share/man/man8/nginx.8.gz\n  /usr/share/nginx\n  /usr/share/nginx/html\n  /usr/share/nginx/html/50x.html\n  /usr/share/nginx/html/index.html\n  /var/cache/nginx\n  /var/log/nginx\n  \n  # 查看配置信息\n  [root@localhost nginx]# rpm -qc nginx\n  /etc/logrotate.d/nginx\n  /etc/nginx/conf.d/default.conf\n  /etc/nginx/fastcgi_params\n  /etc/nginx/koi-utf\n  /etc/nginx/koi-win\n  /etc/nginx/mime.types\n  /etc/nginx/nginx.conf\n  /etc/nginx/scgi_params\n  /etc/nginx/uwsgi_params\n  /etc/nginx/win-utf\n  /etc/sysconfig/nginx\n  /etc/sysconfig/nginx-debug\n  \n  # 查看文件帮助信息\n  [root@localhost nginx]# rpm -qd zlib\n  /usr/share/doc/zlib-1.2.7/ChangeLog\n  /usr/share/doc/zlib-1.2.7/FAQ\n  /usr/share/doc/zlib-1.2.7/README\n  \n  # \n  [root@localhost ~]# rpm -qf /usr/sbin/nginx\n  nginx-1.18.0-1.el7.ngx.x86_64\n  \n  # 用 -p 可以查看未安装软件包的详细信息\n  [root@localhost ~]# rpm -qip nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Name        : nginx\n  Epoch       : 1\n  Version     : 1.18.0\n  Release     : 1.el7.ngx\n  Architecture: x86_64\n  Install Date: (not installed)\n  Group       : System Environment/Daemons\n  Size        : 2830028\n  License     : 2-clause BSD-like license\n  Signature   : RSA/SHA1, Tue 21 Apr 2020 11:19:18 PM CST, Key ID abf5bd827bd9bf62\n  Source RPM  : nginx-1.18.0-1.el7.ngx.src.rpm\n  Build Date  : Tue 21 Apr 2020 11:07:33 PM CST\n  Build Host  : ip-10-1-17-101.eu-central-1.compute.internal\n  Relocations : (not relocatable)\n  Vendor      : Nginx, Inc.\n  URL         : http://nginx.org/\n  Summary     : High performance web server\n  Description :\n  nginx [engine x] is an HTTP and reverse proxy server, as well as\n  a mail proxy server.\n  \n  # 升级软件包\n  [root@localhost ~]# rpm -Uvh nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Preparing...                          ################################# [100%]\n  Updating / installing...\n     1:nginx-1:1.18.0-1.el7.ngx         ################################# [ 50%]\n  Cleaning up / removing...\n     2:nginx-1:1.14.0-1.el7_4.ngx       ################################# [100%]\n  [root@localhost ~]# nginx -v\n  nginx version: nginx/1.18.0\n  \n  \n  # 强制删除软件包--nodeps\n  [root@localhost ~]# rpm -e zlib --nodeps\n  \n  ```\n\n## yum\n\n> yum是CentOS的软件包管理工具，自动为我们解决软件依赖问题。yum包管理工具必须使用yum源指定软件下载地址去下载需要安装的软件包。配置的路径是：/etc/yum.repos.d\n\n```bash\n# 清空本机所有的yum源\n[root@www yum.repos.d]# rm -rf /etc/yum.repos.d/*\n```\n\n\n\n- yum源命令\n\n  ```bash\n  # 查看当前系统的yum源列表\n  [root@www yum.repos.d]# yum repolist \n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                   repo name                                           status\n  base                      \"This is local repo, and 非常屌\"                    10,072\n  repolist: 10,072\n  \n  # yum清空缓存\n  [root@www yum.repos.d]# yum clean all\n  Loaded plugins: fastestmirror\n  Cleaning repos: base\n  Cleaning up list of fastest mirrors\n  Other repos take up 76 M of disk space (use --verbose for details)\n  \n  # 建立yum缓存\n  [root@www yum.repos.d]# yum makecache\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  \n  ```\n\n- yum源的执行原理\n\n  ```bash\n  1、需要在/etc/yum.repos.d目录下配置yum源地址\n  2、清空缓存建立新的缓存\n  3、安装软件（自动解决依赖关系）\n  ```\n\n- yum常用的基础命令\n\n  ```bash\n  # 安装软件包的命令\n  yum install 软件包名称\n  \t-y : 免交互安装\n  \n  # 卸载软件（直接将软件的依赖包一起删除）\n  yum remove 软件包名称\n  [root@www yum.repos.d]# yum remove httpd\n  \t-y : 免交互移除\n  \n  # 查看当前系统需要更新软件\n  yum check-update\n  \n  # 更新所有的需要更新的软件\n  yum update \n  \t-y ： 免交互\n  \n  # 更新某一个软件\n  yum update (软件包名称)\n  \n  # 重装软件\n  yum reinstall (软件包名称)\n  \n  # 搜索软件包\n  [root@www httpd]# yum search （软件包名称）\n  -------------------------------------------------------\n  \n  # 查看yum执行历史\n  yum history\n  [root@www httpd]# yum history info (历史ID号)\n  [root@www httpd]# yum history undo (历史ID号)\n  # 查看当前系统当中可更新的软件包\n  [root@www yum.repos.d]# yum check-update \n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  \n  postfix.x86_64                                        2:2.10.1-9.0.1.el7.centos.plus                                      centosplus\n  python-perf.x86_64                                    3.10.0-1160.15.2.el7.centos.plus                                    centosplus\n  [root@www yum.repos.d]# \n  \n  # 查看系统中有哪些仓库地址\n  yum repolist    # 正在启用的yum仓库\n  [root@www yum.repos.d]# yum repolist\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                   repo name                                           status\n  base/7/x86_64             CentOS-7 - Base - repo.huaweicloud.com              10,072\n  extras/7/x86_64           CentOS-7 - Extras - repo.huaweicloud.com               453\n  updates/7/x86_64          CentOS-7 - Updates - repo.huaweicloud.com            1,729\n  \n  yum repolist all # 查看系统中所有的yum仓库\n  [root@www yum.repos.d]# yum repolist all\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                                        repo name                                                             status\n  base/7/x86_64                                  CentOS-7 - Base - repo.huaweicloud.com                                enabled: 10,072\n  centosplus/7/x86_64                            CentOS-7 - Plus - repo.huaweicloud.com                                disabled\n  extras/7/x86_64                                CentOS-7 - Extras - repo.huaweicloud.com                              enabled:    453\n  updates/7/x86_64                               CentOS-7 - Updates - repo.huaweicloud.com                             enabled:  1,72\n  \n  \n  # 启用repo仓库\n  yum install yum-utils -y\n  \n  启用一个yum仓库：yum-config-manager --enable (仓库名称)\n  关闭一个yum仓库：yum-config-manager --disable (仓库名称)\n  \n  \n  # 查看一个仓库中的软件包列表\n  [root@www yum.repos.d]# yum list\n  \n  # 查看软件包组\n  [root@www yum.repos.d]# yum grouplist\n  \n  # 安装软件包组\n  [root@www yum.repos.d]# yum groupinstall \"Development Tools\"\n  \n  \n  ```\n\n- 本地yum源配置\n\n  ```bash\n  1、备份/etc/yum.repos.d/下的所文件\n  \trm -rf /etc/yum.repos.d/*\n  \n  2、编写本地yum源\n  [root@www yum.repos.d]# cat test.repo \n  [base] # yum源名称\n  name=\"This is repo infomation\" #yum源的简介\n  baseurl=file:///opt    # 指定yum源地址\n  enabled=1\t\t\t\t# 是否启用yum源\n  gpgcheck=0\t\t\t\t# 是否检查gpg秘钥\n  \n  3、更新缓存\n  yum makecache\n  \n  4、安装软件\n  yum install dos2unix\n  ```\n\n- 共享yum源配置\n\n  ```bash\n  1、安装ftp\n  yum install vsftpd -y\n  \n  2、启动vsftpd\n  systemctl enable --now vsftpd # 设置开机自启动并且立即启动\n  \n  3、创建yum源共享文件夹\n  [root@www ftp]# mkdir /var/ftp/centos\n  \n  4、将映像中的软件复制到/var/ftp/centos\n  cp -rp /opt/* /var/ftp/centos\n  \n  5、编辑本地yum源，接入ftp\n  [root@localhost yum.repos.d]# cat local.repo \n  [base]\n  baseurl=ftp://192.168.15.100/centos\n  name=\"This is ftp repo\"\n  enabled=1\n  gpgcheck=0\n  \n  6、测试安装\n  yum install dos2unix -y\n  ```\n\n- yum的配置\n\n  ```bash\n  # yum仓库的机器上执行\n  1、修改/etc/yum.conf\n      cachedir=/var/ftp/centos/Packages   # 指定yum缓存目录\n      keepcache=1\t\t\t\t\t\t\t# 下载的缓存软件不立即删除， 0为立即删除\n  \n  2、安装ftp\n  yum install vsftpd -y\n  \n  3、启动vsftpd\n  systemctl enable --now vsftpd # 设置开机自启动并且立即启动\n  \n  4、创建yum源共享文件夹\n  [root@www ftp]# mkdir /var/ftp/centos\n  \n  5、更新yum仓库\n  [root@www ftp]# yum clean all\n  [root@www ftp]# yum makecache\n  \n  6、建立一个快捷方式\n  cd /var/ftp/centos/Packages/base\n  ln -s packages Packages\n  \n  7、安装mariadb\n  yum install mariadb -y\n  \n  8、建立/var/ftp/centos/Packages/base/repodata\n  mkdir /var/ftp/centos/Packages/base/repodata\n  \n  9、把/var/ftp/centos/Packages/base下面的自动生成的压缩文件复制到/var/ftp/centos/Packages/base/repodata用做认证。\n  \n  # 使用yum仓库的机器上执行\n  1、建立yum配置文件\n  [root@localhost ~]# cat /etc/yum.repos.d/local.repo \n  [base]\n  baseurl=ftp://192.168.15.100/centos/Packages/base\n  name=\"This is ftp repo\"\n  enabled=1\n  gpgcheck=0\n  \n  2、更新yum仓库\n  [root@www ftp]# yum clean all\n  [root@www ftp]# yum makecache\n  \n  3、测试安装mariadb\n  yum install mariadb -y\n  ```\n\n  \n\n","source":"_posts/01_运维/01-基础命令/day12-软件包管理/软件包.md","raw":"---\ntitle: 运维之基础命令--软件包管理\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 软件包\n\n- rpm包来源\n\n  ```bash\n  1、来源网络下载\n  2、来源本地：自己的镜像自带的rpm包\n  ```\n\n  \n\n\n\n- rpm命令\n\n  ```bash\n  # 安装\n  \n  rpm -ivh xxx.rpm\n  \n  # http://nginx.org/packages/centos/7/x86_64/RPMS/\n  \n  -v : 显示安装过程\n  -i ：显示安装包的详细信息\n  -h : 安装包哈希标记\n  \n  # 下载Nginx rpm安装包的全名\n  [root@localhost ~]# wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\n  --2021-03-17 12:16:47--  http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\n  Resolving nginx.org (nginx.org)... 52.58.199.22, 3.125.197.172, 2a05:d014:edb:5702::6, ...\n  Connecting to nginx.org (nginx.org)|52.58.199.22|:80... connected.\n  HTTP request sent, awaiting response... 200 OK\n  Length: 790284 (772K) [application/x-redhat-package-manager]\n  Saving to: ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’\n  \n  100%[====================================================>] 790,284      339KB/s   in 2.3s   \n  \n  2021-03-17 12:16:51 (339 KB/s) - ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’ saved [790284/790284]\n  \n  # 安装rpm安装包\n  [root@localhost ~]# rpm -ivh nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Preparing...                          ################################# [100%]\n  Updating / installing...\n     1:nginx-1:1.18.0-1.el7.ngx         ################################# [100%]\n  ----------------------------------------------------------------------\n  \n  Thanks for using nginx!\n  \n  Please find the official documentation for nginx here:\n  * http://nginx.org/en/docs/\n  \n  Please subscribe to nginx-announce mailing list to get\n  the most important news about nginx:\n  * http://nginx.org/en/support.html\n  \n  Commercial subscriptions for nginx are available on:\n  * http://nginx.com/products/\n  \n  ----------------------------------------------------------------------\n  \n  # 验证nginx是否安装成功\n  [root@localhost ~]# nginx -v\n  nginx version: nginx/1.18.0\n  \n  \n  # 卸载\n  [root@localhost ~]# rpm -e nginx (软件包名称)\n  [root@localhost ~]# nginx -v\n  -bash: /usr/sbin/nginx: No such file or directory\n  [root@localhost ~]# \n  \n  \n  # 查看系统当中安装了哪些rpm软件包\n  rpm -qa\n  \n  # 查看系统当中是否安装了某个rpm软件包\n  [root@localhost ~]# rpm -q nginx（软件包名）\n  nginx-1.18.0-1.el7.ngx.x86_64\n  [root@localhost ~]# rpm -q safsdgsfdgfd\n  package safsdgsfdgfd is not installed\n  \n  \n  # 显示已经安装过的rpm包详细信息。\n  [root@localhost ~]# rpm -qi nginx\n  Name        : nginx\n  Epoch       : 1\n  Version     : 1.18.0\n  Release     : 1.el7.ngx\n  Architecture: x86_64\n  Install Date: Wed 17 Mar 2021 04:18:55 PM CST\n  Group       : System Environment/Daemons\n  Size        : 2830028\n  License     : 2-clause BSD-like license\n  Signature   : RSA/SHA1, Tue 21 Apr 2020 11:19:18 PM CST, Key ID abf5bd827bd9bf62\n  Source RPM  : nginx-1.18.0-1.el7.ngx.src.rpm\n  Build Date  : Tue 21 Apr 2020 11:07:33 PM CST\n  Build Host  : ip-10-1-17-101.eu-central-1.compute.internal\n  Relocations : (not relocatable)\n  Vendor      : Nginx, Inc.\n  URL         : http://nginx.org/\n  Summary     : High performance web server\n  Description :\n  nginx [engine x] is an HTTP and reverse proxy server, as well as\n  a mail proxy server.\n  \n  # 查看安装包的内容\n  [root@localhost nginx]# rpm -ql nginx\n  /etc/logrotate.d/nginx\n  /etc/nginx\n  /etc/nginx/conf.d\n  /etc/nginx/conf.d/default.conf\n  /etc/nginx/fastcgi_params\n  /etc/nginx/koi-utf\n  /etc/nginx/koi-win\n  /etc/nginx/mime.types\n  /etc/nginx/modules\n  /etc/nginx/nginx.conf\n  /etc/nginx/scgi_params\n  /etc/nginx/uwsgi_params\n  /etc/nginx/win-utf\n  /etc/sysconfig/nginx\n  /etc/sysconfig/nginx-debug\n  /usr/lib/systemd/system/nginx-debug.service\n  /usr/lib/systemd/system/nginx.service\n  /usr/lib64/nginx\n  /usr/lib64/nginx/modules\n  /usr/libexec/initscripts/legacy-actions/nginx\n  /usr/libexec/initscripts/legacy-actions/nginx/check-reload\n  /usr/libexec/initscripts/legacy-actions/nginx/upgrade\n  /usr/sbin/nginx\n  /usr/sbin/nginx-debug\n  /usr/share/doc/nginx-1.18.0\n  /usr/share/doc/nginx-1.18.0/COPYRIGHT\n  /usr/share/man/man8/nginx.8.gz\n  /usr/share/nginx\n  /usr/share/nginx/html\n  /usr/share/nginx/html/50x.html\n  /usr/share/nginx/html/index.html\n  /var/cache/nginx\n  /var/log/nginx\n  \n  # 查看配置信息\n  [root@localhost nginx]# rpm -qc nginx\n  /etc/logrotate.d/nginx\n  /etc/nginx/conf.d/default.conf\n  /etc/nginx/fastcgi_params\n  /etc/nginx/koi-utf\n  /etc/nginx/koi-win\n  /etc/nginx/mime.types\n  /etc/nginx/nginx.conf\n  /etc/nginx/scgi_params\n  /etc/nginx/uwsgi_params\n  /etc/nginx/win-utf\n  /etc/sysconfig/nginx\n  /etc/sysconfig/nginx-debug\n  \n  # 查看文件帮助信息\n  [root@localhost nginx]# rpm -qd zlib\n  /usr/share/doc/zlib-1.2.7/ChangeLog\n  /usr/share/doc/zlib-1.2.7/FAQ\n  /usr/share/doc/zlib-1.2.7/README\n  \n  # \n  [root@localhost ~]# rpm -qf /usr/sbin/nginx\n  nginx-1.18.0-1.el7.ngx.x86_64\n  \n  # 用 -p 可以查看未安装软件包的详细信息\n  [root@localhost ~]# rpm -qip nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Name        : nginx\n  Epoch       : 1\n  Version     : 1.18.0\n  Release     : 1.el7.ngx\n  Architecture: x86_64\n  Install Date: (not installed)\n  Group       : System Environment/Daemons\n  Size        : 2830028\n  License     : 2-clause BSD-like license\n  Signature   : RSA/SHA1, Tue 21 Apr 2020 11:19:18 PM CST, Key ID abf5bd827bd9bf62\n  Source RPM  : nginx-1.18.0-1.el7.ngx.src.rpm\n  Build Date  : Tue 21 Apr 2020 11:07:33 PM CST\n  Build Host  : ip-10-1-17-101.eu-central-1.compute.internal\n  Relocations : (not relocatable)\n  Vendor      : Nginx, Inc.\n  URL         : http://nginx.org/\n  Summary     : High performance web server\n  Description :\n  nginx [engine x] is an HTTP and reverse proxy server, as well as\n  a mail proxy server.\n  \n  # 升级软件包\n  [root@localhost ~]# rpm -Uvh nginx-1.18.0-1.el7.ngx.x86_64.rpm \n  warning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\n  Preparing...                          ################################# [100%]\n  Updating / installing...\n     1:nginx-1:1.18.0-1.el7.ngx         ################################# [ 50%]\n  Cleaning up / removing...\n     2:nginx-1:1.14.0-1.el7_4.ngx       ################################# [100%]\n  [root@localhost ~]# nginx -v\n  nginx version: nginx/1.18.0\n  \n  \n  # 强制删除软件包--nodeps\n  [root@localhost ~]# rpm -e zlib --nodeps\n  \n  ```\n\n## yum\n\n> yum是CentOS的软件包管理工具，自动为我们解决软件依赖问题。yum包管理工具必须使用yum源指定软件下载地址去下载需要安装的软件包。配置的路径是：/etc/yum.repos.d\n\n```bash\n# 清空本机所有的yum源\n[root@www yum.repos.d]# rm -rf /etc/yum.repos.d/*\n```\n\n\n\n- yum源命令\n\n  ```bash\n  # 查看当前系统的yum源列表\n  [root@www yum.repos.d]# yum repolist \n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                   repo name                                           status\n  base                      \"This is local repo, and 非常屌\"                    10,072\n  repolist: 10,072\n  \n  # yum清空缓存\n  [root@www yum.repos.d]# yum clean all\n  Loaded plugins: fastestmirror\n  Cleaning repos: base\n  Cleaning up list of fastest mirrors\n  Other repos take up 76 M of disk space (use --verbose for details)\n  \n  # 建立yum缓存\n  [root@www yum.repos.d]# yum makecache\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  \n  ```\n\n- yum源的执行原理\n\n  ```bash\n  1、需要在/etc/yum.repos.d目录下配置yum源地址\n  2、清空缓存建立新的缓存\n  3、安装软件（自动解决依赖关系）\n  ```\n\n- yum常用的基础命令\n\n  ```bash\n  # 安装软件包的命令\n  yum install 软件包名称\n  \t-y : 免交互安装\n  \n  # 卸载软件（直接将软件的依赖包一起删除）\n  yum remove 软件包名称\n  [root@www yum.repos.d]# yum remove httpd\n  \t-y : 免交互移除\n  \n  # 查看当前系统需要更新软件\n  yum check-update\n  \n  # 更新所有的需要更新的软件\n  yum update \n  \t-y ： 免交互\n  \n  # 更新某一个软件\n  yum update (软件包名称)\n  \n  # 重装软件\n  yum reinstall (软件包名称)\n  \n  # 搜索软件包\n  [root@www httpd]# yum search （软件包名称）\n  -------------------------------------------------------\n  \n  # 查看yum执行历史\n  yum history\n  [root@www httpd]# yum history info (历史ID号)\n  [root@www httpd]# yum history undo (历史ID号)\n  # 查看当前系统当中可更新的软件包\n  [root@www yum.repos.d]# yum check-update \n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  \n  postfix.x86_64                                        2:2.10.1-9.0.1.el7.centos.plus                                      centosplus\n  python-perf.x86_64                                    3.10.0-1160.15.2.el7.centos.plus                                    centosplus\n  [root@www yum.repos.d]# \n  \n  # 查看系统中有哪些仓库地址\n  yum repolist    # 正在启用的yum仓库\n  [root@www yum.repos.d]# yum repolist\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                   repo name                                           status\n  base/7/x86_64             CentOS-7 - Base - repo.huaweicloud.com              10,072\n  extras/7/x86_64           CentOS-7 - Extras - repo.huaweicloud.com               453\n  updates/7/x86_64          CentOS-7 - Updates - repo.huaweicloud.com            1,729\n  \n  yum repolist all # 查看系统中所有的yum仓库\n  [root@www yum.repos.d]# yum repolist all\n  Loaded plugins: fastestmirror\n  Loading mirror speeds from cached hostfile\n  repo id                                        repo name                                                             status\n  base/7/x86_64                                  CentOS-7 - Base - repo.huaweicloud.com                                enabled: 10,072\n  centosplus/7/x86_64                            CentOS-7 - Plus - repo.huaweicloud.com                                disabled\n  extras/7/x86_64                                CentOS-7 - Extras - repo.huaweicloud.com                              enabled:    453\n  updates/7/x86_64                               CentOS-7 - Updates - repo.huaweicloud.com                             enabled:  1,72\n  \n  \n  # 启用repo仓库\n  yum install yum-utils -y\n  \n  启用一个yum仓库：yum-config-manager --enable (仓库名称)\n  关闭一个yum仓库：yum-config-manager --disable (仓库名称)\n  \n  \n  # 查看一个仓库中的软件包列表\n  [root@www yum.repos.d]# yum list\n  \n  # 查看软件包组\n  [root@www yum.repos.d]# yum grouplist\n  \n  # 安装软件包组\n  [root@www yum.repos.d]# yum groupinstall \"Development Tools\"\n  \n  \n  ```\n\n- 本地yum源配置\n\n  ```bash\n  1、备份/etc/yum.repos.d/下的所文件\n  \trm -rf /etc/yum.repos.d/*\n  \n  2、编写本地yum源\n  [root@www yum.repos.d]# cat test.repo \n  [base] # yum源名称\n  name=\"This is repo infomation\" #yum源的简介\n  baseurl=file:///opt    # 指定yum源地址\n  enabled=1\t\t\t\t# 是否启用yum源\n  gpgcheck=0\t\t\t\t# 是否检查gpg秘钥\n  \n  3、更新缓存\n  yum makecache\n  \n  4、安装软件\n  yum install dos2unix\n  ```\n\n- 共享yum源配置\n\n  ```bash\n  1、安装ftp\n  yum install vsftpd -y\n  \n  2、启动vsftpd\n  systemctl enable --now vsftpd # 设置开机自启动并且立即启动\n  \n  3、创建yum源共享文件夹\n  [root@www ftp]# mkdir /var/ftp/centos\n  \n  4、将映像中的软件复制到/var/ftp/centos\n  cp -rp /opt/* /var/ftp/centos\n  \n  5、编辑本地yum源，接入ftp\n  [root@localhost yum.repos.d]# cat local.repo \n  [base]\n  baseurl=ftp://192.168.15.100/centos\n  name=\"This is ftp repo\"\n  enabled=1\n  gpgcheck=0\n  \n  6、测试安装\n  yum install dos2unix -y\n  ```\n\n- yum的配置\n\n  ```bash\n  # yum仓库的机器上执行\n  1、修改/etc/yum.conf\n      cachedir=/var/ftp/centos/Packages   # 指定yum缓存目录\n      keepcache=1\t\t\t\t\t\t\t# 下载的缓存软件不立即删除， 0为立即删除\n  \n  2、安装ftp\n  yum install vsftpd -y\n  \n  3、启动vsftpd\n  systemctl enable --now vsftpd # 设置开机自启动并且立即启动\n  \n  4、创建yum源共享文件夹\n  [root@www ftp]# mkdir /var/ftp/centos\n  \n  5、更新yum仓库\n  [root@www ftp]# yum clean all\n  [root@www ftp]# yum makecache\n  \n  6、建立一个快捷方式\n  cd /var/ftp/centos/Packages/base\n  ln -s packages Packages\n  \n  7、安装mariadb\n  yum install mariadb -y\n  \n  8、建立/var/ftp/centos/Packages/base/repodata\n  mkdir /var/ftp/centos/Packages/base/repodata\n  \n  9、把/var/ftp/centos/Packages/base下面的自动生成的压缩文件复制到/var/ftp/centos/Packages/base/repodata用做认证。\n  \n  # 使用yum仓库的机器上执行\n  1、建立yum配置文件\n  [root@localhost ~]# cat /etc/yum.repos.d/local.repo \n  [base]\n  baseurl=ftp://192.168.15.100/centos/Packages/base\n  name=\"This is ftp repo\"\n  enabled=1\n  gpgcheck=0\n  \n  2、更新yum仓库\n  [root@www ftp]# yum clean all\n  [root@www ftp]# yum makecache\n  \n  3、测试安装mariadb\n  yum install mariadb -y\n  ```\n\n  \n\n","slug":"01_运维/01-基础命令/day12-软件包管理/软件包","published":1,"updated":"2022-07-06T07:14:02.380Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1f0034a8v720sm411e","content":"<h1 id=\"软件包\"><a href=\"#软件包\" class=\"headerlink\" title=\"软件包\"></a>软件包</h1><ul>\n<li><p>rpm包来源</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、来源网络下载\n<span class=\"token number\">2</span>、来源本地：自己的镜像自带的rpm包<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n\n</li>\n<li><p>rpm命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安装</span>\n\n<span class=\"token function\">rpm</span> -ivh xxx.rpm\n\n<span class=\"token comment\"># http://nginx.org/packages/centos/7/x86_64/RPMS/</span>\n\n-v <span class=\"token builtin class-name\">:</span> 显示安装过程\n-i ：显示安装包的详细信息\n-h <span class=\"token builtin class-name\">:</span> 安装包哈希标记\n\n<span class=\"token comment\"># 下载Nginx rpm安装包的全名</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm</span>\n--2021-03-17 <span class=\"token number\">12</span>:16:47--  http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\nResolving nginx.org <span class=\"token punctuation\">(</span>nginx.org<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>. <span class=\"token number\">52.58</span>.199.22, <span class=\"token number\">3.125</span>.197.172, 2a05:d014:edb:5702::6, <span class=\"token punctuation\">..</span>.\nConnecting to nginx.org <span class=\"token punctuation\">(</span>nginx.org<span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token number\">52.58</span>.199.22<span class=\"token operator\">|</span>:80<span class=\"token punctuation\">..</span>. connected.\nHTTP request sent, awaiting response<span class=\"token punctuation\">..</span>. <span class=\"token number\">200</span> OK\nLength: <span class=\"token number\">790284</span> <span class=\"token punctuation\">(</span>772K<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>application/x-redhat-package-manager<span class=\"token punctuation\">]</span>\nSaving to: ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’\n\n<span class=\"token number\">100</span>%<span class=\"token punctuation\">[</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token number\">790,284</span>      339KB/s   <span class=\"token keyword\">in</span> <span class=\"token number\">2</span>.3s   \n\n<span class=\"token number\">2021</span>-03-17 <span class=\"token number\">12</span>:16:51 <span class=\"token punctuation\">(</span><span class=\"token number\">339</span> KB/s<span class=\"token punctuation\">)</span> - ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’ saved <span class=\"token punctuation\">[</span><span class=\"token number\">790284</span>/790284<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 安装rpm安装包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nPreparing<span class=\"token punctuation\">..</span>.                          <span class=\"token comment\">################################# [100%]</span>\nUpdating / installing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">1</span>:nginx-1:1.18.0-1.el7.ngx         <span class=\"token comment\">################################# [100%]</span>\n----------------------------------------------------------------------\n\nThanks <span class=\"token keyword\">for</span> using nginx<span class=\"token operator\">!</span>\n\nPlease <span class=\"token function\">find</span> the official documentation <span class=\"token keyword\">for</span> nginx here:\n* http://nginx.org/en/docs/\n\nPlease subscribe to nginx-announce mailing list to get\nthe <span class=\"token function\">most</span> important news about nginx:\n* http://nginx.org/en/support.html\n\nCommercial subscriptions <span class=\"token keyword\">for</span> nginx are available on:\n* http://nginx.com/products/\n\n----------------------------------------------------------------------\n\n<span class=\"token comment\"># 验证nginx是否安装成功</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\nnginx version: nginx/1.18.0\n\n\n<span class=\"token comment\"># 卸载</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e nginx (软件包名称)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\n-bash: /usr/sbin/nginx: No such <span class=\"token function\">file</span> or directory\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n\n<span class=\"token comment\"># 查看系统当中安装了哪些rpm软件包</span>\n<span class=\"token function\">rpm</span> -qa\n\n<span class=\"token comment\"># 查看系统当中是否安装了某个rpm软件包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -q nginx（软件包名）</span>\nnginx-1.18.0-1.el7.ngx.x86_64\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -q safsdgsfdgfd</span>\npackage safsdgsfdgfd is not installed\n\n\n<span class=\"token comment\"># 显示已经安装过的rpm包详细信息。</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qi nginx</span>\nName        <span class=\"token builtin class-name\">:</span> nginx\nEpoch       <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\nVersion     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.18</span>.0\nRelease     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>.el7.ngx\nArchitecture: x86_64\nInstall Date: Wed <span class=\"token number\">17</span> Mar <span class=\"token number\">2021</span> 04:18:55 PM CST\nGroup       <span class=\"token builtin class-name\">:</span> System Environment/Daemons\nSize        <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2830028</span>\nLicense     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>-clause BSD-like license\nSignature   <span class=\"token builtin class-name\">:</span> RSA/SHA1, Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:19:18 PM CST, Key ID abf5bd827bd9bf62\nSource RPM  <span class=\"token builtin class-name\">:</span> nginx-1.18.0-1.el7.ngx.src.rpm\nBuild Date  <span class=\"token builtin class-name\">:</span> Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:07:33 PM CST\nBuild Host  <span class=\"token builtin class-name\">:</span> ip-10-1-17-101.eu-central-1.compute.internal\nRelocations <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">(</span>not relocatable<span class=\"token punctuation\">)</span>\nVendor      <span class=\"token builtin class-name\">:</span> Nginx, Inc.\nURL         <span class=\"token builtin class-name\">:</span> http://nginx.org/\nSummary     <span class=\"token builtin class-name\">:</span> High performance web server\nDescription <span class=\"token builtin class-name\">:</span>\nnginx <span class=\"token punctuation\">[</span>engine x<span class=\"token punctuation\">]</span> is an HTTP and reverse proxy server, as well as\na mail proxy server.\n\n<span class=\"token comment\"># 查看安装包的内容</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql nginx</span>\n/etc/logrotate.d/nginx\n/etc/nginx\n/etc/nginx/conf.d\n/etc/nginx/conf.d/default.conf\n/etc/nginx/fastcgi_params\n/etc/nginx/koi-utf\n/etc/nginx/koi-win\n/etc/nginx/mime.types\n/etc/nginx/modules\n/etc/nginx/nginx.conf\n/etc/nginx/scgi_params\n/etc/nginx/uwsgi_params\n/etc/nginx/win-utf\n/etc/sysconfig/nginx\n/etc/sysconfig/nginx-debug\n/usr/lib/systemd/system/nginx-debug.service\n/usr/lib/systemd/system/nginx.service\n/usr/lib64/nginx\n/usr/lib64/nginx/modules\n/usr/libexec/initscripts/legacy-actions/nginx\n/usr/libexec/initscripts/legacy-actions/nginx/check-reload\n/usr/libexec/initscripts/legacy-actions/nginx/upgrade\n/usr/sbin/nginx\n/usr/sbin/nginx-debug\n/usr/share/doc/nginx-1.18.0\n/usr/share/doc/nginx-1.18.0/COPYRIGHT\n/usr/share/man/man8/nginx.8.gz\n/usr/share/nginx\n/usr/share/nginx/html\n/usr/share/nginx/html/50x.html\n/usr/share/nginx/html/index.html\n/var/cache/nginx\n/var/log/nginx\n\n<span class=\"token comment\"># 查看配置信息</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qc nginx</span>\n/etc/logrotate.d/nginx\n/etc/nginx/conf.d/default.conf\n/etc/nginx/fastcgi_params\n/etc/nginx/koi-utf\n/etc/nginx/koi-win\n/etc/nginx/mime.types\n/etc/nginx/nginx.conf\n/etc/nginx/scgi_params\n/etc/nginx/uwsgi_params\n/etc/nginx/win-utf\n/etc/sysconfig/nginx\n/etc/sysconfig/nginx-debug\n\n<span class=\"token comment\"># 查看文件帮助信息</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qd zlib</span>\n/usr/share/doc/zlib-1.2.7/ChangeLog\n/usr/share/doc/zlib-1.2.7/FAQ\n/usr/share/doc/zlib-1.2.7/README\n\n<span class=\"token comment\"># </span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qf /usr/sbin/nginx</span>\nnginx-1.18.0-1.el7.ngx.x86_64\n\n<span class=\"token comment\"># 用 -p 可以查看未安装软件包的详细信息</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qip nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nName        <span class=\"token builtin class-name\">:</span> nginx\nEpoch       <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\nVersion     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.18</span>.0\nRelease     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>.el7.ngx\nArchitecture: x86_64\nInstall Date: <span class=\"token punctuation\">(</span>not installed<span class=\"token punctuation\">)</span>\nGroup       <span class=\"token builtin class-name\">:</span> System Environment/Daemons\nSize        <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2830028</span>\nLicense     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>-clause BSD-like license\nSignature   <span class=\"token builtin class-name\">:</span> RSA/SHA1, Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:19:18 PM CST, Key ID abf5bd827bd9bf62\nSource RPM  <span class=\"token builtin class-name\">:</span> nginx-1.18.0-1.el7.ngx.src.rpm\nBuild Date  <span class=\"token builtin class-name\">:</span> Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:07:33 PM CST\nBuild Host  <span class=\"token builtin class-name\">:</span> ip-10-1-17-101.eu-central-1.compute.internal\nRelocations <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">(</span>not relocatable<span class=\"token punctuation\">)</span>\nVendor      <span class=\"token builtin class-name\">:</span> Nginx, Inc.\nURL         <span class=\"token builtin class-name\">:</span> http://nginx.org/\nSummary     <span class=\"token builtin class-name\">:</span> High performance web server\nDescription <span class=\"token builtin class-name\">:</span>\nnginx <span class=\"token punctuation\">[</span>engine x<span class=\"token punctuation\">]</span> is an HTTP and reverse proxy server, as well as\na mail proxy server.\n\n<span class=\"token comment\"># 升级软件包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -Uvh nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nPreparing<span class=\"token punctuation\">..</span>.                          <span class=\"token comment\">################################# [100%]</span>\nUpdating / installing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">1</span>:nginx-1:1.18.0-1.el7.ngx         <span class=\"token comment\">################################# [ 50%]</span>\nCleaning up / removing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">2</span>:nginx-1:1.14.0-1.el7_4.ngx       <span class=\"token comment\">################################# [100%]</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\nnginx version: nginx/1.18.0\n\n\n<span class=\"token comment\"># 强制删除软件包--nodeps</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e zlib --nodeps</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h2><blockquote>\n<p>yum是CentOS的软件包管理工具，自动为我们解决软件依赖问题。yum包管理工具必须使用yum源指定软件下载地址去下载需要安装的软件包。配置的路径是：&#x2F;etc&#x2F;yum.repos.d</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 清空本机所有的yum源</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /etc/yum.repos.d/*</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<ul>\n<li><p>yum源命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 查看当前系统的yum源列表</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist </span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                   repo name                                           status\nbase                      <span class=\"token string\">\"This is local repo, and 非常屌\"</span>                    <span class=\"token number\">10,072</span>\nrepolist: <span class=\"token number\">10,072</span>\n\n<span class=\"token comment\"># yum清空缓存</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\nLoaded plugins: fastestmirror\nCleaning repos: base\nCleaning up list of fastest mirrors\nOther repos take up <span class=\"token number\">76</span> M of disk space <span class=\"token punctuation\">(</span>use --verbose <span class=\"token keyword\">for</span> details<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 建立yum缓存</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum源的执行原理</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、需要在/etc/yum.repos.d目录下配置yum源地址\n<span class=\"token number\">2</span>、清空缓存建立新的缓存\n<span class=\"token number\">3</span>、安装软件（自动解决依赖关系）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum常用的基础命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安装软件包的命令</span>\nyum <span class=\"token function\">install</span> 软件包名称\n\t-y <span class=\"token builtin class-name\">:</span> 免交互安装\n\n<span class=\"token comment\"># 卸载软件（直接将软件的依赖包一起删除）</span>\nyum remove 软件包名称\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove httpd</span>\n\t-y <span class=\"token builtin class-name\">:</span> 免交互移除\n\n<span class=\"token comment\"># 查看当前系统需要更新软件</span>\nyum check-update\n\n<span class=\"token comment\"># 更新所有的需要更新的软件</span>\nyum update \n\t-y ： 免交互\n\n<span class=\"token comment\"># 更新某一个软件</span>\nyum update <span class=\"token punctuation\">(</span>软件包名称<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 重装软件</span>\nyum reinstall <span class=\"token punctuation\">(</span>软件包名称<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 搜索软件包</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum search （软件包名称）</span>\n-------------------------------------------------------\n\n<span class=\"token comment\"># 查看yum执行历史</span>\nyum <span class=\"token function\">history</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum history info (历史ID号)</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum history undo (历史ID号)</span>\n<span class=\"token comment\"># 查看当前系统当中可更新的软件包</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum check-update </span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n\npostfix.x86_64                                        <span class=\"token number\">2</span>:2.10.1-9.0.1.el7.centos.plus                                      centosplus\npython-perf.x86_64                                    <span class=\"token number\">3.10</span>.0-1160.15.2.el7.centos.plus                                    centosplus\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 查看系统中有哪些仓库地址</span>\nyum repolist    <span class=\"token comment\"># 正在启用的yum仓库</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                   repo name                                           status\nbase/7/x86_64             CentOS-7 - Base - repo.huaweicloud.com              <span class=\"token number\">10,072</span>\nextras/7/x86_64           CentOS-7 - Extras - repo.huaweicloud.com               <span class=\"token number\">453</span>\nupdates/7/x86_64          CentOS-7 - Updates - repo.huaweicloud.com            <span class=\"token number\">1,729</span>\n\nyum repolist all <span class=\"token comment\"># 查看系统中所有的yum仓库</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist all</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                                        repo name                                                             status\nbase/7/x86_64                                  CentOS-7 - Base - repo.huaweicloud.com                                enabled: <span class=\"token number\">10,072</span>\ncentosplus/7/x86_64                            CentOS-7 - Plus - repo.huaweicloud.com                                disabled\nextras/7/x86_64                                CentOS-7 - Extras - repo.huaweicloud.com                              enabled:    <span class=\"token number\">453</span>\nupdates/7/x86_64                               CentOS-7 - Updates - repo.huaweicloud.com                             enabled:  <span class=\"token number\">1,72</span>\n\n\n<span class=\"token comment\"># 启用repo仓库</span>\nyum <span class=\"token function\">install</span> yum-utils -y\n\n启用一个yum仓库：yum-config-manager --enable <span class=\"token punctuation\">(</span>仓库名称<span class=\"token punctuation\">)</span>\n关闭一个yum仓库：yum-config-manager --disable <span class=\"token punctuation\">(</span>仓库名称<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 查看一个仓库中的软件包列表</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum list</span>\n\n<span class=\"token comment\"># 查看软件包组</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum grouplist</span>\n\n<span class=\"token comment\"># 安装软件包组</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum groupinstall \"Development Tools\"</span>\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>本地yum源配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、备份/etc/yum.repos.d/下的所文件\n\t<span class=\"token function\">rm</span> -rf /etc/yum.repos.d/*\n\n<span class=\"token number\">2</span>、编写本地yum源\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat test.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span> <span class=\"token comment\"># yum源名称</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is repo infomation\"</span> <span class=\"token comment\">#yum源的简介</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>file:///opt    <span class=\"token comment\"># 指定yum源地址</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t\t<span class=\"token comment\"># 是否启用yum源</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\t\t\t\t<span class=\"token comment\"># 是否检查gpg秘钥</span>\n\n<span class=\"token number\">3</span>、更新缓存\nyum makecache\n\n<span class=\"token number\">4</span>、安装软件\nyum <span class=\"token function\">install</span> dos2unix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>共享yum源配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、安装ftp\nyum <span class=\"token function\">install</span> vsftpd -y\n\n<span class=\"token number\">2</span>、启动vsftpd\nsystemctl <span class=\"token builtin class-name\">enable</span> --now vsftpd <span class=\"token comment\"># 设置开机自启动并且立即启动</span>\n\n<span class=\"token number\">3</span>、创建yum源共享文件夹\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /var/ftp/centos</span>\n\n<span class=\"token number\">4</span>、将映像中的软件复制到/var/ftp/centos\n<span class=\"token function\">cp</span> -rp /opt/* /var/ftp/centos\n\n<span class=\"token number\">5</span>、编辑本地yum源，接入ftp\n<span class=\"token punctuation\">[</span>root@localhost yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://192.168.15.100/centos\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp repo\"</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token number\">6</span>、测试安装\nyum <span class=\"token function\">install</span> dos2unix -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum的配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># yum仓库的机器上执行</span>\n<span class=\"token number\">1</span>、修改/etc/yum.conf\n    <span class=\"token assign-left variable\">cachedir</span><span class=\"token operator\">=</span>/var/ftp/centos/Packages   <span class=\"token comment\"># 指定yum缓存目录</span>\n    <span class=\"token assign-left variable\">keepcache</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t\t\t\t\t<span class=\"token comment\"># 下载的缓存软件不立即删除， 0为立即删除</span>\n\n<span class=\"token number\">2</span>、安装ftp\nyum <span class=\"token function\">install</span> vsftpd -y\n\n<span class=\"token number\">3</span>、启动vsftpd\nsystemctl <span class=\"token builtin class-name\">enable</span> --now vsftpd <span class=\"token comment\"># 设置开机自启动并且立即启动</span>\n\n<span class=\"token number\">4</span>、创建yum源共享文件夹\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /var/ftp/centos</span>\n\n<span class=\"token number\">5</span>、更新yum仓库\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">6</span>、建立一个快捷方式\n<span class=\"token builtin class-name\">cd</span> /var/ftp/centos/Packages/base\n<span class=\"token function\">ln</span> -s packages Packages\n\n<span class=\"token number\">7</span>、安装mariadb\nyum <span class=\"token function\">install</span> mariadb -y\n\n<span class=\"token number\">8</span>、建立/var/ftp/centos/Packages/base/repodata\n<span class=\"token function\">mkdir</span> /var/ftp/centos/Packages/base/repodata\n\n<span class=\"token number\">9</span>、把/var/ftp/centos/Packages/base下面的自动生成的压缩文件复制到/var/ftp/centos/Packages/base/repodata用做认证。\n\n<span class=\"token comment\"># 使用yum仓库的机器上执行</span>\n<span class=\"token number\">1</span>、建立yum配置文件\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/local.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://192.168.15.100/centos/Packages/base\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp repo\"</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token number\">2</span>、更新yum仓库\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">3</span>、测试安装mariadb\nyum <span class=\"token function\">install</span> mariadb -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"软件包\"><a href=\"#软件包\" class=\"headerlink\" title=\"软件包\"></a>软件包</h1><ul>\n<li><p>rpm包来源</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、来源网络下载\n<span class=\"token number\">2</span>、来源本地：自己的镜像自带的rpm包<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n\n</li>\n<li><p>rpm命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安装</span>\n\n<span class=\"token function\">rpm</span> -ivh xxx.rpm\n\n<span class=\"token comment\"># http://nginx.org/packages/centos/7/x86_64/RPMS/</span>\n\n-v <span class=\"token builtin class-name\">:</span> 显示安装过程\n-i ：显示安装包的详细信息\n-h <span class=\"token builtin class-name\">:</span> 安装包哈希标记\n\n<span class=\"token comment\"># 下载Nginx rpm安装包的全名</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm</span>\n--2021-03-17 <span class=\"token number\">12</span>:16:47--  http://nginx.org/packages/centos/7/x86_64/RPMS/nginx-1.18.0-1.el7.ngx.x86_64.rpm\nResolving nginx.org <span class=\"token punctuation\">(</span>nginx.org<span class=\"token punctuation\">)</span><span class=\"token punctuation\">..</span>. <span class=\"token number\">52.58</span>.199.22, <span class=\"token number\">3.125</span>.197.172, 2a05:d014:edb:5702::6, <span class=\"token punctuation\">..</span>.\nConnecting to nginx.org <span class=\"token punctuation\">(</span>nginx.org<span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token number\">52.58</span>.199.22<span class=\"token operator\">|</span>:80<span class=\"token punctuation\">..</span>. connected.\nHTTP request sent, awaiting response<span class=\"token punctuation\">..</span>. <span class=\"token number\">200</span> OK\nLength: <span class=\"token number\">790284</span> <span class=\"token punctuation\">(</span>772K<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>application/x-redhat-package-manager<span class=\"token punctuation\">]</span>\nSaving to: ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’\n\n<span class=\"token number\">100</span>%<span class=\"token punctuation\">[</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token number\">790,284</span>      339KB/s   <span class=\"token keyword\">in</span> <span class=\"token number\">2</span>.3s   \n\n<span class=\"token number\">2021</span>-03-17 <span class=\"token number\">12</span>:16:51 <span class=\"token punctuation\">(</span><span class=\"token number\">339</span> KB/s<span class=\"token punctuation\">)</span> - ‘nginx-1.18.0-1.el7.ngx.x86_64.rpm’ saved <span class=\"token punctuation\">[</span><span class=\"token number\">790284</span>/790284<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 安装rpm安装包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ivh nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nPreparing<span class=\"token punctuation\">..</span>.                          <span class=\"token comment\">################################# [100%]</span>\nUpdating / installing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">1</span>:nginx-1:1.18.0-1.el7.ngx         <span class=\"token comment\">################################# [100%]</span>\n----------------------------------------------------------------------\n\nThanks <span class=\"token keyword\">for</span> using nginx<span class=\"token operator\">!</span>\n\nPlease <span class=\"token function\">find</span> the official documentation <span class=\"token keyword\">for</span> nginx here:\n* http://nginx.org/en/docs/\n\nPlease subscribe to nginx-announce mailing list to get\nthe <span class=\"token function\">most</span> important news about nginx:\n* http://nginx.org/en/support.html\n\nCommercial subscriptions <span class=\"token keyword\">for</span> nginx are available on:\n* http://nginx.com/products/\n\n----------------------------------------------------------------------\n\n<span class=\"token comment\"># 验证nginx是否安装成功</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\nnginx version: nginx/1.18.0\n\n\n<span class=\"token comment\"># 卸载</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e nginx (软件包名称)</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\n-bash: /usr/sbin/nginx: No such <span class=\"token function\">file</span> or directory\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n\n<span class=\"token comment\"># 查看系统当中安装了哪些rpm软件包</span>\n<span class=\"token function\">rpm</span> -qa\n\n<span class=\"token comment\"># 查看系统当中是否安装了某个rpm软件包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -q nginx（软件包名）</span>\nnginx-1.18.0-1.el7.ngx.x86_64\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -q safsdgsfdgfd</span>\npackage safsdgsfdgfd is not installed\n\n\n<span class=\"token comment\"># 显示已经安装过的rpm包详细信息。</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qi nginx</span>\nName        <span class=\"token builtin class-name\">:</span> nginx\nEpoch       <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\nVersion     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.18</span>.0\nRelease     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>.el7.ngx\nArchitecture: x86_64\nInstall Date: Wed <span class=\"token number\">17</span> Mar <span class=\"token number\">2021</span> 04:18:55 PM CST\nGroup       <span class=\"token builtin class-name\">:</span> System Environment/Daemons\nSize        <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2830028</span>\nLicense     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>-clause BSD-like license\nSignature   <span class=\"token builtin class-name\">:</span> RSA/SHA1, Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:19:18 PM CST, Key ID abf5bd827bd9bf62\nSource RPM  <span class=\"token builtin class-name\">:</span> nginx-1.18.0-1.el7.ngx.src.rpm\nBuild Date  <span class=\"token builtin class-name\">:</span> Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:07:33 PM CST\nBuild Host  <span class=\"token builtin class-name\">:</span> ip-10-1-17-101.eu-central-1.compute.internal\nRelocations <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">(</span>not relocatable<span class=\"token punctuation\">)</span>\nVendor      <span class=\"token builtin class-name\">:</span> Nginx, Inc.\nURL         <span class=\"token builtin class-name\">:</span> http://nginx.org/\nSummary     <span class=\"token builtin class-name\">:</span> High performance web server\nDescription <span class=\"token builtin class-name\">:</span>\nnginx <span class=\"token punctuation\">[</span>engine x<span class=\"token punctuation\">]</span> is an HTTP and reverse proxy server, as well as\na mail proxy server.\n\n<span class=\"token comment\"># 查看安装包的内容</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql nginx</span>\n/etc/logrotate.d/nginx\n/etc/nginx\n/etc/nginx/conf.d\n/etc/nginx/conf.d/default.conf\n/etc/nginx/fastcgi_params\n/etc/nginx/koi-utf\n/etc/nginx/koi-win\n/etc/nginx/mime.types\n/etc/nginx/modules\n/etc/nginx/nginx.conf\n/etc/nginx/scgi_params\n/etc/nginx/uwsgi_params\n/etc/nginx/win-utf\n/etc/sysconfig/nginx\n/etc/sysconfig/nginx-debug\n/usr/lib/systemd/system/nginx-debug.service\n/usr/lib/systemd/system/nginx.service\n/usr/lib64/nginx\n/usr/lib64/nginx/modules\n/usr/libexec/initscripts/legacy-actions/nginx\n/usr/libexec/initscripts/legacy-actions/nginx/check-reload\n/usr/libexec/initscripts/legacy-actions/nginx/upgrade\n/usr/sbin/nginx\n/usr/sbin/nginx-debug\n/usr/share/doc/nginx-1.18.0\n/usr/share/doc/nginx-1.18.0/COPYRIGHT\n/usr/share/man/man8/nginx.8.gz\n/usr/share/nginx\n/usr/share/nginx/html\n/usr/share/nginx/html/50x.html\n/usr/share/nginx/html/index.html\n/var/cache/nginx\n/var/log/nginx\n\n<span class=\"token comment\"># 查看配置信息</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qc nginx</span>\n/etc/logrotate.d/nginx\n/etc/nginx/conf.d/default.conf\n/etc/nginx/fastcgi_params\n/etc/nginx/koi-utf\n/etc/nginx/koi-win\n/etc/nginx/mime.types\n/etc/nginx/nginx.conf\n/etc/nginx/scgi_params\n/etc/nginx/uwsgi_params\n/etc/nginx/win-utf\n/etc/sysconfig/nginx\n/etc/sysconfig/nginx-debug\n\n<span class=\"token comment\"># 查看文件帮助信息</span>\n<span class=\"token punctuation\">[</span>root@localhost nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qd zlib</span>\n/usr/share/doc/zlib-1.2.7/ChangeLog\n/usr/share/doc/zlib-1.2.7/FAQ\n/usr/share/doc/zlib-1.2.7/README\n\n<span class=\"token comment\"># </span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qf /usr/sbin/nginx</span>\nnginx-1.18.0-1.el7.ngx.x86_64\n\n<span class=\"token comment\"># 用 -p 可以查看未安装软件包的详细信息</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -qip nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nName        <span class=\"token builtin class-name\">:</span> nginx\nEpoch       <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>\nVersion     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1.18</span>.0\nRelease     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span>.el7.ngx\nArchitecture: x86_64\nInstall Date: <span class=\"token punctuation\">(</span>not installed<span class=\"token punctuation\">)</span>\nGroup       <span class=\"token builtin class-name\">:</span> System Environment/Daemons\nSize        <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2830028</span>\nLicense     <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>-clause BSD-like license\nSignature   <span class=\"token builtin class-name\">:</span> RSA/SHA1, Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:19:18 PM CST, Key ID abf5bd827bd9bf62\nSource RPM  <span class=\"token builtin class-name\">:</span> nginx-1.18.0-1.el7.ngx.src.rpm\nBuild Date  <span class=\"token builtin class-name\">:</span> Tue <span class=\"token number\">21</span> Apr <span class=\"token number\">2020</span> <span class=\"token number\">11</span>:07:33 PM CST\nBuild Host  <span class=\"token builtin class-name\">:</span> ip-10-1-17-101.eu-central-1.compute.internal\nRelocations <span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">(</span>not relocatable<span class=\"token punctuation\">)</span>\nVendor      <span class=\"token builtin class-name\">:</span> Nginx, Inc.\nURL         <span class=\"token builtin class-name\">:</span> http://nginx.org/\nSummary     <span class=\"token builtin class-name\">:</span> High performance web server\nDescription <span class=\"token builtin class-name\">:</span>\nnginx <span class=\"token punctuation\">[</span>engine x<span class=\"token punctuation\">]</span> is an HTTP and reverse proxy server, as well as\na mail proxy server.\n\n<span class=\"token comment\"># 升级软件包</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -Uvh nginx-1.18.0-1.el7.ngx.x86_64.rpm </span>\nwarning: nginx-1.18.0-1.el7.ngx.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID 7bd9bf62: NOKEY\nPreparing<span class=\"token punctuation\">..</span>.                          <span class=\"token comment\">################################# [100%]</span>\nUpdating / installing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">1</span>:nginx-1:1.18.0-1.el7.ngx         <span class=\"token comment\">################################# [ 50%]</span>\nCleaning up / removing<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">2</span>:nginx-1:1.14.0-1.el7_4.ngx       <span class=\"token comment\">################################# [100%]</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -v</span>\nnginx version: nginx/1.18.0\n\n\n<span class=\"token comment\"># 强制删除软件包--nodeps</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e zlib --nodeps</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"yum\"><a href=\"#yum\" class=\"headerlink\" title=\"yum\"></a>yum</h2><blockquote>\n<p>yum是CentOS的软件包管理工具，自动为我们解决软件依赖问题。yum包管理工具必须使用yum源指定软件下载地址去下载需要安装的软件包。配置的路径是：&#x2F;etc&#x2F;yum.repos.d</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 清空本机所有的yum源</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /etc/yum.repos.d/*</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n\n\n<ul>\n<li><p>yum源命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 查看当前系统的yum源列表</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist </span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                   repo name                                           status\nbase                      <span class=\"token string\">\"This is local repo, and 非常屌\"</span>                    <span class=\"token number\">10,072</span>\nrepolist: <span class=\"token number\">10,072</span>\n\n<span class=\"token comment\"># yum清空缓存</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\nLoaded plugins: fastestmirror\nCleaning repos: base\nCleaning up list of fastest mirrors\nOther repos take up <span class=\"token number\">76</span> M of disk space <span class=\"token punctuation\">(</span>use --verbose <span class=\"token keyword\">for</span> details<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 建立yum缓存</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum源的执行原理</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、需要在/etc/yum.repos.d目录下配置yum源地址\n<span class=\"token number\">2</span>、清空缓存建立新的缓存\n<span class=\"token number\">3</span>、安装软件（自动解决依赖关系）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum常用的基础命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 安装软件包的命令</span>\nyum <span class=\"token function\">install</span> 软件包名称\n\t-y <span class=\"token builtin class-name\">:</span> 免交互安装\n\n<span class=\"token comment\"># 卸载软件（直接将软件的依赖包一起删除）</span>\nyum remove 软件包名称\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove httpd</span>\n\t-y <span class=\"token builtin class-name\">:</span> 免交互移除\n\n<span class=\"token comment\"># 查看当前系统需要更新软件</span>\nyum check-update\n\n<span class=\"token comment\"># 更新所有的需要更新的软件</span>\nyum update \n\t-y ： 免交互\n\n<span class=\"token comment\"># 更新某一个软件</span>\nyum update <span class=\"token punctuation\">(</span>软件包名称<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 重装软件</span>\nyum reinstall <span class=\"token punctuation\">(</span>软件包名称<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 搜索软件包</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum search （软件包名称）</span>\n-------------------------------------------------------\n\n<span class=\"token comment\"># 查看yum执行历史</span>\nyum <span class=\"token function\">history</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum history info (历史ID号)</span>\n<span class=\"token punctuation\">[</span>root@www httpd<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum history undo (历史ID号)</span>\n<span class=\"token comment\"># 查看当前系统当中可更新的软件包</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum check-update </span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n\npostfix.x86_64                                        <span class=\"token number\">2</span>:2.10.1-9.0.1.el7.centos.plus                                      centosplus\npython-perf.x86_64                                    <span class=\"token number\">3.10</span>.0-1160.15.2.el7.centos.plus                                    centosplus\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n\n<span class=\"token comment\"># 查看系统中有哪些仓库地址</span>\nyum repolist    <span class=\"token comment\"># 正在启用的yum仓库</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                   repo name                                           status\nbase/7/x86_64             CentOS-7 - Base - repo.huaweicloud.com              <span class=\"token number\">10,072</span>\nextras/7/x86_64           CentOS-7 - Extras - repo.huaweicloud.com               <span class=\"token number\">453</span>\nupdates/7/x86_64          CentOS-7 - Updates - repo.huaweicloud.com            <span class=\"token number\">1,729</span>\n\nyum repolist all <span class=\"token comment\"># 查看系统中所有的yum仓库</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum repolist all</span>\nLoaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\nrepo <span class=\"token function\">id</span>                                        repo name                                                             status\nbase/7/x86_64                                  CentOS-7 - Base - repo.huaweicloud.com                                enabled: <span class=\"token number\">10,072</span>\ncentosplus/7/x86_64                            CentOS-7 - Plus - repo.huaweicloud.com                                disabled\nextras/7/x86_64                                CentOS-7 - Extras - repo.huaweicloud.com                              enabled:    <span class=\"token number\">453</span>\nupdates/7/x86_64                               CentOS-7 - Updates - repo.huaweicloud.com                             enabled:  <span class=\"token number\">1,72</span>\n\n\n<span class=\"token comment\"># 启用repo仓库</span>\nyum <span class=\"token function\">install</span> yum-utils -y\n\n启用一个yum仓库：yum-config-manager --enable <span class=\"token punctuation\">(</span>仓库名称<span class=\"token punctuation\">)</span>\n关闭一个yum仓库：yum-config-manager --disable <span class=\"token punctuation\">(</span>仓库名称<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 查看一个仓库中的软件包列表</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum list</span>\n\n<span class=\"token comment\"># 查看软件包组</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum grouplist</span>\n\n<span class=\"token comment\"># 安装软件包组</span>\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum groupinstall \"Development Tools\"</span>\n\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>本地yum源配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、备份/etc/yum.repos.d/下的所文件\n\t<span class=\"token function\">rm</span> -rf /etc/yum.repos.d/*\n\n<span class=\"token number\">2</span>、编写本地yum源\n<span class=\"token punctuation\">[</span>root@www yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat test.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span> <span class=\"token comment\"># yum源名称</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is repo infomation\"</span> <span class=\"token comment\">#yum源的简介</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>file:///opt    <span class=\"token comment\"># 指定yum源地址</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t\t<span class=\"token comment\"># 是否启用yum源</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\t\t\t\t<span class=\"token comment\"># 是否检查gpg秘钥</span>\n\n<span class=\"token number\">3</span>、更新缓存\nyum makecache\n\n<span class=\"token number\">4</span>、安装软件\nyum <span class=\"token function\">install</span> dos2unix<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>共享yum源配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、安装ftp\nyum <span class=\"token function\">install</span> vsftpd -y\n\n<span class=\"token number\">2</span>、启动vsftpd\nsystemctl <span class=\"token builtin class-name\">enable</span> --now vsftpd <span class=\"token comment\"># 设置开机自启动并且立即启动</span>\n\n<span class=\"token number\">3</span>、创建yum源共享文件夹\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /var/ftp/centos</span>\n\n<span class=\"token number\">4</span>、将映像中的软件复制到/var/ftp/centos\n<span class=\"token function\">cp</span> -rp /opt/* /var/ftp/centos\n\n<span class=\"token number\">5</span>、编辑本地yum源，接入ftp\n<span class=\"token punctuation\">[</span>root@localhost yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://192.168.15.100/centos\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp repo\"</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token number\">6</span>、测试安装\nyum <span class=\"token function\">install</span> dos2unix -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>yum的配置</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># yum仓库的机器上执行</span>\n<span class=\"token number\">1</span>、修改/etc/yum.conf\n    <span class=\"token assign-left variable\">cachedir</span><span class=\"token operator\">=</span>/var/ftp/centos/Packages   <span class=\"token comment\"># 指定yum缓存目录</span>\n    <span class=\"token assign-left variable\">keepcache</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t\t\t\t\t<span class=\"token comment\"># 下载的缓存软件不立即删除， 0为立即删除</span>\n\n<span class=\"token number\">2</span>、安装ftp\nyum <span class=\"token function\">install</span> vsftpd -y\n\n<span class=\"token number\">3</span>、启动vsftpd\nsystemctl <span class=\"token builtin class-name\">enable</span> --now vsftpd <span class=\"token comment\"># 设置开机自启动并且立即启动</span>\n\n<span class=\"token number\">4</span>、创建yum源共享文件夹\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /var/ftp/centos</span>\n\n<span class=\"token number\">5</span>、更新yum仓库\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">6</span>、建立一个快捷方式\n<span class=\"token builtin class-name\">cd</span> /var/ftp/centos/Packages/base\n<span class=\"token function\">ln</span> -s packages Packages\n\n<span class=\"token number\">7</span>、安装mariadb\nyum <span class=\"token function\">install</span> mariadb -y\n\n<span class=\"token number\">8</span>、建立/var/ftp/centos/Packages/base/repodata\n<span class=\"token function\">mkdir</span> /var/ftp/centos/Packages/base/repodata\n\n<span class=\"token number\">9</span>、把/var/ftp/centos/Packages/base下面的自动生成的压缩文件复制到/var/ftp/centos/Packages/base/repodata用做认证。\n\n<span class=\"token comment\"># 使用yum仓库的机器上执行</span>\n<span class=\"token number\">1</span>、建立yum配置文件\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/yum.repos.d/local.repo </span>\n<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://192.168.15.100/centos/Packages/base\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp repo\"</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token number\">2</span>、更新yum仓库\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@www ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">3</span>、测试安装mariadb\nyum <span class=\"token function\">install</span> mariadb -y<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n"},{"title":"运维之基础命令--yum仓库","date":"2022-07-06T03:19:52.000Z","_content":"\n# yum仓库\n\n1、克隆两台主机\n\n```bash\nyum仓库主机\n\t外网地址：192.168.15.30\n\t内网地址：172.16.1.30\n\nyum测试主机\n\t外网地址：192.168.15.31\n\t内网地址：172.16.1.31\n\n修改的命令：\n\tvim /etc/sysconfig/network-scripts/ifcfg-eth0\n\tvim /etc/sysconfig/network-scripts/ifcfg-eth1\n\t\n\t重启网卡：systemctl restart network\n\t\n\t修改主机名：\n\t\tyum仓库主机：hostnamectl set-hostname warehouse\n\t\tyum测试主机：hostnamectl set-hostname yum-test\n\t\n```\n\n2、配置yum仓库\n\n```bash\n1、需要有一个软件包目录，存放软件包的\n[root@warehouse ~]# mkdir /backup\n\t\n\t1.1、缓存yum安装下载的软件包\n\t[root@warehouse 7]# vim /etc/yum.conf\n\t[main]\n    cachedir=/var/cache/yum/$basearch/$releasever\n    keepcache=1\n    [root@warehouse ~]# yum install mariadb -y\n\t\n\t1.2、将缓存的软件包复制到yum仓库目录\n\t[root@warehouse ~]# cd /var/cache/yum/x86_64/7/base/packages/\n\t[root@warehouse packages]# cp -rp ./* /backup/\n    [root@warehouse packages]# cd /backup/\n    [root@warehouse backup]# ll\n    total 8964\n    -rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n\t\n2、建立软件包依赖关系\n\t[root@warehouse backup]# yum install createrepo -y\n\t[root@warehouse backup]# createrepo /backup/\n    Spawning worker 0 with 1 pkgs\n    Spawning worker 1 with 0 pkgs\n    Workers Finished\n    Saving Primary metadata\n    Saving file lists metadata\n    Saving other metadata\n    Generating sqlite DBs\n    Sqlite DBs complete\n    [root@warehouse backup]# ll\n    total 8968\n    -rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n    drwxr-xr-x 2 root root    4096 Mar 18 08:54 repodata\n    [root@warehouse backup]# ll repodata/\n    total 28\n    -rw-r--r-- 1 root root 1970 Mar 18 08:54 5d54624b2aa7a1fe974ff5553a9a78289683189c6a7b60c8c1421ecf011d270f-other.sqlite.bz2\n    -rw-r--r-- 1 root root 3449 Mar 18 08:54 5e68ee34f7e8f1a11a039f55c990bcc044f16bceb6af7f4486b55d518ad91346-primary.sqlite.bz2\n    -rw-r--r-- 1 root root  539 Mar 18 08:54 6e94b0fa1d98955542fb8238348ea171be7a130ba97573eb3ac756e1aadcec50-filelists.xml.gz\n    -rw-r--r-- 1 root root 1291 Mar 18 08:54 a9afb0b2457f41f5c2d64744a07d5d12599e6c2588c870ae73568cf345a0abca-other.xml.gz\n    -rw-r--r-- 1 root root 1333 Mar 18 08:54 cf41627875b17ef4bea5f0ea566ac63a5c83adc606d3ca730a74944ceb969028-primary.xml.gz\n    -rw-r--r-- 1 root root 1158 Mar 18 08:54 f34cbfd9e5608e8402041e98100f853e913f3df04d6946874c73ba31a78969ba-filelists.sqlite.bz2\n    -rw-r--r-- 1 root root 2969 Mar 18 08:54 repomd.xml\n    [root@warehouse backup]# \n```\n\n3、测试连接（本地版本）\n\n```bash\n1、备份系统所有的yum源\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mkdir backup1\n[root@warehouse yum.repos.d]# mv *.repo backup1\n[root@warehouse yum.repos.d]# vim local.repo\n[local]\nname=\"This is xxx\"\nbaseurl=file:///backup\ngpgcheck=0\nenabled=1\n\n# 清理yum缓存\n[root@warehouse ~]# yum clean all\n[root@warehouse ~]# rm -rf /var/cache/yum/x86_64/7/*\n\n# 生成新的yum缓存\n[root@warehouse ~]# yum makecache\n\n# 测试连接\n[root@warehouse yum.repos.d]# rpm -e mariadb\n[root@warehouse yum.repos.d]# rpm -ql mariadb\npackage mariadb is not installed\n[root@warehouse yum.repos.d]# yum install mariadb\n```\n\n\n\n4、测试连接（远程版本）\n\n```bash\n#########################  yum仓库机器上执行  ###################################\n1、备份系统所有的yum源\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mkdir local\n[root@warehouse yum.repos.d]# mv *.repo local\n\n2、安装远程访问软件\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mv backup1/*  .\n[root@warehouse yum.repos.d]# yum install vsftpd -y\n[root@warehouse yum.repos.d]# systemctl enable --now vsftpd \nCreated symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.\n\n3、配置系统yum仓库\n[root@warehouse yum.repos.d]# cd /var/ftp\n[root@warehouse ftp]# mkdir yum_warehouse\n\n4、将软件包复制到yum仓库目录\n[root@warehouse ftp]# cp -rp /backup/* /var/ftp/yum_warehouse/\n[root@warehouse ftp]# ll yum_warehouse/\ntotal 8968\n-rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\ndrwxr-xr-x 2 root root    4096 Mar 18 08:54 repodata\n\n5、建立yum软件包依赖关系\n[root@warehouse ftp]# createrepo /var/ftp/yum_warehouse/\n\n\n#########################  yum测试机器上执行  ###################################\n1、本机测试网络连接\n    1、备份系统所有的yum源\n    [root@warehouse ftp]# cd /etc/yum.repos.d/\n    [root@warehouse yum.repos.d]# mv *.repo backup1\n    [root@warehouse yum.repos.d]# vim local.repo\n    [root@warehouse yum.repos.d]# cat local.repo \n    [local-ftp]\n    name=\"This is ftp server\"\n    baseurl=ftp://172.16.1.30/yum_warehouse\n    gpgcheck=0\n    enabled=1\n\n    # 清理yum缓存\n    [root@warehouse ~]# yum clean all\n    [root@warehouse ~]# rm -rf /var/cache/yum/x86_64/7/*\n\n    # 生成新的yum缓存\n    [root@warehouse ~]# yum makecache\n\n    # 测试连接\n    [root@warehouse yum.repos.d]# rpm -e mariadb\n    [root@warehouse yum.repos.d]# rpm -ql mariadb\n    package mariadb is not installed\n    [root@warehouse yum.repos.d]# yum install mariadb\n\n2、yum测试机器执行\n\t1、备份yum仓库内容\n\t[root@yum-test ~]# cd /etc/yum.repos.d/\n    [root@yum-test yum.repos.d]# mkdir backup1\n    [root@yum-test yum.repos.d]# mv *.repo backup1\n    [root@yum-test yum.repos.d]# ll\n    total 0\n    drwxr-xr-x. 2 root root 187 Mar  4 09:55 backup\n    drwxr-xr-x  2 root root 220 Mar 18 09:20 backup1\n    [root@yum-test yum.repos.d]# \n    \n    2、编写本地yum源配置文件\n    [root@yum-test yum.repos.d]# vim local.repo\n    [root@yum-test yum.repos.d]# cat local.repo \n    [loacl-ftp-30]\n    name=\"This is 30 ftp server\"\n    baseurl=ftp://172.16.1.30/yum_warehouse\n    gpgcheck=0\n    enabled=1\n    \n    3、清理yum缓存\n    [root@yum-test yum.repos.d]# yum clean all\n    [root@yum-test yum.repos.d]# rm -rf /var/cache/yum/x86_64/7/*\n    \n    4、生成yum缓存\n    [root@yum-test yum.repos.d]# yum makecache\n    \n    5、测试安装\n    [root@yum-test yum.repos.d]# yum install mariadb\n```\n\n\n\n4、同步远程yum仓库内容到本机\n\n```bash\n1、安装华为云镜像仓库\n[root@warehouse yum.repos.d]# rm -rf /etc/yum.repos.d/*\n[root@warehouse yum.repos.d]# wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo\n\n2、生成yum缓存\n[root@warehouse yum.repos.d]# yum clean all\n[root@warehouse yum.repos.d]# rm -rf /var/cache/yum/x86_64/7/*\n[root@warehouse yum.repos.d]# yum makecache\n\n3、同步华为云镜像站软件包到本地yum仓库\n[root@warehouse ftp]# yum install yum-utils -y\n[root@warehouse ftp]# reposync -r (仓库名称：yum repolist)\n\n4、建立依赖关系\n[root@warehouse ftp]# createrepo base\n\n5、测试\n    [loacl-ftp-30]\n    name=\"This is 30 ftp server\"\n    baseurl=ftp://172.16.1.30/base\n    gpgcheck=0\n    enabled=1\n```\n\n![image-20210318112338781](.\\assets\\image-20210318112338781.png)\n\n\n\n\n\n","source":"_posts/01_运维/01-基础命令/day13-yum仓库/yum仓库.md","raw":"---\ntitle: 运维之基础命令--yum仓库\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# yum仓库\n\n1、克隆两台主机\n\n```bash\nyum仓库主机\n\t外网地址：192.168.15.30\n\t内网地址：172.16.1.30\n\nyum测试主机\n\t外网地址：192.168.15.31\n\t内网地址：172.16.1.31\n\n修改的命令：\n\tvim /etc/sysconfig/network-scripts/ifcfg-eth0\n\tvim /etc/sysconfig/network-scripts/ifcfg-eth1\n\t\n\t重启网卡：systemctl restart network\n\t\n\t修改主机名：\n\t\tyum仓库主机：hostnamectl set-hostname warehouse\n\t\tyum测试主机：hostnamectl set-hostname yum-test\n\t\n```\n\n2、配置yum仓库\n\n```bash\n1、需要有一个软件包目录，存放软件包的\n[root@warehouse ~]# mkdir /backup\n\t\n\t1.1、缓存yum安装下载的软件包\n\t[root@warehouse 7]# vim /etc/yum.conf\n\t[main]\n    cachedir=/var/cache/yum/$basearch/$releasever\n    keepcache=1\n    [root@warehouse ~]# yum install mariadb -y\n\t\n\t1.2、将缓存的软件包复制到yum仓库目录\n\t[root@warehouse ~]# cd /var/cache/yum/x86_64/7/base/packages/\n\t[root@warehouse packages]# cp -rp ./* /backup/\n    [root@warehouse packages]# cd /backup/\n    [root@warehouse backup]# ll\n    total 8964\n    -rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n\t\n2、建立软件包依赖关系\n\t[root@warehouse backup]# yum install createrepo -y\n\t[root@warehouse backup]# createrepo /backup/\n    Spawning worker 0 with 1 pkgs\n    Spawning worker 1 with 0 pkgs\n    Workers Finished\n    Saving Primary metadata\n    Saving file lists metadata\n    Saving other metadata\n    Generating sqlite DBs\n    Sqlite DBs complete\n    [root@warehouse backup]# ll\n    total 8968\n    -rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n    drwxr-xr-x 2 root root    4096 Mar 18 08:54 repodata\n    [root@warehouse backup]# ll repodata/\n    total 28\n    -rw-r--r-- 1 root root 1970 Mar 18 08:54 5d54624b2aa7a1fe974ff5553a9a78289683189c6a7b60c8c1421ecf011d270f-other.sqlite.bz2\n    -rw-r--r-- 1 root root 3449 Mar 18 08:54 5e68ee34f7e8f1a11a039f55c990bcc044f16bceb6af7f4486b55d518ad91346-primary.sqlite.bz2\n    -rw-r--r-- 1 root root  539 Mar 18 08:54 6e94b0fa1d98955542fb8238348ea171be7a130ba97573eb3ac756e1aadcec50-filelists.xml.gz\n    -rw-r--r-- 1 root root 1291 Mar 18 08:54 a9afb0b2457f41f5c2d64744a07d5d12599e6c2588c870ae73568cf345a0abca-other.xml.gz\n    -rw-r--r-- 1 root root 1333 Mar 18 08:54 cf41627875b17ef4bea5f0ea566ac63a5c83adc606d3ca730a74944ceb969028-primary.xml.gz\n    -rw-r--r-- 1 root root 1158 Mar 18 08:54 f34cbfd9e5608e8402041e98100f853e913f3df04d6946874c73ba31a78969ba-filelists.sqlite.bz2\n    -rw-r--r-- 1 root root 2969 Mar 18 08:54 repomd.xml\n    [root@warehouse backup]# \n```\n\n3、测试连接（本地版本）\n\n```bash\n1、备份系统所有的yum源\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mkdir backup1\n[root@warehouse yum.repos.d]# mv *.repo backup1\n[root@warehouse yum.repos.d]# vim local.repo\n[local]\nname=\"This is xxx\"\nbaseurl=file:///backup\ngpgcheck=0\nenabled=1\n\n# 清理yum缓存\n[root@warehouse ~]# yum clean all\n[root@warehouse ~]# rm -rf /var/cache/yum/x86_64/7/*\n\n# 生成新的yum缓存\n[root@warehouse ~]# yum makecache\n\n# 测试连接\n[root@warehouse yum.repos.d]# rpm -e mariadb\n[root@warehouse yum.repos.d]# rpm -ql mariadb\npackage mariadb is not installed\n[root@warehouse yum.repos.d]# yum install mariadb\n```\n\n\n\n4、测试连接（远程版本）\n\n```bash\n#########################  yum仓库机器上执行  ###################################\n1、备份系统所有的yum源\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mkdir local\n[root@warehouse yum.repos.d]# mv *.repo local\n\n2、安装远程访问软件\n[root@warehouse yum.repos.d]# cd /etc/yum.repos.d/\n[root@warehouse yum.repos.d]# mv backup1/*  .\n[root@warehouse yum.repos.d]# yum install vsftpd -y\n[root@warehouse yum.repos.d]# systemctl enable --now vsftpd \nCreated symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.\n\n3、配置系统yum仓库\n[root@warehouse yum.repos.d]# cd /var/ftp\n[root@warehouse ftp]# mkdir yum_warehouse\n\n4、将软件包复制到yum仓库目录\n[root@warehouse ftp]# cp -rp /backup/* /var/ftp/yum_warehouse/\n[root@warehouse ftp]# ll yum_warehouse/\ntotal 8968\n-rw-r--r-- 1 root root 9175948 Oct 15 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\ndrwxr-xr-x 2 root root    4096 Mar 18 08:54 repodata\n\n5、建立yum软件包依赖关系\n[root@warehouse ftp]# createrepo /var/ftp/yum_warehouse/\n\n\n#########################  yum测试机器上执行  ###################################\n1、本机测试网络连接\n    1、备份系统所有的yum源\n    [root@warehouse ftp]# cd /etc/yum.repos.d/\n    [root@warehouse yum.repos.d]# mv *.repo backup1\n    [root@warehouse yum.repos.d]# vim local.repo\n    [root@warehouse yum.repos.d]# cat local.repo \n    [local-ftp]\n    name=\"This is ftp server\"\n    baseurl=ftp://172.16.1.30/yum_warehouse\n    gpgcheck=0\n    enabled=1\n\n    # 清理yum缓存\n    [root@warehouse ~]# yum clean all\n    [root@warehouse ~]# rm -rf /var/cache/yum/x86_64/7/*\n\n    # 生成新的yum缓存\n    [root@warehouse ~]# yum makecache\n\n    # 测试连接\n    [root@warehouse yum.repos.d]# rpm -e mariadb\n    [root@warehouse yum.repos.d]# rpm -ql mariadb\n    package mariadb is not installed\n    [root@warehouse yum.repos.d]# yum install mariadb\n\n2、yum测试机器执行\n\t1、备份yum仓库内容\n\t[root@yum-test ~]# cd /etc/yum.repos.d/\n    [root@yum-test yum.repos.d]# mkdir backup1\n    [root@yum-test yum.repos.d]# mv *.repo backup1\n    [root@yum-test yum.repos.d]# ll\n    total 0\n    drwxr-xr-x. 2 root root 187 Mar  4 09:55 backup\n    drwxr-xr-x  2 root root 220 Mar 18 09:20 backup1\n    [root@yum-test yum.repos.d]# \n    \n    2、编写本地yum源配置文件\n    [root@yum-test yum.repos.d]# vim local.repo\n    [root@yum-test yum.repos.d]# cat local.repo \n    [loacl-ftp-30]\n    name=\"This is 30 ftp server\"\n    baseurl=ftp://172.16.1.30/yum_warehouse\n    gpgcheck=0\n    enabled=1\n    \n    3、清理yum缓存\n    [root@yum-test yum.repos.d]# yum clean all\n    [root@yum-test yum.repos.d]# rm -rf /var/cache/yum/x86_64/7/*\n    \n    4、生成yum缓存\n    [root@yum-test yum.repos.d]# yum makecache\n    \n    5、测试安装\n    [root@yum-test yum.repos.d]# yum install mariadb\n```\n\n\n\n4、同步远程yum仓库内容到本机\n\n```bash\n1、安装华为云镜像仓库\n[root@warehouse yum.repos.d]# rm -rf /etc/yum.repos.d/*\n[root@warehouse yum.repos.d]# wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo\n\n2、生成yum缓存\n[root@warehouse yum.repos.d]# yum clean all\n[root@warehouse yum.repos.d]# rm -rf /var/cache/yum/x86_64/7/*\n[root@warehouse yum.repos.d]# yum makecache\n\n3、同步华为云镜像站软件包到本地yum仓库\n[root@warehouse ftp]# yum install yum-utils -y\n[root@warehouse ftp]# reposync -r (仓库名称：yum repolist)\n\n4、建立依赖关系\n[root@warehouse ftp]# createrepo base\n\n5、测试\n    [loacl-ftp-30]\n    name=\"This is 30 ftp server\"\n    baseurl=ftp://172.16.1.30/base\n    gpgcheck=0\n    enabled=1\n```\n\n![image-20210318112338781](.\\assets\\image-20210318112338781.png)\n\n\n\n\n\n","slug":"01_运维/01-基础命令/day13-yum仓库/yum仓库","published":1,"updated":"2022-07-06T07:14:09.239Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1f0037a8v70dmi7ayd","content":"<h1 id=\"yum仓库\"><a href=\"#yum仓库\" class=\"headerlink\" title=\"yum仓库\"></a>yum仓库</h1><p>1、克隆两台主机</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">yum仓库主机\n\t外网地址：192.168.15.30\n\t内网地址：172.16.1.30\n\nyum测试主机\n\t外网地址：192.168.15.31\n\t内网地址：172.16.1.31\n\n修改的命令：\n\t<span class=\"token function\">vim</span> /etc/sysconfig/network-scripts/ifcfg-eth0\n\t<span class=\"token function\">vim</span> /etc/sysconfig/network-scripts/ifcfg-eth1\n\t\n\t重启网卡：systemctl restart network\n\t\n\t修改主机名：\n\t\tyum仓库主机：hostnamectl set-hostname warehouse\n\t\tyum测试主机：hostnamectl set-hostname yum-test\n\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、配置yum仓库</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、需要有一个软件包目录，存放软件包的\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /backup</span>\n\t\n\t<span class=\"token number\">1.1</span>、缓存yum安装下载的软件包\n\t<span class=\"token punctuation\">[</span>root@warehouse <span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/yum.conf</span>\n\t<span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">cachedir</span><span class=\"token operator\">=</span>/var/cache/yum/<span class=\"token variable\">$basearch</span>/<span class=\"token variable\">$releasever</span>\n    <span class=\"token assign-left variable\">keepcache</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb -y</span>\n\t\n\t<span class=\"token number\">1.2</span>、将缓存的软件包复制到yum仓库目录\n\t<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /var/cache/yum/x86_64/7/base/packages/</span>\n\t<span class=\"token punctuation\">[</span>root@warehouse packages<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -rp ./* /backup/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse packages<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /backup/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">8964</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n\t\n<span class=\"token number\">2</span>、建立软件包依赖关系\n\t<span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install createrepo -y</span>\n\t<span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo /backup/</span>\n    Spawning worker <span class=\"token number\">0</span> with <span class=\"token number\">1</span> pkgs\n    Spawning worker <span class=\"token number\">1</span> with <span class=\"token number\">0</span> pkgs\n    Workers Finished\n    Saving Primary metadata\n    Saving <span class=\"token function\">file</span> lists metadata\n    Saving other metadata\n    Generating sqlite DBs\n    Sqlite DBs complete\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">8968</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n    drwxr-xr-x <span class=\"token number\">2</span> root root    <span class=\"token number\">4096</span> Mar <span class=\"token number\">18</span> 08:54 repodata\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll repodata/</span>\n    total <span class=\"token number\">28</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1970</span> Mar <span class=\"token number\">18</span> 08:54 5d54624b2aa7a1fe974ff5553a9a78289683189c6a7b60c8c1421ecf011d270f-other.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">3449</span> Mar <span class=\"token number\">18</span> 08:54 5e68ee34f7e8f1a11a039f55c990bcc044f16bceb6af7f4486b55d518ad91346-primary.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">539</span> Mar <span class=\"token number\">18</span> 08:54 6e94b0fa1d98955542fb8238348ea171be7a130ba97573eb3ac756e1aadcec50-filelists.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1291</span> Mar <span class=\"token number\">18</span> 08:54 a9afb0b2457f41f5c2d64744a07d5d12599e6c2588c870ae73568cf345a0abca-other.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1333</span> Mar <span class=\"token number\">18</span> 08:54 cf41627875b17ef4bea5f0ea566ac63a5c83adc606d3ca730a74944ceb969028-primary.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1158</span> Mar <span class=\"token number\">18</span> 08:54 f34cbfd9e5608e8402041e98100f853e913f3df04d6946874c73ba31a78969ba-filelists.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">2969</span> Mar <span class=\"token number\">18</span> 08:54 repomd.xml\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、测试连接（本地版本）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、备份系统所有的yum源\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir backup1</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n<span class=\"token punctuation\">[</span>local<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is xxx\"</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>file:///backup\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n<span class=\"token comment\"># 清理yum缓存</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n\n<span class=\"token comment\"># 生成新的yum缓存</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token comment\"># 测试连接</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e mariadb</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql mariadb</span>\npackage mariadb is not installed\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>4、测试连接（远程版本）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\">#########################  yum仓库机器上执行  ###################################</span>\n<span class=\"token number\">1</span>、备份系统所有的yum源\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir local</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo local</span>\n\n<span class=\"token number\">2</span>、安装远程访问软件\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv backup1/*  .</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install vsftpd -y</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now vsftpd </span>\nCreated symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.\n\n<span class=\"token number\">3</span>、配置系统yum仓库\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /var/ftp</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir yum_warehouse</span>\n\n<span class=\"token number\">4</span>、将软件包复制到yum仓库目录\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -rp /backup/* /var/ftp/yum_warehouse/</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll yum_warehouse/</span>\ntotal <span class=\"token number\">8968</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\ndrwxr-xr-x <span class=\"token number\">2</span> root root    <span class=\"token number\">4096</span> Mar <span class=\"token number\">18</span> 08:54 repodata\n\n<span class=\"token number\">5</span>、建立yum软件包依赖关系\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo /var/ftp/yum_warehouse/</span>\n\n\n<span class=\"token comment\">#########################  yum测试机器上执行  ###################################</span>\n<span class=\"token number\">1</span>、本机测试网络连接\n    <span class=\"token number\">1</span>、备份系统所有的yum源\n    <span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n    <span class=\"token punctuation\">[</span>local-ftp<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/yum_warehouse\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n    <span class=\"token comment\"># 清理yum缓存</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n\n    <span class=\"token comment\"># 生成新的yum缓存</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n    <span class=\"token comment\"># 测试连接</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e mariadb</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql mariadb</span>\n    package mariadb is not installed\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span>\n\n<span class=\"token number\">2</span>、yum测试机器执行\n\t<span class=\"token number\">1</span>、备份yum仓库内容\n\t<span class=\"token punctuation\">[</span>root@yum-test ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir backup1</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">0</span>\n    drwxr-xr-x. <span class=\"token number\">2</span> root root <span class=\"token number\">187</span> Mar  <span class=\"token number\">4</span> 09:55 backup\n    drwxr-xr-x  <span class=\"token number\">2</span> root root <span class=\"token number\">220</span> Mar <span class=\"token number\">18</span> 09:20 backup1\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n    \n    <span class=\"token number\">2</span>、编写本地yum源配置文件\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n    <span class=\"token punctuation\">[</span>loacl-ftp-30<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is 30 ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/yum_warehouse\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    \n    <span class=\"token number\">3</span>、清理yum缓存\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n    \n    <span class=\"token number\">4</span>、生成yum缓存\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n    \n    <span class=\"token number\">5</span>、测试安装\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>4、同步远程yum仓库内容到本机</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、安装华为云镜像仓库\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /etc/yum.repos.d/*</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo</span>\n\n<span class=\"token number\">2</span>、生成yum缓存\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">3</span>、同步华为云镜像站软件包到本地yum仓库\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install yum-utils -y</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># reposync -r (仓库名称：yum repolist)</span>\n\n<span class=\"token number\">4</span>、建立依赖关系\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo base</span>\n\n<span class=\"token number\">5</span>、测试\n    <span class=\"token punctuation\">[</span>loacl-ftp-30<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is 30 ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/base\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/.%5Cassets%5Cimage-20210318112338781.png\" alt=\"image-20210318112338781\"></p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"yum仓库\"><a href=\"#yum仓库\" class=\"headerlink\" title=\"yum仓库\"></a>yum仓库</h1><p>1、克隆两台主机</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">yum仓库主机\n\t外网地址：192.168.15.30\n\t内网地址：172.16.1.30\n\nyum测试主机\n\t外网地址：192.168.15.31\n\t内网地址：172.16.1.31\n\n修改的命令：\n\t<span class=\"token function\">vim</span> /etc/sysconfig/network-scripts/ifcfg-eth0\n\t<span class=\"token function\">vim</span> /etc/sysconfig/network-scripts/ifcfg-eth1\n\t\n\t重启网卡：systemctl restart network\n\t\n\t修改主机名：\n\t\tyum仓库主机：hostnamectl set-hostname warehouse\n\t\tyum测试主机：hostnamectl set-hostname yum-test\n\t<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、配置yum仓库</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、需要有一个软件包目录，存放软件包的\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /backup</span>\n\t\n\t<span class=\"token number\">1.1</span>、缓存yum安装下载的软件包\n\t<span class=\"token punctuation\">[</span>root@warehouse <span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/yum.conf</span>\n\t<span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">cachedir</span><span class=\"token operator\">=</span>/var/cache/yum/<span class=\"token variable\">$basearch</span>/<span class=\"token variable\">$releasever</span>\n    <span class=\"token assign-left variable\">keepcache</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb -y</span>\n\t\n\t<span class=\"token number\">1.2</span>、将缓存的软件包复制到yum仓库目录\n\t<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /var/cache/yum/x86_64/7/base/packages/</span>\n\t<span class=\"token punctuation\">[</span>root@warehouse packages<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -rp ./* /backup/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse packages<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /backup/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">8964</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n\t\n<span class=\"token number\">2</span>、建立软件包依赖关系\n\t<span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install createrepo -y</span>\n\t<span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo /backup/</span>\n    Spawning worker <span class=\"token number\">0</span> with <span class=\"token number\">1</span> pkgs\n    Spawning worker <span class=\"token number\">1</span> with <span class=\"token number\">0</span> pkgs\n    Workers Finished\n    Saving Primary metadata\n    Saving <span class=\"token function\">file</span> lists metadata\n    Saving other metadata\n    Generating sqlite DBs\n    Sqlite DBs complete\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">8968</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\n    drwxr-xr-x <span class=\"token number\">2</span> root root    <span class=\"token number\">4096</span> Mar <span class=\"token number\">18</span> 08:54 repodata\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll repodata/</span>\n    total <span class=\"token number\">28</span>\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1970</span> Mar <span class=\"token number\">18</span> 08:54 5d54624b2aa7a1fe974ff5553a9a78289683189c6a7b60c8c1421ecf011d270f-other.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">3449</span> Mar <span class=\"token number\">18</span> 08:54 5e68ee34f7e8f1a11a039f55c990bcc044f16bceb6af7f4486b55d518ad91346-primary.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root  <span class=\"token number\">539</span> Mar <span class=\"token number\">18</span> 08:54 6e94b0fa1d98955542fb8238348ea171be7a130ba97573eb3ac756e1aadcec50-filelists.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1291</span> Mar <span class=\"token number\">18</span> 08:54 a9afb0b2457f41f5c2d64744a07d5d12599e6c2588c870ae73568cf345a0abca-other.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1333</span> Mar <span class=\"token number\">18</span> 08:54 cf41627875b17ef4bea5f0ea566ac63a5c83adc606d3ca730a74944ceb969028-primary.xml.gz\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">1158</span> Mar <span class=\"token number\">18</span> 08:54 f34cbfd9e5608e8402041e98100f853e913f3df04d6946874c73ba31a78969ba-filelists.sqlite.bz2\n    -rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">2969</span> Mar <span class=\"token number\">18</span> 08:54 repomd.xml\n    <span class=\"token punctuation\">[</span>root@warehouse backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、测试连接（本地版本）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、备份系统所有的yum源\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir backup1</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n<span class=\"token punctuation\">[</span>local<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is xxx\"</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>file:///backup\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n<span class=\"token comment\"># 清理yum缓存</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n\n<span class=\"token comment\"># 生成新的yum缓存</span>\n<span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token comment\"># 测试连接</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e mariadb</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql mariadb</span>\npackage mariadb is not installed\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>4、测试连接（远程版本）</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\">#########################  yum仓库机器上执行  ###################################</span>\n<span class=\"token number\">1</span>、备份系统所有的yum源\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir local</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo local</span>\n\n<span class=\"token number\">2</span>、安装远程访问软件\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv backup1/*  .</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install vsftpd -y</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now vsftpd </span>\nCreated symlink from /etc/systemd/system/multi-user.target.wants/vsftpd.service to /usr/lib/systemd/system/vsftpd.service.\n\n<span class=\"token number\">3</span>、配置系统yum仓库\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /var/ftp</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir yum_warehouse</span>\n\n<span class=\"token number\">4</span>、将软件包复制到yum仓库目录\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -rp /backup/* /var/ftp/yum_warehouse/</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll yum_warehouse/</span>\ntotal <span class=\"token number\">8968</span>\n-rw-r--r-- <span class=\"token number\">1</span> root root <span class=\"token number\">9175948</span> Oct <span class=\"token number\">15</span> 02:55 mariadb-5.5.68-1.el7.x86_64.rpm\ndrwxr-xr-x <span class=\"token number\">2</span> root root    <span class=\"token number\">4096</span> Mar <span class=\"token number\">18</span> 08:54 repodata\n\n<span class=\"token number\">5</span>、建立yum软件包依赖关系\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo /var/ftp/yum_warehouse/</span>\n\n\n<span class=\"token comment\">#########################  yum测试机器上执行  ###################################</span>\n<span class=\"token number\">1</span>、本机测试网络连接\n    <span class=\"token number\">1</span>、备份系统所有的yum源\n    <span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n    <span class=\"token punctuation\">[</span>local-ftp<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/yum_warehouse\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n\n    <span class=\"token comment\"># 清理yum缓存</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n\n    <span class=\"token comment\"># 生成新的yum缓存</span>\n    <span class=\"token punctuation\">[</span>root@warehouse ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n    <span class=\"token comment\"># 测试连接</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -e mariadb</span>\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rpm -ql mariadb</span>\n    package mariadb is not installed\n    <span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span>\n\n<span class=\"token number\">2</span>、yum测试机器执行\n\t<span class=\"token number\">1</span>、备份yum仓库内容\n\t<span class=\"token punctuation\">[</span>root@yum-test ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/yum.repos.d/</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir backup1</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv *.repo backup1</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\n    total <span class=\"token number\">0</span>\n    drwxr-xr-x. <span class=\"token number\">2</span> root root <span class=\"token number\">187</span> Mar  <span class=\"token number\">4</span> 09:55 backup\n    drwxr-xr-x  <span class=\"token number\">2</span> root root <span class=\"token number\">220</span> Mar <span class=\"token number\">18</span> 09:20 backup1\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span>\n    \n    <span class=\"token number\">2</span>、编写本地yum源配置文件\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim local.repo</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat local.repo </span>\n    <span class=\"token punctuation\">[</span>loacl-ftp-30<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is 30 ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/yum_warehouse\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n    \n    <span class=\"token number\">3</span>、清理yum缓存\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n    \n    <span class=\"token number\">4</span>、生成yum缓存\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n    \n    <span class=\"token number\">5</span>、测试安装\n    <span class=\"token punctuation\">[</span>root@yum-test yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install mariadb</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>4、同步远程yum仓库内容到本机</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、安装华为云镜像仓库\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /etc/yum.repos.d/*</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget -O /etc/yum.repos.d/CentOS-Base.repo https://repo.huaweicloud.com/repository/conf/CentOS-7-reg.repo</span>\n\n<span class=\"token number\">2</span>、生成yum缓存\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum clean all</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /var/cache/yum/x86_64/7/*</span>\n<span class=\"token punctuation\">[</span>root@warehouse yum.repos.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum makecache</span>\n\n<span class=\"token number\">3</span>、同步华为云镜像站软件包到本地yum仓库\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install yum-utils -y</span>\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># reposync -r (仓库名称：yum repolist)</span>\n\n<span class=\"token number\">4</span>、建立依赖关系\n<span class=\"token punctuation\">[</span>root@warehouse ftp<span class=\"token punctuation\">]</span><span class=\"token comment\"># createrepo base</span>\n\n<span class=\"token number\">5</span>、测试\n    <span class=\"token punctuation\">[</span>loacl-ftp-30<span class=\"token punctuation\">]</span>\n    <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"This is 30 ftp server\"</span>\n    <span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>ftp://172.16.1.30/base\n    <span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"/.%5Cassets%5Cimage-20210318112338781.png\" alt=\"image-20210318112338781\"></p>\n"},{"title":"运维之基础命令--文件ACL","date":"2022-07-06T03:19:52.000Z","_content":"\n\n\n# 笔记\n\n\n\n> 补充：\n>\n> ​\t权限的归属\n>\n> ​\t\ta : 属组、属主以及其他人的权限一起设置。\n>\n> ​\t\to : 其他人\n>\n> ​\t\tg : 属组\n>\n> ​\t\tu : 属主\n\n\n\n## umask\n\n> 就是解决目录及文件的默认权限。\n\n- 文件的最高权限是多少     777\n- 文件夹的最高权限是多少  777\n\n\n\n## ACL \n\n> ACL是为了解决某种特殊环境下的，用户权限需求。\n\n- setfacl ： 设置acl权限\n- getfacl ：查看ACL权限\n\n### acl权限归属\n\n- u : 指定用户\n- g : 指定组\n- o : 修改其他用户权限\n- m : 指定mask权限\n\n\n\n注：默认情况下，ACL权限跟普通权限保持一致。\n\n\n\n## ACL 的流程\n\n- 1、创建文件\n\n  ```bash\n  chmod o+x /root\n  chmod o+x /root/xiaochen\n  cd xiaochen\n  \n  [root@localhost xiaochen]# touch abc.txt\n  [root@localhost xiaochen]# chmod 000 abc.txt \n  [root@localhost xiaochen]# ll\n  total 0\n  ---------- 1 root root 0 Mar 16 11:39 abc.txt\n  ```\n\n- 编写文件\n\n  ```bash\n  [root@localhost xiaochen]# echo 111 > abc.txt \n  [root@localhost xiaochen]# cat abc.txt \n  111\n  ```\n\n- 设置ACL权限\n\n  ```bash\n  [root@localhost xiaochen]# useradd xiaozhang\n  [root@localhost xiaochen]# setfacl -m u:xiaozhang:r abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaozhang:r--\n  group::---\n  mask::r--\n  other::---\n  \n  # 注：\n  setfacl -m u:用户名称:权限(rwx) 文件名称\n  ```\n\n- 查看文件\n\n  ```bash\n  [root@localhost ~]# su - xiaozhang\n  [xiaozhang@localhost ~]$ cat /root/xiaochen/abc.txt\n  111\n  ```\n\n  \n\nmask :  rw-\n\nxxxx :   -w-\n\n\n\n-w-\n\n\n\n\n\n## ACL权限的删除\n\n- 删除某个权限\n\n  ```bash\n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaozhang:r--\n  group::---\n  group:xiaochen:r-x\t\t#effective:r--\n  mask::rw-\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -x u:xiaozhang abc.txt\n  \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  group:xiaochen:r-x\n  mask::r-x\n  other::r--\n  \n  \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  group:xiaochen:r-x\n  mask::r-x\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -x g:xiaochen abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  mask::---\n  other::r--\n  \n  ```\n\n  \n\n- 清空acl权限\n\n  ```bash\n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaochen:rw-\n  user:xiaocao:rw-\n  group::---\n  group:xiaochen:rw-\n  group:xiaocao:rw-\n  mask::rw-\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -b abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  other::r--\n  \n  ```\n\n## ACL继承\n\n> 默认情况下，ACL是不会继承上层目录的权限的。只有目录设置可继承子集文件才可以继承ACL权限。\n\n```bash\n[root@localhost linux12]# setfacl -m d:u:xiaochen:w ../linux12\n[root@localhost linux12]# touch bcd.txt\n[root@localhost linux12]# ls -l\ntotal 0\n-rw-r--r--  1 root root 0 Mar 16 15:40 abc.txt\n-rw-rw-r--+ 1 root root 0 Mar 16 15:43 bcd.txt\n[root@localhost linux12]# getfacl bcd.txt \n# file: bcd.txt\n# owner: root\n# group: root\nuser::rw-\nuser:xiaochen:-w-\ngroup::r-x\t\t\t#effective:r--\nmask::rw-\nother::r--\n\n[root@localhost linux12]# \n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/01_运维/01-基础命令/day11-sudo与su/facl.md","raw":"---\ntitle: 运维之基础命令--文件ACL\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n\n\n# 笔记\n\n\n\n> 补充：\n>\n> ​\t权限的归属\n>\n> ​\t\ta : 属组、属主以及其他人的权限一起设置。\n>\n> ​\t\to : 其他人\n>\n> ​\t\tg : 属组\n>\n> ​\t\tu : 属主\n\n\n\n## umask\n\n> 就是解决目录及文件的默认权限。\n\n- 文件的最高权限是多少     777\n- 文件夹的最高权限是多少  777\n\n\n\n## ACL \n\n> ACL是为了解决某种特殊环境下的，用户权限需求。\n\n- setfacl ： 设置acl权限\n- getfacl ：查看ACL权限\n\n### acl权限归属\n\n- u : 指定用户\n- g : 指定组\n- o : 修改其他用户权限\n- m : 指定mask权限\n\n\n\n注：默认情况下，ACL权限跟普通权限保持一致。\n\n\n\n## ACL 的流程\n\n- 1、创建文件\n\n  ```bash\n  chmod o+x /root\n  chmod o+x /root/xiaochen\n  cd xiaochen\n  \n  [root@localhost xiaochen]# touch abc.txt\n  [root@localhost xiaochen]# chmod 000 abc.txt \n  [root@localhost xiaochen]# ll\n  total 0\n  ---------- 1 root root 0 Mar 16 11:39 abc.txt\n  ```\n\n- 编写文件\n\n  ```bash\n  [root@localhost xiaochen]# echo 111 > abc.txt \n  [root@localhost xiaochen]# cat abc.txt \n  111\n  ```\n\n- 设置ACL权限\n\n  ```bash\n  [root@localhost xiaochen]# useradd xiaozhang\n  [root@localhost xiaochen]# setfacl -m u:xiaozhang:r abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaozhang:r--\n  group::---\n  mask::r--\n  other::---\n  \n  # 注：\n  setfacl -m u:用户名称:权限(rwx) 文件名称\n  ```\n\n- 查看文件\n\n  ```bash\n  [root@localhost ~]# su - xiaozhang\n  [xiaozhang@localhost ~]$ cat /root/xiaochen/abc.txt\n  111\n  ```\n\n  \n\nmask :  rw-\n\nxxxx :   -w-\n\n\n\n-w-\n\n\n\n\n\n## ACL权限的删除\n\n- 删除某个权限\n\n  ```bash\n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaozhang:r--\n  group::---\n  group:xiaochen:r-x\t\t#effective:r--\n  mask::rw-\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -x u:xiaozhang abc.txt\n  \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  group:xiaochen:r-x\n  mask::r-x\n  other::r--\n  \n  \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  group:xiaochen:r-x\n  mask::r-x\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -x g:xiaochen abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  mask::---\n  other::r--\n  \n  ```\n\n  \n\n- 清空acl权限\n\n  ```bash\n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  user:xiaochen:rw-\n  user:xiaocao:rw-\n  group::---\n  group:xiaochen:rw-\n  group:xiaocao:rw-\n  mask::rw-\n  other::r--\n  \n  [root@localhost xiaochen]# setfacl -b abc.txt \n  [root@localhost xiaochen]# getfacl abc.txt \n  # file: abc.txt\n  # owner: root\n  # group: root\n  user::---\n  group::---\n  other::r--\n  \n  ```\n\n## ACL继承\n\n> 默认情况下，ACL是不会继承上层目录的权限的。只有目录设置可继承子集文件才可以继承ACL权限。\n\n```bash\n[root@localhost linux12]# setfacl -m d:u:xiaochen:w ../linux12\n[root@localhost linux12]# touch bcd.txt\n[root@localhost linux12]# ls -l\ntotal 0\n-rw-r--r--  1 root root 0 Mar 16 15:40 abc.txt\n-rw-rw-r--+ 1 root root 0 Mar 16 15:43 bcd.txt\n[root@localhost linux12]# getfacl bcd.txt \n# file: bcd.txt\n# owner: root\n# group: root\nuser::rw-\nuser:xiaochen:-w-\ngroup::r-x\t\t\t#effective:r--\nmask::rw-\nother::r--\n\n[root@localhost linux12]# \n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"01_运维/01-基础命令/day11-sudo与su/facl","published":1,"updated":"2022-07-06T07:13:53.865Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1g0039a8v731kkc23o","content":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><blockquote>\n<p>补充：</p>\n<p>​\t权限的归属</p>\n<p>​\t\ta : 属组、属主以及其他人的权限一起设置。</p>\n<p>​\t\to : 其他人</p>\n<p>​\t\tg : 属组</p>\n<p>​\t\tu : 属主</p>\n</blockquote>\n<h2 id=\"umask\"><a href=\"#umask\" class=\"headerlink\" title=\"umask\"></a>umask</h2><blockquote>\n<p>就是解决目录及文件的默认权限。</p>\n</blockquote>\n<ul>\n<li>文件的最高权限是多少     777</li>\n<li>文件夹的最高权限是多少  777</li>\n</ul>\n<h2 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h2><blockquote>\n<p>ACL是为了解决某种特殊环境下的，用户权限需求。</p>\n</blockquote>\n<ul>\n<li>setfacl ： 设置acl权限</li>\n<li>getfacl ：查看ACL权限</li>\n</ul>\n<h3 id=\"acl权限归属\"><a href=\"#acl权限归属\" class=\"headerlink\" title=\"acl权限归属\"></a>acl权限归属</h3><ul>\n<li>u : 指定用户</li>\n<li>g : 指定组</li>\n<li>o : 修改其他用户权限</li>\n<li>m : 指定mask权限</li>\n</ul>\n<p>注：默认情况下，ACL权限跟普通权限保持一致。</p>\n<h2 id=\"ACL-的流程\"><a href=\"#ACL-的流程\" class=\"headerlink\" title=\"ACL 的流程\"></a>ACL 的流程</h2><ul>\n<li><p>1、创建文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> o+x /root\n<span class=\"token function\">chmod</span> o+x /root/xiaochen\n<span class=\"token builtin class-name\">cd</span> xiaochen\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch abc.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 000 abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\ntotal <span class=\"token number\">0</span>\n---------- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">11</span>:39 abc.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>编写文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 111 > abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat abc.txt </span>\n<span class=\"token number\">111</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>设置ACL权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd xiaozhang</span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -m u:xiaozhang:r abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaozhang:r--\ngroup::---\nmask::r--\nother::---\n\n<span class=\"token comment\"># 注：</span>\nsetfacl -m u:用户名称:权限<span class=\"token punctuation\">(</span>rwx<span class=\"token punctuation\">)</span> 文件名称<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>查看文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># su - xiaozhang</span>\n<span class=\"token punctuation\">[</span>xiaozhang@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> /root/xiaochen/abc.txt\n<span class=\"token number\">111</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p>mask :  rw-</p>\n<p>xxxx :   -w-</p>\n<p>-w-</p>\n<h2 id=\"ACL权限的删除\"><a href=\"#ACL权限的删除\" class=\"headerlink\" title=\"ACL权限的删除\"></a>ACL权限的删除</h2><ul>\n<li><p>删除某个权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaozhang:r--\ngroup::---\ngroup:xiaochen:r-x\t\t<span class=\"token comment\">#effective:r--</span>\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -x u:xiaozhang abc.txt</span>\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\ngroup:xiaochen:r-x\nmask::r-x\nother::r--\n\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\ngroup:xiaochen:r-x\nmask::r-x\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -x g:xiaochen abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\nmask::---\nother::r--\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n</li>\n<li><p>清空acl权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaochen:rw-\nuser:xiaocao:rw-\ngroup::---\ngroup:xiaochen:rw-\ngroup:xiaocao:rw-\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -b abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\nother::r--\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"ACL继承\"><a href=\"#ACL继承\" class=\"headerlink\" title=\"ACL继承\"></a>ACL继承</h2><blockquote>\n<p>默认情况下，ACL是不会继承上层目录的权限的。只有目录设置可继承子集文件才可以继承ACL权限。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -m d:u:xiaochen:w ../linux12</span>\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch bcd.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">0</span>\n-rw-r--r--  <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">15</span>:40 abc.txt\n-rw-rw-r--+ <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">15</span>:43 bcd.txt\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl bcd.txt </span>\n<span class=\"token comment\"># file: bcd.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::rw-\nuser:xiaochen:-w-\ngroup::r-x\t\t\t<span class=\"token comment\">#effective:r--</span>\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><blockquote>\n<p>补充：</p>\n<p>​\t权限的归属</p>\n<p>​\t\ta : 属组、属主以及其他人的权限一起设置。</p>\n<p>​\t\to : 其他人</p>\n<p>​\t\tg : 属组</p>\n<p>​\t\tu : 属主</p>\n</blockquote>\n<h2 id=\"umask\"><a href=\"#umask\" class=\"headerlink\" title=\"umask\"></a>umask</h2><blockquote>\n<p>就是解决目录及文件的默认权限。</p>\n</blockquote>\n<ul>\n<li>文件的最高权限是多少     777</li>\n<li>文件夹的最高权限是多少  777</li>\n</ul>\n<h2 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h2><blockquote>\n<p>ACL是为了解决某种特殊环境下的，用户权限需求。</p>\n</blockquote>\n<ul>\n<li>setfacl ： 设置acl权限</li>\n<li>getfacl ：查看ACL权限</li>\n</ul>\n<h3 id=\"acl权限归属\"><a href=\"#acl权限归属\" class=\"headerlink\" title=\"acl权限归属\"></a>acl权限归属</h3><ul>\n<li>u : 指定用户</li>\n<li>g : 指定组</li>\n<li>o : 修改其他用户权限</li>\n<li>m : 指定mask权限</li>\n</ul>\n<p>注：默认情况下，ACL权限跟普通权限保持一致。</p>\n<h2 id=\"ACL-的流程\"><a href=\"#ACL-的流程\" class=\"headerlink\" title=\"ACL 的流程\"></a>ACL 的流程</h2><ul>\n<li><p>1、创建文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">chmod</span> o+x /root\n<span class=\"token function\">chmod</span> o+x /root/xiaochen\n<span class=\"token builtin class-name\">cd</span> xiaochen\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch abc.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 000 abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll</span>\ntotal <span class=\"token number\">0</span>\n---------- <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">11</span>:39 abc.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>编写文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 111 > abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat abc.txt </span>\n<span class=\"token number\">111</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>设置ACL权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd xiaozhang</span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -m u:xiaozhang:r abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaozhang:r--\ngroup::---\nmask::r--\nother::---\n\n<span class=\"token comment\"># 注：</span>\nsetfacl -m u:用户名称:权限<span class=\"token punctuation\">(</span>rwx<span class=\"token punctuation\">)</span> 文件名称<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</li>\n<li><p>查看文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># su - xiaozhang</span>\n<span class=\"token punctuation\">[</span>xiaozhang@localhost ~<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> /root/xiaochen/abc.txt\n<span class=\"token number\">111</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<p>mask :  rw-</p>\n<p>xxxx :   -w-</p>\n<p>-w-</p>\n<h2 id=\"ACL权限的删除\"><a href=\"#ACL权限的删除\" class=\"headerlink\" title=\"ACL权限的删除\"></a>ACL权限的删除</h2><ul>\n<li><p>删除某个权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaozhang:r--\ngroup::---\ngroup:xiaochen:r-x\t\t<span class=\"token comment\">#effective:r--</span>\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -x u:xiaozhang abc.txt</span>\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\ngroup:xiaochen:r-x\nmask::r-x\nother::r--\n\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\ngroup:xiaochen:r-x\nmask::r-x\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -x g:xiaochen abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\nmask::---\nother::r--\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n</li>\n<li><p>清空acl权限</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\nuser:xiaochen:rw-\nuser:xiaocao:rw-\ngroup::---\ngroup:xiaochen:rw-\ngroup:xiaocao:rw-\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -b abc.txt </span>\n<span class=\"token punctuation\">[</span>root@localhost xiaochen<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl abc.txt </span>\n<span class=\"token comment\"># file: abc.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::---\ngroup::---\nother::r--\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h2 id=\"ACL继承\"><a href=\"#ACL继承\" class=\"headerlink\" title=\"ACL继承\"></a>ACL继承</h2><blockquote>\n<p>默认情况下，ACL是不会继承上层目录的权限的。只有目录设置可继承子集文件才可以继承ACL权限。</p>\n</blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># setfacl -m d:u:xiaochen:w ../linux12</span>\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch bcd.txt</span>\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls -l</span>\ntotal <span class=\"token number\">0</span>\n-rw-r--r--  <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">15</span>:40 abc.txt\n-rw-rw-r--+ <span class=\"token number\">1</span> root root <span class=\"token number\">0</span> Mar <span class=\"token number\">16</span> <span class=\"token number\">15</span>:43 bcd.txt\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># getfacl bcd.txt </span>\n<span class=\"token comment\"># file: bcd.txt</span>\n<span class=\"token comment\"># owner: root</span>\n<span class=\"token comment\"># group: root</span>\nuser::rw-\nuser:xiaochen:-w-\ngroup::r-x\t\t\t<span class=\"token comment\">#effective:r--</span>\nmask::rw-\nother::r--\n\n<span class=\"token punctuation\">[</span>root@localhost linux12<span class=\"token punctuation\">]</span><span class=\"token comment\"># </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"运维之基础命令--sudo和su","date":"2022-07-06T03:19:52.000Z","_content":"\n\n\n# sudo\n\n> 用于普通用提升权限的。\n\n- 相关的文件：`/etc/sudoers`\n\n- 检查`/etc/sudoers`是否修改正确：visudo -c\n\n- sudoers文件格式\n\n  ```bash\n  tom       ALL=           (ALL)          ALL\n  用户名称   所有机器可登陆    所有IP或主机名   所有的指令\n  ```\n\n- 指令编写格式\n\n  ```bash\n  # 必须写全路径：which查看命令全路径\n  \n  ## 只支持vim命令提权\n  xianchen ALL=(ALL)  /usr/bin/vim\n  \n  ## 支持所有的命令提权\n  tom ALL=(ALL)  ALL\n  \n  ## 不支持某个命令提权\n  tom ALL=(ALL) ALL, !/usr/bin/vim\n  \n  ## 不支持某个命令的部分功能\n  xiaochen ALL=(ALL)   ALL, !/usr/bin/vim /root/123.txt\n  ```\n\n  \n\n\n\n# su\n\n- su - xxx  和 su xxx之间区别\n\n  ```bash\n  1、su - xxx ：相当于切换一个窗口，su xxx 仅仅切换了用户\n  \n  2、su - xxx ： 切换用户执行的系统文件要多于 su xxx\n  \n  3、su - xxx 是登录\n     su  xxx  切换用户\n  ```\n\n  \n\n","source":"_posts/01_运维/01-基础命令/day11-sudo与su/sudo and su.md","raw":"---\ntitle: 运维之基础命令--sudo和su\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n\n\n# sudo\n\n> 用于普通用提升权限的。\n\n- 相关的文件：`/etc/sudoers`\n\n- 检查`/etc/sudoers`是否修改正确：visudo -c\n\n- sudoers文件格式\n\n  ```bash\n  tom       ALL=           (ALL)          ALL\n  用户名称   所有机器可登陆    所有IP或主机名   所有的指令\n  ```\n\n- 指令编写格式\n\n  ```bash\n  # 必须写全路径：which查看命令全路径\n  \n  ## 只支持vim命令提权\n  xianchen ALL=(ALL)  /usr/bin/vim\n  \n  ## 支持所有的命令提权\n  tom ALL=(ALL)  ALL\n  \n  ## 不支持某个命令提权\n  tom ALL=(ALL) ALL, !/usr/bin/vim\n  \n  ## 不支持某个命令的部分功能\n  xiaochen ALL=(ALL)   ALL, !/usr/bin/vim /root/123.txt\n  ```\n\n  \n\n\n\n# su\n\n- su - xxx  和 su xxx之间区别\n\n  ```bash\n  1、su - xxx ：相当于切换一个窗口，su xxx 仅仅切换了用户\n  \n  2、su - xxx ： 切换用户执行的系统文件要多于 su xxx\n  \n  3、su - xxx 是登录\n     su  xxx  切换用户\n  ```\n\n  \n\n","slug":"01_运维/01-基础命令/day11-sudo与su/sudo and su","published":1,"updated":"2022-07-06T07:13:48.988Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1h003ba8v758t640vy","content":"<h1 id=\"sudo\"><a href=\"#sudo\" class=\"headerlink\" title=\"sudo\"></a>sudo</h1><blockquote>\n<p>用于普通用提升权限的。</p>\n</blockquote>\n<ul>\n<li><p>相关的文件：<code>/etc/sudoers</code></p>\n</li>\n<li><p>检查<code>/etc/sudoers</code>是否修改正确：visudo -c</p>\n</li>\n<li><p>sudoers文件格式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tom       <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span>           <span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>          ALL\n用户名称   所有机器可登陆    所有IP或主机名   所有的指令<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>指令编写格式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 必须写全路径：which查看命令全路径</span>\n\n<span class=\"token comment\">## 只支持vim命令提权</span>\nxianchen <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>  /usr/bin/vim\n\n<span class=\"token comment\">## 支持所有的命令提权</span>\ntom <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>  ALL\n\n<span class=\"token comment\">## 不支持某个命令提权</span>\ntom <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span> ALL, <span class=\"token operator\">!</span>/usr/bin/vim\n\n<span class=\"token comment\">## 不支持某个命令的部分功能</span>\nxiaochen <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>   ALL, <span class=\"token operator\">!</span>/usr/bin/vim /root/123.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"su\"><a href=\"#su\" class=\"headerlink\" title=\"su\"></a>su</h1><ul>\n<li><p>su - xxx  和 su xxx之间区别</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、su - xxx ：相当于切换一个窗口，su xxx 仅仅切换了用户\n\n<span class=\"token number\">2</span>、su - xxx ： 切换用户执行的系统文件要多于 <span class=\"token function\">su</span> xxx\n\n<span class=\"token number\">3</span>、su - xxx 是登录\n   <span class=\"token function\">su</span>  xxx  切换用户<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"sudo\"><a href=\"#sudo\" class=\"headerlink\" title=\"sudo\"></a>sudo</h1><blockquote>\n<p>用于普通用提升权限的。</p>\n</blockquote>\n<ul>\n<li><p>相关的文件：<code>/etc/sudoers</code></p>\n</li>\n<li><p>检查<code>/etc/sudoers</code>是否修改正确：visudo -c</p>\n</li>\n<li><p>sudoers文件格式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">tom       <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span>           <span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>          ALL\n用户名称   所有机器可登陆    所有IP或主机名   所有的指令<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n</li>\n<li><p>指令编写格式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 必须写全路径：which查看命令全路径</span>\n\n<span class=\"token comment\">## 只支持vim命令提权</span>\nxianchen <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>  /usr/bin/vim\n\n<span class=\"token comment\">## 支持所有的命令提权</span>\ntom <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>  ALL\n\n<span class=\"token comment\">## 不支持某个命令提权</span>\ntom <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span> ALL, <span class=\"token operator\">!</span>/usr/bin/vim\n\n<span class=\"token comment\">## 不支持某个命令的部分功能</span>\nxiaochen <span class=\"token assign-left variable\">ALL</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ALL<span class=\"token punctuation\">)</span>   ALL, <span class=\"token operator\">!</span>/usr/bin/vim /root/123.txt<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n<h1 id=\"su\"><a href=\"#su\" class=\"headerlink\" title=\"su\"></a>su</h1><ul>\n<li><p>su - xxx  和 su xxx之间区别</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、su - xxx ：相当于切换一个窗口，su xxx 仅仅切换了用户\n\n<span class=\"token number\">2</span>、su - xxx ： 切换用户执行的系统文件要多于 <span class=\"token function\">su</span> xxx\n\n<span class=\"token number\">3</span>、su - xxx 是登录\n   <span class=\"token function\">su</span>  xxx  切换用户<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>\n</ul>\n"},{"title":"运维之基础命令--netstat使用","date":"2022-07-06T03:19:52.000Z","_content":"\n# 笔记\n\n1、netstat\n\n```bash\nnetstat主要用来查询系统端口相关问题\n\n注：要使用netstat，需要安装yum install -y net-tools\n\n# netstat常用参数\n-t : 打印tcp链接的进程\n-u : 打印UDP链接的进程\n-l : 监听\n-p : 打印进程的PID\n-n : 不反解，不将ip地址解析成域名同时不将端口解析成对应的协议名称\n\nnetstat -nutlp\n```\n\n2、分区\n\n```bash\n# 查看系统磁盘\n[root@localhost ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               8:0    0   20G  0 disk \n├─sda1            8:1    0    1G  0 part /boot\n└─sda2            8:2    0   19G  0 part \n  ├─centos-root 253:0    0   18G  0 lvm  /\n  └─centos-swap 253:1    0    1G  0 lvm  [SWAP]\nsdb               8:16   0   40G  0 disk \nsdc               8:32   0  3.9T  0 disk \n\n# 分区\n[root@localhost ~]# fdisk /dev/sdb \n\nn : 新建一个分区\np : 查看分区情况\nm ：查看帮助\nd : 删除分区\nw ；保存分区修改内容\n```\n\n3、使用文件系统的流程\n\n```bash\n1、装硬盘\n\n2、查看当前系统硬盘\n[root@localhost a]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               8:0    0   20G  0 disk \n├─sda1            8:1    0    1G  0 part /boot\n└─sda2            8:2    0   19G  0 part \n  ├─centos-root 253:0    0   18G  0 lvm  /\n  └─centos-swap 253:1    0    1G  0 lvm  [SWAP]\nsdb               8:16   0   40G  0 disk \nsdc               8:32   0  3.9T  0 disk \nsr0              11:0    1  4.3G  0 rom  \n\n3、分区\n\t2TB 以下的硬盘，使用MBR分区\n\t2TB 以上的硬盘，使用GPT分区\n\t\n\tfdisk /dev/sdb\n\n4、格式化分区（将分区做成文件系统）\n\tmkfs.xfs /dev/sdb1\n\n5、挂载分区\n\tmount /dev/sdb1  /a\n\n6、检测\n\tdf\n\t\t-h : 显示硬盘大小单位\n\n# 注：挂载哪个硬盘则显示对应硬盘里面的内容\n```\n\n","source":"_posts/01_运维/01-基础命令/day18-netstat使用/笔记.md","raw":"---\ntitle: 运维之基础命令--netstat使用\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 笔记\n\n1、netstat\n\n```bash\nnetstat主要用来查询系统端口相关问题\n\n注：要使用netstat，需要安装yum install -y net-tools\n\n# netstat常用参数\n-t : 打印tcp链接的进程\n-u : 打印UDP链接的进程\n-l : 监听\n-p : 打印进程的PID\n-n : 不反解，不将ip地址解析成域名同时不将端口解析成对应的协议名称\n\nnetstat -nutlp\n```\n\n2、分区\n\n```bash\n# 查看系统磁盘\n[root@localhost ~]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               8:0    0   20G  0 disk \n├─sda1            8:1    0    1G  0 part /boot\n└─sda2            8:2    0   19G  0 part \n  ├─centos-root 253:0    0   18G  0 lvm  /\n  └─centos-swap 253:1    0    1G  0 lvm  [SWAP]\nsdb               8:16   0   40G  0 disk \nsdc               8:32   0  3.9T  0 disk \n\n# 分区\n[root@localhost ~]# fdisk /dev/sdb \n\nn : 新建一个分区\np : 查看分区情况\nm ：查看帮助\nd : 删除分区\nw ；保存分区修改内容\n```\n\n3、使用文件系统的流程\n\n```bash\n1、装硬盘\n\n2、查看当前系统硬盘\n[root@localhost a]# lsblk \nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               8:0    0   20G  0 disk \n├─sda1            8:1    0    1G  0 part /boot\n└─sda2            8:2    0   19G  0 part \n  ├─centos-root 253:0    0   18G  0 lvm  /\n  └─centos-swap 253:1    0    1G  0 lvm  [SWAP]\nsdb               8:16   0   40G  0 disk \nsdc               8:32   0  3.9T  0 disk \nsr0              11:0    1  4.3G  0 rom  \n\n3、分区\n\t2TB 以下的硬盘，使用MBR分区\n\t2TB 以上的硬盘，使用GPT分区\n\t\n\tfdisk /dev/sdb\n\n4、格式化分区（将分区做成文件系统）\n\tmkfs.xfs /dev/sdb1\n\n5、挂载分区\n\tmount /dev/sdb1  /a\n\n6、检测\n\tdf\n\t\t-h : 显示硬盘大小单位\n\n# 注：挂载哪个硬盘则显示对应硬盘里面的内容\n```\n\n","slug":"01_运维/01-基础命令/day18-netstat使用/笔记","published":1,"updated":"2022-07-06T07:14:29.922Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1h003ea8v72c4g9o7w","content":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><p>1、netstat</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">netstat主要用来查询系统端口相关问题\n\n注：要使用netstat，需要安装yum <span class=\"token function\">install</span> -y net-tools\n\n<span class=\"token comment\"># netstat常用参数</span>\n-t <span class=\"token builtin class-name\">:</span> 打印tcp链接的进程\n-u <span class=\"token builtin class-name\">:</span> 打印UDP链接的进程\n-l <span class=\"token builtin class-name\">:</span> 监听\n-p <span class=\"token builtin class-name\">:</span> 打印进程的PID\n-n <span class=\"token builtin class-name\">:</span> 不反解，不将ip地址解析成域名同时不将端口解析成对应的协议名称\n\n<span class=\"token function\">netstat</span> -nutlp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、分区</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 查看系统磁盘</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk </span>\nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   20G  <span class=\"token number\">0</span> disk \n├─sda1            <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n└─sda2            <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>   19G  <span class=\"token number\">0</span> part \n  ├─centos-root <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>   18G  <span class=\"token number\">0</span> lvm  /\n  └─centos-swap <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> lvm  <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\nsdb               <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   40G  <span class=\"token number\">0</span> disk \nsdc               <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9T  <span class=\"token number\">0</span> disk \n\n<span class=\"token comment\"># 分区</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdb </span>\n\nn <span class=\"token builtin class-name\">:</span> 新建一个分区\np <span class=\"token builtin class-name\">:</span> 查看分区情况\nm ：查看帮助\nd <span class=\"token builtin class-name\">:</span> 删除分区\nw ；保存分区修改内容<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、使用文件系统的流程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、装硬盘\n\n<span class=\"token number\">2</span>、查看当前系统硬盘\n<span class=\"token punctuation\">[</span>root@localhost a<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk </span>\nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   20G  <span class=\"token number\">0</span> disk \n├─sda1            <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n└─sda2            <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>   19G  <span class=\"token number\">0</span> part \n  ├─centos-root <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>   18G  <span class=\"token number\">0</span> lvm  /\n  └─centos-swap <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> lvm  <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\nsdb               <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   40G  <span class=\"token number\">0</span> disk \nsdc               <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9T  <span class=\"token number\">0</span> disk \nsr0              <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  <span class=\"token number\">4</span>.3G  <span class=\"token number\">0</span> rom  \n\n<span class=\"token number\">3</span>、分区\n\t2TB 以下的硬盘，使用MBR分区\n\t2TB 以上的硬盘，使用GPT分区\n\t\n\t<span class=\"token function\">fdisk</span> /dev/sdb\n\n<span class=\"token number\">4</span>、格式化分区（将分区做成文件系统）\n\tmkfs.xfs /dev/sdb1\n\n<span class=\"token number\">5</span>、挂载分区\n\t<span class=\"token function\">mount</span> /dev/sdb1  /a\n\n<span class=\"token number\">6</span>、检测\n\t<span class=\"token function\">df</span>\n\t\t-h <span class=\"token builtin class-name\">:</span> 显示硬盘大小单位\n\n<span class=\"token comment\"># 注：挂载哪个硬盘则显示对应硬盘里面的内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><p>1、netstat</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">netstat主要用来查询系统端口相关问题\n\n注：要使用netstat，需要安装yum <span class=\"token function\">install</span> -y net-tools\n\n<span class=\"token comment\"># netstat常用参数</span>\n-t <span class=\"token builtin class-name\">:</span> 打印tcp链接的进程\n-u <span class=\"token builtin class-name\">:</span> 打印UDP链接的进程\n-l <span class=\"token builtin class-name\">:</span> 监听\n-p <span class=\"token builtin class-name\">:</span> 打印进程的PID\n-n <span class=\"token builtin class-name\">:</span> 不反解，不将ip地址解析成域名同时不将端口解析成对应的协议名称\n\n<span class=\"token function\">netstat</span> -nutlp<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、分区</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 查看系统磁盘</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk </span>\nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   20G  <span class=\"token number\">0</span> disk \n├─sda1            <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n└─sda2            <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>   19G  <span class=\"token number\">0</span> part \n  ├─centos-root <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>   18G  <span class=\"token number\">0</span> lvm  /\n  └─centos-swap <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> lvm  <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\nsdb               <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   40G  <span class=\"token number\">0</span> disk \nsdc               <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9T  <span class=\"token number\">0</span> disk \n\n<span class=\"token comment\"># 分区</span>\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdb </span>\n\nn <span class=\"token builtin class-name\">:</span> 新建一个分区\np <span class=\"token builtin class-name\">:</span> 查看分区情况\nm ：查看帮助\nd <span class=\"token builtin class-name\">:</span> 删除分区\nw ；保存分区修改内容<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、使用文件系统的流程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、装硬盘\n\n<span class=\"token number\">2</span>、查看当前系统硬盘\n<span class=\"token punctuation\">[</span>root@localhost a<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk </span>\nNAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda               <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   20G  <span class=\"token number\">0</span> disk \n├─sda1            <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n└─sda2            <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>   19G  <span class=\"token number\">0</span> part \n  ├─centos-root <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>   18G  <span class=\"token number\">0</span> lvm  /\n  └─centos-swap <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> lvm  <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\nsdb               <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   40G  <span class=\"token number\">0</span> disk \nsdc               <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>  <span class=\"token number\">3</span>.9T  <span class=\"token number\">0</span> disk \nsr0              <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  <span class=\"token number\">4</span>.3G  <span class=\"token number\">0</span> rom  \n\n<span class=\"token number\">3</span>、分区\n\t2TB 以下的硬盘，使用MBR分区\n\t2TB 以上的硬盘，使用GPT分区\n\t\n\t<span class=\"token function\">fdisk</span> /dev/sdb\n\n<span class=\"token number\">4</span>、格式化分区（将分区做成文件系统）\n\tmkfs.xfs /dev/sdb1\n\n<span class=\"token number\">5</span>、挂载分区\n\t<span class=\"token function\">mount</span> /dev/sdb1  /a\n\n<span class=\"token number\">6</span>、检测\n\t<span class=\"token function\">df</span>\n\t\t-h <span class=\"token builtin class-name\">:</span> 显示硬盘大小单位\n\n<span class=\"token comment\"># 注：挂载哪个硬盘则显示对应硬盘里面的内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--进程管理","date":"2022-07-06T03:19:52.000Z","_content":"\n# 进程\n\n程序：安装包\n\n进程：正在运行的实例\n\nCPU：计算\n\n内存：存储CPU计算使用的临时数据\n\n存储：\n\n进程和线程\n\n\n\n僵尸进程和孤儿进程\n\n僵尸进程：进程生命周期结束了，但是PID未被回收\n\n孤儿进程：父进程生命周期结束了，但是子进程未结束，子进程被系统进程接收\n\n\n\n1、查看进程\n\n```bash\n# 命令：ps, 默认查看当前进程\n\n# 参数\n-a : 查询所有进程\n-x : 查看后台所有的进程\n-u : 查看进程的用户\n\nUSER ： 开启当前进程的用户\nPID  ： 当前进程的ID号\n%CPU ： CPU的使用率\n%MEM ： 内存使用率\nVSZ  ： 进程启动时默认向计算机申请的内存\nRSS  ： 进程运行时实际使用的内存\nTTY  ： 进程运行的终端\n\t？： 后台运行（没有终端）\n\ttty：使用系统终端\n\tpts：使用虚拟终端\nSTAT ：进程运行状态\n\tR ： 正在运行中的进程\n\t+ ： 在前台运行\n\tS ： 睡眠中状态\n\tD ： 不可中断睡眠\n\tT ： 停止状态\n\tZ :  僵尸状态\n\tX ： 死掉的进程\n\t< : 优先级较高的进程\n\tN ：优先级较低的进程\n\ts : 包含子进程       yum install psmisc -y \n\tl : 已线程的方式运行\n\t| ： 代表管道\nSTART ： 进程的启动时间\nTIME  ： 占用CPU的时间\nCOMMAND ： 进程执行的命令\n\n\n-e : 显示所有的进程\n-f : 格式化输出同时显示PPID\n\nPPID ： 父进程ID\n```\n\n2、top\n\n```bash\n# 根据一定频率的去监控系统\n\nup前是系统时间\nup后是开启的时间\n\nload average: 0.01, 0.42, 0.73\n0.01  ： 一分钟平均负载\n0.42  ： 五分钟平均负载\n0.73  ： 十五分钟平均负载\n\n平均负载：\n\n\n# CPU加压工具\nstress --cpu [需要加压的系统核心数] --timeout [加压的时间]\n\n# CPU 性能加压工具\n## 添加epel源（epel源主要用来安装红帽系列操作系统附加软件）\nyum install stress -y\n\n# CPU 性能分析工具\nyum install sysstat -y\n\nmpstat -P ALL 3   \n\n# 进程性能分析⼯具\npidstat -u 1 5  \n\n\n\nTasks\nTasks: 125 total,   1 running, 124 sleeping,   0 stopped,   0 zombie\n\ntotal : 当前系统一共运行的是125个进程\nrunning : 正在运行的是1个\nsleeping : 124个处于睡眠状态\nstopped : 停止运行的进程数\nzombie  ：僵尸进程数\n\n\n%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n\nus ：在单位时间进程使用CPU所占用的时间百分比\nsy : 在单位时间内系统进程占用CPU时间百分比\nni : 在单位时间内优先使用CPU所占时间百分比\nid ：在单位时间内CPU空闲所占时间百分比\nwa : 在单位时间内CPU阻塞态所占CPU时间的百分比\nhi : 硬件中断\nsi : 软件中断\nst : 其他占用CPU时间百分比\n\nKiB Mem :  2027892 total,  1234180 free,   176352 used,   617360 buff/cache\n\ntotal ：系统总内存\nfree  ：系统空闲内存\nused  : 系统使用内存\nbuff/cache ： 缓存使用内存\navail Mem ：\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND  \n  \nPID ： 进程编号\nUSER ： 启动进程的用户\nPR : 优先级\nNI ：nice值\nVIRT ： 虚拟内存\nRES  ： 使用内存\nSHR  ： 共享内存\n%CPU ： cpu使用率\n%MEM ：内存使用率\n\n```\n\n3、top快捷键\n\n```bash\n按1 : 展示所有的CPU的详情\n按s : 设置top监控频率（默认3秒）\n按m : 按照内存排序 \n按z : 添加颜色\n按p : 按照CPU排序\n按l : 展示CPU总负载（默认显示）\n```\n\n4、top的参数\n\n```bash\n-d ： 设置top的刷新频率\n-p :  设置查看的进程PID\n\ttop -d 1 -p `pgrep nginx | head -1`\n\n-u :  查询指定用户的经常的进程\n\ttop -u oldboy\n\n-n : 表示查询n次\n\t top -d 0.1 -u oldboy -n 20\n```\n\n\n\n\n\n\n\n```bash\n[epel]\nname=Extra Packages for Enterprise Linux 7 - $basearch\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch\nfailovermethod=priority\nenabled=1\ngpgcheck=0\n\n[epel-debuginfo]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Debug\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch/debug\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=$basearch\nfailovermethod=priority\nenabled=0\ngpgcheck=0\n\n[epel-source]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Source\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=$basearch\nfailovermethod=priority\nenabled=0\ngpgcheck=0\n```\n\n\n\n","source":"_posts/01_运维/01-基础命令/day16-进程管理/笔记.md","raw":"---\ntitle: 运维之基础命令--进程管理\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 进程\n\n程序：安装包\n\n进程：正在运行的实例\n\nCPU：计算\n\n内存：存储CPU计算使用的临时数据\n\n存储：\n\n进程和线程\n\n\n\n僵尸进程和孤儿进程\n\n僵尸进程：进程生命周期结束了，但是PID未被回收\n\n孤儿进程：父进程生命周期结束了，但是子进程未结束，子进程被系统进程接收\n\n\n\n1、查看进程\n\n```bash\n# 命令：ps, 默认查看当前进程\n\n# 参数\n-a : 查询所有进程\n-x : 查看后台所有的进程\n-u : 查看进程的用户\n\nUSER ： 开启当前进程的用户\nPID  ： 当前进程的ID号\n%CPU ： CPU的使用率\n%MEM ： 内存使用率\nVSZ  ： 进程启动时默认向计算机申请的内存\nRSS  ： 进程运行时实际使用的内存\nTTY  ： 进程运行的终端\n\t？： 后台运行（没有终端）\n\ttty：使用系统终端\n\tpts：使用虚拟终端\nSTAT ：进程运行状态\n\tR ： 正在运行中的进程\n\t+ ： 在前台运行\n\tS ： 睡眠中状态\n\tD ： 不可中断睡眠\n\tT ： 停止状态\n\tZ :  僵尸状态\n\tX ： 死掉的进程\n\t< : 优先级较高的进程\n\tN ：优先级较低的进程\n\ts : 包含子进程       yum install psmisc -y \n\tl : 已线程的方式运行\n\t| ： 代表管道\nSTART ： 进程的启动时间\nTIME  ： 占用CPU的时间\nCOMMAND ： 进程执行的命令\n\n\n-e : 显示所有的进程\n-f : 格式化输出同时显示PPID\n\nPPID ： 父进程ID\n```\n\n2、top\n\n```bash\n# 根据一定频率的去监控系统\n\nup前是系统时间\nup后是开启的时间\n\nload average: 0.01, 0.42, 0.73\n0.01  ： 一分钟平均负载\n0.42  ： 五分钟平均负载\n0.73  ： 十五分钟平均负载\n\n平均负载：\n\n\n# CPU加压工具\nstress --cpu [需要加压的系统核心数] --timeout [加压的时间]\n\n# CPU 性能加压工具\n## 添加epel源（epel源主要用来安装红帽系列操作系统附加软件）\nyum install stress -y\n\n# CPU 性能分析工具\nyum install sysstat -y\n\nmpstat -P ALL 3   \n\n# 进程性能分析⼯具\npidstat -u 1 5  \n\n\n\nTasks\nTasks: 125 total,   1 running, 124 sleeping,   0 stopped,   0 zombie\n\ntotal : 当前系统一共运行的是125个进程\nrunning : 正在运行的是1个\nsleeping : 124个处于睡眠状态\nstopped : 停止运行的进程数\nzombie  ：僵尸进程数\n\n\n%Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\n\nus ：在单位时间进程使用CPU所占用的时间百分比\nsy : 在单位时间内系统进程占用CPU时间百分比\nni : 在单位时间内优先使用CPU所占时间百分比\nid ：在单位时间内CPU空闲所占时间百分比\nwa : 在单位时间内CPU阻塞态所占CPU时间的百分比\nhi : 硬件中断\nsi : 软件中断\nst : 其他占用CPU时间百分比\n\nKiB Mem :  2027892 total,  1234180 free,   176352 used,   617360 buff/cache\n\ntotal ：系统总内存\nfree  ：系统空闲内存\nused  : 系统使用内存\nbuff/cache ： 缓存使用内存\navail Mem ：\n\n  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND  \n  \nPID ： 进程编号\nUSER ： 启动进程的用户\nPR : 优先级\nNI ：nice值\nVIRT ： 虚拟内存\nRES  ： 使用内存\nSHR  ： 共享内存\n%CPU ： cpu使用率\n%MEM ：内存使用率\n\n```\n\n3、top快捷键\n\n```bash\n按1 : 展示所有的CPU的详情\n按s : 设置top监控频率（默认3秒）\n按m : 按照内存排序 \n按z : 添加颜色\n按p : 按照CPU排序\n按l : 展示CPU总负载（默认显示）\n```\n\n4、top的参数\n\n```bash\n-d ： 设置top的刷新频率\n-p :  设置查看的进程PID\n\ttop -d 1 -p `pgrep nginx | head -1`\n\n-u :  查询指定用户的经常的进程\n\ttop -u oldboy\n\n-n : 表示查询n次\n\t top -d 0.1 -u oldboy -n 20\n```\n\n\n\n\n\n\n\n```bash\n[epel]\nname=Extra Packages for Enterprise Linux 7 - $basearch\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch\nfailovermethod=priority\nenabled=1\ngpgcheck=0\n\n[epel-debuginfo]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Debug\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/$basearch/debug\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=$basearch\nfailovermethod=priority\nenabled=0\ngpgcheck=0\n\n[epel-source]\nname=Extra Packages for Enterprise Linux 7 - $basearch - Source\nbaseurl=https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS\n#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=$basearch\nfailovermethod=priority\nenabled=0\ngpgcheck=0\n```\n\n\n\n","slug":"01_运维/01-基础命令/day16-进程管理/笔记","published":1,"updated":"2022-07-06T07:14:15.906Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1i003fa8v7b9zx0boi","content":"<h1 id=\"进程\"><a href=\"#进程\" class=\"headerlink\" title=\"进程\"></a>进程</h1><p>程序：安装包</p>\n<p>进程：正在运行的实例</p>\n<p>CPU：计算</p>\n<p>内存：存储CPU计算使用的临时数据</p>\n<p>存储：</p>\n<p>进程和线程</p>\n<p>僵尸进程和孤儿进程</p>\n<p>僵尸进程：进程生命周期结束了，但是PID未被回收</p>\n<p>孤儿进程：父进程生命周期结束了，但是子进程未结束，子进程被系统进程接收</p>\n<p>1、查看进程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 命令：ps, 默认查看当前进程</span>\n\n<span class=\"token comment\"># 参数</span>\n-a <span class=\"token builtin class-name\">:</span> 查询所有进程\n-x <span class=\"token builtin class-name\">:</span> 查看后台所有的进程\n-u <span class=\"token builtin class-name\">:</span> 查看进程的用户\n\n<span class=\"token environment constant\">USER</span> ： 开启当前进程的用户\nPID  ： 当前进程的ID号\n%CPU ： CPU的使用率\n%MEM ： 内存使用率\nVSZ  ： 进程启动时默认向计算机申请的内存\nRSS  ： 进程运行时实际使用的内存\nTTY  ： 进程运行的终端\n\t？： 后台运行（没有终端）\n\ttty：使用系统终端\n\tpts：使用虚拟终端\nSTAT ：进程运行状态\n\tR ： 正在运行中的进程\n\t+ ： 在前台运行\n\tS ： 睡眠中状态\n\tD ： 不可中断睡眠\n\tT ： 停止状态\n\tZ <span class=\"token builtin class-name\">:</span>  僵尸状态\n\tX ： 死掉的进程\n\t<span class=\"token operator\">&lt;</span> <span class=\"token builtin class-name\">:</span> 优先级较高的进程\n\tN ：优先级较低的进程\n\ts <span class=\"token builtin class-name\">:</span> 包含子进程       yum <span class=\"token function\">install</span> psmisc -y \n\tl <span class=\"token builtin class-name\">:</span> 已线程的方式运行\n\t<span class=\"token operator\">|</span> ： 代表管道\nSTART ： 进程的启动时间\nTIME  ： 占用CPU的时间\nCOMMAND ： 进程执行的命令\n\n\n-e <span class=\"token builtin class-name\">:</span> 显示所有的进程\n-f <span class=\"token builtin class-name\">:</span> 格式化输出同时显示<span class=\"token environment constant\">PPID</span>\n\n<span class=\"token environment constant\">PPID</span> ： 父进程ID<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、top</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 根据一定频率的去监控系统</span>\n\nup前是系统时间\nup后是开启的时间\n\nload average: <span class=\"token number\">0.01</span>, <span class=\"token number\">0.42</span>, <span class=\"token number\">0.73</span>\n<span class=\"token number\">0.01</span>  ： 一分钟平均负载\n<span class=\"token number\">0.42</span>  ： 五分钟平均负载\n<span class=\"token number\">0.73</span>  ： 十五分钟平均负载\n\n平均负载：\n\n\n<span class=\"token comment\"># CPU加压工具</span>\nstress --cpu <span class=\"token punctuation\">[</span>需要加压的系统核心数<span class=\"token punctuation\">]</span> --timeout <span class=\"token punctuation\">[</span>加压的时间<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># CPU 性能加压工具</span>\n<span class=\"token comment\">## 添加epel源（epel源主要用来安装红帽系列操作系统附加软件）</span>\nyum <span class=\"token function\">install</span> stress -y\n\n<span class=\"token comment\"># CPU 性能分析工具</span>\nyum <span class=\"token function\">install</span> sysstat -y\n\nmpstat -P ALL <span class=\"token number\">3</span>   \n\n<span class=\"token comment\"># 进程性能分析⼯具</span>\npidstat -u <span class=\"token number\">1</span> <span class=\"token number\">5</span>  \n\n\n\nTasks\nTasks: <span class=\"token number\">125</span> total,   <span class=\"token number\">1</span> running, <span class=\"token number\">124</span> sleeping,   <span class=\"token number\">0</span> stopped,   <span class=\"token number\">0</span> zombie\n\ntotal <span class=\"token builtin class-name\">:</span> 当前系统一共运行的是125个进程\nrunning <span class=\"token builtin class-name\">:</span> 正在运行的是1个\nsleeping <span class=\"token builtin class-name\">:</span> <span class=\"token number\">124</span>个处于睡眠状态\nstopped <span class=\"token builtin class-name\">:</span> 停止运行的进程数\nzombie  ：僵尸进程数\n\n\n%Cpu0  <span class=\"token builtin class-name\">:</span>  <span class=\"token number\">0.0</span> us,  <span class=\"token number\">0.0</span> sy,  <span class=\"token number\">0.0</span> ni,100.0 id,  <span class=\"token number\">0.0</span> wa,  <span class=\"token number\">0.0</span> hi,  <span class=\"token number\">0.0</span> si,  <span class=\"token number\">0.0</span> st\n\nus ：在单位时间进程使用CPU所占用的时间百分比\nsy <span class=\"token builtin class-name\">:</span> 在单位时间内系统进程占用CPU时间百分比\nni <span class=\"token builtin class-name\">:</span> 在单位时间内优先使用CPU所占时间百分比\n<span class=\"token function\">id</span> ：在单位时间内CPU空闲所占时间百分比\nwa <span class=\"token builtin class-name\">:</span> 在单位时间内CPU阻塞态所占CPU时间的百分比\nhi <span class=\"token builtin class-name\">:</span> 硬件中断\nsi <span class=\"token builtin class-name\">:</span> 软件中断\nst <span class=\"token builtin class-name\">:</span> 其他占用CPU时间百分比\n\nKiB Mem <span class=\"token builtin class-name\">:</span>  <span class=\"token number\">2027892</span> total,  <span class=\"token number\">1234180</span> free,   <span class=\"token number\">176352</span> used,   <span class=\"token number\">617360</span> buff/cache\n\ntotal ：系统总内存\n<span class=\"token function\">free</span>  ：系统空闲内存\nused  <span class=\"token builtin class-name\">:</span> 系统使用内存\nbuff/cache ： 缓存使用内存\navail Mem ：\n\n  PID <span class=\"token environment constant\">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND  \n  \nPID ： 进程编号\n<span class=\"token environment constant\">USER</span> ： 启动进程的用户\nPR <span class=\"token builtin class-name\">:</span> 优先级\nNI ：nice值\nVIRT ： 虚拟内存\nRES  ： 使用内存\nSHR  ： 共享内存\n%CPU ： cpu使用率\n%MEM ：内存使用率\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、top快捷键</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">按1 <span class=\"token builtin class-name\">:</span> 展示所有的CPU的详情\n按s <span class=\"token builtin class-name\">:</span> 设置top监控频率（默认3秒）\n按m <span class=\"token builtin class-name\">:</span> 按照内存排序 \n按z <span class=\"token builtin class-name\">:</span> 添加颜色\n按p <span class=\"token builtin class-name\">:</span> 按照CPU排序\n按l <span class=\"token builtin class-name\">:</span> 展示CPU总负载（默认显示）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、top的参数</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">-d ： 设置top的刷新频率\n-p <span class=\"token builtin class-name\">:</span>  设置查看的进程PID\n\t<span class=\"token function\">top</span> -d <span class=\"token number\">1</span> -p <span class=\"token variable\"><span class=\"token variable\">`</span>pgrep nginx <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -1<span class=\"token variable\">`</span></span>\n\n-u <span class=\"token builtin class-name\">:</span>  查询指定用户的经常的进程\n\t<span class=\"token function\">top</span> -u oldboy\n\n-n <span class=\"token builtin class-name\">:</span> 表示查询n次\n\t <span class=\"token function\">top</span> -d <span class=\"token number\">0.1</span> -u oldboy -n <span class=\"token number\">20</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>epel<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/<span class=\"token variable\">$basearch</span>\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token punctuation\">[</span>epel-debuginfo<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span> - Debug\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/<span class=\"token variable\">$basearch</span>/debug\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token punctuation\">[</span>epel-source<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span> - Source\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"进程\"><a href=\"#进程\" class=\"headerlink\" title=\"进程\"></a>进程</h1><p>程序：安装包</p>\n<p>进程：正在运行的实例</p>\n<p>CPU：计算</p>\n<p>内存：存储CPU计算使用的临时数据</p>\n<p>存储：</p>\n<p>进程和线程</p>\n<p>僵尸进程和孤儿进程</p>\n<p>僵尸进程：进程生命周期结束了，但是PID未被回收</p>\n<p>孤儿进程：父进程生命周期结束了，但是子进程未结束，子进程被系统进程接收</p>\n<p>1、查看进程</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 命令：ps, 默认查看当前进程</span>\n\n<span class=\"token comment\"># 参数</span>\n-a <span class=\"token builtin class-name\">:</span> 查询所有进程\n-x <span class=\"token builtin class-name\">:</span> 查看后台所有的进程\n-u <span class=\"token builtin class-name\">:</span> 查看进程的用户\n\n<span class=\"token environment constant\">USER</span> ： 开启当前进程的用户\nPID  ： 当前进程的ID号\n%CPU ： CPU的使用率\n%MEM ： 内存使用率\nVSZ  ： 进程启动时默认向计算机申请的内存\nRSS  ： 进程运行时实际使用的内存\nTTY  ： 进程运行的终端\n\t？： 后台运行（没有终端）\n\ttty：使用系统终端\n\tpts：使用虚拟终端\nSTAT ：进程运行状态\n\tR ： 正在运行中的进程\n\t+ ： 在前台运行\n\tS ： 睡眠中状态\n\tD ： 不可中断睡眠\n\tT ： 停止状态\n\tZ <span class=\"token builtin class-name\">:</span>  僵尸状态\n\tX ： 死掉的进程\n\t<span class=\"token operator\">&lt;</span> <span class=\"token builtin class-name\">:</span> 优先级较高的进程\n\tN ：优先级较低的进程\n\ts <span class=\"token builtin class-name\">:</span> 包含子进程       yum <span class=\"token function\">install</span> psmisc -y \n\tl <span class=\"token builtin class-name\">:</span> 已线程的方式运行\n\t<span class=\"token operator\">|</span> ： 代表管道\nSTART ： 进程的启动时间\nTIME  ： 占用CPU的时间\nCOMMAND ： 进程执行的命令\n\n\n-e <span class=\"token builtin class-name\">:</span> 显示所有的进程\n-f <span class=\"token builtin class-name\">:</span> 格式化输出同时显示<span class=\"token environment constant\">PPID</span>\n\n<span class=\"token environment constant\">PPID</span> ： 父进程ID<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、top</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 根据一定频率的去监控系统</span>\n\nup前是系统时间\nup后是开启的时间\n\nload average: <span class=\"token number\">0.01</span>, <span class=\"token number\">0.42</span>, <span class=\"token number\">0.73</span>\n<span class=\"token number\">0.01</span>  ： 一分钟平均负载\n<span class=\"token number\">0.42</span>  ： 五分钟平均负载\n<span class=\"token number\">0.73</span>  ： 十五分钟平均负载\n\n平均负载：\n\n\n<span class=\"token comment\"># CPU加压工具</span>\nstress --cpu <span class=\"token punctuation\">[</span>需要加压的系统核心数<span class=\"token punctuation\">]</span> --timeout <span class=\"token punctuation\">[</span>加压的时间<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># CPU 性能加压工具</span>\n<span class=\"token comment\">## 添加epel源（epel源主要用来安装红帽系列操作系统附加软件）</span>\nyum <span class=\"token function\">install</span> stress -y\n\n<span class=\"token comment\"># CPU 性能分析工具</span>\nyum <span class=\"token function\">install</span> sysstat -y\n\nmpstat -P ALL <span class=\"token number\">3</span>   \n\n<span class=\"token comment\"># 进程性能分析⼯具</span>\npidstat -u <span class=\"token number\">1</span> <span class=\"token number\">5</span>  \n\n\n\nTasks\nTasks: <span class=\"token number\">125</span> total,   <span class=\"token number\">1</span> running, <span class=\"token number\">124</span> sleeping,   <span class=\"token number\">0</span> stopped,   <span class=\"token number\">0</span> zombie\n\ntotal <span class=\"token builtin class-name\">:</span> 当前系统一共运行的是125个进程\nrunning <span class=\"token builtin class-name\">:</span> 正在运行的是1个\nsleeping <span class=\"token builtin class-name\">:</span> <span class=\"token number\">124</span>个处于睡眠状态\nstopped <span class=\"token builtin class-name\">:</span> 停止运行的进程数\nzombie  ：僵尸进程数\n\n\n%Cpu0  <span class=\"token builtin class-name\">:</span>  <span class=\"token number\">0.0</span> us,  <span class=\"token number\">0.0</span> sy,  <span class=\"token number\">0.0</span> ni,100.0 id,  <span class=\"token number\">0.0</span> wa,  <span class=\"token number\">0.0</span> hi,  <span class=\"token number\">0.0</span> si,  <span class=\"token number\">0.0</span> st\n\nus ：在单位时间进程使用CPU所占用的时间百分比\nsy <span class=\"token builtin class-name\">:</span> 在单位时间内系统进程占用CPU时间百分比\nni <span class=\"token builtin class-name\">:</span> 在单位时间内优先使用CPU所占时间百分比\n<span class=\"token function\">id</span> ：在单位时间内CPU空闲所占时间百分比\nwa <span class=\"token builtin class-name\">:</span> 在单位时间内CPU阻塞态所占CPU时间的百分比\nhi <span class=\"token builtin class-name\">:</span> 硬件中断\nsi <span class=\"token builtin class-name\">:</span> 软件中断\nst <span class=\"token builtin class-name\">:</span> 其他占用CPU时间百分比\n\nKiB Mem <span class=\"token builtin class-name\">:</span>  <span class=\"token number\">2027892</span> total,  <span class=\"token number\">1234180</span> free,   <span class=\"token number\">176352</span> used,   <span class=\"token number\">617360</span> buff/cache\n\ntotal ：系统总内存\n<span class=\"token function\">free</span>  ：系统空闲内存\nused  <span class=\"token builtin class-name\">:</span> 系统使用内存\nbuff/cache ： 缓存使用内存\navail Mem ：\n\n  PID <span class=\"token environment constant\">USER</span>      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND  \n  \nPID ： 进程编号\n<span class=\"token environment constant\">USER</span> ： 启动进程的用户\nPR <span class=\"token builtin class-name\">:</span> 优先级\nNI ：nice值\nVIRT ： 虚拟内存\nRES  ： 使用内存\nSHR  ： 共享内存\n%CPU ： cpu使用率\n%MEM ：内存使用率\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、top快捷键</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">按1 <span class=\"token builtin class-name\">:</span> 展示所有的CPU的详情\n按s <span class=\"token builtin class-name\">:</span> 设置top监控频率（默认3秒）\n按m <span class=\"token builtin class-name\">:</span> 按照内存排序 \n按z <span class=\"token builtin class-name\">:</span> 添加颜色\n按p <span class=\"token builtin class-name\">:</span> 按照CPU排序\n按l <span class=\"token builtin class-name\">:</span> 展示CPU总负载（默认显示）<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、top的参数</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">-d ： 设置top的刷新频率\n-p <span class=\"token builtin class-name\">:</span>  设置查看的进程PID\n\t<span class=\"token function\">top</span> -d <span class=\"token number\">1</span> -p <span class=\"token variable\"><span class=\"token variable\">`</span>pgrep nginx <span class=\"token operator\">|</span> <span class=\"token function\">head</span> -1<span class=\"token variable\">`</span></span>\n\n-u <span class=\"token builtin class-name\">:</span>  查询指定用户的经常的进程\n\t<span class=\"token function\">top</span> -u oldboy\n\n-n <span class=\"token builtin class-name\">:</span> 表示查询n次\n\t <span class=\"token function\">top</span> -d <span class=\"token number\">0.1</span> -u oldboy -n <span class=\"token number\">20</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n\n\n\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>epel<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span>\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/<span class=\"token variable\">$basearch</span>\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token punctuation\">[</span>epel-debuginfo<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span> - Debug\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/<span class=\"token variable\">$basearch</span>/debug\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n<span class=\"token punctuation\">[</span>epel-source<span class=\"token punctuation\">]</span>\n<span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Extra Packages <span class=\"token keyword\">for</span> Enterprise Linux <span class=\"token number\">7</span> - <span class=\"token variable\">$basearch</span> - Source\n<span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.tuna.tsinghua.edu.cn/epel/7/SRPMS\n<span class=\"token comment\">#mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&amp;arch=$basearch</span>\n<span class=\"token assign-left variable\">failovermethod</span><span class=\"token operator\">=</span>priority\n<span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n"},{"title":"运维之基础命令--linux信号","date":"2022-07-06T03:19:52.000Z","_content":"\n# 笔记\n\n1、设置进程的nice值\n\n```bash\n# 设置进程的优先级\nnice -n -11 bash test.sh\n\n-n ： 设置优先级\n\t普通用户：（0~19）\n\t超级用户：（-20~19）\n\t\n# 给指定进程设置优先级\nrenice [设置优先级] pid\n\n```\n\n2、Linux系统信号\n\n```bash\n中断信号\n\tctrl + c\n\tctrl + z\n\n\tINT(2) : \n\t\tkill -[信号名称|信号ID]　pid\n\t\t\n\t\tkill -SIGINT  PID\n\t\tkill -INT     PID\n\t\tkill -2       PID \n\n退出信号:\n\tctrl + d\n\n暂停信号：将进程暂停\n\tSIGTSTP（20）\n\t\tkill -20 PID \n\t\tkill -SIGTSTP PID \n\t\tkill -TSTP PID\n\n杀死进程信号\n\tSIGKILL\n\t\tkill -9 PID \n\t\tkill -SIGKILL PID\n\t\tkill -KILL PID\n注：不能够被捕捉\n\n终止信号\n\tSIGTREM\n\t\tkill -15 PID \n\t\tkill -SIGTERM PID\n\t\tkill -TERM PID\n\n注：优雅终止进程\n\n暂停和恢复信号\n\tSIGCONT : 恢复\n\tSIGSTOP ：暂停\n\n重载信号\n\tSIGHUP（1）\n\n\n1、nohup [执行的命令] &\n后台启动，会在当前目录生成一个nohub.out文件，用于执行的命令的输出。\n2、setsid : 实际上开了一个孤儿进程\n3、（执行的命令&）\n4、screen  开启一个子窗口\n```\n\n","source":"_posts/01_运维/01-基础命令/day17-Linux信号/笔记.md","raw":"---\ntitle: 运维之基础命令--linux信号\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 笔记\n\n1、设置进程的nice值\n\n```bash\n# 设置进程的优先级\nnice -n -11 bash test.sh\n\n-n ： 设置优先级\n\t普通用户：（0~19）\n\t超级用户：（-20~19）\n\t\n# 给指定进程设置优先级\nrenice [设置优先级] pid\n\n```\n\n2、Linux系统信号\n\n```bash\n中断信号\n\tctrl + c\n\tctrl + z\n\n\tINT(2) : \n\t\tkill -[信号名称|信号ID]　pid\n\t\t\n\t\tkill -SIGINT  PID\n\t\tkill -INT     PID\n\t\tkill -2       PID \n\n退出信号:\n\tctrl + d\n\n暂停信号：将进程暂停\n\tSIGTSTP（20）\n\t\tkill -20 PID \n\t\tkill -SIGTSTP PID \n\t\tkill -TSTP PID\n\n杀死进程信号\n\tSIGKILL\n\t\tkill -9 PID \n\t\tkill -SIGKILL PID\n\t\tkill -KILL PID\n注：不能够被捕捉\n\n终止信号\n\tSIGTREM\n\t\tkill -15 PID \n\t\tkill -SIGTERM PID\n\t\tkill -TERM PID\n\n注：优雅终止进程\n\n暂停和恢复信号\n\tSIGCONT : 恢复\n\tSIGSTOP ：暂停\n\n重载信号\n\tSIGHUP（1）\n\n\n1、nohup [执行的命令] &\n后台启动，会在当前目录生成一个nohub.out文件，用于执行的命令的输出。\n2、setsid : 实际上开了一个孤儿进程\n3、（执行的命令&）\n4、screen  开启一个子窗口\n```\n\n","slug":"01_运维/01-基础命令/day17-Linux信号/笔记","published":1,"updated":"2022-07-06T07:14:23.575Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1j003ia8v7fq4p3qw4","content":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><p>1、设置进程的nice值</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 设置进程的优先级</span>\n<span class=\"token function\">nice</span> -n -11 <span class=\"token function\">bash</span> test.sh\n\n-n ： 设置优先级\n\t普通用户：（0~19）\n\t超级用户：（-20~19）\n\t\n<span class=\"token comment\"># 给指定进程设置优先级</span>\n<span class=\"token function\">renice</span> <span class=\"token punctuation\">[</span>设置优先级<span class=\"token punctuation\">]</span> pid\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、Linux系统信号</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">中断信号\n\tctrl + c\n\tctrl + z\n\n\tINT<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">:</span> \n\t\t<span class=\"token function\">kill</span> -<span class=\"token punctuation\">[</span>信号名称<span class=\"token operator\">|</span>信号ID<span class=\"token punctuation\">]</span>　pid\n\t\t\n\t\t<span class=\"token function\">kill</span> -SIGINT  PID\n\t\t<span class=\"token function\">kill</span> -INT     PID\n\t\t<span class=\"token function\">kill</span> -2       PID \n\n退出信号:\n\tctrl + d\n\n暂停信号：将进程暂停\n\tSIGTSTP（20）\n\t\t<span class=\"token function\">kill</span> -20 PID \n\t\t<span class=\"token function\">kill</span> -SIGTSTP PID \n\t\t<span class=\"token function\">kill</span> -TSTP PID\n\n杀死进程信号\n\tSIGKILL\n\t\t<span class=\"token function\">kill</span> -9 PID \n\t\t<span class=\"token function\">kill</span> -SIGKILL PID\n\t\t<span class=\"token function\">kill</span> -KILL PID\n注：不能够被捕捉\n\n终止信号\n\tSIGTREM\n\t\t<span class=\"token function\">kill</span> -15 PID \n\t\t<span class=\"token function\">kill</span> -SIGTERM PID\n\t\t<span class=\"token function\">kill</span> -<span class=\"token environment constant\">TERM</span> PID\n\n注：优雅终止进程\n\n暂停和恢复信号\n\tSIGCONT <span class=\"token builtin class-name\">:</span> 恢复\n\tSIGSTOP ：暂停\n\n重载信号\n\tSIGHUP（1）\n\n\n<span class=\"token number\">1</span>、nohup <span class=\"token punctuation\">[</span>执行的命令<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span>\n后台启动，会在当前目录生成一个nohub.out文件，用于执行的命令的输出。\n<span class=\"token number\">2</span>、setsid <span class=\"token builtin class-name\">:</span> 实际上开了一个孤儿进程\n<span class=\"token number\">3</span>、（执行的命令<span class=\"token operator\">&amp;</span>）\n<span class=\"token number\">4</span>、screen  开启一个子窗口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h1><p>1、设置进程的nice值</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 设置进程的优先级</span>\n<span class=\"token function\">nice</span> -n -11 <span class=\"token function\">bash</span> test.sh\n\n-n ： 设置优先级\n\t普通用户：（0~19）\n\t超级用户：（-20~19）\n\t\n<span class=\"token comment\"># 给指定进程设置优先级</span>\n<span class=\"token function\">renice</span> <span class=\"token punctuation\">[</span>设置优先级<span class=\"token punctuation\">]</span> pid\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、Linux系统信号</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">中断信号\n\tctrl + c\n\tctrl + z\n\n\tINT<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">:</span> \n\t\t<span class=\"token function\">kill</span> -<span class=\"token punctuation\">[</span>信号名称<span class=\"token operator\">|</span>信号ID<span class=\"token punctuation\">]</span>　pid\n\t\t\n\t\t<span class=\"token function\">kill</span> -SIGINT  PID\n\t\t<span class=\"token function\">kill</span> -INT     PID\n\t\t<span class=\"token function\">kill</span> -2       PID \n\n退出信号:\n\tctrl + d\n\n暂停信号：将进程暂停\n\tSIGTSTP（20）\n\t\t<span class=\"token function\">kill</span> -20 PID \n\t\t<span class=\"token function\">kill</span> -SIGTSTP PID \n\t\t<span class=\"token function\">kill</span> -TSTP PID\n\n杀死进程信号\n\tSIGKILL\n\t\t<span class=\"token function\">kill</span> -9 PID \n\t\t<span class=\"token function\">kill</span> -SIGKILL PID\n\t\t<span class=\"token function\">kill</span> -KILL PID\n注：不能够被捕捉\n\n终止信号\n\tSIGTREM\n\t\t<span class=\"token function\">kill</span> -15 PID \n\t\t<span class=\"token function\">kill</span> -SIGTERM PID\n\t\t<span class=\"token function\">kill</span> -<span class=\"token environment constant\">TERM</span> PID\n\n注：优雅终止进程\n\n暂停和恢复信号\n\tSIGCONT <span class=\"token builtin class-name\">:</span> 恢复\n\tSIGSTOP ：暂停\n\n重载信号\n\tSIGHUP（1）\n\n\n<span class=\"token number\">1</span>、nohup <span class=\"token punctuation\">[</span>执行的命令<span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span>\n后台启动，会在当前目录生成一个nohub.out文件，用于执行的命令的输出。\n<span class=\"token number\">2</span>、setsid <span class=\"token builtin class-name\">:</span> 实际上开了一个孤儿进程\n<span class=\"token number\">3</span>、（执行的命令<span class=\"token operator\">&amp;</span>）\n<span class=\"token number\">4</span>、screen  开启一个子窗口<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--dd与文件系统备份","date":"2022-07-06T03:19:52.000Z","_content":"\n## 笔记\n\n1、dd命令\n\n```bash\ndd if=/dev/zero of=/dev/sdb bs=500M count=1 \n \nif : 从哪里读文件\nof : 写入到哪里\nbs : 写入500M\ncount : 写一块\n```\n\n2、模拟文件系统出问题\n\n```bash\n1、直接向硬盘中写数据，不能测试向分区写数据\n2、卸载之后重新挂载\n[root@localhost ~]# mount /dev/sdc1 /root/test\nmount: mount /dev/sdc1 on /root/test failed: Structure needs cleaning\n\n3、对文件系统进行修复\nxfs_repair [磁盘或分区路径]\n\n注： xfs_repair修改硬盘之后，硬盘数据丢失，所以对重要的数据要进行数据备份\n```\n\n3、文件系统的备份与恢复\n\n```bash\n备份：另外在保存一份\n恢复：将以前保存的数据进行还原\n\ntouch 1.txt\necho aaaa > 1.txt\ncp  1.txt   2.txt\n\nrm 1.txt\n\ncp 2.txt 1.txt\n\n1.log   1T = 1024G\n\n全量备份和增量备份\n全量备份：将需要备份的文件全部复制一份\n增量备份：在原来备份基础上，把新增数据重新备份一份\n\n备份与恢复的命令\nxfsdump : 备份的命令\nxfsrestore  : 恢复的命令\n\n\n# 备份的步骤\n1、安装备份命令\n[root@localhost test]# yum install xfsdump -y\n\n2、备份的等级\n0  全量备份\n\n1 ~ 9 增量备份（等级）\n\n3、备份的参数\n-L ：记录每次备份的地方\n-M ：注释，此次备份的注释\n-l ：指定备份的等级\n-f ：备份的文件名称\n-I ：查看备份信息\n\n4、备份的条件（限制）\n\t1、必须使用root权限\n\t2、只能备份已经挂载的内容\n\t3、只能备份xfs文件系统\n\t4、只能够用xfsrestore来恢复\n\n5、备份的命令格式\nxfsdump [参数] 备份路径\nxfsdump -L sdb1_bak -M \"sbd1_from_xxx\" -l 0 -f sdb1_from_bak_1 /root/oldboy\n\n6、数据恢复\nxfsrestore\n\n7、恢复数据的参数\n-f : 指定备份的文件路径\n\n8、恢复的格式\nxfsrestore [参数] 恢复的路径\n[root@localhost oldboy]# xfsrestore -f /root/sdb1_from_bak_3 /root/oldboy/\n```\n\n4、LVM\n\n```bsah\n1、什么是lvm\n\n你如何保证你的硬盘空间恰好够用？\n如果你的硬盘你够用了怎么扩容？\n\nLVM是文件系统管理工具\n\n/root/oldboy --->  lv[5G]\n/root/oldboy --->  lv[3G]\n\n2、LVM的优点\n\t1、可以动态扩容与缩容\n\t2、可以将新增加的硬盘添加到VG存储池\n\t3、可以突破物理存储卷的限制\n\n\n\n3、使用lvm\n\t1、安装lvm软件包\n\t\tyum install lvm2 -y\n\t2、将磁盘交给pv\n\t\tpvreate [磁盘|磁盘分区]\n\t3、查看pv\n\t\tpvs\n\t\tpvscan\n\t4、创建vg\n\t\tvgcreate [vg名称] [pv路径]\n\t5、查看vg\n\t6、创建lvm逻辑卷（lv）\n\t\t-L ： 创建逻辑卷的大小\n\t\t-n : 逻辑卷的名字\n\t\tlvcreate [参数] 逻辑卷名称\n\t7、制作文件系统\n\t\tmkfs.xfs /dev/vg1/xxx\n\t\n\t8、挂载文件系统\n\t\tmount [lv的路径] [挂载点的路径]\n```\n\n","source":"_posts/01_运维/01-基础命令/day20-dd与文件系统备份/笔记.md","raw":"---\ntitle: 运维之基础命令--dd与文件系统备份\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n## 笔记\n\n1、dd命令\n\n```bash\ndd if=/dev/zero of=/dev/sdb bs=500M count=1 \n \nif : 从哪里读文件\nof : 写入到哪里\nbs : 写入500M\ncount : 写一块\n```\n\n2、模拟文件系统出问题\n\n```bash\n1、直接向硬盘中写数据，不能测试向分区写数据\n2、卸载之后重新挂载\n[root@localhost ~]# mount /dev/sdc1 /root/test\nmount: mount /dev/sdc1 on /root/test failed: Structure needs cleaning\n\n3、对文件系统进行修复\nxfs_repair [磁盘或分区路径]\n\n注： xfs_repair修改硬盘之后，硬盘数据丢失，所以对重要的数据要进行数据备份\n```\n\n3、文件系统的备份与恢复\n\n```bash\n备份：另外在保存一份\n恢复：将以前保存的数据进行还原\n\ntouch 1.txt\necho aaaa > 1.txt\ncp  1.txt   2.txt\n\nrm 1.txt\n\ncp 2.txt 1.txt\n\n1.log   1T = 1024G\n\n全量备份和增量备份\n全量备份：将需要备份的文件全部复制一份\n增量备份：在原来备份基础上，把新增数据重新备份一份\n\n备份与恢复的命令\nxfsdump : 备份的命令\nxfsrestore  : 恢复的命令\n\n\n# 备份的步骤\n1、安装备份命令\n[root@localhost test]# yum install xfsdump -y\n\n2、备份的等级\n0  全量备份\n\n1 ~ 9 增量备份（等级）\n\n3、备份的参数\n-L ：记录每次备份的地方\n-M ：注释，此次备份的注释\n-l ：指定备份的等级\n-f ：备份的文件名称\n-I ：查看备份信息\n\n4、备份的条件（限制）\n\t1、必须使用root权限\n\t2、只能备份已经挂载的内容\n\t3、只能备份xfs文件系统\n\t4、只能够用xfsrestore来恢复\n\n5、备份的命令格式\nxfsdump [参数] 备份路径\nxfsdump -L sdb1_bak -M \"sbd1_from_xxx\" -l 0 -f sdb1_from_bak_1 /root/oldboy\n\n6、数据恢复\nxfsrestore\n\n7、恢复数据的参数\n-f : 指定备份的文件路径\n\n8、恢复的格式\nxfsrestore [参数] 恢复的路径\n[root@localhost oldboy]# xfsrestore -f /root/sdb1_from_bak_3 /root/oldboy/\n```\n\n4、LVM\n\n```bsah\n1、什么是lvm\n\n你如何保证你的硬盘空间恰好够用？\n如果你的硬盘你够用了怎么扩容？\n\nLVM是文件系统管理工具\n\n/root/oldboy --->  lv[5G]\n/root/oldboy --->  lv[3G]\n\n2、LVM的优点\n\t1、可以动态扩容与缩容\n\t2、可以将新增加的硬盘添加到VG存储池\n\t3、可以突破物理存储卷的限制\n\n\n\n3、使用lvm\n\t1、安装lvm软件包\n\t\tyum install lvm2 -y\n\t2、将磁盘交给pv\n\t\tpvreate [磁盘|磁盘分区]\n\t3、查看pv\n\t\tpvs\n\t\tpvscan\n\t4、创建vg\n\t\tvgcreate [vg名称] [pv路径]\n\t5、查看vg\n\t6、创建lvm逻辑卷（lv）\n\t\t-L ： 创建逻辑卷的大小\n\t\t-n : 逻辑卷的名字\n\t\tlvcreate [参数] 逻辑卷名称\n\t7、制作文件系统\n\t\tmkfs.xfs /dev/vg1/xxx\n\t\n\t8、挂载文件系统\n\t\tmount [lv的路径] [挂载点的路径]\n```\n\n","slug":"01_运维/01-基础命令/day20-dd与文件系统备份/笔记","published":1,"updated":"2022-07-06T07:14:48.372Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k1j003ka8v7bgoo0tuk","content":"<h2 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h2><p>1、dd命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>/dev/zero <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>/dev/sdb <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>500M <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> \n \n<span class=\"token keyword\">if</span> <span class=\"token builtin class-name\">:</span> 从哪里读文件\nof <span class=\"token builtin class-name\">:</span> 写入到哪里\nbs <span class=\"token builtin class-name\">:</span> 写入500M\ncount <span class=\"token builtin class-name\">:</span> 写一块<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、模拟文件系统出问题</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、直接向硬盘中写数据，不能测试向分区写数据\n<span class=\"token number\">2</span>、卸载之后重新挂载\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount /dev/sdc1 /root/test</span>\nmount: <span class=\"token function\">mount</span> /dev/sdc1 on /root/test failed: Structure needs cleaning\n\n<span class=\"token number\">3</span>、对文件系统进行修复\nxfs_repair <span class=\"token punctuation\">[</span>磁盘或分区路径<span class=\"token punctuation\">]</span>\n\n注： xfs_repair修改硬盘之后，硬盘数据丢失，所以对重要的数据要进行数据备份<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、文件系统的备份与恢复</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">备份：另外在保存一份\n恢复：将以前保存的数据进行还原\n\n<span class=\"token function\">touch</span> <span class=\"token number\">1</span>.txt\n<span class=\"token builtin class-name\">echo</span> aaaa <span class=\"token operator\">></span> <span class=\"token number\">1</span>.txt\n<span class=\"token function\">cp</span>  <span class=\"token number\">1</span>.txt   <span class=\"token number\">2</span>.txt\n\n<span class=\"token function\">rm</span> <span class=\"token number\">1</span>.txt\n\n<span class=\"token function\">cp</span> <span class=\"token number\">2</span>.txt <span class=\"token number\">1</span>.txt\n\n<span class=\"token number\">1</span>.log   1T <span class=\"token operator\">=</span> 1024G\n\n全量备份和增量备份\n全量备份：将需要备份的文件全部复制一份\n增量备份：在原来备份基础上，把新增数据重新备份一份\n\n备份与恢复的命令\nxfsdump <span class=\"token builtin class-name\">:</span> 备份的命令\nxfsrestore  <span class=\"token builtin class-name\">:</span> 恢复的命令\n\n\n<span class=\"token comment\"># 备份的步骤</span>\n<span class=\"token number\">1</span>、安装备份命令\n<span class=\"token punctuation\">[</span>root@localhost test<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install xfsdump -y</span>\n\n<span class=\"token number\">2</span>、备份的等级\n<span class=\"token number\">0</span>  全量备份\n\n<span class=\"token number\">1</span> ~ <span class=\"token number\">9</span> 增量备份（等级）\n\n<span class=\"token number\">3</span>、备份的参数\n-L ：记录每次备份的地方\n-M ：注释，此次备份的注释\n-l ：指定备份的等级\n-f ：备份的文件名称\n-I ：查看备份信息\n\n<span class=\"token number\">4</span>、备份的条件（限制）\n\t<span class=\"token number\">1</span>、必须使用root权限\n\t<span class=\"token number\">2</span>、只能备份已经挂载的内容\n\t<span class=\"token number\">3</span>、只能备份xfs文件系统\n\t<span class=\"token number\">4</span>、只能够用xfsrestore来恢复\n\n<span class=\"token number\">5</span>、备份的命令格式\nxfsdump <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 备份路径\nxfsdump -L sdb1_bak -M <span class=\"token string\">\"sbd1_from_xxx\"</span> -l <span class=\"token number\">0</span> -f sdb1_from_bak_1 /root/oldboy\n\n<span class=\"token number\">6</span>、数据恢复\nxfsrestore\n\n<span class=\"token number\">7</span>、恢复数据的参数\n-f <span class=\"token builtin class-name\">:</span> 指定备份的文件路径\n\n<span class=\"token number\">8</span>、恢复的格式\nxfsrestore <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 恢复的路径\n<span class=\"token punctuation\">[</span>root@localhost oldboy<span class=\"token punctuation\">]</span><span class=\"token comment\"># xfsrestore -f /root/sdb1_from_bak_3 /root/oldboy/</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、LVM</p>\n<pre class=\"line-numbers language-bsah\" data-language=\"bsah\"><code class=\"language-bsah\">1、什么是lvm\n\n你如何保证你的硬盘空间恰好够用？\n如果你的硬盘你够用了怎么扩容？\n\nLVM是文件系统管理工具\n\n&#x2F;root&#x2F;oldboy ---&gt;  lv[5G]\n&#x2F;root&#x2F;oldboy ---&gt;  lv[3G]\n\n2、LVM的优点\n\t1、可以动态扩容与缩容\n\t2、可以将新增加的硬盘添加到VG存储池\n\t3、可以突破物理存储卷的限制\n\n\n\n3、使用lvm\n\t1、安装lvm软件包\n\t\tyum install lvm2 -y\n\t2、将磁盘交给pv\n\t\tpvreate [磁盘|磁盘分区]\n\t3、查看pv\n\t\tpvs\n\t\tpvscan\n\t4、创建vg\n\t\tvgcreate [vg名称] [pv路径]\n\t5、查看vg\n\t6、创建lvm逻辑卷（lv）\n\t\t-L ： 创建逻辑卷的大小\n\t\t-n : 逻辑卷的名字\n\t\tlvcreate [参数] 逻辑卷名称\n\t7、制作文件系统\n\t\tmkfs.xfs &#x2F;dev&#x2F;vg1&#x2F;xxx\n\t\n\t8、挂载文件系统\n\t\tmount [lv的路径] [挂载点的路径]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"笔记\"><a href=\"#笔记\" class=\"headerlink\" title=\"笔记\"></a>笔记</h2><p>1、dd命令</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">dd</span> <span class=\"token assign-left variable\">if</span><span class=\"token operator\">=</span>/dev/zero <span class=\"token assign-left variable\">of</span><span class=\"token operator\">=</span>/dev/sdb <span class=\"token assign-left variable\">bs</span><span class=\"token operator\">=</span>500M <span class=\"token assign-left variable\">count</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> \n \n<span class=\"token keyword\">if</span> <span class=\"token builtin class-name\">:</span> 从哪里读文件\nof <span class=\"token builtin class-name\">:</span> 写入到哪里\nbs <span class=\"token builtin class-name\">:</span> 写入500M\ncount <span class=\"token builtin class-name\">:</span> 写一块<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、模拟文件系统出问题</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、直接向硬盘中写数据，不能测试向分区写数据\n<span class=\"token number\">2</span>、卸载之后重新挂载\n<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount /dev/sdc1 /root/test</span>\nmount: <span class=\"token function\">mount</span> /dev/sdc1 on /root/test failed: Structure needs cleaning\n\n<span class=\"token number\">3</span>、对文件系统进行修复\nxfs_repair <span class=\"token punctuation\">[</span>磁盘或分区路径<span class=\"token punctuation\">]</span>\n\n注： xfs_repair修改硬盘之后，硬盘数据丢失，所以对重要的数据要进行数据备份<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、文件系统的备份与恢复</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">备份：另外在保存一份\n恢复：将以前保存的数据进行还原\n\n<span class=\"token function\">touch</span> <span class=\"token number\">1</span>.txt\n<span class=\"token builtin class-name\">echo</span> aaaa <span class=\"token operator\">></span> <span class=\"token number\">1</span>.txt\n<span class=\"token function\">cp</span>  <span class=\"token number\">1</span>.txt   <span class=\"token number\">2</span>.txt\n\n<span class=\"token function\">rm</span> <span class=\"token number\">1</span>.txt\n\n<span class=\"token function\">cp</span> <span class=\"token number\">2</span>.txt <span class=\"token number\">1</span>.txt\n\n<span class=\"token number\">1</span>.log   1T <span class=\"token operator\">=</span> 1024G\n\n全量备份和增量备份\n全量备份：将需要备份的文件全部复制一份\n增量备份：在原来备份基础上，把新增数据重新备份一份\n\n备份与恢复的命令\nxfsdump <span class=\"token builtin class-name\">:</span> 备份的命令\nxfsrestore  <span class=\"token builtin class-name\">:</span> 恢复的命令\n\n\n<span class=\"token comment\"># 备份的步骤</span>\n<span class=\"token number\">1</span>、安装备份命令\n<span class=\"token punctuation\">[</span>root@localhost test<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install xfsdump -y</span>\n\n<span class=\"token number\">2</span>、备份的等级\n<span class=\"token number\">0</span>  全量备份\n\n<span class=\"token number\">1</span> ~ <span class=\"token number\">9</span> 增量备份（等级）\n\n<span class=\"token number\">3</span>、备份的参数\n-L ：记录每次备份的地方\n-M ：注释，此次备份的注释\n-l ：指定备份的等级\n-f ：备份的文件名称\n-I ：查看备份信息\n\n<span class=\"token number\">4</span>、备份的条件（限制）\n\t<span class=\"token number\">1</span>、必须使用root权限\n\t<span class=\"token number\">2</span>、只能备份已经挂载的内容\n\t<span class=\"token number\">3</span>、只能备份xfs文件系统\n\t<span class=\"token number\">4</span>、只能够用xfsrestore来恢复\n\n<span class=\"token number\">5</span>、备份的命令格式\nxfsdump <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 备份路径\nxfsdump -L sdb1_bak -M <span class=\"token string\">\"sbd1_from_xxx\"</span> -l <span class=\"token number\">0</span> -f sdb1_from_bak_1 /root/oldboy\n\n<span class=\"token number\">6</span>、数据恢复\nxfsrestore\n\n<span class=\"token number\">7</span>、恢复数据的参数\n-f <span class=\"token builtin class-name\">:</span> 指定备份的文件路径\n\n<span class=\"token number\">8</span>、恢复的格式\nxfsrestore <span class=\"token punctuation\">[</span>参数<span class=\"token punctuation\">]</span> 恢复的路径\n<span class=\"token punctuation\">[</span>root@localhost oldboy<span class=\"token punctuation\">]</span><span class=\"token comment\"># xfsrestore -f /root/sdb1_from_bak_3 /root/oldboy/</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、LVM</p>\n<pre class=\"line-numbers language-bsah\" data-language=\"bsah\"><code class=\"language-bsah\">1、什么是lvm\n\n你如何保证你的硬盘空间恰好够用？\n如果你的硬盘你够用了怎么扩容？\n\nLVM是文件系统管理工具\n\n&#x2F;root&#x2F;oldboy ---&gt;  lv[5G]\n&#x2F;root&#x2F;oldboy ---&gt;  lv[3G]\n\n2、LVM的优点\n\t1、可以动态扩容与缩容\n\t2、可以将新增加的硬盘添加到VG存储池\n\t3、可以突破物理存储卷的限制\n\n\n\n3、使用lvm\n\t1、安装lvm软件包\n\t\tyum install lvm2 -y\n\t2、将磁盘交给pv\n\t\tpvreate [磁盘|磁盘分区]\n\t3、查看pv\n\t\tpvs\n\t\tpvscan\n\t4、创建vg\n\t\tvgcreate [vg名称] [pv路径]\n\t5、查看vg\n\t6、创建lvm逻辑卷（lv）\n\t\t-L ： 创建逻辑卷的大小\n\t\t-n : 逻辑卷的名字\n\t\tlvcreate [参数] 逻辑卷名称\n\t7、制作文件系统\n\t\tmkfs.xfs &#x2F;dev&#x2F;vg1&#x2F;xxx\n\t\n\t8、挂载文件系统\n\t\tmount [lv的路径] [挂载点的路径]<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--逻辑卷管理","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、LVM介绍\n\n​\t逻辑卷管理LVM是一个多才多艺的硬盘系统工具。无论在Linux或者其他类似的系统，都是非常的好用。传统分区使用固定大小分区，重新调整大小十分麻烦。但是，LVM可以创建和管理“逻辑”卷，而不是直接使用物理硬盘。可以让管理员弹性的管理逻辑卷的扩大缩小，操作简单，而不损坏已存储的数据。可以随意将新的硬盘添加到LVM，以直接扩展已经存在的逻辑卷。LVM并不需要重启就可以让内核知道分区的存在。\n\nLVM使用分层结构，如下如所示：\n\n![img](02_逻辑卷管理.assets/134408sa12dauefffyszfg.jpg)\n\n​\t图中顶部，首先是实际的物理磁盘及其划分的分区和其上的物理卷（PV）。一个或多个物理卷可以用来创建卷组（VG）。然后基于卷组可以创建逻辑卷（LV）。只要在卷组中有可用空间，就可以随心所欲的创建逻辑卷。文件系统就是在逻辑卷上创建的，然后可以在操作系统挂载和访问\n\n## 二、LVM使用\n\n### 2.1 磁盘准备\n\n加装两块硬盘，sdb-10G与sdc-5G\n\n```shell\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\nsdc      8:32   0    5G  0 disk\nsr0     11:0    1  792M  0 rom\n```\n\n给sbd创建LVM分区\n\n```shell\n[root@lb01 ~]# fdisk /dev/sdb\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n  # 新建分区\nPartition type:\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended\nSelect (default p):\nUsing default response p\nPartition number (1-4, default 1):\nFirst sector (2048-20971519, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-20971519, default 20971519): +2G\nPartition 1 of type Linux and of size 2 GiB is set\n\nCommand (m for help): t  # 将分区改为LVM分区\nSelected partition 1\nHex code (type L to list all codes): L\n\n 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris\n 1  FAT12           27  Hidden NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-\n 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-\n 3  XENIX usr       3c  PartitionMagic  84  OS/2 hidden C:  c6  DRDOS/sec (FAT-\n 4  FAT16 <32M      40  Venix 80286     85  Linux extended  c7  Syrinx\n 5  Extended        41  PPC PReP Boot   86  NTFS volume set da  Non-FS data\n 6  FAT16           42  SFS             87  NTFS volume set db  CP/M / CTOS / .\n 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux plaintext de  Dell Utility\n 8  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       df  BootIt\n 9  AIX bootable    4f  QNX4.x 3rd part 93  Amoeba          e1  DOS access\n a  OS/2 Boot Manag 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O\n b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor\n c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad hi eb  BeOS fs\n e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         ee  GPT\n f  W95 Ext'd (LBA) 54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/\n10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC b\n11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor\n12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f4  SpeedStor\n14  Hidden FAT16 <3 61  SpeedStor       ab  Darwin boot     f2  DOS secondary\n16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS\n17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE\n18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fd  Linux raid auto\n1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fe  LANstep\n1c  Hidden W95 FAT3 75  PC/IX           be  Solaris boot    ff  BBT\n1e  Hidden W95 FAT1 80  Old Minix\nHex code (type L to list all codes): 8e\nChanged type of partition 'Linux' to 'Linux LVM'\n\nCommand (m for help): p\n\nDisk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            2048     4196351     2097152   8e  Linux LVM\n```\n\n重复添加，再加一个3G，一个2G的分区，可见分区表如下：\n\n```shell\n[root@lb01 ~]# fdisk -l /dev/sdb\n\nDisk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            2048     4196351     2097152   8e  Linux LVM\n/dev/sdb2         4196352    10487807     3145728   8e  Linux LVM\n/dev/sdb3        10487808    14682111     2097152   8e  Linux LVM\n```\n\n### 2.2 创建物理卷（PV）\n\n安装LVM工具\n\n```shell\n[root@lb01 ~]# yum install lvm2 \n```\n\n将准备好的LVM分区生成为物理卷\n\n```shell\n[root@lb01 ~]# pvcreate /dev/sdb1\nWARNING: ext4 signature detected on /dev/sdb1 at offset 1080. Wipe it? [y/n]: y\n  Wiping ext4 signature on /dev/sdb1.\n  Physical volume \"/dev/sdb1\" successfully created.\n[root@lb01 ~]# pvcreate /dev/sdb2\n  Physical volume \"/dev/sdb2\" successfully created.\n[root@lb01 ~]# pvcreate /dev/sdb3\n  Physical volume \"/dev/sdb3\" successfully created.\n```\n\n查看物理卷信息\n\n```shell\n[root@lb01 ~]# pvdisplay\n  \"/dev/sdb1\" is a new physical volume of \"2.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb1\n  VG Name\n  PV Size               2.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               YUHdrd-AH1x-ew0m-Mp9i-3GHp-S4zc-XxlDJM\n\n  \"/dev/sdb2\" is a new physical volume of \"3.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb2\n  VG Name\n  PV Size               3.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               wGDQvx-7zfs-g018-wqx4-Y8rh-1kWT-PnLuFu\n\n  \"/dev/sdb3\" is a new physical volume of \"2.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb3\n  VG Name\n  PV Size               2.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               fykcuR-jooY-WKbi-yM8j-7fQ5-mhnH-JCkXC8\n```\n\n补充：如何删除物理卷\n\n```shell\n[root@lb01 ~]# pvremove /dev/sdb1\n```\n\n### 2.3 创建卷组（VG）\n\n将/dev/sdb{1,2,3}合并为卷组vg01\n\n```shell\n[root@lb01 ~]# vgcreate vg01 /dev/sdb1 /dev/sdb2 /dev/sdb3\n```\n\n查看卷组信息\n\n```shell\n[root@lb01 ~]# vgdisplay\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        3\n  Metadata Sequence No  1\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                0\n  Open LV               0\n  Max PV                0\n  Cur PV                3\n  Act PV                3\n  VG Size               <6.99 GiB\n  PE Size               4.00 MiB\n  Total PE              1789\n  Alloc PE / Size       0 / 0\n  Free  PE / Size       1789 / <6.99 GiB\n  VG UUID               gzeouH-16qO-n6xv-V6VM-A9ep-eK6E-ODuIwU\n```\n\n补充：如何删除卷组\n\n```shell\n[root@lb01 ~]# vgremove vg01\n  Volume group \"vg01\" successfully removed\n```\n\n### 2.4 创建逻辑卷（LV）\n\n创建一个名为lv01，大小为100M的逻辑卷\n\n```shell\n[root@lb01 ~]# lvcreate -L 100M -n lv01 vg01\n  Logical volume \"lv01\" created.\n```\n\n查看逻辑卷\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                xFksnb-ENc2-mEo4-5gEb-yaJj-wP2c-oFuBeT\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:39:16 +0800\n  LV Status              available\n  # open                 0\n  LV Size                100.00 MiB\n  Current LE             25\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n```\n\n补充：删除逻辑卷\n\n```shell\n[root@lb01 ~]# lvremove /dev/vg01/lv02\nDo you really want to remove active logical volume vg01/lv02? [y/n]: y\n  Logical volume \"lv02\" successfully removed\n```\n\n### 2.5 逻辑卷挂载\n\n格式化逻辑卷\n\n```shell\n[root@lb01 ~]# mkfs.ext4 /dev/vg01/lv01\nmke2fs 1.42.9 (28-Dec-2013)\nFilesystem label=\nOS type: Linux\nBlock size=1024 (log=0)\nFragment size=1024 (log=0)\nStride=0 blocks, Stripe width=0 blocks\n25688 inodes, 102400 blocks\n5120 blocks (5.00%) reserved for the super user\nFirst data block=1\nMaximum filesystem blocks=33685504\n13 block groups\n8192 blocks per group, 8192 fragments per group\n1976 inodes per group\nSuperblock backups stored on blocks:\n        8193, 24577, 40961, 57345, 73729\n\nAllocating group tables: done\nWriting inode tables: done\nCreating journal (4096 blocks): done\nWriting superblocks and filesystem accounting information: done\n```\n\n挂载逻辑卷\n\n```shell\n[root@lb01 ~]# mkdir /mnt/test-lv01\n[root@lb01 ~]# mount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01   93M  1.6M   85M   2% /mnt/test-lv01\n```\n\n### 2.6 扩展逻辑卷\n\n卸载逻辑卷\n\n```shell\n[root@lb01 ~]# umount /dev/vg01/lv01\n```\n\n将逻辑卷lv01调整为200M\n\n```shell\n[root@lb01 ~]# lvresize -L 200M /dev/vg01/lv01 \n  Size of logical volume vg01/lv01 changed from 100.00 MiB (25 extents) to 200.00 MiB (50 extents).\n  Logical volume vg01/lv01 successfully resized.\n```\n\n检查磁盘错误\n\n```shell\n[root@lb01 ~]# e2fsck -f /dev/vg01/lv01\ne2fsck 1.42.9 (28-Dec-2013)\nPass 1: Checking inodes, blocks, and sizes\nPass 2: Checking directory structure\nPass 3: Checking directory connectivity\nPass 4: Checking reference counts\nPass 5: Checking group summary information\n/dev/vg01/lv01: 11/25688 files (9.1% non-contiguous), 8896/102400 blocks\n```\n\n调整文件系统大小\n\n```shell\n[root@lb01 ~]# resize2fs /dev/vg01/lv01\n```\n\n查看逻辑卷信息\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:41:53 +0800\n  LV Status              available\n  # open                 0\n  LV Size                200.00 MiB\n  Current LE             50\n  Segments               2\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n  ...\n```\n\n重新挂载使用\n\n```shell\n[root@lb01 ~]# !mount\nmount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01  190M  1.6M  175M   1% /mnt/test-lv01\n```\n\n### 2.7 缩减逻辑卷\n\n卸载逻辑卷\n\n```shell\n[root@lb01 ~]# umount /dev/vg01/lv01\n```\n\n检查磁盘错误\n\n```shell\n[root@lb01 ~]# e2fsck -f /dev/vg01/lv01\ne2fsck 1.42.9 (28-Dec-2013)\nPass 1: Checking inodes, blocks, and sizes\nPass 2: Checking directory structure\nPass 3: Checking directory connectivity\nPass 4: Checking reference counts\nPass 5: Checking group summary information\n/dev/vg01/lv01: 11/49400 files (9.1% non-contiguous), 11884/204800 blocks\n```\n\n缩减文件系统大小，更新ext4信息\n\n```shell\n[root@lb01 ~]# resize2fs /dev/vg01/lv01 100M\nresize2fs 1.42.9 (28-Dec-2013)\nResizing the filesystem on /dev/vg01/lv01 to 102400 (1k) blocks.\nThe filesystem on /dev/vg01/lv01 is now 102400 blocks long.\n```\n\n完成后，减小逻辑卷大小\n\n```shell\n[root@lb01 ~]# lvresize -L 100M /dev/vg01/lv01\n  WARNING: Reducing active logical volume to 100.00 MiB.\n  THIS MAY DESTROY YOUR DATA (filesystem etc.)\nDo you really want to reduce vg01/lv01? [y/n]: y\n  Size of logical volume vg01/lv01 changed from 200.00 MiB (50 extents) to 100.00 MiB (25 extents).\n  Logical volume vg01/lv01 successfully resized.\n```\n\n查看逻辑卷信息\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:41:53 +0800\n  LV Status              available\n  # open                 0\n  LV Size                100.00 MiB\n  Current LE             25\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n  ...\n```\n\n挂载使用\n\n```shell\n[root@lb01 ~]# !mo\nmount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01   93M  1.6M   85M   2% /mnt/test-lv01\n```\n\n### 2.8 VG增加一块磁盘\n\n新盘创建lvm分区\n\n```shell\n[root@lb01 ~]# fdisk /dev/sdc\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\nDevice does not contain a recognized partition table\nBuilding a new DOS disklabel with disk identifier 0x05ff27fa.\n\nCommand (m for help): n\nPartition type:\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended\nSelect (default p):\nUsing default response p\nPartition number (1-4, default 1):\nFirst sector (2048-10485759, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-10485759, default 10485759): +4G\nPartition 1 of type Linux and of size 4 GiB is set\n\nCommand (m for help): t\nSelected partition 1\nHex code (type L to list all codes):\nHex code (type L to list all codes): 8e\nChanged type of partition 'Linux' to 'Linux LVM'\n\nCommand (m for help): p\n\nDisk /dev/sdc: 5368 MB, 5368709120 bytes, 10485760 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x05ff27fa\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdc1            2048     8390655     4194304   8e  Linux LVM\n```\n\n创建物理卷\n\n```shell\n[root@lb01 ~]# pvcreate /dev/sdc1\n  Physical volume \"/dev/sdc1\" successfully created.\n```\n\n扩容VG\n\n```shell\n[root@lb01 ~]# vgextend vg01 /dev/sdc1\n  Volume group \"vg01\" successfully extended\n```\n\n查看VG信息\n\n```shell\n[root@lb01 ~]# vgdisplay vg01\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        4\n  Metadata Sequence No  10\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                2\n  Open LV               1\n  Max PV                0\n  Cur PV                4\n  Act PV                4\n  VG Size               10.98 GiB\n  PE Size               4.00 MiB\n  Total PE              2812\n  Alloc PE / Size       50 / 200.00 MiB\n  Free  PE / Size       2762 / <10.79 GiB\n  VG UUID               2Tjzna-XmXI-9MQ7-zeyc-AARV-84r5-jyymkf\n```\n\n>PS：尽管我们使用一个单独的磁盘做示范，其实只要是‘8e’类型的磁盘分区都可以用来扩展卷组。\n\n在VG中创建LV，可以看到磁盘都用上了\n\n```shell\n[root@lb01 ~]# lvcreate -L 10G -n lv03 vg01\n  Logical volume \"lv03\" created.\n[root@lb01 ~]# lsblk\nNAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda             8:0    0   50G  0 disk\n├─sda1          8:1    0    1G  0 part /boot\n├─sda2          8:2    0    2G  0 part [SWAP]\n└─sda3          8:3    0   47G  0 part /\nsdb             8:16   0   10G  0 disk\n├─sdb1          8:17   0    2G  0 part\n│ ├─vg01-lv01 253:0    0  100M  0 lvm  /mnt/test-lv01\n│ ├─vg01-lv02 253:1    0  100M  0 lvm\n│ └─vg01-lv03 253:2    0   10G  0 lvm\n├─sdb2          8:18   0    3G  0 part\n│ └─vg01-lv03 253:2    0   10G  0 lvm\n└─sdb3          8:19   0    2G  0 part\n  └─vg01-lv03 253:2    0   10G  0 lvm\nsdc             8:32   0    5G  0 disk\n└─sdc1          8:33   0    4G  0 part\n  └─vg01-lv03 253:2    0   10G  0 lvm\nsr0            11:0    1  792M  0 rom\n```\n\n\n\n","source":"_posts/01_运维/01-基础命令/day19-磁盘分区/02_逻辑卷管理.md","raw":"---\ntitle: 运维之基础命令--逻辑卷管理\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n## 一、LVM介绍\n\n​\t逻辑卷管理LVM是一个多才多艺的硬盘系统工具。无论在Linux或者其他类似的系统，都是非常的好用。传统分区使用固定大小分区，重新调整大小十分麻烦。但是，LVM可以创建和管理“逻辑”卷，而不是直接使用物理硬盘。可以让管理员弹性的管理逻辑卷的扩大缩小，操作简单，而不损坏已存储的数据。可以随意将新的硬盘添加到LVM，以直接扩展已经存在的逻辑卷。LVM并不需要重启就可以让内核知道分区的存在。\n\nLVM使用分层结构，如下如所示：\n\n![img](02_逻辑卷管理.assets/134408sa12dauefffyszfg.jpg)\n\n​\t图中顶部，首先是实际的物理磁盘及其划分的分区和其上的物理卷（PV）。一个或多个物理卷可以用来创建卷组（VG）。然后基于卷组可以创建逻辑卷（LV）。只要在卷组中有可用空间，就可以随心所欲的创建逻辑卷。文件系统就是在逻辑卷上创建的，然后可以在操作系统挂载和访问\n\n## 二、LVM使用\n\n### 2.1 磁盘准备\n\n加装两块硬盘，sdb-10G与sdc-5G\n\n```shell\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\nsdc      8:32   0    5G  0 disk\nsr0     11:0    1  792M  0 rom\n```\n\n给sbd创建LVM分区\n\n```shell\n[root@lb01 ~]# fdisk /dev/sdb\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\n\nCommand (m for help): n  # 新建分区\nPartition type:\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended\nSelect (default p):\nUsing default response p\nPartition number (1-4, default 1):\nFirst sector (2048-20971519, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-20971519, default 20971519): +2G\nPartition 1 of type Linux and of size 2 GiB is set\n\nCommand (m for help): t  # 将分区改为LVM分区\nSelected partition 1\nHex code (type L to list all codes): L\n\n 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris\n 1  FAT12           27  Hidden NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-\n 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-\n 3  XENIX usr       3c  PartitionMagic  84  OS/2 hidden C:  c6  DRDOS/sec (FAT-\n 4  FAT16 <32M      40  Venix 80286     85  Linux extended  c7  Syrinx\n 5  Extended        41  PPC PReP Boot   86  NTFS volume set da  Non-FS data\n 6  FAT16           42  SFS             87  NTFS volume set db  CP/M / CTOS / .\n 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux plaintext de  Dell Utility\n 8  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       df  BootIt\n 9  AIX bootable    4f  QNX4.x 3rd part 93  Amoeba          e1  DOS access\n a  OS/2 Boot Manag 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O\n b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor\n c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad hi eb  BeOS fs\n e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         ee  GPT\n f  W95 Ext'd (LBA) 54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/\n10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC b\n11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor\n12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f4  SpeedStor\n14  Hidden FAT16 <3 61  SpeedStor       ab  Darwin boot     f2  DOS secondary\n16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS\n17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE\n18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fd  Linux raid auto\n1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fe  LANstep\n1c  Hidden W95 FAT3 75  PC/IX           be  Solaris boot    ff  BBT\n1e  Hidden W95 FAT1 80  Old Minix\nHex code (type L to list all codes): 8e\nChanged type of partition 'Linux' to 'Linux LVM'\n\nCommand (m for help): p\n\nDisk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            2048     4196351     2097152   8e  Linux LVM\n```\n\n重复添加，再加一个3G，一个2G的分区，可见分区表如下：\n\n```shell\n[root@lb01 ~]# fdisk -l /dev/sdb\n\nDisk /dev/sdb: 10.7 GB, 10737418240 bytes, 20971520 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            2048     4196351     2097152   8e  Linux LVM\n/dev/sdb2         4196352    10487807     3145728   8e  Linux LVM\n/dev/sdb3        10487808    14682111     2097152   8e  Linux LVM\n```\n\n### 2.2 创建物理卷（PV）\n\n安装LVM工具\n\n```shell\n[root@lb01 ~]# yum install lvm2 \n```\n\n将准备好的LVM分区生成为物理卷\n\n```shell\n[root@lb01 ~]# pvcreate /dev/sdb1\nWARNING: ext4 signature detected on /dev/sdb1 at offset 1080. Wipe it? [y/n]: y\n  Wiping ext4 signature on /dev/sdb1.\n  Physical volume \"/dev/sdb1\" successfully created.\n[root@lb01 ~]# pvcreate /dev/sdb2\n  Physical volume \"/dev/sdb2\" successfully created.\n[root@lb01 ~]# pvcreate /dev/sdb3\n  Physical volume \"/dev/sdb3\" successfully created.\n```\n\n查看物理卷信息\n\n```shell\n[root@lb01 ~]# pvdisplay\n  \"/dev/sdb1\" is a new physical volume of \"2.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb1\n  VG Name\n  PV Size               2.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               YUHdrd-AH1x-ew0m-Mp9i-3GHp-S4zc-XxlDJM\n\n  \"/dev/sdb2\" is a new physical volume of \"3.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb2\n  VG Name\n  PV Size               3.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               wGDQvx-7zfs-g018-wqx4-Y8rh-1kWT-PnLuFu\n\n  \"/dev/sdb3\" is a new physical volume of \"2.00 GiB\"\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb3\n  VG Name\n  PV Size               2.00 GiB\n  Allocatable           NO\n  PE Size               0\n  Total PE              0\n  Free PE               0\n  Allocated PE          0\n  PV UUID               fykcuR-jooY-WKbi-yM8j-7fQ5-mhnH-JCkXC8\n```\n\n补充：如何删除物理卷\n\n```shell\n[root@lb01 ~]# pvremove /dev/sdb1\n```\n\n### 2.3 创建卷组（VG）\n\n将/dev/sdb{1,2,3}合并为卷组vg01\n\n```shell\n[root@lb01 ~]# vgcreate vg01 /dev/sdb1 /dev/sdb2 /dev/sdb3\n```\n\n查看卷组信息\n\n```shell\n[root@lb01 ~]# vgdisplay\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        3\n  Metadata Sequence No  1\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                0\n  Open LV               0\n  Max PV                0\n  Cur PV                3\n  Act PV                3\n  VG Size               <6.99 GiB\n  PE Size               4.00 MiB\n  Total PE              1789\n  Alloc PE / Size       0 / 0\n  Free  PE / Size       1789 / <6.99 GiB\n  VG UUID               gzeouH-16qO-n6xv-V6VM-A9ep-eK6E-ODuIwU\n```\n\n补充：如何删除卷组\n\n```shell\n[root@lb01 ~]# vgremove vg01\n  Volume group \"vg01\" successfully removed\n```\n\n### 2.4 创建逻辑卷（LV）\n\n创建一个名为lv01，大小为100M的逻辑卷\n\n```shell\n[root@lb01 ~]# lvcreate -L 100M -n lv01 vg01\n  Logical volume \"lv01\" created.\n```\n\n查看逻辑卷\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                xFksnb-ENc2-mEo4-5gEb-yaJj-wP2c-oFuBeT\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:39:16 +0800\n  LV Status              available\n  # open                 0\n  LV Size                100.00 MiB\n  Current LE             25\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n```\n\n补充：删除逻辑卷\n\n```shell\n[root@lb01 ~]# lvremove /dev/vg01/lv02\nDo you really want to remove active logical volume vg01/lv02? [y/n]: y\n  Logical volume \"lv02\" successfully removed\n```\n\n### 2.5 逻辑卷挂载\n\n格式化逻辑卷\n\n```shell\n[root@lb01 ~]# mkfs.ext4 /dev/vg01/lv01\nmke2fs 1.42.9 (28-Dec-2013)\nFilesystem label=\nOS type: Linux\nBlock size=1024 (log=0)\nFragment size=1024 (log=0)\nStride=0 blocks, Stripe width=0 blocks\n25688 inodes, 102400 blocks\n5120 blocks (5.00%) reserved for the super user\nFirst data block=1\nMaximum filesystem blocks=33685504\n13 block groups\n8192 blocks per group, 8192 fragments per group\n1976 inodes per group\nSuperblock backups stored on blocks:\n        8193, 24577, 40961, 57345, 73729\n\nAllocating group tables: done\nWriting inode tables: done\nCreating journal (4096 blocks): done\nWriting superblocks and filesystem accounting information: done\n```\n\n挂载逻辑卷\n\n```shell\n[root@lb01 ~]# mkdir /mnt/test-lv01\n[root@lb01 ~]# mount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01   93M  1.6M   85M   2% /mnt/test-lv01\n```\n\n### 2.6 扩展逻辑卷\n\n卸载逻辑卷\n\n```shell\n[root@lb01 ~]# umount /dev/vg01/lv01\n```\n\n将逻辑卷lv01调整为200M\n\n```shell\n[root@lb01 ~]# lvresize -L 200M /dev/vg01/lv01 \n  Size of logical volume vg01/lv01 changed from 100.00 MiB (25 extents) to 200.00 MiB (50 extents).\n  Logical volume vg01/lv01 successfully resized.\n```\n\n检查磁盘错误\n\n```shell\n[root@lb01 ~]# e2fsck -f /dev/vg01/lv01\ne2fsck 1.42.9 (28-Dec-2013)\nPass 1: Checking inodes, blocks, and sizes\nPass 2: Checking directory structure\nPass 3: Checking directory connectivity\nPass 4: Checking reference counts\nPass 5: Checking group summary information\n/dev/vg01/lv01: 11/25688 files (9.1% non-contiguous), 8896/102400 blocks\n```\n\n调整文件系统大小\n\n```shell\n[root@lb01 ~]# resize2fs /dev/vg01/lv01\n```\n\n查看逻辑卷信息\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:41:53 +0800\n  LV Status              available\n  # open                 0\n  LV Size                200.00 MiB\n  Current LE             50\n  Segments               2\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n  ...\n```\n\n重新挂载使用\n\n```shell\n[root@lb01 ~]# !mount\nmount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01  190M  1.6M  175M   1% /mnt/test-lv01\n```\n\n### 2.7 缩减逻辑卷\n\n卸载逻辑卷\n\n```shell\n[root@lb01 ~]# umount /dev/vg01/lv01\n```\n\n检查磁盘错误\n\n```shell\n[root@lb01 ~]# e2fsck -f /dev/vg01/lv01\ne2fsck 1.42.9 (28-Dec-2013)\nPass 1: Checking inodes, blocks, and sizes\nPass 2: Checking directory structure\nPass 3: Checking directory connectivity\nPass 4: Checking reference counts\nPass 5: Checking group summary information\n/dev/vg01/lv01: 11/49400 files (9.1% non-contiguous), 11884/204800 blocks\n```\n\n缩减文件系统大小，更新ext4信息\n\n```shell\n[root@lb01 ~]# resize2fs /dev/vg01/lv01 100M\nresize2fs 1.42.9 (28-Dec-2013)\nResizing the filesystem on /dev/vg01/lv01 to 102400 (1k) blocks.\nThe filesystem on /dev/vg01/lv01 is now 102400 blocks long.\n```\n\n完成后，减小逻辑卷大小\n\n```shell\n[root@lb01 ~]# lvresize -L 100M /dev/vg01/lv01\n  WARNING: Reducing active logical volume to 100.00 MiB.\n  THIS MAY DESTROY YOUR DATA (filesystem etc.)\nDo you really want to reduce vg01/lv01? [y/n]: y\n  Size of logical volume vg01/lv01 changed from 200.00 MiB (50 extents) to 100.00 MiB (25 extents).\n  Logical volume vg01/lv01 successfully resized.\n```\n\n查看逻辑卷信息\n\n```shell\n[root@lb01 ~]# lvdisplay\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, time lb01, 2021-09-01 20:41:53 +0800\n  LV Status              available\n  # open                 0\n  LV Size                100.00 MiB\n  Current LE             25\n  Segments               1\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently set to     8192\n  Block device           253:0\n  ...\n```\n\n挂载使用\n\n```shell\n[root@lb01 ~]# !mo\nmount /dev/vg01/lv01 /mnt/test-lv01\n[root@lb01 ~]# df -h\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  1.9G   46G   4% /\ndevtmpfs               479M     0  479M   0% /dev\ntmpfs                  489M     0  489M   0% /dev/shm\ntmpfs                  489M  6.8M  482M   2% /run\ntmpfs                  489M     0  489M   0% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  12% /boot\ntmpfs                   98M     0   98M   0% /run/user/0\n/dev/mapper/vg01-lv01   93M  1.6M   85M   2% /mnt/test-lv01\n```\n\n### 2.8 VG增加一块磁盘\n\n新盘创建lvm分区\n\n```shell\n[root@lb01 ~]# fdisk /dev/sdc\nWelcome to fdisk (util-linux 2.23.2).\n\nChanges will remain in memory only, until you decide to write them.\nBe careful before using the write command.\n\nDevice does not contain a recognized partition table\nBuilding a new DOS disklabel with disk identifier 0x05ff27fa.\n\nCommand (m for help): n\nPartition type:\n   p   primary (0 primary, 0 extended, 4 free)\n   e   extended\nSelect (default p):\nUsing default response p\nPartition number (1-4, default 1):\nFirst sector (2048-10485759, default 2048):\nUsing default value 2048\nLast sector, +sectors or +size{K,M,G} (2048-10485759, default 10485759): +4G\nPartition 1 of type Linux and of size 4 GiB is set\n\nCommand (m for help): t\nSelected partition 1\nHex code (type L to list all codes):\nHex code (type L to list all codes): 8e\nChanged type of partition 'Linux' to 'Linux LVM'\n\nCommand (m for help): p\n\nDisk /dev/sdc: 5368 MB, 5368709120 bytes, 10485760 sectors\nUnits = sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 512 bytes\nI/O size (minimum/optimal): 512 bytes / 512 bytes\nDisk label type: dos\nDisk identifier: 0x05ff27fa\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdc1            2048     8390655     4194304   8e  Linux LVM\n```\n\n创建物理卷\n\n```shell\n[root@lb01 ~]# pvcreate /dev/sdc1\n  Physical volume \"/dev/sdc1\" successfully created.\n```\n\n扩容VG\n\n```shell\n[root@lb01 ~]# vgextend vg01 /dev/sdc1\n  Volume group \"vg01\" successfully extended\n```\n\n查看VG信息\n\n```shell\n[root@lb01 ~]# vgdisplay vg01\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        4\n  Metadata Sequence No  10\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                0\n  Cur LV                2\n  Open LV               1\n  Max PV                0\n  Cur PV                4\n  Act PV                4\n  VG Size               10.98 GiB\n  PE Size               4.00 MiB\n  Total PE              2812\n  Alloc PE / Size       50 / 200.00 MiB\n  Free  PE / Size       2762 / <10.79 GiB\n  VG UUID               2Tjzna-XmXI-9MQ7-zeyc-AARV-84r5-jyymkf\n```\n\n>PS：尽管我们使用一个单独的磁盘做示范，其实只要是‘8e’类型的磁盘分区都可以用来扩展卷组。\n\n在VG中创建LV，可以看到磁盘都用上了\n\n```shell\n[root@lb01 ~]# lvcreate -L 10G -n lv03 vg01\n  Logical volume \"lv03\" created.\n[root@lb01 ~]# lsblk\nNAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda             8:0    0   50G  0 disk\n├─sda1          8:1    0    1G  0 part /boot\n├─sda2          8:2    0    2G  0 part [SWAP]\n└─sda3          8:3    0   47G  0 part /\nsdb             8:16   0   10G  0 disk\n├─sdb1          8:17   0    2G  0 part\n│ ├─vg01-lv01 253:0    0  100M  0 lvm  /mnt/test-lv01\n│ ├─vg01-lv02 253:1    0  100M  0 lvm\n│ └─vg01-lv03 253:2    0   10G  0 lvm\n├─sdb2          8:18   0    3G  0 part\n│ └─vg01-lv03 253:2    0   10G  0 lvm\n└─sdb3          8:19   0    2G  0 part\n  └─vg01-lv03 253:2    0   10G  0 lvm\nsdc             8:32   0    5G  0 disk\n└─sdc1          8:33   0    4G  0 part\n  └─vg01-lv03 253:2    0   10G  0 lvm\nsr0            11:0    1  792M  0 rom\n```\n\n\n\n","slug":"01_运维/01-基础命令/day19-磁盘分区/02_逻辑卷管理","published":1,"updated":"2022-07-06T07:14:41.390Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k25006da8v7f84xcoe4","content":"<h2 id=\"一、LVM介绍\"><a href=\"#一、LVM介绍\" class=\"headerlink\" title=\"一、LVM介绍\"></a>一、LVM介绍</h2><p>​\t逻辑卷管理LVM是一个多才多艺的硬盘系统工具。无论在Linux或者其他类似的系统，都是非常的好用。传统分区使用固定大小分区，重新调整大小十分麻烦。但是，LVM可以创建和管理“逻辑”卷，而不是直接使用物理硬盘。可以让管理员弹性的管理逻辑卷的扩大缩小，操作简单，而不损坏已存储的数据。可以随意将新的硬盘添加到LVM，以直接扩展已经存在的逻辑卷。LVM并不需要重启就可以让内核知道分区的存在。</p>\n<p>LVM使用分层结构，如下如所示：</p>\n<p><img src=\"/02_%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86.assets/134408sa12dauefffyszfg.jpg\" alt=\"img\"></p>\n<p>​\t图中顶部，首先是实际的物理磁盘及其划分的分区和其上的物理卷（PV）。一个或多个物理卷可以用来创建卷组（VG）。然后基于卷组可以创建逻辑卷（LV）。只要在卷组中有可用空间，就可以随心所欲的创建逻辑卷。文件系统就是在逻辑卷上创建的，然后可以在操作系统挂载和访问</p>\n<h2 id=\"二、LVM使用\"><a href=\"#二、LVM使用\" class=\"headerlink\" title=\"二、LVM使用\"></a>二、LVM使用</h2><h3 id=\"2-1-磁盘准备\"><a href=\"#2-1-磁盘准备\" class=\"headerlink\" title=\"2.1 磁盘准备\"></a>2.1 磁盘准备</h3><p>加装两块硬盘，sdb-10G与sdc-5G</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\nsdc      <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>    5G  <span class=\"token number\">0</span> disk\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>给sbd创建LVM分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdb</span>\nWelcome to <span class=\"token function\">fdisk</span> <span class=\"token punctuation\">(</span>util-linux <span class=\"token number\">2.23</span>.2<span class=\"token punctuation\">)</span>.\n\nChanges will remain <span class=\"token keyword\">in</span> memory only, <span class=\"token keyword\">until</span> you decide to <span class=\"token function\">write</span> them.\nBe careful before using the <span class=\"token function\">write</span> command.\n\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: n  <span class=\"token comment\"># 新建分区</span>\nPartition type:\n   p   primary <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> primary, <span class=\"token number\">0</span> extended, <span class=\"token number\">4</span> <span class=\"token function\">free</span><span class=\"token punctuation\">)</span>\n   e   extended\nSelect <span class=\"token punctuation\">(</span>default p<span class=\"token punctuation\">)</span>:\nUsing default response p\nPartition number <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>-4, default <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>:\nFirst sector <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-20971519, default <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span>:\nUsing default value <span class=\"token number\">2048</span>\nLast sector, +sectors or +size<span class=\"token punctuation\">&#123;</span>K,M,G<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-20971519, default <span class=\"token number\">20971519</span><span class=\"token punctuation\">)</span>: +2G\nPartition <span class=\"token number\">1</span> of <span class=\"token builtin class-name\">type</span> Linux and of size <span class=\"token number\">2</span> GiB is <span class=\"token builtin class-name\">set</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: t  <span class=\"token comment\"># 将分区改为LVM分区</span>\nSelected partition <span class=\"token number\">1</span>\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>: L\n\n <span class=\"token number\">0</span>  Empty           <span class=\"token number\">24</span>  NEC DOS         <span class=\"token number\">81</span>  Minix / old Lin bf  Solaris\n <span class=\"token number\">1</span>  FAT12           <span class=\"token number\">27</span>  Hidden NTFS Win <span class=\"token number\">82</span>  Linux swap / So c1  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">2</span>  XENIX root      <span class=\"token number\">39</span>  Plan <span class=\"token number\">9</span>          <span class=\"token number\">83</span>  Linux           c4  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">3</span>  XENIX usr       3c  PartitionMagic  <span class=\"token number\">84</span>  OS/2 hidden C:  c6  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">4</span>  FAT16 <span class=\"token operator\">&lt;</span>32M      <span class=\"token number\">40</span>  Venix <span class=\"token number\">80286</span>     <span class=\"token number\">85</span>  Linux extended  c7  Syrinx\n <span class=\"token number\">5</span>  Extended        <span class=\"token number\">41</span>  PPC PReP Boot   <span class=\"token number\">86</span>  NTFS volume <span class=\"token builtin class-name\">set</span> da  Non-FS data\n <span class=\"token number\">6</span>  FAT16           <span class=\"token number\">42</span>  SFS             <span class=\"token number\">87</span>  NTFS volume <span class=\"token builtin class-name\">set</span> db  CP/M / CTOS / <span class=\"token builtin class-name\">.</span>\n <span class=\"token number\">7</span>  HPFS/NTFS/exFAT 4d  QNX4.x          <span class=\"token number\">88</span>  Linux plaintext de  Dell Utility\n <span class=\"token number\">8</span>  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       <span class=\"token function\">df</span>  BootIt\n <span class=\"token number\">9</span>  AIX bootable    4f  QNX4.x 3rd part <span class=\"token number\">93</span>  Amoeba          e1  DOS access\n a  OS/2 Boot Manag <span class=\"token number\">50</span>  OnTrack DM      <span class=\"token number\">94</span>  Amoeba BBT      e3  DOS R/O\n b  W95 FAT32       <span class=\"token number\">51</span>  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor\n c  W95 FAT32 <span class=\"token punctuation\">(</span>LBA<span class=\"token punctuation\">)</span> <span class=\"token number\">52</span>  CP/M            a0  IBM Thinkpad hi eb  BeOS fs\n e  W95 FAT16 <span class=\"token punctuation\">(</span>LBA<span class=\"token punctuation\">)</span> <span class=\"token number\">53</span>  OnTrack DM6 Aux a5  FreeBSD         ee  GPT\n f  W95 Ext<span class=\"token string\">'d (LBA) 54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/\n10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC b\n11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor\n12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f4  SpeedStor\n14  Hidden FAT16 &lt;3 61  SpeedStor       ab  Darwin boot     f2  DOS secondary\n16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS\n17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE\n18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fd  Linux raid auto\n1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fe  LANstep\n1c  Hidden W95 FAT3 75  PC/IX           be  Solaris boot    ff  BBT\n1e  Hidden W95 FAT1 80  Old Minix\nHex code (type L to list all codes): 8e\nChanged type of partition '</span>Linux<span class=\"token string\">' to '</span>Linux LVM'\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: p\n\nDisk /dev/sdb: <span class=\"token number\">10.7</span> GB, <span class=\"token number\">10737418240</span> bytes, <span class=\"token number\">20971520</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            <span class=\"token number\">2048</span>     <span class=\"token number\">4196351</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重复添加，再加一个3G，一个2G的分区，可见分区表如下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk -l /dev/sdb</span>\n\nDisk /dev/sdb: <span class=\"token number\">10.7</span> GB, <span class=\"token number\">10737418240</span> bytes, <span class=\"token number\">20971520</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            <span class=\"token number\">2048</span>     <span class=\"token number\">4196351</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM\n/dev/sdb2         <span class=\"token number\">4196352</span>    <span class=\"token number\">10487807</span>     <span class=\"token number\">3145728</span>   8e  Linux LVM\n/dev/sdb3        <span class=\"token number\">10487808</span>    <span class=\"token number\">14682111</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-创建物理卷（PV）\"><a href=\"#2-2-创建物理卷（PV）\" class=\"headerlink\" title=\"2.2 创建物理卷（PV）\"></a>2.2 创建物理卷（PV）</h3><p>安装LVM工具</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install lvm2 </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将准备好的LVM分区生成为物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb1</span>\nWARNING: ext4 signature detected on /dev/sdb1 at offset <span class=\"token number\">1080</span>. Wipe it? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Wiping ext4 signature on /dev/sdb1.\n  Physical volume <span class=\"token string\">\"/dev/sdb1\"</span> successfully created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb2</span>\n  Physical volume <span class=\"token string\">\"/dev/sdb2\"</span> successfully created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb3</span>\n  Physical volume <span class=\"token string\">\"/dev/sdb3\"</span> successfully created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看物理卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvdisplay</span>\n  <span class=\"token string\">\"/dev/sdb1\"</span> is a new physical volume of <span class=\"token string\">\"2.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb1\n  VG Name\n  PV Size               <span class=\"token number\">2.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               YUHdrd-AH1x-ew0m-Mp9i-3GHp-S4zc-XxlDJM\n\n  <span class=\"token string\">\"/dev/sdb2\"</span> is a new physical volume of <span class=\"token string\">\"3.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb2\n  VG Name\n  PV Size               <span class=\"token number\">3.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               wGDQvx-7zfs-g018-wqx4-Y8rh-1kWT-PnLuFu\n\n  <span class=\"token string\">\"/dev/sdb3\"</span> is a new physical volume of <span class=\"token string\">\"2.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb3\n  VG Name\n  PV Size               <span class=\"token number\">2.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               fykcuR-jooY-WKbi-yM8j-7fQ5-mhnH-JCkXC8<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：如何删除物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvremove /dev/sdb1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-3-创建卷组（VG）\"><a href=\"#2-3-创建卷组（VG）\" class=\"headerlink\" title=\"2.3 创建卷组（VG）\"></a>2.3 创建卷组（VG）</h3><p>将&#x2F;dev&#x2F;sdb{1,2,3}合并为卷组vg01</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgcreate vg01 /dev/sdb1 /dev/sdb2 /dev/sdb3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看卷组信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgdisplay</span>\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        <span class=\"token number\">3</span>\n  Metadata Sequence No  <span class=\"token number\">1</span>\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                <span class=\"token number\">0</span>\n  Cur LV                <span class=\"token number\">0</span>\n  Open LV               <span class=\"token number\">0</span>\n  Max PV                <span class=\"token number\">0</span>\n  Cur PV                <span class=\"token number\">3</span>\n  Act PV                <span class=\"token number\">3</span>\n  VG Size               <span class=\"token operator\">&lt;</span><span class=\"token number\">6.99</span> GiB\n  PE Size               <span class=\"token number\">4.00</span> MiB\n  Total PE              <span class=\"token number\">1789</span>\n  Alloc PE / Size       <span class=\"token number\">0</span> / <span class=\"token number\">0</span>\n  Free  PE / Size       <span class=\"token number\">1789</span> / <span class=\"token operator\">&lt;</span><span class=\"token number\">6.99</span> GiB\n  VG UUID               gzeouH-16qO-n6xv-V6VM-A9ep-eK6E-ODuIwU<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：如何删除卷组</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgremove vg01</span>\n  Volume group <span class=\"token string\">\"vg01\"</span> successfully removed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-创建逻辑卷（LV）\"><a href=\"#2-4-创建逻辑卷（LV）\" class=\"headerlink\" title=\"2.4 创建逻辑卷（LV）\"></a>2.4 创建逻辑卷（LV）</h3><p>创建一个名为lv01，大小为100M的逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvcreate -L 100M -n lv01 vg01</span>\n  Logical volume <span class=\"token string\">\"lv01\"</span> created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                xFksnb-ENc2-mEo4-5gEb-yaJj-wP2c-oFuBeT\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:39:16 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">100.00</span> MiB\n  Current LE             <span class=\"token number\">25</span>\n  Segments               <span class=\"token number\">1</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：删除逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvremove /dev/vg01/lv02</span>\nDo you really want to remove active logical volume vg01/lv02? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Logical volume <span class=\"token string\">\"lv02\"</span> successfully removed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-逻辑卷挂载\"><a href=\"#2-5-逻辑卷挂载\" class=\"headerlink\" title=\"2.5 逻辑卷挂载\"></a>2.5 逻辑卷挂载</h3><p>格式化逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkfs.ext4 /dev/vg01/lv01</span>\n<span class=\"token function\">mke2fs</span> <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nFilesystem <span class=\"token assign-left variable\">label</span><span class=\"token operator\">=</span>\nOS type: Linux\nBlock <span class=\"token assign-left variable\">size</span><span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token punctuation\">(</span>log<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nFragment <span class=\"token assign-left variable\">size</span><span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token punctuation\">(</span>log<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token assign-left variable\">Stride</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> blocks, Stripe <span class=\"token assign-left variable\">width</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> blocks\n<span class=\"token number\">25688</span> inodes, <span class=\"token number\">102400</span> blocks\n<span class=\"token number\">5120</span> blocks <span class=\"token punctuation\">(</span><span class=\"token number\">5.00</span>%<span class=\"token punctuation\">)</span> reserved <span class=\"token keyword\">for</span> the super user\nFirst data <span class=\"token assign-left variable\">block</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\nMaximum filesystem <span class=\"token assign-left variable\">blocks</span><span class=\"token operator\">=</span><span class=\"token number\">33685504</span>\n<span class=\"token number\">13</span> block <span class=\"token function\">groups</span>\n<span class=\"token number\">8192</span> blocks per group, <span class=\"token number\">8192</span> fragments per group\n<span class=\"token number\">1976</span> inodes per group\nSuperblock backups stored on blocks:\n        <span class=\"token number\">8193</span>, <span class=\"token number\">24577</span>, <span class=\"token number\">40961</span>, <span class=\"token number\">57345</span>, <span class=\"token number\">73729</span>\n\nAllocating group tables: <span class=\"token keyword\">done</span>\nWriting inode tables: <span class=\"token keyword\">done</span>\nCreating journal <span class=\"token punctuation\">(</span><span class=\"token number\">4096</span> blocks<span class=\"token punctuation\">)</span>: <span class=\"token keyword\">done</span>\nWriting superblocks and filesystem accounting information: <span class=\"token keyword\">done</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /mnt/test-lv01</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount /dev/vg01/lv01 /mnt/test-lv01</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01   93M  <span class=\"token number\">1</span>.6M   85M   <span class=\"token number\">2</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-扩展逻辑卷\"><a href=\"#2-6-扩展逻辑卷\" class=\"headerlink\" title=\"2.6 扩展逻辑卷\"></a>2.6 扩展逻辑卷</h3><p>卸载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将逻辑卷lv01调整为200M</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvresize -L 200M /dev/vg01/lv01 </span>\n  Size of logical volume vg01/lv01 changed from <span class=\"token number\">100.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">25</span> extents<span class=\"token punctuation\">)</span> to <span class=\"token number\">200.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">50</span> extents<span class=\"token punctuation\">)</span>.\n  Logical volume vg01/lv01 successfully resized.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>检查磁盘错误</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># e2fsck -f /dev/vg01/lv01</span>\ne2fsck <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nPass <span class=\"token number\">1</span>: Checking inodes, blocks, and sizes\nPass <span class=\"token number\">2</span>: Checking directory structure\nPass <span class=\"token number\">3</span>: Checking directory connectivity\nPass <span class=\"token number\">4</span>: Checking reference counts\nPass <span class=\"token number\">5</span>: Checking group summary information\n/dev/vg01/lv01: <span class=\"token number\">11</span>/25688 files <span class=\"token punctuation\">(</span><span class=\"token number\">9.1</span>% non-contiguous<span class=\"token punctuation\">)</span>, <span class=\"token number\">8896</span>/102400 blocks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>调整文件系统大小</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看逻辑卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:41:53 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">200.00</span> MiB\n  Current LE             <span class=\"token number\">50</span>\n  Segments               <span class=\"token number\">2</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0\n  <span class=\"token punctuation\">..</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重新挂载使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># !mount</span>\n<span class=\"token function\">mount</span> /dev/vg01/lv01 /mnt/test-lv01\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01  190M  <span class=\"token number\">1</span>.6M  175M   <span class=\"token number\">1</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-7-缩减逻辑卷\"><a href=\"#2-7-缩减逻辑卷\" class=\"headerlink\" title=\"2.7 缩减逻辑卷\"></a>2.7 缩减逻辑卷</h3><p>卸载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>检查磁盘错误</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># e2fsck -f /dev/vg01/lv01</span>\ne2fsck <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nPass <span class=\"token number\">1</span>: Checking inodes, blocks, and sizes\nPass <span class=\"token number\">2</span>: Checking directory structure\nPass <span class=\"token number\">3</span>: Checking directory connectivity\nPass <span class=\"token number\">4</span>: Checking reference counts\nPass <span class=\"token number\">5</span>: Checking group summary information\n/dev/vg01/lv01: <span class=\"token number\">11</span>/49400 files <span class=\"token punctuation\">(</span><span class=\"token number\">9.1</span>% non-contiguous<span class=\"token punctuation\">)</span>, <span class=\"token number\">11884</span>/204800 blocks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>缩减文件系统大小，更新ext4信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/vg01/lv01 100M</span>\nresize2fs <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nResizing the filesystem on /dev/vg01/lv01 to <span class=\"token number\">102400</span> <span class=\"token punctuation\">(</span>1k<span class=\"token punctuation\">)</span> blocks.\nThe filesystem on /dev/vg01/lv01 is now <span class=\"token number\">102400</span> blocks long.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>完成后，减小逻辑卷大小</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvresize -L 100M /dev/vg01/lv01</span>\n  WARNING: Reducing active logical volume to <span class=\"token number\">100.00</span> MiB.\n  THIS MAY DESTROY YOUR DATA <span class=\"token punctuation\">(</span>filesystem etc.<span class=\"token punctuation\">)</span>\nDo you really want to reduce vg01/lv01? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Size of logical volume vg01/lv01 changed from <span class=\"token number\">200.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">50</span> extents<span class=\"token punctuation\">)</span> to <span class=\"token number\">100.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">25</span> extents<span class=\"token punctuation\">)</span>.\n  Logical volume vg01/lv01 successfully resized.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看逻辑卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:41:53 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">100.00</span> MiB\n  Current LE             <span class=\"token number\">25</span>\n  Segments               <span class=\"token number\">1</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0\n  <span class=\"token punctuation\">..</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># !mo</span>\n<span class=\"token function\">mount</span> /dev/vg01/lv01 /mnt/test-lv01\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01   93M  <span class=\"token number\">1</span>.6M   85M   <span class=\"token number\">2</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-VG增加一块磁盘\"><a href=\"#2-8-VG增加一块磁盘\" class=\"headerlink\" title=\"2.8 VG增加一块磁盘\"></a>2.8 VG增加一块磁盘</h3><p>新盘创建lvm分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdc</span>\nWelcome to <span class=\"token function\">fdisk</span> <span class=\"token punctuation\">(</span>util-linux <span class=\"token number\">2.23</span>.2<span class=\"token punctuation\">)</span>.\n\nChanges will remain <span class=\"token keyword\">in</span> memory only, <span class=\"token keyword\">until</span> you decide to <span class=\"token function\">write</span> them.\nBe careful before using the <span class=\"token function\">write</span> command.\n\nDevice does not contain a recognized partition table\nBuilding a new DOS disklabel with disk identifier 0x05ff27fa.\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: n\nPartition type:\n   p   primary <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> primary, <span class=\"token number\">0</span> extended, <span class=\"token number\">4</span> <span class=\"token function\">free</span><span class=\"token punctuation\">)</span>\n   e   extended\nSelect <span class=\"token punctuation\">(</span>default p<span class=\"token punctuation\">)</span>:\nUsing default response p\nPartition number <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>-4, default <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>:\nFirst sector <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-10485759, default <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span>:\nUsing default value <span class=\"token number\">2048</span>\nLast sector, +sectors or +size<span class=\"token punctuation\">&#123;</span>K,M,G<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-10485759, default <span class=\"token number\">10485759</span><span class=\"token punctuation\">)</span>: +4G\nPartition <span class=\"token number\">1</span> of <span class=\"token builtin class-name\">type</span> Linux and of size <span class=\"token number\">4</span> GiB is <span class=\"token builtin class-name\">set</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: t\nSelected partition <span class=\"token number\">1</span>\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>:\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>: 8e\nChanged <span class=\"token builtin class-name\">type</span> of partition <span class=\"token string\">'Linux'</span> to <span class=\"token string\">'Linux LVM'</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: p\n\nDisk /dev/sdc: <span class=\"token number\">5368</span> MB, <span class=\"token number\">5368709120</span> bytes, <span class=\"token number\">10485760</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x05ff27fa\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdc1            <span class=\"token number\">2048</span>     <span class=\"token number\">8390655</span>     <span class=\"token number\">4194304</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>创建物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdc1</span>\n  Physical volume <span class=\"token string\">\"/dev/sdc1\"</span> successfully created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>扩容VG</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgextend vg01 /dev/sdc1</span>\n  Volume group <span class=\"token string\">\"vg01\"</span> successfully extended<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看VG信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgdisplay vg01</span>\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        <span class=\"token number\">4</span>\n  Metadata Sequence No  <span class=\"token number\">10</span>\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                <span class=\"token number\">0</span>\n  Cur LV                <span class=\"token number\">2</span>\n  Open LV               <span class=\"token number\">1</span>\n  Max PV                <span class=\"token number\">0</span>\n  Cur PV                <span class=\"token number\">4</span>\n  Act PV                <span class=\"token number\">4</span>\n  VG Size               <span class=\"token number\">10.98</span> GiB\n  PE Size               <span class=\"token number\">4.00</span> MiB\n  Total PE              <span class=\"token number\">2812</span>\n  Alloc PE / Size       <span class=\"token number\">50</span> / <span class=\"token number\">200.00</span> MiB\n  Free  PE / Size       <span class=\"token number\">2762</span> / <span class=\"token operator\">&lt;</span><span class=\"token number\">10.79</span> GiB\n  VG UUID               2Tjzna-XmXI-9MQ7-zeyc-AARV-84r5-jyymkf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：尽管我们使用一个单独的磁盘做示范，其实只要是‘8e’类型的磁盘分区都可以用来扩展卷组。</p>\n</blockquote>\n<p>在VG中创建LV，可以看到磁盘都用上了</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvcreate -L 10G -n lv03 vg01</span>\n  Logical volume <span class=\"token string\">\"lv03\"</span> created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda             <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1          <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2          <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3          <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb             <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\n├─sdb1          <span class=\"token number\">8</span>:17   <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part\n│ ├─vg01-lv01 <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>  100M  <span class=\"token number\">0</span> lvm  /mnt/test-lv01\n│ ├─vg01-lv02 <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>  100M  <span class=\"token number\">0</span> lvm\n│ └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\n├─sdb2          <span class=\"token number\">8</span>:18   <span class=\"token number\">0</span>    3G  <span class=\"token number\">0</span> part\n│ └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\n└─sdb3          <span class=\"token number\">8</span>:19   <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part\n  └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\nsdc             <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>    5G  <span class=\"token number\">0</span> disk\n└─sdc1          <span class=\"token number\">8</span>:33   <span class=\"token number\">0</span>    4G  <span class=\"token number\">0</span> part\n  └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\nsr0            <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、LVM介绍\"><a href=\"#一、LVM介绍\" class=\"headerlink\" title=\"一、LVM介绍\"></a>一、LVM介绍</h2><p>​\t逻辑卷管理LVM是一个多才多艺的硬盘系统工具。无论在Linux或者其他类似的系统，都是非常的好用。传统分区使用固定大小分区，重新调整大小十分麻烦。但是，LVM可以创建和管理“逻辑”卷，而不是直接使用物理硬盘。可以让管理员弹性的管理逻辑卷的扩大缩小，操作简单，而不损坏已存储的数据。可以随意将新的硬盘添加到LVM，以直接扩展已经存在的逻辑卷。LVM并不需要重启就可以让内核知道分区的存在。</p>\n<p>LVM使用分层结构，如下如所示：</p>\n<p><img src=\"/02_%E9%80%BB%E8%BE%91%E5%8D%B7%E7%AE%A1%E7%90%86.assets/134408sa12dauefffyszfg.jpg\" alt=\"img\"></p>\n<p>​\t图中顶部，首先是实际的物理磁盘及其划分的分区和其上的物理卷（PV）。一个或多个物理卷可以用来创建卷组（VG）。然后基于卷组可以创建逻辑卷（LV）。只要在卷组中有可用空间，就可以随心所欲的创建逻辑卷。文件系统就是在逻辑卷上创建的，然后可以在操作系统挂载和访问</p>\n<h2 id=\"二、LVM使用\"><a href=\"#二、LVM使用\" class=\"headerlink\" title=\"二、LVM使用\"></a>二、LVM使用</h2><h3 id=\"2-1-磁盘准备\"><a href=\"#2-1-磁盘准备\" class=\"headerlink\" title=\"2.1 磁盘准备\"></a>2.1 磁盘准备</h3><p>加装两块硬盘，sdb-10G与sdc-5G</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\nsdc      <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>    5G  <span class=\"token number\">0</span> disk\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>给sbd创建LVM分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdb</span>\nWelcome to <span class=\"token function\">fdisk</span> <span class=\"token punctuation\">(</span>util-linux <span class=\"token number\">2.23</span>.2<span class=\"token punctuation\">)</span>.\n\nChanges will remain <span class=\"token keyword\">in</span> memory only, <span class=\"token keyword\">until</span> you decide to <span class=\"token function\">write</span> them.\nBe careful before using the <span class=\"token function\">write</span> command.\n\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: n  <span class=\"token comment\"># 新建分区</span>\nPartition type:\n   p   primary <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> primary, <span class=\"token number\">0</span> extended, <span class=\"token number\">4</span> <span class=\"token function\">free</span><span class=\"token punctuation\">)</span>\n   e   extended\nSelect <span class=\"token punctuation\">(</span>default p<span class=\"token punctuation\">)</span>:\nUsing default response p\nPartition number <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>-4, default <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>:\nFirst sector <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-20971519, default <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span>:\nUsing default value <span class=\"token number\">2048</span>\nLast sector, +sectors or +size<span class=\"token punctuation\">&#123;</span>K,M,G<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-20971519, default <span class=\"token number\">20971519</span><span class=\"token punctuation\">)</span>: +2G\nPartition <span class=\"token number\">1</span> of <span class=\"token builtin class-name\">type</span> Linux and of size <span class=\"token number\">2</span> GiB is <span class=\"token builtin class-name\">set</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: t  <span class=\"token comment\"># 将分区改为LVM分区</span>\nSelected partition <span class=\"token number\">1</span>\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>: L\n\n <span class=\"token number\">0</span>  Empty           <span class=\"token number\">24</span>  NEC DOS         <span class=\"token number\">81</span>  Minix / old Lin bf  Solaris\n <span class=\"token number\">1</span>  FAT12           <span class=\"token number\">27</span>  Hidden NTFS Win <span class=\"token number\">82</span>  Linux swap / So c1  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">2</span>  XENIX root      <span class=\"token number\">39</span>  Plan <span class=\"token number\">9</span>          <span class=\"token number\">83</span>  Linux           c4  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">3</span>  XENIX usr       3c  PartitionMagic  <span class=\"token number\">84</span>  OS/2 hidden C:  c6  DRDOS/sec <span class=\"token punctuation\">(</span>FAT-\n <span class=\"token number\">4</span>  FAT16 <span class=\"token operator\">&lt;</span>32M      <span class=\"token number\">40</span>  Venix <span class=\"token number\">80286</span>     <span class=\"token number\">85</span>  Linux extended  c7  Syrinx\n <span class=\"token number\">5</span>  Extended        <span class=\"token number\">41</span>  PPC PReP Boot   <span class=\"token number\">86</span>  NTFS volume <span class=\"token builtin class-name\">set</span> da  Non-FS data\n <span class=\"token number\">6</span>  FAT16           <span class=\"token number\">42</span>  SFS             <span class=\"token number\">87</span>  NTFS volume <span class=\"token builtin class-name\">set</span> db  CP/M / CTOS / <span class=\"token builtin class-name\">.</span>\n <span class=\"token number\">7</span>  HPFS/NTFS/exFAT 4d  QNX4.x          <span class=\"token number\">88</span>  Linux plaintext de  Dell Utility\n <span class=\"token number\">8</span>  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       <span class=\"token function\">df</span>  BootIt\n <span class=\"token number\">9</span>  AIX bootable    4f  QNX4.x 3rd part <span class=\"token number\">93</span>  Amoeba          e1  DOS access\n a  OS/2 Boot Manag <span class=\"token number\">50</span>  OnTrack DM      <span class=\"token number\">94</span>  Amoeba BBT      e3  DOS R/O\n b  W95 FAT32       <span class=\"token number\">51</span>  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor\n c  W95 FAT32 <span class=\"token punctuation\">(</span>LBA<span class=\"token punctuation\">)</span> <span class=\"token number\">52</span>  CP/M            a0  IBM Thinkpad hi eb  BeOS fs\n e  W95 FAT16 <span class=\"token punctuation\">(</span>LBA<span class=\"token punctuation\">)</span> <span class=\"token number\">53</span>  OnTrack DM6 Aux a5  FreeBSD         ee  GPT\n f  W95 Ext<span class=\"token string\">'d (LBA) 54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/\n10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC b\n11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor\n12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f4  SpeedStor\n14  Hidden FAT16 &lt;3 61  SpeedStor       ab  Darwin boot     f2  DOS secondary\n16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS\n17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE\n18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fd  Linux raid auto\n1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fe  LANstep\n1c  Hidden W95 FAT3 75  PC/IX           be  Solaris boot    ff  BBT\n1e  Hidden W95 FAT1 80  Old Minix\nHex code (type L to list all codes): 8e\nChanged type of partition '</span>Linux<span class=\"token string\">' to '</span>Linux LVM'\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: p\n\nDisk /dev/sdb: <span class=\"token number\">10.7</span> GB, <span class=\"token number\">10737418240</span> bytes, <span class=\"token number\">20971520</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            <span class=\"token number\">2048</span>     <span class=\"token number\">4196351</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重复添加，再加一个3G，一个2G的分区，可见分区表如下：</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk -l /dev/sdb</span>\n\nDisk /dev/sdb: <span class=\"token number\">10.7</span> GB, <span class=\"token number\">10737418240</span> bytes, <span class=\"token number\">20971520</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x0005122b\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdb1            <span class=\"token number\">2048</span>     <span class=\"token number\">4196351</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM\n/dev/sdb2         <span class=\"token number\">4196352</span>    <span class=\"token number\">10487807</span>     <span class=\"token number\">3145728</span>   8e  Linux LVM\n/dev/sdb3        <span class=\"token number\">10487808</span>    <span class=\"token number\">14682111</span>     <span class=\"token number\">2097152</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-2-创建物理卷（PV）\"><a href=\"#2-2-创建物理卷（PV）\" class=\"headerlink\" title=\"2.2 创建物理卷（PV）\"></a>2.2 创建物理卷（PV）</h3><p>安装LVM工具</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install lvm2 </span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将准备好的LVM分区生成为物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb1</span>\nWARNING: ext4 signature detected on /dev/sdb1 at offset <span class=\"token number\">1080</span>. Wipe it? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Wiping ext4 signature on /dev/sdb1.\n  Physical volume <span class=\"token string\">\"/dev/sdb1\"</span> successfully created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb2</span>\n  Physical volume <span class=\"token string\">\"/dev/sdb2\"</span> successfully created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdb3</span>\n  Physical volume <span class=\"token string\">\"/dev/sdb3\"</span> successfully created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看物理卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvdisplay</span>\n  <span class=\"token string\">\"/dev/sdb1\"</span> is a new physical volume of <span class=\"token string\">\"2.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb1\n  VG Name\n  PV Size               <span class=\"token number\">2.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               YUHdrd-AH1x-ew0m-Mp9i-3GHp-S4zc-XxlDJM\n\n  <span class=\"token string\">\"/dev/sdb2\"</span> is a new physical volume of <span class=\"token string\">\"3.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb2\n  VG Name\n  PV Size               <span class=\"token number\">3.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               wGDQvx-7zfs-g018-wqx4-Y8rh-1kWT-PnLuFu\n\n  <span class=\"token string\">\"/dev/sdb3\"</span> is a new physical volume of <span class=\"token string\">\"2.00 GiB\"</span>\n  --- NEW Physical volume ---\n  PV Name               /dev/sdb3\n  VG Name\n  PV Size               <span class=\"token number\">2.00</span> GiB\n  Allocatable           NO\n  PE Size               <span class=\"token number\">0</span>\n  Total PE              <span class=\"token number\">0</span>\n  Free PE               <span class=\"token number\">0</span>\n  Allocated PE          <span class=\"token number\">0</span>\n  PV UUID               fykcuR-jooY-WKbi-yM8j-7fQ5-mhnH-JCkXC8<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：如何删除物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvremove /dev/sdb1</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"2-3-创建卷组（VG）\"><a href=\"#2-3-创建卷组（VG）\" class=\"headerlink\" title=\"2.3 创建卷组（VG）\"></a>2.3 创建卷组（VG）</h3><p>将&#x2F;dev&#x2F;sdb{1,2,3}合并为卷组vg01</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgcreate vg01 /dev/sdb1 /dev/sdb2 /dev/sdb3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看卷组信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgdisplay</span>\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        <span class=\"token number\">3</span>\n  Metadata Sequence No  <span class=\"token number\">1</span>\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                <span class=\"token number\">0</span>\n  Cur LV                <span class=\"token number\">0</span>\n  Open LV               <span class=\"token number\">0</span>\n  Max PV                <span class=\"token number\">0</span>\n  Cur PV                <span class=\"token number\">3</span>\n  Act PV                <span class=\"token number\">3</span>\n  VG Size               <span class=\"token operator\">&lt;</span><span class=\"token number\">6.99</span> GiB\n  PE Size               <span class=\"token number\">4.00</span> MiB\n  Total PE              <span class=\"token number\">1789</span>\n  Alloc PE / Size       <span class=\"token number\">0</span> / <span class=\"token number\">0</span>\n  Free  PE / Size       <span class=\"token number\">1789</span> / <span class=\"token operator\">&lt;</span><span class=\"token number\">6.99</span> GiB\n  VG UUID               gzeouH-16qO-n6xv-V6VM-A9ep-eK6E-ODuIwU<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：如何删除卷组</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgremove vg01</span>\n  Volume group <span class=\"token string\">\"vg01\"</span> successfully removed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-4-创建逻辑卷（LV）\"><a href=\"#2-4-创建逻辑卷（LV）\" class=\"headerlink\" title=\"2.4 创建逻辑卷（LV）\"></a>2.4 创建逻辑卷（LV）</h3><p>创建一个名为lv01，大小为100M的逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvcreate -L 100M -n lv01 vg01</span>\n  Logical volume <span class=\"token string\">\"lv01\"</span> created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                xFksnb-ENc2-mEo4-5gEb-yaJj-wP2c-oFuBeT\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:39:16 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">100.00</span> MiB\n  Current LE             <span class=\"token number\">25</span>\n  Segments               <span class=\"token number\">1</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>补充：删除逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvremove /dev/vg01/lv02</span>\nDo you really want to remove active logical volume vg01/lv02? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Logical volume <span class=\"token string\">\"lv02\"</span> successfully removed<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-5-逻辑卷挂载\"><a href=\"#2-5-逻辑卷挂载\" class=\"headerlink\" title=\"2.5 逻辑卷挂载\"></a>2.5 逻辑卷挂载</h3><p>格式化逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkfs.ext4 /dev/vg01/lv01</span>\n<span class=\"token function\">mke2fs</span> <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nFilesystem <span class=\"token assign-left variable\">label</span><span class=\"token operator\">=</span>\nOS type: Linux\nBlock <span class=\"token assign-left variable\">size</span><span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token punctuation\">(</span>log<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nFragment <span class=\"token assign-left variable\">size</span><span class=\"token operator\">=</span><span class=\"token number\">1024</span> <span class=\"token punctuation\">(</span>log<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token assign-left variable\">Stride</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> blocks, Stripe <span class=\"token assign-left variable\">width</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> blocks\n<span class=\"token number\">25688</span> inodes, <span class=\"token number\">102400</span> blocks\n<span class=\"token number\">5120</span> blocks <span class=\"token punctuation\">(</span><span class=\"token number\">5.00</span>%<span class=\"token punctuation\">)</span> reserved <span class=\"token keyword\">for</span> the super user\nFirst data <span class=\"token assign-left variable\">block</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\nMaximum filesystem <span class=\"token assign-left variable\">blocks</span><span class=\"token operator\">=</span><span class=\"token number\">33685504</span>\n<span class=\"token number\">13</span> block <span class=\"token function\">groups</span>\n<span class=\"token number\">8192</span> blocks per group, <span class=\"token number\">8192</span> fragments per group\n<span class=\"token number\">1976</span> inodes per group\nSuperblock backups stored on blocks:\n        <span class=\"token number\">8193</span>, <span class=\"token number\">24577</span>, <span class=\"token number\">40961</span>, <span class=\"token number\">57345</span>, <span class=\"token number\">73729</span>\n\nAllocating group tables: <span class=\"token keyword\">done</span>\nWriting inode tables: <span class=\"token keyword\">done</span>\nCreating journal <span class=\"token punctuation\">(</span><span class=\"token number\">4096</span> blocks<span class=\"token punctuation\">)</span>: <span class=\"token keyword\">done</span>\nWriting superblocks and filesystem accounting information: <span class=\"token keyword\">done</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /mnt/test-lv01</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount /dev/vg01/lv01 /mnt/test-lv01</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01   93M  <span class=\"token number\">1</span>.6M   85M   <span class=\"token number\">2</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-6-扩展逻辑卷\"><a href=\"#2-6-扩展逻辑卷\" class=\"headerlink\" title=\"2.6 扩展逻辑卷\"></a>2.6 扩展逻辑卷</h3><p>卸载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>将逻辑卷lv01调整为200M</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvresize -L 200M /dev/vg01/lv01 </span>\n  Size of logical volume vg01/lv01 changed from <span class=\"token number\">100.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">25</span> extents<span class=\"token punctuation\">)</span> to <span class=\"token number\">200.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">50</span> extents<span class=\"token punctuation\">)</span>.\n  Logical volume vg01/lv01 successfully resized.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>检查磁盘错误</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># e2fsck -f /dev/vg01/lv01</span>\ne2fsck <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nPass <span class=\"token number\">1</span>: Checking inodes, blocks, and sizes\nPass <span class=\"token number\">2</span>: Checking directory structure\nPass <span class=\"token number\">3</span>: Checking directory connectivity\nPass <span class=\"token number\">4</span>: Checking reference counts\nPass <span class=\"token number\">5</span>: Checking group summary information\n/dev/vg01/lv01: <span class=\"token number\">11</span>/25688 files <span class=\"token punctuation\">(</span><span class=\"token number\">9.1</span>% non-contiguous<span class=\"token punctuation\">)</span>, <span class=\"token number\">8896</span>/102400 blocks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>调整文件系统大小</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>查看逻辑卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:41:53 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">200.00</span> MiB\n  Current LE             <span class=\"token number\">50</span>\n  Segments               <span class=\"token number\">2</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0\n  <span class=\"token punctuation\">..</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>重新挂载使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># !mount</span>\n<span class=\"token function\">mount</span> /dev/vg01/lv01 /mnt/test-lv01\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01  190M  <span class=\"token number\">1</span>.6M  175M   <span class=\"token number\">1</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-7-缩减逻辑卷\"><a href=\"#2-7-缩减逻辑卷\" class=\"headerlink\" title=\"2.7 缩减逻辑卷\"></a>2.7 缩减逻辑卷</h3><p>卸载逻辑卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/vg01/lv01</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>检查磁盘错误</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># e2fsck -f /dev/vg01/lv01</span>\ne2fsck <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nPass <span class=\"token number\">1</span>: Checking inodes, blocks, and sizes\nPass <span class=\"token number\">2</span>: Checking directory structure\nPass <span class=\"token number\">3</span>: Checking directory connectivity\nPass <span class=\"token number\">4</span>: Checking reference counts\nPass <span class=\"token number\">5</span>: Checking group summary information\n/dev/vg01/lv01: <span class=\"token number\">11</span>/49400 files <span class=\"token punctuation\">(</span><span class=\"token number\">9.1</span>% non-contiguous<span class=\"token punctuation\">)</span>, <span class=\"token number\">11884</span>/204800 blocks<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>缩减文件系统大小，更新ext4信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/vg01/lv01 100M</span>\nresize2fs <span class=\"token number\">1.42</span>.9 <span class=\"token punctuation\">(</span><span class=\"token number\">28</span>-Dec-2013<span class=\"token punctuation\">)</span>\nResizing the filesystem on /dev/vg01/lv01 to <span class=\"token number\">102400</span> <span class=\"token punctuation\">(</span>1k<span class=\"token punctuation\">)</span> blocks.\nThe filesystem on /dev/vg01/lv01 is now <span class=\"token number\">102400</span> blocks long.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>完成后，减小逻辑卷大小</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvresize -L 100M /dev/vg01/lv01</span>\n  WARNING: Reducing active logical volume to <span class=\"token number\">100.00</span> MiB.\n  THIS MAY DESTROY YOUR DATA <span class=\"token punctuation\">(</span>filesystem etc.<span class=\"token punctuation\">)</span>\nDo you really want to reduce vg01/lv01? <span class=\"token punctuation\">[</span>y/n<span class=\"token punctuation\">]</span>: y\n  Size of logical volume vg01/lv01 changed from <span class=\"token number\">200.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">50</span> extents<span class=\"token punctuation\">)</span> to <span class=\"token number\">100.00</span> MiB <span class=\"token punctuation\">(</span><span class=\"token number\">25</span> extents<span class=\"token punctuation\">)</span>.\n  Logical volume vg01/lv01 successfully resized.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看逻辑卷信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvdisplay</span>\n  --- Logical volume ---\n  LV Path                /dev/vg01/lv01\n  LV Name                lv01\n  VG Name                vg01\n  LV UUID                svm5Xk-B8jZ-QhZw-egCm-x6b2-e5Jt-wvMi2F\n  LV Write Access        read/write\n  LV Creation host, <span class=\"token function\">time</span> lb01, <span class=\"token number\">2021</span>-09-01 <span class=\"token number\">20</span>:41:53 +0800\n  LV Status              available\n  <span class=\"token comment\"># open                 0</span>\n  LV Size                <span class=\"token number\">100.00</span> MiB\n  Current LE             <span class=\"token number\">25</span>\n  Segments               <span class=\"token number\">1</span>\n  Allocation             inherit\n  Read ahead sectors     auto\n  - currently <span class=\"token builtin class-name\">set</span> to     <span class=\"token number\">8192</span>\n  Block device           <span class=\"token number\">253</span>:0\n  <span class=\"token punctuation\">..</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>挂载使用</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># !mo</span>\n<span class=\"token function\">mount</span> /dev/vg01/lv01 /mnt/test-lv01\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># df -h</span>\nFilesystem             Size  Used Avail Use% Mounted on\n/dev/sda3               47G  <span class=\"token number\">1</span>.9G   46G   <span class=\"token number\">4</span>% /\ndevtmpfs               479M     <span class=\"token number\">0</span>  479M   <span class=\"token number\">0</span>% /dev\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /dev/shm\ntmpfs                  489M  <span class=\"token number\">6</span>.8M  482M   <span class=\"token number\">2</span>% /run\ntmpfs                  489M     <span class=\"token number\">0</span>  489M   <span class=\"token number\">0</span>% /sys/fs/cgroup\n/dev/sda1             1014M  119M  896M  <span class=\"token number\">12</span>% /boot\ntmpfs                   98M     <span class=\"token number\">0</span>   98M   <span class=\"token number\">0</span>% /run/user/0\n/dev/mapper/vg01-lv01   93M  <span class=\"token number\">1</span>.6M   85M   <span class=\"token number\">2</span>% /mnt/test-lv01<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-8-VG增加一块磁盘\"><a href=\"#2-8-VG增加一块磁盘\" class=\"headerlink\" title=\"2.8 VG增加一块磁盘\"></a>2.8 VG增加一块磁盘</h3><p>新盘创建lvm分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># fdisk /dev/sdc</span>\nWelcome to <span class=\"token function\">fdisk</span> <span class=\"token punctuation\">(</span>util-linux <span class=\"token number\">2.23</span>.2<span class=\"token punctuation\">)</span>.\n\nChanges will remain <span class=\"token keyword\">in</span> memory only, <span class=\"token keyword\">until</span> you decide to <span class=\"token function\">write</span> them.\nBe careful before using the <span class=\"token function\">write</span> command.\n\nDevice does not contain a recognized partition table\nBuilding a new DOS disklabel with disk identifier 0x05ff27fa.\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: n\nPartition type:\n   p   primary <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> primary, <span class=\"token number\">0</span> extended, <span class=\"token number\">4</span> <span class=\"token function\">free</span><span class=\"token punctuation\">)</span>\n   e   extended\nSelect <span class=\"token punctuation\">(</span>default p<span class=\"token punctuation\">)</span>:\nUsing default response p\nPartition number <span class=\"token punctuation\">(</span><span class=\"token number\">1</span>-4, default <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>:\nFirst sector <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-10485759, default <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span>:\nUsing default value <span class=\"token number\">2048</span>\nLast sector, +sectors or +size<span class=\"token punctuation\">&#123;</span>K,M,G<span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2048</span>-10485759, default <span class=\"token number\">10485759</span><span class=\"token punctuation\">)</span>: +4G\nPartition <span class=\"token number\">1</span> of <span class=\"token builtin class-name\">type</span> Linux and of size <span class=\"token number\">4</span> GiB is <span class=\"token builtin class-name\">set</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: t\nSelected partition <span class=\"token number\">1</span>\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>:\nHex code <span class=\"token punctuation\">(</span>type L to list all codes<span class=\"token punctuation\">)</span>: 8e\nChanged <span class=\"token builtin class-name\">type</span> of partition <span class=\"token string\">'Linux'</span> to <span class=\"token string\">'Linux LVM'</span>\n\nCommand <span class=\"token punctuation\">(</span>m <span class=\"token keyword\">for</span> <span class=\"token builtin class-name\">help</span><span class=\"token punctuation\">)</span>: p\n\nDisk /dev/sdc: <span class=\"token number\">5368</span> MB, <span class=\"token number\">5368709120</span> bytes, <span class=\"token number\">10485760</span> sectors\nUnits <span class=\"token operator\">=</span> sectors of <span class=\"token number\">1</span> * <span class=\"token number\">512</span> <span class=\"token operator\">=</span> <span class=\"token number\">512</span> bytes\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nI/O size <span class=\"token punctuation\">(</span>minimum/optimal<span class=\"token punctuation\">)</span>: <span class=\"token number\">512</span> bytes / <span class=\"token number\">512</span> bytes\nDisk label type: dos\nDisk identifier: 0x05ff27fa\n\n   Device Boot      Start         End      Blocks   Id  System\n/dev/sdc1            <span class=\"token number\">2048</span>     <span class=\"token number\">8390655</span>     <span class=\"token number\">4194304</span>   8e  Linux LVM<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>创建物理卷</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pvcreate /dev/sdc1</span>\n  Physical volume <span class=\"token string\">\"/dev/sdc1\"</span> successfully created.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>扩容VG</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgextend vg01 /dev/sdc1</span>\n  Volume group <span class=\"token string\">\"vg01\"</span> successfully extended<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span></span></code></pre>\n\n<p>查看VG信息</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vgdisplay vg01</span>\n  --- Volume group ---\n  VG Name               vg01\n  System ID\n  Format                lvm2\n  Metadata Areas        <span class=\"token number\">4</span>\n  Metadata Sequence No  <span class=\"token number\">10</span>\n  VG Access             read/write\n  VG Status             resizable\n  MAX LV                <span class=\"token number\">0</span>\n  Cur LV                <span class=\"token number\">2</span>\n  Open LV               <span class=\"token number\">1</span>\n  Max PV                <span class=\"token number\">0</span>\n  Cur PV                <span class=\"token number\">4</span>\n  Act PV                <span class=\"token number\">4</span>\n  VG Size               <span class=\"token number\">10.98</span> GiB\n  PE Size               <span class=\"token number\">4.00</span> MiB\n  Total PE              <span class=\"token number\">2812</span>\n  Alloc PE / Size       <span class=\"token number\">50</span> / <span class=\"token number\">200.00</span> MiB\n  Free  PE / Size       <span class=\"token number\">2762</span> / <span class=\"token operator\">&lt;</span><span class=\"token number\">10.79</span> GiB\n  VG UUID               2Tjzna-XmXI-9MQ7-zeyc-AARV-84r5-jyymkf<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>PS：尽管我们使用一个单独的磁盘做示范，其实只要是‘8e’类型的磁盘分区都可以用来扩展卷组。</p>\n</blockquote>\n<p>在VG中创建LV，可以看到磁盘都用上了</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lvcreate -L 10G -n lv03 vg01</span>\n  Logical volume <span class=\"token string\">\"lv03\"</span> created.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda             <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1          <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2          <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3          <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb             <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\n├─sdb1          <span class=\"token number\">8</span>:17   <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part\n│ ├─vg01-lv01 <span class=\"token number\">253</span>:0    <span class=\"token number\">0</span>  100M  <span class=\"token number\">0</span> lvm  /mnt/test-lv01\n│ ├─vg01-lv02 <span class=\"token number\">253</span>:1    <span class=\"token number\">0</span>  100M  <span class=\"token number\">0</span> lvm\n│ └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\n├─sdb2          <span class=\"token number\">8</span>:18   <span class=\"token number\">0</span>    3G  <span class=\"token number\">0</span> part\n│ └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\n└─sdb3          <span class=\"token number\">8</span>:19   <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part\n  └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\nsdc             <span class=\"token number\">8</span>:32   <span class=\"token number\">0</span>    5G  <span class=\"token number\">0</span> disk\n└─sdc1          <span class=\"token number\">8</span>:33   <span class=\"token number\">0</span>    4G  <span class=\"token number\">0</span> part\n  └─vg01-lv03 <span class=\"token number\">253</span>:2    <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> lvm\nsr0            <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n"},{"title":"运维之基础命令--磁盘分区","date":"2022-07-06T03:19:52.000Z","_content":"\n## 一、磁盘分区方案\n\n### 1.1 MBR与GPT介绍\n\nLinux中磁盘分区有两种方案\n\n- **MBR**（主引导记录）\n- **GPT**（GUID分区表）\n\n**<font color='blue'>MBR分区方案</font>**的特点（支持的磁盘容量<=2T）：\n\n1. 最多支持四个主分区 \n2. 在Linux上使用扩展分区和逻辑分区最多可以创建15个分区， \n3. 由于分区中的数据以32位存储，使用MBR分区是最大支持2T空间。 \n4. 用fdisk管理工具来创建MBR分区\n\n**<font color='red'>GPT分区方案</font>**的特点（支持的磁盘容量>2T）：\n\n1. 是UEFI标准的一部分，主板必须要支持UEFI标准 \n2. GPT分区列表支持最大128PB(1PB=1024TB) \n3. 可以定义128个分区 \n4. 没有主分区，扩展分区和逻辑分区的概念，所有分区都能格式化 \n5. gdisk和parted管理工具可以创建GPT分区\n\n### 1.2 MBR与GTP的区别\n\n| 对比项             | MBR                                      | GPT                                    |\n| ------------------ | ---------------------------------------- | -------------------------------------- |\n| 新旧度             | 旧                                       | 新                                     |\n| 支持的硬盘容量大小 | 最大2TB                                  | 支持2T以上                             |\n| 分区计数           | 最多支持4个主分区或3个主分区一个扩展分区 | 最多支持128个分区,部分主分区、扩展分区 |\n| 安全功能           | 不提供任何安全功能                       | 支持CRC32校验和机制                    |\n\n## 二、分区工具使用\n\n### 2.1 MBR分区工具fdisk\n\n### 2.2 GPT分区工具gdisk\n\n### 2.3 GPT分区工具parted\n\n​\tparted用于对磁盘（或RAID磁盘）进行分区及管理，与fdisk分区工具相比，支持2TB以上的磁盘分区，并且允许调整分区的大小，<font color='red'>支持命令行方式或交互式方式</font>，常用命令如下：\n\n| parted交互命令                          | 说 明                                    |\n| --------------------------------------- | ---------------------------------------- |\n| check NUMBER                            | 做一次简单的文件系统检测                 |\n| cp [FROM-DEVICE] FROM-NUMBER TO-NUMBER  | 复制文件系统到另一个分区                 |\n| help [COMMAND]                          | 显示所有的命令帮助                       |\n| mklabel,mktable LABEL-TYPE              | 创建新的磁盘卷标（分区表）               |\n| mkfs NUMBER FS-TYPE                     | 在分区上建立文件系统                     |\n| mkpart PART-TYPE [FS-TYPE] START END    | 创建一个分区                             |\n| mkpartfs PART-TYPE FS-TYPE START END    | 创建分区，并建立文件系统                 |\n| move NUMBER START END                   | 移动分区                                 |\n| name NUMBER NAME                        | 给分区命名                               |\n| print [devices\\|free\\|list,all\\|NUMBER] | 显示分区表、活动设备、空闲空间、所有分区 |\n| quit                                    | 退出                                     |\n| rescue START END                        | 修复丢失的分区                           |\n| resize NUMBER START END                 | 修改分区大小                             |\n| rm NUMBER                               | 删除分区                                 |\n| select DEVICE                           | 选择需要编辑的设备                       |\n| set NUMBER FLAG STATE                   | 改变分区标记                             |\n| toggle [NUMBER [FLAG]]                  | 切换分区表的状态                         |\n| unit UNIT                               | 设置默认的单位                           |\n| Version                                 | 显示版本                                 |\n\n>关于mkpart与PART-TYPE（FS-TYPE）的解释：\n>\n>Make a part-type partition for filesystem fs-type (if specified), beginning at start and ending at end (by default in megabytes).  fs-type can  be  one  of  \"btrfs\",  \"ext2\", \"ext3\", \"ext4\", \"fat16\", \"fat32\", \"hfs\", \"hfs+\", \"linux-swap\", \"ntfs\", \"reiserfs\", or \"xfs\".  part-type should be one of \"primary\", \"logical\", or \"extended\".\n\n#### 2.3.1 使用parted\n\n#### 2.3.1.1 列出所有块设备分区情况\n\n```shell\n# 查看当前有哪些块设备\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\nsr0     11:0    1  792M  0 rom\n\n# 查看分区情况\n[root@lb01 ~]# parted -l\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sda: 53.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system     Flags\n 1      1049kB  1075MB  1074MB  primary  xfs             boot\n 2      1075MB  3223MB  2149MB  primary  linux-swap(v1)\n 3      3223MB  53.7GB  50.5GB  primary  xfs\n\n\nError: /dev/sdb: unrecognised disk label\t# sdb还没有分区\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: unknown\nDisk Flags:\n\nWarning: Unable to open /dev/sr0 read-write (Read-only file system).  /dev/sr0\nhas been opened read-only.\nModel: NECVMWar VMware IDE CDR10 (scsi)\nDisk /dev/sr0: 830MB\nSector size (logical/physical): 2048B/2048B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End     Size    Type     File system  Flags\n 2      885kB  37.7MB  36.8MB  primary\n```\n\n#### 2.3.1.2 创建分区\n\n> 案例：在/dev/sdb中创建一个1GB的分区\n\na、命令行方式，创建一个主分区\n\n```shell\n# 转换为MBR分区方案msdos, GPT方案为gpt\n[root@lb01 ~]# parted /dev/sdb mklabel msdos\nInformation: You may need to update /etc/fstab.\n\n# 创建主分区\n[root@lb01 ~]# parted /dev/sdb mkpart primary ext4 0GB 1GB  # 把1GB换成100%就是分完剩余空间\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\n└─sdb1   8:17   0  953M  0 part\nsr0     11:0    1  792M  0 rom\n\n```\n\nb、再用交互方式，继续创建一个主分区\n\n```shell\n[root@lb01 ~]# parted\nGNU Parted 3.1\nUsing /dev/sda\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) select /dev/sdb # 选择块设备\nUsing /dev/sdb\n(parted) mkpart\t# 新建分区\nPartition type?  primary/extended? primary\nFile system type?  [ext2]? ext4\nStart? 1GB\nEnd? 2GB\n```\n\nc、扩展分区与逻辑分区的创建\n\n>扩展分区最多只有一个，再创建会提示选择primary/logical\n\n```shell\n(parted) select /dev/sdb\nUsing /dev/sdb\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n\n# 给扩展分区2创建一个逻辑分区（使用范围只能在扩展分区2的范围内）\n(parted) mkpart logical 1GB 2GB\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n 5      1001MB  2000MB  998MB   logical\n\n# 给扩展分区2再创建一个逻辑分区\n(parted) mkpart logical 2GB 3GB\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n 5      1001MB  2000MB  998MB   logical\n 6      2001MB  3000MB  999MB   logical\n```\n\n#### 2.3.1.3 查看分区\n\n```shell\n(parted) print # 打印分区\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n 2      1000MB  2000MB  999MB  primary\n \n (parted) print free # 查看剩余空间\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n        32.3kB  1049kB  1016kB           Free Space\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  2000MB  999MB   primary\n        2000MB  10.7GB  8738MB           Free Space\n\n```\n\n#### 2.3.1.4 调整分区大小\n\n>将分区2从1GB扩展到2GB\n>\n>PS：v2.4之后的版本，resize命令已经移除，更新到3.1-32版本有resizepart\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n 2      1000MB  2000MB  999MB  primary\n\n# 调整分区2的大小为2GB\n[root@lb01 ~]# parted /dev/sdb resizepart 2 3GB\t(3GB是指END位置，即使用1GB-3GB的空间，共2GB)\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  3000MB  2000MB  primary\n \n # 如果已经格式化并挂载使用，需要重新调整文件系统大小\n [root@lb01 ~]# resize2fs /dev/sdb2\n```\n\n>缩小分区大小会怎样？将提示有数据丢失的风险\n\n```shell\n[root@lb01 ~]# parted /dev/sdb resizepart 2 2GB\nWarning: Shrinking a partition can cause data loss, are you sure you want to continue?\nYes/No?\n```\n\n#### 2.3.1.5 删除分区\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  4000MB  3000MB  primary  ext4\n\n[root@lb01 ~]# parted /dev/sdb rm 2   // 删除2号分区，因为已挂载，会提示要先卸载\nError: Partition /dev/sdb2 is being used. You must unmount it before you modify it with Parted.\n[root@lb01 ~]# umount /dev/sdb2\n[root@lb01 ~]# parted /dev/sdb rm 2 // 删除成功\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# print\n-bash: print: command not found\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n```\n\n#### 2.3.1.6 设置/更改分区标志\n\n```shell\n[root@lb01 ~]# parted /dev/sdb set 1 lvm on\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary               lvm\n```\n\n查看有哪些标志可以设置\n\n```shell\n[root@lb01 ~]# parted\nGNU Parted 3.1\nUsing /dev/sda\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) help set\n  set NUMBER FLAG STATE                    change the FLAG on partition NUMBER\n\n        NUMBER is the partition number used by Linux.  On MS-DOS disk labels, the primary partitions number from 1 to 4, logical partitions from 5 onwards.\n        FLAG is one of: boot, root, swap, hidden, raid, lvm, lba, hp-service, palo, prep, msftres, bios_grub, atvrecv, diag, legacy_boot\n        STATE is one of: on, off\n```\n\n#### 2.3.16 GPT分区方案下的NAME标签\n\nGPT分区的print\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start  End  Size  File system  Name  Flags\n```\n\nMBR分区的print\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mklabel msdos\nWarning: The existing disk label on /dev/sdb will be destroyed and all data on this disk will be lost. Do you want to continue?\nYes/No? Yes\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End  Size  Type  File system  Flags\n```\n\n> **<font color='red'>可见GPT标志中多了一个Name标签</font>**\n\n使用的时候GPT分区方式可以指定分区名，不用指定主分区、扩展分区这些类型\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mkpart BOOT 0GB 1GB\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start   End     Size   File system  Name  Flags\n 1      1049kB  1000MB  999MB  xfs          BOOT\n```\n\n但是MBR就不能\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mkpart BOOT 0GB 1GB\nparted: invalid token: BOOT\nPartition type?  primary/extended?\n[root@lb01 ~]# parted /dev/sdb mkpart primary BOOT 0GB 1GB\nparted: invalid token: BOOT\nFile system type?  [ext2]?\n```\n\n## 三、磁盘挂载\n\n```shell\n1、开机自动挂载\n\t开机自动执行：/etc/rc.local\n\t\n\tchmod +x /etc/ec.local\n\t\n\techo \"mount /dev/sdc1 /root/test\" >> /etc/rc.local\n\n2、修改配置文件 /etc/fstab\n/dev/sdc100     /opt    xfs         defaults   0      0\n设备\t\t\t\t挂载点  文件系统类型   挂载类型  是否备份  是否检测\nUUID=1327e665-44b3-4223-a93b-69c36ec602f9   /root/oldboy  xfs   defaults 0 0\n\n /dev/sdc100  等价于  UUID\n\n3、查询设备UUID\n\t[root@localhost ~]# blkid \n/dev/sdc1: UUID=\"b5797ad6-9b98-452c-8962-fa12f6590fa6\" TYPE=\"xfs\" PARTLABEL=\"Linux filesystem\"\n```\n\n## 四、创建SWAP分区\n\n```she\n1、创建一个硬盘分区\n\n2、制作swap分区\nmkswap /dev/sdb3\n\n3、激活swap\nswapon /dev/sdb3\n\n4、关闭swap\nswapoff \n\n5、自动挂载\n\t5.1、\n        echo \"mkswap /dev/sdb3\" >> /etc/rc.local\n        echo \"swapon /dev/sdb3\" >> /etc/rc.local\n\t5.2、\n\t\techo \"/dev/sdb3  swap  swap  defaults 0  0\" >> /etc/fstab\n```\n\n","source":"_posts/01_运维/01-基础命令/day19-磁盘分区/01_磁盘分区笔记.md","raw":"---\ntitle: 运维之基础命令--磁盘分区\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n## 一、磁盘分区方案\n\n### 1.1 MBR与GPT介绍\n\nLinux中磁盘分区有两种方案\n\n- **MBR**（主引导记录）\n- **GPT**（GUID分区表）\n\n**<font color='blue'>MBR分区方案</font>**的特点（支持的磁盘容量<=2T）：\n\n1. 最多支持四个主分区 \n2. 在Linux上使用扩展分区和逻辑分区最多可以创建15个分区， \n3. 由于分区中的数据以32位存储，使用MBR分区是最大支持2T空间。 \n4. 用fdisk管理工具来创建MBR分区\n\n**<font color='red'>GPT分区方案</font>**的特点（支持的磁盘容量>2T）：\n\n1. 是UEFI标准的一部分，主板必须要支持UEFI标准 \n2. GPT分区列表支持最大128PB(1PB=1024TB) \n3. 可以定义128个分区 \n4. 没有主分区，扩展分区和逻辑分区的概念，所有分区都能格式化 \n5. gdisk和parted管理工具可以创建GPT分区\n\n### 1.2 MBR与GTP的区别\n\n| 对比项             | MBR                                      | GPT                                    |\n| ------------------ | ---------------------------------------- | -------------------------------------- |\n| 新旧度             | 旧                                       | 新                                     |\n| 支持的硬盘容量大小 | 最大2TB                                  | 支持2T以上                             |\n| 分区计数           | 最多支持4个主分区或3个主分区一个扩展分区 | 最多支持128个分区,部分主分区、扩展分区 |\n| 安全功能           | 不提供任何安全功能                       | 支持CRC32校验和机制                    |\n\n## 二、分区工具使用\n\n### 2.1 MBR分区工具fdisk\n\n### 2.2 GPT分区工具gdisk\n\n### 2.3 GPT分区工具parted\n\n​\tparted用于对磁盘（或RAID磁盘）进行分区及管理，与fdisk分区工具相比，支持2TB以上的磁盘分区，并且允许调整分区的大小，<font color='red'>支持命令行方式或交互式方式</font>，常用命令如下：\n\n| parted交互命令                          | 说 明                                    |\n| --------------------------------------- | ---------------------------------------- |\n| check NUMBER                            | 做一次简单的文件系统检测                 |\n| cp [FROM-DEVICE] FROM-NUMBER TO-NUMBER  | 复制文件系统到另一个分区                 |\n| help [COMMAND]                          | 显示所有的命令帮助                       |\n| mklabel,mktable LABEL-TYPE              | 创建新的磁盘卷标（分区表）               |\n| mkfs NUMBER FS-TYPE                     | 在分区上建立文件系统                     |\n| mkpart PART-TYPE [FS-TYPE] START END    | 创建一个分区                             |\n| mkpartfs PART-TYPE FS-TYPE START END    | 创建分区，并建立文件系统                 |\n| move NUMBER START END                   | 移动分区                                 |\n| name NUMBER NAME                        | 给分区命名                               |\n| print [devices\\|free\\|list,all\\|NUMBER] | 显示分区表、活动设备、空闲空间、所有分区 |\n| quit                                    | 退出                                     |\n| rescue START END                        | 修复丢失的分区                           |\n| resize NUMBER START END                 | 修改分区大小                             |\n| rm NUMBER                               | 删除分区                                 |\n| select DEVICE                           | 选择需要编辑的设备                       |\n| set NUMBER FLAG STATE                   | 改变分区标记                             |\n| toggle [NUMBER [FLAG]]                  | 切换分区表的状态                         |\n| unit UNIT                               | 设置默认的单位                           |\n| Version                                 | 显示版本                                 |\n\n>关于mkpart与PART-TYPE（FS-TYPE）的解释：\n>\n>Make a part-type partition for filesystem fs-type (if specified), beginning at start and ending at end (by default in megabytes).  fs-type can  be  one  of  \"btrfs\",  \"ext2\", \"ext3\", \"ext4\", \"fat16\", \"fat32\", \"hfs\", \"hfs+\", \"linux-swap\", \"ntfs\", \"reiserfs\", or \"xfs\".  part-type should be one of \"primary\", \"logical\", or \"extended\".\n\n#### 2.3.1 使用parted\n\n#### 2.3.1.1 列出所有块设备分区情况\n\n```shell\n# 查看当前有哪些块设备\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\nsr0     11:0    1  792M  0 rom\n\n# 查看分区情况\n[root@lb01 ~]# parted -l\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sda: 53.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system     Flags\n 1      1049kB  1075MB  1074MB  primary  xfs             boot\n 2      1075MB  3223MB  2149MB  primary  linux-swap(v1)\n 3      3223MB  53.7GB  50.5GB  primary  xfs\n\n\nError: /dev/sdb: unrecognised disk label\t# sdb还没有分区\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: unknown\nDisk Flags:\n\nWarning: Unable to open /dev/sr0 read-write (Read-only file system).  /dev/sr0\nhas been opened read-only.\nModel: NECVMWar VMware IDE CDR10 (scsi)\nDisk /dev/sr0: 830MB\nSector size (logical/physical): 2048B/2048B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End     Size    Type     File system  Flags\n 2      885kB  37.7MB  36.8MB  primary\n```\n\n#### 2.3.1.2 创建分区\n\n> 案例：在/dev/sdb中创建一个1GB的分区\n\na、命令行方式，创建一个主分区\n\n```shell\n# 转换为MBR分区方案msdos, GPT方案为gpt\n[root@lb01 ~]# parted /dev/sdb mklabel msdos\nInformation: You may need to update /etc/fstab.\n\n# 创建主分区\n[root@lb01 ~]# parted /dev/sdb mkpart primary ext4 0GB 1GB  # 把1GB换成100%就是分完剩余空间\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# lsblk\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      8:0    0   50G  0 disk\n├─sda1   8:1    0    1G  0 part /boot\n├─sda2   8:2    0    2G  0 part [SWAP]\n└─sda3   8:3    0   47G  0 part /\nsdb      8:16   0   10G  0 disk\n└─sdb1   8:17   0  953M  0 part\nsr0     11:0    1  792M  0 rom\n\n```\n\nb、再用交互方式，继续创建一个主分区\n\n```shell\n[root@lb01 ~]# parted\nGNU Parted 3.1\nUsing /dev/sda\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) select /dev/sdb # 选择块设备\nUsing /dev/sdb\n(parted) mkpart\t# 新建分区\nPartition type?  primary/extended? primary\nFile system type?  [ext2]? ext4\nStart? 1GB\nEnd? 2GB\n```\n\nc、扩展分区与逻辑分区的创建\n\n>扩展分区最多只有一个，再创建会提示选择primary/logical\n\n```shell\n(parted) select /dev/sdb\nUsing /dev/sdb\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n\n# 给扩展分区2创建一个逻辑分区（使用范围只能在扩展分区2的范围内）\n(parted) mkpart logical 1GB 2GB\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n 5      1001MB  2000MB  998MB   logical\n\n# 给扩展分区2再创建一个逻辑分区\n(parted) mkpart logical 2GB 3GB\n(parted) print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n 1      1049kB  1000MB  999MB   primary   ext4\n 2      1000MB  4000MB  3000MB  extended               lba\n 5      1001MB  2000MB  998MB   logical\n 6      2001MB  3000MB  999MB   logical\n```\n\n#### 2.3.1.3 查看分区\n\n```shell\n(parted) print # 打印分区\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n 2      1000MB  2000MB  999MB  primary\n \n (parted) print free # 查看剩余空间\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n        32.3kB  1049kB  1016kB           Free Space\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  2000MB  999MB   primary\n        2000MB  10.7GB  8738MB           Free Space\n\n```\n\n#### 2.3.1.4 调整分区大小\n\n>将分区2从1GB扩展到2GB\n>\n>PS：v2.4之后的版本，resize命令已经移除，更新到3.1-32版本有resizepart\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n 2      1000MB  2000MB  999MB  primary\n\n# 调整分区2的大小为2GB\n[root@lb01 ~]# parted /dev/sdb resizepart 2 3GB\t(3GB是指END位置，即使用1GB-3GB的空间，共2GB)\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  3000MB  2000MB  primary\n \n # 如果已经格式化并挂载使用，需要重新调整文件系统大小\n [root@lb01 ~]# resize2fs /dev/sdb2\n```\n\n>缩小分区大小会怎样？将提示有数据丢失的风险\n\n```shell\n[root@lb01 ~]# parted /dev/sdb resizepart 2 2GB\nWarning: Shrinking a partition can cause data loss, are you sure you want to continue?\nYes/No?\n```\n\n#### 2.3.1.5 删除分区\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n 1      1049kB  1000MB  999MB   primary\n 2      1000MB  4000MB  3000MB  primary  ext4\n\n[root@lb01 ~]# parted /dev/sdb rm 2   // 删除2号分区，因为已挂载，会提示要先卸载\nError: Partition /dev/sdb2 is being used. You must unmount it before you modify it with Parted.\n[root@lb01 ~]# umount /dev/sdb2\n[root@lb01 ~]# parted /dev/sdb rm 2 // 删除成功\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# print\n-bash: print: command not found\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary\n```\n\n#### 2.3.1.6 设置/更改分区标志\n\n```shell\n[root@lb01 ~]# parted /dev/sdb set 1 lvm on\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n 1      1049kB  1000MB  999MB  primary               lvm\n```\n\n查看有哪些标志可以设置\n\n```shell\n[root@lb01 ~]# parted\nGNU Parted 3.1\nUsing /dev/sda\nWelcome to GNU Parted! Type 'help' to view a list of commands.\n(parted) help set\n  set NUMBER FLAG STATE                    change the FLAG on partition NUMBER\n\n        NUMBER is the partition number used by Linux.  On MS-DOS disk labels, the primary partitions number from 1 to 4, logical partitions from 5 onwards.\n        FLAG is one of: boot, root, swap, hidden, raid, lvm, lba, hp-service, palo, prep, msftres, bios_grub, atvrecv, diag, legacy_boot\n        STATE is one of: on, off\n```\n\n#### 2.3.16 GPT分区方案下的NAME标签\n\nGPT分区的print\n\n```shell\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start  End  Size  File system  Name  Flags\n```\n\nMBR分区的print\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mklabel msdos\nWarning: The existing disk label on /dev/sdb will be destroyed and all data on this disk will be lost. Do you want to continue?\nYes/No? Yes\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End  Size  Type  File system  Flags\n```\n\n> **<font color='red'>可见GPT标志中多了一个Name标签</font>**\n\n使用的时候GPT分区方式可以指定分区名，不用指定主分区、扩展分区这些类型\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mkpart BOOT 0GB 1GB\nInformation: You may need to update /etc/fstab.\n\n[root@lb01 ~]# parted /dev/sdb print\nModel: VMware, VMware Virtual S (scsi)\nDisk /dev/sdb: 10.7GB\nSector size (logical/physical): 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start   End     Size   File system  Name  Flags\n 1      1049kB  1000MB  999MB  xfs          BOOT\n```\n\n但是MBR就不能\n\n```shell\n[root@lb01 ~]# parted /dev/sdb mkpart BOOT 0GB 1GB\nparted: invalid token: BOOT\nPartition type?  primary/extended?\n[root@lb01 ~]# parted /dev/sdb mkpart primary BOOT 0GB 1GB\nparted: invalid token: BOOT\nFile system type?  [ext2]?\n```\n\n## 三、磁盘挂载\n\n```shell\n1、开机自动挂载\n\t开机自动执行：/etc/rc.local\n\t\n\tchmod +x /etc/ec.local\n\t\n\techo \"mount /dev/sdc1 /root/test\" >> /etc/rc.local\n\n2、修改配置文件 /etc/fstab\n/dev/sdc100     /opt    xfs         defaults   0      0\n设备\t\t\t\t挂载点  文件系统类型   挂载类型  是否备份  是否检测\nUUID=1327e665-44b3-4223-a93b-69c36ec602f9   /root/oldboy  xfs   defaults 0 0\n\n /dev/sdc100  等价于  UUID\n\n3、查询设备UUID\n\t[root@localhost ~]# blkid \n/dev/sdc1: UUID=\"b5797ad6-9b98-452c-8962-fa12f6590fa6\" TYPE=\"xfs\" PARTLABEL=\"Linux filesystem\"\n```\n\n## 四、创建SWAP分区\n\n```she\n1、创建一个硬盘分区\n\n2、制作swap分区\nmkswap /dev/sdb3\n\n3、激活swap\nswapon /dev/sdb3\n\n4、关闭swap\nswapoff \n\n5、自动挂载\n\t5.1、\n        echo \"mkswap /dev/sdb3\" >> /etc/rc.local\n        echo \"swapon /dev/sdb3\" >> /etc/rc.local\n\t5.2、\n\t\techo \"/dev/sdb3  swap  swap  defaults 0  0\" >> /etc/fstab\n```\n\n","slug":"01_运维/01-基础命令/day19-磁盘分区/01_磁盘分区笔记","published":1,"updated":"2022-07-06T07:14:36.999Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k26006ea8v7atn2ep75","content":"<h2 id=\"一、磁盘分区方案\"><a href=\"#一、磁盘分区方案\" class=\"headerlink\" title=\"一、磁盘分区方案\"></a>一、磁盘分区方案</h2><h3 id=\"1-1-MBR与GPT介绍\"><a href=\"#1-1-MBR与GPT介绍\" class=\"headerlink\" title=\"1.1 MBR与GPT介绍\"></a>1.1 MBR与GPT介绍</h3><p>Linux中磁盘分区有两种方案</p>\n<ul>\n<li><strong>MBR</strong>（主引导记录）</li>\n<li><strong>GPT</strong>（GUID分区表）</li>\n</ul>\n<p>**<font color='blue'>MBR分区方案</font>**的特点（支持的磁盘容量&lt;&#x3D;2T）：</p>\n<ol>\n<li>最多支持四个主分区 </li>\n<li>在Linux上使用扩展分区和逻辑分区最多可以创建15个分区， </li>\n<li>由于分区中的数据以32位存储，使用MBR分区是最大支持2T空间。 </li>\n<li>用fdisk管理工具来创建MBR分区</li>\n</ol>\n<p>**<font color='red'>GPT分区方案</font>**的特点（支持的磁盘容量&gt;2T）：</p>\n<ol>\n<li>是UEFI标准的一部分，主板必须要支持UEFI标准 </li>\n<li>GPT分区列表支持最大128PB(1PB&#x3D;1024TB) </li>\n<li>可以定义128个分区 </li>\n<li>没有主分区，扩展分区和逻辑分区的概念，所有分区都能格式化 </li>\n<li>gdisk和parted管理工具可以创建GPT分区</li>\n</ol>\n<h3 id=\"1-2-MBR与GTP的区别\"><a href=\"#1-2-MBR与GTP的区别\" class=\"headerlink\" title=\"1.2 MBR与GTP的区别\"></a>1.2 MBR与GTP的区别</h3><table>\n<thead>\n<tr>\n<th>对比项</th>\n<th>MBR</th>\n<th>GPT</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>新旧度</td>\n<td>旧</td>\n<td>新</td>\n</tr>\n<tr>\n<td>支持的硬盘容量大小</td>\n<td>最大2TB</td>\n<td>支持2T以上</td>\n</tr>\n<tr>\n<td>分区计数</td>\n<td>最多支持4个主分区或3个主分区一个扩展分区</td>\n<td>最多支持128个分区,部分主分区、扩展分区</td>\n</tr>\n<tr>\n<td>安全功能</td>\n<td>不提供任何安全功能</td>\n<td>支持CRC32校验和机制</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、分区工具使用\"><a href=\"#二、分区工具使用\" class=\"headerlink\" title=\"二、分区工具使用\"></a>二、分区工具使用</h2><h3 id=\"2-1-MBR分区工具fdisk\"><a href=\"#2-1-MBR分区工具fdisk\" class=\"headerlink\" title=\"2.1 MBR分区工具fdisk\"></a>2.1 MBR分区工具fdisk</h3><h3 id=\"2-2-GPT分区工具gdisk\"><a href=\"#2-2-GPT分区工具gdisk\" class=\"headerlink\" title=\"2.2 GPT分区工具gdisk\"></a>2.2 GPT分区工具gdisk</h3><h3 id=\"2-3-GPT分区工具parted\"><a href=\"#2-3-GPT分区工具parted\" class=\"headerlink\" title=\"2.3 GPT分区工具parted\"></a>2.3 GPT分区工具parted</h3><p>​\tparted用于对磁盘（或RAID磁盘）进行分区及管理，与fdisk分区工具相比，支持2TB以上的磁盘分区，并且允许调整分区的大小，<font color='red'>支持命令行方式或交互式方式</font>，常用命令如下：</p>\n<table>\n<thead>\n<tr>\n<th>parted交互命令</th>\n<th>说 明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>check NUMBER</td>\n<td>做一次简单的文件系统检测</td>\n</tr>\n<tr>\n<td>cp [FROM-DEVICE] FROM-NUMBER TO-NUMBER</td>\n<td>复制文件系统到另一个分区</td>\n</tr>\n<tr>\n<td>help [COMMAND]</td>\n<td>显示所有的命令帮助</td>\n</tr>\n<tr>\n<td>mklabel,mktable LABEL-TYPE</td>\n<td>创建新的磁盘卷标（分区表）</td>\n</tr>\n<tr>\n<td>mkfs NUMBER FS-TYPE</td>\n<td>在分区上建立文件系统</td>\n</tr>\n<tr>\n<td>mkpart PART-TYPE [FS-TYPE] START END</td>\n<td>创建一个分区</td>\n</tr>\n<tr>\n<td>mkpartfs PART-TYPE FS-TYPE START END</td>\n<td>创建分区，并建立文件系统</td>\n</tr>\n<tr>\n<td>move NUMBER START END</td>\n<td>移动分区</td>\n</tr>\n<tr>\n<td>name NUMBER NAME</td>\n<td>给分区命名</td>\n</tr>\n<tr>\n<td>print [devices|free|list,all|NUMBER]</td>\n<td>显示分区表、活动设备、空闲空间、所有分区</td>\n</tr>\n<tr>\n<td>quit</td>\n<td>退出</td>\n</tr>\n<tr>\n<td>rescue START END</td>\n<td>修复丢失的分区</td>\n</tr>\n<tr>\n<td>resize NUMBER START END</td>\n<td>修改分区大小</td>\n</tr>\n<tr>\n<td>rm NUMBER</td>\n<td>删除分区</td>\n</tr>\n<tr>\n<td>select DEVICE</td>\n<td>选择需要编辑的设备</td>\n</tr>\n<tr>\n<td>set NUMBER FLAG STATE</td>\n<td>改变分区标记</td>\n</tr>\n<tr>\n<td>toggle [NUMBER [FLAG]]</td>\n<td>切换分区表的状态</td>\n</tr>\n<tr>\n<td>unit UNIT</td>\n<td>设置默认的单位</td>\n</tr>\n<tr>\n<td>Version</td>\n<td>显示版本</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>关于mkpart与PART-TYPE（FS-TYPE）的解释：</p>\n<p>Make a part-type partition for filesystem fs-type (if specified), beginning at start and ending at end (by default in megabytes).  fs-type can  be  one  of  “btrfs”,  “ext2”, “ext3”, “ext4”, “fat16”, “fat32”, “hfs”, “hfs+”, “linux-swap”, “ntfs”, “reiserfs”, or “xfs”.  part-type should be one of “primary”, “logical”, or “extended”.</p>\n</blockquote>\n<h4 id=\"2-3-1-使用parted\"><a href=\"#2-3-1-使用parted\" class=\"headerlink\" title=\"2.3.1 使用parted\"></a>2.3.1 使用parted</h4><h4 id=\"2-3-1-1-列出所有块设备分区情况\"><a href=\"#2-3-1-1-列出所有块设备分区情况\" class=\"headerlink\" title=\"2.3.1.1 列出所有块设备分区情况\"></a>2.3.1.1 列出所有块设备分区情况</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看当前有哪些块设备</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom\n\n<span class=\"token comment\"># 查看分区情况</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted -l</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sda: <span class=\"token number\">53</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system     Flags\n <span class=\"token number\">1</span>      1049kB  1075MB  1074MB  primary  xfs             boot\n <span class=\"token number\">2</span>      1075MB  3223MB  2149MB  primary  linux-swap<span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">)</span>\n <span class=\"token number\">3</span>      3223MB  <span class=\"token number\">53</span>.7GB  <span class=\"token number\">50</span>.5GB  primary  xfs\n\n\nError: /dev/sdb: unrecognised disk label\t<span class=\"token comment\"># sdb还没有分区</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: unknown\nDisk Flags:\n\nWarning: Unable to <span class=\"token function\">open</span> /dev/sr0 read-write <span class=\"token punctuation\">(</span>Read-only <span class=\"token function\">file</span> system<span class=\"token punctuation\">)</span>.  /dev/sr0\nhas been opened read-only.\nModel: NECVMWar VMware IDE CDR10 <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sr0: 830MB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 2048B/2048B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End     Size    Type     File system  Flags\n <span class=\"token number\">2</span>      885kB  <span class=\"token number\">37</span>.7MB  <span class=\"token number\">36</span>.8MB  primary<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-2-创建分区\"><a href=\"#2-3-1-2-创建分区\" class=\"headerlink\" title=\"2.3.1.2 创建分区\"></a>2.3.1.2 创建分区</h4><blockquote>\n<p>案例：在&#x2F;dev&#x2F;sdb中创建一个1GB的分区</p>\n</blockquote>\n<p>a、命令行方式，创建一个主分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 转换为MBR分区方案msdos, GPT方案为gpt</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mklabel msdos</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token comment\"># 创建主分区</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart primary ext4 0GB 1GB  # 把1GB换成100%就是分完剩余空间</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\n└─sdb1   <span class=\"token number\">8</span>:17   <span class=\"token number\">0</span>  953M  <span class=\"token number\">0</span> part\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b、再用交互方式，继续创建一个主分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted</span>\nGNU Parted <span class=\"token number\">3.1</span>\nUsing /dev/sda\nWelcome to GNU Parted<span class=\"token operator\">!</span> Type <span class=\"token string\">'help'</span> to view a list of commands.\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">select</span> /dev/sdb <span class=\"token comment\"># 选择块设备</span>\nUsing /dev/sdb\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart\t<span class=\"token comment\"># 新建分区</span>\nPartition type?  primary/extended? primary\nFile system type?  <span class=\"token punctuation\">[</span>ext2<span class=\"token punctuation\">]</span>? ext4\nStart? 1GB\nEnd? 2GB<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>c、扩展分区与逻辑分区的创建</p>\n<blockquote>\n<p>扩展分区最多只有一个，再创建会提示选择primary&#x2F;logical</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">select</span> /dev/sdb\nUsing /dev/sdb\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n\n<span class=\"token comment\"># 给扩展分区2创建一个逻辑分区（使用范围只能在扩展分区2的范围内）</span>\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart logical 1GB 2GB\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n <span class=\"token number\">5</span>      1001MB  2000MB  998MB   logical\n\n<span class=\"token comment\"># 给扩展分区2再创建一个逻辑分区</span>\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart logical 2GB 3GB\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n <span class=\"token number\">5</span>      1001MB  2000MB  998MB   logical\n <span class=\"token number\">6</span>      2001MB  3000MB  999MB   logical<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-3-查看分区\"><a href=\"#2-3-1-3-查看分区\" class=\"headerlink\" title=\"2.3.1.3 查看分区\"></a>2.3.1.3 查看分区</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token comment\"># 打印分区</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB  primary\n \n <span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token function\">free</span> <span class=\"token comment\"># 查看剩余空间</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n        <span class=\"token number\">32</span>.3kB  1049kB  1016kB           Free Space\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB   primary\n        2000MB  <span class=\"token number\">10</span>.7GB  8738MB           Free Space\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-4-调整分区大小\"><a href=\"#2-3-1-4-调整分区大小\" class=\"headerlink\" title=\"2.3.1.4 调整分区大小\"></a>2.3.1.4 调整分区大小</h4><blockquote>\n<p>将分区2从1GB扩展到2GB</p>\n<p>PS：v2.4之后的版本，resize命令已经移除，更新到3.1-32版本有resizepart</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB  primary\n\n<span class=\"token comment\"># 调整分区2的大小为2GB</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb resizepart 2 3GB\t(3GB是指END位置，即使用1GB-3GB的空间，共2GB)</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  3000MB  2000MB  primary\n \n <span class=\"token comment\"># 如果已经格式化并挂载使用，需要重新调整文件系统大小</span>\n <span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/sdb2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>缩小分区大小会怎样？将提示有数据丢失的风险</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb resizepart 2 2GB</span>\nWarning: Shrinking a partition can cause data loss, are you sure you want to continue?\nYes/No?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-5-删除分区\"><a href=\"#2-3-1-5-删除分区\" class=\"headerlink\" title=\"2.3.1.5 删除分区\"></a>2.3.1.5 删除分区</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  primary  ext4\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb rm 2   // 删除2号分区，因为已挂载，会提示要先卸载</span>\nError: Partition /dev/sdb2 is being used. You must unmount it before you modify it with Parted.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/sdb2</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb rm 2 // 删除成功</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># print</span>\n-bash: print: <span class=\"token builtin class-name\">command</span> not found\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-6-设置-x2F-更改分区标志\"><a href=\"#2-3-1-6-设置-x2F-更改分区标志\" class=\"headerlink\" title=\"2.3.1.6 设置&#x2F;更改分区标志\"></a>2.3.1.6 设置&#x2F;更改分区标志</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb set 1 lvm on</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary               lvm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看有哪些标志可以设置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted</span>\nGNU Parted <span class=\"token number\">3.1</span>\nUsing /dev/sda\nWelcome to GNU Parted<span class=\"token operator\">!</span> Type <span class=\"token string\">'help'</span> to view a list of commands.\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">help</span> <span class=\"token builtin class-name\">set</span>\n  <span class=\"token builtin class-name\">set</span> NUMBER FLAG STATE                    change the FLAG on partition NUMBER\n\n        NUMBER is the partition number used by Linux.  On MS-DOS disk labels, the primary partitions number from <span class=\"token number\">1</span> to <span class=\"token number\">4</span>, logical partitions from <span class=\"token number\">5</span> onwards.\n        FLAG is one of: boot, root, swap, hidden, raid, lvm, lba, hp-service, palo, prep, msftres, bios_grub, atvrecv, diag, legacy_boot\n        STATE is one of: on, off<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-16-GPT分区方案下的NAME标签\"><a href=\"#2-3-16-GPT分区方案下的NAME标签\" class=\"headerlink\" title=\"2.3.16 GPT分区方案下的NAME标签\"></a>2.3.16 GPT分区方案下的NAME标签</h4><p>GPT分区的print</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start  End  Size  File system  Name  Flags<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>MBR分区的print</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mklabel msdos</span>\nWarning: The existing disk label on /dev/sdb will be destroyed and all data on this disk will be lost. Do you want to continue?\nYes/No? Yes\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End  Size  Type  File system  Flags<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p><strong><font color='red'>可见GPT标志中多了一个Name标签</font></strong></p>\n</blockquote>\n<p>使用的时候GPT分区方式可以指定分区名，不用指定主分区、扩展分区这些类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart BOOT 0GB 1GB</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start   End     Size   File system  Name  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  xfs          BOOT<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但是MBR就不能</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart BOOT 0GB 1GB</span>\nparted: invalid token: BOOT\nPartition type?  primary/extended?\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart primary BOOT 0GB 1GB</span>\nparted: invalid token: BOOT\nFile system type?  <span class=\"token punctuation\">[</span>ext2<span class=\"token punctuation\">]</span>?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、磁盘挂载\"><a href=\"#三、磁盘挂载\" class=\"headerlink\" title=\"三、磁盘挂载\"></a>三、磁盘挂载</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token number\">1</span>、开机自动挂载\n\t开机自动执行：/etc/rc.local\n\t\n\t<span class=\"token function\">chmod</span> +x /etc/ec.local\n\t\n\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"mount /dev/sdc1 /root/test\"</span> <span class=\"token operator\">>></span> /etc/rc.local\n\n<span class=\"token number\">2</span>、修改配置文件 /etc/fstab\n/dev/sdc100     /opt    xfs         defaults   <span class=\"token number\">0</span>      <span class=\"token number\">0</span>\n设备\t\t\t\t挂载点  文件系统类型   挂载类型  是否备份  是否检测\n<span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span>1327e665-44b3-4223-a93b-69c36ec602f9   /root/oldboy  xfs   defaults <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n\n /dev/sdc100  等价于  UUID\n\n<span class=\"token number\">3</span>、查询设备UUID\n\t<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># blkid </span>\n/dev/sdc1: <span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"b5797ad6-9b98-452c-8962-fa12f6590fa6\"</span> <span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"xfs\"</span> <span class=\"token assign-left variable\">PARTLABEL</span><span class=\"token operator\">=</span><span class=\"token string\">\"Linux filesystem\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、创建SWAP分区\"><a href=\"#四、创建SWAP分区\" class=\"headerlink\" title=\"四、创建SWAP分区\"></a>四、创建SWAP分区</h2><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">1、创建一个硬盘分区\n\n2、制作swap分区\nmkswap &#x2F;dev&#x2F;sdb3\n\n3、激活swap\nswapon &#x2F;dev&#x2F;sdb3\n\n4、关闭swap\nswapoff \n\n5、自动挂载\n\t5.1、\n        echo &quot;mkswap &#x2F;dev&#x2F;sdb3&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local\n        echo &quot;swapon &#x2F;dev&#x2F;sdb3&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local\n\t5.2、\n\t\techo &quot;&#x2F;dev&#x2F;sdb3  swap  swap  defaults 0  0&quot; &gt;&gt; &#x2F;etc&#x2F;fstab<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"一、磁盘分区方案\"><a href=\"#一、磁盘分区方案\" class=\"headerlink\" title=\"一、磁盘分区方案\"></a>一、磁盘分区方案</h2><h3 id=\"1-1-MBR与GPT介绍\"><a href=\"#1-1-MBR与GPT介绍\" class=\"headerlink\" title=\"1.1 MBR与GPT介绍\"></a>1.1 MBR与GPT介绍</h3><p>Linux中磁盘分区有两种方案</p>\n<ul>\n<li><strong>MBR</strong>（主引导记录）</li>\n<li><strong>GPT</strong>（GUID分区表）</li>\n</ul>\n<p>**<font color='blue'>MBR分区方案</font>**的特点（支持的磁盘容量&lt;&#x3D;2T）：</p>\n<ol>\n<li>最多支持四个主分区 </li>\n<li>在Linux上使用扩展分区和逻辑分区最多可以创建15个分区， </li>\n<li>由于分区中的数据以32位存储，使用MBR分区是最大支持2T空间。 </li>\n<li>用fdisk管理工具来创建MBR分区</li>\n</ol>\n<p>**<font color='red'>GPT分区方案</font>**的特点（支持的磁盘容量&gt;2T）：</p>\n<ol>\n<li>是UEFI标准的一部分，主板必须要支持UEFI标准 </li>\n<li>GPT分区列表支持最大128PB(1PB&#x3D;1024TB) </li>\n<li>可以定义128个分区 </li>\n<li>没有主分区，扩展分区和逻辑分区的概念，所有分区都能格式化 </li>\n<li>gdisk和parted管理工具可以创建GPT分区</li>\n</ol>\n<h3 id=\"1-2-MBR与GTP的区别\"><a href=\"#1-2-MBR与GTP的区别\" class=\"headerlink\" title=\"1.2 MBR与GTP的区别\"></a>1.2 MBR与GTP的区别</h3><table>\n<thead>\n<tr>\n<th>对比项</th>\n<th>MBR</th>\n<th>GPT</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>新旧度</td>\n<td>旧</td>\n<td>新</td>\n</tr>\n<tr>\n<td>支持的硬盘容量大小</td>\n<td>最大2TB</td>\n<td>支持2T以上</td>\n</tr>\n<tr>\n<td>分区计数</td>\n<td>最多支持4个主分区或3个主分区一个扩展分区</td>\n<td>最多支持128个分区,部分主分区、扩展分区</td>\n</tr>\n<tr>\n<td>安全功能</td>\n<td>不提供任何安全功能</td>\n<td>支持CRC32校验和机制</td>\n</tr>\n</tbody></table>\n<h2 id=\"二、分区工具使用\"><a href=\"#二、分区工具使用\" class=\"headerlink\" title=\"二、分区工具使用\"></a>二、分区工具使用</h2><h3 id=\"2-1-MBR分区工具fdisk\"><a href=\"#2-1-MBR分区工具fdisk\" class=\"headerlink\" title=\"2.1 MBR分区工具fdisk\"></a>2.1 MBR分区工具fdisk</h3><h3 id=\"2-2-GPT分区工具gdisk\"><a href=\"#2-2-GPT分区工具gdisk\" class=\"headerlink\" title=\"2.2 GPT分区工具gdisk\"></a>2.2 GPT分区工具gdisk</h3><h3 id=\"2-3-GPT分区工具parted\"><a href=\"#2-3-GPT分区工具parted\" class=\"headerlink\" title=\"2.3 GPT分区工具parted\"></a>2.3 GPT分区工具parted</h3><p>​\tparted用于对磁盘（或RAID磁盘）进行分区及管理，与fdisk分区工具相比，支持2TB以上的磁盘分区，并且允许调整分区的大小，<font color='red'>支持命令行方式或交互式方式</font>，常用命令如下：</p>\n<table>\n<thead>\n<tr>\n<th>parted交互命令</th>\n<th>说 明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>check NUMBER</td>\n<td>做一次简单的文件系统检测</td>\n</tr>\n<tr>\n<td>cp [FROM-DEVICE] FROM-NUMBER TO-NUMBER</td>\n<td>复制文件系统到另一个分区</td>\n</tr>\n<tr>\n<td>help [COMMAND]</td>\n<td>显示所有的命令帮助</td>\n</tr>\n<tr>\n<td>mklabel,mktable LABEL-TYPE</td>\n<td>创建新的磁盘卷标（分区表）</td>\n</tr>\n<tr>\n<td>mkfs NUMBER FS-TYPE</td>\n<td>在分区上建立文件系统</td>\n</tr>\n<tr>\n<td>mkpart PART-TYPE [FS-TYPE] START END</td>\n<td>创建一个分区</td>\n</tr>\n<tr>\n<td>mkpartfs PART-TYPE FS-TYPE START END</td>\n<td>创建分区，并建立文件系统</td>\n</tr>\n<tr>\n<td>move NUMBER START END</td>\n<td>移动分区</td>\n</tr>\n<tr>\n<td>name NUMBER NAME</td>\n<td>给分区命名</td>\n</tr>\n<tr>\n<td>print [devices|free|list,all|NUMBER]</td>\n<td>显示分区表、活动设备、空闲空间、所有分区</td>\n</tr>\n<tr>\n<td>quit</td>\n<td>退出</td>\n</tr>\n<tr>\n<td>rescue START END</td>\n<td>修复丢失的分区</td>\n</tr>\n<tr>\n<td>resize NUMBER START END</td>\n<td>修改分区大小</td>\n</tr>\n<tr>\n<td>rm NUMBER</td>\n<td>删除分区</td>\n</tr>\n<tr>\n<td>select DEVICE</td>\n<td>选择需要编辑的设备</td>\n</tr>\n<tr>\n<td>set NUMBER FLAG STATE</td>\n<td>改变分区标记</td>\n</tr>\n<tr>\n<td>toggle [NUMBER [FLAG]]</td>\n<td>切换分区表的状态</td>\n</tr>\n<tr>\n<td>unit UNIT</td>\n<td>设置默认的单位</td>\n</tr>\n<tr>\n<td>Version</td>\n<td>显示版本</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>关于mkpart与PART-TYPE（FS-TYPE）的解释：</p>\n<p>Make a part-type partition for filesystem fs-type (if specified), beginning at start and ending at end (by default in megabytes).  fs-type can  be  one  of  “btrfs”,  “ext2”, “ext3”, “ext4”, “fat16”, “fat32”, “hfs”, “hfs+”, “linux-swap”, “ntfs”, “reiserfs”, or “xfs”.  part-type should be one of “primary”, “logical”, or “extended”.</p>\n</blockquote>\n<h4 id=\"2-3-1-使用parted\"><a href=\"#2-3-1-使用parted\" class=\"headerlink\" title=\"2.3.1 使用parted\"></a>2.3.1 使用parted</h4><h4 id=\"2-3-1-1-列出所有块设备分区情况\"><a href=\"#2-3-1-1-列出所有块设备分区情况\" class=\"headerlink\" title=\"2.3.1.1 列出所有块设备分区情况\"></a>2.3.1.1 列出所有块设备分区情况</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看当前有哪些块设备</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom\n\n<span class=\"token comment\"># 查看分区情况</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted -l</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sda: <span class=\"token number\">53</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system     Flags\n <span class=\"token number\">1</span>      1049kB  1075MB  1074MB  primary  xfs             boot\n <span class=\"token number\">2</span>      1075MB  3223MB  2149MB  primary  linux-swap<span class=\"token punctuation\">(</span>v1<span class=\"token punctuation\">)</span>\n <span class=\"token number\">3</span>      3223MB  <span class=\"token number\">53</span>.7GB  <span class=\"token number\">50</span>.5GB  primary  xfs\n\n\nError: /dev/sdb: unrecognised disk label\t<span class=\"token comment\"># sdb还没有分区</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: unknown\nDisk Flags:\n\nWarning: Unable to <span class=\"token function\">open</span> /dev/sr0 read-write <span class=\"token punctuation\">(</span>Read-only <span class=\"token function\">file</span> system<span class=\"token punctuation\">)</span>.  /dev/sr0\nhas been opened read-only.\nModel: NECVMWar VMware IDE CDR10 <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sr0: 830MB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 2048B/2048B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End     Size    Type     File system  Flags\n <span class=\"token number\">2</span>      885kB  <span class=\"token number\">37</span>.7MB  <span class=\"token number\">36</span>.8MB  primary<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-2-创建分区\"><a href=\"#2-3-1-2-创建分区\" class=\"headerlink\" title=\"2.3.1.2 创建分区\"></a>2.3.1.2 创建分区</h4><blockquote>\n<p>案例：在&#x2F;dev&#x2F;sdb中创建一个1GB的分区</p>\n</blockquote>\n<p>a、命令行方式，创建一个主分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 转换为MBR分区方案msdos, GPT方案为gpt</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mklabel msdos</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token comment\"># 创建主分区</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart primary ext4 0GB 1GB  # 把1GB换成100%就是分完剩余空间</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># lsblk</span>\nNAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT\nsda      <span class=\"token number\">8</span>:0    <span class=\"token number\">0</span>   50G  <span class=\"token number\">0</span> disk\n├─sda1   <span class=\"token number\">8</span>:1    <span class=\"token number\">0</span>    1G  <span class=\"token number\">0</span> part /boot\n├─sda2   <span class=\"token number\">8</span>:2    <span class=\"token number\">0</span>    2G  <span class=\"token number\">0</span> part <span class=\"token punctuation\">[</span>SWAP<span class=\"token punctuation\">]</span>\n└─sda3   <span class=\"token number\">8</span>:3    <span class=\"token number\">0</span>   47G  <span class=\"token number\">0</span> part /\nsdb      <span class=\"token number\">8</span>:16   <span class=\"token number\">0</span>   10G  <span class=\"token number\">0</span> disk\n└─sdb1   <span class=\"token number\">8</span>:17   <span class=\"token number\">0</span>  953M  <span class=\"token number\">0</span> part\nsr0     <span class=\"token number\">11</span>:0    <span class=\"token number\">1</span>  792M  <span class=\"token number\">0</span> rom\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>b、再用交互方式，继续创建一个主分区</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted</span>\nGNU Parted <span class=\"token number\">3.1</span>\nUsing /dev/sda\nWelcome to GNU Parted<span class=\"token operator\">!</span> Type <span class=\"token string\">'help'</span> to view a list of commands.\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">select</span> /dev/sdb <span class=\"token comment\"># 选择块设备</span>\nUsing /dev/sdb\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart\t<span class=\"token comment\"># 新建分区</span>\nPartition type?  primary/extended? primary\nFile system type?  <span class=\"token punctuation\">[</span>ext2<span class=\"token punctuation\">]</span>? ext4\nStart? 1GB\nEnd? 2GB<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>c、扩展分区与逻辑分区的创建</p>\n<blockquote>\n<p>扩展分区最多只有一个，再创建会提示选择primary&#x2F;logical</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token keyword\">select</span> /dev/sdb\nUsing /dev/sdb\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n\n<span class=\"token comment\"># 给扩展分区2创建一个逻辑分区（使用范围只能在扩展分区2的范围内）</span>\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart logical 1GB 2GB\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n <span class=\"token number\">5</span>      1001MB  2000MB  998MB   logical\n\n<span class=\"token comment\"># 给扩展分区2再创建一个逻辑分区</span>\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> mkpart logical 2GB 3GB\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type      File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary   ext4\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  extended               lba\n <span class=\"token number\">5</span>      1001MB  2000MB  998MB   logical\n <span class=\"token number\">6</span>      2001MB  3000MB  999MB   logical<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-3-查看分区\"><a href=\"#2-3-1-3-查看分区\" class=\"headerlink\" title=\"2.3.1.3 查看分区\"></a>2.3.1.3 查看分区</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token comment\"># 打印分区</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB  primary\n \n <span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> print <span class=\"token function\">free</span> <span class=\"token comment\"># 查看剩余空间</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n        <span class=\"token number\">32</span>.3kB  1049kB  1016kB           Free Space\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB   primary\n        2000MB  <span class=\"token number\">10</span>.7GB  8738MB           Free Space\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-4-调整分区大小\"><a href=\"#2-3-1-4-调整分区大小\" class=\"headerlink\" title=\"2.3.1.4 调整分区大小\"></a>2.3.1.4 调整分区大小</h4><blockquote>\n<p>将分区2从1GB扩展到2GB</p>\n<p>PS：v2.4之后的版本，resize命令已经移除，更新到3.1-32版本有resizepart</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary\n <span class=\"token number\">2</span>      1000MB  2000MB  999MB  primary\n\n<span class=\"token comment\"># 调整分区2的大小为2GB</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb resizepart 2 3GB\t(3GB是指END位置，即使用1GB-3GB的空间，共2GB)</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  3000MB  2000MB  primary\n \n <span class=\"token comment\"># 如果已经格式化并挂载使用，需要重新调整文件系统大小</span>\n <span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># resize2fs /dev/sdb2</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>缩小分区大小会怎样？将提示有数据丢失的风险</p>\n</blockquote>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb resizepart 2 2GB</span>\nWarning: Shrinking a partition can cause data loss, are you sure you want to continue?\nYes/No?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-5-删除分区\"><a href=\"#2-3-1-5-删除分区\" class=\"headerlink\" title=\"2.3.1.5 删除分区\"></a>2.3.1.5 删除分区</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size    Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB   primary\n <span class=\"token number\">2</span>      1000MB  4000MB  3000MB  primary  ext4\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb rm 2   // 删除2号分区，因为已挂载，会提示要先卸载</span>\nError: Partition /dev/sdb2 is being used. You must unmount it before you modify it with Parted.\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># umount /dev/sdb2</span>\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb rm 2 // 删除成功</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># print</span>\n-bash: print: <span class=\"token builtin class-name\">command</span> not found\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-1-6-设置-x2F-更改分区标志\"><a href=\"#2-3-1-6-设置-x2F-更改分区标志\" class=\"headerlink\" title=\"2.3.1.6 设置&#x2F;更改分区标志\"></a>2.3.1.6 设置&#x2F;更改分区标志</h4><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb set 1 lvm on</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start   End     Size   Type     File system  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  primary               lvm<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看有哪些标志可以设置</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted</span>\nGNU Parted <span class=\"token number\">3.1</span>\nUsing /dev/sda\nWelcome to GNU Parted<span class=\"token operator\">!</span> Type <span class=\"token string\">'help'</span> to view a list of commands.\n<span class=\"token punctuation\">(</span>parted<span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">help</span> <span class=\"token builtin class-name\">set</span>\n  <span class=\"token builtin class-name\">set</span> NUMBER FLAG STATE                    change the FLAG on partition NUMBER\n\n        NUMBER is the partition number used by Linux.  On MS-DOS disk labels, the primary partitions number from <span class=\"token number\">1</span> to <span class=\"token number\">4</span>, logical partitions from <span class=\"token number\">5</span> onwards.\n        FLAG is one of: boot, root, swap, hidden, raid, lvm, lba, hp-service, palo, prep, msftres, bios_grub, atvrecv, diag, legacy_boot\n        STATE is one of: on, off<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"2-3-16-GPT分区方案下的NAME标签\"><a href=\"#2-3-16-GPT分区方案下的NAME标签\" class=\"headerlink\" title=\"2.3.16 GPT分区方案下的NAME标签\"></a>2.3.16 GPT分区方案下的NAME标签</h4><p>GPT分区的print</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start  End  Size  File system  Name  Flags<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>MBR分区的print</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mklabel msdos</span>\nWarning: The existing disk label on /dev/sdb will be destroyed and all data on this disk will be lost. Do you want to continue?\nYes/No? Yes\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: msdos\nDisk Flags:\n\nNumber  Start  End  Size  Type  File system  Flags<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p><strong><font color='red'>可见GPT标志中多了一个Name标签</font></strong></p>\n</blockquote>\n<p>使用的时候GPT分区方式可以指定分区名，不用指定主分区、扩展分区这些类型</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart BOOT 0GB 1GB</span>\nInformation: You may need to update /etc/fstab.\n\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb print</span>\nModel: VMware, VMware Virtual S <span class=\"token punctuation\">(</span>scsi<span class=\"token punctuation\">)</span>\nDisk /dev/sdb: <span class=\"token number\">10</span>.7GB\nSector size <span class=\"token punctuation\">(</span>logical/physical<span class=\"token punctuation\">)</span>: 512B/512B\nPartition Table: gpt\nDisk Flags:\n\nNumber  Start   End     Size   File system  Name  Flags\n <span class=\"token number\">1</span>      1049kB  1000MB  999MB  xfs          BOOT<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>但是MBR就不能</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart BOOT 0GB 1GB</span>\nparted: invalid token: BOOT\nPartition type?  primary/extended?\n<span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># parted /dev/sdb mkpart primary BOOT 0GB 1GB</span>\nparted: invalid token: BOOT\nFile system type?  <span class=\"token punctuation\">[</span>ext2<span class=\"token punctuation\">]</span>?<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"三、磁盘挂载\"><a href=\"#三、磁盘挂载\" class=\"headerlink\" title=\"三、磁盘挂载\"></a>三、磁盘挂载</h2><pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token number\">1</span>、开机自动挂载\n\t开机自动执行：/etc/rc.local\n\t\n\t<span class=\"token function\">chmod</span> +x /etc/ec.local\n\t\n\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"mount /dev/sdc1 /root/test\"</span> <span class=\"token operator\">>></span> /etc/rc.local\n\n<span class=\"token number\">2</span>、修改配置文件 /etc/fstab\n/dev/sdc100     /opt    xfs         defaults   <span class=\"token number\">0</span>      <span class=\"token number\">0</span>\n设备\t\t\t\t挂载点  文件系统类型   挂载类型  是否备份  是否检测\n<span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span>1327e665-44b3-4223-a93b-69c36ec602f9   /root/oldboy  xfs   defaults <span class=\"token number\">0</span> <span class=\"token number\">0</span>\n\n /dev/sdc100  等价于  UUID\n\n<span class=\"token number\">3</span>、查询设备UUID\n\t<span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># blkid </span>\n/dev/sdc1: <span class=\"token assign-left variable\">UUID</span><span class=\"token operator\">=</span><span class=\"token string\">\"b5797ad6-9b98-452c-8962-fa12f6590fa6\"</span> <span class=\"token assign-left variable\">TYPE</span><span class=\"token operator\">=</span><span class=\"token string\">\"xfs\"</span> <span class=\"token assign-left variable\">PARTLABEL</span><span class=\"token operator\">=</span><span class=\"token string\">\"Linux filesystem\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"四、创建SWAP分区\"><a href=\"#四、创建SWAP分区\" class=\"headerlink\" title=\"四、创建SWAP分区\"></a>四、创建SWAP分区</h2><pre class=\"line-numbers language-she\" data-language=\"she\"><code class=\"language-she\">1、创建一个硬盘分区\n\n2、制作swap分区\nmkswap &#x2F;dev&#x2F;sdb3\n\n3、激活swap\nswapon &#x2F;dev&#x2F;sdb3\n\n4、关闭swap\nswapoff \n\n5、自动挂载\n\t5.1、\n        echo &quot;mkswap &#x2F;dev&#x2F;sdb3&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local\n        echo &quot;swapon &#x2F;dev&#x2F;sdb3&quot; &gt;&gt; &#x2F;etc&#x2F;rc.local\n\t5.2、\n\t\techo &quot;&#x2F;dev&#x2F;sdb3  swap  swap  defaults 0  0&quot; &gt;&gt; &#x2F;etc&#x2F;fstab<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--防火墙与iptables","date":"2022-07-06T03:19:52.000Z","_content":"\n# iptables使用手册\n\n## 一、简单实践\n\n> 从信息查看、保存规则、清除规则、恢复规则、更改规则五个方面来学习。\n\n### 1.1 信息查看\n\n查看现有规则\n\n```shell\n[root@controller ~]# iptables -L\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-linuxbri-INPUT  all  --  anywhere             anywhere\nnova-api-INPUT  all  --  anywhere             anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-filter-top  all  --  anywhere             anywhere\nneutron-linuxbri-FORWARD  all  --  anywhere             anywhere\nnova-filter-top  all  --  anywhere             anywhere\nnova-api-FORWARD  all  --  anywhere             anywhere\n....\n```\n\n查看现有规则，显示主机ip和端口号，-n\n\n```shell\n[root@controller ~]# iptables -L -n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\nnova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\nneutron-linuxbri-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\nnova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\nnova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>结果显示：\n>\n>默认显示三条链的规则INPUT、FORWARD、OUTPUT，而且所有的规则都是默认接受的\n>\n>每条链下面显示的信息是：\n>\n>动作  协议 参数 源地址 目标地址\n\n显示详细信息，-v\n\n```shell\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 11839 packets, 2842K bytes)\n pkts bytes target     prot opt in     out     source               destination\n11839 2842K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n12985 3090K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>结果显示：\n>\n>-v显示的内容比-L -n 显示的内容多了四个字段\n>\n>pkts  规则匹配到的报文数量的多少\n>\n>bytes 规则匹配到的报文内容量的大小\n>\n>in   规则匹配到的流入的接口，*代表任意接口\n>\n>out   规则匹配到的流出的接口\n\n显示规则的标号 --line-numbers\n\n```shell\n[root@controller ~]# iptables -L -n -v --line-numbers\nChain INPUT (policy ACCEPT 13663 packets, 3221K bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1    13663 3221K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n2    14809 3469K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n2        0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n3        0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n4        0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n打印规则命令，将防火墙的编写命令给我们打印出来，可以通过这种方式来学习规则的编写。\n\n```shell\n[root@controller ~]# iptables -S\n-P INPUT ACCEPT\n-P FORWARD ACCEPT\n-P OUTPUT ACCEPT\n-N neutron-filter-top\n-N neutron-linuxbri-FORWARD\n-N neutron-linuxbri-INPUT\n-N neutron-linuxbri-OUTPUT\n-N neutron-linuxbri-local\n-N neutron-linuxbri-scope\n-N neutron-linuxbri-sg-chain\n-N neutron-linuxbri-sg-fallback\n-N nova-api-FORWARD\n-N nova-api-INPUT\n-N nova-api-OUTPUT\n-N nova-api-local\n-N nova-filter-top\n-A INPUT -j neutron-linuxbri-INPUT\n-A INPUT -j nova-api-INPUT\n-A FORWARD -j neutron-filter-top\n-A FORWARD -j neutron-linuxbri-FORWARD\n-A FORWARD -j nova-filter-top\n-A FORWARD -j nova-api-FORWARD\n....\n```\n\n### 1.2 保存规则\n\n> 使用 iptables-save命令可以保存规则\n\n将当前的规则保存到文件中\n\n```shell\n[root@controller ~]# iptables-save > iptables.rules\n[root@controller ~]# cat iptables.rules\n# Generated by iptables-save v1.4.21 on Wed Oct 20 09:22:53 2021\n*filter\n:INPUT ACCEPT [16785:3861723]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [16549:3883715]\n:neutron-filter-top - [0:0]\n:neutron-linuxbri-FORWARD - [0:0]\n:neutron-linuxbri-INPUT - [0:0]\n:neutron-linuxbri-OUTPUT - [0:0]\n:neutron-linuxbri-local - [0:0]\n:neutron-linuxbri-scope - [0:0]\n:neutron-linuxbri-sg-chain - [0:0]\n:neutron-linuxbri-sg-fallback - [0:0]\n:nova-api-FORWARD - [0:0]\n:nova-api-INPUT - [0:0]\n....\n```\n\n### 1.3 清除规则\n\n清除单个规则\n\n```shell\n# 先查看\n[root@controller ~]# iptables -L -n --line-numbers\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n2    neutron-linuxbri-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n3    nova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n4    nova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n\n# 删除FORWARD的第2条规则\n[root@controller ~]# iptables -D FORWARD 2\n\n# 再次查看，删除成功\n[root@controller ~]# iptables -L -n --line-numbers\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n3    nova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n\n# 如果不指定删除的序号，会报错\n[root@controller ~]# iptables -D FORWARD\niptables: Bad rule (does a matching rule exist in that chain?).\n```\n\n清除规则计数\n\n```shell\n# 查看原内容\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 3196 packets, 657K bytes)\n pkts bytes target     prot opt in     out     source               destination\n23118 5147K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n24264 5395K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n\n# 清除规则计数 -Z\n[root@controller ~]# iptables -Z\n\n# 查看效果，pkts与bytes减少，即规则匹配到的报文数量与报文内容大小均减少，清除成功\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 58 packets, 11344 bytes)\n pkts bytes target     prot opt in     out     source               destination\n   58 11344 neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n   58 11344 nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n清除所有规则\n\n```shell\n# 清除默认规则\n[root@controller ~]# iptables -F\n\n# 清除自定义规则\n[root@controller ~]# iptables -X\n\n# 查看效果\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 424 packets, 84770 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 398 packets, 83826 bytes)\n pkts bytes target     prot opt in     out     source               destination\n```\n\n### 1.4 恢复规则\n\n从备份文件恢复规则\n\n```shell\n# 从文件恢复\n[root@controller ~]# iptables-restore < iptables.rules\n\n# 查看确认已恢复\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 268 packets, 46570 bytes)\n pkts bytes target     prot opt in     out     source               destination\n  268 46570 neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n  268 46570 nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n### 1.5 更改规则\n\n可以从ACCEPT改为DROP\n\n```shell\n# 查看原规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 342 packets, 49890 bytes)\n pkts bytes target     prot opt in     out     source               destination\n 4455  836K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n 4455  836K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n\n# -P 修改\n[root@controller ~]# iptables -P FORWARD DROP\n\n# 再次查看，FORWARD链修改DROP成功\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 38 packets, 5017 bytes)\n pkts bytes target     prot opt in     out     source               destination\n 4849  905K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n 4849  905K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy DROP 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>-P 更改的规则，使用 -F 不能自动还原\n>\n>```shell\n>[root@controller ~]# iptables -F\n>[root@controller ~]# iptables -L -n -v\n>Chain INPUT (policy ACCEPT 36 packets, 6554 bytes)\n>pkts bytes target     prot opt in     out     source               destination\n>\n>Chain FORWARD (policy DROP 0 packets, 0 bytes)\n>pkts bytes target     prot opt in     out     source               destination\n>....\n>```\n\n重启iptables服务后，可以使用系统所有默认规则\n\n```shell\n# 清除所有默认规则\n[root@controller ~]# iptables -F\n\n# 查看，没有默认规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 8 packets, 520 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 4 packets, 448 bytes)\n pkts bytes target     prot opt in     out     source               destination\n \n# 重启iptables服务\n[root@controller ~]# systemctl restart iptables\n\n# 再次查看，新增了系统的默认规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    6   432 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED\n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0\n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22\n    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited\n\nChain OUTPUT (policy ACCEPT 4 packets, 544 bytes)\n pkts bytes target     prot opt in     out     source               destination\n```\n\n","source":"_posts/01_运维/01-基础命令/day22-防火墙与iptables/iptables使用.md","raw":"---\ntitle: 运维之基础命令--防火墙与iptables\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# iptables使用手册\n\n## 一、简单实践\n\n> 从信息查看、保存规则、清除规则、恢复规则、更改规则五个方面来学习。\n\n### 1.1 信息查看\n\n查看现有规则\n\n```shell\n[root@controller ~]# iptables -L\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-linuxbri-INPUT  all  --  anywhere             anywhere\nnova-api-INPUT  all  --  anywhere             anywhere\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-filter-top  all  --  anywhere             anywhere\nneutron-linuxbri-FORWARD  all  --  anywhere             anywhere\nnova-filter-top  all  --  anywhere             anywhere\nnova-api-FORWARD  all  --  anywhere             anywhere\n....\n```\n\n查看现有规则，显示主机ip和端口号，-n\n\n```shell\n[root@controller ~]# iptables -L -n\nChain INPUT (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\nnova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\ntarget     prot opt source               destination\nneutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\nneutron-linuxbri-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\nnova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\nnova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>结果显示：\n>\n>默认显示三条链的规则INPUT、FORWARD、OUTPUT，而且所有的规则都是默认接受的\n>\n>每条链下面显示的信息是：\n>\n>动作  协议 参数 源地址 目标地址\n\n显示详细信息，-v\n\n```shell\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 11839 packets, 2842K bytes)\n pkts bytes target     prot opt in     out     source               destination\n11839 2842K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n12985 3090K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>结果显示：\n>\n>-v显示的内容比-L -n 显示的内容多了四个字段\n>\n>pkts  规则匹配到的报文数量的多少\n>\n>bytes 规则匹配到的报文内容量的大小\n>\n>in   规则匹配到的流入的接口，*代表任意接口\n>\n>out   规则匹配到的流出的接口\n\n显示规则的标号 --line-numbers\n\n```shell\n[root@controller ~]# iptables -L -n -v --line-numbers\nChain INPUT (policy ACCEPT 13663 packets, 3221K bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1    13663 3221K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n2    14809 3469K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\nnum   pkts bytes target     prot opt in     out     source               destination\n1        0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n2        0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n3        0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n4        0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n打印规则命令，将防火墙的编写命令给我们打印出来，可以通过这种方式来学习规则的编写。\n\n```shell\n[root@controller ~]# iptables -S\n-P INPUT ACCEPT\n-P FORWARD ACCEPT\n-P OUTPUT ACCEPT\n-N neutron-filter-top\n-N neutron-linuxbri-FORWARD\n-N neutron-linuxbri-INPUT\n-N neutron-linuxbri-OUTPUT\n-N neutron-linuxbri-local\n-N neutron-linuxbri-scope\n-N neutron-linuxbri-sg-chain\n-N neutron-linuxbri-sg-fallback\n-N nova-api-FORWARD\n-N nova-api-INPUT\n-N nova-api-OUTPUT\n-N nova-api-local\n-N nova-filter-top\n-A INPUT -j neutron-linuxbri-INPUT\n-A INPUT -j nova-api-INPUT\n-A FORWARD -j neutron-filter-top\n-A FORWARD -j neutron-linuxbri-FORWARD\n-A FORWARD -j nova-filter-top\n-A FORWARD -j nova-api-FORWARD\n....\n```\n\n### 1.2 保存规则\n\n> 使用 iptables-save命令可以保存规则\n\n将当前的规则保存到文件中\n\n```shell\n[root@controller ~]# iptables-save > iptables.rules\n[root@controller ~]# cat iptables.rules\n# Generated by iptables-save v1.4.21 on Wed Oct 20 09:22:53 2021\n*filter\n:INPUT ACCEPT [16785:3861723]\n:FORWARD ACCEPT [0:0]\n:OUTPUT ACCEPT [16549:3883715]\n:neutron-filter-top - [0:0]\n:neutron-linuxbri-FORWARD - [0:0]\n:neutron-linuxbri-INPUT - [0:0]\n:neutron-linuxbri-OUTPUT - [0:0]\n:neutron-linuxbri-local - [0:0]\n:neutron-linuxbri-scope - [0:0]\n:neutron-linuxbri-sg-chain - [0:0]\n:neutron-linuxbri-sg-fallback - [0:0]\n:nova-api-FORWARD - [0:0]\n:nova-api-INPUT - [0:0]\n....\n```\n\n### 1.3 清除规则\n\n清除单个规则\n\n```shell\n# 先查看\n[root@controller ~]# iptables -L -n --line-numbers\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n2    neutron-linuxbri-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n3    nova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n4    nova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n\n# 删除FORWARD的第2条规则\n[root@controller ~]# iptables -D FORWARD 2\n\n# 再次查看，删除成功\n[root@controller ~]# iptables -L -n --line-numbers\nChain INPUT (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-linuxbri-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-api-INPUT  all  --  0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT)\nnum  target     prot opt source               destination\n1    neutron-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n2    nova-filter-top  all  --  0.0.0.0/0            0.0.0.0/0\n3    nova-api-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0\n....\n\n# 如果不指定删除的序号，会报错\n[root@controller ~]# iptables -D FORWARD\niptables: Bad rule (does a matching rule exist in that chain?).\n```\n\n清除规则计数\n\n```shell\n# 查看原内容\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 3196 packets, 657K bytes)\n pkts bytes target     prot opt in     out     source               destination\n23118 5147K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n24264 5395K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n\n# 清除规则计数 -Z\n[root@controller ~]# iptables -Z\n\n# 查看效果，pkts与bytes减少，即规则匹配到的报文数量与报文内容大小均减少，清除成功\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 58 packets, 11344 bytes)\n pkts bytes target     prot opt in     out     source               destination\n   58 11344 neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n   58 11344 nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n清除所有规则\n\n```shell\n# 清除默认规则\n[root@controller ~]# iptables -F\n\n# 清除自定义规则\n[root@controller ~]# iptables -X\n\n# 查看效果\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 424 packets, 84770 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 398 packets, 83826 bytes)\n pkts bytes target     prot opt in     out     source               destination\n```\n\n### 1.4 恢复规则\n\n从备份文件恢复规则\n\n```shell\n# 从文件恢复\n[root@controller ~]# iptables-restore < iptables.rules\n\n# 查看确认已恢复\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 268 packets, 46570 bytes)\n pkts bytes target     prot opt in     out     source               destination\n  268 46570 neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n  268 46570 nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n### 1.5 更改规则\n\n可以从ACCEPT改为DROP\n\n```shell\n# 查看原规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 342 packets, 49890 bytes)\n pkts bytes target     prot opt in     out     source               destination\n 4455  836K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n 4455  836K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n\n# -P 修改\n[root@controller ~]# iptables -P FORWARD DROP\n\n# 再次查看，FORWARD链修改DROP成功\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 38 packets, 5017 bytes)\n pkts bytes target     prot opt in     out     source               destination\n 4849  905K neutron-linuxbri-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n 4849  905K nova-api-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n\nChain FORWARD (policy DROP 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 neutron-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 neutron-linuxbri-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-filter-top  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 nova-api-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0\n....\n```\n\n>-P 更改的规则，使用 -F 不能自动还原\n>\n>```shell\n>[root@controller ~]# iptables -F\n>[root@controller ~]# iptables -L -n -v\n>Chain INPUT (policy ACCEPT 36 packets, 6554 bytes)\n>pkts bytes target     prot opt in     out     source               destination\n>\n>Chain FORWARD (policy DROP 0 packets, 0 bytes)\n>pkts bytes target     prot opt in     out     source               destination\n>....\n>```\n\n重启iptables服务后，可以使用系统所有默认规则\n\n```shell\n# 清除所有默认规则\n[root@controller ~]# iptables -F\n\n# 查看，没有默认规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 8 packets, 520 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n\nChain OUTPUT (policy ACCEPT 4 packets, 448 bytes)\n pkts bytes target     prot opt in     out     source               destination\n \n# 重启iptables服务\n[root@controller ~]# systemctl restart iptables\n\n# 再次查看，新增了系统的默认规则\n[root@controller ~]# iptables -L -n -v\nChain INPUT (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    6   432 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED\n    0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0\n    0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0\n    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22\n    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited\n\nChain FORWARD (policy ACCEPT 0 packets, 0 bytes)\n pkts bytes target     prot opt in     out     source               destination\n    0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited\n\nChain OUTPUT (policy ACCEPT 4 packets, 544 bytes)\n pkts bytes target     prot opt in     out     source               destination\n```\n\n","slug":"01_运维/01-基础命令/day22-防火墙与iptables/iptables使用","published":1,"updated":"2022-07-06T07:15:01.813Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k26006fa8v7f2bxbr3t","content":"<h1 id=\"iptables使用手册\"><a href=\"#iptables使用手册\" class=\"headerlink\" title=\"iptables使用手册\"></a>iptables使用手册</h1><h2 id=\"一、简单实践\"><a href=\"#一、简单实践\" class=\"headerlink\" title=\"一、简单实践\"></a>一、简单实践</h2><blockquote>\n<p>从信息查看、保存规则、清除规则、恢复规则、更改规则五个方面来学习。</p>\n</blockquote>\n<h3 id=\"1-1-信息查看\"><a href=\"#1-1-信息查看\" class=\"headerlink\" title=\"1.1 信息查看\"></a>1.1 信息查看</h3><p>查看现有规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-linuxbri-INPUT  all  --  anywhere             anywhere\nnova-api-INPUT  all  --  anywhere             anywhere\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-filter-top  all  --  anywhere             anywhere\nneutron-linuxbri-FORWARD  all  --  anywhere             anywhere\nnova-filter-top  all  --  anywhere             anywhere\nnova-api-FORWARD  all  --  anywhere             anywhere\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看现有规则，显示主机ip和端口号，-n</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nneutron-linuxbri-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>结果显示：</p>\n<p>默认显示三条链的规则INPUT、FORWARD、OUTPUT，而且所有的规则都是默认接受的</p>\n<p>每条链下面显示的信息是：</p>\n<p>动作  协议 参数 源地址 目标地址</p>\n</blockquote>\n<p>显示详细信息，-v</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">11839</span> packets, 2842K bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">11839</span> 2842K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">12985</span> 3090K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>结果显示：</p>\n<p>-v显示的内容比-L -n 显示的内容多了四个字段</p>\n<p>pkts  规则匹配到的报文数量的多少</p>\n<p>bytes 规则匹配到的报文内容量的大小</p>\n<p>in   规则匹配到的流入的接口，*代表任意接口</p>\n<p>out   规则匹配到的流出的接口</p>\n</blockquote>\n<p>显示规则的标号 –line-numbers</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">13663</span> packets, 3221K bytes<span class=\"token punctuation\">)</span>\nnum   pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    <span class=\"token number\">13663</span> 3221K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    <span class=\"token number\">14809</span> 3469K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\nnum   pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">4</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>打印规则命令，将防火墙的编写命令给我们打印出来，可以通过这种方式来学习规则的编写。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -S</span>\n-P INPUT ACCEPT\n-P FORWARD ACCEPT\n-P OUTPUT ACCEPT\n-N neutron-filter-top\n-N neutron-linuxbri-FORWARD\n-N neutron-linuxbri-INPUT\n-N neutron-linuxbri-OUTPUT\n-N neutron-linuxbri-local\n-N neutron-linuxbri-scope\n-N neutron-linuxbri-sg-chain\n-N neutron-linuxbri-sg-fallback\n-N nova-api-FORWARD\n-N nova-api-INPUT\n-N nova-api-OUTPUT\n-N nova-api-local\n-N nova-filter-top\n-A INPUT -j neutron-linuxbri-INPUT\n-A INPUT -j nova-api-INPUT\n-A FORWARD -j neutron-filter-top\n-A FORWARD -j neutron-linuxbri-FORWARD\n-A FORWARD -j nova-filter-top\n-A FORWARD -j nova-api-FORWARD\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-保存规则\"><a href=\"#1-2-保存规则\" class=\"headerlink\" title=\"1.2 保存规则\"></a>1.2 保存规则</h3><blockquote>\n<p>使用 iptables-save命令可以保存规则</p>\n</blockquote>\n<p>将当前的规则保存到文件中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables-save > iptables.rules</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat iptables.rules</span>\n<span class=\"token comment\"># Generated by iptables-save v1.4.21 on Wed Oct 20 09:22:53 2021</span>\n*filter\n:INPUT ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">16785</span>:3861723<span class=\"token punctuation\">]</span>\n:FORWARD ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:OUTPUT ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">16549</span>:3883715<span class=\"token punctuation\">]</span>\n:neutron-filter-top - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-FORWARD - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-INPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-OUTPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-local - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-scope - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-sg-chain - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-sg-fallback - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:nova-api-FORWARD - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:nova-api-INPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-清除规则\"><a href=\"#1-3-清除规则\" class=\"headerlink\" title=\"1.3 清除规则\"></a>1.3 清除规则</h3><p>清除单个规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 先查看</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    neutron-linuxbri-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>    nova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">4</span>    nova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 删除FORWARD的第2条规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -D FORWARD 2</span>\n\n<span class=\"token comment\"># 再次查看，删除成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>    nova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 如果不指定删除的序号，会报错</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -D FORWARD</span>\niptables: Bad rule <span class=\"token punctuation\">(</span>does a matching rule exist <span class=\"token keyword\">in</span> that chain?<span class=\"token punctuation\">)</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>清除规则计数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看原内容</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">3196</span> packets, 657K bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">23118</span> 5147K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">24264</span> 5395K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 清除规则计数 -Z</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -Z</span>\n\n<span class=\"token comment\"># 查看效果，pkts与bytes减少，即规则匹配到的报文数量与报文内容大小均减少，清除成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">58</span> packets, <span class=\"token number\">11344</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n   <span class=\"token number\">58</span> <span class=\"token number\">11344</span> neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n   <span class=\"token number\">58</span> <span class=\"token number\">11344</span> nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>清除所有规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 清除默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n\n<span class=\"token comment\"># 清除自定义规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -X</span>\n\n<span class=\"token comment\"># 查看效果</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">424</span> packets, <span class=\"token number\">84770</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">398</span> packets, <span class=\"token number\">83826</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-4-恢复规则\"><a href=\"#1-4-恢复规则\" class=\"headerlink\" title=\"1.4 恢复规则\"></a>1.4 恢复规则</h3><p>从备份文件恢复规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 从文件恢复</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables-restore &lt; iptables.rules</span>\n\n<span class=\"token comment\"># 查看确认已恢复</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">268</span> packets, <span class=\"token number\">46570</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n  <span class=\"token number\">268</span> <span class=\"token number\">46570</span> neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n  <span class=\"token number\">268</span> <span class=\"token number\">46570</span> nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-5-更改规则\"><a href=\"#1-5-更改规则\" class=\"headerlink\" title=\"1.5 更改规则\"></a>1.5 更改规则</h3><p>可以从ACCEPT改为DROP</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看原规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">342</span> packets, <span class=\"token number\">49890</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n <span class=\"token number\">4455</span>  836K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n <span class=\"token number\">4455</span>  836K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># -P 修改</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -P FORWARD DROP</span>\n\n<span class=\"token comment\"># 再次查看，FORWARD链修改DROP成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">38</span> packets, <span class=\"token number\">5017</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n <span class=\"token number\">4849</span>  905K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n <span class=\"token number\">4849</span>  905K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy DROP <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>-P 更改的规则，使用 -F 不能自动还原</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token operator\">></span><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n<span class=\"token operator\">></span><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\n<span class=\"token operator\">></span>Chain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">36</span> packets, <span class=\"token number\">6554</span> bytes<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">></span>pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\n<span class=\"token operator\">></span>Chain FORWARD <span class=\"token punctuation\">(</span>policy DROP <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">></span>pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token operator\">></span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<p>重启iptables服务后，可以使用系统所有默认规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 清除所有默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n\n<span class=\"token comment\"># 查看，没有默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">8</span> packets, <span class=\"token number\">520</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">4</span> packets, <span class=\"token number\">448</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n \n<span class=\"token comment\"># 重启iptables服务</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart iptables</span>\n\n<span class=\"token comment\"># 再次查看，新增了系统的默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">6</span>   <span class=\"token number\">432</span> ACCEPT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            state RELATED,ESTABLISHED\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     icmp --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     all  --  lo     *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     tcp  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            state NEW tcp dpt:22\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> REJECT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            reject-with icmp-host-prohibited\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> REJECT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            reject-with icmp-host-prohibited\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">4</span> packets, <span class=\"token number\">544</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"iptables使用手册\"><a href=\"#iptables使用手册\" class=\"headerlink\" title=\"iptables使用手册\"></a>iptables使用手册</h1><h2 id=\"一、简单实践\"><a href=\"#一、简单实践\" class=\"headerlink\" title=\"一、简单实践\"></a>一、简单实践</h2><blockquote>\n<p>从信息查看、保存规则、清除规则、恢复规则、更改规则五个方面来学习。</p>\n</blockquote>\n<h3 id=\"1-1-信息查看\"><a href=\"#1-1-信息查看\" class=\"headerlink\" title=\"1.1 信息查看\"></a>1.1 信息查看</h3><p>查看现有规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-linuxbri-INPUT  all  --  anywhere             anywhere\nnova-api-INPUT  all  --  anywhere             anywhere\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-filter-top  all  --  anywhere             anywhere\nneutron-linuxbri-FORWARD  all  --  anywhere             anywhere\nnova-filter-top  all  --  anywhere             anywhere\nnova-api-FORWARD  all  --  anywhere             anywhere\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>查看现有规则，显示主机ip和端口号，-n</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination\nneutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nneutron-linuxbri-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\nnova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>结果显示：</p>\n<p>默认显示三条链的规则INPUT、FORWARD、OUTPUT，而且所有的规则都是默认接受的</p>\n<p>每条链下面显示的信息是：</p>\n<p>动作  协议 参数 源地址 目标地址</p>\n</blockquote>\n<p>显示详细信息，-v</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">11839</span> packets, 2842K bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">11839</span> 2842K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">12985</span> 3090K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>结果显示：</p>\n<p>-v显示的内容比-L -n 显示的内容多了四个字段</p>\n<p>pkts  规则匹配到的报文数量的多少</p>\n<p>bytes 规则匹配到的报文内容量的大小</p>\n<p>in   规则匹配到的流入的接口，*代表任意接口</p>\n<p>out   规则匹配到的流出的接口</p>\n</blockquote>\n<p>显示规则的标号 –line-numbers</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">13663</span> packets, 3221K bytes<span class=\"token punctuation\">)</span>\nnum   pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    <span class=\"token number\">13663</span> 3221K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    <span class=\"token number\">14809</span> 3469K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\nnum   pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">4</span>        <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>打印规则命令，将防火墙的编写命令给我们打印出来，可以通过这种方式来学习规则的编写。</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -S</span>\n-P INPUT ACCEPT\n-P FORWARD ACCEPT\n-P OUTPUT ACCEPT\n-N neutron-filter-top\n-N neutron-linuxbri-FORWARD\n-N neutron-linuxbri-INPUT\n-N neutron-linuxbri-OUTPUT\n-N neutron-linuxbri-local\n-N neutron-linuxbri-scope\n-N neutron-linuxbri-sg-chain\n-N neutron-linuxbri-sg-fallback\n-N nova-api-FORWARD\n-N nova-api-INPUT\n-N nova-api-OUTPUT\n-N nova-api-local\n-N nova-filter-top\n-A INPUT -j neutron-linuxbri-INPUT\n-A INPUT -j nova-api-INPUT\n-A FORWARD -j neutron-filter-top\n-A FORWARD -j neutron-linuxbri-FORWARD\n-A FORWARD -j nova-filter-top\n-A FORWARD -j nova-api-FORWARD\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-2-保存规则\"><a href=\"#1-2-保存规则\" class=\"headerlink\" title=\"1.2 保存规则\"></a>1.2 保存规则</h3><blockquote>\n<p>使用 iptables-save命令可以保存规则</p>\n</blockquote>\n<p>将当前的规则保存到文件中</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables-save > iptables.rules</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat iptables.rules</span>\n<span class=\"token comment\"># Generated by iptables-save v1.4.21 on Wed Oct 20 09:22:53 2021</span>\n*filter\n:INPUT ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">16785</span>:3861723<span class=\"token punctuation\">]</span>\n:FORWARD ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:OUTPUT ACCEPT <span class=\"token punctuation\">[</span><span class=\"token number\">16549</span>:3883715<span class=\"token punctuation\">]</span>\n:neutron-filter-top - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-FORWARD - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-INPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-OUTPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-local - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-scope - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-sg-chain - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:neutron-linuxbri-sg-fallback - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:nova-api-FORWARD - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n:nova-api-INPUT - <span class=\"token punctuation\">[</span><span class=\"token number\">0</span>:0<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-3-清除规则\"><a href=\"#1-3-清除规则\" class=\"headerlink\" title=\"1.3 清除规则\"></a>1.3 清除规则</h3><p>清除单个规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 先查看</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    neutron-linuxbri-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>    nova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">4</span>    nova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 删除FORWARD的第2条规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -D FORWARD 2</span>\n\n<span class=\"token comment\"># 再次查看，删除成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n --line-numbers</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-linuxbri-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-api-INPUT  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\nnum  target     prot opt <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">1</span>    neutron-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">2</span>    nova-filter-top  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">3</span>    nova-api-FORWARD  all  --  <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 如果不指定删除的序号，会报错</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -D FORWARD</span>\niptables: Bad rule <span class=\"token punctuation\">(</span>does a matching rule exist <span class=\"token keyword\">in</span> that chain?<span class=\"token punctuation\">)</span>.<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>清除规则计数</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看原内容</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">3196</span> packets, 657K bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token number\">23118</span> 5147K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token number\">24264</span> 5395K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># 清除规则计数 -Z</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -Z</span>\n\n<span class=\"token comment\"># 查看效果，pkts与bytes减少，即规则匹配到的报文数量与报文内容大小均减少，清除成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">58</span> packets, <span class=\"token number\">11344</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n   <span class=\"token number\">58</span> <span class=\"token number\">11344</span> neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n   <span class=\"token number\">58</span> <span class=\"token number\">11344</span> nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>清除所有规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 清除默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n\n<span class=\"token comment\"># 清除自定义规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -X</span>\n\n<span class=\"token comment\"># 查看效果</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">424</span> packets, <span class=\"token number\">84770</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">398</span> packets, <span class=\"token number\">83826</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-4-恢复规则\"><a href=\"#1-4-恢复规则\" class=\"headerlink\" title=\"1.4 恢复规则\"></a>1.4 恢复规则</h3><p>从备份文件恢复规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 从文件恢复</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables-restore &lt; iptables.rules</span>\n\n<span class=\"token comment\"># 查看确认已恢复</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">268</span> packets, <span class=\"token number\">46570</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n  <span class=\"token number\">268</span> <span class=\"token number\">46570</span> neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n  <span class=\"token number\">268</span> <span class=\"token number\">46570</span> nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"1-5-更改规则\"><a href=\"#1-5-更改规则\" class=\"headerlink\" title=\"1.5 更改规则\"></a>1.5 更改规则</h3><p>可以从ACCEPT改为DROP</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 查看原规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">342</span> packets, <span class=\"token number\">49890</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n <span class=\"token number\">4455</span>  836K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n <span class=\"token number\">4455</span>  836K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n\n<span class=\"token comment\"># -P 修改</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -P FORWARD DROP</span>\n\n<span class=\"token comment\"># 再次查看，FORWARD链修改DROP成功</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">38</span> packets, <span class=\"token number\">5017</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n <span class=\"token number\">4849</span>  905K neutron-linuxbri-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n <span class=\"token number\">4849</span>  905K nova-api-INPUT  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy DROP <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> neutron-linuxbri-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-filter-top  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> nova-api-FORWARD  all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote>\n<p>-P 更改的规则，使用 -F 不能自动还原</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token operator\">></span><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n<span class=\"token operator\">></span><span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\n<span class=\"token operator\">></span>Chain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">36</span> packets, <span class=\"token number\">6554</span> bytes<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">></span>pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\n<span class=\"token operator\">></span>Chain FORWARD <span class=\"token punctuation\">(</span>policy DROP <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">></span>pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n<span class=\"token operator\">></span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n</blockquote>\n<p>重启iptables服务后，可以使用系统所有默认规则</p>\n<pre class=\"line-numbers language-shell\" data-language=\"shell\"><code class=\"language-shell\"><span class=\"token comment\"># 清除所有默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -F</span>\n\n<span class=\"token comment\"># 查看，没有默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">8</span> packets, <span class=\"token number\">520</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">4</span> packets, <span class=\"token number\">448</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n \n<span class=\"token comment\"># 重启iptables服务</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart iptables</span>\n\n<span class=\"token comment\"># 再次查看，新增了系统的默认规则</span>\n<span class=\"token punctuation\">[</span>root@controller ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -L -n -v</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">6</span>   <span class=\"token number\">432</span> ACCEPT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            state RELATED,ESTABLISHED\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     icmp --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     all  --  lo     *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> ACCEPT     tcp  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            state NEW tcp dpt:22\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> REJECT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            reject-with icmp-host-prohibited\n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">0</span> packets, <span class=\"token number\">0</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination\n    <span class=\"token number\">0</span>     <span class=\"token number\">0</span> REJECT     all  --  *      *       <span class=\"token number\">0.0</span>.0.0/0            <span class=\"token number\">0.0</span>.0.0/0            reject-with icmp-host-prohibited\n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT <span class=\"token number\">4</span> packets, <span class=\"token number\">544</span> bytes<span class=\"token punctuation\">)</span>\n pkts bytes target     prot opt <span class=\"token keyword\">in</span>     out     <span class=\"token builtin class-name\">source</span>               destination<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n"},{"title":"运维之基础命令--计划任务","date":"2022-07-06T03:19:52.000Z","_content":"\n# 计划任务\n\n1、Crontab表达式\n\n```bash\n*  *  *  * * \n分 时 日 月 周\n\n每天的凌晨2点   02：00     00 02 * * *\n每月执行一次    00  00  01  * *\n每个月的一号零点零时零分同时这一天时星期六 00  00  01  *  6\n\n```\n\n2、系统级别的计划任务\n\n```bash\n1、/etc/crontab\n\n2、如下的目录\n    /etc/cron.hourly/ # 系统定时任务每个⼩时运⾏这个⽬录⾥的内容\n    /etc/cron.daily/ # 系统定时任务每天运⾏这个⽬录⾥的内容\n    /etc/cron.weekly/ # 系统定时任务每周运⾏这个⽬录⾥的内容\n    /etc/cron.monthly/ # 系统定时任务每⽉运⾏这个⽬录⾥的内容\n```\n\n3、用户级别的计划任务\n\n```bash\ncrontab -e\n\n-e : 编辑计划任务\n-l : 查看计划任务\n\n# 注：用户级别的计划任务存放在/var/spool/cron/，不同的用户存放的计划任务是以其自己的名字命名的脚本\n```\n\n4、crontab语法\n\n```bash\n# 1 3 5\n00 00 1,3,5 * *\n\n# 1到5号\n00 00 1-5\n\n# 每几分钟，每几个小数，每几天\n0/2  /2 \n00 0/2    00 /2\n00 00 0/2   00 00 /2\n```\n\n\n\n5、每3分钟同步一下系统时间\n\n","source":"_posts/01_运维/01-基础命令/day21-计划任务/计划任务.md","raw":"---\ntitle: 运维之基础命令--计划任务\ndate: 2022-07-06 11:19:52\ncategories:\n- 运维\n- （一）基础命令\ntags:\n---\n\n# 计划任务\n\n1、Crontab表达式\n\n```bash\n*  *  *  * * \n分 时 日 月 周\n\n每天的凌晨2点   02：00     00 02 * * *\n每月执行一次    00  00  01  * *\n每个月的一号零点零时零分同时这一天时星期六 00  00  01  *  6\n\n```\n\n2、系统级别的计划任务\n\n```bash\n1、/etc/crontab\n\n2、如下的目录\n    /etc/cron.hourly/ # 系统定时任务每个⼩时运⾏这个⽬录⾥的内容\n    /etc/cron.daily/ # 系统定时任务每天运⾏这个⽬录⾥的内容\n    /etc/cron.weekly/ # 系统定时任务每周运⾏这个⽬录⾥的内容\n    /etc/cron.monthly/ # 系统定时任务每⽉运⾏这个⽬录⾥的内容\n```\n\n3、用户级别的计划任务\n\n```bash\ncrontab -e\n\n-e : 编辑计划任务\n-l : 查看计划任务\n\n# 注：用户级别的计划任务存放在/var/spool/cron/，不同的用户存放的计划任务是以其自己的名字命名的脚本\n```\n\n4、crontab语法\n\n```bash\n# 1 3 5\n00 00 1,3,5 * *\n\n# 1到5号\n00 00 1-5\n\n# 每几分钟，每几个小数，每几天\n0/2  /2 \n00 0/2    00 /2\n00 00 0/2   00 00 /2\n```\n\n\n\n5、每3分钟同步一下系统时间\n\n","slug":"01_运维/01-基础命令/day21-计划任务/计划任务","published":1,"updated":"2022-07-06T07:14:55.036Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl5rn8k27006ga8v7bpbs96ns","content":"<h1 id=\"计划任务\"><a href=\"#计划任务\" class=\"headerlink\" title=\"计划任务\"></a>计划任务</h1><p>1、Crontab表达式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">*  *  *  * * \n分 时 日 月 周\n\n每天的凌晨2点   02：00     00 02 * * *\n每月执行一次    00  00  01  * *\n每个月的一号零点零时零分同时这一天时星期六 00  00  01  *  <span class=\"token number\">6</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、系统级别的计划任务</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、/etc/crontab\n\n<span class=\"token number\">2</span>、如下的目录\n    /etc/cron.hourly/ <span class=\"token comment\"># 系统定时任务每个⼩时运⾏这个⽬录⾥的内容</span>\n    /etc/cron.daily/ <span class=\"token comment\"># 系统定时任务每天运⾏这个⽬录⾥的内容</span>\n    /etc/cron.weekly/ <span class=\"token comment\"># 系统定时任务每周运⾏这个⽬录⾥的内容</span>\n    /etc/cron.monthly/ <span class=\"token comment\"># 系统定时任务每⽉运⾏这个⽬录⾥的内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、用户级别的计划任务</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">crontab</span> -e\n\n-e <span class=\"token builtin class-name\">:</span> 编辑计划任务\n-l <span class=\"token builtin class-name\">:</span> 查看计划任务\n\n<span class=\"token comment\"># 注：用户级别的计划任务存放在/var/spool/cron/，不同的用户存放的计划任务是以其自己的名字命名的脚本</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、crontab语法</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 1 3 5</span>\n00 00 <span class=\"token number\">1,3</span>,5 * *\n\n<span class=\"token comment\"># 1到5号</span>\n00 00 <span class=\"token number\">1</span>-5\n\n<span class=\"token comment\"># 每几分钟，每几个小数，每几天</span>\n<span class=\"token number\">0</span>/2  /2 \n00 <span class=\"token number\">0</span>/2    00 /2\n00 00 <span class=\"token number\">0</span>/2   00 00 /2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>5、每3分钟同步一下系统时间</p>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"计划任务\"><a href=\"#计划任务\" class=\"headerlink\" title=\"计划任务\"></a>计划任务</h1><p>1、Crontab表达式</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">*  *  *  * * \n分 时 日 月 周\n\n每天的凌晨2点   02：00     00 02 * * *\n每月执行一次    00  00  01  * *\n每个月的一号零点零时零分同时这一天时星期六 00  00  01  *  <span class=\"token number\">6</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>2、系统级别的计划任务</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token number\">1</span>、/etc/crontab\n\n<span class=\"token number\">2</span>、如下的目录\n    /etc/cron.hourly/ <span class=\"token comment\"># 系统定时任务每个⼩时运⾏这个⽬录⾥的内容</span>\n    /etc/cron.daily/ <span class=\"token comment\"># 系统定时任务每天运⾏这个⽬录⾥的内容</span>\n    /etc/cron.weekly/ <span class=\"token comment\"># 系统定时任务每周运⾏这个⽬录⾥的内容</span>\n    /etc/cron.monthly/ <span class=\"token comment\"># 系统定时任务每⽉运⾏这个⽬录⾥的内容</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>3、用户级别的计划任务</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">crontab</span> -e\n\n-e <span class=\"token builtin class-name\">:</span> 编辑计划任务\n-l <span class=\"token builtin class-name\">:</span> 查看计划任务\n\n<span class=\"token comment\"># 注：用户级别的计划任务存放在/var/spool/cron/，不同的用户存放的计划任务是以其自己的名字命名的脚本</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>4、crontab语法</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># 1 3 5</span>\n00 00 <span class=\"token number\">1,3</span>,5 * *\n\n<span class=\"token comment\"># 1到5号</span>\n00 00 <span class=\"token number\">1</span>-5\n\n<span class=\"token comment\"># 每几分钟，每几个小数，每几天</span>\n<span class=\"token number\">0</span>/2  /2 \n00 <span class=\"token number\">0</span>/2    00 /2\n00 00 <span class=\"token number\">0</span>/2   00 00 /2<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n\n<p>5、每3分钟同步一下系统时间</p>\n"}],"PostAsset":[{"_id":"source/_posts/01_运维/03-Docker/Docker系列-九-Dokcer跨主机容器互连/overlay网络访问.png","slug":"overlay网络访问.png","post":"cl5rn8k0r001ha8v7ee6o98da","modified":0,"renderable":0},{"_id":"source/_posts/01_运维/03-Docker/Docker系列-十-Dokcer单机编排docker-compose/显示不全.png","slug":"显示不全.png","post":"cl5rn8k0v001pa8v7a2uj51lm","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cl5rn8jzs0001a8v71g0yfan1","category_id":"cl5rn8k030004a8v7aiqq3xlc","_id":"cl5rn8k0a000da8v7gxhtak55"},{"post_id":"cl5rn8k060007a8v781pyfwyr","category_id":"cl5rn8k0a000ea8v752r29yr9","_id":"cl5rn8k0f000na8v7hwzt38p4"},{"post_id":"cl5rn8k070009a8v74uu24p63","category_id":"cl5rn8k0a000ea8v752r29yr9","_id":"cl5rn8k0h000ra8v7ccevb9nz"},{"post_id":"cl5rn8k08000ba8v780bo9cya","category_id":"cl5rn8k0a000ea8v752r29yr9","_id":"cl5rn8k0i000ua8v7b2n3d025"},{"post_id":"cl5rn8k050006a8v7b5zg9onp","category_id":"cl5rn8k08000aa8v7gnu7f8ox","_id":"cl5rn8k0j000za8v7agxcdcm1"},{"post_id":"cl5rn8k050006a8v7b5zg9onp","category_id":"cl5rn8k0g000qa8v70td33ov6","_id":"cl5rn8k0k0011a8v77i8t5ab9"},{"post_id":"cl5rn8k09000ca8v7bweg8ici","category_id":"cl5rn8k08000aa8v7gnu7f8ox","_id":"cl5rn8k0k0013a8v77drk0yr2"},{"post_id":"cl5rn8k09000ca8v7bweg8ici","category_id":"cl5rn8k0g000qa8v70td33ov6","_id":"cl5rn8k0l0016a8v7dmwyecm5"},{"post_id":"cl5rn8k0k0012a8v71cnehh41","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k160027a8v7549zd424"},{"post_id":"cl5rn8k0k0012a8v71cnehh41","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k160029a8v7bauoh2y6"},{"post_id":"cl5rn8k0a000ga8v74vlk35mj","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k17002ca8v77xl16auz"},{"post_id":"cl5rn8k0a000ga8v74vlk35mj","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k18002ea8v7d4qk144x"},{"post_id":"cl5rn8k0k0014a8v704b003dh","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k18002ha8v7d1ovesdl"},{"post_id":"cl5rn8k0k0014a8v704b003dh","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k19002ja8v75xibduiq"},{"post_id":"cl5rn8k0l0017a8v7a1g0cwr0","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1a002ma8v722dcbfn8"},{"post_id":"cl5rn8k0l0017a8v7a1g0cwr0","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1b002oa8v7bx9lchm0"},{"post_id":"cl5rn8k0b000ia8v712mqhhxd","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1c002ra8v74xxdfume"},{"post_id":"cl5rn8k0b000ia8v712mqhhxd","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1c002ta8v7gy8t2ukb"},{"post_id":"cl5rn8k0m0018a8v7f6d43f5t","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1d002va8v7alxcgs0a"},{"post_id":"cl5rn8k0m0018a8v7f6d43f5t","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1d002ya8v74bv8fe24"},{"post_id":"cl5rn8k0n001aa8v73ti9db7y","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1e0031a8v7edf56uei"},{"post_id":"cl5rn8k0n001aa8v73ti9db7y","category_id":"cl5rn8k1b002qa8v7ft1ghawz","_id":"cl5rn8k1f0033a8v7he276qlf"},{"post_id":"cl5rn8k0d000ka8v766uw6d54","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1f0035a8v7cmmtd9vy"},{"post_id":"cl5rn8k0d000ka8v766uw6d54","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1g0038a8v7dbkthe1d"},{"post_id":"cl5rn8k0n001ba8v795gu10ha","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1g003aa8v797tk59ev"},{"post_id":"cl5rn8k0n001ba8v795gu10ha","category_id":"cl5rn8k1e0030a8v7eril9qx2","_id":"cl5rn8k1h003da8v79a1v62ww"},{"post_id":"cl5rn8k0p001da8v7akfi4plm","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1i003ha8v7bbfn48t2"},{"post_id":"cl5rn8k0p001da8v7akfi4plm","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1j003ja8v7g55zb3jb"},{"post_id":"cl5rn8k0e000la8v7daipc95f","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1k003ma8v7blyngnry"},{"post_id":"cl5rn8k0e000la8v7daipc95f","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1k003na8v766rsbzvv"},{"post_id":"cl5rn8k0q001ea8v7e52se6od","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1l003pa8v7gvnl0bds"},{"post_id":"cl5rn8k0q001ea8v7e52se6od","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1l003qa8v78qizfusc"},{"post_id":"cl5rn8k0r001ga8v7dmlc8220","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1l003sa8v750u793j4"},{"post_id":"cl5rn8k0r001ga8v7dmlc8220","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1l003ta8v70jlq9ap8"},{"post_id":"cl5rn8k0f000oa8v7hywvb4q9","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1l003va8v7decmc6yn"},{"post_id":"cl5rn8k0f000oa8v7hywvb4q9","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1m003wa8v7eu0e7ag6"},{"post_id":"cl5rn8k0r001ha8v7ee6o98da","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1m003ya8v77lhn815l"},{"post_id":"cl5rn8k0r001ha8v7ee6o98da","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1m003za8v78igy62eq"},{"post_id":"cl5rn8k0s001ja8v7hxma6lyk","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1m0041a8v7brnlaptt"},{"post_id":"cl5rn8k0s001ja8v7hxma6lyk","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1n0042a8v71j7zg38r"},{"post_id":"cl5rn8k0g000pa8v7afmka5tz","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1n0044a8v7bnge4mpd"},{"post_id":"cl5rn8k0g000pa8v7afmka5tz","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1n0045a8v743rlbwcl"},{"post_id":"cl5rn8k0t001ka8v71iuvbxd1","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1o0047a8v7299l80r9"},{"post_id":"cl5rn8k0t001ka8v71iuvbxd1","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1o0048a8v76cp16rua"},{"post_id":"cl5rn8k0u001ma8v764mh3un5","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1p004aa8v75h2bbqmi"},{"post_id":"cl5rn8k0u001ma8v764mh3un5","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1p004ba8v78l4b6ur0"},{"post_id":"cl5rn8k0h000sa8v75cqb3nwe","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1p004da8v79wnj9g3i"},{"post_id":"cl5rn8k0h000sa8v75cqb3nwe","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1q004ea8v777zy0bki"},{"post_id":"cl5rn8k0u001na8v7ezwh0kst","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1q004ga8v715dm240a"},{"post_id":"cl5rn8k0u001na8v7ezwh0kst","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1q004ha8v7gddc0clh"},{"post_id":"cl5rn8k0v001pa8v7a2uj51lm","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1q004ja8v730ly3l6x"},{"post_id":"cl5rn8k0v001pa8v7a2uj51lm","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1q004ka8v7fbgp4203"},{"post_id":"cl5rn8k0h000ta8v7a7uc55p8","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1r004ma8v76xqk1c5v"},{"post_id":"cl5rn8k0h000ta8v7a7uc55p8","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1r004na8v7brv06u10"},{"post_id":"cl5rn8k0w001qa8v7dehf1fnf","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1r004pa8v781aqc56f"},{"post_id":"cl5rn8k0w001qa8v7dehf1fnf","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1s004qa8v75h48atug"},{"post_id":"cl5rn8k0w001sa8v7aovi4ut0","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1s004sa8v7cy4ogskq"},{"post_id":"cl5rn8k0w001sa8v7aovi4ut0","category_id":"cl5rn8k1f0036a8v74l9h0ndu","_id":"cl5rn8k1s004ta8v7gxlgdwga"},{"post_id":"cl5rn8k0i000wa8v7bsodh9kl","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1s004ua8v7429yhh82"},{"post_id":"cl5rn8k0i000wa8v7bsodh9kl","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1s004wa8v7a6ft5vw3"},{"post_id":"cl5rn8k0j000xa8v7bw3ueb13","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1t0050a8v70lc9840o"},{"post_id":"cl5rn8k0j000xa8v7bw3ueb13","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1t0051a8v75als6vtj"},{"post_id":"cl5rn8k0j0010a8v79uo0bcrt","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1u0053a8v794el9mbw"},{"post_id":"cl5rn8k0j0010a8v79uo0bcrt","category_id":"cl5rn8k130020a8v7bv2fgmf6","_id":"cl5rn8k1u0055a8v7gjjr90v7"},{"post_id":"cl5rn8k1c002sa8v72cl2bble","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1u0057a8v78jgkcicn"},{"post_id":"cl5rn8k1c002sa8v72cl2bble","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1v0058a8v7c6ue9nu0"},{"post_id":"cl5rn8k1c002ua8v7hpl7huiz","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1v005aa8v707d66lto"},{"post_id":"cl5rn8k1c002ua8v7hpl7huiz","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1v005ba8v7dumv29ab"},{"post_id":"cl5rn8k1d002za8v71r3y3a58","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1v005da8v7e1b07i1k"},{"post_id":"cl5rn8k1d002za8v71r3y3a58","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1v005ea8v78zsd9qhh"},{"post_id":"cl5rn8k1e0032a8v7hjyyc2kz","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1w005ga8v7d68664tj"},{"post_id":"cl5rn8k1e0032a8v7hjyyc2kz","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1w005ha8v7bl8paejm"},{"post_id":"cl5rn8k1f0034a8v720sm411e","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1w005ja8v7ejpu2njq"},{"post_id":"cl5rn8k1f0034a8v720sm411e","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1w005ka8v75lc1dhyn"},{"post_id":"cl5rn8k1f0037a8v70dmi7ayd","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1w005ma8v73qr2dtdq"},{"post_id":"cl5rn8k1f0037a8v70dmi7ayd","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1x005na8v7coa6fm8l"},{"post_id":"cl5rn8k1g0039a8v731kkc23o","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1x005pa8v756chhfom"},{"post_id":"cl5rn8k1g0039a8v731kkc23o","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1x005qa8v753yc6s1c"},{"post_id":"cl5rn8k1h003ba8v758t640vy","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1x005sa8v7fix3hvd9"},{"post_id":"cl5rn8k1h003ba8v758t640vy","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1x005ta8v79k3pfmlk"},{"post_id":"cl5rn8k1h003ea8v72c4g9o7w","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k1z005va8v71k7k93bl"},{"post_id":"cl5rn8k1h003ea8v72c4g9o7w","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k1z005wa8v7f2bn26nh"},{"post_id":"cl5rn8k1i003fa8v7b9zx0boi","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k20005ya8v7c5iv1vgi"},{"post_id":"cl5rn8k1i003fa8v7b9zx0boi","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k20005za8v73v47bz9b"},{"post_id":"cl5rn8k1j003ia8v7fq4p3qw4","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k200061a8v7c5nne6q3"},{"post_id":"cl5rn8k1j003ia8v7fq4p3qw4","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k200062a8v7gn8hhgjj"},{"post_id":"cl5rn8k1j003ka8v7bgoo0tuk","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k210063a8v78qm3g8qb"},{"post_id":"cl5rn8k1j003ka8v7bgoo0tuk","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k210065a8v778m3faxk"},{"post_id":"cl5rn8k0x001ta8v7fx9h675g","category_id":"cl5rn8k1s004ra8v73iq90d0m","_id":"cl5rn8k210067a8v79kfcak7w"},{"post_id":"cl5rn8k0x001ta8v7fx9h675g","category_id":"cl5rn8k200060a8v7b9fsbgc4","_id":"cl5rn8k210068a8v790n11nma"},{"post_id":"cl5rn8k0y001va8v78szggkma","category_id":"cl5rn8k1s004ra8v73iq90d0m","_id":"cl5rn8k210069a8v7cl4bg0dl"},{"post_id":"cl5rn8k0y001va8v78szggkma","category_id":"cl5rn8k200060a8v7b9fsbgc4","_id":"cl5rn8k21006aa8v734fzh5b2"},{"post_id":"cl5rn8k11001wa8v7hiky2boe","category_id":"cl5rn8k1s004ra8v73iq90d0m","_id":"cl5rn8k21006ba8v7diesff8v"},{"post_id":"cl5rn8k11001wa8v7hiky2boe","category_id":"cl5rn8k210066a8v7glxsfd9m","_id":"cl5rn8k22006ca8v77676brl5"},{"post_id":"cl5rn8k25006da8v7f84xcoe4","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k27006ha8v7cfupfsp1"},{"post_id":"cl5rn8k25006da8v7f84xcoe4","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k28006ia8v760343oh9"},{"post_id":"cl5rn8k26006ea8v7atn2ep75","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k28006ja8v7axwzf07v"},{"post_id":"cl5rn8k26006ea8v7atn2ep75","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k28006ka8v70qvyeoi5"},{"post_id":"cl5rn8k26006fa8v7f2bxbr3t","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k28006la8v7ejv9e41i"},{"post_id":"cl5rn8k26006fa8v7f2bxbr3t","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k28006ma8v7azb2ctw1"},{"post_id":"cl5rn8k27006ga8v7bpbs96ns","category_id":"cl5rn8k0j000ya8v7elmocoau","_id":"cl5rn8k28006na8v79gwmh8md"},{"post_id":"cl5rn8k27006ga8v7bpbs96ns","category_id":"cl5rn8k1t0052a8v7dyfv419p","_id":"cl5rn8k28006oa8v7gxvk97m5"}],"PostTag":[{"post_id":"cl5rn8k050006a8v7b5zg9onp","tag_id":"cl5rn8k070008a8v7bwij8ljl","_id":"cl5rn8k0a000fa8v7dlli9zcj"},{"post_id":"cl5rn8k09000ca8v7bweg8ici","tag_id":"cl5rn8k070008a8v7bwij8ljl","_id":"cl5rn8k0b000ha8v7h3zp6kwr"}],"Tag":[{"name":"工作","_id":"cl5rn8k070008a8v7bwij8ljl"}]}}