---
title: 海光服务器性能测试最佳实践
date: 2023-12-21 11:19:52
categories:
- 测试
- 信创POC测试
tags:
---

# 海光服务器性能测试最佳实践

# 配置清单

操作系统：

```shell
阿里云OS:
AliOS7U2-4.19-x86-64.1.265

#uname -a
Linux localhost.localdomain 4.19.91-007.ali4000.alios7.x86_64 #1 SMP Wed Apr 8 16:17:43 CST 2020 x86_64 x86_64 x86_64 GNU/Linux
```

CPU信息：

```shell
#lscpu 
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                128
On-line CPU(s) list:   0-127
Thread(s) per core:    2
Core(s) per socket:    32
Socket(s):             2
NUMA node(s):          8
Vendor ID:             HygonGenuine
CPU family:            24
Model:                 2
Model name:            Hygon C86 7380 32-core Processor
Stepping:              2
CPU MHz:               2197.285
CPU max MHz:           2200.0000
CPU min MHz:           1200.0000
BogoMIPS:              4399.97
Virtualization:        AMD-V
L1d cache:             32K
L1i cache:             64K
L2 cache:              512K
L3 cache:              8192K
NUMA node0 CPU(s):     0-7,64-71
NUMA node1 CPU(s):     8-15,72-79
NUMA node2 CPU(s):     16-23,80-87
NUMA node3 CPU(s):     24-31,88-95
NUMA node4 CPU(s):     32-39,96-103
NUMA node5 CPU(s):     40-47,104-111
NUMA node6 CPU(s):     48-55,112-119
NUMA node7 CPU(s):     56-63,120-127
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt pdpe1gb rdtscp lm constant_tsc rep_good nopl nonstop_tsc cpuid extd_apicid amd_dcm aperfmperf pni pclmulqdq monitor ssse3 fma cx16 sse4_1 sse4_2 movbe popcnt aes xsave avx f16c rdrand lahf_lm cmp_legacy svm extapic cr8_legacy abm sse4a misalignsse 3dnowprefetch osvw skinit wdt tce topoext perfctr_core perfctr_nb bpext perfctr_llc mwaitx cpb hw_pstate sme ssbd sev ibpb vmmcall fsgsbase bmi1 avx2 smep bmi2 rdseed adx smap clflushopt sha_ni xsaveopt xsavec xgetbv1 xsaves clzero irperf xsaveerptr arat npt lbrv svm_lock nrip_save tsc_scale vmcb_clean flushbyasid decodeassists pausefilter pfthreshold avic v_vmsave_vmload vgif overflow_recov succor smca
```

测试服务器软件配置清单

| 软件项       | 版本  | 备注 |
| ------------ | ----- | ---- |
| SPEC CPU2017 | 1.0.5 |      |

# 7、SPEC CPU2017测试

安装SPEC CPU 2017的依赖（如已有则忽略）

```shell
yum install libnsl gcc gcc-c++ glibc.x86_64 glibc.i686 glibc-devel.i686 glibc-devel.x86_64 libstdc++-devel.i686 libstdc++-devel.x86_64 libgcc.i686 libgcc.x86_64 libxml2.i686 libxml2.x86_64 libgfortran libhugetlbfs libnsl.i686 libnsl2.i686 libnsl2 tar perl vim numactl bzip2
```

挂载镜像

```shell
mount cpu2017-1.0.5.iso /mnt
```

安装SPEC 2017，指定安装到`/home/spec2017`

```shell
sh /mnt/install.sh -d /home/cpu2017
```

上传并解压AOCC优化包

```shell
tar -xf hygon-speccpu2017-aocc2.2.0-20230411.tar.gz -C /home/cpu2017
```

上传并解压优化库

```shell
tar -xf libs_opt.tar.gz -C /opt
```

开始测试

```shell
cd /home/cpu2017
# 根据测试需求调整run.sh中的runcpu测试命令。
nohup sh run.sh &
```

防止fpspeed 628题编译不过

```shell
# 修改/home/spec2017/config文件夹中的speed配置，注释编译选项

#-------------------------- fpseed tuning flags ---------------------------------
fpspeed:
CXX                      = clang++ -std=c++98

LDCFLAGS                 = -L$[GLIBC64_DIR] -Wl,-rpath=$[GLIBC64_DIR] -Wl,--dynamic-linker=$[GLIBC64_DIR]/ld-linux-x86-64.so.2
LDCXXFLAGS               = -L$[GLIBC64_2_30_DIR] -Wl,-rpath=$[GLIBC64_2_30_DIR] -Wl,--dynamic-linker=$[GLIBC64_2_30_DIR]/ld-linux-x86-64.so.2 -Wl,-mllvm -Wl,-suppress-fmas
LDFFLAGS                 = -L$[GLIBC64_DIR] -Wl,-rpath=$[GLIBC64_DIR] -Wl,--dynamic-linker=$[GLIBC64_DIR]/ld-linux-x86-64.so.2 -ffast-math \
                           # 防止628编译不过
                           #-Wl,-mllvm -Wl,-inline-recursion=4 \
                           #-Wl,-mllvm -Wl,-lsr-in-nested-loop \
                           #-Wl,-mllvm -Wl,-enable-iv-split
```

测试数据

| 芯片/测试项                                              | intrate          | fprate           | intspeed            | fpspeed           | 备注                 |
| -------------------------------------------------------- | ---------------- | ---------------- | ------------------- | ----------------- | -------------------- |
| 7380 (2.2Ghz 单核32核，双路64核，超线程128核，共8个NUMA) | 211 (128 copies) | 174 (128 copies) | 5.29  (128 threads) | 77.9 (64 threads) | 内存12 x 32G，共384G |
| 7360  (2.5Ghz 单核24核，双路48核，超线程96核，共8个NUMA) | 231 (96 copies)  | 252 (96 copies)  | 6.05 (96 threads)   | 93.9 (48 threads) | 内存 16 x 32，共512G |
| 5380 (2.4Ghz 单核16核，双路32核，超线程64核，共4个NUMA)  | 110 (64 copies)  | 84.6 (64 copies) | 5.32 (64 threads)   | 41.7 (32 threads) | 内存12 x 32G，共384G |





